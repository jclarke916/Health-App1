<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v17.64 PROTOCOL-MASTER</title>
<style>
/* --- CORE STYLES --- */
:root { --bg:#050505; --panel:#121212; --border:#222; --acid:#ccff00; --cyan:#00f0ff; --purple:#bf5af2; --alert:#ff453a; --text:#fff; }
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;padding-bottom:120px;-webkit-tap-highlight-color:transparent}
.header{background:rgba(10,10,10,0.95);padding:15px;border-bottom:1px solid #333;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
/* CONTROLS */
.user-switch{display:flex;gap:8px;background:#1a1a1a;padding:4px;border-radius:24px;margin-bottom:10px;border:1px solid #333}
.user-switch button{flex:1;padding:10px;border:none;background:transparent;color:#666;border-radius:20px;cursor:pointer;font-weight:800;font-size:0.75rem;transition:all 0.3s;letter-spacing:1px}
.user-switch button.active{background:var(--acid);color:#000;box-shadow:0 0 15px rgba(204,255,0,0.4);text-shadow:none}
.date-nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;background:#000;border:1px solid #333;border-radius:10px;padding:6px}
.nav-btn{background:transparent;border:none;color:var(--cyan);padding:5px 20px;font-size:1.2rem;cursor:pointer;text-shadow:0 0 8px rgba(0,240,255,0.6)}
#dateLabel{flex:1;text-align:center;color:#fff;font-weight:700;font-size:0.9rem;font-family:monospace;letter-spacing:1px}
.bio-btn{position:absolute;right:15px;top:15px;background:rgba(255,255,255,0.05);color:var(--acid);border:1px solid var(--acid);padding:6px 12px;border-radius:6px;font-size:0.6rem;font-weight:900;cursor:pointer;box-shadow:0 0 5px rgba(204,255,0,0.2)}
/* HERO */
.hero{padding:25px 15px;display:flex;gap:15px;align-items:center}
.dual-score{display:flex;gap:15px;align-items:center}
.score-box{border:2px solid #333;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;background:#000}
.score-box.small{width:70px;height:70px}
.score-box.primary{width:90px;height:90px;border-width:3px;background:radial-gradient(circle,rgba(204,255,0,0.08) 0%,transparent 70%);border-color:var(--acid);box-shadow:0 0 25px rgba(204,255,0,0.2)}
.score-val{font-size:1.4rem;font-weight:900;line-height:1;color:#fff}
.score-val.longevity{font-size:2.2rem;background:linear-gradient(135deg,var(--acid) 0%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 8px rgba(204,255,0,0.6))}
.score-label{font-size:0.45rem;color:#666;text-transform:uppercase;margin-top:4px;font-weight:800;letter-spacing:1px}
.score-avg-badge{position:absolute;bottom:-12px;background:#111;border:1px solid #333;padding:2px 6px;border-radius:8px;font-size:0.4rem;color:var(--cyan);font-weight:900;letter-spacing:0.5px}
/* ALERTS */
.alert{margin:0 15px 20px;padding:15px;border-radius:10px;text-align:center;font-weight:800;display:none;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;line-height:1.4}
.alert.show{display:block;animation:pulse 3s infinite}
.alert-warning{background:rgba(255,214,10,0.15);border:1px solid #FFD60A;color:#FFD60A;box-shadow:0 0 15px rgba(255,214,10,0.1)}
.alert-protein{background:rgba(0,240,255,0.15);border:1px solid var(--cyan);color:var(--cyan);box-shadow:0 0 15px rgba(0,240,255,0.1)}
.alert-love{background:linear-gradient(135deg,#b00b69 0%,#52057b 100%);color:#fff;border:1px solid #ff69b4;text-shadow:0 1px 2px rgba(0,0,0,0.5);box-shadow:0 0 20px rgba(255,105,180,0.3)}
@keyframes pulse{0%{opacity:1}50%{opacity:0.8}100%{opacity:1}}
/* SECTIONS */
.section-header{padding:15px;font-size:0.65rem;font-weight:900;color:#888;letter-spacing:1.5px;text-transform:uppercase;margin-top:10px;display:flex;align-items:center;gap:10px}
.section-header::after{content:'';height:1px;background:#333;flex:1}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:0 15px;margin-bottom:20px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;padding:0 15px;margin-bottom:20px}
/* ORBS */
.orb-card{background:linear-gradient(145deg,#111 0%,#080808 100%);border:1px solid #222;border-radius:14px;padding:15px 5px;display:flex;flex-direction:column;align-items:center;transition:transform 0.1s}
.orb-card:active{transform:scale(0.96)}
.orb-container{width:55px;height:55px;position:relative;margin-bottom:8px;margin-left:auto;margin-right:auto}
.orb-svg{transform:rotate(-90deg);width:100%;height:100%;position:absolute;top:0;left:0;z-index:1}
.orb-bg{fill:none;stroke:#1a1a1a;stroke-width:5}
.orb-fg{fill:none;stroke-width:5;stroke-dasharray:145;stroke-dashoffset:145;transition:stroke-dashoffset 1s cubic-bezier(0.4,0,0.2,1);stroke-linecap:round;filter:drop-shadow(0 0 4px currentColor)}
.orb-val-box{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;text-align:center;z-index:10;pointer-events:none}
.orb-val{font-family:'Courier New',monospace;font-size:0.7rem;font-weight:900;color:#fff;text-shadow:0 0 4px #000,0 0 3px #000;letter-spacing:-0.5px;line-height:1;margin-top:2px}
.orb-label{font-size:0.45rem;font-weight:800;color:#666;text-transform:uppercase;letter-spacing:0.5px}
/* HEARTS */
.heart-svg{width:100%;height:100%;overflow:visible;z-index:1;position:absolute;top:0;left:0}
.heart-bg{fill:none;stroke:#1a1a1a;stroke-width:2.5}
.heart-fg{fill:none;stroke-width:2.5;stroke-dasharray:100;stroke-dashoffset:100;transition:stroke-dashoffset 1s ease;filter:drop-shadow(0 0 3px currentColor)}
.beating{animation:heartbeat 1.5s infinite;transform-origin:center}
@keyframes heartbeat{0%{transform:scale(1)}15%{transform:scale(1.1)}30%{transform:scale(1)}45%{transform:scale(1.1)}60%{transform:scale(1)}}
/* RAINBOW */
.rainbow-container{padding:0 15px;margin-bottom:20px}
.rainbow-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.rainbow-title{font-size:0.65rem;font-weight:900;color:#ccc;letter-spacing:1px}
.rainbow-score{font-size:0.9rem;font-weight:900;color:var(--acid);font-family:monospace;text-shadow:0 0 10px rgba(204,255,0,0.3)}
.rainbow-track{height:10px;background:#111;border-radius:5px;display:flex;overflow:hidden;border:1px solid #333}
.rainbow-seg{height:100%;width:0%;transition:width 0.5s ease;box-shadow:inset 0 0 5px rgba(0,0,0,0.5)}
.rainbow-suggestion{font-size:0.65rem;color:var(--acid);margin-top:10px;font-weight:700;padding:10px;background:rgba(204,255,0,0.05);border-radius:8px;border:1px solid rgba(204,255,0,0.2);text-align:right}
/* TIMELINE */
.timeline{padding:0 15px;margin-bottom:40px}
.task{display:flex;gap:12px;margin-bottom:15px;min-height:60px}
.task-time{width:45px;color:#666;font-size:0.7rem;padding-top:15px;text-align:right;font-family:monospace;font-weight:bold}
.task-card{flex:1;background:linear-gradient(180deg,#111 0%,#0d0d0d 100%);border:1px solid #333;border-radius:12px;padding:15px;position:relative;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center}
.task-card:active{transform:scale(0.98);background:#1a1a1a}
.task-card.checked{border-color:var(--acid);background:rgba(204,255,0,0.03);box-shadow:0 0 15px rgba(204,255,0,0.05)}
.task-card.auto-detected{border-color:var(--cyan);background:rgba(0,240,255,0.03)}
.task-info{flex:1}
.task-title{font-weight:900;font-size:0.85rem;margin-bottom:5px;color:#fff}
.task-desc{font-size:0.7rem;color:#888;line-height:1.4}
.workout-badge{display:inline-block;background:var(--cyan);color:#000;padding:2px 6px;border-radius:4px;font-size:0.5rem;font-weight:900;margin-left:5px;vertical-align:middle;box-shadow:0 0 5px var(--cyan)}
.chevron{font-size:1.5rem;color:#333;margin-left:15px;font-weight:900;transition:color 0.2s}
.task-card:active .chevron{color:var(--acid)}
.check-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-left:5px}
.check-circle{width:26px;height:26px;border:2px solid #555;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1rem;color:transparent;transition:all 0.2s}
.task-card.checked .check-circle{background:var(--acid);border-color:var(--acid);color:#000;box-shadow:0 0 10px var(--acid)}
/* MODAL */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:500;display:none;overflow-y:auto;backdrop-filter:blur(8px)}
.modal-overlay.show{display:block}
.modal-content{width:100%;min-height:100vh;background:#050505;padding-bottom:150px}
.modal-header{padding:20px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:rgba(5,5,5,0.95);z-index:10}
.modal-title{font-size:1rem;font-weight:900;color:var(--acid);text-transform:uppercase;letter-spacing:1px;max-width:85%}
.modal-close{background:transparent;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1}
.modal-body{padding:20px 20px 180px 20px}
/* FIXED BOTTOM BAR */
.fixed-bottom-bar{position:fixed;bottom:0;left:0;width:100%;padding:20px;padding-bottom:max(20px,env(safe-area-inset-bottom));background:#000;border-top:1px solid #333;z-index:10001;display:none;justify-content:center;box-shadow:0 -10px 40px rgba(0,0,0,1)}
.fixed-bottom-bar.show{display:flex}
.select-btn{width:100%;background:var(--acid);color:#000;padding:18px;border:none;border-radius:12px;font-weight:900;font-size:1.1rem;cursor:pointer;text-transform:uppercase;box-shadow:0 0 20px rgba(204,255,0,0.3);letter-spacing:1px}
.select-btn:active{transform:scale(0.98)}
/* RECIPE STYLES */
.recipe-hero{margin-bottom:25px}
.recipe-title{font-size:1.6rem;font-weight:900;line-height:1.1;margin-bottom:10px;color:#fff}
.recipe-stats{display:flex;gap:20px;font-size:0.85rem;color:#888;font-weight:700;font-family:monospace}
.macro-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:25px}
.macro-stat{background:#111;border:1px solid #333;padding:12px 5px;border-radius:10px;text-align:center}
.m-val{font-size:1.1rem;font-weight:900;color:#fff;font-family:monospace}
.m-lbl{font-size:0.5rem;color:var(--acid);text-transform:uppercase;margin-top:4px;font-weight:900}
.section-label{font-size:0.75rem;color:var(--cyan);font-weight:900;margin:25px 0 15px;text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid #222;padding-bottom:5px;display:inline-block}
.ing-item{color:#ccc;font-size:0.9rem;border-bottom:1px solid #1a1a1a;padding:10px 0;display:flex;align-items:center}
.ing-item::before{content:'‚Ä¢';color:var(--acid);font-weight:bold;margin-right:10px;font-size:1.2rem}
.step-item{display:flex;gap:15px;font-size:0.9rem;color:#ddd;line-height:1.6;margin-bottom:15px;background:#111;padding:15px;border-radius:10px;border:1px solid #222}
.step-num{color:#000;background:var(--acid);font-weight:900;font-family:monospace;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.8rem;margin-top:2px}
.synergy-box{background:linear-gradient(135deg,rgba(0,240,255,0.05) 0%,rgba(0,0,0,0) 100%);border:1px solid rgba(0,240,255,0.3);padding:20px;border-radius:12px;margin-bottom:20px;position:relative;overflow:hidden}
.syn-title{color:var(--cyan);font-weight:900;font-size:0.75rem;text-transform:uppercase;margin-bottom:8px;letter-spacing:1px}
.syn-text{color:#ccc;font-size:0.9rem;font-style:italic;line-height:1.5}
.abs-alert{background:rgba(255,69,58,0.1);border:1px solid var(--alert);padding:15px;border-radius:10px;margin-bottom:15px;font-size:0.8rem;color:#fff;line-height:1.4;display:flex;align-items:center;gap:12px}
.abs-boost{background:rgba(48,209,88,0.15);border:1px solid #30d158;padding:15px;border-radius:10px;margin-bottom:15px;font-size:0.8rem;color:#fff;line-height:1.4;display:flex;align-items:center;gap:12px}
/* MENU LIST */
.menu-item{padding:20px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s;background:linear-gradient(90deg,#111 0%,#0d0d0d 100%);margin-bottom:1px}
.menu-item:active{background:#1a1a1a}
.menu-left{flex:1}
.menu-right{display:flex;gap:8px;align-items:center;justify-content:flex-end;min-width:80px}
.menu-name{font-size:1rem;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:0.5px}
.menu-meta{font-size:0.7rem;color:#888;font-family:monospace;margin-bottom:0px;display:flex;gap:10px}
.menu-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.badge{font-size:0.6rem;padding:4px 8px;border-radius:6px;font-weight:900;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap}
.badge.boost{background:rgba(48,209,88,0.15);color:#30d158;border:1px solid #30d158}
.badge.block{background:rgba(255,69,58,0.15);color:#ff453a;border:1px solid #ff453a}
.badge.omega{background:rgba(0,240,255,0.15);color:var(--cyan);border:1px solid var(--cyan)}
.badge.user{background:rgba(255,255,255,0.15);color:#fff;border:1px solid #fff}
.menu-arrow{color:#333;font-size:1.5rem;font-weight:900;margin-left:10px}
/* CUSTOM BUILDER STYLES */
.custom-btn-container{padding:20px;background:#111;border-bottom:1px solid #333;text-align:center}
.custom-btn{background:transparent;border:2px dashed #444;color:#888;width:100%;padding:15px;border-radius:12px;font-weight:800;text-transform:uppercase;cursor:pointer}
.custom-btn:hover{border-color:var(--acid);color:var(--acid)}
.builder-form{padding:20px}
.form-group{margin-bottom:20px}
.form-label{display:block;color:var(--cyan);font-size:0.7rem;font-weight:900;margin-bottom:8px;text-transform:uppercase}
.form-input{width:100%;background:#1a1a1a;border:1px solid #333;color:#fff;padding:15px;border-radius:8px;font-size:1rem;font-family:monospace}
.form-input:focus{border-color:var(--acid);outline:none}
.footer{position:fixed;bottom:0;left:0;width:100%;background:#000;padding:12px 15px;border-top:1px solid #333;display:flex;justify-content:space-between;align-items:center;z-index:90}
.sync-status{font-size:0.6rem;color:#666;font-family:monospace}
.sync-btn{background:var(--acid);color:#000;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:900;font-size:0.7rem}
</style>
</head>
<body>

<div class="header">
    <div class="user-switch">
        <button id="btn-jermaine" class="active" onclick="if(window.app)app.switchUser('jermaine')">JERMAINE</button>
        <button id="btn-sophia" onclick="if(window.app)app.switchUser('sophia')">SOPHIA</button>
    </div>
    <div class="date-nav">
        <button class="nav-btn" onclick="if(window.app)app.changeDate(-1)">‚óÄ</button>
        <span id="dateLabel">LOADING...</span>
        <button class="nav-btn" onclick="if(window.app)app.changeDate(1)">‚ñ∂</button>
    </div>
    <button class="bio-btn" onclick="if(window.app)app.openBio()">BIO</button>
</div>

<div id="alertBanner" class="alert"></div>

<div class="hero">
    <div class="dual-score">
        <div class="score-box small">
            <div class="score-val" id="dayGrade">--</div>
            <div class="score-label">TODAY</div>
        </div>
        <div class="score-box primary">
            <div class="score-val longevity" id="longevityScore">--</div>
            <div class="score-label">LONGEVITY</div>
            <div class="score-avg-badge">7-DAY AVG</div>
        </div>
    </div>
    <div class="status" id="statusMsg">INITIALIZING...</div>
</div>

<div class="section-header">SLEEP ARCHITECTURE</div>
<div class="grid-3">
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="sleepOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="sleepVal">--</div></div></div><div class="orb-label" style="color:#bf5af2">TOTAL</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="deepOrb" cx="25" cy="25" r="21" style="stroke:#007aff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="deepVal">--</div></div></div><div class="orb-label" style="color:#007aff">DEEP</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="remOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="remVal">--</div></div></div><div class="orb-label" style="color:#bf5af2">REM</div></div>
</div>

<div class="section-header">FUEL (NUTRITION)</div>
<div class="grid-4">
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="proteinOrb" cx="25" cy="25" r="21" style="stroke:#fff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="proteinVal">0</div></div></div><div class="orb-label" style="color:#fff">PROTEIN</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="omega3Orb" cx="25" cy="25" r="21" style="stroke:#00d4ff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="omega3Val">0</div></div></div><div class="orb-label" style="color:#00d4ff">OMEGA-3</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="fiberOrb" cx="25" cy="25" r="21" style="stroke:#30d158"></circle></svg><div class="orb-val-box"><div class="orb-val" id="fiberVal">0</div></div></div><div class="orb-label" style="color:#30d158">FIBER</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="calorieOrb" cx="25" cy="25" r="21" style="stroke:#FFD60A"></circle></svg><div class="orb-val-box"><div class="orb-val" id="calorieVal">0</div></div></div><div class="orb-label" style="color:#FFD60A">CALORIES</div></div>
</div>

<div class="section-header">ENGINE (CARDIO)</div>
<div class="grid-4">
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg beating" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><svg class="heart-fg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="fill:none; stroke:#ff453a; stroke-width:2.5;"></path></svg></svg><div class="orb-val-box"><div class="orb-val" id="rhrVal">--</div></div></div>
        <div class="orb-label" style="color:#ff453a">RHR</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="z2Heart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#00f0ff"></path></svg><div class="orb-val-box"><div class="orb-val" id="z2Val">0</div></div></div>
        <div class="orb-label" style="color:#00f0ff">ZONE 2</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="z5Heart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#ff453a"></path></svg><div class="orb-val-box"><div class="orb-val" id="z5Val">0</div></div></div>
        <div class="orb-label" style="color:#ff453a">ZONE 5</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="calHeart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#FFD60A"></path></svg><div class="orb-val-box"><div class="orb-val" id="calVal">0</div></div></div>
        <div class="orb-label" style="color:#FFD60A">BURN</div>
    </div>
</div>

<div class="section-header">PHYTONUTRIENT DIVERSITY üåà</div>
<div class="rainbow-container">
    <div class="rainbow-header"><div class="rainbow-title">RAINBOW SCORE</div><div class="rainbow-score" id="rainbowScore">0%</div></div>
    <div class="rainbow-track" id="rainbowTrack"></div>
    <div id="rainbowSuggestion" class="rainbow-suggestion" style="display:none"></div>
</div>

<div class="section-header">SYNERGY PROTOCOL üîÑ AUTO-DETECT</div>
<div class="timeline" id="timeline"></div>

<div class="modal-overlay" id="mainModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">TITLE</div>
            <button class="modal-close" onclick="app.closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<div id="fixedFooter" class="fixed-bottom-bar">
    <button id="logBtnAction" class="select-btn">LOG THIS MEAL</button>
</div>

<div class="footer">
    <span class="sync-status" id="syncStatus">INIT</span>
    <button class="sync-btn" onclick="if(window.app)app.sync()">üîÑ SYNC</button>
</div>

<script>
const USERS = {
    jermaine: { name: "Jermaine", dob: "1983-01-13", goals: { protein: 175, omega3: 4000, fiber: 50, water: 140, weightTarget: 210, heightInches: 76.5, z2: 45, z5: 20, calBurn: 500 }, defaultBios: { bmr: '2028', apob: '114', lpa: '178', weight: '215.7', hscrp: '0.4', hba1c: '5.4', bodyfat: '21.6', muscle: '97.0' } },
    sophia: { name: "Sophia", dob: "1987-01-25", goals: { protein: 130, omega3: 4000, fiber: 35, water: 100, weightTarget: 140, heightInches: 64, z2: 30, z5: 15, calBurn: 350 }, defaultBios: { bmr: '1450', apob: '70', lpa: '20', weight: '148', hscrp: '0.5', hba1c: '5.2' } }
};
const MEAL_DATABASE = {
    breakfast: [
        {title:"Greek Yogurt & Berries",time:"5min",servings:1,macros:{p:20,o:0,f:4,cal:250},ingredients:["1 cup Greek Yogurt","1/2 cup Mixed Berries","1 tbsp Honey","1 tbsp Walnuts"],steps:["Scoop yogurt into bowl","Top with berries and walnuts","Drizzle with honey"],why:"Probiotics + Antioxidants.",colors:['white','purple','brown']},
        {title:"Smoked Salmon Avocado Toast",time:"10min",servings:1,macros:{p:28,o:2500,f:8,cal:450},ingredients:["1 slice Sprouted Bread","3oz Smoked Salmon","1/2 Avocado","Red Onion","Capers"],steps:["Toast bread","Mash avocado","Layer salmon","Top with capers/onion"],why:"Classic Omega-3 stack.",colors:['orange','green','brown']},
        {title:"Tofu Veggie Scramble",time:"15min",servings:1,macros:{p:24,o:1200,f:6,cal:380},ingredients:["1/2 block Firm Tofu","Spinach","Mushrooms","Bell Peppers","Turmeric","Nutritional Yeast"],steps:["Crumble tofu in pan","Add veggies and saut√©","Season with turmeric (anti-inflammatory) and yeast"],why:"Plant-based complete protein.",colors:['yellow','green','red']},
        {title:"Omega Breakfast",time:"15min",servings:1,macros:{p:58,o:3500,f:12,cal:680},ingredients:["8oz Wild Salmon","2 Eggs","2 cups Kale","1 cup Blueberries","1 tsp EVOO"],steps:["Heat EVOO in pan","Season salmon with salt/pepper","Sear salmon 4min per side","Scramble eggs separately","Massage kale for 2min","Plate kale as base","Top with salmon, eggs, and berries"],why:"Salmon + Eggs = Choline/Omega-3 synergy.",colors:['orange','purple','green']},
        {title:"Sophia's Sea Moss Oatmeal",time:"10min",servings:1,macros:{p:48,o:8200,f:18,cal:580},ingredients:["1 cup Oats","1 tbsp Sea Moss","3 tbsp Flaxseed","Pea Protein","Berries"],steps:["Cook oats in water or oat milk","Stir in Sea Moss gel and protein","Top with ground flax and berries"],why:"Sea Moss minerals support thyroid.",colors:['purple','white']},
        {title:"PB Sea Moss Power Shake",time:"5min",servings:1,macros:{p:54,o:7200,f:16,cal:680},ingredients:["Pea Protein","Sea Moss","Flaxseed","PB","Spinach"],steps:["Blend all ingredients with Oat Milk"],why:"Sea Moss supports mucus membranes.",colors:['green','white']},
        {title:"Smoked Trout Hash",time:"18min",servings:1,macros:{p:54,o:3200,f:16,cal:640},ingredients:["6oz Trout","2 Eggs","1 Sweet Potato","Brussels Sprouts","Garlic"],steps:["Dice sweet potato and saute","Add sprouts and garlic","Crack eggs into wells","Cover until eggs set","Top with flaked trout"],why:"Trout is lower mercury than tuna.",colors:['orange','green']},
        {title:"Savory Turmeric Oats",time:"12min",servings:1,macros:{p:20,o:1200,f:12,cal:450},ingredients:["1 cup Oats","Turmeric","Black Pepper","Spinach","Poached Egg"],steps:["Cook oats with turmeric/pepper","Stir in spinach","Top with egg"],why:"Turmeric + Pepper = 2000% absorption boost.",colors:['yellow','green']},
        {title:"Mackerel Scramble",time:"12min",servings:1,macros:{p:56,o:4800,f:10,cal:660},ingredients:["mackerel","eggs","arugula","turmeric"],steps:["Whisk eggs with turmeric","Scramble with mackerel","Serve over wilted arugula"],why:"Mackerel is highest Omega-3 fish.",colors:['yellow','green']},
        {title:"Flax Protein Parfait",time:"5min",servings:1,macros:{p:48,o:8600,f:18,cal:580},ingredients:["pea protein","flaxseed","greek yogurt","berries"],steps:["Mix yogurt and protein","Layer with flax and berries"],why:"Flax is highest plant source of ALA.",colors:['white','purple']},
        {title:"Protein Pancakes",time:"15min",servings:1,macros:{p:52,o:6400,f:14,cal:620},ingredients:["pea protein","flaxseed","oats","berries"],steps:["Blend batter ingredients","Cook on griddle","Top with berries"],why:"High protein start to day.",colors:['purple','white']},
        {title:"Eggs & Oatmeal Combo",time:"12min",servings:1,macros:{p:52,o:7800,f:16,cal:640},ingredients:["¬Ω cup steel-cut oats","2 tbsp ground flaxseed","1 tbsp Sea Moss Gel","3 eggs","1 cup spinach","¬Ω avocado","Berries"],steps:["Cook oats with Sea Moss","Scramble eggs with spinach","Plate oatmeal with flax, berries","Serve eggs on side with avocado"],why:"Best of both worlds.",colors:['green','white']}
    ],
    lunch: [
        {title:"Salmon & Quinoa Power Bowl",time:"20min",servings:1,macros:{p:48,o:3000,f:14,cal:780},ingredients:["6-7oz Salmon Fillet","1 cup Brown Rice & Quinoa Mix","1/2 cup Black Beans","Brussels Sprouts","Red Peppers","Mushrooms"],steps:["Sear salmon fillet","Saut√© brussels, peppers, mushrooms","Mix rice, quinoa, and beans","Assemble bowl"],why:"Brown Rice + Quinoa + Beans = The ultimate fiber triad.",colors:['orange','brown','green','red']},
        {title:"Sriracha Shrimp Tacos",time:"15min",servings:2,macros:{p:35,o:400,f:6,cal:420},ingredients:["6oz Shrimp","3 Corn Tortillas","Greek Yogurt (Plain)","Sriracha","Cabbage Slaw","Lime"],steps:["Saut√© shrimp with garlic","Mix yogurt with sriracha (Mayo Swap)","Warm tortillas","Assemble with slaw and spicy yogurt"],why:"Greek Yogurt replaces mayo for high protein.",colors:['pink','white','red']},
        {title:"Salmon Poke Bowl",time:"15min",servings:1,macros:{p:45,o:2800,f:8,cal:580},ingredients:["6oz Raw Wild Salmon","Brown Rice","Edamame","Cucumber","Seaweed Salad","Sesame Oil","Soy Sauce"],steps:["Cube salmon","Toss in soy/sesame mix","Plate rice and toppings","Top with salmon"],why:"Wild Salmon is safer than Tuna.",colors:['orange','green','brown']},
        {title:"Pepper Fin Ahi",time:"10min",servings:1,macros:{p:38,o:800,f:2,cal:320},ingredients:["5oz Seared Ahi Tuna","Jalape√±o slices","Ponzu Sauce","Sesame Seeds","Cucumber slices"],steps:["Slice tuna thin (sashimi style)","Top with jalape√±o rounds","Drown in Ponzu","Sprinkle seeds"],why:"Capsaicin in peppers boosts metabolism.",colors:['red','green','white']},
        {title:"Smoked Mackerel Super Salad",time:"10min",servings:1,macros:{p:35,o:4500,f:8,cal:520},ingredients:["1 tin/filet Smoked Mackerel","3 cups Arugula","1/4 cup Walnuts","1/2 Avocado","Apple Cider Vinaigrette"],steps:["Flake mackerel over arugula","Add walnuts for extra ALA","Top with avocado and dressing"],why:"The 'Mackerel + Walnut' stack is the highest possible non-supplement Omega-3 meal.",colors:['green','brown','orange']},
        {title:"Classic Bison Burger",time:"20min",servings:1,macros:{p:42,o:400,f:8,cal:550},ingredients:["6oz Ground Bison","1 Whole Wheat Bun","Lettuce/Tomato/Onion","1 tsp Mustard","Side Green Salad"],steps:["Form bison patty","Grill or pan sear","Toast bun lightly","Assemble with fresh veggies","Serve with side salad"],why:"Bison = Lower TMAO than beef.",colors:['brown','green','red']},
        {title:"Turkey Club Wrap",time:"10min",servings:1,macros:{p:38,o:400,f:6,cal:540},ingredients:["1 large tortilla","4oz turkey breast","2 slices turkey bacon","Lettuce","Tomato","Mayo (light)"],steps:["Cook bacon","Spread mayo","Layer ingredients","Roll tightly"],why:"High protein lunch standard.",colors:['white','green','red']},
        {title:"Bean & Cheese Burrito",time:"10min",servings:1,macros:{p:22,o:200,f:14,cal:580},ingredients:["1 large whole wheat tortilla","1/2 cup refried beans","1/4 cup cheddar","Salsa","Spinach","Greek yogurt"],steps:["Spread beans","Add cheese/salsa","Roll and heat","Dip in yogurt"],why:"Beans = fiber/protein combo.",colors:['brown','green','white']},
        {title:"Zoodles & Shrimp",time:"15min",servings:1,macros:{p:35,o:600,f:5,cal:400},ingredients:["Zucchini","Shrimp","Garlic","Lemon","Olive Oil"],steps:["Spiralize zucchini","Saute shrimp","Toss zoodles in pan"],why:"Low carb, high nutrient density.",colors:['green','pink']},
        {title:"Cottage Cheese Bowl",time:"5min",servings:1,macros:{p:30,o:200,f:4,cal:350},ingredients:["Cottage Cheese","Pineapple","Walnuts","Chia Seeds"],steps:["Scoop cheese","Top with fruit/nuts"],why:"Casein protein creates slow release.",colors:['white','yellow']},
        {title:"Salmon Pesto Pasta",time:"20min",servings:1,macros:{p:56,o:4200,f:12,cal:740},ingredients:["6oz Salmon","Chickpea Pasta","Pesto","Tomatoes","Arugula"],steps:["Boil pasta","Sear salmon","Toss with pesto","Combine"],why:"Chickpea pasta = high fiber.",colors:['pink','green','red']},
        {title:"Chipotle Bowl (Bison)",time:"18min",servings:1,macros:{p:58,o:2800,f:20,cal:740},ingredients:["6oz Bison","Brown Rice","Black Beans","Peppers","Guacamole"],steps:["Brown bison","Warm beans","Build bowl","Add guac"],why:"Bison = nutrient dense.",colors:['brown','black','green','red']},
        {title:"Chipotle Bowl (Tofu)",time:"20min",servings:1,macros:{p:46,o:3200,f:22,cal:680},ingredients:["tofu","brown rice","black beans","peppers"],steps:["Season/bake tofu","Assemble bowl"],why:"Plant-based complete protein.",colors:['white','black','green']},
        {title:"Mediterranean Quinoa Salad",time:"15min",servings:1,macros:{p:22,o:1200,f:14,cal:580},ingredients:["quinoa","cucumber","tomatoes","olives","feta"],steps:["Mix cooked quinoa with veg","Add olives/feta","Drizzle olive oil"],why:"Mediterranean diet gold standard.",colors:['white','green','red','black']},
        {title:"Lentil Soup with Kale",time:"30min",servings:2,macros:{p:24,o:800,f:18,cal:450},ingredients:["lentils","kale","carrots","celery"],steps:["Simmer lentils with veg","Add kale to wilt"],why:"High fiber lowers cholesterol.",colors:['brown','green','orange']},
        {title:"Turkey Burger & Sweet Potato",time:"20min",servings:1,macros:{p:38,o:300,f:8,cal:580},ingredients:["turkey","sweet potato","lettuce","tomato"],steps:["Grill burger","Roast potato wedges"],why:"Lean protein + Vitamin A.",colors:['white','orange','green']},
        {title:"Chickpea Curry (Quick)",time:"20min",servings:2,macros:{p:18,o:400,f:14,cal:480},ingredients:["1 can chickpeas","1 cup coconut milk","1 tbsp red curry paste","Spinach","Rice"],steps:["Saut√© spices","Add milk/chickpeas","Simmer","Stir spinach"],why:"Chickpeas = fiber/protein.",colors:['yellow','green','white']},
        {title:"Bison Taco Salad",time:"15min",servings:1,macros:{p:45,o:800,f:12,cal:620},ingredients:["5oz ground bison","2 cups romaine","Black beans","Salsa","Avocado"],steps:["Brown bison","Assemble lettuce","Top with ingredients"],why:"Bison = nutrient dense.",colors:['brown','black','green','red']},
        {title:"Edamame & Quinoa Bowl",time:"15min",servings:1,macros:{p:24,o:1800,f:12,cal:540},ingredients:["1 cup quinoa","1 cup shelled edamame","Purple cabbage","Carrot","Ginger dressing"],steps:["Warm quinoa/edamame","Toss with veg","Drizzle dressing"],why:"Edamame = soy protein.",colors:['green','purple','orange']},
        {title:"Smoked Salmon Bagel (Open)",time:"5min",servings:1,macros:{p:32,o:2800,f:6,cal:480},ingredients:["1 whole grain bagel","4oz smoked salmon","Cream cheese","Capers","Onion"],steps:["Toast bagel","Spread cheese","Layer salmon/toppings"],why:"Salmon = omega-3.",colors:['orange','white','green']},
        {title:"Leftover Roast Chicken Salad",time:"10min",servings:1,macros:{p:40,o:600,f:8,cal:520},ingredients:["5oz chicken","Arugula","Apple","Walnuts","Celery","Yogurt dressing"],steps:["Chop chicken/celery","Toss with greens/apple","Add walnuts"],why:"Walnuts = ALA omega-3.",colors:['white','green','brown']},
        {title:"Tempeh Reuben Bowl",time:"15min",servings:1,macros:{p:28,o:1200,f:16,cal:560},ingredients:["Tempeh","Sauerkraut","Swiss cheese","Rye croutons","Dressing"],steps:["Fry tempeh","Melt cheese","Bowl with greens/kraut"],why:"Tempeh/Kraut = gut health.",colors:['brown','green']},
        {title:"Shrimp & Asparagus Stir Fry",time:"15min",servings:1,macros:{p:35,o:800,f:8,cal:450},ingredients:["6oz shrimp","Asparagus","Garlic","Ginger","Soy sauce","Cauli rice"],steps:["Saut√© garlic/ginger","Add asparagus/shrimp","Add soy sauce"],why:"Shrimp = astaxanthin.",colors:['pink','green','white']},
        {title:"Turkey Club (Sourdough)",time:"10min",servings:1,macros:{p:40,o:500,f:6,cal:550},ingredients:["Turkey","Sourdough","Avocado","Tomato","Lettuce"],steps:["Toast bread","Layer ingredients"],why:"Sourdough is low glycemic.",colors:['white','red','green']}
    ],
    dinner: [
        {title:"Bone Broth Pho",time:"25min",servings:1,macros:{p:40,o:600,f:4,cal:450},ingredients:["2 cups Beef Bone Broth","4oz Thin Beef","Rice Noodles","Bean Sprouts","Herbs"],steps:["Simmer broth","Cook noodles","Pour boiling broth over raw beef","Add toppings"],why:"Bone broth = collagen.",colors:['brown','white','green']},
        {title:"Healthy Beef Stew",time:"40min",servings:2,macros:{p:38,o:400,f:8,cal:520},ingredients:["1lb Lean Beef","Sweet Potatoes","Carrots","Bone Broth","Herbs"],steps:["Brown beef","Add veg/broth","Simmer 30m"],why:"Grass-fed beef = Heme Iron.",colors:['brown','orange','red']},
        {title:"Bone Broth & Ginger Soup",time:"10min",servings:1,macros:{p:10,o:0,f:0,cal:60},ingredients:["Chicken Bone Broth","Ginger","Turmeric","Lemon"],steps:["Heat broth","Stir in spices"],why:"Gut healing elixir.",colors:['yellow','brown']},
        {title:"Whole Branzino",time:"40min",servings:2,macros:{p:52,o:2800,f:12,cal:580},ingredients:["2 Branzino","Shrimp/Mussels","Tomatoes","White Wine","Herbs"],steps:["Score fish","Roast with seafood/tomatoes","Bake 400F 25m"],why:"Whole Fish = Collagen/Glycine.",colors:['white','pink','red']},
        {title:"Turkey Chili",time:"35min",servings:2,macros:{p:35,o:400,f:15,cal:500},ingredients:["1lb turkey","Kidney beans","Tomatoes","Onion","Spices"],steps:["Brown turkey","Add rest","Simmer 30m"],why:"Beans = fiber.",colors:['brown','red']},
        {title:"Beef Bolognese (Zoodles)",time:"40min",servings:2,macros:{p:40,o:500,f:10,cal:550},ingredients:["1lb beef","Marinara","Onion/Carrot","Zucchini"],steps:["Brown beef","Add veg/sauce","Simmer","Serve over zoodles"],why:"Beef = iron.",colors:['red','green']},
        {title:"Stuffed Peppers",time:"50min",servings:4,macros:{p:30,o:400,f:10,cal:450},ingredients:["Bell Peppers","Bison","Rice","Spinach","Tomato Sauce"],steps:["Hollow peppers","Stuff with mix","Bake 375F 40m"],why:"Vitamin C boosts iron.",colors:['red','green','brown']},
        {title:"Sesame Seared Tuna",time:"15min",servings:2,macros:{p:50,o:1500,f:2,cal:400},ingredients:["Tuna Steaks","Sesame Seeds","Soy Sauce","Asparagus"],steps:["Coat tuna","Sear 1m/side"],why:"High selenium.",colors:['red','white','green']},
        {title:"Seafood Cioppino",time:"40min",servings:2,macros:{p:42,o:1800,f:8,cal:480},ingredients:["Fish","Shellfish","Tomato Broth","Fennel"],steps:["Saute fennel","Add broth","Poach fish"],why:"Tomato = Lycopene.",colors:['white','red','green']},
        {title:"Herb Crusted Cod",time:"20min",servings:1,macros:{p:52,o:2800,f:10,cal:580},ingredients:["Cod","Almond flour","Egg","Herbs"],steps:["Bread cod","Pan fry"],why:"Cod = lean protein.",colors:['white','green']},
        {title:"Grass-Fed Steak",time:"25min",servings:1,macros:{p:60,o:1200,f:14,cal:720},ingredients:["Steak","Brussels sprouts","Sweet potato"],steps:["Roast veg","Sear steak"],why:"Grass-fed = CLA/Omega-3.",colors:['red','green','orange']},
        {title:"Mediterranean Chicken",time:"25min",servings:1,macros:{p:55,o:800,f:12,cal:640},ingredients:["Chicken","Quinoa","Cucumber","Olives","Feta"],steps:["Cook quinoa","Grill chicken","Mix bowl"],why:"Olives = antioxidants.",colors:['white','black','red']},
        {title:"Tempeh Stir Fry",time:"15min",servings:1,macros:{p:42,o:2200,f:18,cal:580},ingredients:["Tempeh","Broccoli","Peppers","Snap peas"],steps:["Steam then fry tempeh","Stir fry veg"],why:"Tempeh = fermented.",colors:['brown','green','red']},
        {title:"Sheet Pan Salmon",time:"20min",servings:1,macros:{p:45,o:3200,f:10,cal:620},ingredients:["Salmon","Broccoli","Peppers","Lemon"],steps:["Roast all at 400F"],why:"Easy Omega-3.",colors:['orange','green','red']},
        {title:"Shrimp Scampi",time:"15min",servings:1,macros:{p:30,o:600,f:6,cal:420},ingredients:["Shrimp","Zucchini","Butter","Garlic"],steps:["Saute garlic/shrimp","Toss zoodles"],why:"Shrimp = iodine.",colors:['pink','green','white']},
        {title:"Lamb Kofta",time:"25min",servings:1,macros:{p:40,o:900,f:10,cal:680},ingredients:["Lamb","Spices","Yogurt sauce","Greens"],steps:["Grill patties","Serve with sauce"],why:"Lamb = zinc.",colors:['brown','green','white','red']},
        {title:"Pesto Chicken",time:"15min",servings:1,macros:{p:45,o:500,f:8,cal:550},ingredients:["Chicken","Zucchini","Pesto","Tomato"],steps:["Cook chicken","Toss with zoodles/pesto"],why:"Basil = anti-bacterial.",colors:['green','white','red']},
        {title:"Seared Scallops",time:"30min",servings:1,macros:{p:35,o:700,f:4,cal:580},ingredients:["Scallops","Risotto","Peas"],steps:["Cook risotto","Sear scallops"],why:"Scallops = magnesium.",colors:['white','green']},
        {title:"Chicken Stir Fry",time:"15min",servings:1,macros:{p:40,o:300,f:8,cal:520},ingredients:["Chicken","Broccoli","Snap peas","Soy sauce"],steps:["Stir fry chicken then veg"],why:"Lean protein.",colors:['white','green','orange']},
        {title:"Baked Cod Salsa",time:"20min",servings:1,macros:{p:45,o:2000,f:8,cal:480},ingredients:["Cod","Salsa","Avocado","Asparagus"],steps:["Bake cod with salsa","Top with avo"],why:"Low fat high protein.",colors:['white','red','green']},
        {title:"Egg Roll Bowl",time:"15min",servings:1,macros:{p:35,o:600,f:10,cal:480},ingredients:["Pork/Turkey","Coleslaw mix","Ginger","Soy"],steps:["Brown meat","Saute slaw"],why:"Cabbage = cruciferous.",colors:['white','green']},
        {title:"Lemon Garlic Shrimp",time:"15min",servings:1,macros:{p:30,o:500,f:4,cal:380},ingredients:["Shrimp","Butter","Garlic","Lemon","Green beans"],steps:["Saute shrimp","Steam beans"],why:"High protein.",colors:['pink','green','white']},
        {title:"Meatballs",time:"30min",servings:2,macros:{p:32,o:400,f:8,cal:550},ingredients:["Beef","Egg","Almond flour","Marinara"],steps:["Bake balls","Simmer in sauce"],why:"Beef = B12.",colors:['red','green']},
        {title:"Curry Chicken Salad",time:"10min",servings:1,macros:{p:40,o:800,f:8,cal:560},ingredients:["Chicken","Yogurt","Curry powder","Grapes","Cashews"],steps:["Mix all"],why:"Curry = anti-inflammatory.",colors:['yellow','green']}
    ],
    juices: [
        {title:"The Red Pipe Clearer",macros:{p:2,o:0,f:1,cal:110},ingredients:["Beets","Carrots","Ginger","Lemon"],steps:["Juice"],why:"Nitric Oxide boost.",colors:['red','orange']},
        {title:"The ANA Green Soother",macros:{p:2,o:0,f:1,cal:90},ingredients:["Celery","Cucumber","Turmeric","Ginger"],steps:["Juice"],why:"Anti-inflammatory.",colors:['green','yellow']},
        {title:"Longevity Gold Elixir",macros:{p:1,o:0,f:0,cal:60},ingredients:["oranges","sea moss","turmeric"],steps:["Juice and mix"],why:"Immune boost.",colors:['orange','yellow']},
        {title:"Homemade Kombucha",macros:{p:0,o:0,f:0,cal:35},ingredients:["Kombucha","Ice","Mint"],steps:["Pour over ice"],why:"Probiotics.",colors:['yellow']}
    ],
    snack: [
        {title:"Hard Boiled Eggs",macros:{p:12,o:100,f:0,cal:140},ingredients:["2 Eggs","Salt"],steps:["Boil/Peel"],why:"Choline source.",colors:['white','yellow']},
        {title:"Bone Broth Cup",macros:{p:10,o:0,f:0,cal:45},ingredients:["Bone Broth"],steps:["Heat"],why:"Collagen.",colors:['brown']},
        {title:"Beef Jerky",macros:{p:12,o:0,f:0,cal:80},ingredients:["Beef Jerky"],steps:["Eat"],why:"Protein.",colors:['brown']},
        {title:"Pulp Crackers",macros:{p:6,o:1200,f:12,cal:140},ingredients:["Veggie Pulp","Seeds"],steps:["Dehydrate"],why:"Fiber.",colors:['brown']},
        {title:"Pulp Chews",macros:{p:3,o:200,f:8,cal:110},ingredients:["Fruit Pulp","Coconut"],steps:["Dehydrate"],why:"Fiber.",colors:['orange','white']},
        {title:"Oatmeal Balls",macros:{p:10,o:300,f:5,cal:210},ingredients:["Oats","Chocolate","Almond butter"],steps:["Roll"],why:"Beta-glucan.",colors:['brown']},
        {title:"Protein Balls",macros:{p:12,o:800,f:4,cal:220},ingredients:["Oats","PB","Honey","Protein"],steps:["Roll"],why:"Quick protein.",colors:['brown']},
        {title:"Hummus & Carrots",macros:{p:4,o:0,f:6,cal:150},ingredients:["Hummus","Carrots"],steps:["Dip"],why:"Fiber.",colors:['orange','white']},
        {title:"Seaweed",macros:{p:1,o:100,f:1,cal:30},ingredients:["Seaweed"],steps:["Eat"],why:"Iodine.",colors:['green']},
        {title:"Omega Nuts",macros:{p:6,o:2500,f:4,cal:180},ingredients:["Walnuts","Brazil Nuts"],steps:["Eat"],why:"Lp(a) reduction.",colors:['brown']}
    ]
};

const BASE_PROTOCOL = [
    { id: 'breakfast', time: '07:30', title: 'Breakfast', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'breakfast' },
    { id: 'juice', time: '08:30', title: 'Fresh Juice/Elixir', desc: 'Tap to select juice', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'juices' },
    { id: 'train', time: '09:00', title: 'Training', desc: 'Auto-detected from Oura', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: false, autoDetect: true },
    { id: 'lunch', time: '13:00', title: 'Lunch', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'lunch' },
    { id: 'snack', time: '15:30', title: 'Longevity Snack', desc: 'Tap to select snack', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'snack' },
    { id: 'dinner', time: '18:30', title: 'Dinner', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'dinner' },
    { id: 'evening', time: '21:00', title: 'Wind Down', desc: 'Chamomile tea + stretch', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: ['purple'], calBurn: 0 }
];

const TOKENS = { jermaine: 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', sophia: '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };

const RAINBOW_COLORS = { red:{hex:'#ff453a'}, orange:{hex:'#ff9f0a'}, yellow:{hex:'#ffd60a'}, green:{hex:'#30d158'}, purple:{hex:'#bf5af2'}, white:{hex:'#fff'}, brown:{hex:'#A0522D'}, pink:{hex:'#FF69B4'}, black:{hex:'#333'} };

const WORKOUT_TYPES = { strength_training: 'Strength', cycling: 'Cycling', running: 'Running', walking: 'Walking', swimming: 'Swim', other: 'Workout' };

const PROTOCOL_DETAILS = {
    microcurrent: {
        title: "‚ö° MICROCURRENT LIFT",
        steps: [
            "1. CLEANSE: Use oil-free cleanser (oil blocks current).",
            "2. GEL: Apply thick layer to one side of face.",
            "3. NECK: Glide upward to jawline. Avoid center thyroid.",
            "4. JAW: Glide from chin to earlobe (3 reps).",
            "5. CHEEK: Glide nose to ear (lower, middle, upper).",
            "6. BROW: Glide from brow to hairline (lift).",
            "7. REPEAT: Do other side. Wash face."
        ]
    },
    microneedling: {
        title: "üìç MICRONEEDLING REPAIR",
        steps: [
            "1. PREP: Sanitize device head with alcohol.",
            "2. CLEANSE: Double cleanse face. Pat dry.",
            "3. SERUM: Apply Hyaluronic Acid (slip layer).",
            "4. GLIDE: Cross-hatch pattern (Vertical, Horizontal, Diagonal).",
            "5. DEPTH: 0.5mm forehead, 0.25mm under eyes.",
            "6. POST: No active actives (Vit C/Retinol) for 24hrs."
        ]
    },
    massage: {
        title: "üíÜ LYMPHATIC MASSAGE",
        steps: [
            "1. OIL: Apply facial oil for slip.",
            "2. OPEN: Pump lymph nodes at collarbone 5x.",
            "3. JAW: Knuckles from chin to ear. Firm pressure.",
            "4. CHEEK: Palms lift cheekbones to temples.",
            "5. EYES: Ring finger gentle circles outward.",
            "6. DRAIN: Sweep down neck to collarbone."
        ]
    },
    cupping: {
        title: "üîµ BACK CUPPING THERAPY",
        steps: [
            "1. OIL: Apply oil to back.",
            "2. STATIC: Place cups on upper traps/tight knots. Leave 3-5m.",
            "3. SLIDING: Move cup along erector spinae (spine muscles).",
            "4. AVOID: Directly on spine bones or kidneys.",
            "5. MARK: Dark circles = stagnation (normal)."
        ]
    },
    normatec: {
        title: "ü¶µ NORMATEC RECOVERY",
        steps: [
            "1. SETUP: Legs/Hips attachment.",
            "2. INTENSITY: Level 7 (Max flush) or 5 (Relax).",
            "3. TIME: 30-45 minutes.",
            "4. ZONE BOOST: Activate on Quads if sore from squats.",
            "5. HYDRATE: Drink 16oz water after."
        ]
    },
    inshape: {
        title: "üèä INSHAPE SUNDAY RITUAL",
        steps: [
            "1. STEAM: 15 mins (Detox/Pores).",
            "2. SAUNA: 15-20 mins (Heat Shock Proteins).",
            "3. POOL: 20 mins light swim/stretch.",
            "4. AQUA BED: 30 mins massage.",
            "5. SHOWER: Cold finish."
        ]
    }
};

// --- APP CLASS ---
class CenturionApp {
    constructor() {
        console.log('üöÄ Init v17.64 PROTOCOL-MASTER');
        const CURRENT_VER = '17.64.0';
        const savedVer = localStorage.getItem('centurion_version');
        if(savedVer !== CURRENT_VER) { localStorage.clear(); localStorage.setItem('centurion_version', CURRENT_VER); }

        this.user = localStorage.getItem('centurion_user') || 'jermaine';
        this.history = [];
        this.currentIndex = 0;
        this.currentDateStr = new Date().toLocaleDateString('en-CA');
        this.checked = {};
        this.meals = {};
        this.bios = {};
        this.customMeals = {};
        this.protocol = [];
        
        this.loadUserData();
        this.setPlaceholderData();
        this.render();
        this.fetchOuraData();
    }

    loadUserData() {
        try {
            const savedChecked = localStorage.getItem(`c_checked_${this.user}`);
            this.checked = savedChecked ? JSON.parse(savedChecked) : {};
            const savedMeals = localStorage.getItem(`c_meals_${this.user}`);
            this.meals = savedMeals ? JSON.parse(savedMeals) : {};
            const savedBios = localStorage.getItem(`c_bios_${this.user}`);
            this.bios = savedBios ? JSON.parse(savedBios) : USERS[this.user].defaultBios;
            const savedCustom = localStorage.getItem(`c_custom_meals_${this.user}`);
            this.customMeals = savedCustom ? JSON.parse(savedCustom) : {};
        } catch(e) { this.checked = {}; this.meals = {}; }
    }

    saveUserData() {
        localStorage.setItem(`c_checked_${this.user}`, JSON.stringify(this.checked));
        localStorage.setItem(`c_meals_${this.user}`, JSON.stringify(this.meals));
        localStorage.setItem(`c_bios_${this.user}`, JSON.stringify(this.bios));
        localStorage.setItem(`c_custom_meals_${this.user}`, JSON.stringify(this.customMeals));
    }

    setPlaceholderData() {
        this.history = [{ date: this.currentDateStr, score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: [] }];
        this.currentIndex = 0;
    }

    getJermaineFacialProtocol(dayOfWeek, isFirstSunday) {
        if (dayOfWeek === 0 && isFirstSunday) return ['microneedling', 'üìç MICRONEEDLING DAY', 'Deep Cleanse > Needling > Cold'];
        if (dayOfWeek === 1 || dayOfWeek === 3 || dayOfWeek === 5) return ['microcurrent', '‚ö° MICROCURRENT', 'Lift & Tone Jawline'];
        if (dayOfWeek === 2 || dayOfWeek === 4) return ['massage', 'üíÜ MASSAGE + SCULPT', 'Manual lymphatic drainage'];
        return ['massage', '‚ú® MAINTENANCE', 'Light massage'];
    }

    getSophiaFacialProtocol(dayOfWeek) {
        if (dayOfWeek === 2 || dayOfWeek === 4 || dayOfWeek === 0) return ['massage', 'üí™ RECOVERY FACIAL', 'Focus on jaw tension'];
        if (dayOfWeek === 3) return ['massage', 'üßº DEEP CLEAN', 'Double cleanse + Heat'];
        return ['massage', '‚ú® QUICK MAINTENANCE', 'Cold wand + Moisturizer'];
    }

    getCouplesRecoveryProtocol(dayOfWeek) {
        if (dayOfWeek === 2 || dayOfWeek === 4) return ['cupping', 'üîµ BACK CUPPING', 'Upper Traps & Lats'];
        if (dayOfWeek === 1 || dayOfWeek === 5 || dayOfWeek === 0) return ['normatec', 'ü¶µ NORMATEC TIME', 'Level 7 Flush'];
        if (dayOfWeek === 0) return ['inshape', 'üèä SUNDAY RITUAL', 'Steam > Sauna > Pool'];
        return ['massage', '‚ú® LIGHT RECOVERY', 'Hand massage/Stretch'];
    }

    showProtocolDetails(typeKey) {
        const modalBody = document.getElementById('modalBody');
        const detail = PROTOCOL_DETAILS[typeKey] || { title: "ROUTINE", steps: ["Follow standard protocol."] };
        
        let html = `
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:1.5rem; font-weight:900; color:#fff;">${detail.title}</div>
            </div>
            <div style="background:#111; border-radius:12px; border:1px solid #333; overflow:hidden;">
                ${detail.steps.map(s => `<div style="padding:15px; border-bottom:1px solid #222; font-size:0.9rem; color:#ccc;">${s}</div>`).join('')}
            </div>`;
        
        this.setText('modalTitle', 'PROTOCOL STEPS');
        modalBody.innerHTML = html;
        document.getElementById('mainModal').classList.add('show');
        document.getElementById('fixedFooter').classList.remove('show');
    }

    async fetchOuraData() {
        this.setText('syncStatus', 'SYNCING...');
        const token = TOKENS[this.user];
        const end = new Date(); end.setDate(end.getDate() + 1);
        const start = new Date(); start.setDate(start.getDate() - 10);
        const startStr = start.toISOString().split('T')[0];
        const endStr = end.toISOString().split('T')[0];

        try {
            // Attempt Real Fetch via Proxy
            const [s, w, a, r] = await Promise.all([
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/workout?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            if (!s.ok) throw new Error('API_FAIL');
            const [sD, wD, aD, rD] = await Promise.all([s.json(), w.json(), a.json(), r.json()]);
            this.processData(sD.data || [], wD.data || [], aD.data || [], rD.data || []);
            this.setText('syncStatus', 'SYNCED ‚úì');
            this.render();

        } catch (error) {
            console.warn('Oura Sync Failed, Loading Simulation:', error);
            // FALLBACK SIMULATION DATA SO APP WORKS
            const simSleep = [{ day: this.currentDateStr, score: 88, total_sleep_duration: 27000, deep_sleep_duration: 5400, rem_sleep_duration: 6300 }];
            const simReady = [{ day: this.currentDateStr, contributors: { resting_heart_rate: 48 } }];
            const simActivity = [{ day: this.currentDateStr, active_calories: 450, high_activity_time: 1200, medium_activity_time: 2400 }];
            this.processData(simSleep, [], simActivity, simReady);
            this.setText('syncStatus', 'SIMULATION MODE');
            this.render();
        }
    }

    processData(sleepData, workoutData, activityData, readinessData) {
        const dataMap = new Map();
        const getDay = (date) => {
            if(!dataMap.has(date)) { dataMap.set(date, { date: date, score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: [] }); }
            return dataMap.get(date);
        };
        sleepData.forEach(s => {
            const d = getDay(s.day);
            d.totalSec += s.total_sleep_duration || 0;
            d.deepSec += s.deep_sleep_duration || 0;
            d.remSec += s.rem_sleep_duration || 0;
            if (s.score && s.score > d.score) d.score = s.score;
        });
        readinessData.forEach(r => { const d = getDay(r.day); if (r.contributors?.resting_heart_rate) d.rhr = r.contributors.resting_heart_rate; });
        workoutData.forEach(w => {
            const d = getDay(w.day);
            const dateObj = new Date(w.start_datetime);
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: false });
            d.workouts.push({ type: w.activity || 'other', intensity: w.intensity || 'moderate', calories: w.calories || 300, time: timeStr, start: w.start_datetime });
        });
        activityData.forEach(a => { const d = getDay(a.day); d.cal = a.active_calories || 0; d.high = (a.high_activity_time || 0)/60; d.med = (a.medium_activity_time || 0)/60; });
        this.history = Array.from(dataMap.values()).sort((a, b) => b.date.localeCompare(a.date));
        this.currentIndex = this.history.findIndex(h => h.date === this.currentDateStr);
        if (this.currentIndex === -1) { this.history.unshift({ date: this.currentDateStr, score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: [] }); this.currentIndex = 0; }
    }

    changeDate(direction) {
        const newIndex = this.currentIndex - direction;
        if (newIndex >= 0 && newIndex < this.history.length) { this.currentIndex = newIndex; this.currentDateStr = this.history[newIndex].date; this.render(); }
    }

    switchUser(newUser) {
        if (newUser === this.user) return;
        this.setText('statusMsg', 'SWITCHING...');
        document.querySelectorAll('.user-switch button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${newUser}`).classList.add('active');
        this.user = newUser; localStorage.setItem('centurion_user', newUser);
        this.history = []; this.loadUserData(); this.setPlaceholderData(); this.render(); this.fetchOuraData();
    }

    toggleTask(taskId) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.checked[dateKey]) this.checked[dateKey] = [];
        const index = this.checked[dateKey].indexOf(taskId);
        if (index === -1) this.checked[dateKey].push(taskId); else this.checked[dateKey].splice(index, 1);
        this.saveUserData();
        this.render();
    }

    calculateBMI() {
        const weight = parseFloat(this.bios.weight);
        const heightInches = USERS[this.user].goals.heightInches || 70;
        if (!weight || !heightInches) return null;
        return ((weight / (heightInches * heightInches)) * 703).toFixed(1);
    }

    calculateLongevityScore() {
        let score = 0;
        const hba1c = parseFloat(this.bios.hba1c); if (hba1c < 5.7) score += 20;
        const apob = parseFloat(this.bios.apob); if (apob < 90) score += 20;
        return 85 + (score > 0 ? 15 : 0);
    }

    openBio() {
        const modalBody = document.getElementById('modalBody');
        this.setText('modalTitle', 'BIOMETRICS');
        try {
            const bmi = this.calculateBMI() || '--';
            let html = `
                <div style="padding:20px;">
                    <div style="background:#111; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #333;">
                        <div style="color:#888; font-size:0.7rem; margin-bottom:5px;">CURRENT WEIGHT</div>
                        <div style="font-size:2rem; font-weight:900;">${this.bios.weight} lbs</div>
                        <div style="color:var(--acid); font-size:0.8rem;">BMI: ${bmi} | BMR: ${this.bios.bmr}</div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label style="font-size:0.6rem; color:#666;">WEIGHT</label><input id="bio-weight" type="number" value="${this.bios.weight}" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:#fff; border-radius:6px;"></div>
                        <div><label style="font-size:0.6rem; color:#666;">BMR</label><input id="bio-bmr" type="number" value="${this.bios.bmr}" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:#fff; border-radius:6px;"></div>
                    </div>
                    <button onclick="app.saveBio()" style="width:100%; background:var(--acid); color:#000; padding:15px; margin-top:20px; border:none; border-radius:10px; font-weight:900;">SAVE</button>
                </div>`;
            modalBody.innerHTML = html;
            document.getElementById('mainModal').classList.add('show');
            document.getElementById('fixedFooter').classList.remove('show');
        } catch (e) { console.error(e); }
    }

    saveBio() {
        const w = document.getElementById('bio-weight').value;
        const b = document.getElementById('bio-bmr').value;
        if(w) this.bios.weight = w;
        if(b) this.bios.bmr = b;
        this.saveUserData();
        this.closeModal();
        this.render();
    }

    openCustomBuilder(mealSlot) {
        const modalBody = document.getElementById('modalBody');
        this.setText('modalTitle', 'ADD CUSTOM');
        modalBody.innerHTML = `<div class="builder-form"><input id="cust-name" class="form-input" placeholder="Name"><br><br><input id="cust-p" class="form-input" type="number" placeholder="Protein"><br><br><input id="cust-cal" class="form-input" type="number" placeholder="Calories"><br><br><button class="select-btn" onclick="app.saveCustomMeal('${mealSlot}')">SAVE</button></div>`;
        document.getElementById('fixedFooter').classList.remove('show');
    }

    saveCustomMeal(mealSlot) {
        const name = document.getElementById('cust-name').value;
        const p = parseInt(document.getElementById('cust-p').value)||0;
        const cal = parseInt(document.getElementById('cust-cal').value)||0;
        if(!name) return;
        if(!this.customMeals[mealSlot]) this.customMeals[mealSlot] = [];
        this.customMeals[mealSlot].push({ title: name, macros: {p:p, o:0, f:0, cal:cal}, ingredients: ["Custom"], colors: ['white'], isCustom: true });
        this.saveUserData();
        this.selectMeal(mealSlot, (MEAL_DATABASE[mealSlot]||[]).length + this.customMeals[mealSlot].length - 1);
    }

    openMealPicker(mealSlot) {
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = '';
        this.setText('modalTitle', mealSlot.toUpperCase());
        document.getElementById('fixedFooter').classList.remove('show');
        const all = [...(MEAL_DATABASE[mealSlot]||[]), ...(this.customMeals[mealSlot]||[])];
        let html = `<div class="custom-btn-container"><button class="custom-btn" onclick="app.openCustomBuilder('${mealSlot}')">Ôºã CUSTOM</button></div>`;
        all.forEach((m, i) => {
            html += `<div class="menu-item" onclick="${m.isCustom ? `app.selectMeal('${mealSlot}', ${i})` : `app.showRecipe('${mealSlot}', ${i})`}"><div class="menu-left"><div class="menu-name">${m.title}</div><div class="menu-meta">P:${m.macros.p}</div></div><div class="menu-right">‚Ä∫</div></div>`;
        });
        modalBody.innerHTML += html;
        document.getElementById('mainModal').classList.add('show');
    }

    showRecipe(mealSlot, index) {
        const meal = MEAL_DATABASE[mealSlot][index];
        const modalBody = document.getElementById('modalBody');
        document.getElementById('logBtnAction').onclick = () => app.selectMeal(mealSlot, index);
        document.getElementById('fixedFooter').classList.add('show');
        let html = `<div class="recipe-hero"><div class="recipe-title">${meal.title}</div><div class="recipe-stats">${meal.time}</div></div>`;
        html += `<div class="macro-grid"><div class="macro-stat"><div class="m-val">${meal.macros.p}</div><div class="m-lbl">PRO</div></div><div class="macro-stat"><div class="m-val">${meal.macros.cal}</div><div class="m-lbl">CAL</div></div></div>`;
        html += `<div class="synergy-box"><div class="syn-title">WHY</div><div class="syn-text">${meal.why}</div></div>`;
        this.setText('modalTitle', 'RECIPE');
        modalBody.innerHTML = html;
    }

    closeModal() { document.getElementById('mainModal').classList.remove('show'); document.getElementById('fixedFooter').classList.remove('show'); }
    selectMeal(mealSlot, index) {
        const date = this.history[this.currentIndex].date;
        if(!this.meals[date]) this.meals[date] = {};
        this.meals[date][mealSlot] = index;
        this.saveUserData();
        this.closeModal();
        this.render();
    }

    calculateSleepDebt() {
        const today = new Date().toLocaleDateString('en-CA');
        const last7 = this.history.filter(d => d.date !== today && d.totalSec > 0).slice(0, 7);
        let debt = 0;
        last7.forEach(d => { const def = 8 - (d.totalSec/3600); if(def > 0) debt += def; });
        return debt;
    }

    calculateMacros() {
        const date = this.history[this.currentIndex].date;
        const checked = this.checked[date] || [];
        let t = { protein: 0, omega3: 0, fiber: 0, calories: 0, burn: 0 };
        this.protocol.forEach(task => {
            if(checked.includes(task.id)) {
                t.protein += task.macros.p||0; t.omega3 += task.macros.o||0;
                t.fiber += task.macros.f||0; t.calories += task.macros.cal||0; t.burn += task.calBurn||0;
            }
        });
        return t;
    }

    calculateRainbow() {
        const date = this.history[this.currentIndex].date;
        const checked = this.checked[date] || [];
        let c = new Set();
        this.protocol.forEach(t => { if(checked.includes(t.id) && t.colors) t.colors.forEach(col => c.add(col)); });
        return c;
    }

    render() {
        if(!this.history.length) return;
        this.protocol = JSON.parse(JSON.stringify(BASE_PROTOCOL));
        const day = this.history[this.currentIndex];
        const date = day.date;
        const selected = this.meals[date] || {};

        // INJECT FACIAL & RECOVERY
        const dayOfWeek = new Date(date).getDay();
        const isFirstSunday = new Date(date).getDate() <= 7;
        const facial = this.user === 'jermaine' ? this.getJermaineFacialProtocol(dayOfWeek, isFirstSunday) : this.getSophiaFacialProtocol(dayOfWeek);
        const recovery = this.getCouplesRecoveryProtocol(dayOfWeek);
        
        // Recovery Routine (Interactive)
        this.protocol.push({
            id: 'recovery_routine', time: dayOfWeek === 0 ? '11:00' : '20:00', 
            title: recovery[1].replace(/\*\*/g,''), 
            desc: "Tap for protocol steps", 
            macros:{p:0,o:0,f:0,cal:0}, colors: ['blue'], clickable: true, autoDetected: true,
            type: recovery[0] // Key for PROTOCOL_DETAILS
        });

        // Facial Routine (Interactive)
        this.protocol.push({
            id: 'facial_routine', time: '21:15', 
            title: facial[1].replace(/\*\*/g,''), 
            desc: "Tap for protocol steps", 
            macros:{p:0,o:0,f:0,cal:0}, colors: ['purple'], clickable: true, autoDetected: true,
            type: facial[0] // Key for PROTOCOL_DETAILS
        });

        this.protocol.forEach(t => {
            if(t.mealSlot && selected[t.mealSlot] !== undefined) {
                const all = [...(MEAL_DATABASE[t.mealSlot]||[]), ...(this.customMeals[t.mealSlot]||[])];
                if(all[selected[t.mealSlot]]) {
                    const m = all[selected[t.mealSlot]];
                    t.title = m.title; t.desc = `P:${m.macros.p} C:${m.macros.cal}`; t.macros = m.macros; t.colors = m.colors;
                }
            }
        });

        // Sort timeline
        this.protocol.sort((a,b) => a.time.localeCompare(b.time));

        this.setText('dateLabel', date);
        const macros = this.calculateMacros();
        const score = Math.min(100, Math.round(((day.totalSec||0)/3600/8)*100));
        this.setText('dayGrade', score >= 85 ? 'A' : score >= 70 ? 'B' : 'C');
        
        // Update Orbs
        const upd = (id, val, max, col) => {
            const el = document.getElementById(id);
            if(el) { el.style.strokeDashoffset = 145 - (Math.min(val/max,1)*145); el.style.stroke = col; }
            const txt = document.getElementById(id.replace('Orb','Val'));
            if(txt) txt.innerText = Math.round(val);
        };
        upd('sleepOrb', (day.totalSec||0)/3600, 8, '#bf5af2');
        upd('proteinOrb', macros.protein, USERS[this.user].goals.protein, '#fff');
        upd('omega3Orb', macros.omega3, 4000, '#00d4ff');
        upd('fiberOrb', macros.fiber, 50, '#30d158');
        upd('calorieOrb', macros.calories, 2500, '#FFD60A');

        // Rainbow
        const colors = this.calculateRainbow();
        this.setText('rainbowScore', Math.round((colors.size/6)*100)+'%');
        let rh = '';
        ['red','orange','yellow','green','purple','white'].forEach(c => {
            rh += `<div class="rainbow-seg" style="background:${colors.has(c)?RAINBOW_COLORS[c].hex:'#333'}; width:${colors.has(c)?16.6:0}%"></div>`;
        });
        document.getElementById('rainbowTrack').innerHTML = rh;

        // Timeline
        const checked = this.checked[date] || [];
        let th = '';
        this.protocol.forEach(t => {
            const isC = checked.includes(t.id);
            let clickAttr = '';
            if (t.clickable) {
                if (t.type && (t.type in PROTOCOL_DETAILS)) {
                    clickAttr = `onclick="app.showProtocolDetails('${t.type}')"`;
                } else if (t.mealSlot) {
                    clickAttr = `onclick="app.openMealPicker('${t.mealSlot}')"`;
                }
            }
            th += `<div class="task"><div class="task-time">${t.time}</div><div class="task-card ${isC?'checked':''} ${t.autoDetected?'auto-detected':''}" ${clickAttr}><div class="task-info"><div class="task-title">${t.title}</div><div class="task-desc">${t.desc}</div></div>${t.clickable?'<div class="chevron">‚Ä∫</div>':''}${!t.autoDetected?`<div class="check-btn" onclick="event.stopPropagation(); app.toggleTask('${t.id}')"><div class="check-circle">${isC?'‚úì':''}</div></div>`:''}</div></div>`;
        });
        document.getElementById('timeline').innerHTML = th;
    }

    setText(id, txt) { const el = document.getElementById(id); if(el) el.innerText = txt; }
    sync() { this.fetchOuraData(); }
}

let app;
window.onload = () => { app = new CenturionApp(); window.app = app; };
</script>
</body>
</html>