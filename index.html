<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v23 - Oura Synergy</title>
<style>
:root{--bg:#0a0a0c;--panel:#141418;--panel-elevated:#1a1a20;--border:rgba(255,255,255,0.08);--acid:#c8ff00;--cyan:#00d4ff;--purple:#a855f7;--alert:#ff4757;--orange:#ff9500;--success:#34d399;--text:#fff;--text-secondary:rgba(255,255,255,0.6);--text-tertiary:rgba(255,255,255,0.4)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding-bottom:140px;min-height:100vh;background-image:radial-gradient(ellipse at 20% 0%,rgba(200,255,0,0.03) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(0,212,255,0.03) 0%,transparent 50%)}
.header{background:rgba(10,10,12,0.95);padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px)}
.user-switch{display:flex;gap:8px;background:var(--panel);padding:4px;border-radius:16px;margin-bottom:12px;border:1px solid var(--border)}
.user-switch button{flex:1;padding:10px;border:none;background:transparent;color:var(--text-tertiary);border-radius:12px;cursor:pointer;font-weight:700;font-size:0.7rem;letter-spacing:1px;transition:all 0.3s}
.user-switch button.active{background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;box-shadow:0 4px 20px rgba(200,255,0,0.3)}
.date-nav{display:flex;justify-content:space-between;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px 12px}
.nav-btn{background:transparent;border:none;color:var(--cyan);padding:8px 16px;font-size:1.1rem;cursor:pointer}
#dateLabel{flex:1;text-align:center;font-weight:600;font-size:0.85rem}
.bio-btn{background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;border:none;padding:10px 16px;border-radius:10px;font-size:0.65rem;font-weight:800;cursor:pointer}
.section-header{padding:20px 20px 12px;font-size:0.65rem;font-weight:700;color:var(--text-tertiary);letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;gap:12px}
.section-header::after{content:'';height:1px;background:var(--border);flex:1}
.recovery-battery{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:20px;margin:20px;position:relative;overflow:hidden}
.recovery-battery::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#4facfe,#00f2fe)}
.battery-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.battery-title{font-size:0.7rem;font-weight:700;color:var(--text-secondary);letter-spacing:1.5px}
.battery-score{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,#4facfe,#00f2fe);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.battery-bar{height:12px;background:var(--panel-elevated);border-radius:6px;overflow:hidden;margin-bottom:12px}
.battery-fill{height:100%;background:linear-gradient(90deg,#4facfe,#00f2fe);border-radius:6px;transition:width 1s;box-shadow:0 0 20px rgba(79,172,254,0.4)}
.battery-components{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.battery-component{text-align:center;padding:8px;background:var(--panel-elevated);border-radius:8px}
.bc-value{font-size:0.9rem;font-weight:700}
.bc-label{font-size:0.5rem;color:var(--text-tertiary);text-transform:uppercase;margin-top:2px}
.bc-trend{font-size:0.55rem;margin-top:2px}
.trend-up{color:var(--success)}
.trend-down{color:var(--alert)}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:0 20px;margin-bottom:20px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:0 20px;margin-bottom:20px}
.orb-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px 8px 12px;display:flex;flex-direction:column;align-items:center;transition:transform 0.2s}
.orb-card:active{transform:scale(0.97)}
.orb-card.alert{border-color:var(--alert);background:rgba(255,71,87,0.1)}
.orb-card.warning{border-color:var(--orange);background:rgba(255,149,0,0.1)}
.orb-card.optimal{border-color:var(--success);background:rgba(52,211,153,0.1)}
.orb-container{width:52px;height:52px;position:relative;margin-bottom:8px}
.orb-svg{transform:rotate(-90deg);width:100%;height:100%;position:absolute}
.orb-bg{fill:none;stroke:var(--panel-elevated);stroke-width:5}
.orb-fg{fill:none;stroke-width:5;stroke-dasharray:138;stroke-dashoffset:138;transition:stroke-dashoffset 1s;stroke-linecap:round;filter:drop-shadow(0 0 6px currentColor)}
.orb-val-box{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.orb-val{font-size:0.75rem;font-weight:800;line-height:1}
.orb-label{font-size:0.5rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase}
.orb-trend{position:absolute;top:6px;right:6px;font-size:0.55rem;font-weight:700}
.hrv-card{background:linear-gradient(135deg,var(--panel) 0%,rgba(168,85,247,0.1) 100%);border-color:var(--purple)}
.hrv-wave{width:100%;height:28px;margin-bottom:8px}
.hrv-wave-path{fill:none;stroke:var(--purple);stroke-width:2;stroke-linecap:round;filter:drop-shadow(0 0 4px var(--purple))}
.temp-indicator{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:8px;font-size:1.2rem}
.temp-normal{background:rgba(52,211,153,0.15);border:2px solid var(--success)}
.temp-elevated{background:rgba(255,149,0,0.15);border:2px solid var(--orange)}
.temp-high{background:rgba(255,71,87,0.15);border:2px solid var(--alert)}
.sleep-debt-card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:0 20px 20px;display:flex;align-items:center;gap:16px}
.sleep-debt-visual{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
.debt-positive{background:rgba(255,71,87,0.15);border:2px solid var(--alert)}
.debt-negative{background:rgba(52,211,153,0.15);border:2px solid var(--success)}
.debt-neutral{background:var(--panel-elevated);border:2px solid var(--border)}
.sleep-debt-info{flex:1}
.sleep-debt-value{font-size:1.5rem;font-weight:800}
.sleep-debt-label{font-size:0.7rem;color:var(--text-tertiary)}
.insight-card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:0 20px 16px}
.insight-card.warning{border-left:3px solid var(--orange)}
.insight-card.alert{border-left:3px solid var(--alert)}
.insight-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.insight-icon{font-size:1.2rem}
.insight-title{font-size:0.8rem;font-weight:700}
.insight-body{font-size:0.75rem;color:var(--text-secondary);line-height:1.5}
.insight-action{margin-top:10px;padding:10px;background:rgba(200,255,0,0.1);border-radius:8px;font-size:0.7rem;color:var(--acid);font-weight:600}
.score-row{display:flex;gap:12px;justify-content:center;padding:20px}
.score-orb{flex:0 0 90px;height:90px;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer}
.score-orb svg{position:absolute;width:100%;height:100%;transform:rotate(-90deg)}
.score-orb-bg{fill:none;stroke:var(--panel-elevated);stroke-width:6}
.score-orb-fg{fill:none;stroke-width:6;stroke-linecap:round;stroke-dasharray:251;stroke-dashoffset:251;transition:stroke-dashoffset 1.5s;filter:drop-shadow(0 0 8px currentColor)}
.score-orb-value{font-size:1.6rem;font-weight:800;z-index:1}
.score-orb-label{font-size:0.45rem;color:var(--text-tertiary);text-transform:uppercase;z-index:1}
.score-orb.primary{flex:0 0 110px;height:110px}
.score-orb.primary .score-orb-value{font-size:2.2rem;background:linear-gradient(135deg,#c8ff00,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.score-orb-badge{position:absolute;bottom:-6px;background:var(--panel);border:1px solid var(--border);padding:2px 6px;border-radius:8px;font-size:0.4rem;color:var(--cyan);font-weight:700}
.status-container{margin:0 20px 20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;border-left:3px solid var(--acid)}
.status-label{font-size:0.6rem;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.status-msg{font-size:0.85rem;font-weight:600;line-height:1.4}
.heart-container{width:52px;height:52px;position:relative;margin-bottom:8px}
.heart-svg{width:100%;height:100%}
.heart-bg{fill:none;stroke:var(--panel-elevated);stroke-width:2}
.heart-fg{fill:none;stroke-width:2.5;stroke-dasharray:100;stroke-dashoffset:100;transition:stroke-dashoffset 1s;filter:drop-shadow(0 0 4px currentColor)}
.beating{animation:heartbeat 1.5s infinite}
@keyframes heartbeat{0%,100%{transform:scale(1)}15%{transform:scale(1.08)}30%{transform:scale(1)}45%{transform:scale(1.08)}}
.timeline{padding:0 20px 40px}
.task{display:flex;gap:12px;margin-bottom:14px}
.task-time{width:50px;color:var(--text-tertiary);font-size:0.7rem;padding-top:16px;text-align:right;font-weight:600}
.task-card{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s}
.task-card:active{transform:scale(0.98)}
.task-card.checked{border-color:var(--acid);background:rgba(200,255,0,0.05)}
.task-card.auto-detected{border-color:var(--cyan);background:rgba(0,212,255,0.05)}
.task-card.hrv-adjusted{border-color:var(--orange);background:rgba(255,149,0,0.05)}
.task-info{flex:1}
.task-title{font-weight:700;font-size:0.85rem;margin-bottom:4px}
.task-desc{font-size:0.7rem;color:var(--text-secondary)}
.chevron{font-size:1.3rem;color:var(--text-tertiary);margin-left:12px}
.check-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.check-circle{width:28px;height:28px;border:2px solid var(--border);border-radius:50%;background:var(--panel-elevated);display:flex;align-items:center;justify-content:center;font-weight:800;color:transparent;transition:all 0.2s}
.task-card.checked .check-circle{background:var(--acid);border-color:var(--acid);color:#000;box-shadow:0 0 15px var(--acid)}
.water-container,.rainbow-container{padding:0 20px;margin-bottom:20px}
.water-header,.rainbow-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.water-title,.rainbow-title{font-size:0.7rem;font-weight:700;color:var(--text-secondary)}
.water-score{font-size:1rem;font-weight:800;color:var(--cyan)}
.rainbow-score{font-size:1rem;font-weight:800;color:var(--acid)}
.water-track{height:12px;background:var(--panel);border-radius:6px;overflow:hidden;border:1px solid var(--border);cursor:pointer}
.water-fill{height:100%;background:linear-gradient(90deg,#00d4ff,#0088ff);border-radius:6px;transition:width 0.3s}
.rainbow-track{height:12px;background:var(--panel);border-radius:6px;display:flex;overflow:hidden;border:1px solid var(--border)}
.rainbow-seg{height:100%;transition:width 0.5s}
.footer{position:fixed;bottom:0;left:0;width:100%;background:rgba(10,10,12,0.95);backdrop-filter:blur(20px);padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;z-index:90}
.sync-status{font-size:0.65rem;color:var(--text-tertiary)}
.sync-btn{background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;border:none;padding:10px 20px;border-radius:10px;font-weight:700;font-size:0.75rem;cursor:pointer}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:500;display:none;overflow-y:auto;backdrop-filter:blur(10px)}
.modal-overlay.show{display:block}
.modal-content{width:100%;min-height:100vh;background:var(--bg);padding-bottom:100px}
.modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:rgba(10,10,12,0.95);backdrop-filter:blur(20px);z-index:10}
.modal-title{font-size:1rem;font-weight:800;color:var(--acid);text-transform:uppercase;letter-spacing:1px}
.modal-close{background:transparent;border:none;color:var(--text);font-size:2rem;cursor:pointer;padding:8px}
.modal-body{padding:20px}
.menu-item{padding:18px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.menu-item:active{background:var(--panel-elevated)}
.menu-name{font-size:0.95rem;font-weight:700;margin-bottom:4px}
.menu-meta{font-size:0.7rem;color:var(--text-secondary)}
.menu-arrow{color:var(--text-tertiary);font-size:1.3rem}
</style>
</head>
<body>
<div class="header">
<div class="user-switch">
<button id="btn-jermaine" onclick="app.switchUser('jermaine')">JERMAINE</button>
<button id="btn-sophia" onclick="app.switchUser('sophia')">SOPHIA</button>
</div>
<div class="date-nav">
<button class="nav-btn" onclick="app.changeDate(-1)">‚óÄ</button>
<span id="dateLabel">LOADING...</span>
<button class="nav-btn" onclick="app.changeDate(1)">‚ñ∂</button>
<button class="bio-btn" onclick="app.openBio()">BIO</button>
</div>
</div>

<div class="recovery-battery">
<div class="battery-header">
<div class="battery-title">‚ö° RECOVERY BATTERY</div>
<div class="battery-score" id="batteryScore">--</div>
</div>
<div class="battery-bar"><div class="battery-fill" id="batteryFill" style="width:0%"></div></div>
<div class="battery-components">
<div class="battery-component"><div class="bc-value" id="bcHrv">--</div><div class="bc-label">HRV</div><div class="bc-trend" id="bcHrvTrend"></div></div>
<div class="battery-component"><div class="bc-value" id="bcSleep">--</div><div class="bc-label">SLEEP</div><div class="bc-trend" id="bcSleepTrend"></div></div>
<div class="battery-component"><div class="bc-value" id="bcReadiness">--</div><div class="bc-label">READY</div><div class="bc-trend" id="bcReadinessTrend"></div></div>
<div class="battery-component"><div class="bc-value" id="bcStrain">--</div><div class="bc-label">STRAIN</div><div class="bc-trend" id="bcStrainTrend"></div></div>
</div>
</div>

<div class="score-row">
<div class="score-orb" onclick="app.showSummary()">
<svg viewBox="0 0 100 100"><circle class="score-orb-bg" cx="50" cy="50" r="40"/><circle class="score-orb-fg" id="dayScoreOrb" cx="50" cy="50" r="40" style="stroke:var(--cyan)"/></svg>
<div class="score-orb-value" id="dayGrade">--</div>
<div class="score-orb-label">TODAY</div>
</div>
<div class="score-orb primary" onclick="app.showSummary()">
<svg viewBox="0 0 100 100"><circle class="score-orb-bg" cx="50" cy="50" r="40"/><circle class="score-orb-fg" id="longevityOrb" cx="50" cy="50" r="40" style="stroke:var(--acid)"/></svg>
<div class="score-orb-value" id="longevityScore">--</div>
<div class="score-orb-label">LONGEVITY</div>
<div class="score-orb-badge">7-DAY AVG</div>
</div>
<div class="score-orb">
<svg viewBox="0 0 100 100"><circle class="score-orb-bg" cx="50" cy="50" r="40"/><circle class="score-orb-fg" id="streakOrb" cx="50" cy="50" r="40" style="stroke:var(--acid)"/></svg>
<div class="score-orb-value" id="streakCount" style="color:var(--acid)">0</div>
<div class="score-orb-label">STREAK</div>
</div>
</div>

<div class="status-container">
<div class="status-label">üß† AI PROTOCOL ADVISOR</div>
<div class="status-msg" id="statusMsg">ANALYZING...</div>
</div>

<div id="insightContainer"></div>

<div class="section-header">RECOVERY METRICS (NEW)</div>
<div class="grid-4">
<div class="orb-card hrv-card" id="hrvCard">
<svg class="hrv-wave" viewBox="0 0 100 28"><path class="hrv-wave-path" id="hrvWave" d="M0,14 Q12,4 25,14 T50,14 T75,14 T100,14"/></svg>
<div class="orb-val" id="hrvVal" style="font-size:1.1rem;color:var(--purple)">--</div>
<div class="orb-label" style="color:var(--purple)">HRV (ms)</div>
<div class="orb-trend" id="hrvTrend"></div>
</div>
<div class="orb-card" id="tempCard">
<div class="temp-indicator temp-normal" id="tempIndicator">üå°Ô∏è</div>
<div class="orb-val" id="tempVal" style="font-size:0.9rem">+0.0¬∞</div>
<div class="orb-label">TEMP DEV</div>
</div>
<div class="orb-card">
<svg class="hrv-wave" viewBox="0 0 100 28" style="opacity:0.6"><path style="fill:none;stroke:var(--cyan);stroke-width:2" d="M0,14 Q25,0 50,14 T100,14"/></svg>
<div class="orb-val" id="respVal" style="font-size:1.1rem;color:var(--cyan)">--</div>
<div class="orb-label" style="color:var(--cyan)">RESP/MIN</div>
</div>
<div class="orb-card">
<div class="orb-container">
<svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="readinessOrb" cx="25" cy="25" r="22" style="stroke:var(--success)"/></svg>
<div class="orb-val-box"><div class="orb-val" id="readinessVal">--</div></div>
</div>
<div class="orb-label" style="color:var(--success)">READINESS</div>
</div>
</div>

<div class="section-header">SLEEP BANK</div>
<div class="sleep-debt-card">
<div class="sleep-debt-visual debt-neutral" id="sleepDebtVisual">üí§</div>
<div class="sleep-debt-info">
<div class="sleep-debt-value" id="sleepDebtValue">0h</div>
<div class="sleep-debt-label">7-DAY SLEEP BALANCE</div>
</div>
</div>

<div class="section-header">SLEEP ARCHITECTURE</div>
<div class="grid-3">
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="sleepOrb" cx="25" cy="25" r="22" style="stroke:var(--purple)"/></svg><div class="orb-val-box"><div class="orb-val" id="sleepVal">--</div></div></div><div class="orb-label" style="color:var(--purple)">TOTAL</div></div>
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="deepOrb" cx="25" cy="25" r="22" style="stroke:#667eea"/></svg><div class="orb-val-box"><div class="orb-val" id="deepVal">--</div></div></div><div class="orb-label" style="color:#667eea">DEEP</div></div>
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="remOrb" cx="25" cy="25" r="22" style="stroke:#f093fb"/></svg><div class="orb-val-box"><div class="orb-val" id="remVal">--</div></div></div><div class="orb-label" style="color:#f093fb">REM</div></div>
</div>

<div class="section-header">FUEL (NUTRITION)</div>
<div class="grid-4">
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="proteinOrb" cx="25" cy="25" r="22" style="stroke:#fff"/></svg><div class="orb-val-box"><div class="orb-val" id="proteinVal">0</div></div></div><div class="orb-label">PROTEIN</div></div>
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="omega3Orb" cx="25" cy="25" r="22" style="stroke:var(--cyan)"/></svg><div class="orb-val-box"><div class="orb-val" id="omega3Val">0</div></div></div><div class="orb-label" style="color:var(--cyan)">OMEGA-3</div></div>
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="fiberOrb" cx="25" cy="25" r="22" style="stroke:var(--success)"/></svg><div class="orb-val-box"><div class="orb-val" id="fiberVal">0</div></div></div><div class="orb-label" style="color:var(--success)">FIBER</div></div>
<div class="orb-card"><div class="orb-container"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="22"/><circle class="orb-fg" id="polyphenolOrb" cx="25" cy="25" r="22" style="stroke:var(--purple)"/></svg><div class="orb-val-box"><div class="orb-val" id="polyphenolVal">0</div></div></div><div class="orb-label" style="color:var(--purple)">POLYPHENOL</div></div>
</div>

<div class="section-header">ENGINE (CARDIO)</div>
<div class="grid-4">
<div class="orb-card"><div class="heart-container"><svg class="heart-svg beating" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/><path class="heart-fg" style="stroke:var(--alert);stroke-dasharray:none;stroke-dashoffset:0" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><div class="orb-val-box"><div class="orb-val" id="rhrVal" style="color:var(--alert)">--</div></div></div><div class="orb-label" style="color:var(--alert)">RHR</div></div>
<div class="orb-card"><div class="heart-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/><path class="heart-fg" id="z2Heart" pathLength="100" style="stroke:var(--cyan)" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><div class="orb-val-box"><div class="orb-val" id="z2Val" style="color:var(--cyan)">0</div></div></div><div class="orb-label" style="color:var(--cyan)">ZONE 2</div></div>
<div class="orb-card" id="z5Card"><div class="heart-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/><path class="heart-fg" id="z5Heart" pathLength="100" style="stroke:var(--alert)" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><div class="orb-val-box"><div class="orb-val" id="z5Val" style="color:var(--alert)">0</div></div></div><div class="orb-label" style="color:var(--alert)" id="z5Label">ZONE 5</div></div>
<div class="orb-card"><div class="heart-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/><path class="heart-fg" id="calHeart" pathLength="100" style="stroke:var(--orange)" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><div class="orb-val-box"><div class="orb-val" id="calVal" style="color:var(--orange)">0</div></div></div><div class="orb-label" style="color:var(--orange)">BURN</div></div>
</div>

<div class="section-header">HYDRATION üíß</div>
<div class="water-container">
<div class="water-header"><div class="water-title">WATER INTAKE</div><div class="water-score" id="waterScore">0 / 140 oz</div></div>
<div class="water-track" onclick="app.addWater()"><div class="water-fill" id="waterFill"></div></div>
</div>

<div class="section-header">PHYTONUTRIENT üåà</div>
<div class="rainbow-container">
<div class="rainbow-header"><div class="rainbow-title">RAINBOW SCORE</div><div class="rainbow-score" id="rainbowScore">0%</div></div>
<div class="rainbow-track" id="rainbowTrack"></div>
</div>

<div class="section-header">PROTOCOL</div>
<div class="timeline" id="timeline"></div>

<div class="modal-overlay" id="mainModal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title" id="modalTitle">MENU</div><button class="modal-close" onclick="app.closeModal()">√ó</button></div>
<div class="modal-body" id="modalBody"></div>
</div>
</div>

<div class="footer">
<span class="sync-status" id="syncStatus">INIT</span>
<button class="sync-btn" onclick="app.sync()">üîÑ SYNC</button>
</div>

<script>
const USERS={jermaine:{name:"Jermaine",goals:{protein:175,omega3:4000,fiber:50,water:140,sleepHours:8},defaultBios:{bmr:'2028'},hrvBaseline:45},sophia:{name:"Sophia",goals:{protein:130,omega3:4000,fiber:35,water:100,sleepHours:8},defaultBios:{bmr:'1450'},hrvBaseline:55}};
const TOKENS={jermaine:'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y',sophia:'4QSDWYJJUZFHRWRH727NCK7WH4COQJF4'};
const COLORS={red:'#ff4757',orange:'#ff9500',yellow:'#ffd60a',green:'#34d399',purple:'#a855f7',white:'#fff',brown:'#A0522D',pink:'#ff6b9d',cyan:'#00d4ff',black:'#000',silver:'#c0c0c0'};
const MEALS={breakfast:[{title:"Omega Breakfast",macros:{p:58,o:3500,f:12,cal:680,poly:450},colors:['orange','green']},{title:"Power Smoothie",macros:{p:55,o:8000,f:18,cal:680,poly:400},colors:['purple','green']},{title:"Greek Yogurt Bowl",macros:{p:20,o:0,f:4,cal:250,poly:150},colors:['white','purple']}],lunch:[{title:"Salmon Quinoa Bowl",macros:{p:58,o:4200,f:20,cal:720,poly:200},colors:['pink','green','brown']},{title:"Chicken Culture Bowl",macros:{p:68,o:800,f:12,cal:720,poly:200},colors:['brown','green','black']},{title:"Ahi Poke Bowl",macros:{p:53,o:1600,f:16,cal:620,poly:150},colors:['red','green','yellow']}],dinner:[{title:"Grass-Fed Steak",macros:{p:60,o:1200,f:14,cal:720,poly:100},colors:['red','green']},{title:"Sheet Pan Salmon",macros:{p:45,o:3200,f:10,cal:620,poly:150},colors:['orange','green']},{title:"Mixed Fajitas",macros:{p:62,o:1400,f:16,cal:620,poly:150},colors:['pink','white','green','red','black']}],snack1:[{title:"Edamame",macros:{p:12,o:400,f:8,cal:150,poly:100},colors:['green']},{title:"Sardines",macros:{p:22,o:2800,f:0,cal:190,poly:0},colors:['silver','white']},{title:"Eggs",macros:{p:12,o:100,f:0,cal:140,poly:0},colors:['white','yellow']}],snack2:[{title:"Hummus & Carrots",macros:{p:4,o:0,f:6,cal:150,poly:40},colors:['orange','white']},{title:"Protein Balls",macros:{p:12,o:800,f:4,cal:220,poly:30},colors:['brown']}],juices:[{title:"Golden Milk",macros:{p:2,o:0,f:0,cal:95,poly:250},colors:['yellow','white']},{title:"Green Tea",macros:{p:0,o:0,f:0,cal:5,poly:300},colors:['green']}]};
MEALS.juice2=MEALS.juices;MEALS.juice3=MEALS.juices;
const BASE=[{id:'juice2',time:'7:15 AM',title:'Morning Beverage',mealSlot:'juice2',cssClass:'optional'},{id:'breakfast',time:'7:30 AM',title:'Breakfast',mealSlot:'breakfast'},{id:'snack1',time:'10:00 AM',title:'Morning Snack',mealSlot:'snack1'},{id:'lunch',time:'1:00 PM',title:'Lunch',mealSlot:'lunch'},{id:'snack2',time:'3:00 PM',title:'Afternoon Snack',mealSlot:'snack2'},{id:'juice3',time:'3:30 PM',title:'Afternoon Beverage',mealSlot:'juice3',cssClass:'optional'},{id:'dinner',time:'6:30 PM',title:'Dinner',mealSlot:'dinner'}];

class CenturionApp{
constructor(){
console.log('üöÄ v23 - HRV FIX');
this.user=localStorage.getItem('c_user')||'jermaine';
this.history=[];this.currentIndex=0;this.currentDateStr=new Date().toLocaleDateString('en-CA');
this.checked=JSON.parse(localStorage.getItem(`c_chk_${this.user}`)||'{}');
this.meals=JSON.parse(localStorage.getItem(`c_meals_${this.user}`)||'{}');
this.portions=JSON.parse(localStorage.getItem(`c_portions_${this.user}`)||'{}');
this.water=JSON.parse(localStorage.getItem(`c_water_${this.user}`)||'{}');
this.bios=JSON.parse(localStorage.getItem(`c_bios_${this.user}`)||'null')||USERS[this.user].defaultBios;
this.currentPortion=1;this.streak=0;
document.querySelectorAll('.user-switch button').forEach(b=>b.classList.remove('active'));
document.getElementById(`btn-${this.user}`)?.classList.add('active');
this.setPlaceholder();this.render();this.fetchOura();
}
save(){
localStorage.setItem(`c_chk_${this.user}`,JSON.stringify(this.checked));
localStorage.setItem(`c_meals_${this.user}`,JSON.stringify(this.meals));
localStorage.setItem(`c_portions_${this.user}`,JSON.stringify(this.portions));
localStorage.setItem(`c_water_${this.user}`,JSON.stringify(this.water));
localStorage.setItem(`c_bios_${this.user}`,JSON.stringify(this.bios));
}
setPlaceholder(){this.history=[{date:this.currentDateStr,score:0,totalSec:0,deepSec:0,remSec:0,rhr:'-',cal:0,high:0,med:0,workouts:[],hrv:null,tempDev:0,respRate:null,readiness:null}];this.currentIndex=0}
async fetchOura(){
this.setText('syncStatus','SYNCING...');
try{
const end=new Date();end.setDate(end.getDate()+1);const start=new Date();start.setDate(start.getDate()-14);
const startStr=start.toISOString().split('T')[0],endStr=end.toISOString().split('T')[0];
const token=TOKENS[this.user],proxy='https://oura-proxy.jclarke-9a0.workers.dev?url=';
const eps=['sleep','workout','daily_activity','daily_readiness','daily_hrv'];
const results=await Promise.allSettled(eps.map(async ep=>{
const url=`${proxy}${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/${ep}?start_date=${startStr}&end_date=${endStr}`)}`;
const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});
if(!res.ok)throw new Error(ep);
return{name:ep,data:(await res.json()).data||[]};
}));
const data={};results.forEach(r=>{if(r.status==='fulfilled')data[r.value.name]=r.value.data});
this.processData(data);this.setText('syncStatus','SYNCED ‚úì');this.render();
}catch(e){console.error(e);this.setText('syncStatus','OFFLINE');this.render()}
}
processData(data){
const m=new Map();
const g=d=>{if(!m.has(d))m.set(d,{date:d,score:0,totalSec:0,deepSec:0,remSec:0,rhr:'-',cal:0,high:0,med:0,workouts:[],hrv:null,tempDev:0,respRate:null,readiness:null});return m.get(d)};
(data.sleep||[]).forEach(s=>{const d=g(s.day);d.totalSec+=s.total_sleep_duration||0;d.deepSec+=s.deep_sleep_duration||0;d.remSec+=s.rem_sleep_duration||0;if(s.lowest_heart_rate>=35&&s.lowest_heart_rate<=100)d.rhr=Math.round(s.lowest_heart_rate);if(s.average_breath)d.respRate=s.average_breath;const sc=s.score||(s.efficiency?Math.round(s.efficiency):0);if(sc>d.score)d.score=sc});
(data.daily_hrv||[]).forEach(h=>{const d=g(h.day);if(h.samples?.hrv?.length){const hrvVals=h.samples.hrv.map(s=>s.value);d.hrv=Math.round(hrvVals.reduce((a,b)=>a+b,0)/hrvVals.length)}});
(data.daily_readiness||[]).forEach(r=>{const d=g(r.day);d.readiness=r.score||null;if(r.contributors?.body_temperature)d.tempDev=(r.contributors.body_temperature-50)/10});
(data.daily_activity||[]).forEach(a=>{const d=g(a.day);d.cal=a.active_calories||0;d.high=(a.high_activity_time||0)/60;d.med=(a.medium_activity_time||0)/60});
(data.workout||[]).forEach(w=>{const d=g(w.day);d.workouts.push({type:w.label||w.activity||'workout',calories:w.calories||300,time:new Date(w.start_datetime).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})})});
this.history=Array.from(m.values()).sort((a,b)=>b.date.localeCompare(a.date));
this.currentIndex=this.history.findIndex(h=>h.date===this.currentDateStr);
if(this.currentIndex===-1){this.history.unshift({date:this.currentDateStr,score:0,totalSec:0,deepSec:0,remSec:0,rhr:'-',cal:0,high:0,med:0,workouts:[],hrv:null,tempDev:0,respRate:null,readiness:null});this.currentIndex=0}
}
changeDate(dir){const n=this.currentIndex-dir;if(n>=0&&n<this.history.length){this.currentIndex=n;this.currentDateStr=this.history[n].date;this.render()}}
switchUser(u){if(u===this.user)return;this.user=u;localStorage.setItem('c_user',u);document.querySelectorAll('.user-switch button').forEach(b=>b.classList.remove('active'));document.getElementById(`btn-${u}`).classList.add('active');this.checked=JSON.parse(localStorage.getItem(`c_chk_${u}`)||'{}');this.meals=JSON.parse(localStorage.getItem(`c_meals_${u}`)||'{}');this.portions=JSON.parse(localStorage.getItem(`c_portions_${u}`)||'{}');this.water=JSON.parse(localStorage.getItem(`c_water_${u}`)||'{}');this.bios=JSON.parse(localStorage.getItem(`c_bios_${u}`)||'null')||USERS[u].defaultBios;this.history=[];this.setPlaceholder();this.render();this.fetchOura()}
toggleTask(id){const dk=this.currentDateStr;if(!this.checked[dk])this.checked[dk]=[];const i=this.checked[dk].indexOf(id);if(i===-1)this.checked[dk].push(id);else this.checked[dk].splice(i,1);this.save();this.render()}
setText(id,txt){const el=document.getElementById(id);if(el)el.innerText=txt}
setCurrentPortion(p){this.currentPortion=p;this.showRecipe(this.currentMealSlot,this.currentMealIdx)}
calcMacros(){const sel=this.meals[this.currentDateStr]||{};const portions=this.portions[this.currentDateStr]||{};let t={protein:0,omega3:0,fiber:0,calories:0,polyphenol:0};Object.keys(sel).forEach(slot=>{const m=MEALS[slot]?.[sel[slot]];if(m){const portion=(slot==='breakfast'||slot==='lunch'||slot==='dinner'||slot==='snack1'||slot==='snack2')?(portions[slot]||1):1;t.protein+=m.macros.p*portion||0;t.omega3+=m.macros.o*portion||0;t.fiber+=m.macros.f*portion||0;t.calories+=m.macros.cal*portion||0;t.polyphenol+=(m.macros.poly||0)*portion}});return t}
calcRainbow(){const sel=this.meals[this.currentDateStr]||{};let s=new Set();Object.keys(sel).forEach(slot=>{const m=MEALS[slot]?.[sel[slot]];if(m?.colors)m.colors.forEach(c=>s.add(c))});return s}
addWater(){const d=this.currentDateStr;if(!this.water[d])this.water[d]=0;this.water[d]+=8;const target=USERS[this.user].goals.water;if(this.water[d]>target)this.water[d]=target;this.save();this.updateWater()}
updateWater(){const cur=this.water[this.currentDateStr]||0;const target=USERS[this.user].goals.water;this.setText('waterScore',`${cur} / ${target} oz`);document.getElementById('waterFill').style.width=`${Math.min(100,cur/target*100)}%`}
openMealPicker(slot){
this.setText('modalTitle',slot.toUpperCase());
const all=MEALS[slot]||[];const sel=this.meals[this.currentDateStr]?.[slot];
document.getElementById('modalBody').innerHTML=all.map((m,i)=>`<div class="menu-item" ${sel===i?'style="border-color:var(--acid)"':''} onclick="app.showRecipe('${slot}',${i})"><div><div class="menu-name">${sel===i?'‚úì ':''}${m.title}</div><div class="menu-meta">P:${m.macros.p}g Œ©3:${m.macros.o}mg Cal:${m.macros.cal}</div></div><div class="menu-arrow">‚Ä∫</div></div>`).join('');
document.getElementById('mainModal').classList.add('show');
}
showRecipe(slot,idx){
this.currentMealSlot=slot;this.currentMealIdx=idx;
const meal=MEALS[slot][idx];
const allowHalf=(slot==='breakfast'||slot==='lunch'||slot==='dinner'||slot==='snack1'||slot==='snack2');
const savedPortion=this.portions?.[this.currentDateStr]?.[slot]||1;
if(this.currentPortion===1&&savedPortion!==1)this.currentPortion=savedPortion;
const cp=this.currentPortion;
let html=`<div style="padding:20px"><div style="font-size:1.2rem;font-weight:800;margin-bottom:10px">${meal.title}</div>`;
if(allowHalf){
html+=`<div style="display:flex;gap:10px;margin:15px 0"><button onclick="app.setCurrentPortion(0.5)" style="flex:1;padding:12px;background:${cp===0.5?'var(--acid)':'#222'};color:${cp===0.5?'#000':'#fff'};border:1px solid ${cp===0.5?'var(--acid)':'#444'};border-radius:8px;font-weight:900;cursor:pointer">HALF</button><button onclick="app.setCurrentPortion(1)" style="flex:1;padding:12px;background:${cp===1?'var(--acid)':'#222'};color:${cp===1?'#000':'#fff'};border:1px solid ${cp===1?'var(--acid)':'#444'};border-radius:8px;font-weight:900;cursor:pointer">FULL</button></div>`;
}
html+=`<div style="background:var(--panel);padding:15px;border-radius:10px;margin:15px 0"><div style="font-size:0.7rem;color:var(--text-tertiary);margin-bottom:8px">MACROS</div><div>P: ${Math.round(meal.macros.p*cp)}g | Œ©3: ${Math.round(meal.macros.o*cp)}mg | F: ${Math.round(meal.macros.f*cp)}g | Cal: ${Math.round(meal.macros.cal*cp)}</div></div><button onclick="app.selectMeal('${slot}',${idx})" style="width:100%;background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;padding:18px;border:none;border-radius:12px;font-weight:800">SELECT</button></div>`;
document.getElementById('modalBody').innerHTML=html;
}
selectMeal(slot,idx){const d=this.currentDateStr;if(!this.meals[d])this.meals[d]={};this.meals[d][slot]=idx;if(slot==='breakfast'||slot==='lunch'||slot==='dinner'||slot==='snack1'||slot==='snack2'){if(!this.portions[d])this.portions[d]={};this.portions[d][slot]=this.currentPortion}if(!this.checked[d])this.checked[d]=[];if(!this.checked[d].includes(slot))this.checked[d].push(slot);this.save();this.closeModal();this.render()}
closeModal(){document.getElementById('mainModal').classList.remove('show');this.currentPortion=1}
openBio(){this.setText('modalTitle','BIOMETRICS');document.getElementById('modalBody').innerHTML=`<div style="padding:20px"><div style="background:var(--panel);padding:15px;border-radius:10px;border:1px solid var(--border);margin-bottom:15px"><div style="font-size:0.7rem;color:var(--text-tertiary);margin-bottom:5px">BMR</div><input id="bio-bmr" type="number" value="${this.bios.bmr||''}" style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:1rem"></div><button onclick="app.saveBio()" style="width:100%;background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;padding:15px;border:none;border-radius:10px;font-weight:800">SAVE</button></div>`;document.getElementById('mainModal').classList.add('show')}
saveBio(){const el=document.getElementById('bio-bmr');if(el?.value)this.bios.bmr=el.value;this.save();this.closeModal();this.render()}
showSummary(){const last7=this.history.slice(0,7);const avgScore=last7.length?Math.round(last7.reduce((s,d)=>s+(d.score||0),0)/last7.length):0;const avgSleep=last7.length?(last7.reduce((s,d)=>s+d.totalSec,0)/last7.length/3600).toFixed(1):0;this.setText('modalTitle','7-DAY SUMMARY');document.getElementById('modalBody').innerHTML=`<div style="padding:20px;text-align:center"><div style="font-size:3rem;font-weight:800;background:linear-gradient(135deg,#c8ff00,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px">${avgScore}</div><div style="font-size:0.8rem;color:var(--text-tertiary);margin-bottom:30px">LONGEVITY SCORE</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px"><div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--border)"><div style="font-size:2rem;font-weight:800;color:var(--cyan)">${avgSleep}h</div><div style="font-size:0.7rem;color:var(--text-tertiary)">AVG SLEEP</div></div></div><button onclick="app.closeModal()" style="width:100%;background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;padding:18px;border:none;border-radius:12px;font-weight:800;margin-top:30px">CLOSE</button></div>`;document.getElementById('mainModal').classList.add('show')}
calculateStreak(){
let streak=0;
for(let i=0;i<this.history.length;i++){
const day=this.history[i];
const chk=this.checked[day.date]||[];
const tempProtocol=JSON.parse(JSON.stringify(BASE));
const sel=this.meals[day.date]||{};
const portions=this.portions[day.date]||{};
tempProtocol.forEach(t=>{if(t.mealSlot&&sel[t.mealSlot]!==undefined){const all=MEALS[t.mealSlot]||[];if(all[sel[t.mealSlot]]){const m=all[sel[t.mealSlot]];const portion=(t.mealSlot==='breakfast'||t.mealSlot==='lunch'||t.mealSlot==='dinner'||t.mealSlot==='snack1'||t.mealSlot==='snack2')?(portions[t.mealSlot]||1):1;t.title=m.title+(portion===0.5?' (HALF)':'');t.desc=`P:${Math.round(m.macros.p*portion)} C:${Math.round(m.macros.cal*portion)}`;t.macros={p:m.macros.p*portion,o:m.macros.o*portion,f:m.macros.f*portion,cal:m.macros.cal*portion,poly:(m.macros.poly||0)*portion};t.colors=m.colors}}});
const requiredItems=tempProtocol.filter(t=>!t.cssClass?.includes('optional'));
const allChecked=requiredItems.every(t=>chk.includes(t.id));
if(allChecked&&requiredItems.length>0){streak++}else{break}
}
this.streak=streak;
}
render(){
if(!this.history.length)return;
const day=this.history[this.currentIndex];
const date=day.date;
const sel=this.meals[date]||{};
const portions=this.portions[date]||{};
const chk=this.checked[date]||[];
const goals=USERS[this.user].goals;
const hrvBaseline=USERS[this.user].hrvBaseline;
this.setText('dateLabel',date);

// Recovery Battery
const batteryScore=day.readiness||Math.round((day.score||0)*0.8);
this.setText('batteryScore',batteryScore||'--');
document.getElementById('batteryFill').style.width=`${batteryScore||0}%`;
this.setText('bcHrv',day.hrv||'--');
this.setText('bcSleep',`${((day.totalSec||0)/3600).toFixed(1)}h`);
this.setText('bcReadiness',day.readiness||'--');
this.setText('bcStrain',Math.round((day.high||0)+(day.med||0)*0.5)||'--');

// Trends
const last7=this.history.slice(0,7);
const calcTrend=(cur,key)=>{if(!cur)return'';const prev=last7.slice(1,4).filter(d=>d[key]).map(d=>d[key]);if(!prev.length)return'';const avg=prev.reduce((a,b)=>a+b,0)/prev.length;const diff=cur-avg;if(Math.abs(diff)<2)return'';return diff>0?'<span class="trend-up">‚Üë</span>':'<span class="trend-down">‚Üì</span>'};
document.getElementById('bcHrvTrend').innerHTML=calcTrend(day.hrv,'hrv');
document.getElementById('bcSleepTrend').innerHTML=calcTrend(day.totalSec/3600,'totalSec');

// Scores
const avgScore=last7.length?Math.round(last7.reduce((s,d)=>s+(d.score||0),0)/last7.length):0;
this.setText('longevityScore',avgScore);
document.getElementById('longevityOrb').style.strokeDashoffset=251-(avgScore/100*251);
const dayScore=Math.min(100,Math.round(((day.totalSec||0)/3600/8)*100));
this.setText('dayGrade',dayScore>=85?'A':dayScore>=70?'B':'C');
document.getElementById('dayScoreOrb').style.strokeDashoffset=251-(dayScore/100*251);

// Streak
this.calculateStreak();
this.setText('streakCount',this.streak);
document.getElementById('streakOrb').style.strokeDashoffset=251-((this.streak/30)*251);

// HRV-based adjustments
const hrvLow=day.hrv&&day.hrv<hrvBaseline*0.85;
let status='ALL SYSTEMS OPTIMAL';
let insights='';
if(hrvLow){
status='‚ö†Ô∏è LOW HRV ‚Üí RECOVERY MODE';
insights+=`<div class="insight-card warning"><div class="insight-header"><span class="insight-icon">üíú</span><span class="insight-title">HRV Below Baseline</span></div><div class="insight-body">Your HRV is ${day.hrv}ms vs baseline ${hrvBaseline}ms. Your body needs recovery.</div><div class="insight-action">‚Üí Skip HIIT, walk 30min Z2, sleep +1hr</div></div>`;
}
if(Math.abs(day.tempDev||0)>0.5){
insights+=`<div class="insight-card ${Math.abs(day.tempDev||0)>1?'alert':'warning'}"><div class="insight-header"><span class="insight-icon">üå°Ô∏è</span><span class="insight-title">Temperature Deviation</span></div><div class="insight-body">Your temp is ${day.tempDev>0?'+':''}${(day.tempDev||0).toFixed(1)}¬∞ from baseline. May indicate illness or overtraining.</div><div class="insight-action">‚Üí Monitor symptoms, reduce intensity</div></div>`;
}
this.setText('statusMsg',status);
document.getElementById('insightContainer').innerHTML=insights;

// Recovery Metrics
this.setText('hrvVal',day.hrv||'--');
const hrvCard=document.getElementById('hrvCard');
hrvCard.classList.remove('alert','warning','optimal');
if(hrvLow)hrvCard.classList.add('warning');else if(day.hrv&&day.hrv>=hrvBaseline)hrvCard.classList.add('optimal');
this.setText('tempVal',`${day.tempDev>0?'+':''}${(day.tempDev||0).toFixed(1)}¬∞`);
const tempInd=document.getElementById('tempIndicator');
tempInd.className='temp-indicator '+(Math.abs(day.tempDev||0)>1?'temp-high':Math.abs(day.tempDev||0)>0.5?'temp-elevated':'temp-normal');
this.setText('respVal',day.respRate?day.respRate.toFixed(1):'--');
this.setText('readinessVal',day.readiness||'--');
const upd=(id,val,max)=>{const el=document.getElementById(id);if(el)el.style.strokeDashoffset=138-(Math.min(val/max,1)*138)};
upd('readinessOrb',day.readiness||0,100);

// Sleep Debt
const sleepTarget=goals.sleepHours*7;
const sleepActual=last7.reduce((s,d)=>s+(d.totalSec||0)/3600,0);
const sleepDebt=sleepActual-sleepTarget;
this.setText('sleepDebtValue',`${sleepDebt>0?'+':''}${sleepDebt.toFixed(1)}h`);
const debtVis=document.getElementById('sleepDebtVisual');
debtVis.className='sleep-debt-visual '+(sleepDebt<-3?'debt-positive':sleepDebt>1?'debt-negative':'debt-neutral');

// Sleep Architecture
this.setText('sleepVal',`${((day.totalSec||0)/3600).toFixed(1)}h`);
this.setText('deepVal',`${Math.round((day.deepSec||0)/60)}m`);
this.setText('remVal',`${Math.round((day.remSec||0)/60)}m`);
upd('sleepOrb',(day.totalSec||0)/3600,8);
upd('deepOrb',(day.deepSec||0)/60,90);
upd('remOrb',(day.remSec||0)/60,90);

// Nutrition
const mac=this.calcMacros();
const updMac=(id,val,max)=>{upd(id,val,max);const txt=document.getElementById(id.replace('Orb','Val'));if(txt)txt.innerText=Math.round(val)};
updMac('proteinOrb',mac.protein,goals.protein);
updMac('omega3Orb',mac.omega3,4000);
updMac('fiberOrb',mac.fiber,goals.fiber);
updMac('polyphenolOrb',mac.polyphenol,2000);

// Cardio
this.setText('rhrVal',day.rhr!=='-'?day.rhr:'--');
const updHeart=(id,val,max)=>{const el=document.getElementById(id);if(el)el.style.strokeDashoffset=100-(Math.min(val/max,1)*100)};
updHeart('z2Heart',day.med||0,45);
if(hrvLow){
document.getElementById('z5Heart').style.stroke='var(--orange)';
this.setText('z5Val','‚òÖ');
this.setText('z5Label','RECOVERY');
}else{
document.getElementById('z5Heart').style.stroke='var(--alert)';
this.setText('z5Val',Math.round(day.high||0));
this.setText('z5Label','ZONE 5');
updHeart('z5Heart',day.high||0,20);
}
this.setText('z2Val',Math.round(day.med||0));
this.setText('calVal',Math.round(day.cal||0));
updHeart('calHeart',day.cal||0,500);

// Water & Rainbow
this.updateWater();
const cols=this.calcRainbow();
this.setText('rainbowScore',Math.round((cols.size/7)*100)+'%');
document.getElementById('rainbowTrack').innerHTML=['red','orange','yellow','green','purple','white','brown'].map(c=>`<div class="rainbow-seg" style="background:${cols.has(c)?COLORS[c]:'#333'};width:${cols.has(c)?14.28:0}%"></div>`).join('');

// Timeline
let protocol=[...BASE];
day.workouts.forEach((w,i)=>{protocol.push({id:`workout_${i}`,time:w.time,title:`${w.type.toUpperCase()} Detected`,desc:`${w.calories} cal`,autoDetected:true})});
if(hrvLow)protocol.push({id:'hrv_rec',time:'ALL DAY',title:'‚ö†Ô∏è LOW HRV - RECOVERY',desc:'Skip HIIT, focus Zone 2',hrvAdjusted:true});
protocol.sort((a,b)=>{const pt=t=>{const m=t.match(/(\d+):(\d+)\s*(AM|PM)/i);if(!m)return 0;let h=parseInt(m[1]);if(m[3].toUpperCase()==='PM'&&h!==12)h+=12;if(m[3].toUpperCase()==='AM'&&h===12)h=0;return h*60+parseInt(m[2])};return pt(a.time)-pt(b.time)});

protocol.forEach(t=>{if(t.mealSlot&&sel[t.mealSlot]!==undefined){const m=MEALS[t.mealSlot][sel[t.mealSlot]];if(m){const portion=(t.mealSlot==='breakfast'||t.mealSlot==='lunch'||t.mealSlot==='dinner'||t.mealSlot==='snack1'||t.mealSlot==='snack2')?(portions[t.mealSlot]||1):1;t.title=m.title+(portion===0.5?' (HALF)':'');t.desc=`P:${Math.round(m.macros.p*portion)}g Cal:${Math.round(m.macros.cal*portion)}`}}});

document.getElementById('timeline').innerHTML=protocol.map(t=>{
const isC=chk.includes(t.id);
const cc=`task-card ${isC?'checked':''} ${t.autoDetected?'auto-detected':''} ${t.hrvAdjusted?'hrv-adjusted':''}`;
const ca=t.mealSlot?`onclick="app.openMealPicker('${t.mealSlot}')"`:'';
return `<div class="task"><div class="task-time">${t.time}</div><div class="${cc}" ${ca}><div class="task-info"><div class="task-title">${t.title}</div><div class="task-desc">${t.desc||'Tap to select'}</div></div>${t.mealSlot?'<div class="chevron">‚Ä∫</div>':''}${!t.autoDetected&&!t.hrvAdjusted&&!t.cssClass?.includes('optional')?`<div class="check-btn" onclick="event.stopPropagation();app.toggleTask('${t.id}')"><div class="check-circle">${isC?'‚úì':''}</div></div>`:''}</div></div>`;
}).join('');
}
sync(){this.fetchOura()}
}
let app;window.onload=()=>{app=new CenturionApp();window.app=app};
</script>

</body>
</html>