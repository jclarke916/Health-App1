<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v23 - Complete Oura Synergy</title>
<style>
:root{--bg:#0a0a0c;--panel:#141418;--panel-elevated:#1a1a20;--border:rgba(255,255,255,0.08);--border-strong:rgba(255,255,255,0.15);--acid:#c8ff00;--acid-dim:rgba(200,255,0,0.15);--cyan:#00d4ff;--cyan-dim:rgba(0,212,255,0.15);--purple:#a855f7;--purple-dim:rgba(168,85,247,0.15);--alert:#ff4757;--alert-dim:rgba(255,71,87,0.15);--orange:#ff9500;--orange-dim:rgba(255,149,0,0.15);--success:#34d399;--success-dim:rgba(52,211,153,0.15);--text:#fff;--text-secondary:rgba(255,255,255,0.6);--text-tertiary:rgba(255,255,255,0.4)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding-bottom:140px;min-height:100vh;-webkit-tap-highlight-color:transparent;background-image:radial-gradient(ellipse at 20% 0%,rgba(200,255,0,0.03) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(0,212,255,0.03) 0%,transparent 50%)}

/* HEADER */
.header{background:rgba(10,10,12,0.95);padding:16px 20px;border-bottom:1px solid var(‚Äìborder);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px)}
.user-switch{display:flex;gap:8px;background:var(‚Äìpanel);padding:4px;border-radius:16px;margin-bottom:12px;border:1px solid var(‚Äìborder)}
.user-switch button{flex:1;padding:10px;border:none;background:transparent;color:var(‚Äìtext-tertiary);border-radius:12px;cursor:pointer;font-weight:700;font-size:0.7rem;letter-spacing:1px;transition:all 0.3s}
.user-switch button.active{background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;box-shadow:0 4px 20px rgba(200,255,0,0.3)}
.date-nav{display:flex;justify-content:space-between;align-items:center;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:14px;padding:8px 12px}
.nav-btn{background:transparent;border:none;color:var(‚Äìcyan);padding:8px 16px;font-size:1.1rem;cursor:pointer;transition:transform 0.2s}
.nav-btn:active{transform:scale(0.9)}
#dateLabel{flex:1;text-align:center;font-weight:600;font-size:0.85rem}
.bio-btn{background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;border:none;padding:10px 16px;border-radius:10px;font-size:0.65rem;font-weight:800;cursor:pointer}

/* SECTION HEADERS */
.section-header{padding:20px 20px 12px;font-size:0.65rem;font-weight:700;color:var(‚Äìtext-tertiary);letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;gap:12px}
.section-header::after{content:‚Äô‚Äô;height:1px;background:var(‚Äìborder);flex:1}

/* RECOVERY BATTERY - v22 style */
.recovery-battery{background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:20px;padding:20px;margin:20px;position:relative;overflow:hidden}
.recovery-battery::before{content:‚Äô‚Äô;position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#4facfe,#00f2fe)}
.battery-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.battery-title{font-size:0.7rem;font-weight:700;color:var(‚Äìtext-secondary);letter-spacing:1.5px;text-transform:uppercase}
.battery-score{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,#4facfe,#00f2fe);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.battery-bar{height:12px;background:var(‚Äìpanel-elevated);border-radius:6px;overflow:hidden;margin-bottom:12px}
.battery-fill{height:100%;background:linear-gradient(90deg,#4facfe,#00f2fe);border-radius:6px;transition:width 1s cubic-bezier(0.4,0,0.2,1);box-shadow:0 0 20px rgba(79,172,254,0.4)}
.battery-components{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.battery-component{text-align:center;padding:8px 4px;background:var(‚Äìpanel-elevated);border-radius:8px}
.bc-value{font-size:0.9rem;font-weight:700;color:var(‚Äìtext)}
.bc-label{font-size:0.5rem;color:var(‚Äìtext-tertiary);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
.bc-trend{font-size:0.6rem;margin-top:2px}
.trend-up{color:var(‚Äìsuccess)}
.trend-down{color:var(‚Äìalert)}

/* SCORE ORBS - v22 style */
.score-row{display:flex;gap:12px;justify-content:center;align-items:center;padding:0 20px}
.score-orb{flex:1;max-width:100px;aspect-ratio:1;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.2s}
.score-orb:active{transform:scale(0.95)}
.score-orb svg{position:absolute;width:100%;height:100%;transform:rotate(-90deg)}
.score-orb-bg{fill:none;stroke:var(‚Äìpanel-elevated);stroke-width:6}
.score-orb-fg{fill:none;stroke-width:6;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1.5s cubic-bezier(0.4,0,0.2,1)}
.score-orb-value{font-size:1.4rem;font-weight:800;position:relative;z-index:1}
.score-orb-label{font-size:0.5rem;font-weight:700;color:var(‚Äìtext-tertiary);letter-spacing:1px;position:relative;z-index:1}
.score-orb-badge{font-size:0.45rem;color:var(‚Äìtext-tertiary);text-align:center;letter-spacing:0.5px;margin-top:4px}
.score-orb.primary{max-width:120px}
.score-orb.primary .score-orb-value{font-size:1.8rem;color:var(‚Äìacid);font-weight:900}

/* STATUS CONTAINER */
.status-container{margin:16px 20px;padding:14px 16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:14px;text-align:center}
.status-label{font-size:0.55rem;font-weight:700;color:var(‚Äìtext-tertiary);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px}
.status-msg{font-size:0.8rem;color:var(‚Äìtext-secondary);line-height:1.5}

/* INSIGHT CARDS */
.insight-card{margin:0 20px 10px;padding:14px 16px;border-radius:14px;font-size:0.8rem;display:flex;align-items:center;gap:10px;border:1px solid}
.insight-card.recovery{background:var(‚Äìsuccess-dim);border-color:var(‚Äìsuccess);color:var(‚Äìsuccess)}
.insight-card.warning{background:var(‚Äìalert-dim);border-color:var(‚Äìalert);color:var(‚Äìalert)}
.insight-card.info{background:var(‚Äìcyan-dim);border-color:var(‚Äìcyan);color:var(‚Äìcyan)}

/* MACROS PANEL */
.macros-panel{margin:0 20px 15px;padding:16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.macro-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(‚Äìborder)}
.macro-row:last-child{border-bottom:none}
.macro-name{font-size:0.75rem;color:var(‚Äìtext-secondary)}
.macro-val{font-size:0.85rem;font-weight:700}
.macro-bar{flex:1;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin:0 12px;overflow:hidden}
.macro-bar-fill{height:100%;border-radius:2px;transition:width 0.3s}

/* WATER TRACKING */
.water-section{margin:0 20px 10px;padding:14px 16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.water-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.water-title{font-size:0.65rem;font-weight:700;letter-spacing:1px;color:var(‚Äìtext-tertiary)}
.water-display{font-size:1.1rem;font-weight:900}
.water-bar{height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;margin-bottom:10px}
.water-bar-fill{height:100%;background:linear-gradient(90deg,var(‚Äìcyan),#00f0ff);border-radius:4px;transition:width 0.3s}
.water-btns{display:flex;gap:8px}
.water-btn{flex:1;padding:10px;border:1px solid var(‚Äìborder);background:var(‚Äìpanel-elevated);color:var(‚Äìtext);border-radius:10px;font-size:0.75rem;font-weight:700;cursor:pointer;text-align:center;transition:all 0.2s}
.water-btn:active{background:var(‚Äìcyan-dim);border-color:var(‚Äìcyan)}

/* RAINBOW BAR */
.rainbow-section{margin:0 20px 15px;padding:12px 16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.rainbow-title{font-size:0.65rem;font-weight:700;letter-spacing:1px;color:var(‚Äìtext-tertiary);margin-bottom:8px}
.rainbow-bar{display:flex;gap:3px;height:16px;border-radius:8px;overflow:hidden}
.rainbow-segment{flex:1;border-radius:4px;opacity:0.2;transition:opacity 0.3s}
.rainbow-segment.active{opacity:1}

/* TIMELINE */
.task{display:flex;align-items:stretch;padding:0 20px;margin-bottom:6px}
.task-time{width:50px;font-size:0.65rem;color:var(‚Äìtext-tertiary);padding-top:14px;font-weight:600}
.task-card{flex:1;display:flex;align-items:center;padding:12px 14px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:14px;cursor:pointer;transition:all 0.2s;gap:10px}
.task-card:active{transform:scale(0.98)}
.task-card.checked{border-color:var(‚Äìacid) !important;background:var(‚Äìacid-dim) !important}
.task-card.checked .task-title,.task-card.checked .task-desc{color:var(‚Äìacid) !important}
.task-card.auto-detected{border-color:var(‚Äìpurple) !important;background:var(‚Äìpurple-dim) !important}
.task-card.auto-detected .task-title,.task-card.auto-detected .task-desc{color:var(‚Äìpurple) !important}
.task-card.hrv-adjusted{border-color:var(‚Äìorange) !important;background:var(‚Äìorange-dim) !important}
.task-card.task-card.recovery-task{border-color:var(‚Äìsuccess) !important;background:var(‚Äìsuccess-dim) !important}
.task-card.facial-task{border-color:var(‚Äìpurple) !important;background:var(‚Äìpurple-dim) !important}
.task-info{flex:1;min-width:0}
.task-title{font-size:0.8rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.task-desc{font-size:0.65rem;color:var(‚Äìtext-tertiary);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chevron{color:var(‚Äìtext-tertiary);font-size:1.2rem}
.check-btn{padding:4px;flex-shrink:0}
.check-circle{width:28px;height:28px;min-width:28px;min-height:28px;flex-shrink:0;border:2px solid var(‚Äìborder-strong);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(‚Äìacid);transition:all 0.2s}
.task-card.checked .check-circle{border-color:var(‚Äìacid) !important;background:var(‚Äìacid-dim) !important}

/* MODALS */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:200;backdrop-filter:blur(10px)}
.modal-overlay.active{display:flex;flex-direction:column}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(‚Äìborder)}
.modal-title{font-size:0.9rem;font-weight:800;letter-spacing:0.5px}
.modal-close{background:transparent;border:none;color:var(‚Äìtext-tertiary);font-size:1.5rem;cursor:pointer;padding:4px 8px}
.modal-body{flex:1;overflow-y:auto;padding:16px 20px}
.meal-option{padding:14px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:14px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
.meal-option:active,.meal-option.selected{border-color:var(‚Äìacid);background:var(‚Äìacid-dim)}
.meal-name{font-size:0.85rem;font-weight:700;margin-bottom:4px}
.meal-macros{font-size:0.65rem;color:var(‚Äìtext-tertiary)}
.recipe-section{padding:16px;background:var(‚Äìpanel-elevated);border:1px solid var(‚Äìborder);border-radius:14px;margin-bottom:12px}
.recipe-section-title{font-size:0.65rem;font-weight:700;letter-spacing:1px;color:var(‚Äìtext-tertiary);margin-bottom:8px}
.ing-item{color:var(‚Äìtext-secondary);font-size:0.8rem;border-bottom:1px solid var(‚Äìborder);padding:10px 0;display:flex;align-items:center;cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent}
.ing-item:active{background:rgba(255,255,255,0.03)}
.ing-item::before{content:‚Äô‚Ä¢‚Äô;color:var(‚Äìacid);font-weight:bold;margin-right:10px;font-size:1.1rem}
.ing-item.removed{opacity:0.35;text-decoration:line-through;color:#666}
.ing-item.removed::before{content:‚Äò‚úï‚Äô;color:var(‚Äìalert)}
.ing-hint{text-align:center;font-size:0.6rem;color:var(‚Äìtext-tertiary);margin:6px 0 12px}
.bread-selector{display:flex;gap:6px;margin:8px 0 12px;flex-wrap:wrap}
.bread-opt{padding:6px 12px;border:1px solid var(‚Äìborder);border-radius:20px;font-size:0.7rem;color:var(‚Äìtext-secondary);background:var(‚Äìpanel);cursor:pointer;transition:all 0.2s}
.bread-opt.active{border-color:var(‚Äìacid);color:var(‚Äìacid);background:var(‚Äìacid-dim)}
.synergy-box{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(168,85,247,0.08));border:1px solid rgba(0,212,255,0.2);border-radius:14px;padding:16px;margin:16px 0}
.syn-title{font-size:0.7rem;font-weight:900;color:var(‚Äìcyan);letter-spacing:1px;margin-bottom:6px}
.syn-text{font-size:0.8rem;color:var(‚Äìtext-secondary);line-height:1.5}
.step-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(‚Äìborder);font-size:0.8rem;color:var(‚Äìtext-secondary)}
.step-num{font-weight:900;color:var(‚Äìcyan);font-size:1.1rem;min-width:28px}
.portion-toggle{display:flex;gap:8px;margin:12px 0}
.portion-btn{flex:1;padding:10px;border:2px solid var(‚Äìborder);background:var(‚Äìpanel);color:var(‚Äìtext-secondary);border-radius:10px;font-size:0.85rem;font-weight:700;cursor:pointer;text-align:center;transition:all 0.2s}
.portion-btn.active{border-color:var(‚Äìacid);background:var(‚Äìacid);color:#000;font-weight:900}
.add-protocol-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(‚Äìacid),var(‚Äìcyan));color:#000;border:none;border-radius:14px;font-size:0.85rem;font-weight:900;cursor:pointer;letter-spacing:0.5px;margin-top:12px}
.bio-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:300;overflow-y:auto}
.bio-modal.active{display:block}
.bio-content{max-width:500px;margin:0 auto;padding:20px}
.bio-field{margin-bottom:12px}
.bio-label{font-size:0.65rem;color:var(‚Äìtext-tertiary);font-weight:700;letter-spacing:0.5px;margin-bottom:4px;display:block}
.bio-input{width:100%;padding:12px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:10px;color:var(‚Äìtext);font-size:0.85rem}
.search-container{padding:0 20px;margin-bottom:15px}
.search-input{width:100%;padding:12px 16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:14px;color:var(‚Äìtext);font-size:0.85rem;outline:none}
.search-input:focus{border-color:var(‚Äìcyan)}

/* BOTTOM SYNC BAR */
.sync-bar{position:fixed;bottom:0;left:0;width:100%;background:rgba(10,10,12,0.95);backdrop-filter:blur(20px);padding:14px 20px;border-top:1px solid var(‚Äìborder);display:flex;justify-content:space-between;align-items:center;z-index:90}
.sync-status{font-size:0.65rem;color:var(‚Äìtext-tertiary)}
.sync-btn{background:linear-gradient(135deg,#c8ff00,#00d4ff);color:#000;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.75rem;transition:transform 0.2s}
.sync-btn:active{transform:scale(0.95)}

/* DEBUG */
.debug-btn{position:fixed;bottom:75px;right:20px;z-index:200;background:var(‚Äìpanel);color:var(‚Äìtext);border:1px solid var(‚Äìborder);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;font-size:0.7rem}
.debug-console{position:fixed;bottom:65px;left:0;right:0;max-height:300px;background:rgba(0,0,0,0.98);border-top:2px solid var(‚Äìacid);z-index:199;overflow-y:auto;padding:12px;font-size:0.65rem;color:#0f0;font-family:monospace;display:none}
.debug-console.show{display:block}

/* RECOVERY METRICS GRID */
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 20px;margin-bottom:16px}
.metric-card{background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:14px;padding:14px 10px;text-align:center}
.metric-card .m-value{font-size:1.2rem;font-weight:800;display:block}
.metric-card .m-label{font-size:0.5rem;color:var(‚Äìtext-tertiary);text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;display:block}
.metric-card .m-sub{font-size:0.55rem;color:var(‚Äìtext-tertiary);margin-top:2px;display:block}

/* SLEEP DEBT */
.sleep-debt-card{margin:0 20px 16px;padding:16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.sleep-debt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.sleep-debt-title{font-size:0.65rem;font-weight:700;letter-spacing:1px;color:var(‚Äìtext-tertiary)}
.sleep-debt-value{font-size:1.4rem;font-weight:800}
.debt-positive{color:var(‚Äìsuccess)}
.debt-negative{color:var(‚Äìalert)}
.sleep-debt-bar{height:6px;background:var(‚Äìpanel-elevated);border-radius:3px;overflow:hidden;position:relative}
.sleep-debt-fill{height:100%;border-radius:3px;transition:width 0.5s}
.sleep-debt-info{font-size:0.65rem;color:var(‚Äìtext-tertiary);margin-top:8px}

/* SYNERGY DASHBOARD */
.synergy-panel{margin:0 20px 16px;padding:16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.synergy-title{font-size:0.65rem;font-weight:700;letter-spacing:1px;color:var(‚Äìtext-tertiary);margin-bottom:12px}
.synergy-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(‚Äìborder)}
.synergy-row:last-child{border-bottom:none}
.synergy-name{font-size:0.75rem;color:var(‚Äìtext-secondary)}
.synergy-vals{display:flex;gap:16px;font-size:0.8rem;font-weight:700}
.synergy-j{color:var(‚Äìacid)}
.synergy-s{color:var(‚Äìcyan)}

/* THERMAL LOGGING */
.thermal-btns{display:flex;gap:8px;padding:0 20px;margin-bottom:16px}
.thermal-btn{flex:1;padding:12px;border:1px solid var(‚Äìborder);background:var(‚Äìpanel);color:var(‚Äìtext-secondary);border-radius:12px;font-size:0.7rem;font-weight:700;cursor:pointer;text-align:center;transition:all 0.2s}
.thermal-btn:active{transform:scale(0.97)}
.thermal-btn.logged{border-color:var(‚Äìsuccess);background:var(‚Äìsuccess-dim);color:var(‚Äìsuccess)}

/* PARTNER FOOD LOG */
.partner-log{margin:0 20px 16px;padding:16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.partner-log-title{font-size:0.65rem;font-weight:700;letter-spacing:1px;color:var(‚Äìtext-tertiary);margin-bottom:10px}
.partner-meal{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(‚Äìborder);font-size:0.75rem}
.partner-meal:last-child{border-bottom:none}
.partner-slot{color:var(‚Äìtext-tertiary);text-transform:uppercase;font-size:0.6rem;font-weight:700}

/* COLLAPSIBLE SECTIONS */
.section-header.collapsible{cursor:pointer;user-select:none}
.section-chevron{margin-left:auto;font-size:0.7rem;transition:transform 0.3s}
.section-chevron.collapsed{transform:rotate(-90deg)}
.section-summary{font-size:0.6rem;color:var(‚Äìcyan);margin-left:8px;font-weight:400}
.section-body{overflow:hidden;transition:max-height 0.3s ease;max-height:1000px}
.section-body.collapsed{max-height:0;overflow:hidden}

/* CALORIE BALANCE */
.calorie-panel{margin:0 20px 16px;padding:16px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:16px}
.calorie-row{display:flex;justify-content:space-between;padding:8px 0;font-size:0.8rem;border-bottom:1px solid var(‚Äìborder)}
.calorie-row:last-child{border-bottom:none}
.calorie-label{color:var(‚Äìtext-secondary)}
.calorie-val{font-weight:700}
.calorie-positive{color:var(‚Äìsuccess)}
.calorie-negative{color:var(‚Äìalert)}
.calorie-neutral{color:var(‚Äìtext)}
.stat-card{padding:10px;background:var(‚Äìpanel);border:1px solid var(‚Äìborder);border-radius:10px;text-align:center}
.bio-section-label{font-size:0.65rem;color:var(‚Äìtext-tertiary);letter-spacing:1px;margin:16px 0 10px}
</style>

</head>
<body>

<div class="header">
<div class="user-switch">
<button id="btn-jermaine" onclick="if(window.app)app.switchUser('jermaine')">JERMAINE</button>
<button id="btn-sophia" onclick="if(window.app)app.switchUser('sophia')">SOPHIA</button>
</div>
<div class="date-nav">
<button class="nav-btn" onclick="if(window.app)app.changeDate(-1)">‚óÄ</button>
<span id="dateLabel">LOADING...</span>
<button class="nav-btn" onclick="if(window.app)app.changeDate(1)">‚ñ∂</button>
<button class="bio-btn" onclick="if(window.app)app.showBiomarkers()">BIO</button>
</div>
</div>

<!-- HERO: RECOVERY BATTERY -->

<div class="hero">
<div class="recovery-battery">
<div class="battery-header">
<div class="battery-title">‚ö° RECOVERY BATTERY</div>
<div class="battery-score" id="batteryScore">--</div>
</div>
<div class="battery-bar"><div class="battery-fill" id="batteryFill" style="width:0%"></div></div>
<div class="battery-components">
<div class="battery-component"><div class="bc-value" id="bcHrv">--</div><div class="bc-label">HRV</div><div class="bc-trend" id="bcHrvTrend">--</div></div>
<div class="battery-component"><div class="bc-value" id="bcSleep">--</div><div class="bc-label">SLEEP</div><div class="bc-trend" id="bcSleepTrend">--</div></div>
<div class="battery-component"><div class="bc-value" id="bcReadiness">--</div><div class="bc-label">READY</div><div class="bc-trend" id="bcReadinessTrend">--</div></div>
<div class="battery-component"><div class="bc-value" id="bcStrain">--</div><div class="bc-label">STRAIN</div><div class="bc-trend" id="bcStrainTrend">--</div></div>
</div>
</div>
</div>

<!-- SCORE ORBS -->

<div class="score-row">
<div class="score-orb" onclick="app.showWeeklySummary()">
<svg viewBox="0 0 100 100"><circle class="score-orb-bg" cx="50" cy="50" r="45"/><circle class="score-orb-fg" id="dayScoreOrb" cx="50" cy="50" r="45" style="stroke:var(--cyan)"/></svg>
<div class="score-orb-value" id="dayGrade">--</div>
<div class="score-orb-label">TODAY</div>
</div>
<div style="display:flex;flex-direction:column;align-items:center;flex:1.3;max-width:140px">
<div class="score-orb primary" onclick="app.showWeeklySummary()" style="max-width:140px;width:100%">
<svg viewBox="0 0 100 100"><circle class="score-orb-bg" cx="50" cy="50" r="45"/><circle class="score-orb-fg" id="longevityOrb" cx="50" cy="50" r="45" style="stroke:var(--acid)"/></svg>
<div class="score-orb-value" id="longevityScore">--</div>
<div class="score-orb-label">LONGEVITY</div>
</div>
<div class="score-orb-badge">7-DAY AVG</div>
</div>
<div class="score-orb">
<svg viewBox="0 0 100 100"><circle class="score-orb-bg" cx="50" cy="50" r="45"/><circle class="score-orb-fg" id="streakOrb" cx="50" cy="50" r="45" style="stroke:var(--acid)"/></svg>
<div class="score-orb-value" id="streakCount" style="color:var(--acid)">0</div>
<div class="score-orb-label">STREAK</div>
</div>
</div>

<!-- STATUS / AI ADVISOR -->

<div class="status-container">
<div class="status-label">üß† AI PROTOCOL ADVISOR</div>
<div class="status-msg" id="statusMsg">ANALYZING...</div>
</div>

<!-- INSIGHT CARDS -->

<div id="insightCards"></div>

<!-- RECOVERY METRICS -->

<div class="section-header">RECOVERY METRICS</div>
<div class="grid-4">
<div class="metric-card"><span class="m-value" id="metricRhr">--</span><span class="m-label">RHR</span><span class="m-sub">bpm</span></div>
<div class="metric-card"><span class="m-value" id="metricResp">--</span><span class="m-label">RESP</span><span class="m-sub">br/min</span></div>
<div class="metric-card"><span class="m-value" id="metricTemp">--</span><span class="m-label">TEMP</span><span class="m-sub">¬∞C dev</span></div>
<div class="metric-card"><span class="m-value" id="metricVasc">--</span><span class="m-label">VASC AGE</span><span class="m-sub">years</span></div>
</div>

<!-- SLEEP DEBT -->

<div class="sleep-debt-card">
<div class="sleep-debt-header">
<span class="sleep-debt-title">üò¥ SLEEP DEBT (7-DAY)</span>
<span class="sleep-debt-value" id="sleepDebtValue">--</span>
</div>
<div class="sleep-debt-bar"><div class="sleep-debt-fill" id="sleepDebtFill" style="width:50%;background:var(--text-tertiary)"></div></div>
<div class="sleep-debt-info" id="sleepDebtInfo">Calculating...</div>
</div>

<!-- COUPLES SYNERGY DASHBOARD -->

<div class="section-header">COUPLES SYNERGY</div>
<div class="synergy-panel">
<div class="synergy-title">üë´ JERMAINE & SOPHIA</div>
<div id="synergyContent">Loading...</div>
</div>

<!-- PARTNER FOOD LOG -->

<div class="partner-log">
<div class="partner-log-title">üçΩÔ∏è PARTNER'S MEALS TODAY</div>
<div id="partnerFoodLog">No meals logged yet</div>
</div>

<!-- THERMAL DETECTION -->

<div class="section-header">THERMAL RECOVERY</div>
<div class="thermal-btns">
<button class="thermal-btn" id="thermalSauna" onclick="app.logThermal('sauna')">üî• SAUNA</button>
<button class="thermal-btn" id="thermalCryo" onclick="app.logThermal('cryo')">‚ùÑÔ∏è CRYO</button>
<button class="thermal-btn" id="thermalContrast" onclick="app.logThermal('contrast')">üî•‚ùÑÔ∏è CONTRAST</button>
</div>

<!-- MACROS -->

<div class="section-header collapsible" onclick="app.toggleSection('macros')">DAILY MACROS<span class="section-summary" id="macrosSummary"></span><span class="section-chevron" id="macrosChevron">‚ñº</span></div>
<div class="section-body" id="macrosBody">
<div class="macros-panel">
<div id="macrosContent"></div>
</div>
</div>

<!-- CALORIE BALANCE -->

<div class="section-header collapsible" onclick="app.toggleSection('calories')">CALORIE BALANCE<span class="section-summary" id="caloriesSummary"></span><span class="section-chevron" id="caloriesChevron">‚ñº</span></div>
<div class="section-body" id="caloriesBody">
<div class="calorie-panel" id="caloriePanel"></div>
</div>

<!-- WATER -->

<div class="section-header">HYDRATION</div>
<div class="water-section">
<div class="water-header">
<span class="water-title">üíß WATER</span>
<span class="water-display" id="waterDisplay">0 / 0 oz</span>
</div>
<div class="water-bar"><div class="water-bar-fill" id="waterBarFill" style="width:0%"></div></div>
<div class="water-btns">
<button class="water-btn" onclick="app.addWater(8)">+8 oz</button>
<button class="water-btn" onclick="app.addWater(12)">+12 oz</button>
<button class="water-btn" onclick="app.addWater(16)">+16 oz</button>
<button class="water-btn" onclick="app.addWater(-8)">-8 oz</button>
</div>
</div>

<!-- RAINBOW -->

<div class="rainbow-section">
<div class="rainbow-title">üåà PHYTONUTRIENT RAINBOW</div>
<div class="rainbow-bar" id="rainbowBar"></div>
</div>

<!-- PROTOCOL TIMELINE -->

<div class="section-header">TODAY'S PROTOCOL</div>
<div id="timeline"></div>

<!-- MEAL PICKER MODAL -->

<div class="modal-overlay" id="mealModal">
<div class="modal-header">
<span class="modal-title" id="modalTitle">SELECT MEAL</span>
<button class="modal-close" onclick="app.closeMealPicker()">‚úï</button>
</div>
<div class="search-container" style="padding-top:12px">
<input class="search-input" id="mealSearch" type="text" placeholder="Search meals..." oninput="app.filterMeals(this.value)">
</div>
<div class="modal-body" id="modalBody"></div>
</div>

<!-- BIOMARKERS MODAL -->

<div class="bio-modal" id="bioModal">
<div class="bio-content">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-size:1rem;font-weight:800">BIOMARKERS</span>
<button style="background:transparent;border:none;color:var(--text-tertiary);font-size:1.5rem;cursor:pointer" onclick="app.closeBiomarkers()">‚úï</button>
</div>
<div style="display:flex;gap:6px;margin-bottom:16px">
<button id="bioTabDash" onclick="app.showBioTab('dash')" style="flex:1;padding:10px;border:1px solid var(--acid);background:var(--acid);color:#000;border-radius:10px;font-size:0.65rem;font-weight:900;cursor:pointer;letter-spacing:1px">DASHBOARD</button>
<button id="bioTabTrend" onclick="app.showBioTab('trend')" style="flex:1;padding:10px;border:1px solid var(--border);background:transparent;color:var(--text-tertiary);border-radius:10px;font-size:0.65rem;font-weight:900;cursor:pointer;letter-spacing:1px">TRENDING</button>
</div>
<div id="bioFields"></div>
<div id="bioTrending" style="display:none"></div>
<button id="bioSaveBtn" onclick="app.saveBiomarkers()" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--acid),var(--cyan));color:#000;border:none;border-radius:14px;font-size:0.85rem;font-weight:900;cursor:pointer;margin-top:16px">SAVE BIOMARKERS</button>
</div>
</div>

<!-- BOTTOM SYNC BAR -->

<div class="sync-bar">
<div class="sync-status" id="syncStatus">‚Äî</div>
<button class="sync-btn" onclick="if(window.app)app.sync()">SYNC OURA</button>
</div>

<!-- DEBUG -->

<button class="debug-btn" onclick="document.getElementById('debugConsole').classList.toggle('show')">üêõ DEBUG</button>

<div class="debug-console" id="debugConsole"></div>

<script>
// ============================================================================
// DEBUG
// ============================================================================
const debugEl=document.getElementById('debugConsole');
function log(msg){console.log(msg);if(debugEl){debugEl.innerHTML+=msg+'<br>';debugEl.scrollTop=debugEl.scrollHeight}}
function logerr(msg){console.error(msg);if(debugEl){debugEl.innerHTML+=`<span style="color:var(--alert)">${msg}</span><br>`;debugEl.scrollTop=debugEl.scrollHeight}}

// ============================================================================
// USER PROFILES
// ============================================================================
const USERS={
jermaine:{
name:'Jermaine',dob:'1983-01-13',weight:215.7,height:76.5,
goals:{protein:175,omega3:4000,fiber:50,water:140,sleepHours:8,weightTarget:210,z2:45,z5:20,calBurn:500},
tests:{vo2:{now:45,goal:55,unit:'ml/kg',name:'VO2 Max'},deadHang:{now:90,goal:120,unit:'sec',name:'Dead Hang'},wallSit:{now:120,goal:180,unit:'sec',name:'Wall Sit'},breathHold:{now:90,goal:150,unit:'sec',name:'Breath Hold'}},
bodyGoals:{bodyfat:{now:21.6,goal:15,unit:'%',lowerBetter:true},muscle:{now:97,goal:105,unit:'lbs',lowerBetter:false},weight:{now:215,goal:210,unit:'lbs',lowerBetter:true},visceralFat:{now:10,goal:7,unit:'',lowerBetter:true}},
labGoals:{apob:{goal:80,unit:'mg/dL',lowerBetter:true},lpa:{goal:75,unit:'nmol/L',lowerBetter:true},hscrp:{goal:0.5,unit:'mg/L',lowerBetter:true},hba1c:{goal:5.0,unit:'%',lowerBetter:true},glucose:{goal:82,unit:'mg/dL',lowerBetter:true},ldl:{goal:90,unit:'mg/dL',lowerBetter:true},hdl:{goal:60,unit:'mg/dL',lowerBetter:false},omega3idx:{goal:8,unit:'%',lowerBetter:false},vitD:{goal:60,unit:'ng/mL',lowerBetter:false}},
defaultBios:{weight:215,bmr:2028,apob:114,lpa:178,hscrp:0.4,hba1c:5.4,bodyfat:21.6,muscle:97.0,ldl:118,hdl:52,trig:95,glucose:88,vitD:45,b12:680,omega3idx:6.2,testosterone:520,cortisol:14},
hrvBaseline:45
},
sophia:{
name:'Sophia',dob:'1987-01-25',weight:148,height:64,
goals:{protein:130,omega3:4000,fiber:35,water:100,sleepHours:8,weightTarget:140,z2:30,z5:15,calBurn:350},
tests:{vo2:{now:32,goal:50,unit:'ml/kg',name:'VO2 Max'},deadHang:{now:40,goal:90,unit:'sec',name:'Dead Hang'},wallSit:{now:75,goal:150,unit:'sec',name:'Wall Sit'},breathHold:{now:60,goal:120,unit:'sec',name:'Breath Hold'}},
bodyGoals:{bodyfat:{now:18.2,goal:16,unit:'%',lowerBetter:true},muscle:{now:68,goal:75,unit:'lbs',lowerBetter:false},weight:{now:145,goal:140,unit:'lbs',lowerBetter:true}},
labGoals:{apob:{goal:70,unit:'mg/dL',lowerBetter:true},hscrp:{goal:0.5,unit:'mg/L',lowerBetter:true},hba1c:{goal:5.0,unit:'%',lowerBetter:true},glucose:{goal:78,unit:'mg/dL',lowerBetter:true},vitD:{goal:60,unit:'ng/mL',lowerBetter:false},omega3idx:{goal:8,unit:'%',lowerBetter:false}},
defaultBios:{weight:145,bmr:1450,apob:70,lpa:20,hscrp:0.5,hba1c:5.2,bodyfat:18.2,muscle:68.0,ldl:90,hdl:65,trig:70,glucose:82,vitD:38,b12:550,omega3idx:5.8,estrogen:120,cortisol:12},
hrvBaseline:55
}
};

const TOKENS={
jermaine:'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y',
sophia:'4QSDWYJJUZFHRWRH727NCK7WH4COQJF4'
};

// ============================================================================
// MEAL DATABASE (truncated ‚Äî add full DB here)
// ============================================================================
const MEALS={
breakfast:[
{title:'Greek Yogurt & Berries',macros:{p:36,o:2500,f:12,cal:400,poly:450},ingredients:'Greek yogurt (1.5 cups), walnuts (1/4 cup), blueberries (1 cup), flax seeds (2 tbsp), raw honey (1 tsp), cinnamon',colors:['white','blue','brown'],prepTime:5,suggestedBeverage:'Green Tea',synergyNote:'EGCG antioxidants + berry anthocyanins = doubled free radical protection. L-theanine enhances calm morning focus.',steps:'Layer yogurt in bowl~Stir in ground flax seeds~Add blueberries on top~Sprinkle crushed walnuts~Drizzle raw honey~Dust with cinnamon~Serve immediately',why:'Walnuts provide ALA omega-3 + polyphenols. Blueberries = anthocyanins for vascular health. Flax must be ground for omega-3 absorption. Cinnamon improves insulin sensitivity.'},
{title:'Omega Breakfast',macros:{p:44,o:3500,f:12,cal:480,poly:300},ingredients:'Omega-3 eggs (4), smoked salmon (3 oz), spinach (2 cups), avocado (1/2), turmeric, black pepper',colors:['yellow','orange','green'],prepTime:10,suggestedBeverage:'Golden Milk',synergyNote:'Turmeric curcumin enhances omega-3 anti-inflammatory effects. Fat from eggs + salmon aids curcumin absorption.',steps:'Heat pan with olive oil over medium~Saut√© spinach until wilted (2 min)~Push spinach aside, crack eggs in~Scramble eggs gently until just set~Slice avocado~Plate eggs with smoked salmon on side~Add turmeric and black pepper on top',why:'Omega-3 eggs + salmon = EPA/DHA stack. Turmeric + black pepper = 2000% curcumin absorption boost. Spinach provides folate + iron. Avocado fat enhances fat-soluble nutrient uptake.'},
{title:'PB Sea Moss Power Shake',macros:{p:55,o:2000,f:10,cal:780,poly:350},ingredients:'Plant protein (2 scoops), PB (2 tbsp), sea moss gel (1 tbsp), banana, almond milk, flax seeds',colors:['brown','yellow'],prepTime:5,suggestedBeverage:'Green Detox Press',synergyNote:'Alkalizing greens balance the acidity of protein powder. Celery nitrates boost workout blood flow.',steps:'Add almond milk to blender~Add plant protein scoops~Add peanut butter~Add sea moss gel~Peel and add banana~Add ground flax seeds~Blend on high 60 seconds~Pour and serve immediately',why:'Sea moss = 92 minerals including iodine for thyroid. PB provides monounsaturated fats. Plant protein avoids dairy inflammation. Banana adds prebiotic fiber for gut microbiome.'},
],
lunch:[
{title:'Double Chicken Bowl',macros:{p:62,o:1200,f:14,cal:650,poly:300},ingredients:'Chicken breast (8 oz), brown rice (3/4 cup), black beans, roasted peppers, avocado (1/2), salsa',colors:['brown','green','red'],prepTime:15,suggestedBeverage:'Beet Endurance Elixir',synergyNote:'Beet nitrates boost nitric oxide for muscle recovery. Turmeric reduces post-meal inflammation. Drink 2 hrs before workout.',steps:'Season chicken with garlic powder, paprika, salt~Grill or pan-sear chicken 6 min per side~Cook brown rice per package~Heat black beans with cumin~Roast peppers at 400¬∞F for 15 min~Slice avocado~Assemble bowl: rice, beans, chicken, peppers~Top with salsa and avocado',why:'8oz chicken = 62g complete protein for muscle synthesis. Black beans add resistant starch for gut health. Peppers = vitamin C for collagen production. Avocado fat boosts lycopene absorption from salsa.'},
{title:'Salmon Quinoa Bowl',macros:{p:58,o:4200,f:20,cal:720,poly:380},ingredients:'Wild salmon (6 oz), quinoa (3/4 cup), brown rice, edamame, avocado (1/2)',colors:['orange','brown','green'],prepTime:15,suggestedBeverage:'Green Tea',synergyNote:'EGCG protects omega-3 fats from oxidation during digestion. Catechins enhance the anti-inflammatory cascade from salmon.',steps:'Cook quinoa in salted water 15 min~Season salmon with lemon, garlic~Pan-sear salmon skin-down 4 min~Flip, cook 3 min more~Cook brown rice~Steam edamame 3 min~Slice avocado~Build bowl: grains, salmon, edamame, avocado',why:'Wild salmon = 4200mg EPA/DHA omega-3, the strongest Lp(a) reducer. Quinoa is a complete protein grain. Edamame adds isoflavones for cardiovascular protection.'},
{title:'Ahi Poke Bowl',macros:{p:48,o:3800,f:12,cal:560,poly:300},ingredients:'Ahi tuna (6 oz), sushi rice, cucumber, edamame, avocado, sesame seeds, soy sauce',colors:['red','brown','green'],prepTime:10,suggestedBeverage:'Green Detox Press',synergyNote:'Ginger aids raw fish digestion. Lemon vitamin C enhances iron absorption. Celery nitrates support cardiovascular health.',steps:'Dice ahi tuna into 1-inch cubes~Marinate in soy sauce + sesame oil 10 min~Cook sushi rice~Slice cucumber thin~Shell edamame~Slice avocado~Build bowl: rice, marinated tuna, veggies~Top with sesame seeds and green onion',why:'Raw ahi preserves maximum omega-3 (heat destroys some). Sesame = lignans for cholesterol reduction. Edamame + tuna = complete amino acid profile. Cucumber hydrates and adds silica.'},
],
dinner:[
{title:'Wild Salmon Centurion',macros:{p:52,o:4800,f:16,cal:620,poly:400},ingredients:'Wild salmon (8 oz), sweet potato (1 large), broccoli (2 cups), olive oil, lemon, garlic, herbs',colors:['orange','brown','green'],prepTime:25,suggestedBeverage:'Golden Milk',synergyNote:'Turmeric + salmon omega-3 = synergistic anti-inflammatory stack. Black pepper piperine enhances both curcumin and DHA absorption.',steps:'Preheat oven to 400¬∞F~Season salmon with lemon, garlic, herbs~Cube sweet potato, toss with olive oil~Roast sweet potato 20 min~Cut broccoli into florets~Add broccoli to oven last 10 min~Pan-sear salmon 4 min per side~Plate with lemon wedge',why:'Wild salmon = highest EPA/DHA source for Lp(a) management. Sweet potato = beta-carotene + fiber. Broccoli = sulforaphane, the #1 longevity compound. Olive oil enhances all fat-soluble nutrient absorption.'},
{title:'Bison Organ Blend (20% Liver)',macros:{p:48,o:800,f:16,cal:560,poly:300},ingredients:'Grass-fed bison blend (7 oz: 80% bison, 20% beef liver), sweet potato (1 large), Brussels sprouts (3 cups), onions, olive oil',colors:['brown','orange','green'],prepTime:25,suggestedBeverage:'Beet Endurance Elixir',synergyNote:'Beet nitrates enhance iron absorption from liver. Vitamin C from orange boosts non-heme iron uptake 6x.',steps:'Let bison blend reach room temp~Season with salt, pepper, garlic~Cube sweet potato, roast at 400F 20 min~Halve Brussels sprouts, add to oven 15 min~Slice onions~Sear bison patty 5 min per side~Caramelize onions in pan drippings~Plate: patty, sweet potato, sprouts, onions',why:'Liver is nature\'s multivitamin - B12, folate, iron, copper, vitamin A. 20% blend masks liver taste. Bison is leaner than beef with higher omega-3. Brussels sprouts = glucosinolates for detox pathways.'},
{title:'Maine Lobster Tail',macros:{p:44,o:2500,f:10,cal:480,poly:250},ingredients:'Lobster tail (8 oz), asparagus (2 cups), garlic butter (1 tbsp), lemon, brown rice (3/4 cup)',colors:['red','green','brown'],prepTime:20,suggestedBeverage:'Green Tea',synergyNote:'EGCG protects the astaxanthin in lobster from oxidation. Light tannins complement delicate seafood flavors.',steps:'Butterfly lobster tail with scissors~Lift meat above shell~Season with garlic butter, lemon~Broil 8-10 min until opaque~Trim asparagus ends~Roast asparagus with olive oil 10 min~Cook brown rice~Plate: lobster, asparagus, rice with lemon',why:'Lobster = astaxanthin (most powerful carotenoid antioxidant). Asparagus = prebiotic inulin for gut bacteria. Garlic butter provides allicin for blood pressure. Low calorie, high protein ratio.'},
],
snack1:[
{title:'Edamame',macros:{p:17,o:500,f:8,cal:190,poly:100},ingredients:'Edamame (1.5 cups), sea salt',colors:['green'],prepTime:3,steps:'Boil salted water~Add frozen edamame~Cook 3-4 min~Drain~Sprinkle sea salt~Serve warm or cold',why:'Complete plant protein with all essential amino acids. Isoflavones reduce cardiovascular risk. High fiber for satiety. One of the highest protein-per-calorie snacks available.'},
{title:'Sardines',macros:{p:22,o:2800,f:0,cal:190,poly:0},ingredients:'Wild sardines (1 can), lemon, hot sauce',colors:['silver'],prepTime:1,steps:'Open can, drain liquid~Plate sardines~Squeeze fresh lemon over top~Add hot sauce to taste~Serve with crackers optional',why:'Highest omega-3 per calorie of any food. Small fish = lowest mercury. Bones provide calcium. Coenzyme Q10 for mitochondrial energy. One can = full daily omega-3 target.'},
{title:'Hard Boiled Eggs',macros:{p:18,o:300,f:0,cal:210,poly:0},ingredients:'Omega-3 eggs (3), everything seasoning',colors:['yellow','white'],prepTime:10,steps:'Place eggs in cold water~Bring to boil~Reduce heat, simmer 10 min~Transfer to ice bath 5 min~Peel under running water~Season with everything seasoning',why:'Omega-3 eggs provide choline for brain health and liver function. Complete protein with all 9 essential amino acids. Lutein + zeaxanthin for eye protection.'},
],
snack2:[
{title:'Trail Mix Elite',macros:{p:12,o:1500,f:6,cal:280,poly:200},ingredients:'Walnuts, almonds, dark chocolate chips, goji berries, pumpkin seeds',colors:['brown','red'],prepTime:2,steps:'Measure walnuts and almonds~Add dark chocolate chips~Add goji berries~Add pumpkin seeds~Mix together~Portion into serving size',why:'Walnuts = ALA omega-3 + polyphenols for brain health. Dark chocolate = flavanols for blood flow. Goji berries = zeaxanthin for eyes. Pumpkin seeds = zinc for immune function and testosterone.'},
{title:'Apple + Almond Butter',macros:{p:8,o:500,f:6,cal:260,poly:180},ingredients:'Apple (1 large), almond butter (2 tbsp), cinnamon',colors:['red','brown'],prepTime:2,steps:'Wash and slice apple~Spread almond butter on slices~Sprinkle cinnamon on top~Eat immediately to prevent browning',why:'Quercetin in apple skin is a powerful anti-inflammatory. Almond butter provides vitamin E for skin health. Cinnamon regulates blood sugar response. Fiber + fat combo keeps you full 3+ hours.'},
],
juice2:[
{title:'Golden Milk',macros:{p:2,o:200,f:2,cal:80,poly:400},ingredients:'Turmeric, ginger, black pepper, coconut milk, honey',colors:['yellow','orange'],prepTime:5,steps:'Heat coconut milk in saucepan~Add turmeric and ginger~Add black pepper (critical for absorption)~Whisk until smooth~Drizzle honey~Serve warm',why:'Turmeric = curcumin, one of the most studied anti-inflammatory compounds. Black pepper increases absorption 2000%. Ginger aids digestion and reduces muscle soreness.'},
{title:'Green Tea',macros:{p:0,o:0,f:0,cal:5,poly:300},ingredients:'Matcha or green tea (1 cup)',colors:['green'],prepTime:3,steps:'Heat water to 175¬∞F (not boiling)~Steep tea for 2-3 minutes~Remove bag or strain~Serve plain or with lemon',why:'EGCG catechins are potent antioxidants that lower LDL oxidation. L-theanine promotes calm focus. Steep at lower temp to preserve catechins ‚Äî boiling destroys them.'},
],
juice3:[
{title:'Green Detox Press',macros:{p:4,o:300,f:4,cal:120,poly:300},ingredients:'Kale, celery, cucumber, ginger, lemon, green apple',colors:['green'],prepTime:5,steps:'Wash all produce~Run kale through juicer~Add celery stalks~Add cucumber~Press ginger root~Squeeze lemon~Add green apple last~Stir and serve immediately',why:'Kale = sulforaphane precursor for NRF2 pathway activation. Celery provides nitrates for blood flow. Ginger = gingerol anti-inflammatory. Lemon vitamin C enhances iron absorption from greens.'},
{title:'Beet Endurance Elixir',macros:{p:3,o:200,f:4,cal:140,poly:350},ingredients:'Beets, carrot, ginger, turmeric, orange, black pepper',colors:['red','orange'],prepTime:5,steps:'Wash and trim beets~Run beets through juicer~Add carrots~Press ginger and turmeric~Squeeze orange~Add black pepper~Stir well and serve',why:'Beet nitrates convert to nitric oxide ‚Äî proven to improve exercise endurance 16%. Turmeric + black pepper = anti-inflammatory stack. Peak effect 2-3 hours after drinking.'},
],
alcohol:[
{title:'Red Wine (Resveratrol)',macros:{p:0,o:0,f:0,cal:125,poly:200},ingredients:'Organic red wine (5 oz) - Pinot Noir preferred',colors:['red'],prepTime:0,steps:'Pour 5 oz organic Pinot Noir~Serve at 60-65¬∞F~Pair with omega-3 rich dinner~Limit to 1 glass',why:'Resveratrol activates SIRT1 longevity gene. Pinot Noir has highest resveratrol content. Polyphenols support gut microbiome diversity. One glass max ‚Äî more reverses all benefits.'},
{title:'Sake (Junmai)',macros:{p:1,o:0,f:0,cal:105,poly:50},ingredients:'Junmai sake (4 oz), served warm or cold',colors:['white'],prepTime:0,steps:'Choose Junmai (pure rice, no added alcohol)~Serve warm (104¬∞F) or chilled~Pair with omega-3 fish dishes~Limit to 4 oz serving',why:'Lower alcohol than wine with amino acids from fermentation. Junmai grade = purest form. Pairs synergistically with omega-3 fish ‚Äî enhances absorption. Ferulic acid provides mild antioxidant benefit.'},
{title:'Sapporo Premium',macros:{p:1,o:0,f:0,cal:140,poly:30},ingredients:'Sapporo Premium Beer (12 oz)',colors:['yellow'],prepTime:0,steps:'Serve cold (38-42¬∞F)~Pour into glass for aroma~Pair with Asian cuisine or seafood~Limit to one 12 oz serving',why:'Japanese lager with silicon content that supports bone density. Xanthohumol from hops has mild anti-inflammatory properties. Higher calorie than wine ‚Äî use sparingly. Best paired with sushi nights.'},
{title:'No Alcohol',macros:{p:0,o:0,f:0,cal:0,poly:0},ingredients:'Rest day ‚Äî hydrate instead',colors:[],prepTime:0,steps:'Hydrate with 16 oz water instead~Add lemon or electrolytes~Consider herbal tea',why:'Alcohol-free days allow liver recovery and optimize sleep architecture. Even moderate drinking disrupts REM sleep. Your HRV will be 15-20% higher the next morning.'},
]
};

// ============================================================================
// PROTOCOLS
// ============================================================================
const PROTOCOLS={
microcurrent:{title:'‚ö° Microcurrent Protocol',steps:['1. Cleanse face','2. Apply conductive gel','3. Forehead ‚Äî 3 min','4. Cheeks ‚Äî 4 min each','5. Jawline ‚Äî 3 min','6. Neck ‚Äî 2 min (upward only)','7. Remove gel, apply serum']},
microneedling:{title:'üìç Microneedling Protocol',steps:['1. Sanitize device','2. Double cleanse','3. Apply HA serum','4. Cross-hatch pattern all zones','5. Wait 10 min','6. No actives for 24 hrs','7. SPF mandatory next day']},
massage:{title:'üíÜ Facial Massage',steps:['1. Apply facial oil','2. Jaw: chin-to-ear strokes','3. Cheeks: lift-to-temples','4. Forehead: center-out','5. Neck: upward only','6. 5 min total minimum']},
cupping:{title:'ü´ô Cupping Protocol',steps:['1. Oil generously','2. Use small cup for face','3. Glide ‚Äî never park','4. Avoid spine directly','5. Marks = stagnation indicator','6. Hyperice 15 min after']},
clubstudio:{title:'üè¢ Club Studio',steps:['Option A: Cryo 3 min ‚Üí wait 5 min ‚Üí Sauna 20 min ‚Üí Massage bed 20 min','Option B: Cryo OR Sauna only ‚Üí Massage 15 min']},
contrast:{title:'üî•‚ùÑÔ∏è Contrast Therapy',steps:['1. Sauna 15-20 min at 170¬∞F+','2. Cold 3 min cryo/plunge','3. Rest 5 min natural rewarming','4. Repeat 2-3 rounds','5. Always end cold']},
hipflexor:{title:'üßò Hip Flexor Stretch',steps:['1. Kneeling lunge position','2. Engage core, tuck pelvis','3. Shift forward gently','4. 2.5 min each side','5. Total: 5 min']},
shoulder:{title:'ü¶æ Shoulder Mobility',steps:['1. Arm circles ‚Äî 1 min','2. Doorway pec stretch ‚Äî 2 min','3. Sleeper stretch ‚Äî 2 min']},
lowhrv:{title:'üíú Low HRV Protocol',steps:['‚Ä¢ Skip HIIT entirely','‚Ä¢ Zone 2 cardio only','‚Ä¢ Add 30 min extra sleep','‚Ä¢ No alcohol','‚Ä¢ Prioritize recovery']},
normatec:{title:'ü¶µ Normatec Protocol',steps:['1. Setup legs + hips','2. Level 7 flush','3. Time: 30-45 min','4. Zone boost if sore','5. Hydrate 16oz after','6. Can do 2x daily']},
inshape:{title:'üèä InShape Protocol',steps:['1. Steam room 15 min','2. Sauna 20 min','3. Pool ‚Äî light swim/stretch 20 min','4. Aqua massage bed 30 min','5. Cold shower finish','6. Normatec 45 min at home']}
};

// ============================================================================
// WORKOUTS ‚Äî REHABILITATION PHASE
// ============================================================================
const WORKOUT_RECS={
jermaine:{
monday:'20 min stabilization (wall sits, step-downs, TKE) ‚Üí Upper body lift',
tuesday:'Hip flexor stretches + lower ab/back circuit (20 min)',
wednesday:'Reform class or pool work (protect patella)',
thursday:'Lower body lift (quad-dominant rehab focus)',
friday:'Reform class or pool work (protect patella)',
saturday:'Active recovery ‚Äî walk + stretch',
sunday:'Full rest or gentle yoga'
},
sophia:{
monday:'Full body strength',
tuesday:'Cardio ‚Äî spin or HIIT',
wednesday:'Yoga or pilates',
thursday:'Upper body + core',
friday:'Cardio ‚Äî run or swim',
saturday:'Active recovery',
sunday:'Rest'
}
};

// ============================================================================
// PROTOCOL BUILDER
// ============================================================================
const BASE=[
{id:'wake',time:'6:00',title:'‚òÄÔ∏è Wake + Hydrate',desc:'16 oz water + lemon + Celtic salt'},
{id:'juice2',time:'7:15',title:'Morning Beverage',desc:'Tap to select',mealSlot:'juice2',optional:true},
{id:'breakfast',time:'7:30',title:'üç≥ BREAKFAST',desc:'Tap to select',mealSlot:'breakfast'},

{id:'snack1',time:'10:00',title:'ü•ú Morning Snack',desc:'Tap to select',mealSlot:'snack1'},
{id:'lunch',time:'1:00 PM',title:'ü•ó LUNCH',desc:'Tap to select',mealSlot:'lunch'},
{id:'snack2',time:'3:00 PM',title:'üçé Afternoon Snack',desc:'Tap to select',mealSlot:'snack2'},
{id:'juice3',time:'3:30 PM',title:'Afternoon Beverage',desc:'Tap to select',mealSlot:'juice3',optional:true},
{id:'dinner',time:'6:30 PM',title:'üçΩÔ∏è DINNER',desc:'Tap to select',mealSlot:'dinner'},
{id:'alcohol',time:'8:00 PM',title:'üç∑ Alcohol',desc:'Tap to select',mealSlot:'alcohol',optional:true},
{id:'winddown',time:'9:00 PM',title:'üåô Wind Down',desc:'Blue light off, magnesium glycinate, 30 min reading'},
{id:'sleep',time:'10:00 PM',title:'üò¥ Sleep Target',desc:'8 hrs ‚Äî lights out'}
];

function buildProtocol(user,date,ouraData){
const p=JSON.parse(JSON.stringify(BASE));
const dayName=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][new Date(date+'T12:00:00').getDay()];
const dayNum=new Date(date+'T12:00:00').getDay();
const isFirstSunday=new Date(date+'T12:00:00').getDate()<=7;
let workoutDesc=WORKOUT_RECS[user]?.[dayName]||'Rest day';
let hrvAdjusted=false;
if(ouraData&&ouraData.hrv&&ouraData.hrv<30){
workoutDesc='‚ö†Ô∏è LOW HRV ‚Äî Zone 2 only, skip HIIT';
hrvAdjusted=true;
}
if(ouraData&&ouraData.workouts&&ouraData.workouts.length>0){
ouraData.workouts.forEach((w,i)=>{
let wTime='9:30';
if(w.startTime){
const dt=new Date(w.startTime);
const h=dt.getHours();const m=dt.getMinutes();
wTime=h>12?(h-12)+':'+String(m).padStart(2,'0')+' PM':h+':'+String(m).padStart(2,'0');
}
const wItem={id:'workout_'+i,time:wTime,title:'üèãÔ∏è '+(w.type||'WORKOUT').toUpperCase(),desc:(w.calories?Math.round(w.calories)+' cal burned ‚Äî ':'')+'(auto-detected)',autoDetected:true};
p.splice(3+i,0,wItem);
});
}
// Lunch recovery (hip flexor M/W/F, shoulder T/Th)
const lunchRec=_tempGetLunchRecovery(user,dayNum);
if(lunchRec){
const lunchIdx=p.findIndex(t=>t.mealSlot==='lunch');
if(lunchIdx>=0)p.splice(lunchIdx,0,{id:'lunch_recovery',time:'11:30',title:lunchRec.title,desc:lunchRec.desc,type:lunchRec.type,clickable:true,cssClass:'recovery-task'});
}
// Evening recovery (cupping, club studio, inshape)
const eveRec=_tempGetEveningRecovery(user,dayNum,ouraData);
if(eveRec){
const dinnerIdx=p.findIndex(t=>t.mealSlot==='dinner');
if(dinnerIdx>=0)p.splice(dinnerIdx,0,{id:'evening_recovery',time:eveRec.time,title:eveRec.title,desc:eveRec.desc,type:eveRec.type,clickable:true,cssClass:'recovery-task'});
}
// End of day facial
const facial=_tempGetFacial(user,dayNum,isFirstSunday);
if(facial){
p.push({id:'facial',time:'9:00 PM',title:facial.title,desc:facial.desc,type:facial.type,clickable:true,cssClass:'facial-task'});
}
return p;
}
// Temporary static helpers for buildProtocol (before app instance exists)
function _tempGetLunchRecovery(user,d){
if(user==='jermaine'&&(d===1||d===3||d===5))return{title:'üßò Hip Flexor',desc:'5min stretch ‚Äî combat numbness',type:'hipflexor'};
if(user==='jermaine'&&(d===2||d===4))return{title:'ü¶æ Shoulder',desc:'5min mobility ‚Äî prevent impingement',type:'shoulder'};
return null;
}
function _tempGetEveningRecovery(user,d,day){
const w=day&&day.workouts&&day.workouts.length>0;
if(user==='jermaine'){
if(d===0)return{time:'2:00 PM',title:'üèä InShape',desc:'Together ‚Äî Steam + Pool + Aqua Massage',type:'inshape'};
if(d===2||d===4)return{time:'7:00 PM',title:'üîµ Cupping',desc:'Both 15min each + Hyperice after',type:'cupping'};
if(d===1&&w)return{time:'7:00 PM',title:'üí™ Post-Lift',desc:'Club Studio: Cryo + Sauna',type:'clubstudio'};
if(d===3)return{time:'6:30 PM',title:'üßò Mid-Week Recovery',desc:'Club Studio: Sauna + Cryo + Massage Bed',type:'clubstudio'};
return{time:'6:30 PM',title:'‚ú® Light Recovery',desc:'Normatec 30min or Massage bed',type:'clubstudio'};
}
if(user==='sophia'){
if(d===0)return{time:'2:00 PM',title:'üèä InShape',desc:'Together',type:'inshape'};
if((d===3||d===5)&&w)return{time:'7:00 PM',title:'üèÉ Post-Rebound',desc:'Cryo + Sauna or Theragun + Normatec',type:'clubstudio'};
if(d===2||d===4)return{time:'6:30 PM',title:'üîµ Cupping',desc:'Both 15min + Hyperice',type:'cupping'};
return{time:'6:30 PM',title:'‚ú® Light Recovery',desc:'Optional',type:'clubstudio'};
}
return null;
}
function _tempGetFacial(user,d,firstSunday){
if(user==='jermaine'){
if(d===0&&firstSunday)return{title:'üìç Sophia Needle',desc:'45min ‚Äî SPF 24hrs',type:'microneedling'};
if(d===1||d===3||d===5||d===0)return{title:'‚ö° Sophia Micro',desc:'Lift + Tone',type:'microcurrent'};
if(d===2||d===4)return{title:'üíÜ Sophia Massage',desc:'Hand + Wands',type:'massage'};
return{title:'‚ú® Sophia Maint',desc:'Optional',type:'massage'};
}
if(user==='sophia'){
if(d===1||d===3||d===5||d===0)return{title:'‚ö° Jermaine Micro',desc:'Jawline focus',type:'microcurrent'};
if(d===2||d===4)return{title:'üí™ Jermaine Recovery',desc:'Cold + Jaw massage',type:'massage'};
return{title:'‚ú® Jermaine Maint',desc:'Optional',type:'massage'};
}
return null;
}

// ============================================================================
// RAINBOW
// ============================================================================
const RAINBOW_COLORS=['#ff4444','#ff8800','#ffcc00','#44cc44','#2196F3','#7c4dff','#e040fb'];
const RAINBOW_NAMES=['Red','Orange','Yellow','Green','Blue','Indigo','Violet'];

// ============================================================================
// MAIN APP CLASS
// ============================================================================
class CenturionApp{
constructor(){
log('üöÄ Centurion v23 - Oura Synergy');
const V='23.5-INLINE';
if(localStorage.getItem('centurion_version')!==V){localStorage.clear();localStorage.setItem('centurion_version',V)}
this.user=localStorage.getItem('centurion_user')||'jermaine';
this.history=[];this.currentIndex=0;this.currentDateStr=new Date().toLocaleDateString('en-CA');
this.checked={};this.meals={};this.portions={};this.bios={};this.protocol=[];
this.currentPortion=1;this.currentMealIdx=null;this.currentMealSlot=null;this.inRecipeView=false;
this.streak=0;this.water={};this.removedIngredients={};this.breadChoices={};
document.querySelectorAll('.user-switch button').forEach(b=>b.classList.remove('active'));
document.getElementById(`btn-${this.user}`)?.classList.add('active');
this.loadUserData();this.setPlaceholderData();this.render();this.fetchOuraData();
}

loadUserData(){
try{
this.checked=JSON.parse(localStorage.getItem(`c_checked_${this.user}`)||'{}');
this.meals=JSON.parse(localStorage.getItem(`c_meals_${this.user}`)||'{}');
this.portions=JSON.parse(localStorage.getItem(`c_portions_${this.user}`)||'{}');
this.bios=JSON.parse(localStorage.getItem(`c_bios_${this.user}`)||'null')||{...USERS[this.user].defaultBios};
this.streak=parseInt(localStorage.getItem(`c_streak_${this.user}`)||'0');
this.water=JSON.parse(localStorage.getItem(`c_water_${this.user}`)||'{}');
this.removedIngredients=JSON.parse(localStorage.getItem(`c_remIng_${this.user}`)||'{}');
this.breadChoices=JSON.parse(localStorage.getItem(`c_bread_${this.user}`)||'{}');
}catch(e){this.checked={};this.meals={};this.portions={};this.streak=0;this.water={};this.removedIngredients={};this.breadChoices={}}
}

saveUserData(){
localStorage.setItem(`c_checked_${this.user}`,JSON.stringify(this.checked));
localStorage.setItem(`c_meals_${this.user}`,JSON.stringify(this.meals));
localStorage.setItem(`c_portions_${this.user}`,JSON.stringify(this.portions));
localStorage.setItem(`c_bios_${this.user}`,JSON.stringify(this.bios));
localStorage.setItem(`c_streak_${this.user}`,this.streak.toString());
localStorage.setItem(`c_water_${this.user}`,JSON.stringify(this.water));
localStorage.setItem(`c_remIng_${this.user}`,JSON.stringify(this.removedIngredients));
localStorage.setItem(`c_bread_${this.user}`,JSON.stringify(this.breadChoices));
}

setPlaceholderData(){
this.history=[{date:this.currentDateStr,score:0,totalSec:0,deepSec:0,remSec:0,rhr:'-',cal:0,high:0,med:0,workouts:[],hrv:null,tempDev:0,respRate:null,readiness:null,cardioAge:null}];
this.currentIndex=0;
}

setText(id,val){const el=document.getElementById(id);if(el)el.textContent=val}
setOrb(id,pct){const el=document.getElementById(id);if(el){const c=283;el.style.strokeDashoffset=c-(c*(Math.min(pct,100)/100))}}

// ========================================================================
// OURA FETCH ‚Äî Promise.allSettled (working version)
// ========================================================================
async fetchOuraData(){
this.setText('syncStatus','SYNCING...');
log('üîÑ Starting Oura sync for user: '+this.user);
try{
const end=new Date();end.setDate(end.getDate()+1);
const start=new Date();start.setDate(start.getDate()-14);
const startStr=start.toISOString().split('T')[0],endStr=end.toISOString().split('T')[0];
log('üìÖ Date range: '+startStr+' to '+endStr);
const token=TOKENS[this.user];
if(!token||token.includes('YOUR_')){this.setText('syncStatus','NO TOKEN');log('‚ö†Ô∏è No token found');return}
log('üîë Token found: '+token.substring(0,6)+'...');

const proxy='https://oura-proxy.jclarke-9a0.workers.dev?url=';
const eps=['sleep','daily_sleep','workout','daily_activity','daily_readiness','daily_hrv','daily_cardiovascular_age'];
const results=await Promise.allSettled(eps.map(async ep=>{
const url=`${proxy}${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/${ep}?start_date=${startStr}&end_date=${endStr}`)}`;
log('üì° Fetching: '+ep);
const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});
if(!res.ok){log('‚ùå '+ep+' failed: HTTP '+res.status);throw new Error(ep+' '+res.status);}
const json=await res.json();
log('‚úÖ '+ep+': '+(json.data?.length||0)+' records');
return{name:ep,data:json.data||[]};
}));
const data={};
let failCount=0;
results.forEach(r=>{
if(r.status==='fulfilled')data[r.value.name]=r.value.data;
else{failCount++;log('‚ö†Ô∏è Failed: '+r.reason);}
});
log('üìä Sleep:'+(data.sleep?.length||0)+' DailySleep:'+(data.daily_sleep?.length||0)+' Workout:'+(data.workout?.length||0)+' HRV:'+(data.daily_hrv?.length||0)+' Readiness:'+(data.daily_readiness?.length||0)+' Failed:'+failCount);
if(data.sleep?.length>0){log('üîç Sample sleep day: '+JSON.stringify(data.sleep[0]).substring(0,200));}
if(data.daily_hrv?.length>0){log('üîç Sample HRV day: '+JSON.stringify(data.daily_hrv[0]).substring(0,200));}
this.processOuraData(data);
this.setText('syncStatus','SYNCED ‚úì');
log('‚úÖ Sync complete. History has '+this.history.length+' days. Current index: '+this.currentIndex);
const hrvVals=this.history.filter(h=>h.hrv&&h.hrv>0).map(h=>h.date+':'+h.hrv);
log('üíì HRV values: '+hrvVals.join(', '));
const avgH=hrvVals.length?Math.round(this.history.filter(h=>h.hrv&&h.hrv>0).reduce((a,h)=>a+h.hrv,0)/hrvVals.length):0;
log('üíì Average HRV: '+avgH+'ms across '+hrvVals.length+' days');
this.render();
}catch(e){
logerr('‚ùå Sync failed: '+e.message);
this.setText('syncStatus','OFFLINE');
this.render();
}
}

processOuraData(raw){
const dayMap=new Map();
const g=(date)=>{
if(!dayMap.has(date))dayMap.set(date,{date,score:0,totalSec:0,deepSec:0,remSec:0,rhr:'-',cal:0,high:0,med:0,workouts:[],hrv:null,tempDev:0,respRate:null,readiness:null,cardioAge:null});
return dayMap.get(date);
};

(raw.sleep||[]).forEach(s=>{
const d=g(s.day);
d.totalSec+=s.total_sleep_duration||0;
d.deepSec+=s.deep_sleep_duration||0;
d.remSec+=s.rem_sleep_duration||0;
if(s.lowest_heart_rate>=35&&s.lowest_heart_rate<=100)d.rhr=Math.round(s.lowest_heart_rate);
if(s.average_breath)d.respRate=s.average_breath;
if(s.average_hrv&&s.average_hrv>0)d.hrv=Math.round(s.average_hrv);
if(s.temperature_deviation!==undefined&&s.temperature_deviation!==null)d.tempDev=Math.round(s.temperature_deviation*10)/10;
const sc=s.score||(s.efficiency?Math.round(s.efficiency):0);
if(sc>d.score)d.score=sc;
});

(raw.daily_sleep||[]).forEach(ds=>{
const d=g(ds.day);
if(ds.score)d.score=ds.score;
});

(raw.daily_activity||[]).forEach(a=>{
const d=g(a.day);
d.cal=a.active_calories||0;
d.high=(a.high_activity_time||0)/60;
d.med=(a.medium_activity_time||0)/60;
});

(raw.workout||[]).forEach(w=>{
const day=w.day||(w.start_datetime?w.start_datetime.split('T')[0]:null);
if(day){const d=g(day);d.workouts.push({type:w.label||w.activity||'workout',calories:w.calories||0,startTime:w.start_datetime||null})}
});

(raw.daily_readiness||[]).forEach(r=>{
const d=g(r.day);
d.readiness=r.score||null;
if(r.temperature_trend_deviation!==undefined&&r.temperature_trend_deviation!==null)d.tempDev=Math.round(r.temperature_trend_deviation*10)/10;
});

(raw.daily_hrv||[]).forEach(h=>{
const d=g(h.day);
if(!d.hrv&&h.contributors?.balance){d.hrv=Math.round(h.contributors.balance)}
});

(raw.daily_cardiovascular_age||[]).forEach(c=>{
const d=g(c.day);
d.cardioAge=c.vascular_age||null;
});

this.history=Array.from(dayMap.values()).sort((a,b)=>b.date.localeCompare(a.date));
this.currentIndex=this.history.findIndex(h=>h.date===this.currentDateStr);
if(this.currentIndex===-1){
this.history.unshift({date:this.currentDateStr,score:0,totalSec:0,deepSec:0,remSec:0,rhr:'-',cal:0,high:0,med:0,workouts:[],hrv:null,tempDev:0,respRate:null,readiness:null,cardioAge:null});
this.currentIndex=0;
}
log('‚úÖ Processed '+this.history.length+' days');
}

// ========================================================================
// RENDERING
// ========================================================================
render(){
const day=this.history[this.currentIndex]||{};
const date=day.date||this.currentDateStr;
const sel=this.meals[date]||{};
const chk=this.checked[date]||[];
const portions=this.portions[date]||{};
const u=USERS[this.user];

// Date
const d=new Date(date+'T12:00:00');
const isToday=date===new Date().toLocaleDateString('en-CA');
const dayName=d.toLocaleDateString('en-US',{weekday:'long'});
const dateStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
this.setText('dateLabel',isToday?`TODAY ‚Äî ${dayName}, ${dateStr}`:`${dayName}, ${dateStr}`);

// Longevity score
const sleepPct=(day.score||0)/100;
const hrvPct=day.hrv?Math.min(day.hrv/50,1):0;
const readyPct=(day.readiness||0)/100;
const components=[];
if(day.score)components.push({w:0.35,v:sleepPct});
if(day.hrv)components.push({w:0.35,v:hrvPct});
if(day.readiness)components.push({w:0.30,v:readyPct});
const totalW=components.reduce((a,c)=>a+c.w,0)||1;
const longevity=components.length?Math.round(components.reduce((a,c)=>a+(c.v*(c.w/totalW)),0)*100):0;
log('üß¨ Longevity calc: sleep='+day.score+' hrv='+day.hrv+' ready='+day.readiness+' ‚Üí '+longevity);

// Score orbs
this.setText('dayGrade',day.score||'--');
this.setOrb('dayScoreOrb',(day.score||0));
this.setText('longevityScore',longevity>0?longevity:'--');
this.setOrb('longevityOrb',longevity);
this.setText('streakCount',this.streak);
this.setOrb('streakOrb',Math.min(this.streak*10,100));

// Recovery Battery
const batteryAvg=Math.round(((day.score||0)+(day.readiness||0)+(day.hrv?Math.min(day.hrv/80*100,100):0))/3);
this.setText('batteryScore',batteryAvg||'--');
const fillEl=document.getElementById('batteryFill');
if(fillEl)fillEl.style.width=batteryAvg+'%';

this.setText('bcHrv',day.hrv||'--');
this.setText('bcSleep',day.score||'--');
this.setText('bcReadiness',day.readiness||'--');
const strain=day.workouts.length>0?Math.min(Math.round((day.high+day.med)),100):0;
this.setText('bcStrain',strain);
{const prev7=this.history.slice(Math.max(0,this.currentIndex-7),this.currentIndex);
const avgStrain=prev7.length?prev7.reduce((a,h)=>{const s=h.workouts?.length>0?Math.min(Math.round((h.high||0)+(h.med||0)),100):0;return a+s;},0)/prev7.length:0;
const diff=strain-avgStrain;const trend=diff>5?'‚Üë':'';
this.setText('bcStrainTrend',prev7.length?trend||'‚Äî':'‚Äî');}

// Trends (compare to yesterday)
if(this.history.length>1){
const prev=this.history[Math.min(this.currentIndex+1,this.history.length-1)];
this.setTrend('bcHrvTrend',day.hrv,prev.hrv);
this.setTrend('bcSleepTrend',day.score,prev.score);
this.setTrend('bcReadinessTrend',day.readiness,prev.readiness);
}

// Status message
this.renderStatus(day);

// Insights
this.renderInsights(day);

// Recovery Metrics
this.renderRecoveryMetrics(day);

// Sleep Debt
this.renderSleepDebt();

// Couples Synergy
this.renderSynergy(date);

// Partner Food Log
this.renderPartnerFoodLog(date);

// Thermal buttons
this.renderThermalButtons(date);

// Macros
this.renderMacros(date,sel,portions);

// Calorie Balance
this.renderCalorieBalance(date,sel,portions,day);

// Streak
this.calculateStreak();
this.setText('streakCount',this.streak);
this.setOrb('streakOrb',Math.min(this.streak*10,100));

// Water
this.renderWater(date);

// Rainbow
this.renderRainbow(date,sel);

// Timeline
this.protocol=buildProtocol(this.user,date,day);
this.renderTimeline(this.protocol,sel,chk,portions,date);
}

setTrend(id,curr,prev){
const el=document.getElementById(id);
if(!el||!curr||!prev)return;
if(curr>prev)el.innerHTML=`<span class="trend-up">‚ñ≤${curr-prev}</span>`;
else if(curr<prev)el.innerHTML=`<span class="trend-down">‚ñº${prev-curr}</span>`;
else el.textContent='‚Äî';
}

renderStatus(day){
const el=document.getElementById('statusMsg');
if(!el)return;
el.textContent=this.getDailyRecommendation(day);
}

renderInsights(day){
const el=document.getElementById('insightCards');
if(!el)return;
let html='';
const recs=this.getSmartRecovery(day);
recs.slice(1).forEach(r=>{
const cls=r.type==='warning'?'warning':r.type==='good'?'recovery':'info';
html+=`<div class="insight-card ${cls}">${r.icon} ${r.msg}</div>`;
});
if(day.cardioAge)html+=`<div class="insight-card info">‚ù§Ô∏è Vascular Age: ${day.cardioAge} years</div>`;
el.innerHTML=html;
}

renderMacros(date,sel,portions){
const t=this.calcMacros(date,sel,portions);
const u=USERS[this.user];
const el=document.getElementById('macrosContent');
if(!el)return;
const macros=[
{name:'Protein',val:Math.round(t.protein),target:u.goals.protein,unit:'g',color:'var(--acid)'},
{name:'Omega-3',val:Math.round(t.omega3),target:u.goals.omega3,unit:'mg',color:'var(--cyan)'},
{name:'Fiber',val:Math.round(t.fiber),target:u.goals.fiber,unit:'g',color:'var(--purple)'},
{name:'Calories',val:Math.round(t.calories),target:2400,unit:'',color:'var(--orange)'},
{name:'Polyphenols',val:Math.round(t.polyphenol),target:1500,unit:'mg',color:'var(--success)'}
];
el.innerHTML=macros.map(m=>{
const pct=Math.min((parseFloat(m.val)/m.target)*100,100);
return `<div class="macro-row"><span class="macro-name">${m.name}</span><div class="macro-bar"><div class="macro-bar-fill" style="width:${pct}%;background:${m.color}"></div></div><span class="macro-val">${m.val}${m.unit} / ${m.target}${m.unit}</span></div>`;
}).join('');
const summaryEl=document.getElementById('macrosSummary');
if(summaryEl)summaryEl.textContent=`P:${Math.round(t.protein)}g | O3:${Math.round(t.omega3)}mg`;
}

calcMacros(date,sel,portions){
let t={protein:0,omega3:0,fiber:0,calories:0,polyphenol:0};
Object.keys(sel).forEach(slot=>{
const idx=sel[slot];
const meal=MEALS[slot]?.[idx];
if(meal){
const portion=(portions[slot]||1);
const remKey=`${date}:${slot}:${idx}`;
const removed=this.removedIngredients?.[remKey]||[];
let totalIng=1;
if(Array.isArray(meal.ingredients))totalIng=meal.ingredients.length;
else if(typeof meal.ingredients==='string')totalIng=meal.ingredients.split(',').filter(s=>s.trim()).length||1;
const ratio=removed.length>0&&totalIng>0?(totalIng-removed.length)/totalIng:1;
t.protein+=(meal.macros.p*portion*ratio)||0;
t.omega3+=(meal.macros.o*portion*ratio)||0;
t.fiber+=(meal.macros.f*portion*ratio)||0;
t.calories+=(meal.macros.cal*portion*ratio)||0;
t.polyphenol+=((meal.macros.poly||0)*portion*ratio);
}
});
return t;
}

renderWater(date){
const u=USERS[this.user];
const current=this.water[date]||0;
const target=Math.ceil(parseFloat((u.weight*0.67).toFixed(2))*10)/10;
const displayVal=Math.ceil(parseFloat(current.toFixed(2))*10)/10;
this.setText('waterDisplay',`${displayVal} / ${target} oz`);
const pct=Math.min((current/target)*100,100);
const barEl=document.getElementById('waterBarFill');
if(barEl)barEl.style.width=pct+'%';
}

addWater(oz){
const date=this.history[this.currentIndex]?.date||this.currentDateStr;
if(!this.water[date])this.water[date]=0;
this.water[date]=Math.max(0,this.water[date]+oz);
this.saveUserData();
this.renderWater(date);
}

renderRainbow(date,sel){
const el=document.getElementById('rainbowBar');
if(!el)return;
const activeColors=new Set();
Object.keys(sel).forEach(slot=>{
const meal=MEALS[slot]?.[sel[slot]];
if(meal&&meal.colors)meal.colors.forEach(c=>activeColors.add(c.toLowerCase()));
});
el.innerHTML=RAINBOW_COLORS.map((c,i)=>{
const colorNames=['red','orange','yellow','green','blue','indigo','violet'];
const isActive=activeColors.has(colorNames[i])||activeColors.has(c);
return `<div class="rainbow-segment${isActive?' active':''}" style="background:${c}" title="${RAINBOW_NAMES[i]}"></div>`;
}).join('');
}

renderTimeline(protocol,sel,chk,portions,date){
const el=document.getElementById('timeline');
if(!el)return;
el.innerHTML=protocol.map(t=>{
if(t.mealSlot&&sel[t.mealSlot]!==undefined){
const m=MEALS[t.mealSlot]?.[sel[t.mealSlot]];
if(m){
const portion=portions[t.mealSlot]||1;
t.title=m.title+(portion<1?' (HALF)':'');
t.desc=`P:${Math.round(m.macros.p*portion)}g Cal:${Math.round(m.macros.cal*portion)}`;
}
}
const isC=chk.includes(t.id);
const hasMeal=t.mealSlot&&sel[t.mealSlot]!==undefined;
const isChecked=isC||hasMeal;
const isAuto=t.autoDetected;
const isHrv=t.hrvAdjusted;
const isRecovery=t.cssClass==='recovery-task';
const isFacial=t.cssClass==='facial-task';
let cardStyle='',titleStyle='',circleStyle='';
if(isAuto){cardStyle='border-color:#a855f7;background:rgba(168,85,247,0.15)';titleStyle='color:#a855f7'}
else if(isHrv){cardStyle='border-color:#ff9500;background:rgba(255,149,0,0.15)';titleStyle='color:#ff9500'}
else if(isRecovery){cardStyle='border-color:#34d399;background:rgba(52,211,153,0.15)';titleStyle='color:#34d399'}
else if(isFacial){cardStyle='border-color:#a855f7;background:rgba(168,85,247,0.15)';titleStyle='color:#a855f7'}
else if(isChecked){cardStyle='border-color:#c8ff00;background:rgba(200,255,0,0.15)';titleStyle='color:#c8ff00';circleStyle='border-color:#c8ff00;background:rgba(200,255,0,0.15)'}
let ca='';
if(t.clickable&&t.type&&PROTOCOLS[t.type])ca=`onclick="app.showProtocolDetails('${t.type}')"`;
else if(t.mealSlot)ca=`onclick="app.openMealPicker('${t.mealSlot}')"`;
return `<div class="task"><div class="task-time">${t.time}</div><div class="task-card ${t.optional?'optional':''}" style="${cardStyle}" ${ca}><div class="task-info"><div class="task-title" style="${titleStyle}">${t.title}</div><div class="task-desc" style="${titleStyle}">${t.desc||'Tap to select'}</div></div>${(t.mealSlot||t.clickable)?'<div class="chevron">‚Ä∫</div>':''}${!isAuto&&!isHrv?`<div class="check-btn" onclick="event.stopPropagation();app.toggleTask('${t.id}')"><div class="check-circle" style="${circleStyle}">${isC?'‚úì':''}</div></div>`:''}</div></div>`;
}).join('');
}

// ========================================================================
// NAVIGATION
// ========================================================================
changeDate(direction){
const newIndex=this.currentIndex-direction;
if(newIndex>=0&&newIndex<this.history.length){
this.currentIndex=newIndex;
this.currentDateStr=this.history[newIndex].date;
this.render();
}
}

switchUser(newUser){
if(newUser===this.user)return;
this.saveUserData();
document.querySelectorAll('.user-switch button').forEach(b=>b.classList.remove('active'));
document.getElementById(`btn-${newUser}`)?.classList.add('active');
this.user=newUser;
localStorage.setItem('centurion_user',newUser);
this.history=[];
this.loadUserData();
this.setPlaceholderData();
this.render();
this.fetchOuraData();
}

toggleTask(taskId){
const dateKey=this.history[this.currentIndex]?.date;
if(!dateKey)return;
if(!this.checked[dateKey])this.checked[dateKey]=[];
const index=this.checked[dateKey].indexOf(taskId);
if(index===-1)this.checked[dateKey].push(taskId);
else this.checked[dateKey].splice(index,1);
this.saveUserData();
this.render();
}

// ========================================================================
// MEAL PICKER
// ========================================================================
openMealPicker(slot){
this.currentMealSlot=slot;
this.inRecipeView=false;
this.currentPortion=1;
document.getElementById('mealModal').classList.add('active');
this.setText('modalTitle',slot.toUpperCase().replace(/[0-9]/g,'')+' MENU');
document.getElementById('mealSearch').value='';
this.renderMealOptions(slot);
}

closeMealPicker(){
document.getElementById('mealModal').classList.remove('active');
this.inRecipeView=false;
}

filterMeals(query){this.renderMealOptions(this.currentMealSlot,query)}

renderMealOptions(slot,filter=''){
const meals=MEALS[slot]||[];
const body=document.getElementById('modalBody');
const date=this.history[this.currentIndex]?.date;
const selected=this.meals[date]?.[slot];
const q=filter.toLowerCase();
body.innerHTML=meals.map((m,i)=>{
if(q&&!m.title.toLowerCase().includes(q)&&!(m.ingredients||'').toLowerCase().includes(q))return '';
const isSel=selected===i;
return `<div class="meal-option${isSel?' selected':''}" onclick="app.showRecipe('${slot}',${i})"><div class="meal-name">${m.title}</div><div class="meal-macros">P:${m.macros.p}g | O3:${Math.round(m.macros.o)}mg | F:${m.macros.f}g | ${m.macros.cal} cal</div></div>`;
}).join('');
}

showRecipe(slot,idx){
if(this.currentMealSlot!==slot||this.currentMealIdx!==idx)this._freshRecipeOpen=true;
this.currentMealSlot=slot;
this.currentMealIdx=idx;
this.inRecipeView=true;
const meal=MEALS[slot][idx];
const body=document.getElementById('modalBody');
this.setText('modalTitle',meal.title.toUpperCase());
const savedPortion=this.portions?.[this.history[this.currentIndex]?.date]?.[slot]||1;
if(this.currentPortion===1&&savedPortion!==1)this.currentPortion=savedPortion;
const portion=this.currentPortion;
const allowHalf=['breakfast','lunch','dinner','snack1','snack2'].includes(slot);
const date=this.history[this.currentIndex]?.date||this.currentDateStr;
const remKey=`${date}:${slot}:${idx}`;
const removed=new Set(this.removedIngredients[remKey]||[]);
// Parse ingredients ‚Äî split strings into arrays
let ingList=[];
if(Array.isArray(meal.ingredients)){ingList=meal.ingredients;}
else if(typeof meal.ingredients==='string'&&meal.ingredients.length>0){ingList=meal.ingredients.split(',').map(s=>s.trim()).filter(s=>s.length>0);}
const breadIngIdx=ingList.findIndex(i=>(/bread|toast|sourdough|ezekiel|sprouted/i.test(i)));
const hasBread=breadIngIdx>=0;
const breadKey=`${date}:${slot}:${idx}`;
const breadOptions=['Sourdough','Ezekiel','Sprouted Grain','Whole Wheat','Gluten-Free'];
const currentBread=this.breadChoices[breadKey]||null;
const totalIng=ingList.length||1;
const activeIng=totalIng-removed.size;
const ratio=totalIng>0?activeIng/totalIng:1;
const adj={p:Math.round(meal.macros.p*portion*ratio),o:Math.round(meal.macros.o*portion*ratio),f:Math.round(meal.macros.f*portion*ratio),cal:Math.round(meal.macros.cal*portion*ratio),poly:Math.round((meal.macros.poly||0)*portion*ratio)};
const warnColor=removed.size>0?'var(--orange)':'var(--text)';
const portionLabel=portion===0.5?'(\u00bd)':portion===0.75?'(\u00be)':portion===1.5?'(1.5x)':'';
let html='<div class="recipe-section">';
html+=`<div class="recipe-section-title">MACROS ${portionLabel}${removed.size>0?' \u2014 '+removed.size+' REMOVED':''}</div>`;
html+=`<div class="macro-row"><span class="macro-name">Protein</span><span class="macro-val" style="color:${warnColor}">${adj.p}g</span></div>`;
html+=`<div class="macro-row"><span class="macro-name">Omega-3</span><span class="macro-val" style="color:${warnColor}">${adj.o}mg</span></div>`;
html+=`<div class="macro-row"><span class="macro-name">Fiber</span><span class="macro-val" style="color:${warnColor}">${adj.f}g</span></div>`;
html+=`<div class="macro-row"><span class="macro-name">Calories</span><span class="macro-val" style="color:${warnColor}">${adj.cal}</span></div>`;
html+=`<div class="macro-row"><span class="macro-name">Polyphenols</span><span class="macro-val" style="color:${warnColor}">${adj.poly}mg</span></div>`;
html+='</div>';
if(allowHalf){
const sizes=[{v:0.5,l:'\u00bd'},{v:0.75,l:'\u00be'},{v:1,l:'Full'},{v:1.5,l:'1.5x'}];
html+='<div class="portion-toggle" style="display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin:10px 0">';
sizes.forEach(s=>{html+=`<button class="portion-btn${portion===s.v?' active':''}" onclick="app.setPortion(${s.v})" style="padding:8px 12px;min-width:40px">${s.l}</button>`;});
html+='</div>';
}
if(hasBread){
html+=`<div class="recipe-section"><div class="recipe-section-title">\ud83c\udf5e BREAD TYPE</div><div class="bread-selector">`;
breadOptions.forEach(b=>{html+=`<div class="bread-opt ${currentBread===b?'active':''}" onclick="app.chooseBread('${breadKey}','${b}')">${b}</div>`;});
html+='</div></div>';
}
html+='<div class="recipe-section"><div class="recipe-section-title">INGREDIENTS</div>';
html+='<div class="ing-hint">Tap ingredient to remove it</div>';
ingList.forEach((ing,i)=>{
const isRem=removed.has(i);
let displayIng=ing;
if(i===breadIngIdx&&currentBread)displayIng=displayIng.replace(/sourdough|ezekiel|sprouted grain|whole wheat|bread/gi,currentBread);
html+=`<div class="ing-item${isRem?' removed':''}" onclick="app.toggleIngredient('${slot}',${idx},${i})">${displayIng}</div>`;
});
html+='</div>';
// Bio Hack
if(meal.why)html+=`<div class="synergy-box"><div class="syn-title">\ud83e\uddec BIO HACK</div><div class="syn-text">${meal.why}</div></div>`;
// Preparation steps
let stepsList=[];
if(meal.steps&&Array.isArray(meal.steps)){stepsList=meal.steps;}
else if(typeof meal.steps==='string'&&meal.steps.length>0){stepsList=meal.steps.split('~').map(s=>s.trim()).filter(s=>s.length>0);}
if(stepsList.length>0){
html+='<div class="recipe-section"><div class="recipe-section-title">PREPARATION</div>';
stepsList.forEach((s,i)=>{html+=`<div class="step-item"><div class="step-num">${i+1}</div><div>${s}</div></div>`;});
html+='</div>';
}
// Beverage Synergy Pairing
if(meal.suggestedBeverage){
const allJuices=[...(MEALS.juice2||[]),...(MEALS.juice3||[])];
const bevMatch=allJuices.find(j=>j.title===meal.suggestedBeverage);
const bevSlot=MEALS.juice2?.find(j=>j.title===meal.suggestedBeverage)?'juice2':'juice3';
const bevIdx=(MEALS[bevSlot]||[]).findIndex(j=>j.title===meal.suggestedBeverage);
html+=`<div style="background:linear-gradient(135deg,rgba(0,212,255,0.06),rgba(204,255,0,0.06));border:1px solid var(--acid);border-radius:14px;padding:16px;margin:12px 0;cursor:pointer" ${bevIdx>=0?`onclick="app.showRecipe('${bevSlot}',${bevIdx})"`:''}>`;
html+=`<div style="font-size:0.65rem;font-weight:900;color:var(--acid);letter-spacing:1px;margin-bottom:6px">\ud83c\udf79 PAIRS WELL WITH</div>`;
html+=`<div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:4px">${meal.suggestedBeverage}</div>`;
if(meal.synergyNote)html+=`<div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.4;margin-bottom:6px">${meal.synergyNote}</div>`;
if(bevMatch)html+=`<div style="font-size:0.6rem;color:var(--cyan)">TAP TO VIEW RECIPE \u203a</div>`;
html+=`</div>`;
}
html+=`<button class="add-protocol-btn" onclick="app.selectMeal('${slot}',${idx})">ADD TO PROTOCOL</button>`;
html+=`<button style="width:100%;padding:12px;background:transparent;border:1px solid var(--border);color:var(--text-secondary);border-radius:14px;font-size:0.8rem;cursor:pointer;margin-top:8px" onclick="app.renderMealOptions('${slot}')">\u2190 BACK TO MENU</button>`;
body.innerHTML=html;
if(this._freshRecipeOpen){body.scrollTop=0;this._freshRecipeOpen=false;}
}

chooseBread(key,type){
this.breadChoices[key]=type;
this.saveUserData();
const body=document.getElementById('modalBody');
const scrollPos=body?body.scrollTop:0;
this.showRecipe(this.currentMealSlot,this.currentMealIdx);
if(body)body.scrollTop=scrollPos;
}

toggleIngredient(slot,mealIdx,ingIdx){
const date=this.history[this.currentIndex]?.date||this.currentDateStr;
const key=`${date}:${slot}:${mealIdx}`;
if(!this.removedIngredients[key])this.removedIngredients[key]=[];
const arr=this.removedIngredients[key];
const i=arr.indexOf(ingIdx);
if(i===-1)arr.push(ingIdx);else arr.splice(i,1);
if(arr.length===0)delete this.removedIngredients[key];
this.saveUserData();
const body=document.getElementById('modalBody');
const scrollPos=body?body.scrollTop:0;
this.showRecipe(slot,mealIdx);
if(body)body.scrollTop=scrollPos;
}

setPortion(val){this.currentPortion=val;this.showRecipe(this.currentMealSlot,this.currentMealIdx)}

selectMeal(slot,idx){
const date=this.history[this.currentIndex]?.date;
if(!date)return;
if(!this.meals[date])this.meals[date]={};
this.meals[date][slot]=idx;
if(!this.portions[date])this.portions[date]={};
this.portions[date][slot]=this.currentPortion;
this.currentPortion=1;
this.saveUserData();
this.closeMealPicker();
this.render();
}

// ========================================================================
// BIOMARKERS
// ========================================================================
showBiomarkers(){
document.getElementById('bioModal').classList.add('active');
const fields=document.getElementById('bioFields');
const bios=this.bios||{...USERS[this.user].defaultBios};
const u=USERS[this.user];const g=u.goals;
const labels={weight:'Weight (lbs)',bmr:'BMR (kcal)',apob:'ApoB (mg/dL)',lpa:'Lp(a) (nmol/L)',hscrp:'hsCRP (mg/L)',hba1c:'HbA1c (%)',bodyfat:'Body Fat (%)',muscle:'Muscle Mass (lbs)',ldl:'LDL (mg/dL)',hdl:'HDL (mg/dL)',trig:'Triglycerides (mg/dL)',glucose:'Fasting Glucose (mg/dL)',vitD:'Vitamin D (ng/mL)',b12:'B12 (pg/mL)',omega3idx:'Omega-3 Index (%)',testosterone:'Testosterone (ng/dL)',estrogen:'Estrogen (pg/mL)',cortisol:'Cortisol (¬µg/dL)'};
// Optimal ranges
const ranges={apob:{lo:0,hi:80,unit:'mg/dL',good:'<80'},lpa:{lo:0,hi:75,unit:'nmol/L',good:'<75'},hscrp:{lo:0,hi:1.0,unit:'mg/L',good:'<1.0'},hba1c:{lo:4.5,hi:5.4,unit:'%',good:'4.5-5.4'},bodyfat:{lo:8,hi:18,unit:'%',good:'8-18'},glucose:{lo:70,hi:90,unit:'mg/dL',good:'70-90'},ldl:{lo:0,hi:100,unit:'mg/dL',good:'<100'},hdl:{lo:50,hi:100,unit:'mg/dL',good:'>50'},trig:{lo:0,hi:100,unit:'mg/dL',good:'<100'},vitD:{lo:40,hi:80,unit:'ng/mL',good:'40-80'},omega3idx:{lo:8,hi:12,unit:'%',good:'>8'},cortisol:{lo:6,hi:18,unit:'¬µg/dL',good:'6-18'}};
const rangeCheck=(k,v)=>{
if(!v||!ranges[k])return 'var(--text-tertiary)';
const r=ranges[k];
if(r.hi&&r.lo&&v>=r.lo&&v<=r.hi)return 'var(--success)';
if(r.hi&&!r.lo&&v<=r.hi)return 'var(--success)';
if(r.lo&&!r.hi&&v>=r.lo)return 'var(--success)';
return 'var(--alert)';
};
// Dashboard card helper
const dCard=(label,val,unit,color)=>`<div style="padding:10px;background:var(--panel-elevated);border:1px solid var(--border);border-radius:10px;text-align:center"><div style="font-size:1.1rem;font-weight:900;color:${color}">${val||'--'}</div><div style="font-size:0.5rem;color:var(--text-tertiary);margin-top:2px">${label}</div></div>`;
// Goal progress bar
const gProgress=(label,current,target,unit,color)=>{
if(!current||!target)return '';
const pct=Math.min((current/target)*100,120);const hit=pct>=90&&pct<=110;
return `<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:0.7rem;margin-bottom:3px"><span style="color:var(--text-secondary)">${label}</span><span style="color:${hit?'var(--success)':'var(--orange)'};font-weight:700">${current}${unit} ‚Üí ${target}${unit}</span></div><div style="height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(pct,100)}%;background:${color};border-radius:3px"></div></div></div>`;
};
let dashHtml=`
<div style="font-size:0.65rem;color:var(--text-tertiary);letter-spacing:1px;margin-bottom:10px">‚öñÔ∏è BODY COMPOSITION</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px">
${dCard('WEIGHT',bios.weight,'lbs','var(--text)')}
${dCard('BODY FAT',bios.bodyfat?bios.bodyfat+'%':'--','',rangeCheck('bodyfat',parseFloat(bios.bodyfat)))}
${dCard('MUSCLE',bios.muscle,'lbs','var(--cyan)')}
${dCard('BMR',bios.bmr,'kcal','var(--orange)')}
</div>
${gProgress('Weight Target',bios.weight?parseFloat(bios.weight):null,g.weightTarget,'lbs','var(--cyan)')}

<div class="bio-section-label">ü´Ä VASCULAR & METABOLIC</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:16px">
${dCard('ApoB',bios.apob,'',rangeCheck('apob',parseFloat(bios.apob)))}
${dCard('Lp(a)',bios.lpa,'',rangeCheck('lpa',parseFloat(bios.lpa)))}
${dCard('hsCRP',bios.hscrp,'',rangeCheck('hscrp',parseFloat(bios.hscrp)))}
${dCard('HbA1c',bios.hba1c,'',rangeCheck('hba1c',parseFloat(bios.hba1c)))}
${dCard('Glucose',bios.glucose,'',rangeCheck('glucose',parseFloat(bios.glucose)))}
${dCard('Cortisol',bios.cortisol,'',rangeCheck('cortisol',parseFloat(bios.cortisol)))}
</div>

<div class="bio-section-label">üß¨ LIPIDS & NUTRIENTS</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px">
${dCard('LDL',bios.ldl,'',rangeCheck('ldl',parseFloat(bios.ldl)))}
${dCard('HDL',bios.hdl,'',rangeCheck('hdl',parseFloat(bios.hdl)))}
${dCard('TRIG',bios.trig,'',rangeCheck('trig',parseFloat(bios.trig)))}
${dCard('Œ©3 IDX',bios.omega3idx,'',rangeCheck('omega3idx',parseFloat(bios.omega3idx)))}
${dCard('Vit D',bios.vitD,'',rangeCheck('vitD',parseFloat(bios.vitD)))}
${dCard('B12',bios.b12,'','var(--text-tertiary)')}
${dCard(this.user==='jermaine'?'TESTO':'ESTRO',this.user==='jermaine'?bios.testosterone:bios.estrogen,'','var(--purple)')}
${dCard('Cortisol',bios.cortisol,'',rangeCheck('cortisol',parseFloat(bios.cortisol)))}
</div>

<div class="bio-section-label">üéØ LONGEVITY GOALS</div>
${gProgress('Z2 Cardio/day',g.z2,45,'min','var(--success)')}
${gProgress('Z5 Intensity/day',g.z5,20,'min','var(--purple)')}
${gProgress('Cal Burn/day',g.calBurn,g.calBurn,'cal','var(--orange)')}
${gProgress('Protein/day',g.protein,g.protein,'g','var(--acid)')}

<div style="font-size:0.65rem;color:var(--text-tertiary);letter-spacing:1px;margin:20px 0 10px">‚úèÔ∏è EDIT VALUES</div>
`;
// Input fields for editing
dashHtml+=Object.keys(labels).map(k=>{
if(bios[k]===undefined&&!USERS[this.user].defaultBios.hasOwnProperty(k))return '';
return `<div class="bio-field"><label class="bio-label">${labels[k]}${ranges[k]?' (optimal: '+ranges[k].good+')':''}</label><input class="bio-input" id="bio_${k}" type="number" step="0.1" value="${bios[k]||''}" placeholder="Enter value"></div>`;
}).join('');
fields.innerHTML=dashHtml;
}

closeBiomarkers(){document.getElementById('bioModal').classList.remove('active')}

showBioTab(tab){
const dashBtn=document.getElementById('bioTabDash');
const trendBtn=document.getElementById('bioTabTrend');
const fieldsEl=document.getElementById('bioFields');
const trendEl=document.getElementById('bioTrending');
const saveBtn=document.getElementById('bioSaveBtn');
if(tab==='dash'){
dashBtn.style.background='var(--acid)';dashBtn.style.color='#000';dashBtn.style.borderColor='var(--acid)';
trendBtn.style.background='transparent';trendBtn.style.color='var(--text-tertiary)';trendBtn.style.borderColor='var(--border)';
fieldsEl.style.display='block';trendEl.style.display='none';saveBtn.style.display='block';
}else{
trendBtn.style.background='var(--acid)';trendBtn.style.color='#000';trendBtn.style.borderColor='var(--acid)';
dashBtn.style.background='transparent';dashBtn.style.color='var(--text-tertiary)';dashBtn.style.borderColor='var(--border)';
fieldsEl.style.display='none';trendEl.style.display='block';saveBtn.style.display='none';
this.renderTrending();
}
}

renderTrending(){
document.getElementById('bioTrending').innerHTML=this.getTrendingHtml();
}

saveBiomarkers(){
const bios={};
document.querySelectorAll('.bio-input').forEach(input=>{
const key=input.id.replace('bio_','');
bios[key]=input.value?parseFloat(input.value):null;
});
this.bios=bios;
this.saveUserData();
this.closeBiomarkers();
log('‚úÖ Biomarkers saved');
}

// ========================================================================
// PROTOCOL DETAILS & WEEKLY SUMMARY
// ========================================================================
showProtocolDetails(type){
const p=PROTOCOLS[type];
if(!p)return;
document.getElementById('mealModal').classList.add('active');
this.setText('modalTitle',p.title);
document.getElementById('modalBody').innerHTML=`<div style="padding:10px">${p.steps.map(s=>`<div style="padding:12px 0;border-bottom:1px solid var(--border);color:var(--text-secondary);font-size:0.9rem;line-height:1.6">${s}</div>`).join('')}</div>`;
}

showWeeklySummary(){
const last7=this.history.slice(0,7);
const u=USERS[this.user];const g=u.goals;const bios=this.bios||{...u.defaultBios};
// Averages
const avgSleep=last7.reduce((a,d)=>a+(d.totalSec||0),0)/last7.length/3600;
const avgHrv=last7.filter(d=>d.hrv).reduce((a,d)=>a+d.hrv,0)/(last7.filter(d=>d.hrv).length||1);
const avgScore=last7.reduce((a,d)=>a+(d.score||0),0)/last7.length;
const avgReadiness=last7.filter(d=>d.readiness).reduce((a,d)=>a+d.readiness,0)/(last7.filter(d=>d.readiness).length||1);
const avgRhr=last7.filter(d=>d.rhr!=='-').reduce((a,d)=>a+d.rhr,0)/(last7.filter(d=>d.rhr!=='-').length||1);
const totalWorkouts=last7.reduce((a,d)=>a+(d.workouts?.length||0),0);
const avgDeep=last7.reduce((a,d)=>a+(d.deepSec||0),0)/last7.length/60;
const avgRem=last7.reduce((a,d)=>a+(d.remSec||0),0)/last7.length/60;
const avgCal=last7.reduce((a,d)=>a+(d.cal||0),0)/last7.length;
// Goal check helpers
const gBar=(label,val,target,unit,color)=>{
const pct=Math.min((val/target)*100,150);const hit=pct>=90;
const statusIcon=hit?'‚úÖ':'‚ö†Ô∏è';const statusColor=hit?'var(--success)':'var(--alert)';
return `<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:4px"><span style="color:var(--text-secondary)">${statusIcon} ${label}</span><span style="color:${statusColor};font-weight:700">${val}${unit} / ${target}${unit}</span></div><div style="height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(pct,100)}%;background:${hit?color:'var(--alert)'};border-radius:3px;transition:width 0.3s"></div></div></div>`;
};
// Advice engine
const advice=[];
if(avgSleep<(g.sleepHours||8)-0.5)advice.push({icon:'üò¥',msg:`Sleep avg ${avgSleep.toFixed(1)}h ‚Äî below ${g.sleepHours||8}h target. Push bedtime 30 min earlier.`,color:'var(--alert)'});
else if(avgSleep>=(g.sleepHours||8))advice.push({icon:'üåô',msg:`Sleep on track at ${avgSleep.toFixed(1)}h avg. Keep it up!`,color:'var(--success)'});
if(avgHrv<u.hrvBaseline*0.8)advice.push({icon:'üíì',msg:`HRV trending low (${Math.round(avgHrv)}ms vs ${u.hrvBaseline}ms baseline). Prioritize recovery days.`,color:'var(--alert)'});
else if(avgHrv>=u.hrvBaseline)advice.push({icon:'üíö',msg:`HRV strong at ${Math.round(avgHrv)}ms ‚Äî above your ${u.hrvBaseline}ms baseline.`,color:'var(--success)'});
if(avgDeep<45)advice.push({icon:'üß†',msg:`Deep sleep avg ${Math.round(avgDeep)}min ‚Äî aim for 60+ min. Reduce late screens & alcohol.`,color:'var(--orange)'});
if(avgRem<60)advice.push({icon:'üí≠',msg:`REM avg ${Math.round(avgRem)}min ‚Äî target 90min. Consistent wake time helps.`,color:'var(--orange)'});
if(totalWorkouts<3)advice.push({icon:'üèãÔ∏è',msg:`Only ${totalWorkouts} workouts this week. Target 4-5 for longevity goals.`,color:'var(--alert)'});
else if(totalWorkouts>=5)advice.push({icon:'üî•',msg:`${totalWorkouts} workouts! Strong consistency.`,color:'var(--success)'});
if(g.calBurn&&avgCal<g.calBurn*0.7)advice.push({icon:'‚ö°',msg:`Avg active burn ${Math.round(avgCal)} cal ‚Äî below ${g.calBurn} target. Add Zone 2.`,color:'var(--orange)'});
if(bios.weight&&g.weightTarget){
const diff=parseFloat(bios.weight)-g.weightTarget;
if(Math.abs(diff)>3)advice.push({icon:'‚öñÔ∏è',msg:`Current ${bios.weight} lbs ‚Üí Target ${g.weightTarget} lbs (${diff>0?diff.toFixed(1)+' lbs to lose':Math.abs(diff).toFixed(1)+' lbs to gain'})`,color:Math.abs(diff)>10?'var(--alert)':'var(--orange)'});
else advice.push({icon:'‚öñÔ∏è',msg:`Weight ${bios.weight} lbs ‚Äî within range of ${g.weightTarget} lb target!`,color:'var(--success)'});
}
if(advice.length===0)advice.push({icon:'üéØ',msg:'All metrics on track. Follow today\'s protocol for optimal results.',color:'var(--success)'});
// Build HTML
document.getElementById('mealModal').classList.add('active');
this.setText('modalTitle','üìä WEEKLY REPORT');
const trendHtml=this.getTrendingHtml();
document.getElementById('modalBody').innerHTML=`
<div style="padding:15px">
<div style="display:flex;gap:6px;margin-bottom:16px">
<button id="weekTabSum" onclick="document.getElementById('weekSummary').style.display='block';document.getElementById('weekTrend').style.display='none';this.style.background='var(--acid)';this.style.color='#000';document.getElementById('weekTabTrend').style.background='transparent';document.getElementById('weekTabTrend').style.color='var(--text-tertiary)'" style="flex:1;padding:10px;border:1px solid var(--acid);background:var(--acid);color:#000;border-radius:10px;font-size:0.65rem;font-weight:900;cursor:pointer;letter-spacing:1px">SUMMARY</button>
<button id="weekTabTrend" onclick="document.getElementById('weekTrend').style.display='block';document.getElementById('weekSummary').style.display='none';this.style.background='var(--acid)';this.style.color='#000';document.getElementById('weekTabSum').style.background='transparent';document.getElementById('weekTabSum').style.color='var(--text-tertiary)'" style="flex:1;padding:10px;border:1px solid var(--border);background:transparent;color:var(--text-tertiary);border-radius:10px;font-size:0.65rem;font-weight:900;cursor:pointer;letter-spacing:1px">TRENDING</button>
</div>
<div id="weekSummary">
<div style="font-size:0.65rem;color:var(--text-tertiary);letter-spacing:1px;margin-bottom:12px">üéØ GOAL TRACKING</div>
${gBar('Sleep',avgSleep.toFixed(1),g.sleepHours||8,' hrs','var(--cyan)')}
${gBar('HRV',Math.round(avgHrv),u.hrvBaseline,' ms','var(--purple)')}
${gBar('Readiness',Math.round(avgReadiness),85,'','var(--success)')}
${gBar('Workouts/wk',totalWorkouts,4,'','var(--acid)')}
${g.calBurn?gBar('Avg Cal Burn',Math.round(avgCal),g.calBurn,' cal','var(--orange)'):''}
${g.z2?gBar('Deep Sleep',Math.round(avgDeep),60,' min','var(--purple)'):''}

<div style="font-size:0.65rem;color:var(--text-tertiary);letter-spacing:1px;margin:20px 0 12px">üß† AI WEEKLY ADVICE</div>
${advice.map(a=>`<div style="padding:10px 12px;margin-bottom:8px;background:rgba(255,255,255,0.03);border-left:3px solid ${a.color};border-radius:0 8px 8px 0;font-size:0.8rem;color:var(--text-secondary)">${a.icon} ${a.msg}</div>`).join('')}

<div style="font-size:0.65rem;color:var(--text-tertiary);letter-spacing:1px;margin:20px 0 12px">üìà 7-DAY STATS</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--cyan)">${avgSleep.toFixed(1)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG SLEEP (hrs)</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--purple)">${Math.round(avgHrv)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG HRV (ms)</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--acid)">${Math.round(avgScore)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG SLEEP SCORE</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--success)">${Math.round(avgReadiness)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG READINESS</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--orange)">${Math.round(avgRhr)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG RHR (bpm)</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--acid)">${totalWorkouts}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">WORKOUTS</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--purple)">${Math.round(avgDeep)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG DEEP (min)</div></div>
<div class="stat-card"><div style="font-size:1.1rem;font-weight:900;color:var(--cyan)">${Math.round(avgRem)}</div><div style="font-size:0.55rem;color:var(--text-tertiary)">AVG REM (min)</div></div>
</div>
<div style="margin-top:16px;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;text-align:center"><span style="color:var(--text-tertiary);font-size:0.75rem">üî• Streak: </span><span style="color:var(--acid);font-weight:900;font-size:1rem">${this.streak} days</span></div>
</div>
<div id="weekTrend" style="display:none">${trendHtml}</div>
</div>`;
}

getTrendingHtml(){
const u=USERS[this.user];const bios=this.bios||{...u.defaultBios};
const weekNum=Math.max(1,Math.ceil(this.streak/7));
const compliance=Math.min(this.streak/7*0.15,0.95);
const trendBar=(label,now,goal,unit,lowerBetter,icon)=>{
if(!now||!goal)return '';
const pct=lowerBetter?Math.max(0,Math.min(100,((1-(now-goal)/(now*0.5))*100))):Math.max(0,Math.min(100,(now/goal)*100));
const improving=lowerBetter?(now>goal):(now<goal);
const projected=lowerBetter?now-(now-goal)*compliance:now+(goal-now)*compliance;
const projRounded=Math.round(projected*10)/10;
const arrow=lowerBetter?(projected<now?'üìâ':'üìà'):(projected>now?'üìà':'üìâ');
const barColor=pct>=90?'var(--success)':pct>=60?'var(--orange)':'var(--alert)';
return `<div style="margin-bottom:16px;padding:14px;background:var(--panel-elevated);border:1px solid var(--border);border-radius:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-weight:800;font-size:0.85rem">${icon} ${label}</span>
<span style="font-size:0.65rem;color:var(--text-tertiary)">${unit}</span>
</div>
<div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:4px">
<span style="color:var(--text-secondary)">NOW: <strong style="color:var(--text)">${now}</strong></span>
<span style="color:var(--cyan)">GOAL: <strong>${goal}</strong></span>
</div>
<div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;margin-bottom:8px">
<div style="height:100%;width:${Math.min(pct,100)}%;background:${barColor};border-radius:4px;transition:width 0.8s"></div>
</div>
${improving?`<div style="font-size:0.7rem;color:var(--success)">${arrow} Trending: <strong>${projRounded}${unit}</strong> (Week ${weekNum})</div>`:`<div style="font-size:0.7rem;color:var(--success)">‚úÖ On track!</div>`}
</div>`;
};
let html=`<div style="text-align:center;margin-bottom:16px;padding:12px;background:var(--panel-elevated);border-radius:12px">
<div style="font-size:0.6rem;color:var(--text-tertiary);letter-spacing:1px;margin-bottom:4px">PROTOCOL COMPLIANCE</div>
<div style="font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--acid),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Week ${weekNum}</div>
<div style="font-size:0.7rem;color:var(--text-secondary)">üî• ${this.streak} day streak</div>
</div>`;
html+=`<div class="bio-section-label">‚öñÔ∏è BODY COMPOSITION</div>`;
if(u.bodyGoals){Object.entries(u.bodyGoals).forEach(([k,v])=>{
const current=bios[k]?parseFloat(bios[k]):v.now;
html+=trendBar(k.replace(/([A-Z])/g,' $1').toUpperCase(),current,v.goal,v.unit,v.lowerBetter,k==='weight'?'‚öñÔ∏è':k==='bodyfat'?'üìâ':k==='muscle'?'üí™':'ü´Å');
});}
html+=`<div class="bio-section-label">üß¨ BLOOD BIOMARKERS</div>`;
if(u.labGoals){Object.entries(u.labGoals).forEach(([k,v])=>{
const current=bios[k]?parseFloat(bios[k]):null;
if(current)html+=trendBar(k.toUpperCase(),current,v.goal,v.unit,v.lowerBetter,'ü©∏');
});}
html+=`<div class="bio-section-label">üèãÔ∏è PERFORMANCE TESTS</div>`;
if(u.tests){Object.entries(u.tests).forEach(([k,v])=>{
html+=trendBar(v.name,v.now,v.goal,v.unit,false,'üéØ');
});}
return html;
}

// ========================================================================
// RECOVERY METRICS
// ========================================================================
renderRecoveryMetrics(day){
this.setText('metricRhr',day.rhr!=='-'?day.rhr:'--');
this.setText('metricResp',day.respRate?day.respRate.toFixed(1):'--');
this.setText('metricTemp',day.tempDev?((day.tempDev>0?'+':'')+day.tempDev.toFixed(1)):'--');
this.setText('metricVasc',day.cardioAge||'--');
}

// ========================================================================
// WORKOUT IMPACT SYSTEM (v21)
// ========================================================================
getWorkoutImpact(day){
if(!day.workouts||day.workouts.length===0)return null;
const impacts={
'cycling':{z2:30,cal:250,recovery:'low'},
'running':{z2:25,z5:10,cal:350,recovery:'medium'},
'walking':{z2:15,cal:120,recovery:'low'},
'strength_training':{cal:200,recovery:'medium'},
'hiit':{z5:20,cal:400,recovery:'high'},
'swimming':{z2:30,cal:300,recovery:'low'},
'yoga':{cal:100,recovery:'restorative'},
'basketball':{z5:15,z2:15,cal:400,recovery:'high'},
'boxing':{z5:15,cal:350,recovery:'high'},
'workout':{z2:15,cal:200,recovery:'medium'}
};
let totalCal=0,totalZ2=0,totalZ5=0,maxRecovery='low';
const recoveryOrder=['low','medium','high'];
day.workouts.forEach(w=>{
const type=(w.type||'workout').toLowerCase().replace(/\s+/g,'_');
const impact=impacts[type]||impacts['workout'];
totalCal+=w.calories||impact.cal||200;
totalZ2+=impact.z2||0;
totalZ5+=impact.z5||0;
if(recoveryOrder.indexOf(impact.recovery)>recoveryOrder.indexOf(maxRecovery))maxRecovery=impact.recovery;
});
return{calories:totalCal,z2:totalZ2,z5:totalZ5,recovery:maxRecovery,types:day.workouts.map(w=>w.type)};
}

// ========================================================================
// SMART RECOVERY RECOMMENDATIONS (v21)
// ========================================================================
getSmartRecovery(day){
const recs=[];
if(day.hrv&&day.hrv<USERS[this.user].hrvBaseline*0.7)recs.push({icon:'üíú',msg:'HRV significantly below baseline ‚Äî skip HIIT, Zone 2 only',type:'warning'});
else if(day.hrv&&day.hrv<USERS[this.user].hrvBaseline)recs.push({icon:'üíõ',msg:'HRV below baseline ‚Äî moderate intensity today',type:'caution'});
if(day.score&&day.score<65)recs.push({icon:'üò¥',msg:'Poor sleep ‚Äî add 30 min nap, prioritize recovery',type:'warning'});
if(day.readiness&&day.readiness>85)recs.push({icon:'üü¢',msg:'High readiness ‚Äî push intensity today',type:'good'});
const impact=this.getWorkoutImpact(day);
if(impact&&impact.recovery==='high')recs.push({icon:'üßä',msg:'High-impact workout detected ‚Äî consider contrast therapy',type:'recovery'});
if(day.tempDev&&day.tempDev>0.5)recs.push({icon:'üå°Ô∏è',msg:'Elevated temp ‚Äî immune system active, rest more',type:'warning'});
return recs;
}

// ========================================================================
// DAILY RECOMMENDATION (AI Advisor enhanced)
// ========================================================================
getDailyRecommendation(day){
const recs=this.getSmartRecovery(day);
if(recs.length>0)return recs[0].icon+' '+recs[0].msg;
const impact=this.getWorkoutImpact(day);
if(impact)return `üí™ ${impact.types.join(', ')} detected ‚Äî ${impact.calories} cal burned. ${impact.recovery==='high'?'Recovery focus tonight.':'Nice work.'}`;
return 'üìä Follow today\'s protocol for optimal results.';
}

// ========================================================================
// STREAK CALCULATION (v21)
// ========================================================================
calculateStreak(){
let streak=0;
const today=new Date().toLocaleDateString('en-CA');
for(let i=0;i<this.history.length;i++){
const d=this.history[i];
const chk=this.checked[d.date]||[];
const sel=this.meals[d.date]||{};
const hasActivity=chk.length>=3||Object.keys(sel).length>=2;
if(hasActivity)streak++;
else break;
}
this.streak=streak;
this.saveUserData();
return streak;
}

// ========================================================================

// ========================================================================

// ========================================================================
// CALORIE BALANCE (v21)
// ========================================================================
renderCalorieBalance(date,sel,portions,day){
const el=document.getElementById('caloriePanel');
if(!el)return;
const u=USERS[this.user];
const bmr=this.bios?.bmr||u.defaultBios.bmr;
const t=this.calcMacros(date,sel,portions);
const intake=Math.round(t.calories);
const impact=this.getWorkoutImpact(day);
const burned=impact?impact.calories:(day.cal||0);
const net=intake-bmr-burned;
const summaryEl=document.getElementById('caloriesSummary');
if(summaryEl)summaryEl.textContent=`Net: ${net>0?'+':''}${Math.round(net)} cal`;

el.innerHTML=`
<div class="calorie-row"><span class="calorie-label">BMR</span><span class="calorie-val">${bmr} cal</span></div>
<div class="calorie-row"><span class="calorie-label">Food Intake</span><span class="calorie-val calorie-neutral">${intake} cal</span></div>
<div class="calorie-row"><span class="calorie-label">Workout Burn</span><span class="calorie-val calorie-positive">-${burned} cal</span></div>
<div class="calorie-row"><span class="calorie-label">Net Balance</span><span class="calorie-val ${net>200?'calorie-negative':net<-200?'calorie-positive':'calorie-neutral'}">${net>0?'+':''}${Math.round(net)} cal</span></div>
`;
}

// ========================================================================
// COLLAPSIBLE SECTIONS (v21)
// ========================================================================
toggleSection(sectionId){
const body=document.getElementById(sectionId+'Body');
const chevron=document.getElementById(sectionId+'Chevron');
if(!body)return;
body.classList.toggle('collapsed');
if(chevron)chevron.classList.toggle('collapsed');
}

// ========================================================================
// SLEEP DEBT (7-day balance)
// ========================================================================
renderSleepDebt(){
const u=USERS[this.user];
const targetSec=u.goals.sleepHours*3600;
const last7=this.history.slice(0,7);
let totalDebt=0;
let daysWithData=0;
last7.forEach(d=>{
if(d.totalSec>0){
totalDebt+=(d.totalSec-targetSec);
daysWithData++;
}
});
const debtHrs=totalDebt/3600;
const el=document.getElementById('sleepDebtValue');
if(el){
if(debtHrs>=0){el.textContent='+'+debtHrs.toFixed(1)+'h';el.className='sleep-debt-value debt-positive'}
else{el.textContent=debtHrs.toFixed(1)+'h';el.className='sleep-debt-value debt-negative'}
}
const fillEl=document.getElementById('sleepDebtFill');
if(fillEl){
const pct=Math.min(Math.max(50+(debtHrs/8*50),5),95);
fillEl.style.width=pct+'%';
fillEl.style.background=debtHrs>=0?'var(--success)':'var(--alert)';
}
const info=document.getElementById('sleepDebtInfo');
if(info){
if(daysWithData===0)info.textContent='No sleep data yet';
else if(debtHrs>=-1&&debtHrs<=1)info.textContent='‚úÖ Sleep balanced ‚Äî great consistency';
else if(debtHrs<-1)info.textContent='‚ö†Ô∏è Sleep deficit ‚Äî prioritize extra rest';
else info.textContent='üü¢ Sleep surplus ‚Äî well rested';
}
}

// ========================================================================
// COUPLES SYNERGY DASHBOARD
// ========================================================================
renderSynergy(date){
const el=document.getElementById('synergyContent');
if(!el)return;
const other=this.user==='jermaine'?'sophia':'jermaine';
// Load other user's data from localStorage
let otherChecked={},otherMeals={},otherWater={};
try{
otherChecked=JSON.parse(localStorage.getItem(`c_checked_${other}`)||'{}');
otherMeals=JSON.parse(localStorage.getItem(`c_meals_${other}`)||'{}');
otherWater=JSON.parse(localStorage.getItem(`c_water_${other}`)||'{}');
}catch(e){}

const day=this.history[this.currentIndex]||{};
const myWater=this.water[date]||0;
const theirWater=otherWater[date]||0;
const myTarget=Math.ceil(parseFloat((USERS[this.user].weight*0.67).toFixed(2))*10)/10;
const theirTarget=Math.ceil(parseFloat((USERS[other].weight*0.67).toFixed(2))*10)/10;

const myMeals=Object.keys(this.meals[date]||{}).length;
const theirMeals=Object.keys(otherMeals[date]||{}).length;
const myTasks=(this.checked[date]||[]).length;
const theirTasks=(otherChecked[date]||[]).length;

const jLabel=this.user==='jermaine'?'YOU':'J';
const sLabel=this.user==='sophia'?'YOU':'S';

const jCal=this.user==='jermaine'?(day.cal||0):0;
const sCal=this.user==='sophia'?(day.cal||0):0;
const jWork=this.user==='jermaine'?(day.workouts?.length||0):0;
const sWork=this.user==='sophia'?(day.workouts?.length||0):0;
const jSleep=this.user==='jermaine'?(day.score||0):0;
const sSleep=this.user==='sophia'?(day.score||0):0;
const jReady=this.user==='jermaine'?(day.readiness||0):0;
const sReady=this.user==='sophia'?(day.readiness||0):0;
const lead=(a,b)=>a>b?'color:var(--acid)':'';
const leadB=(a,b)=>b>a?'color:var(--acid)':'';

el.innerHTML=`
<div class="synergy-row"><span class="synergy-name">üî• Calories Burned</span><div class="synergy-vals"><span class="synergy-j" style="${lead(jCal,sCal)}">${jLabel}: ${jCal}</span><span class="synergy-s" style="${leadB(jCal,sCal)}">${sLabel}: ${sCal}</span></div></div>
<div class="synergy-row"><span class="synergy-name">üèãÔ∏è Workouts</span><div class="synergy-vals"><span class="synergy-j" style="${lead(jWork,sWork)}">${jLabel}: ${jWork}</span><span class="synergy-s" style="${leadB(jWork,sWork)}">${sLabel}: ${sWork}</span></div></div>
<div class="synergy-row"><span class="synergy-name">üò¥ Sleep Score</span><div class="synergy-vals"><span class="synergy-j" style="${lead(jSleep,sSleep)}">${jLabel}: ${jSleep||'--'}</span><span class="synergy-s" style="${leadB(jSleep,sSleep)}">${sLabel}: ${sSleep||'--'}</span></div></div>
<div class="synergy-row"><span class="synergy-name">‚ö° Readiness</span><div class="synergy-vals"><span class="synergy-j" style="${lead(jReady,sReady)}">${jLabel}: ${jReady||'--'}</span><span class="synergy-s" style="${leadB(jReady,sReady)}">${sLabel}: ${sReady||'--'}</span></div></div>
`;
}

// ========================================================================
// PARTNER FOOD LOG
// ========================================================================
renderPartnerFoodLog(date){
const el=document.getElementById('partnerFoodLog');
if(!el)return;
const other=this.user==='jermaine'?'sophia':'jermaine';
let otherMeals={};
try{otherMeals=JSON.parse(localStorage.getItem(`c_meals_${other}`)||'{}')}catch(e){}
const sel=otherMeals[date]||{};
const slots=['breakfast','lunch','dinner','snack1','snack2'];
const logged=slots.filter(s=>sel[s]!==undefined);
if(logged.length===0){el.innerHTML='<div style="color:var(--text-tertiary);font-size:0.75rem">No meals logged yet</div>';return}
el.innerHTML=logged.map(s=>{
const meal=MEALS[s]?.[sel[s]];
if(!meal)return '';
return `<div class="partner-meal"><span class="partner-slot">${s.replace(/[0-9]/g,'')}</span><span>${meal.title}</span><span style="color:var(--text-tertiary)">${meal.macros.p}g P</span></div>`;
}).join('');
}

// ========================================================================
// THERMAL DETECTION (Sauna/Cryo logging)
// ========================================================================
logThermal(type){
const date=this.history[this.currentIndex]?.date||this.currentDateStr;
const key=`thermal_${type}`;
if(!this.checked[date])this.checked[date]=[];
const idx=this.checked[date].indexOf(key);
if(idx===-1)this.checked[date].push(key);
else this.checked[date].splice(idx,1);
this.saveUserData();
this.renderThermalButtons(date);
log(`üå°Ô∏è Thermal ${type}: ${idx===-1?'logged':'removed'}`);
}

renderThermalButtons(date){
const chk=this.checked[date]||[];
['sauna','cryo','contrast'].forEach(t=>{
const el=document.getElementById('thermal'+t.charAt(0).toUpperCase()+t.slice(1));
if(el){
if(chk.includes('thermal_'+t))el.classList.add('logged');
else el.classList.remove('logged');
}
});
}

// ========================================================================
// SYNC
// ========================================================================
sync(){this.fetchOuraData()}
}

// ============================================================================
// INIT
// ============================================================================
let app;
window.onload=()=>{app=new CenturionApp();window.app=app};
</script>

</body>
</html>