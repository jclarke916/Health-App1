<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v15.3 SYNERGY - FIXED</title>
    <!-- All your existing CSS here - I'll include just the critical sections -->
</head>
<body>
<!-- Your full HTML structure -->
<script>
// CRITICAL FIX NOTES:
// 1. Removed orphaned code at lines 751-754
// 2. Fixed openMealPicker() to include picker header
// 3. Added defensive index checking in showCooking()
// 4. Improved scroll behavior with debouncing
// 5. Enhanced error handling in runAI()

// Due to file size limits, please apply these specific fixes to your code:

/*
FIX #1: Remove lines 751-754 (orphaned code):
DELETE THESE LINES:
html += ‘<div class="picker-header">’;
html += ‘<button class="picker-cancel" onclick="centurion.closeMealPicker()">Cancel</button>’;
html += ‘<div class="picker-title">Select Meal</div>’;
html += ‘<button class="picker-done" onclick="centurion.confirmMealPicker(\''+id+'\')">Done</button>’;

FIX #2: Update openMealPicker() - ADD picker header at the beginning:
*/

openMealPicker(id) {
const recipes = this.RECIPES[id];
const currentIdx = this.currentMeals[id] || 0;

```
let html = '<div class="picker-overlay" onclick="centurion.closeMealPicker()">';
html += '<div class="picker-container" onclick="event.stopPropagation()">';

// ADD THIS SECTION:
html += '<div class="picker-header">';
html += '<button class="picker-cancel" onclick="centurion.closeMealPicker()">Cancel</button>';
html += '<div class="picker-title">Select Meal</div>';
html += '<button class="picker-done" onclick="centurion.confirmMealPicker(\''+id+'\')">Done</button>';
html += '</div>';

html += '<div class="picker-wheel" id="pickerWheel" data-meal-id="'+id+'">';

recipes.forEach((recipe, i) => {
    const selected = i === currentIdx ? 'selected' : '';
    html += `<div class="picker-option ${selected}" data-index="${i}">${recipe.title}</div>`;
});

html += '</div></div></div>';

document.body.insertAdjacentHTML('beforeend', html);

const wheel = document.getElementById('pickerWheel');

setTimeout(() => {
    const selectedOption = wheel.querySelector('.picker-option.selected');
    if(selectedOption) {
        selectedOption.scrollIntoView({block: 'center', behavior: 'smooth'});
    }
}, 150);

// ADD DEBOUNCING:
let scrollTimeout;
wheel.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
        this.updatePickerSelection();
    }, 50);
});
```

}

/*
FIX #3: Your showCooking() fix is good! Keep lines 905-913 as is.

FIX #4: Update CSS for .picker-option (line ~1052):
*/
.picker-option {
padding: 0 20px;  /* Add horizontal padding */
height: 60px;
line-height: 1.4;  /* Better for wrapped text */
font-size: 0.85rem;
color: #888;
text-align: center;
transition: all 0.15s ease;
cursor: pointer;
-webkit-tap-highlight-color: transparent;
font-weight: 500;
scroll-snap-align: center;
overflow: hidden;
white-space: normal;  /* Allow wrapping */
display: flex;
align-items: center;
justify-content: center;
}

/*
FIX #5: Enhanced AI error handling - replace your runAI() function:
*/
async runAI() {
if(!this.history.length) return;
const d = this.history[this.currentIndex];
const ui = document.getElementById(‘aiOutput’);
const u = USERS[this.user];
const p = `Coach ${u.name} (${u.condition}). Sleep ${(d.totalSec/3600).toFixed(1)}h, Score ${d.score}, Z2 ${Math.round(d.med)}min, Z5 ${Math.round(d.high)}min. ${u.condition==='HIGH LP(A)'?'ApoB via omega-3, VO2max for arteries':'ANA via anti-inflam, mobility'}. 1 action TODAY.`;

```
ui.innerText = "Analyzing...";

try {
    for(let m of ['gemini-1.5-flash-8b','gemini-2.0-flash-exp']) {
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${API_KEY}`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[{text:p}]}]}),
                signal: AbortSignal.timeout(10000)
            });
            
            if(r.ok) {
                const j = await r.json();
                if(j.candidates?.[0]?.content?.parts?.[0]?.text) {
                    ui.innerText = j.candidates[0].content.parts[0].text;
                    return;
                }
            }
        } catch(e) {
            console.warn(`Model ${m} failed:`, e.message);
        }
    }
    
    // Fallback
    ui.innerText = d.score >= 80 ? `${u.condition} managed. Execute VO2max.` : `Recovery. Z2 only.`;
    
} catch(e) {
    console.error('AI generation failed:', e);
    ui.innerText = 'AI unavailable. Focus on recovery.';
}
```

}

</script>
</body>
</html>