<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v17.17 CLEAN-UI</title>
<style>
/* --- CORE STYLES --- */
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:sans-serif;padding-bottom:100px; -webkit-tap-highlight-color: transparent;}
.header{background:#111;padding:15px;border-bottom:1px solid #333;position:sticky;top:0;z-index:100}

/* CONTROLS */
.user-switch{display:flex;gap:5px;background:#222;padding:3px;border-radius:20px;margin-bottom:10px}
.user-switch button{flex:1;padding:8px 12px;border:none;background:transparent;color:#666;border-radius:16px;cursor:pointer;font-weight:900;font-size:0.7rem;transition:all 0.2s}
.user-switch button.active{background:#ccff00;color:#000;box-shadow:0 2px 10px rgba(204,255,0,0.2)}
.date-nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;background:#000;border:1px solid #333;border-radius:8px;padding:4px}
.nav-btn{background:transparent;border:none;color:#ccff00;padding:8px 20px;font-size:1.2rem;cursor:pointer}
#dateLabel{flex:1;text-align:center;color:#fff;font-weight:900;font-size:0.9rem;font-family:monospace}
.bio-btn{position:absolute;right:15px;top:15px;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid #333;padding:5px 10px;border-radius:6px;font-size:0.6rem;font-weight:bold;cursor:pointer}

/* HERO */
.hero{padding:20px 15px;display:flex;gap:15px;align-items:center}
.dual-score{display:flex;gap:12px;align-items:center}
.score-box{border:3px solid #333;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
.score-box.small{width:70px;height:70px;border-width:2px}
.score-box.primary{width:90px;height:90px;border-width:3px;background:radial-gradient(circle,rgba(204,255,0,0.05) 0%,transparent 70%);box-shadow:0 0 15px rgba(204,255,0,0.1)}
.score-val{font-size:1.4rem;font-weight:900;line-height:1}
.score-val.longevity{font-size:2rem;background:linear-gradient(135deg,#ccff00 0%,#00f0ff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.score-label{font-size:0.45rem;color:#666;text-transform:uppercase;margin-top:2px;font-weight:700}
.status{flex:1;border-left:3px solid #ccff00;padding-left:15px;font-size:0.7rem;font-weight:bold;line-height:1.3;color:#ccc}
.alert{margin:0 15px 20px;padding:12px;border-radius:8px;text-align:center;font-weight:bold;display:none;font-size:0.7rem;text-transform:uppercase;letter-spacing:1px}
.alert.show{display:block;animation:pulse 2s infinite}
.alert-warning{background:#FFD60A;color:#000}
.alert-protein{background:#00f0ff;color:#000}
.alert-love{background:linear-gradient(135deg, #e056fd 0%, #000000 100%); color:#fff; border:1px solid #e056fd; text-shadow:0 1px 2px rgba(0,0,0,0.5); line-height:1.6;}
@keyframes pulse{0%{opacity:1}50%{opacity:0.8}100%{opacity:1}}

/* SECTIONS & GRIDS */
.section-header{padding:10px 15px;font-size:0.55rem;font-weight:900;color:#666;letter-spacing:1px;text-transform:uppercase;margin-top:10px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:0 15px;margin-bottom:20px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;padding:0 15px;margin-bottom:20px}

/* ORBS & HEARTS */
.orb-card{background:#0a0a0a;border:1px solid #222;border-radius:12px;padding:12px 5px;display:flex;flex-direction:column;align-items:center}
.orb-container{width:50px;height:50px;position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.orb-svg{transform:rotate(-90deg);width:100%;height:100%}
.orb-bg{fill:none;stroke:#222;stroke-width:4}
.orb-fg{fill:none;stroke-width:4;stroke-dasharray:145;stroke-dashoffset:145;transition:stroke-dashoffset 1s ease;stroke-linecap:round}
.heart-svg { width: 100%; height: 100%; overflow: visible; }
.heart-bg { fill: none; stroke: #222; stroke-width: 2; }
.heart-fg { fill: none; stroke-width: 2; stroke-dasharray: 100; stroke-dashoffset: 100; transition: stroke-dashoffset 1s ease; }
.beating { animation: heartbeat 1.5s infinite; transform-origin: center; }
@keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } }
.orb-val-box{position:absolute;text-align:center}
.orb-val{font-family:monospace;font-size:0.7rem;font-weight:900;color:#fff}
.orb-label{font-size:0.45rem;font-weight:700;color:#666;text-transform:uppercase;letter-spacing:1px}

/* RAINBOW */
.rainbow-container{padding:0 15px;margin-bottom:20px}
.rainbow-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.rainbow-title{font-size:0.6rem;font-weight:900;color:#fff;letter-spacing:1px}
.rainbow-score{font-size:0.75rem;font-weight:900;color:#ccff00;font-family:monospace}
.rainbow-track{height:8px;background:#111;border-radius:4px;display:flex;overflow:hidden;border:1px solid #222}
.rainbow-seg{height:100%;width:0%;transition:width 0.5s ease}
.rainbow-meta{font-size:0.55rem;color:#666;margin-top:6px;line-height:1.3}
.rainbow-suggestion{font-size:0.6rem;color:#ccff00;margin-top:8px;font-weight:700;padding:8px;background:rgba(204,255,0,0.05);border-radius:6px;border:1px solid rgba(204,255,0,0.2)}

/* TIMELINE */
.timeline{padding:0 15px;margin-bottom:40px}
.task{display:flex;gap:10px;margin-bottom:15px;min-height:60px}
.task-time{width:45px;color:#666;font-size:0.7rem;padding-top:12px;text-align:right;font-family:monospace;font-weight:bold}
.task-card{flex:1;background:#0a0a0a;border:1px solid #333;border-radius:12px;padding:12px 15px;position:relative;transition:all 0.2s; display:flex; justify-content:space-between; align-items:center;}
.task-card.checked{border-color:#ccff00;background:rgba(204,255,0,0.05)}
.task-card.clickable:active{transform:scale(0.98);background:#222}
.task-card.auto-detected{border-color:#00f0ff;background:rgba(0,240,255,0.05); opacity:0.9;}

.task-info { flex:1; }
.task-title{font-weight:900;font-size:0.8rem;margin-bottom:4px;color:#fff}
.task-desc{font-size:0.65rem;color:#888;line-height:1.4}
.workout-badge{display:inline-block;background:#00f0ff;color:#000;padding:2px 6px;border-radius:4px;font-size:0.5rem;font-weight:900;margin-left:5px; vertical-align:middle;}
.chevron { font-size:1.2rem; color:#666; margin-left:15px; font-weight:900; }

.check-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-left:10px;}
.check-circle{width:24px;height:24px;border:2px solid #666;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:0.9rem;transition:all 0.2s}
.task-card.checked .check-circle{background:#ccff00;border-color:#ccff00;color:#000}

/* MODALS */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:500;display:none;overflow-y:auto}
.modal-overlay.show{display:block}
.modal-content{width:90%;max-width:500px;margin:60px auto;background:#111;border-radius:16px;border:2px solid #ccff00}
.modal-header{padding:15px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;background:#000;border-radius:14px 14px 0 0}
.modal-title{font-size:0.9rem;font-weight:900;color:#ccff00;text-transform:uppercase;letter-spacing:1px}
.modal-close{background:transparent;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1}
.modal-body{padding:15px;max-height:70vh;overflow-y:auto}
/* BIO FORM STYLES */
.bio-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}
.bio-group label{display:block;color:#888;font-size:0.6rem;margin-bottom:4px;text-transform:uppercase;font-weight:700}
.bio-input{width:100%;background:#000;border:1px solid #333;color:#fff;padding:10px;border-radius:6px;font-family:monospace;font-size:0.9rem}
.bio-input:focus{border-color:#ccff00;outline:none}
.save-btn{width:100%;background:#ccff00;color:#000;border:none;padding:12px;border-radius:8px;font-weight:900;font-size:0.9rem;margin-top:10px;cursor:pointer}
/* MEAL OPTION STYLES */
.meal-option{background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:15px;margin-bottom:12px;cursor:pointer}
.meal-option:active{transform:scale(0.98);background:#222;border-color:#ccff00}
.meal-name{font-size:0.8rem;font-weight:900;color:#fff;margin-bottom:6px}
.meal-macros{font-size:0.6rem;color:#ccc;margin-bottom:6px;font-family:monospace}
.meal-colors{font-size:0.55rem;color:#888}
.color-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}
.abs-alert{background:rgba(255,165,0,0.15);border:1px solid #ff9f0a;padding:10px;border-radius:8px;margin-bottom:15px;font-size:0.7rem;color:#ccc;line-height:1.4}
.abs-boost{background:rgba(48,209,88,0.15);border:1px solid #30d158;padding:10px;border-radius:8px;margin-bottom:15px;font-size:0.7rem;color:#ccc;line-height:1.4}

/* FOOTER */
.footer{position:fixed;bottom:0;left:0;width:100%;background:#000;padding:12px 15px;border-top:1px solid #333;display:flex;justify-content:space-between;align-items:center;z-index:100}
.sync-status{font-size:0.6rem;color:#666;font-family:monospace}
.sync-btn{background:#ccff00;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:900;font-size:0.75rem}
</style>
</head>
<body>

<div class="header">
    <div class="user-switch">
        <button id="btn-jermaine" class="active" onclick="if(window.app)app.switchUser('jermaine')">JERMAINE</button>
        <button id="btn-sophia" onclick="if(window.app)app.switchUser('sophia')">SOPHIA</button>
    </div>
    <div class="date-nav">
        <button class="nav-btn" onclick="if(window.app)app.changeDate(-1)">‚óÄ</button>
        <span id="dateLabel">LOADING...</span>
        <button class="nav-btn" onclick="if(window.app)app.changeDate(1)">‚ñ∂</button>
    </div>
    <button class="bio-btn" onclick="if(window.app)app.openBio()">BIO</button>
</div>

<div id="alertBanner" class="alert"></div>

<div class="hero">
    <div class="dual-score">
        <div class="score-box small">
            <div class="score-val" id="dayGrade">--</div>
            <div class="score-label">TODAY</div>
        </div>
        <div class="score-box primary">
            <div class="score-val longevity" id="longevityScore">--</div>
            <div class="score-label">LONGEVITY</div>
            <div class="score-max">/120</div>
        </div>
    </div>
    <div class="status" id="statusMsg">INITIALIZING...</div>
</div>

<div class="section-header">SLEEP ARCHITECTURE</div>
<div class="grid-3">
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="sleepOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="sleepVal">--</div></div></div><div class="orb-label">TOTAL</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="deepOrb" cx="25" cy="25" r="21" style="stroke:#007aff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="deepVal">--</div></div></div><div class="orb-label">DEEP</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="remOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="remVal">--</div></div></div><div class="orb-label">REM</div></div>
</div>

<div class="section-header">FUEL (NUTRITION)</div>
<div class="grid-4">
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="proteinOrb" cx="25" cy="25" r="21" style="stroke:#fff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="proteinVal">0</div></div></div><div class="orb-label">PROTEIN</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="omega3Orb" cx="25" cy="25" r="21" style="stroke:#00d4ff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="omega3Val">0</div></div></div><div class="orb-label">OMEGA-3</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="fiberOrb" cx="25" cy="25" r="21" style="stroke:#30d158"></circle></svg><div class="orb-val-box"><div class="orb-val" id="fiberVal">0</div></div></div><div class="orb-label">FIBER</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="calorieOrb" cx="25" cy="25" r="21" style="stroke:#FFD60A"></circle></svg><div class="orb-val-box"><div class="orb-val" id="calorieVal">0</div></div></div><div class="orb-label">CALORIES</div></div>
</div>

<div class="section-header">ENGINE (CARDIO)</div>
<div class="grid-4">
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg beating" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#ff453a; fill:rgba(255,69,58,0.2);"></path></svg><div class="orb-val-box"><div class="orb-val" id="rhrVal">--</div></div></div>
        <div class="orb-label">RHR</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="z2Heart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#00f0ff"></path></svg><div class="orb-val-box"><div class="orb-val" id="z2Val">0</div></div></div>
        <div class="orb-label">ZONE 2</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="z5Heart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#ff453a"></path></svg><div class="orb-val-box"><div class="orb-val" id="z5Val">0</div></div></div>
        <div class="orb-label">ZONE 5</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="calHeart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#FFD60A"></path></svg><div class="orb-val-box"><div class="orb-val" id="calVal">0</div></div></div>
        <div class="orb-label">BURN</div>
    </div>
</div>

<div class="section-header">PHYTONUTRIENT DIVERSITY üåà</div>
<div class="rainbow-container">
    <div class="rainbow-header"><div class="rainbow-title">RAINBOW SCORE</div><div class="rainbow-score" id="rainbowScore">0%</div></div>
    <div class="rainbow-track" id="rainbowTrack"></div>
    <div id="rainbowSuggestion" class="rainbow-suggestion" style="display:none"></div>
</div>

<div class="section-header">SYNERGY PROTOCOL üîÑ AUTO-DETECT</div>
<div class="timeline" id="timeline"></div>

<div class="modal-overlay" id="mainModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">TITLE</div>
            <button class="modal-close" onclick="app.closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<div class="footer">
    <span class="sync-status" id="syncStatus">INIT</span>
    <button class="sync-btn" onclick="if(window.app)app.sync()">üîÑ SYNC</button>
</div>

<script>
// --- CONFIGURATION ---
const USERS = {
    jermaine: {
        name: "Jermaine",
        dob: "1983-01-13",
        goals: { protein: 172, omega3: 12000, fiber: 50, water: 140, weightTarget: 210, heightInches: 70, z2: 45, z5: 20, calBurn: 500 },
        defaultBios: { bmr: '2057', apob: '114', lpa: '178', weight: '217.1', hscrp: '0.4', hba1c: '5.4' }
    },
    sophia: {
        name: "Sophia",
        dob: "1987-01-25",
        goals: { protein: 130, omega3: 4000, fiber: 35, water: 100, weightTarget: 140, heightInches: 64, z2: 30, z5: 15, calBurn: 350 },
        defaultBios: { bmr: '1450', apob: '70', lpa: '20', weight: '148', hscrp: '0.5', hba1c: '5.2' }
    }
};

// GLOBAL RECIPE DATABASE - CLEANED
const MEAL_DATABASE = {
    breakfast: [
        {title:"Omega Breakfast",time:"15min",servings:1,macros:{p:58,o:3500,poly:220,f:12,cal:680},ingredients:["salmon","kale","berries","walnuts","avocado"],colors:['orange','purple','green']},
        {title:"Sophia's Sea Moss Oatmeal ‚≠ê",time:"10min",servings:1,macros:{p:48,o:8200,poly:240,f:18,cal:580},ingredients:["oats","pea protein","sea moss","flaxseed","berries"],colors:['purple','white']},
        {title:"PB Sea Moss Power Shake",time:"5min",servings:1,macros:{p:54,o:7200,poly:200,f:16,cal:680},ingredients:["pea protein","sea moss","flaxseed","peanut butter","spinach"],colors:['green','white']},
        {title:"Smoked Trout Hash",time:"18min",servings:1,macros:{p:54,o:3200,poly:190,f:16,cal:640},ingredients:["trout","eggs","sweet potato","brussels sprouts"],colors:['orange','green']},
        {title:"Mackerel Scramble",time:"12min",servings:1,macros:{p:56,o:4800,poly:200,f:10,cal:660},ingredients:["mackerel","eggs","arugula","turmeric"],colors:['yellow','green']},
        {title:"Smoked Salmon Avocado Toast ‚≠ê",time:"12min",servings:1,macros:{p:54,o:3400,poly:200,f:14,cal:680},ingredients:["smoked salmon","sprouted grain bread","avocado","eggs"],colors:['orange','green']},
        {title:"Flax Protein Parfait",time:"5min",servings:1,macros:{p:48,o:8600,poly:240,f:18,cal:580},ingredients:["pea protein","flaxseed","greek yogurt","berries"],colors:['white','purple']},
        {title:"Tofu Scramble Supreme",time:"12min",servings:1,macros:{p:44,o:2800,poly:200,f:10,cal:580},ingredients:["tofu","spinach","mushrooms","turmeric"],colors:['yellow','green','white']},
        {title:"Protein Pancakes",time:"15min",servings:1,macros:{p:52,o:6400,poly:180,f:14,cal:620},ingredients:["pea protein","flaxseed","oats","berries"],colors:['purple','white']}
    ],
    lunch: [
        {title:"Ahi Poke Bowl (Classic)",time:"15min",servings:1,macros:{p:45,o:1200,poly:200,f:8,cal:520},ingredients:["ahi tuna","brown rice","cucumber","mango","seaweed"],colors:['red','green','yellow']},
        {title:"Salmon Pesto Pasta",time:"20min",servings:1,macros:{p:56,o:4200,poly:280,f:12,cal:740},ingredients:["salmon","chickpea pasta","basil pesto","tomatoes"],colors:['pink','green','red']},
        {title:"Wild Salmon Poke Bowl ‚≠ê",time:"15min",servings:1,macros:{p:56,o:5200,poly:240,f:18,cal:720},ingredients:["salmon","brown rice","edamame","seaweed"],colors:['orange','green']},
        {title:"Chipotle Bowl (Bison) ‚≠ê",time:"18min",servings:1,macros:{p:58,o:2800,poly:200,f:20,cal:740},ingredients:["bison","brown rice","black beans","peppers","guacamole"],colors:['brown','black','green','red']},
        {title:"Chipotle Bowl (Tofu) ‚≠ê",time:"20min",servings:1,macros:{p:46,o:3200,poly:220,f:22,cal:680},ingredients:["tofu","brown rice","black beans","peppers"],colors:['white','black','green']},
        {title:"Mediterranean Quinoa Salad",time:"15min",servings:1,macros:{p:22,o:1200,poly:350,f:14,cal:580},ingredients:["quinoa","cucumber","tomatoes","olives","feta"],colors:['white','green','red','black']},
        {title:"Lentil Soup with Kale",time:"30min",servings:2,macros:{p:24,o:800,poly:280,f:18,cal:450},ingredients:["lentils","kale","carrots","celery"],colors:['brown','green','orange']},
        {title:"Turkey Burger & Sweet Potato",time:"20min",servings:1,macros:{p:38,o:300,poly:150,f:8,cal:580},ingredients:["turkey","sweet potato","lettuce","tomato"],colors:['white','orange','green']}
    ],
    dinner: [
        {title:"Seafood Cioppino ‚≠ê",time:"40min",servings:2,macros:{p:42,o:1800,poly:320,f:8,cal:480},ingredients:["white fish","mussels","shrimp","tomatoes","fennel"],colors:['white','red','green']},
        {title:"Herb Crusted Cod",time:"20min",servings:1,macros:{p:52,o:2800,poly:150,f:10,cal:580},ingredients:["cod","almond flour","herbs","asparagus"],colors:['white','green']},
        {title:"Grass-Fed Steak & Sprouts",time:"25min",servings:1,macros:{p:60,o:1200,poly:180,f:14,cal:720},ingredients:["steak","brussels sprouts","sweet potato","garlic"],colors:['red','green','orange']},
        {title:"Mediterranean Chicken",time:"25min",servings:1,macros:{p:55,o:800,poly:240,f:12,cal:640},ingredients:["chicken","quinoa","olives","feta"],colors:['white','black','red']},
        {title:"Tempeh Stir Fry (Plant)",time:"15min",servings:1,macros:{p:42,o:2200,poly:190,f:18,cal:580},ingredients:["tempeh","broccoli","peppers","ginger"],colors:['brown','green','red']},
        {title:"Sheet Pan Salmon & Veggies",time:"20min",servings:1,macros:{p:45,o:3200,poly:200,f:10,cal:620},ingredients:["salmon","broccoli","peppers","lemon"],colors:['orange','green','red']},
        {title:"Shrimp Scampi with Zoodles",time:"15min",servings:1,macros:{p:30,o:600,poly:120,f:6,cal:420},ingredients:["shrimp","zucchini","garlic","lemon"],colors:['pink','green','white']},
        {title:"Lamb Kofta Bowl",time:"25min",servings:1,macros:{p:40,o:900,poly:180,f:10,cal:680},ingredients:["lamb","cucumber","yogurt","tomatoes"],colors:['brown','green','white','red']}
    ],
    juices: [
        {title:"The Red Pipe Clearer",macros:{p:2,o:0,f:1,cal:110},ingredients:["beets","carrots","ginger","lemon"],colors:['red','orange']},
        {title:"The ANA Green Soother",macros:{p:2,o:0,f:1,cal:90},ingredients:["celery","cucumber","turmeric","ginger"],colors:['green','yellow']},
        {title:"Longevity Gold Elixir",macros:{p:1,o:0,f:0,cal:60},ingredients:["oranges","sea moss","turmeric"],colors:['orange','yellow']}
    ],
    snack: [
        {title:"Savory Pulp Crackers",macros:{p:6,o:1200,f:12,cal:140},ingredients:["veggie pulp","flaxseed","chia seeds"],colors:['brown']},
        {title:"Dark Chocolate Oatmeal Balls",macros:{p:10,o:300,f:5,cal:210},ingredients:["oats","dark chocolate","almond butter"],colors:['brown']},
        {title:"Omega Nut Mix",macros:{p:6,o:2500,f:4,cal:180},ingredients:["walnuts","brazil nuts","almonds"],colors:['brown']}
    ]
};

const BASE_PROTOCOL = [
    { id: 'sunrise', time: '06:00', title: 'Morning Walk', desc: '15min walk + cold shower', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 60 },
    { id: 'breakfast', time: '07:30', title: 'Breakfast', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'breakfast' },
    { id: 'juice', time: '08:30', title: 'Fresh Juice/Elixir', desc: 'Tap to select juice', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'juices' },
    { id: 'train', time: '09:00', title: 'Training', desc: 'Auto-detected from Oura', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: false, autoDetect: true },
    { id: 'lunch', time: '13:00', title: 'Lunch', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'lunch' },
    { id: 'snack', time: '15:30', title: 'Longevity Snack', desc: 'Tap to select snack', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'snack' },
    { id: 'dinner', time: '18:30', title: 'Dinner', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'dinner' },
    { id: 'evening', time: '21:00', title: 'Wind Down', desc: 'Chamomile tea + stretch', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: ['purple'], calBurn: 0 }
];

const TOKENS = { jermaine: 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', sophia: '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };

const LONGEVITY_MARKERS = {
    apob: { weight: 15, optimal: 80, threshold: 130, direction: 'lower' },
    lpa: { weight: 15, optimal: 30, threshold: 150, direction: 'lower' },
    rhr: { weight: 10, optimal: 50, threshold: 75, direction: 'lower' },
    sleepScore: { weight: 10, optimal: 85, threshold: 60, direction: 'higher' }
};

const RAINBOW_COLORS = {
    red: { hex: '#ff453a', examples: 'Tomatoes, Beets' },
    orange: { hex: '#ff9f0a', examples: 'Carrots, Salmon' },
    yellow: { hex: '#ffd60a', examples: 'Lemon, Turmeric' },
    green: { hex: '#30d158', examples: 'Kale, Spinach' },
    purple: { hex: '#bf5af2', examples: 'Blueberries' },
    white: { hex: '#fff', examples: 'Garlic, Onion' },
    brown: { hex: '#A0522D', examples: 'Nuts, Seeds' },
    pink: { hex: '#FF69B4', examples: 'Shrimp, Salmon' },
    black: { hex: '#333', examples: 'Olives, Beans' }
};

const ABSORPTION_RULES = {
    blockers: {
        calcium_iron: { warning: "Calcium blocks iron absorption", check: (ing) => (ing.includes('salmon') && ing.includes('yogurt')) },
        phytates: { warning: "Phytates block mineral uptake", check: (ing) => (ing.includes('oats') || ing.includes('beans')) }
    },
    boosters: {
        vitc_iron: { boost: "Vit C boosts Iron 3x", check: (ing) => (ing.includes('spinach') && ing.includes('citrus')) },
        fat_omega: { boost: "Fat helps Omega-3 absorb", check: (ing) => (ing.includes('salmon') && ing.includes('avocado')) }
    }
};

const WORKOUT_TYPES = { strength_training: 'Strength', cycling: 'Cycling', running: 'Running', walking: 'Walking', swimming: 'Swim', other: 'Workout' };

// --- APP CLASS ---
class CenturionApp {
    constructor() {
        console.log('üöÄ Init v17.17 CLEAN-UI');
        
        // SELF-HEALING
        const CURRENT_VER = '17.17.0';
        const savedVer = localStorage.getItem('centurion_version');
        if(savedVer !== CURRENT_VER) {
             localStorage.clear();
             localStorage.setItem('centurion_version', CURRENT_VER);
        }

        this.user = localStorage.getItem('centurion_user') || 'jermaine';
        this.history = [];
        this.currentIndex = 0;
        this.currentDateStr = new Date().toLocaleDateString('en-CA');
        this.checked = {};
        this.meals = {};
        this.bios = {};
        this.protocol = [];
        
        this.loadUserData();
        this.setPlaceholderData();
        this.render();
        this.fetchOuraData();
    }

    loadUserData() {
        try {
            const savedChecked = localStorage.getItem(`c_checked_${this.user}`);
            this.checked = savedChecked ? JSON.parse(savedChecked) : {};
            
            const savedMeals = localStorage.getItem(`c_meals_${this.user}`);
            this.meals = savedMeals ? JSON.parse(savedMeals) : {};
            
            const savedBios = localStorage.getItem(`c_bios_${this.user}`);
            this.bios = savedBios ? JSON.parse(savedBios) : USERS[this.user].defaultBios;
        } catch(e) {
            console.error('Data corrupt, resetting user data');
            this.checked = {};
            this.meals = {};
        }
    }

    saveUserData() {
        localStorage.setItem(`c_checked_${this.user}`, JSON.stringify(this.checked));
        localStorage.setItem(`c_meals_${this.user}`, JSON.stringify(this.meals));
        localStorage.setItem(`c_bios_${this.user}`, JSON.stringify(this.bios));
    }

    setPlaceholderData() {
        this.history = [{
            date: this.currentDateStr,
            score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0,
            workouts: []
        }];
        this.currentIndex = 0;
    }

    async fetchOuraData() {
        this.setText('syncStatus', 'SYNCING...');
        
        try {
            const end = new Date();
            end.setDate(end.getDate() + 1);
            const start = new Date();
            start.setDate(start.getDate() - 10);
            
            const startStr = start.toISOString().split('T')[0];
            const endStr = end.toISOString().split('T')[0];
            const token = TOKENS[this.user];

            const sleepUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${endStr}`)}`;
            const workoutUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/workout?start_date=${startStr}&end_date=${endStr}`)}`;
            const activityUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?start_date=${startStr}&end_date=${endStr}`)}`;
            const readinessUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${startStr}&end_date=${endStr}`)}`;

            const [sleepRes, workoutRes, activityRes, readinessRes] = await Promise.all([
                fetch(sleepUrl, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(workoutUrl, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(activityUrl, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(readinessUrl, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            if (!sleepRes.ok || !workoutRes.ok || !activityRes.ok) throw new Error('API failed');

            const sleepData = await sleepRes.json();
            const workoutData = await workoutRes.json();
            const activityData = await activityRes.json();
            const readinessData = await readinessRes.json();

            this.processData(sleepData.data || [], workoutData.data || [], activityData.data || [], readinessData.data || []);
            
            this.setText('syncStatus', 'SYNCED ‚úì');
            this.render();
            
        } catch (error) {
            console.error('Sync failed: ' + error);
            this.setText('syncStatus', 'OFFLINE');
            this.render();
        }
    }

    processData(sleepData, workoutData, activityData, readinessData) {
        const dataMap = new Map();
        
        const getDay = (date) => {
            if(!dataMap.has(date)) {
                dataMap.set(date, {
                    date: date,
                    score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', 
                    cal: 0, high: 0, med: 0,
                    workouts: []
                });
            }
            return dataMap.get(date);
        };

        sleepData.forEach(session => {
            const day = getDay(session.day);
            day.totalSec += session.total_sleep_duration || 0;
            day.deepSec += session.deep_sleep_duration || 0;
            day.remSec += session.rem_sleep_duration || 0;
            if (session.score && session.score > day.score) day.score = session.score;
        });
        
        readinessData.forEach(readiness => {
             const day = getDay(readiness.day);
             if (readiness.contributors?.resting_heart_rate) {
                 day.rhr = readiness.contributors.resting_heart_rate;
             }
        });
        
        workoutData.forEach(workout => {
            const day = getDay(workout.day);
            const startTime = new Date(workout.start_datetime);
            const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: false });
            day.workouts.push({
                type: workout.activity || 'other',
                intensity: workout.intensity || 'moderate',
                calories: workout.calories || 300,
                time: timeStr,
                start: workout.start_datetime
            });
        });
        
        activityData.forEach(act => {
            const day = getDay(act.day);
            day.cal = act.active_calories || 0;
            day.high = (act.high_activity_time || 0) / 60;
            day.med = (act.medium_activity_time || 0) / 60;
        });
        
        this.history = Array.from(dataMap.values()).sort((a, b) => b.date.localeCompare(a.date));
        
        this.currentIndex = this.history.findIndex(h => h.date === this.currentDateStr);
        if (this.currentIndex === -1) {
            this.history.unshift({
                date: this.currentDateStr,
                score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: []
            });
            this.currentIndex = 0;
        }
    }

    changeDate(direction) {
        const newIndex = this.currentIndex - direction;
        if (newIndex >= 0 && newIndex < this.history.length) {
            this.currentIndex = newIndex;
            this.currentDateStr = this.history[newIndex].date;
            this.render();
        }
    }

    switchUser(newUser) {
        if (newUser === this.user) return;
        document.querySelectorAll('.user-switch button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${newUser}`).classList.add('active');
        this.user = newUser;
        localStorage.setItem('centurion_user', newUser);
        this.history = []; 
        this.loadUserData(); 
        this.setPlaceholderData(); 
        this.render(); 
        this.fetchOuraData(); 
    }

    toggleTask(taskId) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.checked[dateKey]) this.checked[dateKey] = [];
        const index = this.checked[dateKey].indexOf(taskId);
        if (index === -1) this.checked[dateKey].push(taskId);
        else this.checked[dateKey].splice(index, 1);
        this.saveUserData();
        this.render();
    }

    // --- MODAL & LOGIC ---

    openBio() {
        const modalBody = document.getElementById('modalBody');
        this.setText('modalTitle', 'BIOMETRICS');
        let html = '';
        const fields = ['apob', 'lpa', 'ldl', 'hscrp', 'glucose', 'hba1c', 'weight', 'bmr'];
        fields.forEach(f => {
            html += `<div class="bio-row"><div class="bio-col"><label>${f.toUpperCase()}</label><input class="bio-input" id="bio-${f}" type="number" value="${this.bios[f] || ''}"></div></div>`;
        });
        html += `<button class="save-btn" onclick="app.saveBio()">SAVE BIOMETRICS</button>`;
        modalBody.innerHTML = html;
        document.getElementById('mainModal').classList.add('show');
    }

    saveBio() {
        const fields = ['apob', 'lpa', 'ldl', 'hscrp', 'glucose', 'hba1c', 'weight', 'bmr'];
        fields.forEach(f => {
            const el = document.getElementById(`bio-${f}`);
            if(el) this.bios[f] = el.value;
        });
        this.saveUserData();
        this.closeModal();
        this.render();
    }

    openMealPicker(mealSlot) {
        const modalBody = document.getElementById('modalBody');
        const slotName = mealSlot.charAt(0).toUpperCase() + mealSlot.slice(1);
        this.setText('modalTitle', 'SELECT ' + slotName.toUpperCase());
        const meals = MEAL_DATABASE[mealSlot] || [];
        let html = '';
        meals.forEach((meal, index) => {
            const title = meal.title || meal.name || "Unknown Meal";
            const colorDots = (meal.colors || []).map(c => {
                const hex = RAINBOW_COLORS[c] ? RAINBOW_COLORS[c].hex : '#999';
                return `<span class="color-dot" style="background:${hex}"></span>`;
            }).join('');
            
            let alerts = '';
            const ingString = (meal.ingredients || []).join(' ');
            if(ABSORPTION_RULES.blockers.calcium_iron.check(ingString)) alerts += `<div class="abs-alert">‚ö†Ô∏è ${ABSORPTION_RULES.blockers.calcium_iron.warning}</div>`;
            if(ABSORPTION_RULES.boosters.fat_omega.check(ingString)) alerts += `<div class="abs-boost">‚úÖ ${ABSORPTION_RULES.boosters.fat_omega.boost}</div>`;

            html += `<div class="meal-option" onclick="app.selectMeal('${mealSlot}', ${index})">
                <div class="meal-name">${title}</div>
                <div class="meal-macros">P:${meal.macros.p}g Œ©3:${meal.macros.o}mg Fib:${meal.macros.f||0}g Cal:${meal.macros.cal}</div>
                <div class="meal-colors">${colorDots}</div>
                ${alerts}
            </div>`;
        });
        modalBody.innerHTML = html;
        document.getElementById('mainModal').classList.add('show');
    }

    closeModal() { document.getElementById('mainModal').classList.remove('show'); }

    selectMeal(mealSlot, mealIndex) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.meals[dateKey]) this.meals[dateKey] = {};
        this.meals[dateKey][mealSlot] = mealIndex;
        this.saveUserData();
        this.closeModal();
        this.render();
    }

    // --- CALCULATORS ---
    calculateSleepDebt() {
        const today = new Date().toLocaleDateString('en-CA');
        const last7Days = this.history.filter(day => day.date !== today && day.totalSec > 0).slice(0, 7);
        if (last7Days.length === 0) return 0;
        let totalDebt = 0;
        last7Days.forEach(day => {
            const actual = day.totalSec / 3600;
            const deficit = 8 - actual;
            if (deficit > 0) totalDebt += deficit;
        });
        return totalDebt;
    }

    calculateMacros() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let totals = { protein: 0, omega3: 0, fiber: 0, calories: 0, burn: 0 };
        this.protocol.forEach(task => {
            if (checked.includes(task.id)) {
                totals.protein += task.macros.p || 0;
                totals.omega3 += task.macros.o || 0;
                totals.fiber += task.macros.f || 0;
                totals.calories += task.macros.cal || 0;
                totals.burn += task.calBurn || 0;
            }
        });
        return totals;
    }

    calculateRainbow() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let colors = new Set();
        this.protocol.forEach(task => {
            if (checked.includes(task.id) && task.colors) {
                task.colors.forEach(c => colors.add(c));
            }
        });
        return colors;
    }

    calculateGrade(score) {
        if(score >= 95) return { letter: 'S+', color: '#00ff00' };
        if(score >= 90) return { letter: 'S', color: '#ccff00' };
        if(score >= 85) return { letter: 'A+', color: '#00f0ff' };
        if(score >= 80) return { letter: 'A', color: '#00d4ff' };
        if(score >= 70) return { letter: 'B', color: '#FFD60A' };
        return { letter: 'C', color: '#ff453a' };
    }

    // --- RENDER ---
    renderGrade(score) {
        const grade = this.calculateGrade(score);
        this.setText('dayGrade', grade.letter);
        const el = document.getElementById('dayGrade');
        if(el) el.style.color = grade.color;
    }

    render() {
        try {
            if (!this.history || this.history.length === 0) return;
            
            // Clone Base Protocol
            this.protocol = JSON.parse(JSON.stringify(BASE_PROTOCOL));
            const dateKey = this.history[this.currentIndex].date;
            const day = this.history[this.currentIndex];
            const goals = USERS[this.user].goals;

            // 1. Hydrate Meals
            let selectedMeals = this.meals[dateKey] || {};
            this.protocol.forEach(task => {
                if (task.mealSlot && selectedMeals[task.mealSlot] !== undefined) {
                    const dbSlot = MEAL_DATABASE[task.mealSlot];
                    if(dbSlot && dbSlot[selectedMeals[task.mealSlot]]) {
                         const meal = dbSlot[selectedMeals[task.mealSlot]];
                         const mealTitle = meal.title || meal.name || 'Meal'; 
                         task.title = mealTitle;
                         task.desc = `P:${meal.macros.p} F:${meal.macros.f||0} Œ©3:${meal.macros.o}`;
                         task.macros = meal.macros;
                         task.colors = meal.colors;
                    } else {
                         task.desc = "Select meal";
                    }
                }
            });
            
            // 2. CHRONOS: Dynamic Workout Injection
            if (day.workouts && day.workouts.length > 0) {
                this.protocol = this.protocol.filter(t => t.id !== 'train');
                day.workouts.forEach((w, i) => {
                    const dateObj = new Date(w.start);
                    const displayTime = dateObj.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit'});
                    this.protocol.push({
                        id: `workout-${i}`,
                        time: w.time, 
                        displayTime: displayTime,
                        title: `${WORKOUT_TYPES[w.type] || 'Workout'} üîÑ`,
                        desc: `${w.calories} cal ‚Ä¢ Auto-detected`,
                        macros: {p:0,o:0,f:0,cal:0},
                        colors: [],
                        calBurn: w.calories,
                        autoDetected: true
                    });
                    const checked = this.checked[dateKey] || [];
                    if (!checked.includes(`workout-${i}`)) {
                        checked.push(`workout-${i}`);
                        this.checked[dateKey] = checked;
                    }
                });
                this.protocol.sort((a, b) => a.time.localeCompare(b.time));
                this.saveUserData();
            }

            // 2. Scores
            const sleepHours = (day.totalSec || 0) / 3600;
            const dayScore = Math.min(100, Math.round((sleepHours / 8) * 100));
            this.renderGrade(dayScore); 
            this.setText('dateLabel', day.date);
            
            // 3. Orbs & Hearts
            const macros = this.calculateMacros();
            const bmr = parseInt(this.bios.bmr) || 2057;
            const totalBurn = bmr + macros.burn;
            
            const updateOrb = (id, val, goal) => {
                const el = document.getElementById(id);
                if(el) {
                   const pct = Math.min(val/goal, 1);
                   el.style.strokeDashoffset = 145 - (pct * 145);
                   el.style.stroke = pct >= 1 ? '#30d158' : '#fff';
                }
            };
            const updateHeart = (id, val, goal) => {
                 const el = document.getElementById(id);
                 if(el) el.style.strokeDashoffset = 100 - (Math.min(val/goal, 1) * 100);
            };

            // SLEEP
            this.setText('sleepVal', `${Math.floor(sleepHours)}h ${Math.round((day.totalSec%3600)/60)}m`);
            this.setText('deepVal', `${Math.round((day.deepSec||0)/60)}m`);
            this.setText('remVal', `${Math.round((day.remSec||0)/60)}m`);
            updateOrb('sleepOrb', sleepHours, 8);
            updateOrb('deepOrb', (day.deepSec||0)/60, 90);
            updateOrb('remOrb', (day.remSec||0)/60, 90);

            // FUEL
            this.setText('proteinVal', macros.protein); updateOrb('proteinOrb', macros.protein, goals.protein);
            this.setText('omega3Val', Math.round(macros.omega3/1000)+'g'); updateOrb('omega3Orb', macros.omega3, goals.omega3);
            this.setText('fiberVal', macros.fiber); updateOrb('fiberOrb', macros.fiber, goals.fiber);
            this.setText('calorieVal', macros.calories); updateOrb('calorieOrb', macros.calories, 2500);

            // CARDIO
            this.setText('rhrVal', day.rhr); 
            this.setText('z2Val', Math.round(day.med||0)); updateHeart('z2Heart', day.med||0, goals.z2||45);
            this.setText('z5Val', Math.round(day.high||0)); updateHeart('z5Heart', day.high||0, goals.z5||20);
            this.setText('calVal', Math.round(day.cal||0)); updateHeart('calHeart', day.cal||0, goals.calBurn||500);

            // BIRTHDAY CHECK
            const userDob = USERS[this.user].dob;
            if(userDob) {
                const [y, m, d] = userDob.split('-').map(Number);
                const today = new Date();
                if(today.getMonth()+1 === m && today.getDate() === d) {
                     const age = today.getFullYear() - y;
                     const banner = document.getElementById('alertBanner');
                     if (this.user === 'sophia' && m === 1 && d === 25) {
                         banner.className = 'alert alert-love show';
                         banner.innerHTML = `üéÇ <strong>HAPPY BIRTHDAY SOPHIA!</strong> üéâ<br><br>I love you so much. You inspire me every single day.<br>Let's crush 39 together. ‚ù§Ô∏è - Jermaine`;
                     } else {
                         banner.className = 'alert alert-protein show';
                         banner.innerText = `üéÇ HAPPY ${age}TH BIRTHDAY ${USERS[this.user].name.toUpperCase()}! üéâ`;
                     }
                     this.setText('statusMsg', 'CELEBRATION MODE üéÇ');
                } else {
                     this.renderStatus(sleepHours);
                }
            } else {
                 this.renderStatus(sleepHours);
            }
            
            // RAINBOW & TIMELINE
            this.renderRainbow();
            this.renderTimeline(dateKey);

        } catch (e) {
            console.error('Render Error: ' + e);
        }
    }

    renderRainbow() {
        const colors = this.calculateRainbow();
        const score = Math.round((colors.size / 6) * 100);
        this.setText('rainbowScore', score + '%');
        let html = '';
        ['red', 'orange', 'yellow', 'green', 'purple', 'white'].forEach(c => {
            const width = colors.has(c) ? 16.66 : 0;
            const hex = RAINBOW_COLORS[c] ? RAINBOW_COLORS[c].hex : '#999';
            html += `<div class="rainbow-seg" style="background:${hex}; width:${width}%"></div>`;
        });
        document.getElementById('rainbowTrack').innerHTML = html;
        const sugg = document.getElementById('rainbowSuggestion');
        if(colors.size < 6 && colors.size > 0) {
            const missing = ['red', 'orange', 'yellow', 'green', 'purple', 'white'].find(c => !colors.has(c));
            sugg.innerText = `Tip: Add ${missing.toUpperCase()} foods!`;
            sugg.style.display = 'block';
        } else {
            sugg.style.display = 'none';
        }
    }

    renderStatus(sleepHours) {
        const debt = this.calculateSleepDebt();
        const banner = document.getElementById('alertBanner');
        let status = '';
        
        if (debt > 7) {
            status = `‚ö†Ô∏è SLEEP DEBT: ${debt.toFixed(1)}h`;
            banner.className = 'alert alert-warning show';
            banner.innerText = "FORCED RECOVERY: Sleep Debt Critical";
        } else if (sleepHours >= 7) {
            status = "‚úÖ OPTIMAL READY";
            banner.className = 'alert';
        } else {
            status = "‚ö†Ô∏è CAUTION";
            banner.className = 'alert';
        }
        this.setText('statusMsg', status);
    }

    renderTimeline(dateKey) {
        const checked = this.checked[dateKey] || [];
        let html = '';
        this.protocol.forEach(task => {
            const isChecked = checked.includes(task.id);
            const clickAction = task.clickable ? `onclick="app.openMealPicker('${task.mealSlot}')"` : '';
            // Don't disable click for auto-detected if it's also a meal slot
            const cardClass = `task-card ${isChecked ? 'checked' : ''} ${task.clickable ? 'clickable' : ''} ${task.autoDetected ? 'auto-detected' : ''}`;
            
            // Add chevron only if clickable
            const chevron = task.clickable ? `<span class="chevron">‚Ä∫</span>` : '';
            
            // Use displayTime if available (dynamic), else task.time (static)
            const timeDisplay = task.displayTime || task.time;
            
            html += `<div class="task">
                <div class="task-time">${timeDisplay}</div>
                <div class="${cardClass}" ${clickAction}>
                    <div class="task-info">
                        <div class="task-title">${task.title} 
                            ${task.autoDetected ? '<span class="workout-badge">AUTO</span>' : ''}
                        </div>
                        <div class="task-desc">${task.desc}</div>
                    </div>
                    ${chevron}
                    ${!task.autoDetected ? `<div class="check-btn" onclick="event.stopPropagation(); app.toggleTask('${task.id}')">
                        <div class="check-circle">${isChecked ? '‚úì' : ''}</div>
                    </div>` : ''}
                </div>
            </div>`;
        });
        document.getElementById('timeline').innerHTML = html;
    }

    setText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
    sync() { this.fetchOuraData(); }
}

let app;
window.onload = () => { app = new CenturionApp(); window.app = app; };
</script>
</body>
</html>