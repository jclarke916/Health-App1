<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v2004.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --glass: rgba(30, 30, 32, 0.85);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
            --gold: #FFD60A;
            --green: #30D158;
            --blue: #0A84FF;
            --red: #FF453A;
            --purple: #BF5AF2;
            --orange: #FF9F0A;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px 16px; min-height: 100vh; background-image: radial-gradient(circle at top center, #1a1a1a 0%, #000000 60%); }
        .container { max-width: 480px; margin: 0 auto; padding-bottom: 60px; }
        h1 { text-align: center; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; font-size: 0.8rem; margin: 10px 0 20px 0; color: #666; }

        .badge-row { display: flex; justify-content: center; background: rgba(255, 255, 255, 0.05); padding: 4px; border-radius: 30px; margin: 0 auto 20px auto; width: fit-content; border: 1px solid var(--border); }
        .u-badge { padding: 8px 20px; border-radius: 24px; font-size: 0.7rem; font-weight: 700; cursor: pointer; color: var(--text-sub); transition: all 0.3s ease; }
        .u-badge.active { background: rgba(255, 255, 255, 0.15); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .status-bar { text-align: center; color: var(--text-sub); font-size: 0.65rem; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; }
        .controls { display: flex; gap: 8px; margin-bottom: 20px; }
        .nav-btn { background: var(--glass); border: 1px solid var(--border); color: var(--text-sub); padding: 12px; flex: 1; border-radius: 16px; font-size: 0.6rem; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        .nav-btn:active { transform: scale(0.98); }

        .tabs { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;}
        .tab { flex: 1; min-width: 45px; padding: 12px 0; background: transparent; color: #555; border-radius: 16px; font-size: 0.6rem; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: var(--glass); color: #fff; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        .premium-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .premium-card:active { transform: scale(0.99); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-sub); }
        .card-subtitle { font-size: 0.65rem; color: #555; margin-top: 3px; }
        .card-val-lg { font-size: 1.6rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }

        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.02); }
        .data-label { font-size: 0.65rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .data-val { font-size: 0.8rem; font-weight: 700; color: #fff; }

        .bio-section { margin-bottom: 15px; }
        .bar-label { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; margin-bottom: 8px; display: flex; justify-content: space-between; text-transform: uppercase; }
        .bar-track { height: 8px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 0.8s ease; }
        
        .section-header { margin: 25px 0 10px 0; font-size: 0.6rem; color: #666; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .chevron { font-size: 0.8rem; color: #444; transition: transform 0.3s ease; margin-left: 10px; }
        .premium-card.collapsed .card-body { display: none; }
        .premium-card.collapsed .chevron { transform: rotate(-90deg); }
        
        .science-box { margin-top: 15px; padding: 12px; background: rgba(255, 214, 10, 0.05); border-left: 2px solid var(--gold); border-radius: 4px; }
        .sci-label { font-size: 0.6rem; color: var(--gold); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .sci-text { font-size: 0.75rem; color: #ddd; line-height: 1.4; }

        .action-btn { background: var(--blue); color: #fff; padding: 12px 20px; border-radius: 12px; border: none; font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; transition: all 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        .action-btn.green { background: var(--green); }
        .action-btn.gold { background: var(--gold); color: #000; }
        .action-btn.red { background: var(--red); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; animation: fadeIn 0.2s;‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v2004.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --glass: rgba(30, 30, 32, 0.85);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
            --gold: #FFD60A;
            --green: #30D158;
            --blue: #0A84FF;
            --red: #FF453A;
            --purple: #BF5AF2;
            --orange: #FF9F0A;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px 16px; min-height: 100vh; background-image: radial-gradient(circle at top center, #1a1a1a 0%, #000000 60%); }
        .container { max-width: 480px; margin: 0 auto; padding-bottom: 60px; }
        h1 { text-align: center; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; font-size: 0.8rem; margin: 10px 0 20px 0; color: #666; }

        .badge-row { display: flex; justify-content: center; background: rgba(255, 255, 255, 0.05); padding: 4px; border-radius: 30px; margin: 0 auto 20px auto; width: fit-content; border: 1px solid var(--border); }
        .u-badge { padding: 8px 20px; border-radius: 24px; font-size: 0.7rem; font-weight: 700; cursor: pointer; color: var(--text-sub); transition: all 0.3s ease; }
        .u-badge.active { background: rgba(255, 255, 255, 0.15); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .status-bar { text-align: center; color: var(--text-sub); font-size: 0.65rem; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; }
        .controls { display: flex; gap: 8px; margin-bottom: 20px; }
        .nav-btn { background: var(--glass); border: 1px solid var(--border); color: var(--text-sub); padding: 12px; flex: 1; border-radius: 16px; font-size: 0.6rem; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        .nav-btn:active { transform: scale(0.98); }

        .tabs { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;}
        .tab { flex: 1; min-width: 45px; padding: 12px 0; background: transparent; color: #555; border-radius: 16px; font-size: 0.6rem; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: var(--glass); color: #fff; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        .premium-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .premium-card:active { transform: scale(0.99); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-sub); }
        .card-subtitle { font-size: 0.65rem; color: #555; margin-top: 3px; }
        .card-val-lg { font-size: 1.6rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }

        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.02); }
        .data-label { font-size: 0.65rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .data-val { font-size: 0.8rem; font-weight: 700; color: #fff; }

        .bio-section { margin-bottom: 15px; }
        .bar-label { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; margin-bottom: 8px; display: flex; justify-content: space-between; text-transform: uppercase; }
        .bar-track { height: 8px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 0.8s ease; }
        
        .section-header { margin: 25px 0 10px 0; font-size: 0.6rem; color: #666; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .chevron { font-size: 0.8rem; color: #444; transition: transform 0.3s ease; margin-left: 10px; }
        .premium-card.collapsed .card-body { display: none; }
        .premium-card.collapsed .chevron { transform: rotate(-90deg); }
        
        .warning-box { padding: 12px; background: rgba(255, 149, 10, 0.1); border-left: 3px solid var(--orange); border-radius: 8px; margin-top: 12px; }
        .warn-label { font-size: 0.6rem; color: var(--orange); font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
        .warn-text { font-size: 0.75rem; color: #ddd; line-height: 1.4; }
        .warn-action { font-size: 0.7rem; color: var(--gold); margin-top: 6px; font-weight: 700; }

        .synergy-box { padding: 12px; background: rgba(48, 209, 88, 0.1); border-left: 3px solid var(--green); border-radius: 8px; margin-top: 12px; }
        .syn-label { font-size: 0.6rem; color: var(--green); font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
        .syn-text { font-size: 0.75rem; color: #ddd; line-height: 1.4; }

        .action-btn { background: var(--blue); color: #fff; padding: 12px 20px; border-radius: 12px; border: none; font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; transition: all 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        .action-btn.green { background: var(--green); }
        .action-btn.gold { background: var(--gold); color: #000; }
        .action-btn.red { background: var(--red); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; animation: fadeIn 0.2s; }
        .modal.active { display: flex; }
        .modal-header { padding: 20px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 0.8rem; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1.5px; }
        .modal-close { font-size: 1.8rem; cursor: pointer; color: #666; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; }
        .form-input { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-size: 0.9rem; font-weight: 600; }
        .form-input:focus { outline: none; border-color: var(--blue); }

        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 16px; padding: 15px 25px; z-index: 10000; display: none; animation: slideDown 0.3s; max-width: 90%; }
        .notification.active { display: block; }
        .notification.success { border-color: var(--green); }
        .notification.error { border-color: var(--red); }

        .prediction-badge { display: inline-block; padding: 4px 10px; background: rgba(10, 132, 255, 0.15); border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 8px; font-size: 0.55rem; font-weight: 800; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; margin-left: 8px; }

        .meal-category { margin-bottom: 20px; }
        .meal-category-title { font-size: 0.65rem; color: var(--gold); font-weight: 800; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateX(-50%) translateY(-20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>THE CENTURION PROTOCOL</h1>
        <div class="badge-row">
            <div id="bj" class="u-badge" onclick="switchU('J')">üßîüèæ‚Äç‚ôÇÔ∏è JERMAINE</div>
            <div id="bs" class="u-badge" onclick="switchU('S')">üë©üèæ‚Äçü¶± SOPHIA</div>
        </div>
    </header>
    
    <div id="labReminder" class="status-bar" style="color: var(--orange); cursor: default;"></div>
    <div id="bodyScanReminder" class="status-bar" style="color: var(--blue); cursor: default;"></div>
<div id="ouraBar" class="status-bar" onclick="fetchOuraData().then(() => render())">üíç HANDSHAKE REQUIRED...</div>
    <div id="dateDisplay" class="status-bar" style="margin-bottom: 20px; opacity: 0.7;">...</div>

    <div class="controls">
        <button class="nav-btn" onclick="changeW(-1)">‚óÄ PREV</button>
        <button class="nav-btn" onclick="resetD()">TODAY</button>
        <button class="nav-btn" onclick="changeW(1)">NEXT ‚ñ∂</button>
    </div>
    
    <div id="dayTabs" class="tabs"></div>
    <div id="dayContent"></div>
    <div style="text-align:center; color:#333; font-size:10px; margin-top:30px; opacity:0.4;">v2004.0 Meal Recs + Geo Metrics</div>
</div>

<div id="mealModal" class="modal">
    <div class="modal-header">
        <div class="modal-title">üì∏ AI MEAL ANALYZER</div>
        <div class="modal-close" onclick="closeModal('mealModal')">‚úï</div>
    </div>
    <div class="modal-body">
        <input type="file" accept="image/*" capture="environment" id="photoInput" style="display:none" onchange="processPhotoWithAI(event)">
        <label for="photoInput">
            <div style="border: 2px dashed var(--border); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üì∏</div>
                <div style="font-size: 0.8rem; color: var(--text-sub);">TAP TO CAPTURE MEAL</div>
                <div style="font-size: 0.6rem; color: #666; margin-top: 8px;">AI analyzes biomarker impact + nutrient interactions</div>
            </div>
        </label>
        <div id="photoPreview" style="display:none;"></div>
        <div style="border-top: 1px solid var(--border); padding-top: 20px; margin-top: 20px;">
            <div style="font-size: 0.65rem; color: #666; margin-bottom: 15px; text-transform: uppercase; text-align: center;">OR QUICK LOG BALANCED MEALS</div>
            <div id="quickMealButtons"></div>
        </div>
    </div>
</div>

<div id="labModal" class="modal">
    <div class="modal-header">
        <div class="modal-title">ü©∏ LOG TEST RESULTS</div>
        <div class="modal-close" onclick="closeModal('labModal')">‚úï</div>
    </div>
    <div class="modal-body">
        <div style="background: rgba(10, 132, 255, 0.1); padding: 15px; border-radius: 12px; border-left: 3px solid var(--blue); margin-bottom: 20px;">
            <div style="font-size: 0.65rem; color: var(--blue); font-weight: 800; margin-bottom: 5px;">‚ÑπÔ∏è PREDICTION MODE</div>
            <div style="font-size: 0.75rem; color: #ddd; line-height: 1.4;">
                Between tests, we predict values using actual food intake + absorption efficiency. Log actual results annually for blood work.
            </div>
        </div>
        <div id="labModalBody"></div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
// ==========================================
// CENTURION v2004.0 - MEAL RECS + GEO METRICS
// ==========================================

let user = localStorage.getItem('centurion_active_user') || 'J';
let offset = 0;
let selDate = getCaDate(); 
let useMetric = false;

let isPlanCollapsed = false;
let isWorkoutCollapsed = true;
let isNutCollapsed = true;
let isBioCollapsed = true;

const TOKENS = { 
    'J': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 
    'S': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' 
};
// ==========================================
// BIO-AVAILABILITY DATABASE
// ==========================================

const nutrientInteractions = {
    calcium_iron: { nutrient1: 'calcium', nutrient2: 'iron', type: 'inhibitor', severity: 'high', mechanism: 'Calcium competes with iron for absorption via DMT1 transporter', reduction: 0.5, solution: 'Separate calcium-rich foods from iron sources by 2+ hours', examples: 'Dairy + Red meat/Spinach', targetBiomarker: 'ferritin' },
    phytate_iron: { nutrient1: 'phytate', nutrient2: 'iron', type: 'inhibitor', severity: 'high', mechanism: 'Phytic acid binds iron forming insoluble complexes', reduction: 0.6, solution: 'Add vitamin C source (citrus, peppers) to increase absorption 3-4x', examples: 'Whole grains + Spinach', targetBiomarker: 'ferritin' },
    calcium_zinc: { nutrient1: 'calcium', nutrient2: 'zinc', type: 'inhibitor', severity: 'medium', mechanism: 'Competitive inhibition at intestinal zinc transporters', reduction: 0.3, solution: 'Separate high-calcium foods from zinc sources by 1-2 hours', examples: 'Dairy + Oysters/Beef', targetBiomarker: 'testosterone' },
    tannins_iron: { nutrient1: 'tannins', nutrient2: 'iron', type: 'inhibitor', severity: 'medium', mechanism: 'Polyphenols bind iron reducing solubility', reduction: 0.4, solution: 'Avoid coffee/tea within 1 hour of iron-rich meals', examples: 'Coffee/Tea + Meat', targetBiomarker: 'ferritin' },
    fiber_minerals: { nutrient1: 'fiber', nutrient2: 'minerals', type: 'inhibitor', severity: 'low', mechanism: 'Excess fiber (>50g/day) reduces mineral transit time', reduction: 0.15, solution: 'Limit fiber to <40g/day when optimizing mineral absorption', examples: 'High-fiber supplements + Mineral-rich foods', targetBiomarker: 'multiple' },
    vitaminC_iron: { nutrient1: 'vitaminC', nutrient2: 'iron', type: 'enhancer', severity: 'high', mechanism: 'Ascorbic acid reduces ferric to ferrous iron (more bioavailable)', enhancement: 3.5, solution: 'Pair iron sources with citrus, peppers, or tomatoes', examples: 'Spinach + Lemon juice', targetBiomarker: 'ferritin' },
    fat_vitaminD: { nutrient1: 'fat', nutrient2: 'vitaminD', type: 'enhancer', severity: 'high', mechanism: 'Vitamin D is fat-soluble; requires dietary fat for absorption', enhancement: 2.5, solution: 'Take vitamin D supplements with fatty meals (>10g fat)', examples: 'Vitamin D + Avocado/Nuts', targetBiomarker: 'vitaminD' },
    fat_vitaminA: { nutrient1: 'fat', nutrient2: 'vitaminA', type: 'enhancer', severity: 'high', mechanism: 'Carotenoids require fat for micelle formation', enhancement: 3.0, solution: 'Add fat source to vegetable dishes (olive oil on salad)', examples: 'Carrots + Olive oil', targetBiomarker: 'multiple' },
    fat_omega3: { nutrient1: 'fat', nutrient2: 'omega3', type: 'enhancer', severity: 'medium', mechanism: 'Other fats aid omega-3 emulsification', enhancement: 1.5, solution: 'Consume fish oil with meals containing fat', examples: 'Fish oil + Meal with fat', targetBiomarker: 'apob' },
    protein_iron: { nutrient1: 'protein', nutrient2: 'iron', type: 'enhancer', severity: 'medium', mechanism: 'Heme iron (from meat) has 15-35% absorption vs 2-20% non-heme', enhancement: 2.5, solution: 'Prioritize animal sources for iron (beef, oysters)', examples: 'Red meat vs Spinach alone', targetBiomarker: 'ferritin' },
    quercetin_zinc: { nutrient1: 'quercetin', nutrient2: 'zinc', type: 'enhancer', severity: 'low', mechanism: 'Quercetin acts as zinc ionophore improving cellular uptake', enhancement: 1.3, solution: 'Combine zinc-rich foods with onions, apples', examples: 'Beef + Onions', targetBiomarker: 'testosterone' }
};

const foodNutrients = {
    'greek yogurt': { calcium: 200, protein: 15, iron: 0 }, 'milk': { calcium: 300, protein: 8, iron: 0 }, 'cheese': { calcium: 200, protein: 7, iron: 0 }, 'yogurt': { calcium: 180, protein: 10, iron: 0 },
    'beef': { iron: 3, protein: 26, calcium: 10, zinc: 5, vitaminC: 0 }, 'red meat': { iron: 3.5, protein: 26, calcium: 10, zinc: 5, vitaminC: 0 }, 'steak': { iron: 3, protein: 26, calcium: 10, zinc: 5, vitaminC: 0 }, 'bison': { iron: 3.2, protein: 25, calcium: 8, zinc: 5, vitaminC: 0 },
    'spinach': { iron: 3, calcium: 100, vitaminC: 28, phytate: 600 }, 'lentils': { iron: 3.3, protein: 9, phytate: 800, fiber: 8 },
    'lemon': { vitaminC: 53, calcium: 26 }, 'orange': { vitaminC: 70, calcium: 40 }, 'bell pepper': { vitaminC: 190, iron: 0.5 }, 'broccoli': { vitaminC: 90, iron: 0.7, calcium: 47 }, 'tomato': { vitaminC: 23, iron: 0.3 },
    'brown rice': { phytate: 900, fiber: 3.5, iron: 0.8 }, 'quinoa': { phytate: 1200, fiber: 5, iron: 2.8, protein: 8 }, 'oats': { phytate: 1000, fiber: 10, iron: 4.7 }, 'whole wheat': { phytate: 1100, fiber: 12, iron: 3.6 },
    'coffee': { tannins: 200, calcium: 5 }, 'tea': { tannins: 150, calcium: 0 }, 'wine': { tannins: 180 },
    'avocado': { fat: 15, fiber: 7, vitaminC: 10 }, 'olive oil': { fat: 14 }, 'nuts': { fat: 14, zinc: 3, phytate: 400 }, 'walnuts': { fat: 18, omega3: 2.5, phytate: 350 }, 'salmon': { fat: 13, omega3: 2.2, protein: 25, vitaminD: 570 }, 'fish': { fat: 10, omega3: 1.5, protein: 22 },
    'egg': { vitaminD: 44, protein: 6, fat: 5, calcium: 28 }, 'fortified milk': { vitaminD: 120, calcium: 300, fat: 8 }, 'oysters': { zinc: 74, protein: 7, iron: 6, calcium: 37 },
    'sweet potato': { fiber: 3, vitaminA: 19000, calcium: 30 }, 'carrots': { vitaminA: 16700, fiber: 3 }, 'onion': { quercetin: 20 }, 'apple': { quercetin: 4.4, fiber: 2.4 }
};

function analyzeMealInteractions(meals, userID) {
    const warnings = [], synergies = [], absorptionAdjustments = {};
    const recentMeals = meals.filter(m => { const hoursSince = (Date.now() - (m.time || Date.now())) / 3600000; return hoursSince <= 3; });
    if (recentMeals.length === 0) return { warnings, synergies, absorptionAdjustments };
    
    const allFoods = [], totalNutrients = {};
    recentMeals.forEach(meal => {
        meal.name.toLowerCase().split(/[,\+&]/).forEach(food => {
            const trimmed = food.trim();
            Object.keys(foodNutrients).forEach(key => {
                if (trimmed.includes(key) || key.includes(trimmed)) allFoods.push({ name: key, nutrients: foodNutrients[key], mealName: meal.name });
            });
        });
    });
    
    allFoods.forEach(food => { Object.keys(food.nutrients).forEach(nutrient => { totalNutrients[nutrient] = (totalNutrients[nutrient] || 0) + food.nutrients[nutrient]; }); });
    
    Object.keys(nutrientInteractions).forEach(interactionKey => {
        const interaction = nutrientInteractions[interactionKey];
        const nutrient1Val = totalNutrients[interaction.nutrient1] || 0, nutrient2Val = totalNutrients[interaction.nutrient2] || 0;
        
        if (nutrient1Val > 0 && nutrient2Val > 0) {
            if (interaction.type === 'inhibitor') {
                let triggered = false;
                if (interaction.severity === 'high' && nutrient1Val > 100) triggered = true;
                if (interaction.severity === 'medium' && nutrient1Val > 200) triggered = true;
                if (interaction.severity === 'low' && nutrient1Val > 500) triggered = true;
                
                if (triggered) {
                    warnings.push({ type: 'inhibitor', severity: interaction.severity, nutrient: interaction.nutrient2, inhibitor: interaction.nutrient1, mechanism: interaction.mechanism, reduction: interaction.reduction, solution: interaction.solution, examples: interaction.examples, targetBiomarker: interaction.targetBiomarker, affectedMeals: recentMeals.map(m => m.name).join(', ') });
                    if (!absorptionAdjustments[interaction.nutrient2]) absorptionAdjustments[interaction.nutrient2] = 1.0;
                    absorptionAdjustments[interaction.nutrient2] *= (1 - interaction.reduction);
                }
            } else if (interaction.type === 'enhancer') {
                let triggered = false;
                if (interaction.severity === 'high' && nutrient1Val > 10) triggered = true;
                if (interaction.severity === 'medium' && nutrient1Val > 50) triggered = true;
                
                if (triggered) {
                    synergies.push({ type: 'enhancer', severity: interaction.severity, nutrient: interaction.nutrient2, enhancer: interaction.nutrient1, mechanism: interaction.mechanism, enhancement: interaction.enhancement, solution: interaction.solution, examples: interaction.examples, targetBiomarker: interaction.targetBiomarker, affectedMeals: recentMeals.map(m => m.name).join(', ') });
                    if (!absorptionAdjustments[interaction.nutrient2]) absorptionAdjustments[interaction.nutrient2] = 1.0;
                    absorptionAdjustments[interaction.nutrient2] *= interaction.enhancement;
                }
            }
        }
    });
    
    if (userID === 'S' && totalNutrients.calcium > 200 && totalNutrients.iron > 2) {
        const ferritin = baselineData['S'].lastLabTest.ferritin || 75;
        if (ferritin < 100) warnings.push({ type: 'critical', severity: 'high', nutrient: 'iron', inhibitor: 'calcium', mechanism: `Your Ferritin (${ferritin} ng/mL) needs optimization. Calcium inhibiting iron absorption.`, reduction: 0.5, solution: 'Shift Greek yogurt or dairy to 2+ hours after iron-rich meals', targetBiomarker: 'ferritin', affectedMeals: recentMeals.map(m => m.name).join(', ') });
    }
    
    return { warnings, synergies, absorptionAdjustments };
}

const baselineData = {
    'J': { 
        lastBodyScan: { date: '2025-12-23', bf: 20.7, muscle: 98.3, vf: 11, weight: 217.1 }, 
        lastLabTest: { date: '2025-12-23', apob: 95, hba1c: 5.4, testosterone: 650, vitaminD: 45 }, 
        goals: { bf: 15.0, muscle: 105.0, vf: 7, apob: 60, hba1c: 5.0, testosterone: 600, vitaminD: 50, vo2: 55 }, 
        vo2: 45, startDate: '2025-01-01', bmr: 1850, activity_factor: 1.6, tdee: 2960, targetDeficit: -500 
    },
    'S': { 
        lastBodyScan: { date: '2025-12-23', bf: 36.1, muscle: 49.2, vf: 9, weight: 165 }, 
        lastLabTest: { date: '2025-11-01', calcium: 9.0, glucose: 84, bun: 13, creatinine: 0.82, egfr: 94, ana: 320, hba1c: 5.6, ferritin: 75, tsh: 2.1, vitaminD: 38 }, 
        goals: { bf: 22.0, muscle: 60.0, vf: 4, calcium: 9.5, glucose: 85, bun: 15, creatinine: 0.7, egfr: 90, ana: 40, hba1c: 5.0, ferritin: 100, tsh: 2.0, vitaminD: 50, vo2: 45 }, 
        vo2: 32, startDate: '2025-01-01', bmr: 1420, activity_factor: 1.4, tdee: 1988, targetDeficit: -300 
    }
};

const labMetadata = {
    'J': { apob: { name: "ApoB", unit: "mg/dL", lowerBetter: true, freq: 365 }, hba1c: { name: "HbA1c", unit: "%", lowerBetter: true, freq: 365 }, testosterone: { name: "Testosterone", unit: "ng/dL", lowerBetter: false, freq: 365 }, vitaminD: { name: "Vitamin D", unit: "ng/mL", lowerBetter: false, freq: 365 } },
    'S': { calcium: { name: "Calcium", unit: "mg/dL", lowerBetter: false, freq: 365 }, glucose: { name: "Glucose", unit: "mg/dL", lowerBetter: true, freq: 365 }, bun: { name: "BUN", unit: "mg/dL", lowerBetter: false, freq: 365 }, creatinine: { name: "Creatinine", unit: "mg/dL", lowerBetter: true, freq: 365 }, egfr: { name: "eGFR", unit: "", lowerBetter: false, freq: 365 }, ana: { name: "ANA Titer", unit: "", lowerBetter: true, freq: 365 }, hba1c: { name: "HbA1c", unit: "%", lowerBetter: true, freq: 365 }, ferritin: { name: "Ferritin", unit: "ng/mL", lowerBetter: false, freq: 365 }, tsh: { name: "TSH", unit: "mIU/L", lowerBetter: true, freq: 365 }, vitaminD: { name: "Vitamin D", unit: "ng/mL", lowerBetter: false, freq: 365 } }
};

const macroImpacts = {
    'J': { fiber: { target: 35, impacts: [{ biomarker: 'apob', perGram: -0.8, mechanism: "Soluble fiber binds bile acids ‚Üí ‚Üëhepatic LDL-R ‚Üí ‚ÜìApoB" }, { biomarker: 'hba1c', perGram: -0.002, mechanism: "Fiber slows glucose absorption" }] }, saturatedFat: { target: 15, impacts: [{ biomarker: 'apob', perGram: 1.2, mechanism: "Saturated fat ‚ÜëLDL-R downregulation via SREBP-2" }] }, omega3: { target: 3, impacts: [{ biomarker: 'apob', perGram: -2.5, mechanism: "EPA/DHA ‚ÜìVLDL synthesis, ‚ÜëLDL particle size" }] }, protein: { target: 165, impacts: [{ biomarker: 'muscle', perGram: 0.02, mechanism: "Positive nitrogen balance" }] } },
    'S': { fiber: { target: 30, impacts: [{ biomarker: 'ana', perGram: -2.0, mechanism: "Fiber ‚Üëbutyrate ‚Üí ‚Üìsystemic inflammation" }, { biomarker: 'hba1c', perGram: -0.003, mechanism: "Improved glycemic control" }] }, omega3: { target: 2.5, impacts: [{ biomarker: 'ana', perGram: -8.0, mechanism: "EPA/DHA suppress NF-Œ∫B ‚Üí ‚ÜìIL-6, TNF-Œ±" }] }, refinedCarbs: { target: 50, impacts: [{ biomarker: 'hba1c', perGram: 0.002, mechanism: "High GI ‚Üí insulin resistance" }, { biomarker: 'ana', perGram: 0.5, mechanism: "Refined carbs ‚Üëoxidative stress" }] }, protein: { target: 100, impacts: [{ biomarker: 'muscle', perGram: 0.015, mechanism: "Muscle protein synthesis" }] } }
};

const mealDB = {
    b: [
        { name: "Ancestral Beef Sausage + Berries", pro: 25, carb: 15, fat: 18, fiber: 8, omega3: 0.3, satFat: 6, refinedCarbs: 0, cal: 320 },
        { name: "Avocado Egg Toast", pro: 20, carb: 35, fat: 12, fiber: 12, omega3: 0.5, satFat: 3, refinedCarbs: 5, cal: 340 },
        { name: "Greek Yogurt Bowl + Walnuts + Berries", pro: 30, carb: 25, fat: 10, fiber: 5, omega3: 2.5, satFat: 2, refinedCarbs: 10, cal: 310 },
        { name: "Oatmeal + Almond Butter + Banana", pro: 12, carb: 45, fat: 14, fiber: 9, omega3: 0.2, satFat: 2, refinedCarbs: 8, cal: 350 }
    ],
    l: [
        { name: "Super Mince Bowl (Lentils + Veggies)", pro: 50, carb: 45, fat: 15, fiber: 18, omega3: 0.2, satFat: 5, refinedCarbs: 0, cal: 550 },
        { name: "Salmon Power Salad + Olive Oil", pro: 40, carb: 20, fat: 25, fiber: 10, omega3: 3.5, satFat: 4, refinedCarbs: 0, cal: 480 },
        { name: "Turkey Rice Bowl + Broccoli", pro: 45, carb: 50, fat: 10, fiber: 8, omega3: 0.1, satFat: 2, refinedCarbs: 5, cal: 520 },
        { name: "Chicken Quinoa Bowl + Mixed Greens", pro: 42, carb: 38, fat: 12, fiber: 11, omega3: 0.3, satFat: 3, refinedCarbs: 0, cal: 450 }
    ],
    d: [
        { name: "Bison Portobello + Quinoa + Asparagus", pro: 45, carb: 35, fat: 18, fiber: 12, omega3: 0.4, satFat: 7, refinedCarbs: 0, cal: 520 },
        { name: "Wild Salmon + Sweet Potato + Spinach", pro: 50, carb: 40, fat: 20, fiber: 10, omega3: 4.0, satFat: 3, refinedCarbs: 0, cal: 560 },
        { name: "Halibut + White Beans + Kale", pro: 42, carb: 30, fat: 12, fiber: 15, omega3: 0.8, satFat: 2, refinedCarbs: 0, cal: 420 },
        { name: "Grass-Fed Beef + Brown Rice + Brussels", pro: 48, carb: 42, fat: 16, fiber: 9, omega3: 0.5, satFat: 6, refinedCarbs: 0, cal: 540 }
    ],
    s: [
        { name: "Protein Shake + Banana", pro: 25, carb: 30, fat: 3, fiber: 4, omega3: 0.1, satFat: 1, refinedCarbs: 5, cal: 250 },
        { name: "Apple + Almond Butter", pro: 4, carb: 22, fat: 16, fiber: 5, omega3: 0.1, satFat: 2, refinedCarbs: 0, cal: 240 },
        { name: "Mixed Nuts + Dark Chocolate", pro: 8, carb: 18, fat: 22, fiber: 6, omega3: 1.5, satFat: 4, refinedCarbs: 8, cal: 310 },
        { name: "Protein Bar + Orange", pro: 20, carb: 28, fat: 8, fiber: 6, omega3: 0.2, satFat: 3, refinedCarbs: 10, cal: 270 }
    ]
};


const unifiedSchedule = { 1: { focus: "HEAVY LIFT", tasks: "5x5 Compounds", zT: {h:15, m:30} }, 2: { focus: "BOXING", tasks: "45m Intervals", zT: {h:30, m:15} }, 3: { focus: "REFORM", tasks: "Pilates", zT: {h:5, m:40} }, 4: { focus: "BOXING", tasks: "Technique", zT: {h:25, m:20} }, 5: { focus: "REFORM", tasks: "Core", zT: {h:0, m:30} }, 6: { focus: "CS4 / VO2", tasks: "Max Intervals", zT: {h:25, m:20} }, 0: { focus: "REST", tasks: "Recovery", zT: {h:0, m:0} } };

function calculateEnergyBalance(userID, dateKey) {
    const baseline = baselineData[userID], foodLog = getFoodLog(dateKey), cached = JSON.parse(localStorage.getItem(`centurion_oura_cache_${userID}`)) || { history: [] }, ouraData = cached.history.find(d => d.date === dateKey) || { cal: 0 };
    const consumed = foodLog.totalCal || 0, exerciseBurn = parseInt(ouraData.cal) || 0, tdee = baseline.tdee, netBalance = consumed - (tdee + exerciseBurn), dailyFatChange = netBalance / 3500 * 0.454, dailyVFChange = netBalance / 5000 * 0.1;
    return { consumed, tdee, exerciseBurn, totalBurn: tdee + exerciseBurn, netBalance, dailyFatChange, dailyVFChange, status: netBalance < -200 ? 'DEFICIT' : netBalance > 200 ? 'SURPLUS' : 'MAINTENANCE', targetHit: Math.abs(netBalance - baseline.targetDeficit) < 100 };
}

function getWeeklyEnergyTrend(userID) {
    const logs = [];
    for (let i = 0; i < 7; i++) { const d = new Date(); d.setDate(d.getDate() - i); logs.push(calculateEnergyBalance(userID, getDateKey(d))); }
    const avgBalance = logs.reduce((s, l) => s + l.netBalance, 0) / 7, projectedWeeklyFatChange = (avgBalance * 7) / 3500 * 0.454;
    return { avgDailyBalance: Math.round(avgBalance), projectedWeeklyFatChange: projectedWeeklyFatChange.toFixed(2), consistency: logs.filter(l => l.targetHit).length };
}

function calculateMacroImpacts(userID, foodLog) {
    const impacts = {}, userMacros = macroImpacts[userID];
    Object.keys(userMacros).forEach(macroKey => {
        const macro = userMacros[macroKey], actualIntake = foodLog[`total${macroKey.charAt(0).toUpperCase() + macroKey.slice(1)}`] || 0, delta = actualIntake - macro.target;
        macro.impacts.forEach(impact => {
            if (!impacts[impact.biomarker]) impacts[impact.biomarker] = { totalChange: 0, mechanisms: [] };
            const change = delta * impact.perGram;
            impacts[impact.biomarker].totalChange += change;
            if (Math.abs(change) > 0.1) impacts[impact.biomarker].mechanisms.push({ macro: macroKey, change: change.toFixed(2), mechanism: impact.mechanism });
        });
    });
    return impacts;
}
function predictBodyCompositionForDate(userID, targetDate) {
    const baseline = baselineData[userID], lastScan = baseline.lastBodyScan, goals = baseline.goals, startDate = new Date(baseline.startDate), target = new Date(targetDate);
    let cumulativeFatChange = 0, daysWithData = 0;
    const daysSinceStart = Math.floor((target - startDate) / 86400000);
    for (let i = 0; i <= Math.min(daysSinceStart, 90); i++) { const d = new Date(startDate); d.setDate(d.getDate() + i); const dk = getDateKey(d), balance = calculateEnergyBalance(userID, dk); if (balance.consumed > 0) { cumulativeFatChange += balance.dailyFatChange; daysWithData++; } }
    if (daysWithData === 0) { const weeklyBFLoss = userID === 'J' ? 0.25 : 0.35, weeksPassed = daysSinceStart / 7; return { bf: Math.max(goals.bf, lastScan.bf - (weeklyBFLoss * weeksPassed)), muscle: lastScan.muscle, vf: Math.max(goals.vf, lastScan.vf - (0.15 * weeksPassed)), confidence: "LOW", dataSource: "DEFAULT_RATES" }; }
    const currentWeight = lastScan.weight, fatMass = (lastScan.bf / 100) * currentWeight, newFatMass = Math.max(1, fatMass + cumulativeFatChange), predictedBF = Math.max(goals.bf, (newFatMass / currentWeight) * 100);
    return { bf: parseFloat(predictedBF.toFixed(1)), muscle: lastScan.muscle, vf: Math.max(goals.vf, lastScan.vf), confidence: daysWithData >= 7 ? "HIGH" : "MEDIUM", dataSource: "ACTUAL_INTAKE", daysWithData };
}

function predictLabValueForDate(userID, labKey, targetDate) {
    const baseline = baselineData[userID], lastTest = baseline.lastLabTest, goals = baseline.goals;
    if (!lastTest[labKey]) return null;
    const startDate = new Date(baseline.startDate), target = new Date(targetDate), daysSinceStart = Math.floor((target - startDate) / 86400000);
    let totalMacroImpact = 0, daysWithData = 0;
    for (let i = 0; i <= Math.min(daysSinceStart, 90); i++) { const d = new Date(startDate); d.setDate(d.getDate() + i); const foodLog = getFoodLog(getDateKey(d)); if (foodLog.meals && foodLog.meals.length > 0) { const impacts = calculateMacroImpacts(userID, foodLog); if (impacts[labKey]) { totalMacroImpact += impacts[labKey].totalChange; daysWithData++; } } }
    let baseWeeklyChange = 0;
    if (userID === 'J') { if (labKey === 'apob') baseWeeklyChange = -2.0; else if (labKey === 'hba1c') baseWeeklyChange = -0.01; else if (labKey === 'vitaminD') baseWeeklyChange = 0.5; } else { if (labKey === 'ana') baseWeeklyChange = -6.0; else if (labKey === 'hba1c') baseWeeklyChange = -0.015; else if (labKey === 'ferritin') baseWeeklyChange = 0.3; else if (labKey === 'vitaminD') baseWeeklyChange = 0.8; }
    const weeksPassed = daysSinceStart / 7, baseChange = baseWeeklyChange * weeksPassed, totalChange = baseChange + (daysWithData > 0 ? totalMacroImpact / daysWithData * daysSinceStart : 0);
    let predictedVal = lastTest[labKey] + totalChange;
    const meta = labMetadata[userID][labKey];
    if (meta.lowerBetter) predictedVal = Math.max(goals[labKey], predictedVal); else predictedVal = Math.min(goals[labKey], predictedVal);
    return { value: parseFloat(predictedVal.toFixed(labKey === 'hba1c' ? 2 : 1)), confidence: daysWithData >= 7 ? "HIGH" : "MEDIUM", dataSource: daysWithData > 0 ? "MACRO_ADJUSTED" : "BASE_RATE" };
}

function saveFoodLog(date, meal) {
    const log = JSON.parse(localStorage.getItem(`centurion_food_log_${user}`)) || {};
    if (!log[date]) log[date] = { meals: [], totalPro: 0, totalCarb: 0, totalFat: 0, totalCal: 0, totalFiber: 0, totalOmega3: 0, totalSatFat: 0, totalRefinedCarbs: 0 };
    log[date].meals.push({ ...meal, time: Date.now() });
    log[date].totalPro += meal.pro || 0; log[date].totalCarb += meal.carb || 0; log[date].totalFat += meal.fat || 0; log[date].totalCal += meal.cal || 0; log[date].totalFiber += meal.fiber || 0; log[date].totalOmega3 += meal.omega3 || 0; log[date].totalSatFat += meal.satFat || 0; log[date].totalRefinedCarbs += meal.refinedCarbs || 0;
    localStorage.setItem(`centurion_food_log_${user}`, JSON.stringify(log));
    return log[date];
}

function getFoodLog(date) { const log = JSON.parse(localStorage.getItem(`centurion_food_log_${user}`)) || {}; return log[date] || { meals: [], totalPro: 0, totalCarb: 0, totalFat: 0, totalCal: 0, totalFiber: 0, totalOmega3: 0, totalSatFat: 0, totalRefinedCarbs: 0 }; }
function saveLabTest(userID, testDate, results) { baselineData[userID].lastLabTest = { date: testDate, ...results }; localStorage.setItem('centurion_baseline', JSON.stringify(baselineData)); showNotification('‚úì Labs saved - Predictions recalibrated'); }
function saveBodyScan(userID, scanDate, results) { baselineData[userID].lastBodyScan = { date: scanDate, ...results }; localStorage.setItem('centurion_baseline', JSON.stringify(baselineData)); showNotification('‚úì Body scan saved - Predictions recalibrated'); }
function loadBaselineData() { const saved = localStorage.getItem('centurion_baseline'); if (saved) { const data = JSON.parse(saved); Object.keys(data).forEach(u => { if (baselineData[u]) Object.assign(baselineData[u], data[u]); }); } }

function getCaDate() { let d = new Date(); d.setHours(12, 0, 0, 0); return d; }
function getDateKey(d) { return d.toISOString().split('T')[0]; }
function getMon(o) { let d = getCaDate(); d.setHours(0,0,0,0); let day = d.getDay(); let diff = d.getDate() - day + (day === 0 ? -6 : 1); d.setDate(diff + (o * 7)); return d; }

function showNotification(message, type='success') { const notif = document.getElementById('notification'); notif.textContent = message; notif.className = 'notification active ' + type; setTimeout(() => notif.className = 'notification', 3000); }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function checkLabReminder(userID) { 
    const lastTest = new Date(baselineData[userID].lastLabTest.date), nextDue = new Date(lastTest); 
    nextDue.setDate(nextDue.getDate() + 365);
    const today = new Date(), daysUntil = Math.floor((nextDue - today) / 86400000); 
    if (daysUntil <= 0) return `ü©∏ BLOOD WORK OVERDUE - <span style="text-decoration:underline; cursor:pointer;" onclick="openLabLogger()">Order now</span>`; 
    else if (daysUntil <= 30) return `ü©∏ BLOOD WORK DUE IN ${daysUntil} DAYS`; 
    return null; 
}

function checkBodyScanReminder(userID) { 
    const lastScan = new Date(baselineData[userID].lastBodyScan.date), nextDue = new Date(lastScan); 
    nextDue.setDate(nextDue.getDate() + 30);
    const today = new Date(), daysUntil = Math.floor((nextDue - today) / 86400000); 
    if (daysUntil <= 0) return `üìä BODY SCAN OVERDUE - Schedule InBody scan`; 
    else if (daysUntil <= 7) return `üìä BODY SCAN DUE IN ${daysUntil} DAYS`; 
    return null; 
}

async function fetchOuraData() {
    const fetchID = user;
    const token = TOKENS[fetchID];
    const range = `start_date=${getDateKey(new Date(Date.now()-864e5*14))}&end_date=${getDateKey(new Date())}`;
    
    document.getElementById('ouraBar').style.animation = 'pulse 1.5s infinite';
    document.getElementById('ouraBar').innerHTML = `üíç SYNCING ${fetchID === 'J' ? 'JERMAINE' : 'SOPHIA'}...`;
    
    try {
        const [rRes, aRes] = await Promise.all([
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${range}`)}`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            }), 
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?${range}`)}`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            })
        ]);
        
        const rData = await rRes.json();
        const aData = await aRes.json();
        
        // User switched during fetch - abort
        if(user !== fetchID) return;
        
        if(rData.data) {
            const hist = rData.data.map(day => { 
                const act = aData.data ? aData.data.find(ac => ac.day === day.day) : null; 
                return { 
                    date: day.day, 
                    score: day.score || "-", 
                    cal: act ? act.active_calories : 0, 
                    high: act ? Math.round(act.high_activity_time/60) : 0, 
                    med: act ? Math.round(act.medium_activity_time/60) : 0 
                }; 
            }).reverse();
            
            localStorage.setItem(`centurion_oura_cache_${fetchID}`, JSON.stringify({history: hist}));
            document.getElementById('ouraBar').style.animation = '';
            document.getElementById('ouraBar').innerHTML = `üíç ${fetchID === 'J' ? 'JERMAINE' : 'SOPHIA'} READY: <span style="color:${hist[0]?.score >= 75 ? 'var(--green)' : 'var(--red)'}; font-weight:900">${hist[0]?.score || "-"}</span>`;
            
            return true; // SUCCESS
        }
    } catch(e) { 
        console.error('Oura sync error:', e);
        document.getElementById('ouraBar').style.animation = ''; 
        if(user === fetchID) { 
            document.getElementById('ouraBar').innerHTML = "üíç SYNC TIMEOUT - TAP TO RETRY"; 
        }
        return false; // FAILED
    }
}


function confirmAIMeal(name, pro, carb, fat, cal, fiber, omega3, satFat, refinedCarbs) { const dk = getDateKey(selDate), meal = { name, pro, carb, fat, cal, fiber, omega3, satFat, refinedCarbs, aiLogged: true }, dayLog = saveFoodLog(dk, meal); closeModal('mealModal'); showNotification(`‚úì ${name} logged | ${dayLog.totalPro}g protein today`); render(); }
async function processPhotoWithAI(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        const imgData = e.target.result, base64Data = imgData.split(',')[1];
        document.getElementById('photoPreview').style.display = 'block';
        document.getElementById('photoPreview').innerHTML = `<img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;"><div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--border);"><div style="font-size:0.65rem; color:#888; margin-bottom:10px; text-transform:uppercase;">ü§ñ AI ANALYZING</div><div style="text-align:center; padding:20px; color:#666;"><div style="font-size:1.2rem; margin-bottom:10px; animation: pulse 1.5s infinite;">üîÑ Analyzing nutrients + bio-availability...</div></div></div>`;
        try {
            const response = await fetch("https://api.anthropic.com/v1/messages", { method: "POST", headers: { "Content-Type": "application/json", "anthropic-version": "2023-06-01" }, body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1024, messages: [{ role: "user", content: [{ type: "image", source: { type: "base64", media_type: "image/jpeg", data: base64Data } }, { type: "text", text: `Analyze this food and provide ONLY a JSON response (no markdown):\n{\n  "foods": ["specific food 1", "food 2"],\n  "description": "brief meal description",\n  "protein": grams,\n  "carbs": grams,\n  "fat": grams,\n  "fiber": grams,\n  "omega3": grams,\n  "saturatedFat": grams,\n  "refinedCarbs": grams,\n  "calories": total,\n  "portionSize": "small/medium/large",\n  "confidence": "high/medium/low"\n}` }] }] }) });
            if (!response.ok) throw new Error('AI Vision unavailable');
            const data = await response.json(), cleanJson = data.content[0].text.replace(/```json\n?|\n?```/g, '').trim(), foodData = JSON.parse(cleanJson);
            const { foods, description, protein, carbs, fat, fiber, omega3, saturatedFat, refinedCarbs, calories, portionSize, confidence } = foodData;
            const dk = getDateKey(selDate), currentLog = getFoodLog(dk), testMeals = [...currentLog.meals, { name: foods.join(' + '), time: Date.now() }], interactions = analyzeMealInteractions(testMeals, user);
            const tempLog = { totalFiber: fiber, totalOmega3: omega3, totalSatFat: saturatedFat, totalRefinedCarbs: refinedCarbs }, impacts = calculateMacroImpacts(user, tempLog);
            let impactHTML = '';
            Object.keys(impacts).forEach(biomarker => { const impact = impacts[biomarker]; if (Math.abs(impact.totalChange) > 0.1) { const color = impact.totalChange < 0 ? 'var(--green)' : 'var(--red)', symbol = impact.totalChange < 0 ? '‚Üì' : '‚Üë'; impactHTML += `<div style="padding:8px; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:6px;"><div style="display:flex; justify-content:space-between;"><span style="font-size:0.7rem; color:#888;">${labMetadata[user][biomarker]?.name || biomarker}</span><span style="font-size:0.75rem; font-weight:800; color:${color}">${symbol} ${Math.abs(impact.totalChange).toFixed(1)}</span></div></div>`; } });
            let warningsHTML = ''; interactions.warnings.forEach(w => { warningsHTML += `<div class="warning-box"><div class="warn-label">‚ö†Ô∏è ${w.severity.toUpperCase()} INTERACTION</div><div class="warn-text">${w.mechanism}</div><div class="warn-action">üí° ${w.solution}</div></div>`; });
            let synergiesHTML = ''; interactions.synergies.forEach(s => { synergiesHTML += `<div class="synergy-box"><div class="syn-label">‚úì SYNERGY DETECTED</div><div class="syn-text">${s.enhancer} + ${s.nutrient}: ${s.enhancement.toFixed(1)}x absorption boost</div></div>`; });
            document.getElementById('photoPreview').innerHTML = `<img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;"><div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--border);"><div style="display: flex; justify-content: space-between; margin-bottom:12px;"><div style="font-size:0.65rem; color:var(--green); text-transform:uppercase; font-weight:800;">‚úì IDENTIFIED</div><div style="font-size:0.6rem; padding:4px 8px; background:rgba(255,255,255,0.1); border-radius:6px;">${confidence.toUpperCase()}</div></div><div style="margin-bottom:15px;"><div style="font-size:0.9rem; font-weight:800; color:#fff; margin-bottom:5px;">${foods.join(' ‚Ä¢ ')}</div><div style="font-size:0.7rem; color:#888;">${description} (${portionSize})</div></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-bottom:15px;"><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--red)">${protein}</div><div style="font-size:0.5rem; color:#666;">PRO</div></div><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--gold)">${carbs}</div><div style="font-size:0.5rem; color:#666;">CARB</div></div><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--blue)">${fat}</div><div style="font-size:0.5rem; color:#666;">FAT</div></div><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--purple)">${calories}</div><div style="font-size:0.5rem; color:#666;">CAL</div></div></div>${impactHTML ? `<div style="padding:12px; background:rgba(255,214,10,0.05); border-left:2px solid var(--gold); border-radius:8px; margin-bottom:15px;"><div style="font-size:0.6rem; color:var(--gold); margin-bottom:8px; font-weight:800;">üìä BIOMARKER IMPACT</div>${impactHTML}</div>` : ''}${warningsHTML}${synergiesHTML}<div style="display:flex; gap:8px; margin-top:15px;"><button class="action-btn green" style="flex:1;" onclick='confirmAIMeal(${JSON.stringify(foods.join(' + '))}, ${protein}, ${carbs}, ${fat}, ${calories}, ${fiber}, ${omega3}, ${saturatedFat}, ${refinedCarbs})'>‚úì LOG</button><button class="action-btn" style="flex:1; background:rgba(255,255,255,0.1);" onclick="document.getElementById('photoInput').value=''; document.getElementById('photoPreview').style.display='none'">üì∏ RETAKE</button></div></div>`;
        } catch (error) { console.error('AI Vision Error:', error); document.getElementById('photoPreview').innerHTML = `<img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;"><div style="background:rgba(255,69,58,0.1); padding:15px; border-radius:12px; border:1px solid var(--red);"><div style="font-size:0.65rem; color:var(--red); margin-bottom:5px; text-transform:uppercase;">‚ö†Ô∏è AI ERROR</div><div style="font-size:0.75rem; color:#ddd; margin-bottom:15px;">Try again or use quick log.</div><button class="action-btn" style="background:rgba(255,255,255,0.1);" onclick="document.getElementById('photoInput').value=''; document.getElementById('photoPreview').style.display='none'">CLOSE</button></div>`; }
    };
    reader.readAsDataURL(file);
}

function openMealLogger() { 
    let quickButtons = '';
    
    // Breakfast
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üåÖ BREAKFAST</div>`;
    mealDB.b.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='logQuickMeal(${JSON.stringify(meal.name)}, ${meal.pro}, ${meal.carb}, ${meal.fat}, ${meal.cal}, ${meal.fiber}, ${meal.omega3}, ${meal.satFat}, ${meal.refinedCarbs})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // Lunch
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üåû LUNCH</div>`;
    mealDB.l.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='logQuickMeal(${JSON.stringify(meal.name)}, ${meal.pro}, ${meal.carb}, ${meal.fat}, ${meal.cal}, ${meal.fiber}, ${meal.omega3}, ${meal.satFat}, ${meal.refinedCarbs})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // Dinner
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üåô DINNER</div>`;
    mealDB.d.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='logQuickMeal(${JSON.stringify(meal.name)}, ${meal.pro}, ${meal.carb}, ${meal.fat}, ${meal.cal}, ${meal.fiber}, ${meal.omega3}, ${meal.satFat}, ${meal.refinedCarbs})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // Snacks
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üçé SNACKS</div>`;
    mealDB.s.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='logQuickMeal(${JSON.stringify(meal.name)}, ${meal.pro}, ${meal.carb}, ${meal.fat}, ${meal.cal}, ${meal.fiber}, ${meal.omega3}, ${meal.satFat}, ${meal.refinedCarbs})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    document.getElementById('quickMealButtons').innerHTML = quickButtons; 
    document.getElementById('photoPreview').style.display = 'none'; 
    document.getElementById('photoInput').value = ''; 
    openModal('mealModal'); 
}


function logQuickMeal(name, pro, carb, fat, cal, fiber, omega3, satFat, refinedCarbs) { const dk = getDateKey(selDate), meal = { name, pro, carb, fat, cal, fiber, omega3, satFat, refinedCarbs }, dayLog = saveFoodLog(dk, meal); closeModal('mealModal'); showNotification(`‚úì ${name} | ${dayLog.totalPro}g protein today`); render(); }

function openLabLogger() { 
    const baseline = baselineData[user], lastTest = baseline.lastLabTest; 
    let html = `<div class="form-group"><label class="form-label">Test Date</label><input type="date" id="labDateInput" class="form-input" value="${getDateKey(new Date())}"></div>`; 
    Object.keys(labMetadata[user]).forEach(key => { 
        const meta = labMetadata[user][key], currentVal = lastTest[key] || baseline.goals[key]; 
        html += `<div class="form-group"><label class="form-label">${meta.name} <span style="opacity:0.6; font-weight:400;">(${meta.unit || 'units'})</span></label><input type="number" step="0.1" id="lab_${key}" class="form-input" value="${currentVal}" placeholder="${baseline.goals[key]}"></div>`; 
    }); 
    html += '<button class="action-btn green" onclick="saveLabsFromForm()">‚úì SAVE TEST RESULTS</button>'; 
    document.getElementById('labModalBody').innerHTML = html; 
    openModal('labModal'); 
}

function saveLabsFromForm() { const date = document.getElementById('labDateInput').value, results = {}; Object.keys(labMetadata[user]).forEach(key => { const input = document.getElementById('lab_' + key); if (input && input.value) results[key] = parseFloat(input.value); }); saveLabTest(user, date, results); closeModal('labModal'); render(); }

function predictBurnout(ouraHistory) { if (!ouraHistory || ouraHistory.length < 7) return { risk: "LOW", action: "GATHERING DATA", trend: "0", avgScore: "-" }; const last7 = ouraHistory.slice(0, 7), scores = last7.map(d => parseInt(d.score) || 0), trend = (scores[0] - scores[6]) / 6, currentScore = scores[0]; let risk, action; if (trend < -2 || currentScore < 65) { risk = "CRITICAL"; action = "FORCE REST TODAY"; } else if (trend < -1 || currentScore < 70) { risk = "HIGH"; action = "REST WITHIN 48H"; } else if (currentScore < 75) { risk = "MODERATE"; action = "MONITOR CLOSELY"; } else { risk = "LOW"; action = "CONTINUE PROTOCOL"; } return { risk, action, trend: trend.toFixed(1), avgScore: (scores.reduce((a,b)=>a+b,0)/7).toFixed(0) }; }
function adaptSchedule(dayData, burnoutPrediction, currentScore) { if (burnoutPrediction.risk === "CRITICAL" || currentScore < 65) return { focus: "MANDATORY REST", tasks: "Active recovery only.", zT: { h: 0, m: 0 }, override: true, reason: burnoutPrediction.action }; if (burnoutPrediction.risk === "HIGH") return { focus: dayData.focus + " (MOD)", tasks: "Reduce 40%.", zT: { h: Math.round(dayData.zT.h * 0.5), m: dayData.zT.m }, override: true, reason: "Recovery" }; return { ...dayData, override: false }; }
function calculateRecoveryIndex(ouraHistory, currentScore) { if (!ouraHistory || ouraHistory.length < 3) return { score: currentScore, trend: "SYNC", advice: "Syncing...", weekAvg: "-" }; const last3 = ouraHistory.slice(0, 3), avgScore = last3.reduce((sum, d) => sum + (parseInt(d.score) || 0), 0) / 3, trend = currentScore > avgScore ? "IMPROVING" : currentScore < avgScore - 5 ? "DECLINING" : "STABLE"; let advice = ""; if (currentScore >= 85) advice = "Peak performance window."; else if (currentScore >= 75) advice = "Ready for planned intensity."; else if (currentScore >= 65) advice = "Reduce volume 20%."; else advice = "REST: Active recovery only."; return { score: currentScore, trend, advice, weekAvg: avgScore.toFixed(0) }; }
function getZoneCompliance(actual, target) { if (!target) return { pct: 0, status: "NONE", color: "#666" }; const pct = Math.round((actual / target) * 100); if (pct >= 90) return { pct, status: "PERFECT", color: "var(--green)" }; if (pct >= 70) return { pct, status: "GOOD", color: "var(--gold)" }; return { pct, status: "MISSED", color: "var(--red)" }; }
function getWeeklySummary(history) { if (!history || history.length < 7) return null; const week = history.slice(0, 7), avgReady = Math.round(week.reduce((s, d) => s + (parseInt(d.score) || 0), 0) / 7), totalCal = week.reduce((s, d) => s + (parseInt(d.cal) || 0), 0), totalHigh = week.reduce((s, d) => s + d.high, 0), perfectDays = week.filter(d => parseInt(d.score) >= 85).length; return { avgReady, totalCal, totalHigh, perfectDays }; }
function render() {
    const mon = getMon(offset), tabs = document.getElementById('dayTabs');
    tabs.innerHTML = '';
    
    // Show date immediately
    document.getElementById('dateDisplay').innerText = `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${new Date(mon.getTime() + 864e5*6).toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
    
    const labReminder = checkLabReminder(user);
    if (labReminder) { 
        document.getElementById('labReminder').innerHTML = labReminder; 
        document.getElementById('labReminder').style.display = 'block'; 
    } else document.getElementById('labReminder').style.display = 'none';
    
    const bodyScanReminder = checkBodyScanReminder(user);
    if (bodyScanReminder) { 
        document.getElementById('bodyScanReminder').innerHTML = bodyScanReminder; 
        document.getElementById('bodyScanReminder').style.display = 'block'; 
    } else document.getElementById('bodyScanReminder').style.display = 'none';
    
    for(let i=0; i<7; i++){ 
        let d = new Date(mon); 
        d.setDate(mon.getDate()+i); 
        let active = getDateKey(d) === getDateKey(selDate); 
        let t = document.createElement('div'); 
        t.className = 'tab' + (active ? ' active' : ''); 
        t.innerHTML = `${["M","T","W","T","F","S","S"][i]}<br>${d.getDate()}`; 
        t.onclick = () => { selDate = d; render(); }; 
        tabs.appendChild(t); 
        if(active) showDay(d, i+1 === 7 ? 0 : i+1); 
    }
}


function showDay(dObj, idx) {
    const dk = getDateKey(dObj), basePlan = unifiedSchedule[idx], cached = JSON.parse(localStorage.getItem(`centurion_oura_cache_${user}`)) || { history: [] }, rawOura = cached.history.find(d => d.date === dk) || { score: "-", cal: 0, high: 0, med: 0 };
    const burnout = predictBurnout(cached.history), dayData = adaptSchedule(basePlan, burnout, parseInt(rawOura.score) || 0), recovery = calculateRecoveryIndex(cached.history, parseInt(rawOura.score) || 0);
    const bodyPred = predictBodyCompositionForDate(user, dk), foodLog = getFoodLog(dk), energyBalance = calculateEnergyBalance(user, dk), weeklyEnergy = getWeeklyEnergyTrend(user), macroImpacts = calculateMacroImpacts(user, foodLog), interactions = analyzeMealInteractions(foodLog.meals, user);
    
    const burnoutAlert = burnout.risk !== "LOW" ? `<div class="premium-card" style="background:linear-gradient(135deg, rgba(255,69,58,0.2), rgba(191,90,242,0.15)); border:1px solid ${burnout.risk==='CRITICAL'?'var(--red)':'var(--gold)'}; margin-bottom:12px; padding:15px;"><div style="display:flex; align-items:center; gap:12px;"><div style="font-size:2rem;">${burnout.risk === 'CRITICAL' ? 'üö®' : '‚ö†Ô∏è'}</div><div style="flex:1;"><div style="font-size:0.7rem; font-weight:800; color:${burnout.risk==='CRITICAL'?'var(--red)':'var(--gold)'}; text-transform:uppercase;">${burnout.risk} FATIGUE</div><div style="font-size:0.75rem; color:#fff;">${burnout.action}</div></div></div></div>` : "";
    
    let bioavailHTML = '';
    if (interactions.warnings.length > 0 || interactions.synergies.length > 0) bioavailHTML = `<div class="premium-card" style="border-color:${interactions.warnings.length > 0 ? 'var(--orange)' : 'var(--green)'}; margin-bottom:12px;"><div class="card-header"><div><div class="card-title" style="color:${interactions.warnings.length > 0 ? 'var(--orange)' : 'var(--green)'}">‚öóÔ∏è BIO-AVAILABILITY</div><div class="card-subtitle">${interactions.warnings.length} warnings ‚Ä¢ ${interactions.synergies.length} synergies</div></div></div><div style="padding:0 0 10px 0;">${interactions.warnings.map(w => `<div class="warning-box"><div class="warn-label">‚ö†Ô∏è ${w.severity.toUpperCase()}: ${w.inhibitor} ‚Üî ${w.nutrient}</div><div class="warn-text">${w.mechanism}</div><div class="warn-action" style="margin-top:8px;">üí° ${w.solution}</div>${w.targetBiomarker !== 'multiple' ? `<div style="font-size:0.65rem; color:#666; margin-top:5px;">Affects: ${labMetadata[user][w.targetBiomarker]?.name || w.targetBiomarker}</div>` : ''}</div>`).join('')}${interactions.synergies.map(s => `<div class="synergy-box"><div class="syn-label">‚úì SYNERGY: ${s.enhancer} + ${s.nutrient}</div><div class="syn-text">${s.enhancement.toFixed(1)}x absorption boost ‚Ä¢ ${s.mechanism}</div>${s.targetBiomarker !== 'multiple' ? `<div style="font-size:0.65rem; color:#888; margin-top:5px;">Optimizes: ${labMetadata[user][s.targetBiomarker]?.name || s.targetBiomarker}</div>` : ''}</div>`).join('')}</div></div>`;
    
    const weekSum = getWeeklySummary(cached.history), summaryHTML = weekSum ? `<div class="premium-card" style="background:linear-gradient(135deg, rgba(10,132,255,0.15), rgba(191,90,242,0.1)); border-color:rgba(10,132,255,0.3); margin-bottom:12px;"><div style="display:flex; justify-content:space-around; text-align:center;"><div><div style="font-size:1.4rem; font-weight:900;">${weekSum.avgReady}</div><div style="font-size:0.55rem; color:#888;">AVG READY</div></div><div><div style="font-size:1.4rem; font-weight:900; color:var(--green)">${weekSum.perfectDays}/7</div><div style="font-size:0.55rem; color:#888;">PERFECT</div></div><div><div style="font-size:1.4rem; font-weight:900; color:var(--red)">${weekSum.totalHigh}m</div><div style="font-size:0.55rem; color:#888;">HIGH HR</div></div></div></div>` : "";
    
    const energyHTML = `<div class="premium-card" style="border:2px solid ${energyBalance.status==='DEFICIT'?'var(--green)':energyBalance.status==='SURPLUS'?'var(--red)':'var(--gold)'}; margin-bottom:12px; background:linear-gradient(135deg, ${energyBalance.status==='DEFICIT'?'rgba(48,209,88,0.1)':'rgba(255,69,58,0.1)'}, rgba(0,0,0,0.3));"><div class="card-header" style="margin-bottom:20px;"><div><div class="card-title" style="color:${energyBalance.status==='DEFICIT'?'var(--green)':energyBalance.status==='SURPLUS'?'var(--red)':'var(--gold)'}; font-size:0.8rem;">‚öñÔ∏è ENERGY BALANCE</div><div class="card-subtitle">${energyBalance.status} ‚Ä¢ Target: ${baselineData[user].targetDeficit}cal/day</div></div><div class="card-val-lg" style="font-size:2rem;">${energyBalance.netBalance > 0 ? '+' : ''}${energyBalance.netBalance} <span style="font-size:0.8rem; opacity:0.7;">CAL</span></div></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px;"><div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:10px; text-align:center;"><div style="font-size:0.6rem; color:#888; margin-bottom:5px;">CONSUMED</div><div style="font-size:1.3rem; font-weight:800; color:#fff;">${energyBalance.consumed}</div></div><div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:10px; text-align:center;"><div style="font-size:0.6rem; color:#888; margin-bottom:5px;">TDEE</div><div style="font-size:1.3rem; font-weight:800; color:#fff;">${energyBalance.tdee}</div></div><div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:10px; text-align:center;"><div style="font-size:0.6rem; color:#888; margin-bottom:5px;">EXERCISE</div><div style="font-size:1.3rem; font-weight:800; color:var(--red);">${energyBalance.exerciseBurn}</div></div></div><div style="padding:15px; background:rgba(0,0,0,0.3); border-radius:12px; border-left:3px solid ${energyBalance.status==='DEFICIT'?'var(--green)':'var(--red)'}; margin-bottom:12px;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><div style="font-size:0.65rem; color:#888; text-transform:uppercase;">DAILY FAT CHANGE</div><div style="font-size:1rem; font-weight:800; color:${energyBalance.dailyFatChange < 0 ? 'var(--green)' : 'var(--red)'}">${energyBalance.dailyFatChange < 0 ? '‚Üì' : '‚Üë'} ${Math.abs(energyBalance.dailyFatChange * 100).toFixed(2)}%</div></div><div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-size:0.65rem; color:#888; text-transform:uppercase;">VISCERAL FAT</div><div style="font-size:1rem; font-weight:800; color:${energyBalance.dailyVFChange < 0 ? 'var(--green)' : 'var(--red)'}">${energyBalance.dailyVFChange < 0 ? '‚Üì' : '‚Üë'} ${Math.abs(energyBalance.dailyVFChange).toFixed(2)} units</div></div></div><div style="padding:12px; background:rgba(255,214,10,0.08); border-left:2px solid var(--gold); border-radius:8px;"><div style="font-size:0.6rem; color:var(--gold); margin-bottom:5px; font-weight:800; text-transform:uppercase;">7-DAY PROJECTION</div><div style="font-size:0.8rem; color:#fff; line-height:1.5;">At ${weeklyEnergy.avgDailyBalance > 0 ? '+' : ''}${weeklyEnergy.avgDailyBalance}cal/day average: <span style="font-weight:800; color:${weeklyEnergy.projectedWeeklyFatChange < 0 ? 'var(--green)' : 'var(--red)'}">${weeklyEnergy.projectedWeeklyFatChange > 0 ? '+' : ''}${weeklyEnergy.projectedWeeklyFatChange}kg</span> fat/week</div><div style="font-size:0.65rem; color:#888; margin-top:5px; font-style:italic;">üìä 3500cal deficit = 0.454kg (1lb) fat loss</div></div></div>`;
    
    const predictionsHTML = `<div class="premium-card" style="background:linear-gradient(135deg, rgba(191,90,242,0.15), rgba(10,132,255,0.1)); border-color:rgba(191,90,242,0.3); margin-bottom:12px;"><div style="margin-bottom:15px;"><div class="card-title" style="color:var(--purple)">üìä PROJECTIONS</div><div class="card-subtitle">${bodyPred.confidence} ‚Ä¢ ${bodyPred.dataSource}</div></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;"><div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; text-align:center;"><div style="font-size:1.2rem; font-weight:800;">${bodyPred.bf}%</div><div style="font-size:0.5rem; color:#888; margin-top:2px;">BODY FAT</div></div><div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; text-align:center;"><div style="font-size:1.2rem; font-weight:800;">${bodyPred.muscle}lb</div><div style="font-size:0.5rem; color:#888; margin-top:2px;">MUSCLE</div></div><div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; text-align:center;"><div style="font-size:1.2rem; font-weight:800;">${bodyPred.vf}</div><div style="font-size:0.5rem; color:#888; margin-top:2px;">VISC FAT</div></div></div></div>`;
    
    const protocolHTML = `<div class="premium-card ${isPlanCollapsed?'collapsed':''}" onclick="isPlanCollapsed=!isPlanCollapsed;render()"><div class="card-header"><div><div class="card-title" style="color:var(--gold)">PROTOCOL</div><div class="card-subtitle">${dayData.focus}</div></div><div class="card-val-lg">${recovery.score} <span class="chevron">‚ñº</span></div></div><div class="card-body"><div style="padding:12px; background:rgba(255,255,255,0.04); border-radius:12px; border-left:3px solid ${recovery.score >= 75 ?'var(--green)':'var(--red)'}"><div style="font-size:0.8rem; color:#fff;">${recovery.advice}</div></div></div></div>`;
    
    const highComp = getZoneCompliance(rawOura.high, dayData.zT.h), medComp = getZoneCompliance(rawOura.med, dayData.zT.m);
    const workoutHTML = `<div class="premium-card ${isWorkoutCollapsed?'collapsed':''}" onclick="isWorkoutCollapsed=!isWorkoutCollapsed;render()"><div class="card-header"><div><div class="card-title" style="color:var(--red)">TRAINING</div><div class="card-subtitle">${Math.round((highComp.pct + medComp.pct) / 2)}%</div></div><div class="card-val-lg">${rawOura.cal} <span style="font-size:0.7rem; opacity:0.6">CAL</span> <span class="chevron">‚ñº</span></div></div><div class="card-body"><div style="display:flex; gap:8px;"><div style="flex:1; padding:10px; background:rgba(255,255,255,0.03); border-radius:12px; text-align:center; border:1px solid ${highComp.color}"><div style="font-size:1.2rem; font-weight:800; color:${highComp.color}">${highComp.pct}%</div><div style="font-size:0.5rem; color:#666; margin-top:2px;">HIGH</div></div><div style="flex:1; padding:10px; background:rgba(255,255,255,0.03); border-radius:12px; text-align:center; border:1px solid ${medComp.color}"><div style="font-size:1.2rem; font-weight:800; color:${medComp.color}">${medComp.pct}%</div><div style="font-size:0.5rem; color:#666; margin-top:2px;">MED</div></div></div></div></div>`;
    
const nutHTML = `<div class="premium-card ${isNutCollapsed?'collapsed':''}">
    <div class="card-header" onclick="isNutCollapsed=!isNutCollapsed;render()">
        <div>
            <div class="card-title" style="color:var(--green)">NUTRITION</div>
            <div class="card-subtitle">${foodLog.meals.length} meals</div>
        </div>
        <div class="card-val-lg">${foodLog.totalPro || 0}g <span style="font-size:0.7rem; opacity:0.6">PRO</span> <span class="chevron">‚ñº</span></div>
    </div>
    <div class="card-body">
        ${foodLog.meals.length > 0 ? `<div style="padding:12px; background:rgba(48,209,88,0.1); border-left:3px solid var(--green); border-radius:8px; margin-bottom:15px;">
            <div style="font-size:0.65rem; color:var(--green); margin-bottom:8px; font-weight:800;">‚úì LOGGED</div>
            ${foodLog.meals.map(m => `<div style="font-size:0.7rem; color:#ddd; margin-bottom:4px; display:flex; justify-content:space-between;">
                <span>${m.name}${m.aiLogged ? ' ü§ñ' : ''}</span>
                <span style="color:#888;">${m.pro}P ${m.fiber}F</span>
            </div>`).join('')}
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1);">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px;">
                    <div style="text-align:center;">
                        <div style="font-size:1rem; font-weight:800;">${foodLog.totalPro}g</div>
                        <div style="font-size:0.5rem; color:#888;">PRO</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1rem; font-weight:800;">${foodLog.totalFiber}g</div>
                        <div style="font-size:0.5rem; color:#888;">FIBER</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1rem; font-weight:800;">${foodLog.totalOmega3.toFixed(1)}g</div>
                        <div style="font-size:0.5rem; color:#888;">Œ©-3</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1rem; font-weight:800;">${foodLog.totalCal}</div>
                        <div style="font-size:0.5rem; color:#888;">CAL</div>
                    </div>
                </div>
            </div>
        </div>` : '<div style="padding:20px; text-align:center; background:rgba(255,255,255,0.02); border-radius:12px; margin-bottom:15px;"><div style="font-size:0.7rem; color:#666;">No meals logged</div></div>'}
        
        <div style="margin-bottom:12px; padding:12px; background:rgba(255,214,10,0.05); border-left:2px solid var(--gold); border-radius:8px;">
            <div style="font-size:0.6rem; color:var(--gold); margin-bottom:8px; font-weight:800;">üí° RECOMMENDED MEALS</div>
            <div style="font-size:0.7rem; color:#ddd; line-height:1.4;">
                Based on your biomarker targets:
                <div style="margin-top:8px; font-size:0.65rem; color:#aaa;">
                    ‚Ä¢ ${user === 'J' ? 'Salmon (‚ÜìApoB) ‚Ä¢ Spinach + Lemon (‚ÜëIron absorption)' : 'Wild Salmon (‚ÜìANA) ‚Ä¢ Lentils + Peppers (‚ÜëFerritin)'}
                </div>
            </div>
        </div>
        
        <button class="action-btn green" onclick="event.stopPropagation(); openMealLogger()">üì∏ LOG MEAL WITH AI</button>
    </div>
</div>`;
    const lastTest = baselineData[user].lastLabTest, testDate = new Date(lastTest.date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    let labComparisonHTML = '';
    Object.keys(labMetadata[user]).forEach(key => {
        const meta = labMetadata[user][key], currentVal = lastTest[key], pred = predictLabValueForDate(user, key, dk);
        if (currentVal && pred) {
            const delta = pred.value - currentVal, deltaPercent = ((delta / currentVal) * 100).toFixed(1), improving = meta.lowerBetter ? delta < 0 : delta > 0, goal = baselineData[user].goals[key];
            const currentPct = Math.min(meta.lowerBetter ? (goal/currentVal)*100 : (currentVal/goal)*100, 100), predPct = Math.min(meta.lowerBetter ? (goal/pred.value)*100 : (pred.value/goal)*100, 100);
            labComparisonHTML += `<div style="padding:15px; background:rgba(255,255,255,0.03); border-radius:12px; margin-bottom:12px; border:1px solid ${improving ? 'rgba(48,209,88,0.3)' : 'rgba(255,255,255,0.1)'}"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><div><div class="data-label">${meta.name}</div><div style="font-size:0.55rem; color:#666; margin-top:2px;">Goal: ${goal}${meta.unit}</div></div><div style="text-align:right;"><div style="font-size:0.65rem; color:${improving ? 'var(--green)' : delta === 0 ? '#888' : 'var(--orange)'}; font-weight:800; margin-bottom:2px;">${delta > 0 ? '+' : ''}${delta.toFixed(1)}${meta.unit}</div><div style="font-size:0.55rem; color:#666;">${deltaPercent > 0 ? '+' : ''}${deltaPercent}%</div></div></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;"><div><div style="font-size:0.55rem; color:#888; margin-bottom:5px; text-transform:uppercase;">Baseline (${testDate})</div><div style="font-size:1.1rem; font-weight:800; color:#fff; margin-bottom:5px;">${currentVal}${meta.unit}</div><div class="bar-track" style="height:6px;"><div class="bar-fill" style="width:${currentPct}%; background:${currentPct >= 100 ? 'var(--green)' : currentPct >= 70 ? 'var(--gold)' : 'var(--red)'}"></div></div></div><div><div style="font-size:0.55rem; color:var(--purple); margin-bottom:5px; text-transform:uppercase; display:flex; align-items:center; gap:5px;">Predicted (Today) <span class="prediction-badge" style="margin:0;">AI</span></div><div style="font-size:1.1rem; font-weight:800; color:${improving ? 'var(--green)' : delta === 0 ? '#fff' : 'var(--orange)'}; margin-bottom:5px;">${pred.value}${meta.unit}</div><div class="bar-track" style="height:6px;"><div class="bar-fill" style="width:${predPct}%; background:${predPct >= 100 ? 'var(--green)' : predPct >= 70 ? 'var(--gold)' : 'var(--red)'}"></div></div></div></div><div style="font-size:0.6rem; color:#666; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.05);">${pred.confidence} confidence ‚Ä¢ ${pred.dataSource.replace(/_/g, ' ').toLowerCase()}</div></div>`;
        }
    });

    const bioHTML = `<div class="premium-card ${isBioCollapsed?'collapsed':''}" onclick="isBioCollapsed=!isBioCollapsed;render()"><div class="card-header"><div><div class="card-title" style="color:var(--purple)">BIOMETRICS</div><div class="card-subtitle">Baseline vs AI-Predicted</div></div><div class="card-val-lg">${bodyPred.vf} <span style="font-size:0.7rem; opacity:0.6">VF</span> <span class="chevron">‚ñº</span></div></div><div class="card-body">${labComparisonHTML}<button class="action-btn blue" onclick="event.stopPropagation(); openLabLogger()">ü©∏ LOG TEST RESULTS</button></div></div>`;

    // CRITICAL: Actually render everything to the page!
    document.getElementById('dayContent').innerHTML = burnoutAlert + summaryHTML + energyHTML + predictionsHTML + bioavailHTML + protocolHTML + workoutHTML + nutHTML + bioHTML;
}

// ADD THIS FUNCTION after logQuickMeal() function:
async function processPhotoWithAI(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        const imgData = e.target.result, base64Data = imgData.split(',')[1];
        document.getElementById('photoPreview').style.display = 'block';
        document.getElementById('photoPreview').innerHTML = `<img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;"><div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--border);"><div style="font-size:0.65rem; color:#888; margin-bottom:10px; text-transform:uppercase;">ü§ñ AI ANALYZING</div><div style="text-align:center; padding:20px; color:#666;"><div style="font-size:1.2rem; margin-bottom:10px; animation: pulse 1.5s infinite;">üîÑ Analyzing nutrients + bio-availability...</div></div></div>`;
        try {
            const response = await fetch("https://api.anthropic.com/v1/messages", { method: "POST", headers: { "Content-Type": "application/json", "anthropic-version": "2023-06-01" }, body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1024, messages: [{ role: "user", content: [{ type: "image", source: { type: "base64", media_type: "image/jpeg", data: base64Data } }, { type: "text", text: `Analyze this food and provide ONLY a JSON response (no markdown):\n{\n  "foods": ["specific food 1", "food 2"],\n  "description": "brief meal description",\n  "protein": grams,\n  "carbs": grams,\n  "fat": grams,\n  "fiber": grams,\n  "omega3": grams,\n  "saturatedFat": grams,\n  "refinedCarbs": grams,\n  "calories": total,\n  "portionSize": "small/medium/large",\n  "confidence": "high/medium/low"\n}` }] }] }) });
            if (!response.ok) throw new Error('AI Vision unavailable');
            const data = await response.json(), cleanJson = data.content[0].text.replace(/```json\n?|\n?```/g, '').trim(), foodData = JSON.parse(cleanJson);
            const { foods, description, protein, carbs, fat, fiber, omega3, saturatedFat, refinedCarbs, calories, portionSize, confidence } = foodData;
            const dk = getDateKey(selDate), currentLog = getFoodLog(dk), testMeals = [...currentLog.meals, { name: foods.join(' + '), time: Date.now() }], interactions = analyzeMealInteractions(testMeals, user);
            const tempLog = { totalFiber: fiber, totalOmega3: omega3, totalSatFat: saturatedFat, totalRefinedCarbs: refinedCarbs }, impacts = calculateMacroImpacts(user, tempLog);
            let impactHTML = '';
            Object.keys(impacts).forEach(biomarker => { const impact = impacts[biomarker]; if (Math.abs(impact.totalChange) > 0.1) { const color = impact.totalChange < 0 ? 'var(--green)' : 'var(--red)', symbol = impact.totalChange < 0 ? '‚Üì' : '‚Üë'; impactHTML += `<div style="padding:8px; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:6px;"><div style="display:flex; justify-content:space-between;"><span style="font-size:0.7rem; color:#888;">${labMetadata[user][biomarker]?.name || biomarker}</span><span style="font-size:0.75rem; font-weight:800; color:${color}">${symbol} ${Math.abs(impact.totalChange).toFixed(1)}</span></div></div>`; } });
            let warningsHTML = ''; interactions.warnings.forEach(w => { warningsHTML += `<div class="warning-box"><div class="warn-label">‚ö†Ô∏è ${w.severity.toUpperCase()} INTERACTION</div><div class="warn-text">${w.mechanism}</div><div class="warn-action">üí° ${w.solution}</div></div>`; });
            let synergiesHTML = ''; interactions.synergies.forEach(s => { synergiesHTML += `<div class="synergy-box"><div class="syn-label">‚úì SYNERGY DETECTED</div><div class="syn-text">${s.enhancer} + ${s.nutrient}: ${s.enhancement.toFixed(1)}x absorption boost</div></div>`; });
            document.getElementById('photoPreview').innerHTML = `<img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;"><div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--border);"><div style="display: flex; justify-content: space-between; margin-bottom:12px;"><div style="font-size:0.65rem; color:var(--green); text-transform:uppercase; font-weight:800;">‚úì IDENTIFIED</div><div style="font-size:0.6rem; padding:4px 8px; background:rgba(255,255,255,0.1); border-radius:6px;">${confidence.toUpperCase()}</div></div><div style="margin-bottom:15px;"><div style="font-size:0.9rem; font-weight:800; color:#fff; margin-bottom:5px;">${foods.join(' ‚Ä¢ ')}</div><div style="font-size:0.7rem; color:#888;">${description} (${portionSize})</div></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-bottom:15px;"><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--red)">${protein}</div><div style="font-size:0.5rem; color:#666;">PRO</div></div><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--gold)">${carbs}</div><div style="font-size:0.5rem; color:#666;">CARB</div></div><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--blue)">${fat}</div><div style="font-size:0.5rem; color:#666;">FAT</div></div><div style="text-align:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;"><div style="font-size:1rem; font-weight:800; color:var(--purple)">${calories}</div><div style="font-size:0.5rem; color:#666;">CAL</div></div></div>${impactHTML ? `<div style="padding:12px; background:rgba(255,214,10,0.05); border-left:2px solid var(--gold); border-radius:8px; margin-bottom:15px;"><div style="font-size:0.6rem; color:var(--gold); margin-bottom:8px; font-weight:800;">üìä BIOMARKER IMPACT</div>${impactHTML}</div>` : ''}${warningsHTML}${synergiesHTML}<div style="display:flex; gap:8px; margin-top:15px;"><button class="action-btn green" style="flex:1;" onclick='confirmAIMeal(${JSON.stringify(foods.join(' + '))}, ${protein}, ${carbs}, ${fat}, ${calories}, ${fiber}, ${omega3}, ${saturatedFat}, ${refinedCarbs})'>‚úì LOG</button><button class="action-btn" style="flex:1; background:rgba(255,255,255,0.1);" onclick="document.getElementById('photoInput').value=''; document.getElementById('photoPreview').style.display='none'">üì∏ RETAKE</button></div></div>`;
        } catch (error) { console.error('AI Vision Error:', error); document.getElementById('photoPreview').innerHTML = `<img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;"><div style="background:rgba(255,69,58,0.1); padding:15px; border-radius:12px; border:1px solid var(--red);"><div style="font-size:0.65rem; color:var(--red); margin-bottom:5px; text-transform:uppercase;">‚ö†Ô∏è AI ERROR</div><div style="font-size:0.75rem; color:#ddd; margin-bottom:15px;">Try again or use quick log.</div><button class="action-btn" style="background:rgba(255,255,255,0.1);" onclick="document.getElementById('photoInput').value=''; document.getElementById('photoPreview').style.display='none'">CLOSE</button></div>`; }
    };
    reader.readAsDataURL(file);
}


function switchU(uID) { 
    user = uID; 
    localStorage.setItem('centurion_active_user', uID); 
    document.querySelectorAll('.u-badge').forEach(b => b.classList.toggle('active', b.id === 'b' + uID.toLowerCase())); 
    
    // Clear current display immediately
    document.getElementById('ouraBar').innerHTML = `üíç SWITCHING TO ${uID === 'J' ? 'JERMAINE' : 'SOPHIA'}...`;
    document.getElementById('ouraBar').style.animation = 'pulse 1.5s infinite';
    document.getElementById('dayContent').innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading...</div>';
    
    // Reset view
    offset = 0;
    selDate = getCaDate();
    
    // Fetch new user's Oura data, then render
    fetchOuraData().then(() => {
        render();
    });
}

async function fetchOuraData() {
    const fetchID = user;
    const token = TOKENS[fetchID];
    const range = `start_date=${getDateKey(new Date(Date.now()-864e5*14))}&end_date=${getDateKey(new Date())}`;
    
    document.getElementById('ouraBar').style.animation = 'pulse 1.5s infinite';
    document.getElementById('ouraBar').innerHTML = `üíç SYNCING ${fetchID === 'J' ? 'JERMAINE' : 'SOPHIA'}...`;
    
    try {
        const [rRes, aRes] = await Promise.all([
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${range}`)}`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            }), 
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?${range}`)}`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            })
        ]);
        
        const rData = await rRes.json();
        const aData = await aRes.json();
        
        // User switched during fetch - abort
        if(user !== fetchID) return false;
        
        if(rData.data) {
            const hist = rData.data.map(day => { 
                const act = aData.data ? aData.data.find(ac => ac.day === day.day) : null; 
                return { 
                    date: day.day, 
                    score: day.score || "-", 
                    cal: act ? act.active_calories : 0, 
                    high: act ? Math.round(act.high_activity_time/60) : 0, 
                    med: act ? Math.round(act.medium_activity_time/60) : 0 
                }; 
            }).reverse();
            
            localStorage.setItem(`centurion_oura_cache_${fetchID}`, JSON.stringify({history: hist}));
            document.getElementById('ouraBar').style.animation = '';
            document.getElementById('ouraBar').innerHTML = `üíç ${fetchID === 'J' ? 'JERMAINE' : 'SOPHIA'} READY: <span style="color:${hist[0]?.score >= 75 ? 'var(--green)' : 'var(--red)'}; font-weight:900">${hist[0]?.score || "-"}</span>`;
            
            return true;
        }
    } catch(e) { 
        console.error('Oura sync error:', e);
        document.getElementById('ouraBar').style.animation = ''; 
        if(user === fetchID) { 
            document.getElementById('ouraBar').innerHTML = "üíç SYNC TIMEOUT - TAP TO RETRY"; 
        }
        return false;
    }
}



function changeW(d) { offset += d; render(); }
function resetD() { offset = 0; selDate = getCaDate(); render(); }

// REPLACE window.onload with this:
window.onload = async () => { 
    loadBaselineData(); 
    document.querySelectorAll('.u-badge').forEach(b => b.classList.toggle('active', b.id === 'b' + user.toLowerCase()));
    
    // Always render first with cached data
    render();
    
    // Then fetch fresh Oura data in background
    fetchOuraData().then((success) => {
        if (success !== false) {
            render(); // Re-render with fresh data
        }
    });
};




</script>
</body>
</html>
