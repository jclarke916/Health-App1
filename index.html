<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v7300.0 EXPLICIT</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #000000;
            --bg-panel: #0a0a0a;
            --border: #222;
            --acid: #ccff00;
            --cyan: #00f0ff;
            --gold: #FFD60A;
            --alert: #ff453a;
            --purple: #bf5af2;
            --text-main: #ffffff;
            --text-muted: #666;
            --font-ui: 'Inter', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0 0 100px 0; background: var(--bg-deep); color: var(--text-main); font-family: var(--font-ui); min-height: 100vh; background-image: radial-gradient(circle at top right, #111 0%, #000 70%); }

        /* HEADER */
        .hud-header { padding: 15px 16px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-name { font-size: 0.6rem; font-weight: 900; letter-spacing: 2px; color: var(--text-muted); }
        .user-switch { display: flex; gap: 4px; background: #222; padding: 2px; border-radius: 20px; }
        .u-badge { padding: 6px 14px; border-radius: 16px; font-size: 0.6rem; font-weight: 700; color: #666; background: transparent; border: none; cursor: pointer; transition: all 0.2s; }
        .u-badge.active { background: var(--text-main); color: #000; }

        /* HERO */
        .hero-section { padding: 25px 16px 10px; display: flex; align-items: center; justify-content: space-between; }
        .ring-container { width: 110px; height: 110px; position: relative; display: flex; align-items: center; justify-content: center; }
        .ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
        .ring-fg { fill: none; stroke: var(--acid); stroke-width: 6; stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s ease; stroke-linecap: round; }
        .ring-data { position: absolute; text-align: center; }
        .ring-val { font-family: var(--font-data); font-size: 1.8rem; font-weight: 700; color: #fff; line-height: 1; }
        .ring-label { font-size: 0.5rem; font-weight: 700; color: var(--text-muted); margin-top: 2px; }

        .tactical-box { flex: 1; margin-left: 20px; background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, transparent 100%); border-left: 3px solid var(--acid); padding: 12px; border-radius: 0 12px 12px 0; border: 1px solid var(--border); border-left-width: 3px; }
        .tac-label { font-size: 0.55rem; color: var(--acid); font-weight: 900; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .tac-cmd { font-size: 0.8rem; font-weight: 700; color: #fff; line-height: 1.3; }
        .tac-meta { font-family: var(--font-data); font-size: 0.55rem; color: var(--text-muted); margin-top: 4px; }

        /* GRIDS */
        .section-label { font-size: 0.55rem; font-weight: 900; color: var(--text-muted); letter-spacing: 1px; margin: 20px 16px 10px; text-transform: uppercase; }
        .telemetry-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 10px; }
        .sleep-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 20px; }
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 30px; }
        
        .orb-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .orb-container { width: 60px; height: 60px; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
        .orb-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .orb-bg { fill: none; stroke: #222; stroke-width: 5; }
        .orb-fg { fill: none; stroke: var(--cyan); stroke-width: 5; stroke-dasharray: 158; stroke-dashoffset: 158; transition: stroke-dashoffset 1s ease; stroke-linecap: round; }
        .orb-val-box { position: absolute; text-align: center; }
        .orb-val { font-family: var(--font-data); font-size: 0.75rem; font-weight: 700; color: #fff; line-height: 1; }
        .orb-unit { font-size: 0.4rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .orb-label { font-size: 0.5rem; font-weight: 700; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }
        .live-dot { width: 5px; height: 5px; background: var(--alert); border-radius: 50%; position: absolute; top: 8px; right: 8px; box-shadow: 0 0 5px var(--alert); animation: pulse-fast 1s infinite; display: none; }
        .orb-card.live .live-dot { display: block; }

        /* TIMELINE */
        .timeline-container { padding: 0 16px; }
        .time-slot { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
        .ts-time { width: 45px; font-family: var(--font-data); font-size: 0.75rem; color: var(--text-muted); text-align: right; padding-top: 5px; }
        .ts-card { flex: 1; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; }
        .ts-title { font-size: 0.85rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .ts-desc { font-size: 0.75rem; color: #aaa; line-height: 1.4; }
        
        .sync-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-family: var(--font-data); font-size: 0.6rem; color: #555; z-index: 200; }
        .pulse { animation: pulse 2s infinite; display: inline-block; width: 6px; height: 6px; background: var(--acid); border-radius: 50%; margin-right: 6px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <svg style="width:0; height:0; position:absolute;" aria-hidden="true" focusable="false">
      <defs>
        <linearGradient id="grad-zone2" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#00f0ff;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#0080ff;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-zone5" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#ff453a;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#ff9f0a;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-purple" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#bf5af2;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#9d4edd;stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>

    <div class="hud-header">
        <div class="top-bar">
            <div class="app-name">CENTURION v7300</div>
            <div class="user-switch">
                <button id="btn-J" class="u-badge active" onclick="switchU('J')">JER</button>
                <button id="btn-S" class="u-badge" onclick="switchU('S')">SOPH</button>
            </div>
        </div>
    </div>

    <div id="dayContent"></div>

    <div class="sync-footer">
        <div><span class="pulse"></span><span id="ouraBar">INIT...</span></div>
        <div id="syncTime">--:--</div>
    </div>

<script>
// ==========================================
// V7300 LOGIC: EXPLICIT SWITCHING
// ==========================================

let activeUser = localStorage.getItem('centurion_active_user') || 'J';
let selDate = getCaDate(); 

const TOKENS = { 'J': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 'S': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };

function getCaDate() { let d = new Date(); d.setHours(12, 0, 0, 0); return d; }
function getDateKey(d) { return d.toISOString().split('T')[0]; }

// --- RENDER ENGINE (MUST RECEIVE UID) ---
function render(uID) {
    const dk = getDateKey(selDate);
    
    // Explicitly load cache for the passed uID, NOT global var
    const cacheKey = `centurion_oura_cache_${uID}`;
    const cached = JSON.parse(localStorage.getItem(cacheKey)) || { history: [] };
    
    // Find Data
    const rawOura = cached.history.find(d => d.date === dk) || { 
        score: "-", cal: "-", high: 0, med: 0, rhr: "-", 
        sleep: "-", deep: "-", rem: "-" 
    };
    
    const scoreVal = parseInt(rawOura.score) || 0;
    const rColor = scoreVal >= 80 ? 'var(--acid)' : scoreVal >= 60 ? 'var(--gold)' : 'var(--alert)';
    
    // UI BUILD
    const html = `
    <div class="hero-section">
        <div class="ring-container">
            <svg class="ring-svg"><circle class="ring-bg" cx="55" cy="55" r="45"></circle><circle class="ring-fg" cx="55" cy="55" r="45" style="stroke:${rColor}; stroke-dashoffset:${283 - (Math.min(scoreVal,100)/100)*283}"></circle></svg>
            <div class="ring-data"><div class="ring-val">${rawOura.score}</div><div class="ring-label">READINESS</div></div>
        </div>
        <div class="tactical-box" style="border-left-color:${rColor}">
            <div class="tac-label" style="color:${rColor}">USER: ${uID === 'J' ? 'JERMAINE' : 'SOPHIA'}</div>
            <div class="tac-cmd">${scoreVal === 0 ? "LOADING DATA..." : scoreVal >= 80 ? "SYSTEMS NOMINAL" : "RECOVERY REQUIRED"}</div>
            <div class="tac-meta">DATE: ${dk}</div>
        </div>
    </div>

    <div class="section-label">SLEEP ARCHITECTURE</div>
    <div class="sleep-grid">
        <div class="orb-card">
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:url(#grad-purple); stroke-dashoffset:${158 - (Math.min(parseFloat(rawOura.sleep)||0, 9)/9)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.sleep}</div><span class="orb-unit">HRS</span></div></div>
            <div class="orb-label">TOTAL</div>
        </div>
        <div class="orb-card">
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:#007aff; stroke-dashoffset:${158 - (Math.min(parseInt(rawOura.deep)||0, 120)/120)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.deep}</div><span class="orb-unit">DEEP</span></div></div>
            <div class="orb-label">DEEP</div>
        </div>
        <div class="orb-card">
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:var(--purple); stroke-dashoffset:${158 - (Math.min(parseInt(rawOura.rem)||0, 120)/120)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.rem}</div><span class="orb-unit">REM</span></div></div>
            <div class="orb-label">REM</div>
        </div>
    </div>

    <div class="section-label">CARDIO-METABOLIC STATUS</div>
    <div class="telemetry-grid">
        <div class="orb-card live"><div class="live-dot"></div>
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:var(--cyan); stroke-dashoffset:${158 - (Math.min(parseInt(rawOura.cal)||0, 1000)/1000)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.cal}</div><span class="orb-unit">CAL</span></div></div>
            <div class="orb-label">ACTIVE</div>
        </div>
        <div class="orb-card">
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:url(#grad-zone2); stroke-dashoffset:${158 - (Math.min(rawOura.med||0, 60)/60)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.med}</div><span class="orb-unit">Z2 MIN</span></div></div>
            <div class="orb-label">BASE</div>
        </div>
        <div class="orb-card">
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:url(#grad-zone5); stroke-dashoffset:${158 - (Math.min(rawOura.high||0, 30)/30)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.high}</div><span class="orb-unit">Z5 MIN</span></div></div>
            <div class="orb-label">PEAK</div>
        </div>
        <div class="orb-card">
            <div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:var(--acid)"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.rhr}</div><span class="orb-unit">BPM</span></div></div>
            <div class="orb-label">RHR</div>
        </div>
    </div>

    <div class="timeline-container">
        <div class="section-header"><span>CHRONO-PROTOCOL</span></div>
        <div class="time-slot"><div class="ts-time">7 AM</div><div class="ts-card"><div class="ts-title">Hydration</div><div class="ts-desc">Sea Moss Gel (2 tbsp)</div></div></div>
        <div class="time-slot"><div class="ts-time">9 AM</div><div class="ts-card"><div class="ts-title">Training</div><div class="ts-desc">Zone 2 / Strength A</div></div></div>
    </div>
    `;

    document.getElementById('dayContent').innerHTML = html;
}

// ==========================================
// EXPLICIT SWITCHING & FETCHING
// ==========================================

function switchU(uID) {
    activeUser = uID;
    localStorage.setItem('centurion_active_user', uID);
    
    // UI Update
    document.querySelectorAll('.u-badge').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${uID}`).classList.add('active');
    
    document.getElementById('ouraBar').innerHTML = `ðŸ’ SWITCHING TO ${uID}...`;
    
    // 1. WIPE CACHE
    localStorage.removeItem(`centurion_oura_cache_${uID}`);
    
    // 2. RENDER LOADING STATE (Explicitly passing uID)
    render(uID);
    
    // 3. FETCH (Passing uID explicitly)
    fetchOuraData(uID); 
}

async function fetchOuraData(fetchID) {
    // If no ID passed, use active
    if(!fetchID) fetchID = activeUser;
    
    const token = TOKENS[fetchID];
    const range = `start_date=${getDateKey(new Date(Date.now()-864e5*14))}&end_date=${getDateKey(new Date())}`;
    
    document.getElementById('ouraBar').innerHTML = "ðŸ’ HANDSHAKE...";
    
    try {
        const [rRes, aRes, sRes] = await Promise.all([
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${range}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?${range}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_sleep?${range}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);
        
        const rData = await rRes.json();
        const aData = await aRes.json();
        const sData = await sRes.json();
        
        // GUARD: If user switched while fetching, abort
        if(activeUser !== fetchID) return;
        
        if(rData.data) {
            const hist = rData.data.map(day => {
                const act = aData.data ? aData.data.find(ac => ac.day === day.day) : null;
                const slp = sData.data ? sData.data.find(sc => sc.day === day.day) : null;
                
                return { 
                    date: day.day, 
                    score: day.score || "-", 
                    cal: act ? act.active_calories : "-", 
                    high: act ? Math.round(act.high_activity_time/60) : 0, 
                    med: act ? Math.round(act.medium_activity_time/60) : 0,
                    rhr: day.contributors?.resting_heart_rate || "-",
                    sleep: slp ? (slp.total_sleep_duration/3600).toFixed(1) : "-",
                    deep: slp ? Math.round(slp.deep_sleep_duration/60) : "-",
                    rem: slp ? Math.round(slp.rem_sleep_duration/60) : "-"
                };
            }).reverse();
            
            localStorage.setItem(`centurion_oura_cache_${fetchID}`, JSON.stringify({history: hist, lastFetch: Date.now()}));
            document.getElementById('ouraBar').innerHTML = `ðŸ’ SYNCED`;
            
            // Re-render explicitly with the ID we just fetched
            render(fetchID);
        }
    } catch(e) { 
        console.error(e);
        document.getElementById('ouraBar').innerHTML = "ðŸ’ SYNC TIMEOUT"; 
        render(fetchID);
    }
}

// INIT
window.onload = () => { 
    document.getElementById(`btn-${activeUser}`).classList.add('active');
    switchU(activeUser); 
};
</script>
</body>
</html>