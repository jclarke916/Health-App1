<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v300.0 AI Core</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#050505; --card:#141414; --gold:#D4AF37; --green:#00E676; --blue:#00B0FF; --purple:#D500F9; --text:#fff;
        --g-pro:linear-gradient(90deg,#FF5252,#D50000); --g-carb:linear-gradient(90deg,#FFAB40,#FF6D00);
        --g-cal:linear-gradient(90deg,#B388FF,#6200EA); --g-fib:linear-gradient(90deg,#00E676,#00C853);}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:15px;font-size:14px}
        .container{max-width:500px;margin:0 auto; padding-bottom: 50px;}
        h1{text-align:center;font-weight:200;letter-spacing:5px;text-transform:uppercase;font-size:1.2rem;margin:10px 0}
        .version-tag { display: block; text-align: center; font-size: 0.5rem; color:#444; margin-top: -8px; margin-bottom: 15px; letter-spacing: 2px; }
        .badge-row{display:flex;justify-content:center;gap:8px;margin-bottom:15px}
        .u-badge{background:#000;padding:8px 16px;border-radius:20px;border:1px solid #333;font-size:0.6rem;font-weight:800;cursor:pointer;color:#666;transition:all 0.3s;}
        .u-badge.active{border-color:var(--gold);color:var(--gold);box-shadow:0 0 15px rgba(212,175,55,0.3);}
        .status-bar{text-align:center;color:#888;font-size:0.65rem;font-weight:800;margin-bottom:10px;text-transform:uppercase}
        .controls{display:flex;gap:5px;margin-bottom:15px}
        .nav-btn{background:#111;border:1px solid #222;color:#888;padding:10px;flex:1;border-radius:8px;font-size:0.55rem;font-weight:800;cursor:pointer;transition:all 0.2s;}
        .nav-btn:hover{background:#1a1a1a;border-color:#333;}
        .card, .macro-dashboard{background:var(--card);border-radius:20px;padding:20px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.03);position:relative}
        .card::before{content:"";position:absolute;left:0;top:20px;bottom:20px;width:3px;background:var(--gold);border-radius:0 4px 4px 0}
        .label{color:#666;font-size:0.5rem;text-transform:uppercase;font-weight:900;margin-bottom:4px; display: flex; justify-content: space-between;}
        .portion-tag { color: var(--blue); }
        .value{ font-size: 0.95rem; margin-bottom: 12px; font-weight: 500; cursor: pointer; border-bottom: 1px solid #222; padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center; transition:background 0.2s;}
        .value:hover{background:rgba(255,255,255,0.02);}
        .macro-row{margin-bottom:10px}
        .macro-label{display:flex;justify-content:space-between;font-size:0.55rem;font-weight:800;color:#777;margin-bottom:3px}
        .macro-bg{height:5px;background:#222;border-radius:10px;overflow:hidden}
        .macro-fill{height:100%;border-radius:10px;transition:width 0.8s ease}
        .tabs{display:flex;gap:4px;margin-bottom:15px}
        .tab{flex:1;padding:10px 0;background:#111;border:1px solid #222;color:#444;border-radius:8px;font-size:0.55rem;font-weight:800;text-align:center;cursor:pointer;transition:all 0.2s;}
        .tab.active{background:#222;color:#fff;border-color:#444}
        .tab:hover{background:#1a1a1a;}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;overflow-y:auto;padding:0;backdrop-filter:blur(10px);animation:fadeIn 0.3s;}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .modal-content{background:#0a0a0a;margin:0;padding:25px;border:none;border-radius:0;width:100%;min-height:100%;max-width:none;}
        .close-btn-float { position: fixed; top: 25px; right: 25px; width: 50px; height: 50px; background: #FF5252; border-radius: 50%; border: 2px solid #fff; color: #fff; font-size: 30px; text-align: center; line-height: 46px; cursor: pointer; z-index: 3000; box-shadow: 0 4px 15px rgba(0,0,0,0.8); font-weight:bold;transition:transform 0.2s;}
        .close-btn-float:hover{transform:scale(1.1);}
        .ai-insight-card{background:linear-gradient(135deg, #1a1a2e, #16213e);border:1px solid #30475e;border-radius:15px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden;}
        .ai-insight-card::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg, var(--blue), var(--purple));}
        .longevity-score-ring{width:180px;height:180px;margin:20px auto;position:relative;}
        .risk-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:0.6rem;font-weight:900;letter-spacing:1px;margin:3px;}
        .risk-low{background:rgba(0,230,118,0.2);color:var(--green);border:1px solid var(--green);}
        .risk-med{background:rgba(212,175,55,0.2);color:var(--gold);border:1px solid var(--gold);}
        .risk-high{background:rgba(255,82,82,0.2);color:#FF5252;border:1px solid #FF5252;}
        .intervention-card{background:rgba(255,255,255,0.03);border-left:3px solid var(--blue);padding:15px;margin:10px 0;border-radius:8px;transition:all 0.2s;}
        .intervention-card:hover{background:rgba(255,255,255,0.05);transform:translateX(5px);}
        .bioage-display{text-align:center;padding:25px;background:linear-gradient(135deg, rgba(0,176,255,0.1), rgba(213,0,249,0.1));border-radius:15px;margin:15px 0;border:1px solid rgba(0,176,255,0.2);}
        @keyframes pulse-glow{0%,100%{box-shadow:0 0 5px rgba(0,230,118,0.3)}50%{box-shadow:0 0 20px rgba(0,230,118,0.6)}}
        .snack-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .snack-slot { flex: 1; border: 1px dashed #333; border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer; position: relative; min-height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.02);transition:all 0.2s; }
        .snack-slot:hover{border-color:#555;background:rgba(255,255,255,0.04);}
        .snack-slot.filled { border: 1px solid var(--gold); background: #111; }
        .snack-label { font-size: 0.65rem; color: #fff; font-weight: 700; line-height: 1.2; }
        .snack-macro { font-size: 0.5rem; color: #666; margin-top: 4px; }
        .remove-snack { position: absolute; top: -5px; right: -5px; background: #FF5252; color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 20px; text-align: center; font-weight: 800;cursor:pointer;transition:transform 0.2s; }
        .remove-snack:hover{transform:scale(1.2);}
    </style>
</head>
<body>
<div class="container">
    <header><h1>THE CENTURION</h1>
        <span class="version-tag">v300.0 AI Core | Advanced Longevity Logic</span>
        <div class="badge-row">
            <div id="bj" class="u-badge active" onclick="switchU('J')">üßîüèæ‚Äç‚ôÇÔ∏è JERMAINE</div>
            <div id="bs" class="u-badge" onclick="switchU('S')">üë©üèæ‚Äçü¶± SOPHIA</div>
        </div>
    </header>
    <div id="dateDisplay" class="status-bar">Loading...</div>
    
    <!-- AI INSIGHTS DASHBOARD -->
    <div id="aiDashboard" class="ai-insight-card" style="display:none;">
        <div style="font-size:0.6rem;color:var(--blue);font-weight:900;letter-spacing:2px;margin-bottom:10px;">üß† AI LONGEVITY ANALYSIS</div>
        <div id="aiInsights"></div>
    </div>

    <div class="controls">
        <button class="nav-btn" onclick="changeW(-1)">‚óÄ PREV</button>
        <button class="nav-btn" onclick="resetD()">TODAY</button>
        <button class="nav-btn" onclick="changeW(1)">NEXT ‚ñ∂</button>
        <button class="nav-btn" onclick="openBio()" style="color:var(--green)">üìä DATA</button>
        <button class="nav-btn" onclick="toggleAI()" style="color:var(--blue)">üß† AI</button>
    </div>
    <div id="dayTabs" class="tabs"></div>
    <div id="dayContent"></div>
</div>

<div id="masterModal" class="modal" onclick="closeM(event)">
    <div class="close-btn-float" onclick="closeM()">&times;</div>
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="mTitle" style="font-size:1.5rem; margin-top:10px;"></h2>
        <div id="mSub" style="color:var(--gold);font-size:0.85rem;margin:10px 0;"></div>
        <div id="mBody"></div>
        <div id="mTip" style="margin-top:30px; padding:15px; border:1px solid #222; background:#111; border-radius:10px; color:#888; font-style:italic;"></div>
        <br><br><br>
    </div>
</div>

<script>
// ==========================================
// ADVANCED LONGEVITY LOGIC ENGINE v300.0
// ==========================================

let user = localStorage.getItem('centurion_active_user') || 'J';
let offset = 0;
let snackLog = JSON.parse(localStorage.getItem('centurion_snack_log')) || {};
let currentSlot = 0;
let aiVisible = false;

// ==========================================
// LONGEVITY SCORING ALGORITHMS
// ==========================================

const LONGEVITY_WEIGHTS = {
    vo2max: 0.25,
    apob: 0.20,
    hba1c: 0.15,
    visceral_fat: 0.15,
    muscle_mass: 0.10,
    sleep_quality: 0.10,
    grip_strength: 0.05
};

const DISEASE_RISK_MODELS = {
    cvd: (apob, hba1c, vf) => {
        let risk = 0;
        if(apob > 100) risk += 40;
        else if(apob > 80) risk += 25;
        else if(apob > 60) risk += 10;
        
        if(hba1c > 6.0) risk += 30;
        else if(hba1c > 5.5) risk += 15;
        else if(hba1c > 5.0) risk += 5;
        
        if(vf > 12) risk += 30;
        else if(vf > 9) risk += 15;
        else if(vf > 6) risk += 5;
        
        return Math.min(risk, 100);
    },
    
    metabolic: (hba1c, vf, bmr_ratio) => {
        let risk = 0;
        if(hba1c > 5.7) risk += 40;
        if(vf > 10) risk += 35;
        if(bmr_ratio < 0.9) risk += 25;
        return Math.min(risk, 100);
    }
};

function calculateBioAge(userData) {
    const chronAge = (user === 'J') ? 36 : 34;
    let bioAge = chronAge;
    
    // VO2 Max impact
    const vo2Baseline = 35;
    if(userData.tests.vo2) {
        const vo2Delta = userData.tests.vo2.val - vo2Baseline;
        bioAge -= (vo2Delta / 5) * 1.0;
    }
    
    // ApoB impact
    if(userData.labs.apob) {
        if(userData.labs.apob.val > 100) bioAge += 5;
        else if(userData.labs.apob.val > 80) bioAge += 2;
        else if(userData.labs.apob.val <= 60) bioAge -= 3;
    }
    
    // HbA1c impact
    if(userData.labs.hba1c) {
        if(userData.labs.hba1c.val > 5.7) bioAge += 4;
        else if(userData.labs.hba1c.val < 5.0) bioAge -= 2;
    }
    
    // Visceral fat impact
    const vf = userData.now.vf;
    if(vf > 12) bioAge += 6;
    else if(vf > 9) bioAge += 3;
    else if(vf <= 6) bioAge -= 2;
    
    // Muscle mass impact
    const muscleRatio = userData.now.m / userData.goal.m;
    if(muscleRatio > 1.0) bioAge -= 2;
    else if(muscleRatio < 0.9) bioAge += 3;
    
    return Math.round(bioAge * 10) / 10;
}

function calculateLongevityScore(userData) {
    let score = 50;
    
    const vo2 = userData.tests.vo2.val;
    if(vo2 >= 55) score += 15;
    else if(vo2 >= 45) score += 10;
    else if(vo2 >= 35) score += 5;
    else score -= 10;
    
    const apob = userData.labs.apob ? userData.labs.apob.val : 90;
    if(apob <= 60) score += 15;
    else if(apob <= 80) score += 8;
    else if(apob <= 100) score += 3;
    else score -= 15;
    
    const hba1c = userData.labs.hba1c ? userData.labs.hba1c.val : 5.5;
    if(hba1c < 5.0) score += 10;
    else if(hba1c < 5.5) score += 5;
    else if(hba1c > 6.0) score -= 15;
    
    const vf = userData.now.vf;
    if(vf <= 6) score += 10;
    else if(vf <= 9) score += 5;
    else if(vf > 12) score -= 10;
    
    const muscleRatio = userData.now.m / userData.goal.m;
    if(muscleRatio >= 1.0) score += 8;
    else if(muscleRatio >= 0.95) score += 4;
    else score -= 5;
    
    return Math.min(Math.max(score, 0), 100);
}

function generateInterventions(userData) {
    const interventions = [];
    
    if(userData.labs.apob && userData.labs.apob.val > 80) {
        interventions.push({
            priority: userData.labs.apob.val > 100 ? 'HIGH' : 'MEDIUM',
            category: 'Cardiovascular',
            issue: `ApoB elevated at ${userData.labs.apob.val} mg/dL`,
            action: 'Increase soluble fiber to 15g/day',
            impact: 'Reduce ApoB by 20-30 mg/dL in 12 weeks',
            foods: 'Psyllium husk, Oats, Beans, Flaxseed'
        });
    }
    
    if(userData.tests.vo2 && userData.tests.vo2.val < 45) {
        interventions.push({
            priority: 'HIGH',
            category: 'Cardiorespiratory Fitness',
            issue: `VO2 Max below optimal at ${userData.tests.vo2.val}`,
            action: 'Implement 4x4 min HIIT protocol 2x/week',
            impact: 'Increase VO2 by 10-15% in 8 weeks',
            protocol: '4 min @90% max HR, 3 min recovery'
        });
    }
    
    if(userData.now.vf > 9) {
        interventions.push({
            priority: userData.now.vf > 12 ? 'HIGH' : 'MEDIUM',
            category: 'Metabolic Health',
            issue: `Visceral fat at level ${userData.now.vf}`,
            action: 'Eliminate liquid calories & 16:8 fasting',
            impact: 'Reduce VF by 2-3 levels in 16 weeks',
            timing: 'Eating window: 12pm-8pm'
        });
    }
    
    const muscleRatio = userData.now.m / userData.goal.m;
    if(muscleRatio < 0.95) {
        interventions.push({
            priority: 'MEDIUM',
            category: 'Sarcopenia Prevention',
            issue: `Muscle mass ${Math.round(muscleRatio*100)}% of goal`,
            action: 'Increase protein to 1.2g/lb bodyweight',
            impact: 'Gain 3-5 lbs lean mass in 12 weeks',
            supplement: 'Consider creatine 5g/day'
        });
    }
    
    if(user === 'S' && userData.labs.ana && userData.labs.ana.val > 160) {
        interventions.push({
            priority: 'HIGH',
            category: 'Anti-Inflammatory Protocol',
            issue: `ANA titer elevated at ${userData.labs.ana.val}`,
            action: 'Eliminate inflammatory triggers for 30 days',
            impact: 'Reduce systemic inflammation markers',
            eliminate: 'Alcohol, Caffeine, Seed oils, Refined sugar'
        });
    }
    
    return interventions.sort((a, b) => {
        const pOrder = {HIGH: 0, MEDIUM: 1, LOW: 2};
        return pOrder[a.priority] - pOrder[b.priority];
    });
}

function predictLifespan(userData) {
    let baseLife = 78;
    
    const vo2 = userData.tests.vo2.val;
    if(vo2 >= 55) baseLife += 12;
    else if(vo2 >= 50) baseLife += 8;
    else if(vo2 >= 45) baseLife += 5;
    else if(vo2 >= 40) baseLife += 2;
    else if(vo2 < 30) baseLife -= 8;
    
    if(userData.labs.apob) {
        if(userData.labs.apob.val <= 60) baseLife += 8;
        else if(userData.labs.apob.val <= 80) baseLife += 4;
        else if(userData.labs.apob.val > 120) baseLife -= 10;
    }
    
    if(userData.labs.hba1c) {
        if(userData.labs.hba1c.val < 5.0) baseLife += 5;
        else if(userData.labs.hba1c.val > 6.5) baseLife -= 8;
    }
    
    if(userData.now.vf <= 6) baseLife += 5;
    else if(userData.now.vf > 15) baseLife -= 6;
    
    if(userData.tests.hang && userData.tests.hang.val >= 120) baseLife += 4;
    
    return Math.min(baseLife, 100);
}

// ==========================================
// DATA STORES
// ==========================================

const mDB = {
    b: [
        "Beef & Liver Sausage|80/20 Beef-Liver,Sage,Blueberries|sear|HIGH BIOAVAILABILITY|25|8|280|15",
        "Avocado Egg Toast|Ezekiel Bread,Avocado,Egg Whites|toast|FIBER + HEALTHY FATS|35|30|450|12",
        "Oat Protein Pancakes|Oat Flour,Whey Isolate,Blueberries|griddle|SLOW RELEASE CARBS|35|25|380|6"
    ],
    l: [
        "Ground Beef & Lentils|96% Lean Beef,Black Lentils,Broccoli|sear|PROTEIN + FIBER|50|25|550|15",
        "Chicken Artichoke Salad|Chicken Breast,Artichoke,Arugula|sear|LIVER DETOX|40|15|420|10",
        "Seared Salmon Salad|Sockeye Salmon,Spinach,Avocado|sear|OMEGA-3|38|12|480|22"
    ],
    d: [
        "Bison Portobello Burger|Ground Bison,Portobello,Avocado|sear|HIGH PROTEIN|45|8|480|22",
        "Filet & Lentils|Filet Mignon,Black Lentils,Asparagus|sear|IRON + FIBER|45|25|520|18",
        "Halibut White Beans|Halibut,Cannellini Beans,Kale|bake|LEAN PROTEIN|38|20|420|10"
    ],
    s: [
        "Beef Isolate Shake|Beef Isolate Protein,Water|shake|COLLAGEN|25|0|110|0",
        "Sardines|Sardines,Lemon|raw|OMEGA-3|22|0|190|10",
        "Avocado Cup|1/2 Avocado,Sea Salt|raw|HEALTHY FATS|2|8|160|15",
        "Bone Broth|Bone Broth,Turmeric|heat|GUT HEALING|10|0|50|0",
        "Hard Boiled Eggs|2 Eggs|boil|CHOLINE|12|1|140|10"
    ]
};

var defaultUH = {
    'J': {
        now: {bf:19.0, m:99.0, w:217.0, vf:10, bmr:2050}, 
        goal: {bf:15.0, m:105.0, w:212.0, vf:7, bmr:2150},
        labs: {
            apob:{val:95,goal:60,unit:"mg/dL",name:"ApoB",lowerIsBetter:true},
            hba1c:{val:5.4,goal:5.0,unit:"%",name:"HbA1c",lowerIsBetter:true}
        },
        tests: {
            vo2:{val:45,goal:55,unit:"ml/kg",name:"VO2 Max"},
            hang:{val:85,goal:120,unit:"s",name:"Dead Hang"}
        }
    },
    'S': {
        now: {bf:36.1, m:49.2, w:141.5, vf:9, bmr:1250},
        goal: {bf:22.0, m:60.0, w:135.0, vf:4, bmr:1450}, 
        labs: {
            ana:{val:320,goal:40,unit:" titer",name:"ANA",lowerIsBetter:true},
            gluc:{val:84,goal:75,unit:"mg/dL",name:"Glucose",lowerIsBetter:true}
        },
        tests: {
            vo2:{val:32,goal:50,unit:"ml/kg",name:"VO2 Max"},
            hang:{val:40,goal:90,unit:"s",name:"Dead Hang"}
        },
        streak: 0
    }
};

var uH = JSON.parse(localStorage.getItem('centurion_bio_v2'));
if (!uH || !uH['J'].labs || !uH['J'].tests) {
    uH = JSON.parse(JSON.stringify(defaultUH));
    localStorage.setItem('centurion_bio_v2', JSON.stringify(uH));
}

// ==========================================
// AI DASHBOARD
// ==========================================

function toggleAI() {
    aiVisible = !aiVisible;
    const dash = document.getElementById('aiDashboard');
    if(aiVisible) {
        dash.style.display = 'block';
        renderAIDashboard();
    } else {
        dash.style.display = 'none';
    }
}

function renderAIDashboard() {
    const userData = uH[user];
    const bioAge = calculateBioAge(userData);
    const chronAge = (user === 'J') ? 36 : 34;
    const longevityScore = calculateLongevityScore(userData);
    const predictedLife = predictLifespan(userData);
    const interventions = generateInterventions(userData);
    
    const cvdRisk = DISEASE_RISK_MODELS.cvd(
        userData.labs.apob ? userData.labs.apob.val : 90,
        userData.labs.hba1c ? userData.labs.hba1c.val : 5.5,
        userData.now.vf
    );
    
    let html = `
        <div class="bioage-display">
            <div style="font-size:0.6rem;color:#888;margin-bottom:5px;">BIOLOGICAL AGE</div>
            <div style="font-size:3rem;font-weight:900;color:${bioAge < chronAge ? 'var(--green)' : '#FF5252'}">${bioAge}</div>
            <div style="font-size:0.7rem;color:#666;margin-top:5px;">
                Chronological: ${chronAge} 
                <span style="color:${bioAge < chronAge ? 'var(--green)' : '#FF5252'};margin-left:10px;">
                    ${bioAge < chronAge ? '‚Üì' : '‚Üë'} ${Math.abs(bioAge - chronAge).toFixed(1)} years
                </span>
            </div>
        </div>

        <div class="longevity-score-ring">
            <svg viewBox="0 0 200 200" style="transform:rotate(-90deg)">
                <circle cx="100" cy="100" r="85" fill="none" stroke="#222" stroke-width="15"/>
                <circle cx="100" cy="100" r="85" fill="none" 
                    stroke="${longevityScore >= 80 ? 'var(--green)' : longevityScore >= 60 ? 'var(--gold)' : '#FF5252'}" 
                    stroke-width="15" 
                    stroke-dasharray="${(longevityScore/100) * 534} 534"
                    stroke-linecap="round"
                    style="transition:stroke-dasharray 1s ease"/>
            </svg>
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
                <div style="font-size:2.5rem;font-weight:900;color:#fff;">${longevityScore}</div>
                <div style="font-size:0.6rem;color:#666;font-weight:800;">LONGEVITY SCORE</div>
            </div>
        </div>

        <div style="text-align:center;margin:20px 0;padding:15px;background:rgba(0,176,255,0.1);border-radius:10px;">
            <div style="font-size:0.7rem;color:#888;margin-bottom:5px;">PROJECTED LIFESPAN</div>
            <div style="font-size:2rem;font-weight:800;color:var(--blue);">${predictedLife} <span style="font-size:1rem;color:#666;">years</span></div>
            <div style="font-size:0.65rem;color:#666;margin-top:5px;">Based on current biomarkers</div>
        </div>

        <div style="margin:20px 0;">
            <div style="font-size:0.75rem;font-weight:900;color:var(--gold);margin-bottom:15px;">DISEASE RISK PROFILE</div>
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <div style="flex:1;background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;">
                    <div style="font-size:0.6rem;color:#888;margin-bottom:5px;">CVD RISK</div>
                    <div style="font-size:1.5rem;font-weight:800;color:${cvdRisk < 30 ? 'var(--green)' : cvdRisk < 60 ? 'var(--gold)' : '#FF5252'}">${cvdRisk}%</div>
                    <div class="risk-badge ${cvdRisk < 30 ? 'risk-low' : cvdRisk < 60 ? 'risk-med' : 'risk-high'}">${cvdRisk < 30 ? 'LOW' : cvdRisk < 60 ? 'MODERATE' : 'HIGH'}</div>
                </div>
            </div>
        </div>

        <div style="margin:25px 0;">
            <div style="font-size:0.75rem;font-weight:900;color:var(--purple);margin-bottom:15px;">üéØ PRIORITY INTERVENTIONS</div>`;
    
    interventions.slice(0, 3).forEach(int => {
        html += `
            <div class="intervention-card" style="border-color:${int.priority === 'HIGH' ? '#FF5252' : int.priority === 'MEDIUM' ? 'var(--gold)' : 'var(--blue)'};">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <span style="font-size:0.7rem;font-weight:900;color:#fff;">${int.category}</span>
                    <span class="risk-badge ${int.priority === 'HIGH' ? 'risk-high' : int.priority === 'MEDIUM' ? 'risk-med' : 'risk-low'}">${int.priority}</span>
                </div>
                <div style="font-size:0.65rem;color:#888;margin-bottom:8px;">${int.issue}</div>
                <div style="font-size:0.75rem;color:var(--blue);font-weight:700;margin-bottom:5px;">‚Üí ${int.action}</div>
                <div style="font-size:0.6rem;color:#666;font-style:italic;">Expected: ${int.impact}</div>
            </div>`;
    });
    
    html += `</div>`;
    
    document.getElementById('aiInsights').innerHTML = html;
}

// ==========================================
// CORE FUNCTIONS
// ==========================================

function getCaDate() {
    let d = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
    d.setHours(12, 0, 0, 0); 
    return d;
}

function getDateKey(d) {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

let selDate = getCaDate();

function switchU(uID){ 
    user = uID;
    localStorage.setItem('centurion_active_user', uID);
    document.querySelectorAll('.u-badge').forEach(b => b.classList.remove('active')); 
    document.getElementById('b' + uID.toLowerCase()).classList.add('active'); 
    if(aiVisible) renderAIDashboard();
    render(); 
}

function getMon(o){ 
    let d = getCaDate(); 
    d.setHours(0,0,0,0); 
    let day = d.getDay(); 
    let diff = d.getDate() - day + (day === 0 ? -6 : 1); 
    d.setDate(diff + (o * 7)); 
    return d; 
}

function changeW(direction) {
    offset += direction;
    let viewMon = getMon(offset); 
    selDate = new Date(viewMon);
    selDate.setDate(selDate.getDate() + 3); // Mid-week
    selDate.setHours(12, 0, 0, 0);
    render(); 
}

function resetD() { 
    offset = 0; 
    selDate = getCaDate(); 
    render(); 
}

function render() {
    const mon = getMon(offset);
    const days = ["MON","TUE","WED","THU","FRI","SAT","SUN"];
    const tabs = document.getElementById('dayTabs');
    tabs.innerHTML = '';
    const end = new Date(mon);
    end.setDate(mon.getDate() + 6);
    document.getElementById('dateDisplay').innerText = `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${end.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
    
    for(let i = 0; i < 7; i++) {
        let d = new Date(mon);
        d.setDate(mon.getDate() + i);
        const isSelected = getDateKey(d) === getDateKey(selDate);
        const b = document.createElement('div'); 
        b.className = 'tab' + (isSelected ? ' active' : '');
        b.innerHTML = `${days[i]}<br>${d.getDate()}`;
        b.onclick = () => { selDate = d; render(); }; 
        tabs.appendChild(b);
        if(isSelected) showDay(d, i);
    }
}

function showDay(dObj, idx) {
    const id = Math.floor(dObj.getTime() / 864e5);
    const dateKey = getDateKey(dObj);
    if(!snackLog[dateKey]) snackLog[dateKey] = [null, null];
    const snacks = snackLog[dateKey];
    
    let b = mDB.b[Math.abs(id) % mDB.b.length].split('|');
    let l = mDB.l[Math.abs(id) % mDB.l.length].split('|');
    let dn = mDB.d[Math.abs(id) % mDB.d.length].split('|');
    
    const g = (user === 'J') ? {P:165, C:85, F:40, K:1800} : {P:105, C:55, F:35, K:1300};
    const sc = (user === 'J') ? 1 : 0.6;

    let sPro = 0, sCarb = 0, sFib = 0, sCal = 0;
    snacks.forEach(sIdx => {
        if(sIdx !== null) {
            let sData = mDB.s[sIdx].split('|');
            sPro += parseInt(sData[4]); 
            sCarb += parseInt(sData[5]); 
            sCal += parseInt(sData[6]);
            sFib += parseInt(sData[7] || 0);
        }
    });

    let p = Math.round((parseInt(b[4]) + parseInt(l[4]) + parseInt(dn[4])) * sc) + sPro;
    let c = Math.round((parseInt(b[5]) + parseInt(l[5]) + parseInt(dn[5])) * sc) + sCarb;
    let k = Math.round((parseInt(b[6]) + parseInt(l[6]) + parseInt(dn[6])) * sc) + sCal;
    let f = Math.round((parseInt(b[7]||0) + parseInt(l[7]||0) + parseInt(dn[7]||0)) * sc) + sFib;

    let ptn = (user === 'J') ? {b:'Large', l:'8oz', d:'8oz'} : {b:'Small', l:'5oz', d:'5oz'};

    let snackHTML = '<div class="snack-grid">';
    for(let i = 0; i < 2; i++) {
        if(snacks[i] === null) {
            snackHTML += `<div class="snack-slot" onclick="openSnackSelector(${i})"><span style="font-size:1.2rem; color:#333;">Ôºã</span><br><span class="snack-label" style="color:#666;">ADD SNACK</span></div>`;
        } else {
            let s = mDB.s[snacks[i]].split('|');
            snackHTML += `<div class="snack-slot filled"><div class="remove-snack" onclick="event.stopPropagation(); removeSnack(${i})">‚úï</div><span class="snack-label">${s[0]}</span><span class="snack-macro">${s[4]}P ${s[7]||0}F</span></div>`;
        }
    }
    snackHTML += '</div>';

    document.getElementById('dayContent').innerHTML = `
        <div class="label">üç≥ Breakfast <span class="portion-tag">‚Ä¢ ${ptn.b}</span></div>
        <div class="value">
            <span>${b[0]}</span> <span style="font-size:0.6rem;color:#666">${Math.round(b[4]*sc)}P ${b[7]||0}F</span>
        </div>

        <div class="label">ü•ó Lunch <span class="portion-tag">‚Ä¢ ${ptn.l}</span></div>
        <div class="value">
            <span>${l[0]}</span> <span style="font-size:0.6rem;color:#666">${Math.round(l[4]*sc)}P ${l[7]||0}F</span>
        </div>

        <div class="label">üçΩÔ∏è Dinner <span class="portion-tag">‚Ä¢ ${ptn.d}</span></div>
        <div class="value">
            <span>${dn[0]}</span> <span style="font-size:0.6rem;color:#666">${Math.round(dn[4]*sc)}P ${dn[7]||0}F</span>
        </div>

        <div class="label">ü•ú Snack Options</div>
        ${snackHTML}

        <div class="macro-dashboard">
            <div class="macro-row"><div class="macro-label"><span>PROTEIN</span><span>${p}g / ${g.P}g</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((p/g.P)*100,100)}%; background:var(--g-pro)"></div></div></div>
            <div class="macro-row"><div class="macro-label"><span style="color:var(--green)">FIBER</span><span>${f}g / ${g.F}g</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((f/g.F)*100,100)}%; background:var(--g-fib)"></div></div></div>
            <div class="macro-row"><div class="macro-label"><span>CARBS</span><span>${c}g / ${g.C}g</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((c/g.C)*100,100)}%; background:var(--g-carb)"></div></div></div>
            <div class="macro-row"><div class="macro-label"><span>CALORIES</span><span>${k} / ${g.K}</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((k/g.K)*100,100)}%; background:var(--g-cal)"></div></div></div>
        </div>`;
}

function openSnackSelector(slotIdx) {
    currentSlot = slotIdx;
    document.getElementById('mTitle').innerText = "SELECT SNACK";
    document.getElementById('mSub').innerText = "SLOT " + (slotIdx + 1);
    let html = '';
    mDB.s.forEach((item, index) => {
        let s = item.split('|');
        html += `<div class="value" onclick="applySnack(${index})">
            ${s[0]} <span style="float:right;font-size:0.7rem;color:#666">${s[4]}P</span>
        </div>`;
    });
    document.getElementById('mBody').innerHTML = html;
    document.getElementById('mTip').innerText = "Choose high-protein options on training days";
    document.getElementById('masterModal').style.display = 'block';
}

function applySnack(snackIndex) {
    const dateKey = getDateKey(selDate);
    if(!snackLog[dateKey]) snackLog[dateKey] = [null, null];
    snackLog[dateKey][currentSlot] = snackIndex;
    localStorage.setItem('centurion_snack_log', JSON.stringify(snackLog));
    document.getElementById('masterModal').style.display = 'none';
    render();
}

function removeSnack(slotIdx) {
    const dateKey = getDateKey(selDate);
    if(snackLog[dateKey]) {
        snackLog[dateKey][slotIdx] = null;
        localStorage.setItem('centurion_snack_log', JSON.stringify(snackLog));
        render();
    }
}

function openBio() {
    document.getElementById('mTitle').innerHTML = (user === 'J' ? "JERMAINE" : "SOPHIA") + " - BIOMETRICS";
    document.getElementById('mSub').innerText = "Clinical Metrics";
    
    const userData = uH[user];
    const bioAge = calculateBioAge(userData);
    const chronAge = (user === 'J') ? 36 : 34;
    const longevityScore = calculateLongevityScore(userData);
    
    let html = `
        <div style="text-align:center;padding:20px;background:linear-gradient(135deg,#111,#000);border-radius:12px;margin-bottom:20px;">
            <div style="font-size:0.7rem;color:#666;margin-bottom:10px;">LONGEVITY SCORE</div>
            <div style="font-size:3rem;font-weight:900;color:${longevityScore >= 80 ? 'var(--green)' : longevityScore >= 60 ? 'var(--gold)' : '#FF5252'}">${longevityScore}</div>
            <div style="font-size:0.65rem;color:#888;margin-top:8px;">Bio Age: ${bioAge} | Chron Age: ${chronAge}</div>
        </div>
        <div style="font-size:0.8rem;font-weight:900;color:var(--gold);margin:20px 0;">KEY METRICS</div>`;
    
    Object.keys(userData.labs).forEach(key => {
        const m = userData.labs[key];
        const onTrack = m.lowerIsBetter ? m.val <= m.goal : m.val >= m.goal;
        html += `<div style="margin:15px 0;padding:15px;background:rgba(255,255,255,0.03);border-radius:10px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="font-weight:800;">${m.name}</span>
                <span style="color:${onTrack ? 'var(--green)' : '#FF5252'};font-weight:800;">${m.val} ${m.unit}</span>
            </div>
            <div style="font-size:0.65rem;color:#666;">Goal: ${m.goal} ${m.unit}</div>
        </div>`;
    });
    
    html += `<div style="font-size:0.8rem;font-weight:900;color:var(--blue);margin:20px 0;">PERFORMANCE TESTS</div>`;
    
    Object.keys(userData.tests).forEach(key => {
        const m = userData.tests[key];
        const onTrack = m.val >= m.goal;
        html += `<div style="margin:15px 0;padding:15px;background:rgba(255,255,255,0.03);border-radius:10px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="font-weight:800;">${m.name}</span>
                <span style="color:${onTrack ? 'var(--green)' : '#FF5252'};font-weight:800;">${m.val} ${m.unit}</span>
            </div>
            <div style="font-size:0.65rem;color:#666;">Goal: ${m.goal} ${m.unit}</div>
        </div>`;
    });
    
    document.getElementById('mBody').innerHTML = html;
    document.getElementById('mTip').innerText = "Update metrics monthly for accurate tracking";
    document.getElementById('masterModal').style.display = 'block';
}

function closeM(e) { 
    if (!e || e.target.className === 'modal' || e.target.className === 'close-btn-float') {
        document.getElementById('masterModal').style.display = 'none'; 
    }
}

window.onload = function() {
    render();
    document.querySelectorAll('.u-badge').forEach(b => b.classList.remove('active')); 
    document.getElementById('b' + user.toLowerCase()).classList.add('active');
// 1. RESTORE WORKOUT MODAL
function openRecoveryPhase(workout) {
    const p = {
        "HEAVY LIFT":[{h:"Theragun",d:"Target large chains."},{h:"Main Lifts",d:"Compound movements."},{h:"Sauna",d:"20m Heat stress."}],
        "BOXING":[{h:"Mobility",d:"Shoulder/Hip focus."},{h:"Boxing",d:"High output intervals."},{h:"Normatec",d:"Flush legs."}],
        "RELAX":[{h:"Walk",d:"Nature exposure."},{h:"Active",d:"Low HR movement."},{h:"Chair",d:"Zero gravity."}]
    };
    const active = p[workout] || p["RELAX"];
    document.getElementById('mTitle').innerText = workout + " PROTOCOL";
    document.getElementById('mSub').innerText = "RECOVERY FLOW";
    document.getElementById('mBody').innerHTML = `
        <div class="intervention-card" style="border-left-color:var(--blue)"><strong>PRE:</strong> ${active[0].h}</div>
        <div class="intervention-card" style="border-left-color:white"><strong>TRAIN:</strong> ${active[1].h}</div>
        <div class="intervention-card" style="border-left-color:var(--purple)"><strong>POST:</strong> ${active[2].h}</div>
    `;
    document.getElementById('masterModal').style.display = 'block';
}

// 2. RESTORE MEAL MODAL (AI Prompting)
function openR(n, i, a, t) {
    document.getElementById('mTitle').innerText = n;
    document.getElementById('mSub').innerText = "CENTURION RECIPE";
    const clean = n.replace(/[^a-zA-Z ]/g, "").trim();
    const prompt = encodeURIComponent(`delicious high-end plated ${clean} food photography`);
    document.getElementById('mBody').innerHTML = `
        <img src="https://image.pollinations.ai/prompt/${prompt}?nologo=true" style="width:100%; border-radius:15px; margin-bottom:15px;">
        <p style="color:#ccc; line-height:1.6">${t}</p>
    `;
    document.getElementById('masterModal').style.display = 'block';
}

// 3. RESTORE OURA SYNC (proxy logic)
async function fetchOuraData() {
    const token = user === 'J' ? 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y' : '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4';
    try {
        const res = await fetch("https://corsproxy.io/?" + encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${getDateKey(new Date(Date.now()-864e5*3))}&end_date=${getDateKey(new Date())}`), {headers:{'Authorization':`Bearer ${token}`}});
        const j = await res.json();
        if(j.data) {
            const score = j.data[j.data.length-1].score;
            document.getElementById('dateDisplay').innerHTML = `<span style="color:var(--green)">üíç OURA READINESS: ${score}</span>`;
        }
    } catch(e) { document.getElementById('dateDisplay').innerText = "Sync Ready"; }
};
</script>
</body>
</html>