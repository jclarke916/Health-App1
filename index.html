<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v10001 BLACK BOX</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --text: #fff; --acid: #ccff00; --cyan: #00f0ff; --alert: #ff453a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0 0 100px 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; min-height: 100vh; }

        /* HEADER */
        .hud-header { padding: 15px 16px; background: rgba(0,0,0,0.9); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-name { font-size: 0.6rem; font-weight: 900; letter-spacing: 2px; color: #666; }
        .user-switch { display: flex; gap: 4px; background: #222; padding: 2px; border-radius: 20px; }
        .u-badge { padding: 6px 14px; border-radius: 16px; font-size: 0.6rem; font-weight: 700; color: #666; background: transparent; border: none; cursor: pointer; }
        .u-badge.active { background: #fff; color: #000; }
        .bio-btn { background: #222; border: 1px solid #333; color: #888; padding: 4px 8px; border-radius: 8px; font-size: 0.55rem; font-weight: 700; margin-right: 10px; }

        /* NAV & UI */
        .date-nav { display: flex; justify-content: center; gap: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 700; color: #fff; padding-top: 5px; }
        .hero-section { padding: 25px 16px 10px; display: flex; align-items: center; justify-content: space-between; }
        .ring-container { width: 110px; height: 110px; position: relative; display: flex; align-items: center; justify-content: center; }
        .ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-bg { fill: none; stroke: #222; stroke-width: 6; }
        .ring-fg { fill: none; stroke: var(--acid); stroke-width: 6; stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s ease; stroke-linecap: round; }
        .ring-data { position: absolute; text-align: center; }
        .ring-val { font-family: 'JetBrains Mono'; font-size: 1.8rem; font-weight: 700; line-height: 1; }
        .ring-label { font-size: 0.5rem; font-weight: 700; color: #666; margin-top: 2px; }
        
        .tactical-box { flex: 1; margin-left: 20px; border-left: 3px solid var(--acid); padding: 12px; background: #0a0a0a; border-radius: 0 12px 12px 0; }
        .tac-cmd { font-size: 0.8rem; font-weight: 700; line-height: 1.3; }

        /* AI CARD */
        .ai-insight-card { background: #081018; border: 1px solid #004455; border-radius: 12px; padding: 15px; margin: 15px 16px; min-height: 80px; }
        .ai-header { display: flex; gap: 8px; margin-bottom: 10px; font-size: 0.65rem; color: var(--cyan); font-weight: 900; }
        .ai-content { font-size: 0.75rem; line-height: 1.5; color: #ccc; }

        /* GRIDS */
        .section-label { font-size: 0.55rem; font-weight: 900; color: #666; margin: 20px 16px 10px; }
        .orb-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 20px; }
        .orb-card { background: #0a0a0a; border: 1px solid #222; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .orb-val { font-family: 'JetBrains Mono'; font-size: 0.9rem; font-weight: 700; }
        .orb-label { font-size: 0.5rem; font-weight: 700; color: #666; margin-top: 4px; }

        /* FOOTER & LOGS */
        .sync-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; padding: 12px 16px; border-top: 1px solid #222; display: flex; justify-content: space-between; align-items: center; font-family: 'JetBrains Mono'; font-size: 0.6rem; color: #555; z-index: 200; }
        #error-log { color: var(--alert); font-size: 10px; padding: 10px; white-space: pre-wrap; display: none; }
        .reset-btn { background: #220000; border: 1px solid var(--alert); color: var(--alert); padding: 4px 8px; font-size: 0.6rem; cursor: pointer; }
    </style>
</head>
<body>

    <div class="hud-header">
        <div class="top-bar">
            <div class="app-name">CENTURION v10001</div>
            <div>
                <button class="bio-btn" onclick="centurion.openBio()">BIO</button>
                <div class="user-switch" style="display:inline-flex">
                    <button id="btn-jermaine" class="u-badge active" onclick="centurion.switchUser('jermaine')">JER</button>
                    <button id="btn-sophia" class="u-badge" onclick="centurion.switchUser('sophia')">SOPH</button>
                </div>
            </div>
        </div>
        <div class="date-nav">
            <span id="dateDisplay">TODAY</span>
        </div>
    </div>

    <div id="error-log"></div>

    <div id="dayContent">
        <div style="padding:40px; text-align:center; color:#444;">INITIALIZING SYSTEMS...</div>
    </div>

    <div class="sync-footer">
        <div id="statusIndicator">Ready</div>
        <button class="reset-btn" onclick="centurion.hardReset()">RESET DATA</button>
    </div>

<script>
// --- GLOBAL ERROR CATCHER ---
window.onerror = function(msg, url, line) {
    const el = document.getElementById('error-log');
    el.style.display = 'block';
    el.innerHTML += `CRASH: ${msg} (Line ${line})\n`;
    return false;
};

// --- CONFIG ---
const TOKENS = { 'jermaine': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 'sophia': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };
const GEMINI_API_KEY = "AIzaSyCHZvxl_YvhDxZQFuZ1RuriCFasaKSDero"; 

const USERS = {
    'jermaine': { name: "Jermaine", goals: { pro: 180, omega3: 3000 } },
    'sophia': { name: "Sophia", goals: { pro: 120, omega3: 2500 } }
};

// --- SAFE PARSER ---
function safeJsonParse(str) {
    try {
        if (!str) return null;
        return JSON.parse(str);
    } catch (e) {
        console.error("Corrupt JSON found and ignored.");
        return null;
    }
}

function getDateKey(d) { return d.toISOString().split('T')[0]; }

class CenturionCore {
    constructor() {
        this.user = 'jermaine'; // Default safe start
        
        try {
            // Load saved user
            const savedUser = localStorage.getItem('centurion_active_user');
            if(savedUser && USERS[savedUser]) this.user = savedUser;

            // Load Cache safely
            this.cache = safeJsonParse(localStorage.getItem(`centurion_oura_cache_${this.user}`)) || { history: [] };
            if (!Array.isArray(this.cache.history)) this.cache = { history: [] };

            this.aiInsights = safeJsonParse(localStorage.getItem(`centurion_ai_insights_${this.user}`)) || {};
            
        } catch(e) {
            document.getElementById('error-log').innerHTML = "Storage Error: " + e.message;
            this.cache = { history: [] };
        }

        this.init();
    }

    init() {
        this.updateUI();
        this.render();
        this.fetchOuraData();
    }

    hardReset() {
        if(confirm("Wipe all app data and restart?")) {
            localStorage.clear();
            window.location.reload();
        }
    }

    switchUser(uID) {
        this.user = uID;
        localStorage.setItem('centurion_active_user', uID);
        this.cache = safeJsonParse(localStorage.getItem(`centurion_oura_cache_${uID}`)) || { history: [] };
        this.aiInsights = safeJsonParse(localStorage.getItem(`centurion_ai_insights_${uID}`)) || {};
        this.updateUI();
        this.render();
        this.fetchOuraData();
    }

    updateUI() {
        document.querySelectorAll('.u-badge').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-${this.user}`);
        if(btn) btn.classList.add('active');
    }

    async fetchOuraData() {
        const status = document.getElementById('statusIndicator');
        status.innerText = "Syncing...";
        
        const token = TOKENS[this.user];
        const today = new Date();
        const start = new Date(); start.setDate(start.getDate() - 7);
        const urlParams = `start_date=${getDateKey(start)}&end_date=${getDateKey(today)}`;

        try {
            const [rRes, sRes] = await Promise.all([
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${urlParams}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?${urlParams}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            const rData = await rRes.json();
            const sData = await sRes.json();

            if (rData.data) {
                // Process Data with YESTERDAY Logic
                const hist = rData.data.map(day => {
                    // Calc Yesterday
                    const d = new Date(day.day);
                    d.setDate(d.getDate() - 1);
                    const prevKey = getDateKey(d);

                    // Find sleep from yesterday
                    let sessions = sData.data ? sData.data.filter(s => s.day === prevKey) : [];
                    // Fallback to today
                    if(sessions.length === 0 && sData.data) sessions = sData.data.filter(s => s.day === day.day);

                    let totalSec = 0, deepSec = 0, remSec = 0;
                    sessions.forEach(s => {
                        totalSec += s.total_sleep_duration || 0;
                        deepSec += s.deep_sleep_duration || 0;
                        remSec += s.rem_sleep_duration || 0;
                    });

                    return {
                        date: day.day,
                        score: day.score,
                        sleep: totalSec > 0 ? (totalSec / 3600).toFixed(1) : "-",
                        deep: Math.round(deepSec / 60),
                        rem: Math.round(remSec / 60)
                    };
                }).reverse();

                this.cache = { history: hist };
                localStorage.setItem(`centurion_oura_cache_${this.user}`, JSON.stringify(this.cache));
                status.innerText = "Synced";
                this.render();
            }
        } catch (e) {
            console.error(e);
            status.innerText = "Sync Failed";
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerHTML = "Fetch Error: " + e.message;
        }
    }

    async updateAI() {
        const dk = getDateKey(new Date());
        const box = document.getElementById('ai-container');
        if(!box) return;

        // Use Cache
        if(this.aiInsights[dk]) {
            box.innerHTML = `<div class="ai-insight-card"><div class="ai-header">üß† COACH</div><div class="ai-content">${this.aiInsights[dk]}</div></div>`;
            return;
        }

        // Setup Prompt
        const data = this.cache.history.find(d => d.date === dk) || {};
        if(!data.score) { box.innerHTML = ''; return; }

        box.innerHTML = `<div class="ai-insight-card"><div class="ai-header">üß† LOADING...</div></div>`;

        try {
            const prompt = `Longevity analysis for ${USERS[this.user].name}. Today: Readiness ${data.score}, Sleep ${data.sleep}h (Deep ${data.deep}m). Give 1 actionable tip.`;
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if(!res.ok) throw new Error("API Error " + res.status);
            const json = await res.json();
            const text = json.candidates[0].content.parts[0].text;

            this.aiInsights[dk] = text;
            localStorage.setItem(`centurion_ai_insights_${this.user}`, JSON.stringify(this.aiInsights));
            
            box.innerHTML = `<div class="ai-insight-card"><div class="ai-header">üß† COACH</div><div class="ai-content">${text}</div></div>`;

        } catch(e) {
            box.innerHTML = `<div class="ai-insight-card"><div class="ai-header">‚ö†Ô∏è OFFLINE</div><div class="ai-content">AI Unavailable</div></div>`;
        }
    }

    render() {
        const dk = getDateKey(new Date());
        const data = this.cache.history.find(d => d.date === dk) || { score: "-", sleep: "-", deep: "-", rem: "-" };
        
        let color = "#333";
        const s = parseInt(data.score);
        if(s >= 80) color = "var(--acid)";
        else if(s >= 60) color = "var(--gold)";
        else if(s > 0) color = "var(--alert)";

        const html = `
        <div class="hero-section">
            <div class="ring-container">
                <svg class="ring-svg"><circle class="ring-bg" cx="55" cy="55" r="45"></circle><circle class="ring-fg" cx="55" cy="55" r="45" style="stroke:${color}; stroke-dashoffset:${283 - (Math.min(s||0,100)/100)*283}"></circle></svg>
                <div class="ring-data"><div class="ring-val">${data.score}</div><div class="ring-label">READINESS</div></div>
            </div>
            <div class="tactical-box" style="border-color:${color}">
                <div class="tac-cmd" style="color:#fff">STATUS: ${s>=80 ? "OPTIMAL" : "RECOVERY"}</div>
                <div style="font-size:10px; color:#666; margin-top:5px;">USER: ${USERS[this.user].name.toUpperCase()}</div>
            </div>
        </div>

        <div id="ai-container"></div>

        <div class="section-label">SLEEP METRICS (YESTERDAY)</div>
        <div class="orb-grid">
            <div class="orb-card"><div class="orb-val" style="color:#bf5af2">${data.sleep}h</div><div class="orb-label">TOTAL</div></div>
            <div class="orb-card"><div class="orb-val" style="color:#007aff">${data.deep}m</div><div class="orb-label">DEEP</div></div>
            <div class="orb-card"><div class="orb-val" style="color:#00f0ff">${data.rem}m</div><div class="orb-label">REM</div></div>
        </div>
        `;

        document.getElementById('dayContent').innerHTML = html;
        this.updateAI();
    }
}

// Start App
const centurion = new CenturionCore();
</script>
</body>
</html>