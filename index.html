<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centurion v9800 DEEP PROBE</title>
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; font-size: 11px; margin: 0; }
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 12px; cursor: pointer; font-family: inherit; font-weight: bold; }
        .btn:active { background: #444; }
        
        #console { 
            background: #000; border: 1px solid #333; padding: 15px; 
            height: 70vh; overflow-y: scroll; white-space: pre-wrap; 
            margin-bottom: 20px; color: #bbb;
        }
        .log-step { color: #fff; font-weight: bold; border-top: 1px solid #222; margin-top: 10px; padding-top: 5px; }
        .log-success { color: #0f0; }
        .log-warn { color: #fa0; }
        .log-error { color: #f00; font-weight: bold; background: rgba(255,0,0,0.1); padding: 2px; }
        .log-data { color: #0ff; }
    </style>
</head>
<body>

<div class="header">
    <div>v9800 DEEP PROBE</div>
    <button class="btn" onclick="probe.run()">RUN DEEP PROBE</button>
</div>

<div id="console">Initializing... Press RUN to start.</div>

<script>
const TOKEN = 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y'; // Checking Jermaine
const GEMINI_KEY = "AIzaSyCHZvxl_YvhDxZQFuZ1RuriCFasaKSDero"; 

const logger = {
    clear: () => document.getElementById('console').innerHTML = '',
    step: (msg) => log(`\n>>> ${msg}`, 'log-step'),
    info: (msg) => log(`  ${msg}`, ''),
    success: (msg) => log(`  âœ… ${msg}`, 'log-success'),
    warn: (msg) => log(`  âš ï¸ ${msg}`, 'log-warn'),
    error: (msg) => log(`  âŒ ${msg}`, 'log-error'),
    data: (msg) => log(`  ðŸ” ${msg}`, 'log-data')
};

function log(msg, cls) {
    const div = document.createElement('div');
    div.className = cls;
    div.textContent = msg;
    document.getElementById('console').appendChild(div);
}

function getDateKey(d) { return d.toISOString().split('T')[0]; }

const probe = {
    run: async () => {
        logger.clear();
        logger.step("INITIATING PROBE v9800");
        
        const today = new Date();
        const dateKey = getDateKey(today);
        logger.info(`Target Date: ${dateKey}`);
        
        // 1. API FETCH - SLEEP SESSIONS (The suspected culprit)
        logger.step("PHASE 1: SLEEP SESSIONS (Detail Endpoint)");
        const range = `start_date=${getDateKey(new Date(Date.now()-864e5*3))}&end_date=${dateKey}`;
        const url = `https://api.ouraring.com/v2/usercollection/sleep?${range}`;
        
        try {
            const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { 
                headers: { 'Authorization': `Bearer ${TOKEN}` } 
            });
            
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            
            logger.success(`Fetch Success. Items: ${data.data.length}`);
            
            if(data.data.length > 0) {
                // INSPECT THE STRUCTURE
                const sample = data.data[data.data.length - 1];
                logger.step("[INSPECTION] RAW SESSION OBJECT");
                logger.data(JSON.stringify(sample, null, 2));
                
                // TEST FILTERING
                logger.step("TESTING DATE FILTER");
                const matches = data.data.filter(s => s.day === dateKey);
                
                if(sample.day) {
                    logger.success(`Property 'day' exists: "${sample.day}"`);
                } else {
                    logger.error(`Property 'day' MISSING. Keys found: ${Object.keys(sample).join(', ')}`);
                }

                if(matches.length > 0) {
                    logger.success(`Found ${matches.length} sessions matching ${dateKey}`);
                    let totalSec = 0;
                    matches.forEach(s => totalSec += s.total_sleep_duration);
                    logger.success(`Calculated Duration: ${(totalSec/3600).toFixed(1)} hrs`);
                } else {
                    logger.warn(`No sessions match ${dateKey}. (Maybe synced to yesterday?)`);
                    logger.info(`Latest available date: ${sample.day}`);
                }
            } else {
                logger.error("No sleep sessions found in range.");
            }

        } catch(e) {
            logger.error(`API FAIL: ${e.message}`);
        }

        // 2. GEMINI TEST
        logger.step("PHASE 2: GEMINI AI (Model: gemini-pro)");
        const aiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_KEY}`;
        
        try {
            const aiRes = await fetch(aiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: "Hello. Reply 'Online'." }] }] })
            });

            if(aiRes.ok) {
                const aiData = await aiRes.json();
                const reply = aiData.candidates?.[0]?.content?.parts?.[0]?.text;
                logger.success(`Gemini 200 OK. Reply: "${reply}"`);
            } else {
                const errText = await aiRes.text();
                logger.error(`Gemini Error ${aiRes.status}`);
                logger.data(errText); // Dumps the exact Google error message
            }
        } catch(e) {
            logger.error(`Gemini Network Fail: ${e.message}`);
        }
    }
};
</script>
</body>
</html>