<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centurion v9600 DEBUG</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; font-size: 12px; margin: 0; }
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .btn { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; }
        .active { background: #0f0; color: #000; font-weight: bold; }
        
        #console { 
            background: #111; border: 1px solid #333; padding: 10px; 
            height: 60vh; overflow-y: scroll; white-space: pre-wrap; 
            margin-bottom: 20px; font-size: 11px;
        }
        .log-info { color: #888; }
        .log-success { color: #0f0; font-weight: bold; }
        .log-warn { color: #fa0; }
        .log-error { color: #f00; font-weight: bold; border-left: 3px solid #f00; padding-left: 5px; }
        .log-json { color: #0ff; }

        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .card { border: 1px solid #333; padding: 10px; text-align: center; }
        .val { font-size: 18px; font-weight: bold; color: #fff; }
        .label { font-size: 10px; color: #666; }
    </style>
</head>
<body>

<div class="header">
    <div>CENTURION v9600 DIAGNOSTICS</div>
    <div>
        <button id="btn-J" class="btn" onclick="app.switchUser('jermaine')">JER</button>
        <button id="btn-S" class="btn" onclick="app.switchUser('sophia')">SOPH</button>
        <button class="btn" onclick="app.runDiagnostics()">RUN TEST</button>
    </div>
</div>

<div class="dashboard">
    <div class="card"><div class="label">SCORE</div><div class="val" id="d-score">--</div></div>
    <div class="card"><div class="label">SLEEP</div><div class="val" id="d-sleep">--</div></div>
    <div class="card"><div class="label">DEEP</div><div class="val" id="d-deep">--</div></div>
    <div class="card"><div class="label">REM</div><div class="val" id="d-rem">--</div></div>
</div>

<h3>SYSTEM LOG</h3>
<div id="console"></div>

<script>
// --- CONFIG ---
const TOKENS = { 
    'jermaine': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 
    'sophia': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' 
};
const GEMINI_KEY = "AIzaSyCHZvxl_YvhDxZQFuZ1RuriCFasaKSDero"; 

// --- UTILS ---
const logger = {
    add: (msg, type='info') => {
        const div = document.createElement('div');
        div.className = `log-${type}`;
        div.textContent = `> ${msg}`;
        document.getElementById('console').appendChild(div);
        document.getElementById('console').scrollTop = 99999;
        console.log(msg);
    },
    json: (obj) => {
        const div = document.createElement('div');
        div.className = 'log-json';
        div.textContent = JSON.stringify(obj, null, 2);
        document.getElementById('console').appendChild(div);
    }
};

function getDateKey(d) { return d.toISOString().split('T')[0]; }

// --- APP CORE ---
class DebugApp {
    constructor() {
        this.user = 'jermaine';
        logger.add("System Booted. Ready.", 'success');
        this.updateUI();
    }

    switchUser(u) {
        this.user = u;
        this.updateUI();
        this.runDiagnostics();
    }

    updateUI() {
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(this.user === 'jermaine' ? 'btn-J' : 'btn-S');
        if(btn) btn.classList.add('active');
    }

    async runDiagnostics() {
        document.getElementById('console').innerHTML = ''; // Clear Log
        logger.add(`STARTING DIAGNOSTIC RUN FOR: ${this.user.toUpperCase()}`, 'success');
        
        const today = new Date();
        const dateKey = getDateKey(today);
        logger.add(`Target Date: ${dateKey}`);
        
        // 1. API CONNECTION TEST
        logger.add("--- STEP 1: OURA API FETCH ---");
        const token = TOKENS[this.user];
        const range = `start_date=${getDateKey(new Date(Date.now()-864e5*5))}&end_date=${dateKey}`;
        const proxy = "https://corsproxy.io/?";
        
        try {
            // URL 1: Readiness
            const urlReadiness = `https://api.ouraring.com/v2/usercollection/daily_readiness?${range}`;
            logger.add(`Fetching: Readiness...`);
            const rRes = await fetch(proxy + encodeURIComponent(urlReadiness), { headers: { 'Authorization': `Bearer ${token}` } });
            logger.add(`Readiness Status: ${rRes.status}`, rRes.ok ? 'success' : 'error');
            const rData = await rRes.json();
            
            // URL 2: Sleep Summary
            const urlSleepSum = `https://api.ouraring.com/v2/usercollection/daily_sleep?${range}`;
            logger.add(`Fetching: Daily Sleep (Summary)...`);
            const sSumRes = await fetch(proxy + encodeURIComponent(urlSleepSum), { headers: { 'Authorization': `Bearer ${token}` } });
            logger.add(`Daily Sleep Status: ${sSumRes.status}`, sSumRes.ok ? 'success' : 'error');
            const sSumData = await sSumRes.json();

            // URL 3: Sleep Sessions (Detailed)
            const urlSleepSess = `https://api.ouraring.com/v2/usercollection/sleep?${range}`;
            logger.add(`Fetching: Sleep Sessions (Detail)...`);
            const sSessRes = await fetch(proxy + encodeURIComponent(urlSleepSess), { headers: { 'Authorization': `Bearer ${token}` } });
            logger.add(`Sleep Sessions Status: ${sSessRes.status}`, sSessRes.ok ? 'success' : 'error');
            const sSessData = await sSessRes.json();

            // 2. DATA PARSING
            logger.add("--- STEP 2: PARSING DATA ---");
            
            // Find Readiness
            const readiness = rData.data.find(x => x.day === dateKey);
            if (readiness) {
                logger.add(`Readiness Found: ${readiness.score}`, 'success');
                document.getElementById('d-score').innerText = readiness.score;
            } else {
                logger.add(`NO Readiness data for ${dateKey}`, 'error');
                // Dump last 3 days to see what we DO have
                logger.add("Recent Readiness Dates Found:");
                logger.json(rData.data.slice(-3).map(x => x.day));
            }

            // Find Sleep (Hybrid Logic)
            const sleepSum = sSumData.data.find(x => x.day === dateKey);
            const sleepSess = sSessData.data.filter(x => x.day === dateKey);
            
            let totalSec = 0, deepSec = 0, remSec = 0;

            if (sleepSum) {
                logger.add("Found Daily Sleep Summary", 'success');
                totalSec = sleepSum.total_sleep_duration;
                deepSec = sleepSum.deep_sleep_duration;
                remSec = sleepSum.rem_sleep_duration;
            } else if (sleepSess.length > 0) {
                logger.add(`Found ${sleepSess.length} Sleep Sessions (Fallback)`, 'warn');
                sleepSess.forEach(s => {
                    totalSec += s.total_sleep_duration;
                    deepSec += s.deep_sleep_duration;
                    remSec += s.rem_sleep_duration;
                });
            } else {
                logger.add(`NO Sleep Data found for ${dateKey}`, 'error');
            }

            // Update UI
            if (totalSec > 0) {
                const hours = (totalSec / 3600).toFixed(1);
                const deep = Math.round(deepSec / 60);
                const rem = Math.round(remSec / 60);
                
                document.getElementById('d-sleep').innerText = hours + "h";
                document.getElementById('d-deep').innerText = deep + "m";
                document.getElementById('d-rem').innerText = rem + "m";
                logger.add(`Sleep Metrics: ${hours}h | Deep: ${deep}m | REM: ${rem}m`, 'success');
            } else {
                document.getElementById('d-sleep').innerText = "NaN";
            }

            // 3. GEMINI TEST
            logger.add("--- STEP 3: GEMINI AI TEST ---");
            const aiPrompt = `Analyze sleep: ${totalSec/3600} hours. Good or bad? Keep it under 10 words.`;
            const aiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
            
            logger.add("Sending request to Google...");
            
            const aiRes = await fetch(aiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: aiPrompt }] }] })
            });

            if (aiRes.ok) {
                const aiData = await aiRes.json();
                const text = aiData.candidates?.[0]?.content?.parts?.[0]?.text;
                logger.add(`Gemini Response: "${text}"`, 'success');
            } else {
                logger.add(`Gemini Failed: ${aiRes.status} ${aiRes.statusText}`, 'error');
                const errText = await aiRes.text();
                logger.add(`Details: ${errText}`, 'error');
            }

        } catch(e) {
            logger.add(`CRITICAL CRASH: ${e.message}`, 'error');
            console.error(e);
        }
    }
}

const app = new DebugApp();
</script>
</body>
</html>