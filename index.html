<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centurion v5.6 DEBUG</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: 'JetBrains Mono', monospace; padding: 20px; font-size: 12px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .btn { background: #222; border: 1px solid #444; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: inherit; }
        .btn.active { background: #00f0ff; color: #000; font-weight: bold; }
        
        /* THE BLACK BOX LOG */
        #log-console { 
            background: #0a0a0a; border: 1px solid #333; border-radius: 8px; 
            height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 20px;
            white-space: pre-wrap; word-break: break-all;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-time { color: #666; margin-right: 8px; }
        .log-info { color: #00f0ff; }
        .log-warn { color: #ffd60a; font-weight: bold; }
        .log-error { color: #ff453a; font-weight: bold; background: rgba(255, 69, 58, 0.1); }
        .log-success { color: #30d158; }

        /* DATA INSPECTOR */
        .inspector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .data-card { background: #111; padding: 10px; border-radius: 6px; border: 1px solid #222; }
        .label { color: #666; font-size: 10px; text-transform: uppercase; }
        .value { font-size: 18px; font-weight: bold; color: #fff; margin-top: 4px; }
        .raw { color: #444; font-size: 10px; margin-top: 4px; }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight:bold;">V5.6 DEBUGGER</div>
        <div>
            <button id="btn-J" class="btn active" onclick="app.switchUser('jermaine')">JER</button>
            <button id="btn-S" class="btn" onclick="app.switchUser('sophia')">SOPH</button>
        </div>
    </div>

    <div class="inspector">
        <div class="data-card">
            <div class="label">Readiness Score</div>
            <div class="value" id="disp-score">--</div>
            <div class="raw" id="raw-score">raw: --</div>
        </div>
        <div class="data-card">
            <div class="label">Sleep Score</div>
            <div class="value" id="disp-sleepScore">--</div>
            <div class="raw" id="raw-sleepScore">raw: --</div>
        </div>
        <div class="data-card">
            <div class="label">Total Sleep</div>
            <div class="value" id="disp-sleep">--</div>
            <div class="raw" id="raw-sleep">raw: --</div>
        </div>
        <div class="data-card">
            <div class="label">Deep Sleep</div>
            <div class="value" id="disp-deep">--</div>
            <div class="raw" id="raw-deep">raw: --</div>
        </div>
        <div class="data-card">
            <div class="label">REM Sleep</div>
            <div class="value" id="disp-rem">--</div>
            <div class="raw" id="raw-rem">raw: --</div>
        </div>
        <div class="data-card">
            <div class="label">Target Date</div>
            <div class="value" id="disp-date">--</div>
        </div>
    </div>

    <div style="margin-top:20px; font-weight:bold; color:#666;">LIVE LOG:</div>
    <div id="log-console"></div>

    <button class="btn" style="width:100%; padding:15px; background:#222; margin-top:10px;" onclick="app.fetchData()">FORCE SYNC NOW</button>

<script>
// --- CONFIG ---
const TOKENS = { 'jermaine': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 'sophia': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };
function getToday() { let d = new Date(); d.setHours(12,0,0,0); return d.toISOString().split('T')[0]; }

// --- LOGGER ---
function log(msg, type='info') {
    const box = document.getElementById('log-console');
    const time = new Date().toLocaleTimeString().split(' ')[0];
    box.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span></div>`;
    box.scrollTop = box.scrollHeight;
}

// --- APP CORE ---
const app = {
    user: 'jermaine',
    
    init: function() {
        this.switchUser('jermaine');
    },

    switchUser: function(uid) {
        this.user = uid;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById(uid === 'jermaine' ? 'btn-J' : 'btn-S').classList.add('active');
        log(`Switched to user: ${uid.toUpperCase()}`, 'info');
        this.fetchData();
    },

    fetchData: async function() {
        const token = TOKENS[this.user];
        const today = getToday();
        const start = new Date(); start.setDate(start.getDate() - 3); // Look back 3 days
        const startStr = start.toISOString().split('T')[0];
        
        log('-----------------------------------');
        log(`STARTING SYNC for ${today}`, 'info');
        document.getElementById('disp-date').innerText = today;

        try {
            // 1. FETCH DAILY SLEEP (Source of Score)
            log(`Fetching 'daily_sleep' from ${startStr}...`, 'info');
            const url1 = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_sleep?start_date=${startStr}&end_date=${today}`)}`;
            const res1 = await fetch(url1, { headers: { 'Authorization': `Bearer ${token}` } });
            const data1 = await res1.json();
            
            if(!res1.ok) throw new Error(`Daily Sleep API Error: ${res1.status}`);
            log(`Daily Sleep: Found ${data1.data.length} records.`, 'success');

            // 2. FETCH SLEEP SESSIONS (Source of Duration)
            log(`Fetching 'sleep' (sessions) from ${startStr}...`, 'info');
            const url2 = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${today}`)}`;
            const res2 = await fetch(url2, { headers: { 'Authorization': `Bearer ${token}` } });
            const data2 = await res2.json();

            if(!res2.ok) throw new Error(`Sleep Session API Error: ${res2.status}`);
            log(`Sleep Sessions: Found ${data2.data.length} records.`, 'success');

            // 3. FETCH READINESS
            log(`Fetching 'daily_readiness'...`, 'info');
            const url3 = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${startStr}&end_date=${today}`)}`;
            const res3 = await fetch(url3, { headers: { 'Authorization': `Bearer ${token}` } });
            const data3 = await res3.json();
            log(`Readiness: Found ${data3.data.length} records.`, 'success');

            // --- PROCESS DATA ---
            this.processData(today, data1.data, data2.data, data3.data);

        } catch(e) {
            log(`CRITICAL ERROR: ${e.message}`, 'error');
            console.error(e);
        }
    },

    processData: function(targetDate, dailySleeps, sleepSessions, readiness) {
        log(`Analysing data for target: ${targetDate}`, 'warn');

        // A. READINESS
        const rRec = readiness.find(r => r.day === targetDate);
        if(rRec) {
            document.getElementById('disp-score').innerText = rRec.score;
            document.getElementById('raw-score').innerText = `raw: ${rRec.score}`;
            log(`Readiness Score: ${rRec.score}`, 'success');
        } else {
            log(`Readiness NOT FOUND for ${targetDate}`, 'error');
            // Fallback to yesterday to see if offset issue
            const yest = readiness[readiness.length-1];
            if(yest) log(`Most recent Readiness is: ${yest.day} (Score: ${yest.score})`, 'warn');
        }

        // B. SLEEP SCORE (from daily_sleep)
        const dsRec = dailySleeps.find(d => d.day === targetDate);
        if(dsRec) {
            document.getElementById('disp-sleepScore').innerText = dsRec.score;
            document.getElementById('raw-sleepScore').innerText = `raw: ${dsRec.score}`;
            log(`Sleep Score Found: ${dsRec.score}`, 'success');
        } else {
            log(`Daily Sleep (Score) NOT FOUND for ${targetDate}`, 'error');
        }

        // C. SLEEP DURATION (from sessions)
        // Note: Sessions use 'day' field which represents the day the sleep *ended* (woke up).
        const sessRecs = sleepSessions.filter(s => s.day === targetDate);
        log(`Found ${sessRecs.length} sleep sessions for ${targetDate}`, sessRecs.length > 0 ? 'success' : 'warn');

        if(sessRecs.length > 0) {
            // Sum them up (naps + main sleep)
            let totalSec = 0, deepSec = 0, remSec = 0;
            sessRecs.forEach(s => {
                totalSec += s.total_sleep_duration;
                deepSec += s.deep_sleep_duration;
                remSec += s.rem_sleep_duration;
                log(`Session: ${s.type} | Total: ${s.total_sleep_duration}s`, 'info');
            });

            const hrs = (totalSec / 3600).toFixed(1);
            const deepMin = Math.round(deepSec / 60);
            const remMin = Math.round(remSec / 60);

            document.getElementById('disp-sleep').innerText = hrs + "h";
            document.getElementById('raw-sleep').innerText = `raw: ${totalSec}s`;
            
            document.getElementById('disp-deep').innerText = deepMin + "m";
            document.getElementById('raw-deep').innerText = `raw: ${deepSec}s`;

            document.getElementById('disp-rem').innerText = remMin + "m";
            document.getElementById('raw-rem').innerText = `raw: ${remSec}s`;

            log(`Calculated: ${hrs}h Sleep | ${deepMin}m Deep | ${remMin}m REM`, 'success');
        } else {
            document.getElementById('disp-sleep').innerText = "NaN";
            document.getElementById('disp-deep').innerText = "NaN";
            document.getElementById('disp-rem').innerText = "NaN";
            log(`NO SESSIONS FOUND. Checking closest date...`, 'error');
            const lastSess = sleepSessions[sleepSessions.length-1];
            if(lastSess) log(`Last available session was: ${lastSess.day}`, 'warn');
        }
    }
};

// Start
app.init();
</script>
</body>
</html>