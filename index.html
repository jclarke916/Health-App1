<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Centurion</title>
    <style>
        /* ==========================================
           CORE RESET & VARIABLES
           ========================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --gold: #FFD60A;
            --text: #ffffff;
            --text-dim: #888;
            --green: #00ff00;
            --red: #ff4444;
            --blue: #4A90E2;
            --purple: #9b59b6;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 80px;
        }
        
        .container { max-width: 100%; margin: 0 auto; padding: 15px; }
        
        /* ==========================================
           HEADER
           ========================================== */
        .header {
            text-align: center;
            padding: 25px 15px 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border-bottom: 2px solid var(--gold);
            margin-bottom: 20px;
        }
        
        .logo { 
            font-size: 2rem; 
            font-weight: 900; 
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .tagline { 
            font-size: 0.7rem; 
            color: var(--text-dim); 
            font-weight: 600;
            letter-spacing: 3px;
        }
        
        /* ==========================================
           USER TOGGLE
           ========================================== */
        .user-toggle {
            display: flex;
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
            background: var(--bg-card);
            padding: 5px;
            border-radius: 25px;
        }
        
        .user-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-weight: 700;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .user-btn.active { background: var(--gold); color: #000; }
        
        /* ==========================================
           CARDS
           ========================================== */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 214, 10, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }
        
        .card-title {
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--gold);
        }
        
        .card-subtitle {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 3px;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--text);
        }
        
        .card-unit {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-left: 5px;
        }
        
        .collapse-icon {
            font-size: 1.2rem;
            color: var(--text-dim);
            transition: transform 0.3s;
        }
        
        .collapse-icon.collapsed { transform: rotate(180deg); }
        
        .card-content { transition: all 0.3s ease; }
        .card-content.hidden { display: none; }
        
        /* ==========================================
           MACRO DASHBOARD (Daily Adherence Tracking)
           ========================================== */
        .macro-dashboard {
            display: grid;
            gap: 12px;
            margin-top: 15px;
        }
        
        .macro-row {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 214, 10, 0.1);
        }
        
        .macro-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .macro-name {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 1px;
        }
        
        .macro-values {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        
        .macro-current {
            color: var(--text);
            font-weight: 800;
        }
        
        .macro-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .macro-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, var(--gold) 0%, #FFA500 100%);
        }
        
        .macro-progress-fill.complete {
            background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);
        }
        
        .macro-progress-fill.over {
            background: linear-gradient(90deg, var(--red) 0%, #cc0000 100%);
        }
        
        /* ==========================================
           METRICS
           ========================================== */
        .metric-grid { display: grid; gap: 15px; }
        
        .metric-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 214, 10, 0.1);
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .metric-goal { font-size: 0.65rem; opacity: 0.7; }
        
        .metric-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .metric-col { flex: 1; }
        
        .metric-col-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        .metric-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .metric-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .confidence {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 8px;
        }
        
        .ai-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .status-optimal { color: var(--green); }
        .status-warning { color: #FFA500; }
        .status-alert { color: var(--red); }
        
        /* ==========================================
           BUTTONS
           ========================================== */
        .action-btn {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .action-btn:active { transform: scale(0.98); }
        
        /* ==========================================
           MODALS
           ========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: var(--bg-card);
            margin: 20px;
            padding: 25px;
            border-radius: 20px;
            border: 2px solid var(--gold);
            max-width: 500px;
            margin: 50px auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--gold);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ==========================================
           MEAL LOGGING
           ========================================== */
        .meal-category { margin-bottom: 25px; }
        
        .meal-category-title {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 12px;
            letter-spacing: 2px;
        }
        
        .photo-upload {
            border: 2px dashed var(--gold);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload:hover { background: rgba(255, 214, 10, 0.05); }
        
        .photo-preview {
            max-width: 100%;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        input[type="file"] { display: none; }
        
        .macro-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .macro-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .macro-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-bottom: 5px;
        }
        
        .macro-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--gold);
        }
        
        /* ==========================================
           INPUTS
           ========================================== */
        input[type="number"], input[type="text"], textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 214, 10, 0.2);
            border-radius: 10px;
            padding: 12px;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--gold);
        }
        
        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 6px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- ==========================================
         HEADER
         ========================================== -->
    <div class="header">
        <div class="logo">THE CENTURION</div>
        <div class="tagline">OPTIMIZE TO 100+</div>
        
        <!-- User Toggle -->
        <div class="user-toggle">
            <button class="user-btn active" onclick="switchUser('J')">JERMAINE</button>
            <button class="user-btn" onclick="switchUser('S')">SOPHIA</button>
        </div>
    </div>

    <div class="container">
        
        <!-- ==========================================
             1. LONGEVITY TRACKER (Life Expectancy)
             ========================================== -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">üèÜ LONGEVITY TRACKER</div>
                    <div class="card-subtitle">AI-Predicted Life Expectancy</div>
                </div>
                <div>
                    <span class="card-value" id="lifeExpectancy">94</span>
                    <span class="card-unit">YEARS</span>
                </div>
            </div>
        </div>

        <!-- ==========================================
             2. OURA READINESS
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('oura')">
                <div>
                    <div class="card-title">üíç OURA READINESS</div>
                    <div class="card-subtitle">Real-time recovery data</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="ouraScore">85</span>
                    <span class="collapse-icon" id="oura-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content" id="oura-content">
                <button class="action-btn" onclick="updateOura()">üì± SYNC OURA DATA</button>
            </div>
        </div>
                    <!-- SMART SUGGESTIONS BUTTON -->
        <button class="action-btn" onclick="showDailySuggestions()" style="margin: 0 15px 20px 15px;">
                        ü§ñ VIEW DAILY INTELLIGENCE BRIEFING
        </button>

        <!-- ==========================================
             3. PROTOCOL (Today's Workout)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('protocol')">
                <div>
                    <div class="card-title">üéØ PROTOCOL</div>
                    <div class="card-subtitle" id="protocolName">REFORM</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="protocolScore">73</span>
                    <span class="collapse-icon" id="protocol-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content" id="protocol-content">
                <button class="action-btn" onclick="openProtocolSelector()">üìã SELECT TODAY'S PROTOCOL</button>
            </div>
        </div>

        <!-- ==========================================
             4. TRAINING (Auto-synced from Oura)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('training')">
                <div>
                    <div class="card-title">üî• TRAINING</div>
                    <div class="card-subtitle" id="trainingPercent">23%</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="caloriesBurned">165</span>
                    <span class="card-unit">CAL</span>
                    <span class="collapse-icon" id="training-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content" id="training-content">
                <div style="padding: 15px; background: rgba(255,214,10,0.05); border-radius: 12px; border: 1px solid rgba(255,214,10,0.2);">
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px;">
                        üì± AUTO-SYNCED FROM OURA RING
                    </div>
                    <div style="font-size: 0.7rem; line-height: 1.5; color: var(--text);">
                        Active calories are automatically pulled from your Oura Ring activity data. Tap "Sync Oura Data" above to refresh.
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 0.7rem; color: var(--text-dim);">DAILY GOAL</span>
                        <span style="font-size: 0.7rem; color: var(--gold); font-weight: 700;">700 CAL</span>
                    </div>
                    <div class="metric-bar" style="height: 10px;">
                        <div class="metric-fill" id="trainingProgressBar" style="width: 23%; background: linear-gradient(90deg, var(--gold) 0%, #FFA500 100%);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             5. NUTRITION (Macro Dashboard)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('nutrition')">
                <div>
                    <div class="card-title">ü•ó NUTRITION</div>
                    <div class="card-subtitle">Daily Macro Adherence</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="nutritionScore">82</span>
                    <span class="card-unit">%</span>
                    <span class="collapse-icon" id="nutrition-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content" id="nutrition-content">
                <!-- Macro Dashboard -->
                <div class="macro-dashboard" id="macroDashboard">
                    <!-- Protein -->
                    <div class="macro-row">
                        <div class="macro-row-header">
                            <span class="macro-name">PROTEIN</span>
                            <span class="macro-values">
                                <span class="macro-current" id="proteinCurrent">0</span>g / 
                                <span id="proteinTarget">180</span>g
                            </span>
                        </div>
                        <div class="macro-progress-bar">
                            <div class="macro-progress-fill" id="proteinProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Carbs -->
                    <div class="macro-row">
                        <div class="macro-row-header">
                            <span class="macro-name">CARBS</span>
                            <span class="macro-values">
                                <span class="macro-current" id="carbsCurrent">0</span>g / 
                                <span id="carbsTarget">200</span>g
                            </span>
                        </div>
                        <div class="macro-progress-bar">
                            <div class="macro-progress-fill" id="carbsProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Fat -->
                    <div class="macro-row">
                        <div class="macro-row-header">
                            <span class="macro-name">FAT</span>
                            <span class="macro-values">
                                <span class="macro-current" id="fatCurrent">0</span>g / 
                                <span id="fatTarget">80</span>g
                            </span>
                        </div>
                        <div class="macro-progress-bar">
                            <div class="macro-progress-fill" id="fatProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Fiber -->
                    <div class="macro-row">
                        <div class="macro-row-header">
                            <span class="macro-name">FIBER</span>
                            <span class="macro-values">
                                <span class="macro-current" id="fiberCurrent">0</span>g / 
                                <span id="fiberTarget">40</span>g
                            </span>
                        </div>
                        <div class="macro-progress-bar">
                            <div class="macro-progress-fill" id="fiberProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Omega-3 -->
                    <div class="macro-row">
                        <div class="macro-row-header">
                            <span class="macro-name">OMEGA-3</span>
                            <span class="macro-values">
                                <span class="macro-current" id="omega3Current">0</span>g / 
                                <span id="omega3Target">3</span>g
                            </span>
                        </div>
                        <div class="macro-progress-bar">
                            <div class="macro-progress-fill" id="omega3Progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <button class="action-btn" onclick="openMealLogger()">üì∏ LOG MEAL</button>
            </div>
        </div>

        <!-- ==========================================
             6. PROJECTIONS (AI Biomarker Predictions)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('projections')">
                <div>
                    <div class="card-title">üîÆ PROJECTIONS</div>
                    <div class="card-subtitle">90-Day AI Biomarker Forecast</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="projectionDays">90</span>
                    <span class="card-unit">DAYS</span>
                    <span class="collapse-icon" id="projections-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content" id="projections-content">
                <div class="metric-grid" id="projectionsGrid">
                    <div style="padding: 20px; text-align: center; color: var(--text-dim);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîÆ</div>
                        <div style="font-size: 0.8rem;">AI projections will appear here based on your daily adherence to protocol, nutrition, and biomarker trends.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             7. BIOMETRICS (Baseline vs AI Predicted)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('biometrics')">
                <div>
                    <div class="card-title">üß¨ BIOMETRICS</div>
                    <div class="card-subtitle">Baseline vs AI-Predicted</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="biometricsCount">4</span>
                    <span class="card-unit">VF</span>
                    <span class="collapse-icon" id="biometrics-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content" id="biometrics-content">
                <div class="metric-grid" id="biometricsGrid">
                    <!-- Biometric comparisons populate here -->
                </div>
                <button class="action-btn" onclick="openModal('biometricsModal')">üî¨ UPDATE BIOMETRICS</button>
            </div>
        </div>

        <!-- ==========================================
             8. ENERGY BALANCE (Collapsible)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('energy')">
                <div>
                    <div class="card-title">‚ö° ENERGY BALANCE</div>
                    <div class="card-subtitle">Calories In vs Out</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="energyBalance">+320</span>
                    <span class="card-unit">CAL</span>
                    <span class="collapse-icon collapsed" id="energy-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content hidden" id="energy-content">
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-label">CALORIES IN</div>
                        <div class="metric-value status-optimal" id="caloriesIn">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">CALORIES OUT</div>
                        <div class="metric-value" id="caloriesOut">2,130</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             9. BIO-AVAILABILITY (Collapsible)
             ========================================== -->
        <div class="card">
            <div class="card-header" onclick="toggleSection('bioavailability')">
                <div>
                    <div class="card-title">üíä BIO-AVAILABILITY</div>
                    <div class="card-subtitle">Nutrient Absorption Optimization</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="card-value" id="bioavailabilityScore">88</span>
                    <span class="card-unit">%</span>
                    <span class="collapse-icon collapsed" id="bioavailability-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-content hidden" id="bioavailability-content">
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-label">IRON + VITAMIN C</div>
                        <div class="metric-value status-optimal">‚úì PAIRED</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">CALCIUM TIMING</div>
                        <div class="metric-value status-warning">‚ö† CHECK</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ==========================================
         MODALS
         ========================================== -->
    
    <!-- Meal Logger Modal -->
    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì∏ LOG MEAL</div>
                <button class="close-btn" onclick="closeModal('mealModal')">√ó</button>
            </div>
            
            <!-- Photo Upload Option -->
            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                <div style="font-size: 3rem; margin-bottom: 10px;">üì∑</div>
                <div style="font-size: 0.9rem; font-weight: 700; color: var(--gold);">TAP TO CAPTURE MEAL</div>
                <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 5px;">
                    AI analyzes biomarker impact + nutrient interactions
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoCapture(event)">
            <img id="photoPreview" class="photo-preview" style="display: none;">
            
            <div style="text-align: center; margin: 20px 0; color: var(--text-dim); font-size: 0.8rem; font-weight: 700;">
                OR QUICK LOG BALANCED MEALS
            </div>
            
            <!-- Quick Meal Buttons -->
            <div id="quickMealButtons"></div>
        </div>
    </div>

    <!-- Protocol Selector Modal -->
    <div id="protocolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìã SELECT PROTOCOL</div>
                <button class="close-btn" onclick="closeModal('protocolModal')">√ó</button>
            </div>
            
            <button class="action-btn" style="margin-bottom: 10px;" onclick="selectProtocol('REFORM')">üßò REFORM</button>
            <button class="action-btn" style="margin-bottom: 10px;" onclick="selectProtocol('CS4')">üí™ CS4</button>
            <button class="action-btn" style="margin-bottom: 10px;" onclick="selectProtocol('BOXING')">ü•ä BOXING</button>
            <button class="action-btn" style="margin-bottom: 10px;" onclick="selectProtocol('YOGA')">üßò‚Äç‚ôÄÔ∏è YOGA</button>
            <button class="action-btn" style="margin-bottom: 10px;" onclick="selectProtocol('UFC GYM')">ü•ã UFC GYM w/ MARCUS</button>
            <button class="action-btn" style="margin-bottom: 10px;" onclick="selectProtocol('TRADITIONAL GYM')">üèãÔ∏è TRADITIONAL GYM</button>
            <button class="action-btn" onclick="selectProtocol('REST DAY')">üò¥ REST DAY</button>
        </div>
    </div>

    <!-- Biometrics Update Modal -->
    <div id="biometricsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üî¨ UPDATE BIOMETRICS</div>
                <button class="close-btn" onclick="closeModal('biometricsModal')">√ó</button>
            </div>
            
            <label>Body Fat %</label>
            <input type="number" step="0.1" id="bodyFat" placeholder="e.g., 18.5">
            
            <label>Visceral Fat Level</label>
            <input type="number" id="visceralFat" placeholder="e.g., 4">
            
            <label>Muscle Mass (lbs)</label>
            <input type="number" step="0.1" id="muscleMass" placeholder="e.g., 145.2">
            
            <label>VO2 Max</label>
            <input type="number" step="0.1" id="vo2Max" placeholder="e.g., 52.3">
            
            <label>Dead Hang (seconds)</label>
            <input type="number" id="deadHang" placeholder="e.g., 90">
            
            <label>Wall Sit (seconds)</label>
            <input type="number" id="wallSit" placeholder="e.g., 120">
            
            <button class="action-btn" onclick="updateBiometrics()">üíæ SAVE BIOMETRICS</button>
        </div>
    </div>
<script>
// ==========================================
// GLOBAL STATE & DATA
// ==========================================

let user = 'J'; // Current user (J = Jermaine, S = Sophia)

// Oura API Tokens
const TOKENS = {
    J: 'YOUR_JERMAINE_OURA_TOKEN_HERE',
    S: 'YOUR_SOPHIA_OURA_TOKEN_HERE'
};

// Helper: Convert Date to YYYY-MM-DD
function getDateKey(date) {
    return date.toISOString().split('T')[0];
}

// Baseline biomarker data from October 31, 2025
const baselineData = {
    J: {
        date: 'Oct 31, 2025',
        calcium: 9.0,
        glucose: 84,
        bun: 13,
        creatinine: 0.82,
        sodium: 140,
        potassium: 4.2,
        chloride: 102,
        co2: 26,
        apoB: 85,
        ldl: 95,
        hdl: 58,
        triglycerides: 78,
        hsCRP: 0.8,
        lipoA: 45,
        homocysteine: 8.2,
        ferritin: 120,
        vitaminD: 48,
        testosterone: 650,
        tsh: 1.8,
        hba1c: 5.2,
        bodyFat: 18.5,
        visceralFat: 4,
        muscleMass: 145.2,
        vo2Max: 52.3,
        deadHang: 90,
        wallSit: 120,
        lifeExpectancy: 94
    },
    S: {
        date: 'Oct 31, 2025',
        calcium: 9.2,
        glucose: 88,
        bun: 12,
        creatinine: 0.75,
        sodium: 138,
        potassium: 4.0,
        chloride: 101,
        co2: 25,
        ana: 1.2,
        ldl: 105,
        hdl: 62,
        triglycerides: 72,
        hsCRP: 1.1,
        ferritin: 28,
        vitaminD: 42,
        tsh: 2.1,
        hba1c: 5.3,
        bodyFat: 24.5,
        visceralFat: 3,
        muscleMass: 98.5,
        vo2Max: 44.2,
        deadHang: 45,
        wallSit: 90,
        lifeExpectancy: 96
    }
};

// Daily macro targets
const macroTargets = {
    J: { protein: 180, carbs: 200, fat: 80, fiber: 40, omega3: 3.0, calories: 2400 },
    S: { protein: 120, carbs: 150, fat: 60, fiber: 35, omega3: 2.5, calories: 1800 }
};

// Daily tracking
let dailyNutrition = {
    protein: 0,
    carbs: 0,
    fat: 0,
    fiber: 0,
    omega3: 0,
    calories: 0
};

let caloriesBurned = 0;
let todayProtocol = 'REFORM';
let ouraReadiness = 85;

// Collapsed sections state
let collapsedSections = {
    energy: true,
    bioavailability: true,
    oura: false,
    protocol: false,
    training: false,
    nutrition: false,
    projections: false,
    biometrics: false
};

// ==========================================
// MEAL DATABASE (51 Centurion Meals)
// ==========================================

const mealDB = {
    // PRESSED JUICES
    j: [
        {
            name: "Green Longevity Juice (Celery + Cucumber + Spinach + Lemon)",
            pro: 2, carb: 18, fat: 0, fiber: 4, omega3: 0, satFat: 0, refinedCarbs: 0, cal: 80,
            ingredients: "Celery (4 stalks), cucumber (1 whole), spinach (2 cups), green apple (1), lemon (1), ginger (1 inch)",
            instructions: "1. Wash all ingredients thoroughly\n2. Cut into juicer-friendly pieces\n3. Juice in order: celery, cucumber, spinach, apple\n4. Add lemon juice and ginger at end\n5. Stir well and drink immediately (within 15 min)\n6. Best on empty stomach for maximum absorption",
            benefits: "Alkalizing, anti-inflammatory, hydrating. Supports liver detox and reduces systemic inflammation (‚ÜìANA for Sophia)."
        },
        {
            name: "Beet Vitality Juice (Beet + Carrot + Apple + Ginger)",
            pro: 3, carb: 28, fat: 0, fiber: 3, omega3: 0, satFat: 0, refinedCarbs: 0, cal: 120,
            ingredients: "Beets (2 medium), carrots (3 large), green apple (1), ginger (2 inch), lemon (1/2)",
            instructions: "1. Scrub beets and carrots (no need to peel)\n2. Cut into chunks\n3. Juice beets first, then carrots, apple\n4. Add ginger and lemon\n5. Stir and drink within 20 min\n6. Expect pink/red color - totally normal!",
            benefits: "Nitric oxide boost (improves blood flow, VO2 max). Supports cardiovascular health and exercise performance."
        },
        {
            name: "Orange Immune Juice (Carrot + Orange + Turmeric)",
            pro: 2, carb: 32, fat: 0, fiber: 2, omega3: 0, satFat: 0, refinedCarbs: 0, cal: 140,
            ingredients: "Carrots (5 large), oranges (2 peeled), turmeric root (1 inch), black pepper (pinch), lemon (1/2)",
            instructions: "1. Juice carrots first\n2. Peel oranges, juice with membranes removed\n3. Add turmeric root\n4. Add pinch of black pepper (activates turmeric)\n5. Squeeze lemon, stir well\n6. Drink immediately",
            benefits: "High vitamin A & C, powerful anti-inflammatory from turmeric. Supports immune function and reduces inflammation (‚ÜìANA)."
        },
        {
            name: "Red Power Juice (Beet + Pomegranate + Berry)",
            pro: 2, carb: 35, fat: 0, fiber: 3, omega3: 0, satFat: 0, refinedCarbs: 0, cal: 150,
            ingredients: "Beets (2 small), pomegranate arils (1 cup), strawberries (1 cup), blueberries (1/2 cup), lemon (1)",
            instructions: "1. Juice beets first\n2. Add pomegranate arils (or use 1/2 cup pure pom juice)\n3. Add berries\n4. Squeeze lemon\n5. Stir vigorously\n6. Drink within 15 min for max antioxidants",
            benefits: "Antioxidant bomb, supports heart health, nitric oxide production. Anthocyanins reduce oxidative stress (great for both ApoB and ANA)."
        },
        {
            name: "Green Apple Detox (Apple + Kale + Cucumber + Mint)",
            pro: 3, carb: 24, fat: 0, fiber: 5, omega3: 0, satFat: 0, refinedCarbs: 0, cal: 110,
            ingredients: "Green apples (2), kale (3 cups), cucumber (1 large), fresh mint (1/2 cup), lemon (1), ginger (1 inch)",
            instructions: "1. Juice kale first (hardest ingredient)\n2. Alternate with cucumber for better extraction\n3. Add apples\n4. Add mint leaves\n5. Finish with lemon and ginger\n6. Drink immediately on empty stomach",
            benefits: "Liver detox support, high in chlorophyll. Alkalizing and anti-inflammatory. Mint aids digestion."
        },
        {
            name: "Citrus Glow Juice (Grapefruit + Orange + Lemon)",
            pro: 2, carb: 30, fat: 0, fiber: 2, omega3: 0, satFat: 0, refinedCarbs: 0, cal: 130,
            ingredients: "Grapefruit (1 large peeled), oranges (2 peeled), lemon (1), lime (1), ginger (1 inch)",
            instructions: "1. Peel citrus fruits, remove seeds\n2. Juice grapefruit first\n3. Add oranges\n4. Squeeze lemon and lime\n5. Add ginger at end\n6. Drink immediately (vitamin C degrades quickly)",
            benefits: "Vitamin C megadose, supports collagen production, immune function. Grapefruit supports metabolism and liver detox."
        }
    ],
    
    // BREAKFAST
    b: [
        { 
            name: "Longevity Power Bowl (Sardines + Avocado + Spinach + Walnuts)", 
            pro: 32, carb: 18, fat: 28, fiber: 12, omega3: 4.2, satFat: 4, refinedCarbs: 0, cal: 450, 
            ingredients: "Wild sardines (1 can), avocado (1 whole), spinach (3 cups saut√©ed), walnuts (1.5 oz), olive oil, lemon, garlic",
            instructions: "1. Heat olive oil in pan over medium heat\n2. Saut√© minced garlic until fragrant (30 sec)\n3. Add spinach, cook until wilted (2-3 min)\n4. Plate spinach, top with drained sardines\n5. Add sliced avocado and walnuts\n6. Squeeze fresh lemon, season with salt & pepper"
        },
        { 
            name: "Wild Salmon Bowl (Quinoa + Brussels + Flax)", 
            pro: 42, carb: 38, fat: 22, fiber: 14, omega3: 5.5, satFat: 3, refinedCarbs: 0, cal: 520,
            ingredients: "Wild salmon (6 oz), quinoa (3/4 cup), roasted Brussels sprouts (2 cups), ground flaxseed (2 tbsp), lemon, dill, olive oil",
            instructions: "1. Cook quinoa according to package (15 min)\n2. Halve Brussels, toss with olive oil, roast at 425¬∞F for 20 min\n3. Season salmon with salt, pepper, fresh dill\n4. Bake salmon at 400¬∞F for 12-15 min (145¬∞F internal)\n5. Assemble bowl: quinoa base, Brussels, salmon on top\n6. Sprinkle flaxseed, squeeze lemon, drizzle olive oil"
        },
        { 
            name: "Omega Power Scramble (Eggs + Salmon + Spinach + Chia)", 
            pro: 38, carb: 15, fat: 26, fiber: 10, omega3: 4.8, satFat: 6, refinedCarbs: 0, cal: 460,
            ingredients: "Pastured eggs (3), smoked wild salmon (3 oz), spinach (3 cups), chia seeds (1 tbsp), avocado (1/2), olive oil",
            instructions: "1. Heat olive oil in non-stick pan\n2. Whisk eggs with chia seeds\n3. Add spinach to pan, wilt 2 min\n4. Pour in eggs, scramble gently\n5. When almost set, fold in smoked salmon chunks\n6. Serve with sliced avocado on side"
        },
        { 
            name: "Fermented Power Bowl (Natto + Kimchi + Avocado + Egg)", 
            pro: 24, carb: 22, fat: 24, fiber: 12, omega3: 0.8, satFat: 5, refinedCarbs: 0, cal: 400,
            ingredients: "Natto (1 cup), kimchi (1 cup), avocado (1/2), soft-boiled eggs (2), scallions, sesame seeds, brown rice (1/2 cup)",
            instructions: "1. Cook brown rice (20-25 min)\n2. Boil eggs for 6.5 min, ice bath, peel\n3. Bowl: rice base, natto, kimchi on sides\n4. Halve soft eggs, place on top\n5. Add sliced avocado, scallions, sesame seeds\n6. Mix natto packet sauce and serve"
        },
        { 
            name: "Berry Longevity Smoothie (Greens + Chia + Walnuts + Cocoa)", 
            pro: 28, carb: 42, fat: 18, fiber: 16, omega3: 4.5, satFat: 2, refinedCarbs: 0, cal: 440,
            ingredients: "Protein powder (1.5 scoops), wild blueberries (1.5 cups), spinach (3 cups), chia seeds (2 tbsp), walnuts (1 oz), raw cacao (1 tbsp), flaxseed (1 tbsp), almond milk",
            instructions: "1. Add almond milk to blender (1.5 cups)\n2. Add spinach, blend until smooth\n3. Add frozen blueberries, protein powder\n4. Add chia, flax, walnuts, cacao\n5. Blend on high 60 seconds\n6. Add ice if too thick, blend again"
        },
        { 
            name: "Greek Yogurt Longevity Bowl (Walnuts + Berries + Flax + Kefir)", 
            pro: 32, carb: 28, fat: 20, fiber: 11, omega3: 4.2, satFat: 3, refinedCarbs: 0, cal: 420,
            ingredients: "Plain Greek yogurt (1.5 cups), kefir (1/2 cup), walnuts (1.5 oz), wild blueberries (1 cup), ground flaxseed (2 tbsp), chia seeds (1 tbsp), cinnamon",
            instructions: "1. Mix Greek yogurt and kefir in bowl\n2. Top with blueberries\n3. Crush walnuts, sprinkle on top\n4. Add flaxseed and chia seeds\n5. Dust with cinnamon\n6. Stir and enjoy immediately"
        },
        { 
            name: "Steel-Cut Oats Ultimate (Walnuts + Berries + Hemp + Flax)", 
            pro: 22, carb: 52, fat: 20, fiber: 15, omega3: 5.0, satFat: 2, refinedCarbs: 0, cal: 480,
            ingredients: "Steel-cut oats (3/4 cup dry), walnuts (1.5 oz), mixed berries (1 cup), hemp seeds (2 tbsp), ground flaxseed (2 tbsp), chia seeds (1 tbsp), cinnamon",
            instructions: "1. Bring 3 cups water to boil\n2. Add oats, reduce to simmer\n3. Cook 20-25 min, stirring occasionally\n4. Remove from heat, let sit 5 min\n5. Top with berries, walnuts, hemp, flax, chia\n6. Sprinkle cinnamon, stir and serve"
        },
        { 
            name: "Smoked Salmon Scramble (Capers + Dill + Avocado)", 
            pro: 32, carb: 12, fat: 24, fiber: 8, omega3: 3.8, satFat: 6, refinedCarbs: 0, cal: 400,
            ingredients: "Pastured eggs (3 scrambled), smoked wild salmon (3 oz), capers (1 tbsp), fresh dill, avocado (1/2), red onion, cream cheese (1 tbsp), everything bagel seasoning",
            instructions: "1. Whisk eggs with splash of water\n2. Heat non-stick pan, add small pat of butter\n3. Pour eggs, scramble on low heat\n4. When almost set, fold in cream cheese\n5. Add smoked salmon chunks, capers, diced red onion\n6. Serve with avocado slices, fresh dill, everything seasoning"
        }
    ],
    
    // LUNCH
    l: [
        { 
            name: "Sardine Power Salad (Quinoa + Kale + Avocado + Walnuts)", 
            pro: 38, carb: 42, fat: 32, fiber: 16, omega3: 5.8, satFat: 4, refinedCarbs: 0, cal: 620,
            ingredients: "Wild sardines (2 cans), quinoa (1 cup), massaged kale (3 cups), avocado (1 whole), walnuts (1 oz), olive oil (1 tbsp), lemon",
            instructions: "1. Cook quinoa, let cool to room temp\n2. Massage kale with pinch salt for 2 min until soft\n3. Mix quinoa and kale in large bowl\n4. Top with drained sardines, sliced avocado\n5. Add crushed walnuts\n6. Dress with olive oil and lemon juice"
        },
        { 
            name: "Wild Salmon Buddha Bowl (Lentils + Greens + Seeds)", 
            pro: 48, carb: 45, fat: 26, fiber: 18, omega3: 5.2, satFat: 4, refinedCarbs: 0, cal: 620,
            ingredients: "Wild salmon (7 oz), lentils (1 cup), mixed greens (3 cups), pumpkin seeds (1 oz), hemp seeds (2 tbsp), tahini dressing, lemon",
            instructions: "1. Cook lentils until tender (20-25 min)\n2. Season salmon with salt, pepper, lemon zest\n3. Bake salmon at 400¬∞F for 12-15 min\n4. Bowl: lentils base, mixed greens on side\n5. Place salmon on top, sprinkle seeds\n6. Drizzle tahini dressing, squeeze lemon"
        },
        {
            name: "White Fish + Shrimp Ceviche (Avocado + Cilantro + Lime)",
            pro: 42, carb: 24, fat: 14, fiber: 12, omega3: 1.8, satFat: 2, refinedCarbs: 0, cal: 400,
            ingredients: "Wild white fish - halibut or cod (4 oz cubed), shrimp (3 oz), lime juice (fresh), red onion (1/4 cup), jalape√±o, cilantro (1/2 cup), avocado (1/2), cherry tomatoes (1 cup), cucumber (1 cup)",
            instructions: "1. Dice fish into 1/2 inch cubes\n2. Chop shrimp into bite-size pieces\n3. Marinate fish & shrimp in lime juice 20-30 min (fish turns opaque)\n4. Dice tomatoes, cucumber, onion, jalape√±o\n5. Mix all together, add cilantro\n6. Top with avocado cubes, serve with plantain chips or lettuce cups"
        },
        {
            name: "Mackerel Rice Bowl (Brown Rice + Kimchi + Seaweed)",
            pro: 42, carb: 48, fat: 22, fiber: 12, omega3: 4.8, satFat: 5, refinedCarbs: 0, cal: 580,
            ingredients: "Mackerel (6 oz grilled), brown rice (1 cup), kimchi (1 cup), seaweed salad (1 cup), edamame (1/2 cup), sesame seeds, scallions",
            instructions: "1. Cook brown rice (45 min)\n2. Season mackerel with soy sauce, ginger, garlic\n3. Grill or broil mackerel 4-5 min per side\n4. Bowl: rice base, kimchi and seaweed on sides\n5. Place grilled mackerel on top\n6. Add edamame, sesame seeds, scallions"
        },
        {
            name: "Dungeness Crab Salad Bowl (Avocado + Mango + Greens)",
            pro: 36, carb: 28, fat: 16, fiber: 12, omega3: 1.2, satFat: 2, refinedCarbs: 0, cal: 420,
            ingredients: "Dungeness crab meat (6 oz), mixed greens (3 cups), avocado (1/2), mango (1/2 cup), cucumber (1 cup), red onion, lime-cilantro dressing, pumpkin seeds (1 oz)",
            instructions: "1. Pick through crab meat, remove any shells\n2. Build salad: greens base\n3. Add crab meat, diced mango, cucumber\n4. Slice avocado, add diced red onion\n5. Sprinkle pumpkin seeds\n6. Dress with lime juice, cilantro, olive oil"
        },
        {
            name: "Cod Taco Bowl (Black Beans + Cabbage Slaw + Lime)",
            pro: 44, carb: 46, fat: 12, fiber: 16, omega3: 0.8, satFat: 2, refinedCarbs: 0, cal: 480,
            ingredients: "Grilled wild cod (7 oz), black beans (1 cup), brown rice (3/4 cup), purple cabbage slaw (2 cups), avocado (1/4), lime, cilantro, jalape√±o",
            instructions: "1. Cook brown rice\n2. Warm black beans with cumin, garlic\n3. Season cod with chili powder, cumin, salt\n4. Grill cod 4 min per side\n5. Shred cabbage, dress with lime juice\n6. Bowl: rice, beans, cod, slaw, avocado, cilantro, jalape√±o"
        },
        {
            name: "Bison Portobello Burger (Sprouted Toast + Jalape√±o + Arugula)",
            pro: 46, carb: 32, fat: 22, fiber: 14, omega3: 1.2, satFat: 6, refinedCarbs: 0, cal: 520,
            ingredients: "Grass-fed bison patty (6 oz), grilled portobello cap (1 large), caramelized onions (1/2 cup), jalape√±os (sliced), sprouted grain bread (2 slices), arugula (2 cups), avocado (1/2), Dijon mustard, olive oil",
            instructions: "1. Grill portobello with balsamic, garlic, olive oil (5 min per side)\n2. Season bison with smoked paprika, garlic powder, black pepper\n3. Grill bison 4-5 min per side (medium)\n4. Caramelize onions low & slow with balsamic (10 min)\n5. Toast sprouted bread lightly\n6. Layer: bread, arugula, bison, portobello, onions, jalape√±os, avocado, mustard, top bread"
        },
        {
            name: "Bison Taco Bowl (Black Beans + Peppers + Salsa)",
            pro: 46, carb: 44, fat: 18, fiber: 16, omega3: 0.5, satFat: 6, refinedCarbs: 0, cal: 540,
            ingredients: "Seasoned ground bison (6 oz), black beans (1 cup), brown rice (3/4 cup), peppers & onions (1 cup), salsa, Greek yogurt (2 tbsp), cilantro, lime",
            instructions: "1. Cook brown rice\n2. Saut√© peppers and onions with olive oil\n3. Brown ground bison, season with cumin, chili powder, garlic\n4. Warm black beans\n5. Bowl: rice base, beans, bison, peppers/onions\n6. Top with salsa, Greek yogurt, cilantro, lime"
        },
        {
            name: "Chicken Protein Pasta (Lentil Pasta + Pesto + Greens)",
            pro: 48, carb: 46, fat: 18, fiber: 16, omega3: 0.8, satFat: 3, refinedCarbs: 0, cal: 540,
            ingredients: "Grilled chicken breast (6 oz), red lentil pasta (2 oz dry), spinach (3 cups), basil pesto (2 tbsp), cherry tomatoes (1 cup), pine nuts (1/2 oz), parmesan (1 oz)",
            instructions: "1. Cook lentil pasta according to package (usually 7-9 min)\n2. Grill chicken, season with Italian herbs\n3. Reserve 1/2 cup pasta water\n4. Toss pasta with pesto, add pasta water to thin\n5. Add spinach (wilts from heat), cherry tomatoes\n6. Slice chicken, place on top with pine nuts and parmesan"
        },
        {
            name: "Turkey Bolognese (Chickpea Pasta + Marinara)",
            pro: 46, carb: 48, fat: 14, fiber: 18, omega3: 0.4, satFat: 3, refinedCarbs: 0, cal: 520,
            ingredients: "Ground turkey (6 oz), chickpea pasta (2 oz dry), marinara sauce (1 cup), diced vegetables (onion, celery, carrots - 1 cup), garlic, Italian herbs, nutritional yeast (2 tbsp)",
            instructions: "1. Saut√© diced onion, celery, carrots in olive oil (5 min)\n2. Add ground turkey, brown completely\n3. Add minced garlic, cook 1 min\n4. Add marinara, Italian herbs, simmer 15 min\n5. Cook chickpea pasta (8-10 min)\n6. Toss pasta with sauce, top with nutritional yeast"
        },
        {
            name: "Centurion Caesar (Grilled Chicken + Kale + Sardines)",
            pro: 48, carb: 18, fat: 24, fiber: 10, omega3: 3.2, satFat: 5, refinedCarbs: 0, cal: 500,
            ingredients: "Grilled chicken breast (6 oz), baby kale & romaine mix (4 cups), wild sardines (1/2 can chopped into dressing), parmesan (1.5 oz), whole grain croutons (1/4 cup), Caesar dressing (olive oil, lemon, garlic, anchovy paste, Dijon), soft-boiled egg (1)",
            instructions: "1. Make dressing: mash sardines with lemon, garlic, Dijon, olive oil\n2. Grill chicken with salt, pepper, Italian herbs\n3. Massage kale/romaine with pinch of salt\n4. Boil egg for 6.5 min, ice bath, peel\n5. Toss greens with dressing, add parmesan\n6. Top with sliced chicken, halved egg, croutons"
        }
    ],
    
    // DINNER
    d: [
        {
            name: "Wild Salmon Centurion (Lentils + Kale + Walnuts)",
            pro: 52, carb: 38, fat: 28, fiber: 20, omega3: 6.5, satFat: 4, refinedCarbs: 0, cal: 620,
            ingredients: "Wild salmon (8 oz), lentils (1 cup), kale (4 cups massaged), walnuts (1.5 oz), olive oil (1 tbsp), lemon, garlic, dill",
            instructions: "1. Cook lentils 20-25 min until tender\n2. Massage kale with olive oil, salt for 2 min\n3. Season salmon with dill, salt, pepper, lemon zest\n4. Bake at 400¬∞F for 12-15 min\n5. Saut√© garlic, add kale, cook 3-4 min\n6. Plate: lentils, kale, salmon on top, walnuts, lemon wedge"
        },
        {
            name: "Bison Organ Blend (20% Liver + Sweet Potato + Brussels)",
            pro: 48, carb: 42, fat: 20, fiber: 16, omega3: 0.8, satFat: 7, refinedCarbs: 0, cal: 560,
            ingredients: "Grass-fed bison blend (7 oz: 80% bison, 20% beef liver), sweet potato (1 large), Brussels sprouts (3 cups roasted), onions, olive oil, thyme",
            instructions: "1. Dice sweet potato, toss with olive oil, roast at 425¬∞F (30 min)\n2. Halve Brussels, roast with sweet potato last 20 min\n3. Brown bison/liver blend in cast iron with thyme\n4. Caramelize onions separately (10 min)\n5. Plate: sweet potato and Brussels as base\n6. Top with bison blend and caramelized onions"
        },
        {
            name: "Maine Lobster Tail (Cauliflower Mash + Asparagus + Lemon)",
            pro: 38, carb: 32, fat: 14, fiber: 14, omega3: 1.0, satFat: 2, refinedCarbs: 0, cal: 420,
            ingredients: "Maine lobster tail (8 oz steamed), cauliflower mash (2 cups with garlic), asparagus (2 cups grilled), olive oil (1 tbsp), lemon (2 wedges), fresh parsley, white wine reduction",
            instructions: "1. Steam cauliflower until soft (10 min), mash with garlic, salt, olive oil\n2. Butterfly lobster tail, brush with butter & lemon\n3. Broil lobster 8-10 min until opaque\n4. Grill asparagus with olive oil, salt (5 min)\n5. Make white wine reduction: simmer wine, lemon, butter until thick\n6. Plate: cauliflower mash, asparagus, lobster, drizzle reduction, parsley"
        },
        {
            name: "Sardine Pasta Alternative (Chickpea Pasta + Greens)",
            pro: 42, carb: 52, fat: 26, fiber: 18, omega3: 5.0, satFat: 4, refinedCarbs: 0, cal: 620,
            ingredients: "Wild sardines (2 cans), chickpea pasta (2 oz dry), arugula (3 cups), cherry tomatoes (1 cup), garlic, olive oil (1 tbsp), lemon, capers",
            instructions: "1. Cook chickpea pasta (8-10 min)\n2. Reserve 1 cup pasta water\n3. Saut√© garlic in olive oil until fragrant\n4. Add cherry tomatoes, cook until blistered (5 min)\n5. Add drained sardines, capers, arugula\n6. Toss with pasta and pasta water, lemon juice, red pepper flakes"
        },
        {
            name: "Cod + White Beans (Kale + Lemon + Garlic)",
            pro: 46, carb: 38, fat: 14, fiber: 18, omega3: 1.0, satFat: 2, refinedCarbs: 0, cal: 480,
            ingredients: "Wild cod (8 oz baked), white beans (1.5 cups), kale (4 cups saut√©ed), garlic (6 cloves), olive oil (1 tbsp), lemon zest, red pepper flakes",
            instructions: "1. Rinse and drain white beans\n2. Saut√© garlic in olive oil, add kale (5 min)\n3. Add white beans, lemon zest, red pepper flakes\n4. Season cod with salt, pepper, lemon\n5. Bake cod at 400¬∞F for 12-15 min\n6. Plate beans/kale, place cod on top, lemon wedge"
        },
        {
            name: "Mackerel Mediterranean (Quinoa + Olives + Greens)",
            pro: 46, carb: 40, fat: 28, fiber: 14, omega3: 5.5, satFat: 5, refinedCarbs: 0, cal: 600,
            ingredients: "Grilled mackerel (7 oz), quinoa (3/4 cup), mixed greens (3 cups), kalamata olives (1/4 cup), sun-dried tomatoes, olive oil, oregano",
            instructions: "1. Cook quinoa (15 min)\n2. Season mackerel with oregano, lemon, garlic\n3. Grill or broil mackerel 4-5 min per side\n4. Mix quinoa with chopped olives, sun-dried tomatoes\n5. Toss greens with olive oil and lemon\n6. Plate: quinoa base, greens, mackerel on top"
        },
        {
            name: "Bison Steak (Quinoa + Asparagus + Chimichurri)",
            pro: 50, carb: 36, fat: 22, fiber: 14, omega3: 0.7, satFat: 7, refinedCarbs: 0, cal: 560,
            ingredients: "Grass-fed bison ribeye (7 oz), quinoa (3/4 cup), asparagus (2 cups), chimichurri sauce (olive oil, parsley, cilantro, garlic, lemon, red pepper flakes)",
            instructions: "1. Cook quinoa\n2. Make chimichurri: blend parsley, cilantro, garlic, lemon, olive oil, red pepper\n3. Season bison with salt, pepper\n4. Grill bison 4-5 min per side (medium-rare)\n5. Grill asparagus 5 min\n6. Plate: quinoa, asparagus, sliced bison, chimichurri drizzle"
        },
        {
            name: "Grass-Fed Lamb (Lentils + Spinach + Mint)",
            pro: 48, carb: 38, fat: 24, fiber: 18, omega3: 1.0, satFat: 9, refinedCarbs: 0, cal: 580,
            ingredients: "Grass-fed lamb chops (6 oz), lentils (1.5 cups), spinach (4 cups), Greek yogurt mint sauce (1/4 cup), olive oil, cumin",
            instructions: "1. Cook lentils with cumin until tender\n2. Make mint sauce: Greek yogurt, fresh mint, lemon, garlic\n3. Season lamb with salt, pepper, cumin\n4. Grill or pan-sear lamb 3-4 min per side (medium-rare)\n5. Wilt spinach in pan with garlic\n6. Plate: lentils, spinach, lamb, drizzle mint yogurt"
        },
        {
            name: "Whole Branzino (Lemon + Herbs + Roasted Vegetables)",
            pro: 44, carb: 32, fat: 18, fiber: 12, omega3: 2.8, satFat: 3, refinedCarbs: 0, cal: 520,
            ingredients: "Whole Mediterranean branzino (12-14 oz), roasted vegetables (zucchini, peppers, cherry tomatoes - 3 cups), lemon (stuffed inside + wedges), fresh herbs (parsley, thyme, rosemary), garlic, olive oil, white wine",
            instructions: "1. Stuff branzino cavity with lemon slices, herbs, garlic\n2. Score skin 3 times on each side\n3. Drizzle with olive oil, salt, pepper, white wine\n4. Roast at 425¬∞F for 20-25 min (flesh flakes easily)\n5. Roast vegetables alongside (zucchini, peppers, tomatoes)\n6. Serve whole, fillet tableside, serve with vegetables"
        },
        {
            name: "Jumbo Scallops (Cauliflower Pur√©e + Asparagus + Brown Butter)",
            pro: 38, carb: 28, fat: 16, fiber: 12, omega3: 1.2, satFat: 4, refinedCarbs: 0, cal: 440,
            ingredients: "Jumbo sea scallops (6 oz - about 4-5 scallops), cauliflower pur√©e (2 cups), asparagus (2 cups), grass-fed brown butter sauce (1 tbsp), lemon, garlic, fresh thyme",
            instructions: "1. Steam cauliflower, pur√©e with garlic, salt, olive oil until smooth\n2. Pat scallops completely dry, season with salt\n3. Sear scallops in hot pan 2 min per side (golden crust)\n4. Make brown butter: melt butter until nutty brown, add lemon, thyme\n5. Grill asparagus 5 min\n6. Plate: cauliflower pur√©e, asparagus, scallops, brown butter drizzle"
        },
        {
            name: "Grilled Chicken Thighs (Quinoa + Brussels + Chimichurri)",
            pro: 46, carb: 40, fat: 20, fiber: 14, omega3: 0.6, satFat: 5, refinedCarbs: 0, cal: 540,
            ingredients: "Pastured chicken thighs (6 oz), quinoa (3/4 cup), roasted Brussels sprouts (2.5 cups), chimichurri sauce (olive oil, parsley, cilantro, garlic, lemon, red pepper flakes)",
            instructions: "1. Cook quinoa\n2. Marinate chicken in olive oil, garlic, lemon (15 min)\n3. Grill chicken 6-7 min per side (165¬∞F internal)\n4. Roast Brussels at 425¬∞F for 20 min\n5. Make chimichurri (blend all ingredients)\n6. Plate: quinoa, Brussels, chicken, chimichurri"
        },
        {
            name: "Turkey Meatballs Protein Pasta (Lentil Pasta + Marinara)",
            pro: 48, carb: 50, fat: 16, fiber: 20, omega3: 0.5, satFat: 4, refinedCarbs: 0, cal: 560,
            ingredients: "Ground turkey meatballs (6 oz), red lentil pasta (2.5 oz dry), marinara sauce (1.5 cups), spinach (2 cups wilted), nutritional yeast (2 tbsp), fresh basil, garlic",
            instructions: "1. Make meatballs: turkey, garlic, Italian herbs, roll into balls\n2. Bake meatballs at 400¬∞F for 20 min\n3. Cook lentil pasta\n4. Heat marinara, add spinach to wilt\n5. Add meatballs to sauce\n6. Toss with pasta, nutritional yeast, fresh basil"
        },
        {
            name: "Chicken Pesto Protein Pasta (Edamame Pasta + Sun-Dried Tomatoes)",
            pro: 50, carb: 44, fat: 20, fiber: 18, omega3: 1.0, satFat: 4, refinedCarbs: 0, cal: 560,
            ingredients: "Grilled chicken breast (6 oz), edamame pasta (2 oz dry), basil pesto (2 tbsp), sun-dried tomatoes (1/4 cup), arugula (2 cups), pine nuts (1/2 oz), parmesan (1 oz)",
            instructions: "1. Cook edamame pasta (6-8 min)\n2. Grill chicken with Italian herbs\n3. Toss pasta with pesto, pasta water to thin\n4. Add sun-dried tomatoes, arugula\n5. Slice chicken, place on top\n6. Garnish with pine nuts and parmesan"
        },
        {
            name: "Garlic Shrimp Zoodles (Lemon + Cherry Tomatoes)",
            pro: 42, carb: 18, fat: 16, fiber: 8, omega3: 1.2, satFat: 2, refinedCarbs: 0, cal: 400,
            ingredients: "Jumbo shrimp (7 oz), zucchini noodles (4 cups), cherry tomatoes (1.5 cups), garlic (6 cloves), olive oil (1 tbsp), lemon, red pepper flakes, fresh basil, parmesan (1 oz)",
            instructions: "1. Spiralize zucchini, salt and let sit 10 min, pat dry\n2. Saut√© garlic in olive oil until fragrant\n3. Add cherry tomatoes, cook until blistered (5 min)\n4. Add shrimp, cook 2-3 min per side\n5. Add zoodles, toss 2 min (don't overcook!)\n6. Squeeze lemon, red pepper flakes, basil, parmesan"
        },
        {
            name: "Bison Bolognese Zoodles (Marinara + Fresh Basil)",
            pro: 46, carb: 24, fat: 20, fiber: 10, omega3: 0.6, satFat: 6, refinedCarbs: 0, cal: 480,
            ingredients: "Ground bison (6 oz), zucchini noodles (4 cups), marinara sauce (1.5 cups), diced vegetables (onion, celery, carrots - 1 cup), garlic, Italian herbs, nutritional yeast (2 tbsp), fresh basil",
            instructions: "1. Spiralize zucchini, salt, let sit, pat dry\n2. Saut√© diced vegetables in olive oil (5 min)\n3. Add ground bison, brown completely\n4. Add marinara, herbs, simmer 15 min\n5. Quick saut√© zoodles 2-3 min (al dente)\n6. Top zoodles with Bolognese, nutritional yeast, basil"
        },
        {
            name: "Wild Salmon Pesto Zoodles (Pine Nuts + Arugula)",
            pro: 48, carb: 16, fat: 26, fiber: 8, omega3: 5.2, satFat: 4, refinedCarbs: 0, cal: 500,
            ingredients: "Wild salmon (6 oz grilled), zucchini noodles (4 cups), basil pesto (2 tbsp), arugula (2 cups), pine nuts (1/2 oz), cherry tomatoes (1 cup), lemon, parmesan (1 oz)",
            instructions: "1. Spiralize zucchini, salt, pat dry\n2. Grill salmon with lemon, dill\n3. Quick saut√© zoodles 2 min\n4. Toss zoodles with pesto\n5. Add arugula, cherry tomatoes, pine nuts\n6. Place salmon on top, lemon, parmesan"
        },
        {
            name: "Chicken Alfredo Zoodles (Cauliflower Sauce)",
            pro: 50, carb: 20, fat: 18, fiber: 10, omega3: 0.4, satFat: 5, refinedCarbs: 0, cal: 460,
            ingredients: "Grilled chicken breast (7 oz), zucchini noodles (4 cups), cauliflower Alfredo sauce (2 cups blended cauliflower, garlic, nutritional yeast, almond milk), mushrooms (1 cup), spinach (2 cups), parmesan (1 oz)",
            instructions: "1. Steam cauliflower, blend with garlic, nutritional yeast, almond milk, salt until smooth\n2. Grill chicken with Italian herbs\n3. Saut√© mushrooms and spinach\n4. Quick cook zoodles 2 min\n5. Toss zoodles with cauliflower Alfredo\n6. Top with sliced chicken, parmesan"
        },
        {
            name: "Turkey Meatball Zoodles (Marinara + Basil)",
            pro: 48, carb: 26, fat: 18, fiber: 12, omega3: 0.5, satFat: 4, refinedCarbs: 0, cal: 480,
            ingredients: "Ground turkey meatballs (6 oz), zucchini noodles (4 cups), marinara sauce (1.5 cups), fresh basil, garlic, nutritional yeast (2 tbsp), parmesan (1 oz), red pepper flakes",
            instructions: "1. Make turkey meatballs, bake at 400¬∞F for 20 min\n2. Spiralize zucchini, salt, pat dry\n3. Heat marinara, add meatballs\n4. Quick saut√© zoodles 2-3 min\n5. Top zoodles with meatballs and sauce\n6. Garnish with basil, nutritional yeast, parmesan"
        }
    ],
    
    // SNACKS
    s: [
        {
            name: "Sardine Avocado Toast (Sprouted Bread + Arugula)",
            pro: 28, carb: 24, fat: 24, fiber: 12, omega3: 3.8, satFat: 4, refinedCarbs: 0, cal: 420,
            ingredients: "Wild sardines (1 can), sprouted grain bread (2 slices), avocado (1/2), arugula (1 cup), lemon, red pepper flakes",
            instructions: "1. Toast sprouted bread\n2. Mash avocado with lemon juice, salt\n3. Spread avocado on toast\n4. Top with drained sardines\n5. Add arugula, red pepper flakes\n6. Squeeze lemon, enjoy immediately"
        },
        {
            name: "Kefir Longevity Smoothie (Berries + Walnuts + Flax)",
            pro: 22, carb: 32, fat: 18, fiber: 12, omega3: 4.0, satFat: 2, refinedCarbs: 0, cal: 380,
            ingredients: "Kefir (1.5 cups), wild blueberries (1 cup), walnuts (1 oz), ground flaxseed (2 tbsp), chia seeds (1 tbsp), cinnamon",
            instructions: "1. Add kefir to blender\n2. Add frozen blueberries\n3. Add walnuts, flax, chia\n4. Sprinkle cinnamon\n5. Blend on high 60 seconds\n6. Drink immediately"
        },
        {
            name: "Hard-Boiled Eggs (3) + Avocado + Kimchi",
            pro: 22, carb: 12, fat: 28, fiber: 10, omega3: 1.2, satFat: 7, refinedCarbs: 0, cal: 380,
            ingredients: "Pastured hard-boiled eggs (3), avocado (1 whole), kimchi (1 cup), everything bagel seasoning, sea salt",
            instructions: "1. Boil eggs 10 min, ice bath, peel\n2. Halve eggs\n3. Slice avocado\n4. Plate eggs, avocado, kimchi\n5. Sprinkle everything seasoning, sea salt\n6. Enjoy with fork or lettuce wrap"
        },
        {
            name: "Greek Yogurt Power Cup (Walnuts + Chia + Berries)",
            pro: 26, carb: 28, fat: 20, fiber: 12, omega3: 4.5, satFat: 3, refinedCarbs: 0, cal: 400,
            ingredients: "Plain Greek yogurt (1.5 cups), walnuts (1.5 oz), chia seeds (1 tbsp), wild blueberries (3/4 cup), ground flaxseed (1 tbsp), cinnamon",
            instructions: "1. Spoon yogurt into bowl\n2. Top with blueberries\n3. Crush walnuts, sprinkle\n4. Add chia and flaxseed\n5. Dust with cinnamon\n6. Mix and enjoy"
        },
        {
            name: "Smoked Salmon Nori Rolls (Avocado + Cucumber)",
            pro: 24, carb: 18, fat: 20, fiber: 10, omega3: 3.2, satFat: 3, refinedCarbs: 0, cal: 350,
            ingredients: "Smoked wild salmon (4 oz), nori sheets (3), avocado (1/2), cucumber (1/2), scallions, sesame seeds, tamari",
            instructions: "1. Lay nori sheet flat\n2. Layer salmon, avocado slices, cucumber strips\n3. Add scallions\n4. Roll tightly\n5. Slice into pieces\n6. Dip in tamari, sprinkle sesame seeds"
        },
        {
            name: "Cottage Cheese Supreme (Walnuts + Flax + Berries + Hemp)",
            pro: 28, carb: 24, fat: 22, fiber: 11, omega3: 5.0, satFat: 4, refinedCarbs: 0, cal: 400,
            ingredients: "Low-fat cottage cheese (1.5 cups), walnuts (1 oz), ground flaxseed (2 tbsp), hemp seeds (2 tbsp), blueberries (1/2 cup)",
            instructions: "1. Spoon cottage cheese into bowl\n2. Top with blueberries\n3. Add crushed walnuts\n4. Sprinkle flax and hemp seeds\n5. Mix gently\n6. Enjoy immediately"
        },
        {
            name: "Edamame Bowl (Seaweed + Sesame + Kimchi)",
            pro: 20, carb: 28, fat: 14, fiber: 14, omega3: 0.8, satFat: 2, refinedCarbs: 0, cal: 320,
            ingredients: "Edamame (2 cups), seaweed salad (1 cup), kimchi (1 cup), sesame seeds (1 tbsp), scallions, sea salt",
            instructions: "1. Boil edamame in pods 5 min\n2. Drain and salt\n3. Arrange with seaweed salad and kimchi\n4. Sprinkle sesame seeds and scallions\n5. Serve with chopsticks\n6. Pop edamame from pods"
        },
        {
            name: "Shrimp Cocktail Elite (Avocado + Cocktail Sauce + Lemon)",
            pro: 28, carb: 18, fat: 12, fiber: 8, omega3: 1.0, satFat: 2, refinedCarbs: 0, cal: 300,
            ingredients: "Jumbo shrimp (6 oz), avocado (1/2), cocktail sauce (sugar-free, 3 tbsp), lemon wedges, celery sticks (2 cups), cucumber slices",
            instructions: "1. Boil shrimp 2-3 min until pink, ice bath\n2. Peel and devein\n3. Make cocktail sauce: tomato paste, horseradish, lemon, hot sauce\n4. Arrange shrimp on plate with avocado\n5. Serve with celery, cucumber for crunch\n6. Dip in cocktail sauce, squeeze lemon"
        }
    ]
};

// ==========================================
// CORE FUNCTIONS
// ==========================================

// Switch between Jermaine and Sophia
function switchUser(newUser) {
    user = newUser;
    
    // Update button states
    document.querySelectorAll('.user-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Refresh all displays
    updateDashboard();
    
    // Load cached Oura data for this user
    loadCachedOuraData();
}

// Toggle collapsible sections
function toggleSection(sectionId) {
    const content = document.getElementById(`${sectionId}-content`);
    const icon = document.getElementById(`${sectionId}-icon`);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.remove('collapsed');
        collapsedSections[sectionId] = false;
    } else {
        content.classList.add('hidden');
        icon.classList.add('collapsed');
        collapsedSections[sectionId] = true;
    }
}

// Modal management
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Update entire dashboard
function updateDashboard() {
    const baseline = baselineData[user];
    
    // Life expectancy
    document.getElementById('lifeExpectancy').textContent = baseline.lifeExpectancy;
    
    // Oura score (will be updated by sync)
    document.getElementById('ouraScore').textContent = ouraReadiness;
    
    // Protocol
    document.getElementById('protocolName').textContent = todayProtocol;
    
    // Training (will be updated by Oura sync)
    document.getElementById('caloriesBurned').textContent = caloriesBurned;
    
    // Macro targets
    const targets = macroTargets[user];
    document.getElementById('proteinTarget').textContent = targets.protein;
    document.getElementById('carbsTarget').textContent = targets.carbs;
    document.getElementById('fatTarget').textContent = targets.fat;
    document.getElementById('fiberTarget').textContent = targets.fiber;
    document.getElementById('omega3Target').textContent = targets.omega3;
    
    // Update macro progress
    updateMacroProgress();
    
    // Update biometrics display
    updateBiometricsDisplay();
    
    // Update energy balance
    updateEnergyBalance();
}

// Update macro progress bars
function updateMacroProgress() {
    const targets = macroTargets[user];
    
    // Protein
    const proteinPercent = Math.min((dailyNutrition.protein / targets.protein) * 100, 150);
    document.getElementById('proteinCurrent').textContent = Math.round(dailyNutrition.protein);
    document.getElementById('proteinProgress').style.width = proteinPercent + '%';
    document.getElementById('proteinProgress').className = 'macro-progress-fill' + 
        (proteinPercent >= 100 ? ' complete' : proteinPercent >= 150 ? ' over' : '');
    
    // Carbs
    const carbsPercent = Math.min((dailyNutrition.carbs / targets.carbs) * 100, 150);
    document.getElementById('carbsCurrent').textContent = Math.round(dailyNutrition.carbs);
    document.getElementById('carbsProgress').style.width = carbsPercent + '%';
    document.getElementById('carbsProgress').className = 'macro-progress-fill' + 
        (carbsPercent >= 100 ? ' complete' : carbsPercent >= 150 ? ' over' : '');
    
    // Fat
    const fatPercent = Math.min((dailyNutrition.fat / targets.fat) * 100, 150);
    document.getElementById('fatCurrent').textContent = Math.round(dailyNutrition.fat);
    document.getElementById('fatProgress').style.width = fatPercent + '%';
    document.getElementById('fatProgress').className = 'macro-progress-fill' + 
        (fatPercent >= 100 ? ' complete' : fatPercent >= 150 ? ' over' : '');
    
    // Fiber
    const fiberPercent = Math.min((dailyNutrition.fiber / targets.fiber) * 100, 150);
    document.getElementById('fiberCurrent').textContent = Math.round(dailyNutrition.fiber);
    document.getElementById('fiberProgress').style.width = fiberPercent + '%';
    document.getElementById('fiberProgress').className = 'macro-progress-fill' + 
        (fiberPercent >= 100 ? ' complete' : fiberPercent >= 150 ? ' over' : '');
    
    // Omega-3
    const omega3Percent = Math.min((dailyNutrition.omega3 / targets.omega3) * 100, 150);
    document.getElementById('omega3Current').textContent = dailyNutrition.omega3.toFixed(1);
    document.getElementById('omega3Progress').style.width = omega3Percent + '%';
    document.getElementById('omega3Progress').className = 'macro-progress-fill' + 
        (omega3Percent >= 100 ? ' complete' : omega3Percent >= 150 ? ' over' : '');
    
    // Calculate nutrition score (average adherence)
    const avgAdherence = (proteinPercent + carbsPercent + fatPercent + fiberPercent + omega3Percent) / 5;
    document.getElementById('nutritionScore').textContent = Math.round(Math.min(avgAdherence, 100));
}

// Update energy balance
function updateEnergyBalance() {
    const targets = macroTargets[user];
    const caloriesIn = dailyNutrition.calories;
    const caloriesOut = targets.calories - 300 + caloriesBurned; // Base metabolism + training
    const balance = caloriesIn - caloriesOut;
    
    document.getElementById('caloriesIn').textContent = caloriesIn.toLocaleString();
    document.getElementById('caloriesOut').textContent = caloriesOut.toLocaleString();
    document.getElementById('energyBalance').textContent = (balance >= 0 ? '+' : '') + balance;
}

// ==========================================
// OURA SYNC - YOUR EXACT HANDSHAKE PROTOCOL
// ==========================================

async function updateOura() {
    // 1. Capture the user ID at the moment the button was pressed
    const fetchID = user; 
    const token = TOKENS[fetchID];
    const range = `start_date=${getDateKey(new Date(Date.now()-864e5*14))}&end_date=${getDateKey(new Date())}`;

    try {
        // Show loading state
        document.getElementById('ouraScore').textContent = '...';
        document.getElementById('caloriesBurned').textContent = '...';
        
        // 2. Sequential Fetch (Readiness First)
        const rRes = await fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${range}&t=${Date.now()}`)}`, { 
            headers: { 'Authorization': `Bearer ${token}` } 
        });
        const rData = await rRes.json();

        // 3. Activity Fetch (Only after Readiness succeeds)
        const aRes = await fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?${range}&t=${Date.now()}`)}`, { 
            headers: { 'Authorization': `Bearer ${token}` } 
        });
        const aData = await aRes.json();

        // 4. Critical Guard: Did the user switch while we were waiting?
        if(user !== fetchID) return;

        // 5. Process & Cache Data
        if(rData.data && rData.data.length > 0) {
            const hist = rData.data.map(day => {
                const act = aData.data ? aData.data.find(ac => ac.day === day.day) : null;
                return { 
                    date: day.day, 
                    score: day.score || 0, 
                    cal: act ? act.active_calories : 0, 
                    high: act ? Math.round(act.high_activity_time/60) : 0, 
                    med: act ? Math.round(act.medium_activity_time/60) : 0,
                    steps: act ? act.steps : 0,
                    distance: act ? act.equivalent_walking_distance : 0
                };
            }).reverse();

            // Cache the data
            localStorage.setItem(`centurion_oura_cache_${fetchID}`, JSON.stringify({
                history: hist,
                lastSync: new Date().toISOString()
            }));
            
            // 6. Update UI with latest day's data (only if we are still on the correct user)
            const latest = hist[0];
            
            if (latest) {
                // Update Oura Readiness Score
                ouraReadiness = latest.score;
                document.getElementById('ouraScore').textContent = ouraReadiness;
                
                // Update Training Calories
                caloriesBurned = latest.cal;
                document.getElementById('caloriesBurned').textContent = caloriesBurned;
                
                // Update training percentage
                const percentOfGoal = Math.round((caloriesBurned / 700) * 100);
                document.getElementById('trainingPercent').textContent = percentOfGoal + '%';
                
                // Update training progress bar
                const progressBar = document.getElementById('trainingProgressBar');
                if (progressBar) {
                    progressBar.style.width = Math.min(percentOfGoal, 100) + '%';
                    
                    // Update color based on achievement
                    if (percentOfGoal >= 100) {
                        progressBar.style.background = 'linear-gradient(90deg, var(--green) 0%, #00cc00 100%)';
                    } else if (percentOfGoal >= 70) {
                        progressBar.style.background = 'linear-gradient(90deg, var(--gold) 0%, #FFA500 100%)';
                    } else {
                        progressBar.style.background = 'linear-gradient(90deg, var(--red) 0%, #cc0000 100%)';
                    }
                }
                
                // Update energy balance
                updateEnergyBalance();
                
                // Success message
                alert(`‚úÖ Oura synced for ${fetchID === 'J' ? 'JERMAINE' : 'SOPHIA'}!\n\nüíç Readiness: ${latest.score}\nüî• Active Calories: ${latest.cal}\nüëü Steps: ${latest.steps?.toLocaleString() || 'N/A'}`);
            }
            
        } else {
            throw new Error('No Oura data available');
        }
        
    } catch(e) {
        console.error('Oura sync error:', e);
        
        // 7. Error Handling: Only show error if user hasn't switched away
        if(user === fetchID) {
            // Try to load from cache
            const cached = localStorage.getItem(`centurion_oura_cache_${fetchID}`);
            if (cached) {
                const data = JSON.parse(cached);
                const latest = data.history[0];
                
                if (latest) {
                    ouraReadiness = latest.score;
                    caloriesBurned = latest.cal;
                    document.getElementById('ouraScore').textContent = ouraReadiness;
                    document.getElementById('caloriesBurned').textContent = caloriesBurned;
                    
                    const percentOfGoal = Math.round((caloriesBurned / 700) * 100);
                    document.getElementById('trainingPercent').textContent = percentOfGoal + '%';
                    
                    alert(`‚ö†Ô∏è Oura sync timeout. Using cached data from ${new Date(data.lastSync).toLocaleDateString()}`);
                } else {
                    document.getElementById('ouraScore').textContent = '85';
                    document.getElementById('caloriesBurned').textContent = '0';
                    alert('‚ö†Ô∏è Oura sync failed. No cached data available.');
                }
            } else {
                // Fallback to defaults
                document.getElementById('ouraScore').textContent = '85';
                document.getElementById('caloriesBurned').textContent = '0';
                alert('‚ö†Ô∏è Oura sync failed. Please check your connection and try again.');
            }
        }
    }
}

// Load cached Oura data on page load
function loadCachedOuraData() {
    const cached = localStorage.getItem(`centurion_oura_cache_${user}`);
    if (cached) {
        const data = JSON.parse(cached);
        const latest = data.history[0];
        
        if (latest) {
            ouraReadiness = latest.score;
            caloriesBurned = latest.cal;
            document.getElementById('ouraScore').textContent = ouraReadiness;
            document.getElementById('caloriesBurned').textContent = caloriesBurned;
            
            const percentOfGoal = Math.round((caloriesBurned / 700) * 100);
            document.getElementById('trainingPercent').textContent = percentOfGoal + '%';
            
            // Update progress bar if it exists
            const progressBar = document.getElementById('trainingProgressBar');
            if (progressBar) {
                progressBar.style.width = Math.min(percentOfGoal, 100) + '%';
                
                if (percentOfGoal >= 100) {
                    progressBar.style.background = 'linear-gradient(90deg, var(--green) 0%, #00cc00 100%)';
                } else if (percentOfGoal >= 70) {
                    progressBar.style.background = 'linear-gradient(90deg, var(--gold) 0%, #FFA500 100%)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, var(--red) 0%, #cc0000 100%)';
                }
            }
            
            updateEnergyBalance();
        }
    }
}
// ==========================================
// MEAL LOGGING SYSTEM
// ==========================================

function openMealLogger() { 
    let quickButtons = '';
    
    // JUICE RECOMMENDATION LOGIC
    const currentUser = user;
    const baseline = baselineData[currentUser];
    let juiceRec = '';
    
    if (currentUser === 'J') {
        juiceRec = `<div style="padding:12px; background:rgba(255,214,10,0.08); border-left:3px solid var(--gold); border-radius:8px; margin-bottom:15px;"><div style="font-size:0.6rem; color:var(--gold); margin-bottom:5px; font-weight:800;">üí° JERMAINE'S RECOMMENDATION</div><div style="font-size:0.7rem; color:#ddd; line-height:1.4;"><strong>Beet Vitality</strong> or <strong>Green Longevity</strong> - Support nitric oxide production (‚ÜìApoB, ‚ÜëVO2) and reduce inflammation</div></div>`;
    } else {
        juiceRec = `<div style="padding:12px; background:rgba(255,214,10,0.08); border-left:3px solid var(--gold); border-radius:8px; margin-bottom:15px;"><div style="font-size:0.6rem; color:var(--gold); margin-bottom:5px; font-weight:800;">üí° SOPHIA'S RECOMMENDATION</div><div style="font-size:0.7rem; color:#ddd; line-height:1.4;"><strong>Orange Immune</strong> or <strong>Green Longevity</strong> - High in anti-inflammatory compounds (‚ÜìANA, ‚ÜëFerritin absorption with vitamin C)</div></div>`;
    }
    
    // JUICES
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üßÉ PRESSED JUICES</div>${juiceRec}`;
    mealDB.j.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='showMealDetails(${JSON.stringify(meal).replace(/'/g, "\\'")})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.carb}C ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // BREAKFAST
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üåÖ BREAKFAST</div>`;
    mealDB.b.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='showMealDetails(${JSON.stringify(meal).replace(/'/g, "\\'")})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // LUNCH
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üåû LUNCH</div>`;
    mealDB.l.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='showMealDetails(${JSON.stringify(meal).replace(/'/g, "\\'")})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // DINNER
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üåô DINNER</div>`;
    mealDB.d.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='showMealDetails(${JSON.stringify(meal).replace(/'/g, "\\'")})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    // SNACKS
    quickButtons += `<div class="meal-category"><div class="meal-category-title">üçé SNACKS</div>`;
    mealDB.s.forEach(meal => {
        quickButtons += `<button class="action-btn" style="margin-bottom: 8px;" onclick='showMealDetails(${JSON.stringify(meal).replace(/'/g, "\\'")})'>${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.fiber}F)</span></button>`;
    });
    quickButtons += `</div>`;
    
    document.getElementById('quickMealButtons').innerHTML = quickButtons; 
    document.getElementById('photoPreview').style.display = 'none'; 
    document.getElementById('photoInput').value = ''; 
    openModal('mealModal'); 
}

function showMealDetails(meal) {
    const detailsHTML = `
        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="font-size: 1rem; font-weight: 800; color: var(--gold); margin-bottom: 15px;">${meal.name}</div>
            
            <div class="macro-grid">
                <div class="macro-item">
                    <div class="macro-label">PROTEIN</div>
                    <div class="macro-value">${meal.pro}g</div>
                </div>
                <div class="macro-item">
                    <div class="macro-label">CARBS</div>
                    <div class="macro-value">${meal.carb}g</div>
                </div>
                <div class="macro-item">
                    <div class="macro-label">FAT</div>
                    <div class="macro-value">${meal.fat}g</div>
                </div>
                <div class="macro-item">
                    <div class="macro-label">FIBER</div>
                    <div class="macro-value">${meal.fiber}g</div>
                </div>
                <div class="macro-item">
                    <div class="macro-label">OMEGA-3</div>
                    <div class="macro-value">${meal.omega3}g</div>
                </div>
                <div class="macro-item">
                    <div class="macro-label">CALORIES</div>
                    <div class="macro-value">${meal.cal}</div>
                </div>
            </div>
            
            ${meal.benefits ? `<div style="margin-top: 15px; padding: 12px; background: rgba(0,255,0,0.05); border-left: 3px solid var(--green); border-radius: 8px;">
                <div style="font-size: 0.7rem; font-weight: 700; color: var(--green); margin-bottom: 5px;">‚ú® LONGEVITY BENEFITS</div>
                <div style="font-size: 0.75rem; line-height: 1.5;">${meal.benefits}</div>
            </div>` : ''}
            
            <div style="margin-top: 15px;">
                <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-dim); margin-bottom: 8px;">INGREDIENTS:</div>
                <div style="font-size: 0.75rem; line-height: 1.6; color: var(--text);">${meal.ingredients}</div>
            </div>
            
            <div style="margin-top: 15px;">
                <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-dim); margin-bottom: 8px;">INSTRUCTIONS:</div>
                <div style="font-size: 0.75rem; line-height: 1.6; color: var(--text); white-space: pre-line;">${meal.instructions}</div>
            </div>
            
            <button class="action-btn" onclick='logMeal(${JSON.stringify(meal)})'>‚úÖ LOG THIS MEAL</button>
            <button class="action-btn" style="background: rgba(255,255,255,0.1); color: var(--text); margin-top: 10px;" onclick="openMealLogger()">‚Üê BACK TO MEALS</button>
        </div>
    `;
    
    document.getElementById('quickMealButtons').innerHTML = detailsHTML;
}

function logMeal(meal) {
    // Add meal macros to daily totals
    dailyNutrition.protein += meal.pro;
    dailyNutrition.carbs += meal.carb;
    dailyNutrition.fat += meal.fat;
    dailyNutrition.fiber += meal.fiber;
    dailyNutrition.omega3 += meal.omega3;
    dailyNutrition.calories += meal.cal;
    
    // Update display
    updateMacroProgress();
    updateEnergyBalance();
    
    // Close modal
    closeModal('mealModal');
    
    // Success feedback
    alert(`‚úÖ ${meal.name} logged successfully!`);
}

function handlePhotoCapture(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photoPreview').src = e.target.result;
            document.getElementById('photoPreview').style.display = 'block';
            
            // In production, this would call AI vision API
            alert('üì∏ Photo captured! In production, AI would analyze this meal for macros and biomarker impact.');
        };
        reader.readAsDataURL(file);
    }
}

// ==========================================
// PROTOCOL SELECTION
// ==========================================

function openProtocolSelector() {
    openModal('protocolModal');
}

function selectProtocol(protocol) {
    todayProtocol = protocol;
    document.getElementById('protocolName').textContent = protocol;
    
    // Update protocol score based on type
    const protocolScores = {
        'REFORM': 73,
        'CS4': 85,
        'BOXING': 78,
        'YOGA': 65,
        'UFC GYM': 88,
        'TRADITIONAL GYM': 80,
        'REST DAY': 95
    };
    
    document.getElementById('protocolScore').textContent = protocolScores[protocol] || 75;
    
    closeModal('protocolModal');
    alert(`‚úÖ Today's protocol set to: ${protocol}`);
}

// ==========================================
// BIOMETRICS UPDATE
// ==========================================

function updateBiometrics() {
    const baseline = baselineData[user];
    
    // Get new values from inputs
    const bodyFat = parseFloat(document.getElementById('bodyFat').value);
    const visceralFat = parseInt(document.getElementById('visceralFat').value);
    const muscleMass = parseFloat(document.getElementById('muscleMass').value);
    const vo2Max = parseFloat(document.getElementById('vo2Max').value);
    const deadHang = parseInt(document.getElementById('deadHang').value);
    const wallSit = parseInt(document.getElementById('wallSit').value);
    
    // Update baseline data
    if (!isNaN(bodyFat)) baseline.bodyFat = bodyFat;
    if (!isNaN(visceralFat)) baseline.visceralFat = visceralFat;
    if (!isNaN(muscleMass)) baseline.muscleMass = muscleMass;
    if (!isNaN(vo2Max)) baseline.vo2Max = vo2Max;
    if (!isNaN(deadHang)) baseline.deadHang = deadHang;
    if (!isNaN(wallSit)) baseline.wallSit = wallSit;
    
    // Refresh biometrics display
    updateBiometricsDisplay();
    
    // Clear inputs
    document.getElementById('bodyFat').value = '';
    document.getElementById('visceralFat').value = '';
    document.getElementById('muscleMass').value = '';
    document.getElementById('vo2Max').value = '';
    document.getElementById('deadHang').value = '';
    document.getElementById('wallSit').value = '';
    
    closeModal('biometricsModal');
    alert('‚úÖ Biometrics updated successfully!');
}

function updateBiometricsDisplay() {
    const baseline = baselineData[user];
    
    // Create biometrics grid with all blood markers + fitness metrics
    const biometricsHTML = `
        <!-- CALCIUM -->
        <div class="metric-item">
            <div class="metric-label">
                <span>CALCIUM</span>
                <span class="metric-goal">Goal: 9.5mg/dL</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">BASELINE (OCT 31, 2025)</div>
                    <div class="metric-value status-optimal">${baseline.calcium}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.calcium/10)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">PREDICTED (TODAY) <span class="ai-badge">AI</span></div>
                    <div class="metric-value status-optimal">${baseline.calcium}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.calcium/10)*100}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                    </div>
                </div>
            </div>
            <div class="confidence">MEDIUM confidence ‚Ä¢ base rate</div>
        </div>
        
        <!-- GLUCOSE -->
        <div class="metric-item">
            <div class="metric-label">
                <span>GLUCOSE</span>
                <span class="metric-goal">Goal: 85mg/dL</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">BASELINE (OCT 31, 2025)</div>
                    <div class="metric-value status-optimal">${baseline.glucose}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.glucose/120)*100}%; background: var(--green);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">PREDICTED (TODAY) <span class="ai-badge">AI</span></div>
                    <div class="metric-value status-optimal">${Math.max(82, baseline.glucose - 2)}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(Math.max(82, baseline.glucose - 2)/120)*100}%; background: linear-gradient(90deg, #00ff00 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
            <div class="confidence">MEDIUM confidence ‚Ä¢ base rate</div>
        </div>
        
        <!-- BUN -->
        <div class="metric-item">
            <div class="metric-label">
                <span>BUN</span>
                <span class="metric-goal">Goal: 15mg/dL</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">BASELINE (OCT 31, 2025)</div>
                    <div class="metric-value status-optimal">${baseline.bun}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.bun/25)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">PREDICTED (TODAY) <span class="ai-badge">AI</span></div>
                    <div class="metric-value status-optimal">${baseline.bun}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.bun/25)*100}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                    </div>
                </div>
            </div>
            <div class="confidence">MEDIUM confidence ‚Ä¢ base rate</div>
        </div>
        
        <!-- CREATININE -->
        <div class="metric-item">
            <div class="metric-label">
                <span>CREATININE</span>
                <span class="metric-goal">Goal: 0.7mg/dL</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">BASELINE (OCT 31, 2025)</div>
                    <div class="metric-value status-optimal">${baseline.creatinine}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.creatinine/1.5)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">PREDICTED (TODAY) <span class="ai-badge">AI</span></div>
                    <div class="metric-value status-optimal">${Math.max(0.75, baseline.creatinine - 0.02).toFixed(2)}mg/dL</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(Math.max(0.75, baseline.creatinine - 0.02)/1.5)*100}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                    </div>
                </div>
            </div>
            <div class="confidence">MEDIUM confidence ‚Ä¢ base rate</div>
        </div>
        
        <!-- BODY FAT % -->
        <div class="metric-item">
            <div class="metric-label">
                <span>BODY FAT %</span>
                <span class="metric-goal">Goal: ${user === 'J' ? '12-15%' : '18-22%'}</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">CURRENT</div>
                    <div class="metric-value status-optimal">${baseline.bodyFat}%</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.bodyFat/35)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">90-DAY GOAL</div>
                    <div class="metric-value status-optimal">${user === 'J' ? '15.0' : '22.0'}%</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${user === 'J' ? '42' : '62'}%; background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VISCERAL FAT -->
        <div class="metric-item">
            <div class="metric-label">
                <span>VISCERAL FAT</span>
                <span class="metric-goal">Goal: 1-4</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">CURRENT</div>
                    <div class="metric-value status-optimal">${baseline.visceralFat}</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.visceralFat/15)*100}%; background: var(--green);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">90-DAY GOAL</div>
                    <div class="metric-value status-optimal">${Math.max(1, baseline.visceralFat - 1)}</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(Math.max(1, baseline.visceralFat - 1)/15)*100}%; background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MUSCLE MASS -->
        <div class="metric-item">
            <div class="metric-label">
                <span>MUSCLE MASS</span>
                <span class="metric-goal">Goal: ${user === 'J' ? '150+ lbs' : '105+ lbs'}</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">CURRENT</div>
                    <div class="metric-value status-optimal">${baseline.muscleMass} lbs</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.muscleMass/180)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">90-DAY GOAL</div>
                    <div class="metric-value status-optimal">${user === 'J' ? '150.0' : '102.0'} lbs</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${user === 'J' ? '83' : '56'}%; background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VO2 MAX -->
        <div class="metric-item">
            <div class="metric-label">
                <span>VO2 MAX</span>
                <span class="metric-goal">Goal: ${user === 'J' ? '55+' : '48+'}</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">CURRENT</div>
                    <div class="metric-value status-optimal">${baseline.vo2Max}</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.vo2Max/70)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">90-DAY GOAL</div>
                    <div class="metric-value status-optimal">${user === 'J' ? '54.5' : '46.0'}</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${user === 'J' ? '77' : '65'}%; background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DEAD HANG -->
        <div class="metric-item">
            <div class="metric-label">
                <span>DEAD HANG</span>
                <span class="metric-goal">Goal: ${user === 'J' ? '120+ sec' : '60+ sec'}</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">CURRENT</div>
                    <div class="metric-value status-optimal">${baseline.deadHang}s</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.deadHang/180)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">90-DAY GOAL</div>
                    <div class="metric-value status-optimal">${user === 'J' ? '105' : '55'}s</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${user === 'J' ? '58' : '30'}%; background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WALL SIT -->
        <div class="metric-item">
            <div class="metric-label">
                <span>WALL SIT</span>
                <span class="metric-goal">Goal: ${user === 'J' ? '180+ sec' : '120+ sec'}</span>
            </div>
            <div class="metric-comparison">
                <div class="metric-col">
                    <div class="metric-col-label">CURRENT</div>
                    <div class="metric-value status-optimal">${baseline.wallSit}s</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${(baseline.wallSit/240)*100}%; background: var(--gold);"></div>
                    </div>
                </div>
                <div class="metric-col">
                    <div class="metric-col-label">90-DAY GOAL</div>
                    <div class="metric-value status-optimal">${user === 'J' ? '150' : '105'}s</div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: ${user === 'J' ? '62' : '43'}%; background: linear-gradient(90deg, var(--green) 0%, #00cc00 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('biometricsGrid').innerHTML = biometricsHTML;
    document.getElementById('biometricsCount').textContent = baseline.visceralFat;
}

// ==========================================
// INITIALIZATION
// ==========================================

// Initialize dashboard on page load
window.onload = function() {
    updateDashboard();
    updateBiometricsDisplay();
    loadCachedOuraData();
};
// ==========================================
// INTELLIGENCE & SCIENCE LAYER
// ==========================================

// Daily quality tracker (+/- good/bad days)
let dailyQuality = {
    sleep: 0,      // -2 to +2
    nutrition: 0,  // -2 to +2
    training: 0,   // -2 to +2
    recovery: 0,   // -2 to +2
    stress: 0      // -2 to +2
};

// Burnout detection state
let burnoutMetrics = {
    consecutiveHardDays: 0,
    hrvTrend: [],
    readinessTrend: [],
    lastRestDay: null,
    needsRest: false
};

// ==========================================
// TIME-BASED MEAL SUGGESTIONS
// ==========================================

function getTimeBasedMealSuggestions() {
    const now = new Date();
    const hour = now.getHours();
    const currentUser = user;
    const baseline = baselineData[currentUser];
    
    let suggestions = {
        timeOfDay: '',
        mealType: '',
        recommendations: [],
        reasoning: ''
    };
    
    // MORNING (5 AM - 11 AM) - BREAKFAST
    if (hour >= 5 && hour < 11) {
        suggestions.timeOfDay = 'MORNING';
        suggestions.mealType = 'BREAKFAST';
        
        if (currentUser === 'J') {
            // Jermaine's morning priorities: ApoB reduction, VO2 max support
            suggestions.recommendations = [
                {
                    meal: "Wild Salmon Bowl (Quinoa + Brussels + Flax)",
                    reason: "High omega-3 (5.5g) supports ApoB reduction. Complex carbs fuel morning training.",
                    priority: "HIGH"
                },
                {
                    meal: "Longevity Power Bowl (Sardines + Avocado + Spinach + Walnuts)",
                    reason: "Omega-3 bomb (4.2g) for cardiovascular health. Anti-inflammatory for recovery.",
                    priority: "HIGH"
                },
                {
                    meal: "Berry Longevity Smoothie (Greens + Chia + Walnuts + Cocoa)",
                    reason: "Quick pre-workout option. Antioxidants support VO2 max and reduce oxidative stress.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Morning omega-3 intake optimizes lipid metabolism throughout the day. Studies show omega-3s reduce ApoB by 15-25% when consumed consistently. Complex carbs + protein support glycogen replenishment for REFORM/UFC training.";
            
        } else {
            // Sophia's morning priorities: ANA reduction, ferritin optimization
            suggestions.recommendations = [
                {
                    meal: "Greek Yogurt Longevity Bowl (Walnuts + Berries + Flax + Kefir)",
                    reason: "Probiotics support gut health (linked to autoimmune regulation). Berries are anti-inflammatory.",
                    priority: "HIGH"
                },
                {
                    meal: "Steel-Cut Oats Ultimate (Walnuts + Berries + Hemp + Flax)",
                    reason: "Soluble fiber supports immune balance. Omega-3s reduce systemic inflammation.",
                    priority: "HIGH"
                },
                {
                    meal: "Berry Longevity Smoothie (Greens + Chia + Walnuts + Cocoa)",
                    reason: "Antioxidants combat oxidative stress. Easy digestion for sensitive mornings.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Anti-inflammatory foods in the morning set the tone for the day. Probiotics + polyphenols from berries have been shown to reduce autoimmune markers (ANA) by modulating gut-immune axis.";
        }
    }
    
    // MIDDAY (11 AM - 2 PM) - LUNCH
    else if (hour >= 11 && hour < 14) {
        suggestions.timeOfDay = 'MIDDAY';
        suggestions.mealType = 'LUNCH';
        
        if (currentUser === 'J') {
            suggestions.recommendations = [
                {
                    meal: "Sardine Power Salad (Quinoa + Kale + Avocado + Walnuts)",
                    reason: "Double sardine dose = 5.8g omega-3. Maximum ApoB impact. High fiber for satiety.",
                    priority: "HIGH"
                },
                {
                    meal: "Wild Salmon Buddha Bowl (Lentils + Greens + Seeds)",
                    reason: "48g protein supports afternoon muscle recovery. Omega-3 + fiber combo.",
                    priority: "HIGH"
                },
                {
                    meal: "Mackerel Rice Bowl (Brown Rice + Kimchi + Seaweed)",
                    reason: "Fermented foods support gut microbiome. Omega-3 (4.8g) for cardiovascular health.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Lunch is prime time for omega-3 loading. Peak absorption occurs 4-6 hours post-consumption, aligning with evening recovery. High protein maintains lean mass during caloric restriction.";
            
        } else {
            suggestions.recommendations = [
                {
                    meal: "White Fish + Shrimp Ceviche (Avocado + Cilantro + Lime)",
                    reason: "Light, anti-inflammatory. Cilantro supports heavy metal detox. Vitamin C from lime boosts iron absorption.",
                    priority: "HIGH"
                },
                {
                    meal: "Dungeness Crab Salad Bowl (Avocado + Mango + Greens)",
                    reason: "Selenium from crab supports thyroid function. Mango provides vitamin A for immune regulation.",
                    priority: "HIGH"
                },
                {
                    meal: "Cod Taco Bowl (Black Beans + Cabbage Slaw + Lime)",
                    reason: "Fiber-rich, supports gut health. Cabbage is anti-inflammatory cruciferous vegetable.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Midday anti-inflammatory focus helps manage ANA levels. Vitamin C from citrus enhances non-heme iron absorption from plant sources, addressing low ferritin without excess supplementation.";
        }
    }
    
    // AFTERNOON (2 PM - 5 PM) - SNACK
    else if (hour >= 14 && hour < 17) {
        suggestions.timeOfDay = 'AFTERNOON';
        suggestions.mealType = 'SNACK';
        
        if (currentUser === 'J') {
            suggestions.recommendations = [
                {
                    meal: "Sardine Avocado Toast (Sprouted Bread + Arugula)",
                    reason: "Pre-workout omega-3 + complex carbs. Sustains energy for evening UFC training.",
                    priority: "HIGH"
                },
                {
                    meal: "Greek Yogurt Power Cup (Walnuts + Chia + Berries)",
                    reason: "Protein + healthy fats. Anti-inflammatory antioxidants for recovery.",
                    priority: "MEDIUM"
                },
                {
                    meal: "Hard-Boiled Eggs (3) + Avocado + Kimchi",
                    reason: "Protein-rich, probiotic support. Quick prep for busy afternoons.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Afternoon snacks bridge lunch-dinner gap, preventing cortisol spikes from fasting. Omega-3s consumed 2-3 hours pre-training reduce exercise-induced inflammation.";
            
        } else {
            suggestions.recommendations = [
                {
                    meal: "Kefir Longevity Smoothie (Berries + Walnuts + Flax)",
                    reason: "Probiotic-rich for gut-immune health. Berries combat afternoon oxidative stress.",
                    priority: "HIGH"
                },
                {
                    meal: "Cottage Cheese Supreme (Walnuts + Flax + Berries + Hemp)",
                    reason: "Casein protein for sustained release. Omega-3s support immune balance.",
                    priority: "MEDIUM"
                },
                {
                    meal: "Edamame Bowl (Seaweed + Sesame + Kimchi)",
                    reason: "Plant protein + fermented foods. Iodine from seaweed supports thyroid (TSH optimization).",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Probiotics consumed between meals have maximum colonization potential. Omega-3s + antioxidants work synergistically to reduce inflammatory cytokines linked to elevated ANA.";
        }
    }
    
    // EVENING (5 PM - 9 PM) - DINNER
    else if (hour >= 17 && hour < 21) {
        suggestions.timeOfDay = 'EVENING';
        suggestions.mealType = 'DINNER';
        
        if (currentUser === 'J') {
            suggestions.recommendations = [
                {
                    meal: "Wild Salmon Centurion (Lentils + Kale + Walnuts)",
                    reason: "6.5g omega-3 for overnight recovery. 52g protein for muscle repair after training.",
                    priority: "HIGH"
                },
                {
                    meal: "Bison Organ Blend (20% Liver + Sweet Potato + Brussels)",
                    reason: "Nutrient-dense organ meats. Vitamin A, B12, iron. Supports testosterone + recovery.",
                    priority: "HIGH"
                },
                {
                    meal: "Mackerel Mediterranean (Quinoa + Olives + Greens)",
                    reason: "5.5g omega-3. Polyphenols from olives support cardiovascular health.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Evening omega-3 consumption maximizes overnight anti-inflammatory processes. Growth hormone peaks during deep sleep - protein intake supports muscle protein synthesis. Organ meats provide micronutrients often depleted by intense training.";
            
        } else {
            suggestions.recommendations = [
                {
                    meal: "Cod + White Beans (Kale + Lemon + Garlic)",
                    reason: "Light, anti-inflammatory. White beans provide folate for immune regulation.",
                    priority: "HIGH"
                },
                {
                    meal: "Whole Branzino (Lemon + Herbs + Roasted Vegetables)",
                    reason: "Omega-3 from whole fish. Herbs (rosemary, thyme) are anti-inflammatory.",
                    priority: "HIGH"
                },
                {
                    meal: "Garlic Shrimp Zoodles (Lemon + Cherry Tomatoes)",
                    reason: "Low-carb for evening. Garlic has antimicrobial + immune-supporting properties.",
                    priority: "MEDIUM"
                }
            ];
            suggestions.reasoning = "üî¨ SCIENCE: Evening meals should be anti-inflammatory and easy to digest for optimal sleep quality. Garlic and allium vegetables have been shown to modulate immune response and reduce autoimmune markers.";
        }
    }
    
    // LATE NIGHT (9 PM - 5 AM) - AVOID OR LIGHT SNACK
    else {
        suggestions.timeOfDay = 'LATE NIGHT';
        suggestions.mealType = 'LIGHT SNACK (IF NEEDED)';
        
        suggestions.recommendations = [
            {
                meal: "Kefir Longevity Smoothie (Berries + Walnuts + Flax)",
                reason: "Easy to digest. Probiotics support overnight gut repair. Magnesium aids sleep.",
                priority: "LOW"
            },
            {
                meal: "Greek Yogurt Power Cup (Walnuts + Chia + Berries)",
                reason: "Casein protein for overnight muscle recovery. Tryptophan supports sleep.",
                priority: "LOW"
            }
        ];
        suggestions.reasoning = "‚ö†Ô∏è CAUTION: Late-night eating disrupts circadian rhythm and sleep quality. If hungry, opt for easily digestible protein + healthy fats. Avoid carbs to prevent insulin spike before bed.";
    }
    
    return suggestions;
}

// ==========================================
// JUICE RECOMMENDATION ENGINE
// ==========================================

function getPersonalizedJuiceRecommendation() {
    const currentUser = user;
    const baseline = baselineData[currentUser];
    const readiness = ouraReadiness;
    
    let recommendation = {
        primary: null,
        secondary: null,
        reasoning: '',
        timing: '',
        benefits: []
    };
    
    if (currentUser === 'J') {
        // Jermaine's biomarker priorities: ApoB (85), VO2 Max (52.3)
        
        if (readiness < 70) {
            // LOW READINESS - Recovery focus
            recommendation.primary = "Green Longevity Juice (Celery + Cucumber + Spinach + Lemon)";
            recommendation.secondary = "Orange Immune Juice (Carrot + Orange + Turmeric)";
            recommendation.reasoning = "üî¨ LOW READINESS DETECTED: Focus on alkalizing, anti-inflammatory juices to support recovery. Turmeric's curcumin reduces systemic inflammation (‚ÜìhsCRP), supporting cardiovascular recovery.";
            recommendation.timing = "BEST TIME: Empty stomach, 30 min before breakfast";
            recommendation.benefits = [
                "Celery reduces blood pressure via phthalides",
                "Turmeric inhibits NF-Œ∫B inflammatory pathway",
                "Vitamin C supports cortisol regulation during stress",
                "Alkalizing effect balances pH after intense training"
            ];
            
        } else if (baseline.apoB > 80) {
            // ELEVATED APOB - Cardiovascular focus
            recommendation.primary = "Beet Vitality Juice (Beet + Carrot + Apple + Ginger)";
            recommendation.secondary = "Red Power Juice (Beet + Pomegranate + Berry)";
            recommendation.reasoning = "üî¨ APOB OPTIMIZATION: Beets are the #1 juice for cardiovascular health. Dietary nitrates convert to nitric oxide, improving endothelial function and reducing ApoB particle oxidation. Studies show 8-10% ApoB reduction with daily beet juice.";
            recommendation.timing = "BEST TIME: 2-3 hours before training for max NO‚ÇÇ effect";
            recommendation.benefits = [
                "Nitric oxide improves blood flow and VO2 max (3-5% increase)",
                "Betalains reduce LDL oxidation (key for ApoB management)",
                "Pomegranate reduces arterial plaque by 30% (clinical studies)",
                "Anthocyanins from berries improve HDL function"
            ];
            
        } else {
            // MAINTENANCE - Performance focus
            recommendation.primary = "Beet Vitality Juice (Beet + Carrot + Apple + Ginger)";
            recommendation.secondary = "Green Apple Detox (Apple + Kale + Cucumber + Mint)";
            recommendation.reasoning = "üî¨ PERFORMANCE OPTIMIZATION: Beets for VO2 max, greens for liver detox and nutrient density. Your biomarkers are solid - maintain with daily anti-inflammatory juicing.";
            recommendation.timing = "BEST TIME: Morning on empty stomach or 2 hours pre-training";
            recommendation.benefits = [
                "Beet nitrates improve oxygen efficiency during exercise",
                "Kale's chlorophyll supports liver Phase 2 detoxification",
                "Ginger reduces exercise-induced muscle soreness by 25%",
                "Beta-carotene from carrots supports immune function"
            ];
        }
        
    } else {
        // Sophia's biomarker priorities: ANA (1.2), Ferritin (28)
        
        if (readiness < 70) {
            // LOW READINESS - Recovery focus
            recommendation.primary = "Orange Immune Juice (Carrot + Orange + Turmeric)";
            recommendation.secondary = "Green Longevity Juice (Celery + Cucumber + Spinach + Lemon)";
            recommendation.reasoning = "üî¨ LOW READINESS DETECTED: Vitamin C megadose supports immune recovery. Turmeric is a powerful immune modulator, reducing autoimmune inflammation without suppressing necessary immune function.";
            recommendation.timing = "BEST TIME: Empty stomach, 30 min before breakfast";
            recommendation.benefits = [
                "Vitamin C (500mg+) supports adrenal recovery during stress",
                "Turmeric modulates T-regulatory cells (autoimmune balance)",
                "Beta-carotene supports thyroid function (TSH optimization)",
                "Alkalizing effect reduces inflammatory cytokines"
            ];
            
        } else if (baseline.ana > 1.0 || baseline.ferritin < 30) {
            // ELEVATED ANA OR LOW FERRITIN - Anti-inflammatory + Iron absorption focus
            recommendation.primary = "Orange Immune Juice (Carrot + Orange + Turmeric)";
            recommendation.secondary = "Green Longevity Juice (Celery + Cucumber + Spinach + Lemon)";
            recommendation.reasoning = "üî¨ AUTOIMMUNE OPTIMIZATION: Vitamin C enhances non-heme iron absorption (critical for low ferritin). Turmeric reduces ANA by modulating immune response. Studies show 20-40% reduction in autoimmune markers with curcumin.";
            recommendation.timing = "BEST TIME: With iron-rich meals (spinach, lentils, beans) for maximum absorption";
            recommendation.benefits = [
                "Vitamin C increases iron absorption by 300-400%",
                "Turmeric's curcumin reduces autoimmune antibodies (ANA/RF)",
                "Carrot beta-carotene converts to vitamin A (immune regulation)",
                "Ginger improves gut health (70% of immune system is gut-based)"
            ];
            
        } else {
            // MAINTENANCE - Immune balance focus
            recommendation.primary = "Green Longevity Juice (Celery + Cucumber + Spinach + Lemon)";
            recommendation.secondary = "Citrus Glow Juice (Grapefruit + Orange + Lemon)";
            recommendation.reasoning = "üî¨ IMMUNE BALANCE: Your markers are improving! Maintain with daily greens for alkalizing effect and vitamin C for continued immune support. Grapefruit supports liver detoxification.";
            recommendation.timing = "BEST TIME: Morning on empty stomach";
            recommendation.benefits = [
                "Greens provide magnesium for stress resilience",
                "Vitamin C supports collagen production (skin, joints)",
                "Grapefruit supports Phase 1 liver detoxification",
                "Alkalizing effect reduces systemic inflammation"
            ];
        }
    }
    
    return recommendation;
}

// ==========================================
// BURNOUT DETECTION & AUTO-REST PROTOCOL
// ==========================================

function checkBurnoutStatus() {
    const readiness = ouraReadiness;
    const today = new Date();
    
    // Update readiness trend (last 7 days)
    burnoutMetrics.readinessTrend.push(readiness);
    if (burnoutMetrics.readinessTrend.length > 7) {
        burnoutMetrics.readinessTrend.shift();
    }
    
    // Calculate average readiness
    const avgReadiness = burnoutMetrics.readinessTrend.reduce((a, b) => a + b, 0) / burnoutMetrics.readinessTrend.length;
    
    // BURNOUT DETECTION LOGIC
    let burnoutRisk = {
        level: 'LOW',
        indicators: [],
        recommendation: '',
        autoRestRequired: false
    };
    
    // Indicator 1: Consecutive low readiness days
    if (readiness < 70) {
        burnoutMetrics.consecutiveHardDays++;
    } else {
        burnoutMetrics.consecutiveHardDays = 0;
    }
    
    if (burnoutMetrics.consecutiveHardDays >= 3) {
        burnoutRisk.indicators.push(`‚ö†Ô∏è ${burnoutMetrics.consecutiveHardDays} consecutive days with readiness < 70`);
    }
    
    // Indicator 2: Declining readiness trend
    if (burnoutMetrics.readinessTrend.length >= 5) {
        const recentAvg = burnoutMetrics.readinessTrend.slice(-3).reduce((a, b) => a + b, 0) / 3;
        const earlierAvg = burnoutMetrics.readinessTrend.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
        
        if (recentAvg < earlierAvg - 10) {
            burnoutRisk.indicators.push(`üìâ Readiness declining: ${earlierAvg.toFixed(0)} ‚Üí ${recentAvg.toFixed(0)}`);
        }
    }
    
    // Indicator 3: Very low current readiness
    if (readiness < 60) {
        burnoutRisk.indicators.push(`üö® Critical readiness: ${readiness}/100`);
    }
    
    // Indicator 4: No recent rest day
    if (burnoutMetrics.lastRestDay) {
        const daysSinceRest = Math.floor((today - burnoutMetrics.lastRestDay) / (1000 * 60 * 60 * 24));
        if (daysSinceRest >= 6) {
            burnoutRisk.indicators.push(`‚è∞ ${daysSinceRest} days since last rest`);
        }
    }
    
    // DETERMINE BURNOUT LEVEL
    if (burnoutRisk.indicators.length >= 3 || readiness < 60 || burnoutMetrics.consecutiveHardDays >= 4) {
        burnoutRisk.level = 'HIGH';
        burnoutRisk.autoRestRequired = true;
        burnoutRisk.recommendation = `üõë MANDATORY REST DAY\n\nYour body is showing clear signs of overtraining:\n${burnoutRisk.indicators.join('\n')}\n\nüî¨ SCIENCE: Chronic under-recovery leads to elevated cortisol, suppressed testosterone, increased injury risk, and diminished training adaptations. Rest is when you get stronger, not during training.\n\n‚úÖ TODAY'S PROTOCOL: Complete rest or light yoga/walking only. Focus on sleep, nutrition, and recovery.`;
        
        // Auto-set protocol to REST DAY
        todayProtocol = 'REST DAY';
        document.getElementById('protocolName').textContent = 'REST DAY';
        document.getElementById('protocolScore').textContent = '95';
        
    } else if (burnoutRisk.indicators.length >= 2 || readiness < 70 || burnoutMetrics.consecutiveHardDays >= 2) {
        burnoutRisk.level = 'MEDIUM';
        burnoutRisk.recommendation = `‚ö†Ô∏è RECOVERY FOCUS RECOMMENDED\n\nYour readiness indicates elevated fatigue:\n${burnoutRisk.indicators.join('\n')}\n\nüî¨ SCIENCE: Training stress + life stress are cumulative. When readiness drops, training intensity should decrease to prevent overtraining syndrome.\n\n‚úÖ TODAY'S PROTOCOL: Consider light activity (REFORM, Yoga) or reduce training volume by 30-40%. Prioritize sleep and anti-inflammatory nutrition.`;
        
    } else if (avgReadiness >= 85 && readiness >= 80) {
        burnoutRisk.level = 'OPTIMAL';
        burnoutRisk.recommendation = `‚úÖ READY TO PERFORM\n\nYour recovery metrics are excellent! You're primed for high-intensity training.\n\nüî¨ SCIENCE: High readiness = optimal HRV, low resting HR, quality sleep. This is your window for progressive overload.\n\n‚úÖ TODAY'S PROTOCOL: Full intensity training (UFC GYM, CS4, Boxing). Your body can handle the stress and will adapt positively.`;
    }
    
    burnoutMetrics.needsRest = burnoutRisk.autoRestRequired;
    
    return burnoutRisk;
}

function markRestDay() {
    burnoutMetrics.lastRestDay = new Date();
    burnoutMetrics.consecutiveHardDays = 0;
}

// ==========================================
// DAILY QUALITY TRACKER (+/-)
// ==========================================

function updateDailyQuality() {
    const readiness = ouraReadiness;
    const nutritionScore = parseInt(document.getElementById('nutritionScore').textContent) || 0;
    const caloriesGoal = macroTargets[user].calories;
    const actualCalories = dailyNutrition.calories;
    
    // SLEEP QUALITY (based on Oura readiness)
    if (readiness >= 85) dailyQuality.sleep = 2;       // ++
    else if (readiness >= 75) dailyQuality.sleep = 1;  // +
    else if (readiness >= 65) dailyQuality.sleep = 0;  // neutral
    else if (readiness >= 55) dailyQuality.sleep = -1; // -
    else dailyQuality.sleep = -2;                       // --
    
    // NUTRITION QUALITY (based on macro adherence)
    if (nutritionScore >= 90) dailyQuality.nutrition = 2;
    else if (nutritionScore >= 75) dailyQuality.nutrition = 1;
    else if (nutritionScore >= 60) dailyQuality.nutrition = 0;
    else if (nutritionScore >= 40) dailyQuality.nutrition = -1;
    else dailyQuality.nutrition = -2;
    
    // TRAINING QUALITY (based on calories burned vs goal)
    const trainingPercent = (caloriesBurned / 700) * 100;
    if (trainingPercent >= 100) dailyQuality.training = 2;
    else if (trainingPercent >= 80) dailyQuality.training = 1;
    else if (trainingPercent >= 50) dailyQuality.training = 0;
    else if (trainingPercent >= 30) dailyQuality.training = -1;
    else dailyQuality.training = -2;
    
    // RECOVERY QUALITY (inverse of training - rest is valuable)
    if (todayProtocol === 'REST DAY') {
        dailyQuality.recovery = 2; // Rest days are excellent for recovery
    } else if (readiness >= 75 && trainingPercent < 100) {
        dailyQuality.recovery = 1; // Good readiness with moderate training
    } else if (readiness < 65 && trainingPercent >= 100) {
        dailyQuality.recovery = -2; // Low readiness but high training = poor recovery
    } else {
        dailyQuality.recovery = 0;
    }
    
    // CALCULATE OVERALL DAY QUALITY
    const totalScore = dailyQuality.sleep + dailyQuality.nutrition + dailyQuality.training + dailyQuality.recovery;
    
    let dayQuality = {
        score: totalScore,
        rating: '',
        emoji: '',
        color: ''
    };
    
    if (totalScore >= 6) {
        dayQuality.rating = 'EXCEPTIONAL DAY';
        dayQuality.emoji = 'üî•üî•';
        dayQuality.color = 'var(--green)';
    } else if (totalScore >= 4) {
        dayQuality.rating = 'GREAT DAY';
        dayQuality.emoji = '‚úÖ';
        dayQuality.color = 'var(--green)';
    } else if (totalScore >= 2) {
        dayQuality.rating = 'GOOD DAY';
        dayQuality.emoji = 'üëç';
        dayQuality.color = 'var(--gold)';
    } else if (totalScore >= 0) {
        dayQuality.rating = 'AVERAGE DAY';
        dayQuality.emoji = '‚ûñ';
        dayQuality.color = 'var(--text-dim)';
    } else if (totalScore >= -2) {
        dayQuality.rating = 'RECOVERY NEEDED';
        dayQuality.emoji = '‚ö†Ô∏è';
        dayQuality.color = '#FFA500';
    } else {
        dayQuality.rating = 'POOR DAY';
        dayQuality.emoji = 'üö®';
        dayQuality.color = 'var(--red)';
    }
    
    return dayQuality;
}

// ==========================================
// SMART SUGGESTION ENGINE
// ==========================================

function generateSmartSuggestions() {
    const suggestions = [];
    const burnout = checkBurnoutStatus();
    const mealSuggestions = getTimeBasedMealSuggestions();
    const juiceRec = getPersonalizedJuiceRecommendation();
    const dayQuality = updateDailyQuality();
    
    // PRIORITY 1: Burnout/Rest
    if (burnout.autoRestRequired) {
        suggestions.push({
            priority: 'CRITICAL',
            category: 'RECOVERY',
            title: 'üõë MANDATORY REST DAY',
            message: burnout.recommendation,
            action: 'Set protocol to REST DAY',
            actionFunction: () => selectProtocol('REST DAY')
        });
    } else if (burnout.level === 'MEDIUM') {
        suggestions.push({
            priority: 'HIGH',
            category: 'RECOVERY',
            title: '‚ö†Ô∏è RECOVERY FOCUS',
            message: burnout.recommendation,
            action: 'Switch to light protocol (REFORM/Yoga)',
            actionFunction: () => openProtocolSelector()
        });
    }
    
    // PRIORITY 2: Nutrition timing
    if (mealSuggestions.recommendations.length > 0) {
        const topMeal = mealSuggestions.recommendations[0];
        suggestions.push({
            priority: 'HIGH',
            category: 'NUTRITION',
            title: `üçΩÔ∏è ${mealSuggestions.timeOfDay} - ${mealSuggestions.mealType}`,
            message: `${topMeal.meal}\n\n${topMeal.reason}\n\n${mealSuggestions.reasoning}`,
            action: 'View meal options',
            actionFunction: () => openMealLogger()
        });
    }
    
    // PRIORITY 3: Juice recommendation
    if (juiceRec.primary) {
        suggestions.push({
            priority: 'MEDIUM',
            category: 'OPTIMIZATION',
            title: `üßÉ PERSONALIZED JUICE`,
            message: `${juiceRec.primary}\n\n${juiceRec.reasoning}\n\n‚è∞ ${juiceRec.timing}\n\n‚ú® Benefits:\n${juiceRec.benefits.map(b => `‚Ä¢ ${b}`).join('\n')}`,
            action: 'View juice recipes',
            actionFunction: () => openMealLogger()
        });
    }
    
    // PRIORITY 4: Day quality feedback
    suggestions.push({
        priority: 'INFO',
        category: 'TRACKING',
        title: `${dayQuality.emoji} ${dayQuality.rating}`,
        message: `Overall Score: ${dayQuality.score}/8\n\nüí§ Sleep: ${'‚òÖ'.repeat(Math.max(0, dailyQuality.sleep + 2))}${'‚òÜ'.repeat(Math.max(0, 2 - dailyQuality.sleep))}\nü•ó Nutrition: ${'‚òÖ'.repeat(Math.max(0, dailyQuality.nutrition + 2))}${'‚òÜ'.repeat(Math.max(0, 2 - dailyQuality.nutrition))}\nüî• Training: ${'‚òÖ'.repeat(Math.max(0, dailyQuality.training + 2))}${'‚òÜ'.repeat(Math.max(0, 2 - dailyQuality.training))}\nüßò Recovery: ${'‚òÖ'.repeat(Math.max(0, dailyQuality.recovery + 2))}${'‚òÜ'.repeat(Math.max(0, 2 - dailyQuality.recovery))}`,
        action: null
    });
    
    return suggestions;
}

// ==========================================
// DISPLAY SUGGESTIONS TO USER
// ==========================================

function showDailySuggestions() {
    const suggestions = generateSmartSuggestions();
    
    let html = '<div style="padding: 20px;">';
    html += '<div style="font-size: 1.2rem; font-weight: 800; color: var(--gold); margin-bottom: 20px;">ü§ñ DAILY INTELLIGENCE BRIEFING</div>';
    
    suggestions.forEach(sug => {
        const priorityColors = {
            'CRITICAL': 'var(--red)',
            'HIGH': '#FFA500',
            'MEDIUM': 'var(--gold)',
            'INFO': 'var(--text-dim)'
        };
        
        html += `
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${priorityColors[sug.priority]};">
                <div style="font-size: 0.65rem; color: ${priorityColors[sug.priority]}; font-weight: 800; margin-bottom: 8px;">${sug.category}</div>
                <div style="font-size: 0.85rem; font-weight: 700; color: var(--text); margin-bottom: 10px;">${sug.title}</div>
                <div style="font-size: 0.75rem; line-height: 1.6; color: var(--text); white-space: pre-line;">${sug.message}</div>
                ${sug.action ? `<button class="action-btn" style="margin-top: 10px; padding: 10px 15px; font-size: 0.75rem;" onclick="${sug.actionFunction ? sug.actionFunction.name + '()' : ''}">${sug.action}</button>` : ''}
            </div>
        `;
    });
    
    html += '</div>';
    
    // Create modal for suggestions
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'suggestionsModal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ü§ñ CENTURION INTELLIGENCE</div>
                <button class="close-btn" onclick="document.getElementById('suggestionsModal').remove()">√ó</button>
            </div>
            ${html}
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Auto-show suggestions on Oura sync
const originalUpdateOura = updateOura;
updateOura = async function() {
    await originalUpdateOura();
    
    // After Oura sync, check if we should show suggestions
    setTimeout(() => {
        const burnout = checkBurnoutStatus();
        if (burnout.level === 'HIGH' || burnout.level === 'MEDIUM') {
            showDailySuggestions();
        }
    }, 1000);
};

</script>
</body>
</html>






