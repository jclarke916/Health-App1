<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centurion v9700.1 DEBUG</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: 'JetBrains Mono', monospace; padding: 15px; font-size: 11px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .btn { background: #222; border: 1px solid #444; color: #fff; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn.active { background: #00f0ff; color: #000; }
        
        #log-console { 
            background: #0a0a0a; border: 1px solid #333; border-radius: 8px; 
            height: 500px; overflow-y: auto; padding: 10px; margin-bottom: 20px;
            white-space: pre-wrap; word-break: break-all;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .t-stamp { color: #666; margin-right: 8px; }
        .c-info { color: #00f0ff; }
        .c-warn { color: #ffd60a; font-weight: bold; }
        .c-error { color: #ff453a; font-weight: bold; background: rgba(255, 69, 58, 0.15); display:block; padding:2px; }
        .c-success { color: #30d158; }
        .c-debug { color: #bf5af2; }
    </style>
</head>
<body>

    <div class="header">
        <div>V9700.1 PROBE</div>
        <div>
            <button id="btn-J" class="btn active" onclick="app.switchUser('jermaine')">JER</button>
            <button id="btn-S" class="btn" onclick="app.switchUser('sophia')">SOPH</button>
        </div>
    </div>

    <div id="log-console"></div>
    <button class="btn" style="width:100%; border-color:#00f0ff; color:#00f0ff;" onclick="app.fetchData()">FORCE SYNC (DIAGNOSTIC)</button>

<script>
const TOKENS = { 'jermaine': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 'sophia': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };
const GEMINI_API_KEY = "AIzaSyCHZvxl_YvhDxZQFuZ1RuriCFasaKSDero";

function log(msg, type='info') {
    const box = document.getElementById('log-console');
    const time = new Date().toLocaleTimeString().split(' ')[0];
    box.innerHTML += `<div class="log-line"><span class="t-stamp">[${time}]</span><span class="c-${type}">${msg}</span></div>`;
    box.scrollTop = box.scrollHeight;
}

const app = {
    user: 'jermaine',
    
    init: function() { this.switchUser('jermaine'); },

    switchUser: function(uid) {
        this.user = uid;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById(uid === 'jermaine' ? 'btn-J' : 'btn-S').classList.add('active');
        log(`User Switched: ${uid.toUpperCase()}`, 'info');
    },

    fetchData: async function() {
        const token = TOKENS[this.user];
        const today = new Date(); today.setHours(12,0,0,0);
        const todayStr = today.toISOString().split('T')[0];
        const start = new Date(); start.setDate(start.getDate() - 3);
        const startStr = start.toISOString().split('T')[0];
        
        log('=================================', 'info');
        log(`SYNC TARGET: ${todayStr}`, 'warn');

        try {
            // 1. FETCH RAW DATA
            log(`Fetching Oura Data (${startStr} to ${todayStr})...`, 'info');
            const cb = `&t=${Date.now()}`;
            
            const [rRes, dsRes, sRes] = await Promise.all([
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${startStr}&end_date=${todayStr}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_sleep?start_date=${startStr}&end_date=${todayStr}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${todayStr}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            if(!rRes.ok) throw new Error(`Readiness API Failed: ${rRes.status}`);
            if(!sRes.ok) throw new Error(`Sleep Sessions API Failed: ${sRes.status}`);

            const rData = await rRes.json();
            const dsData = await dsRes.json();
            const sData = await sRes.json();

            log(`Readiness: ${rData.data?.length || 0} records`, 'success');
            log(`Daily Sleep: ${dsData.data?.length || 0} records`, 'success');
            log(`Sleep Sessions: ${sData.data?.length || 0} records`, 'success');

            if(!rData.data || rData.data.length === 0) {
                log('STOPPING: No readiness data to process.', 'error');
                return;
            }

            // 2. PROCESS SPECIFIC TARGET DAY
            log(`Processing specific day: ${todayStr}`, 'warn');
            
            // A. Readiness
            const todayReadiness = rData.data.find(r => r.day === todayStr);
            if(todayReadiness) {
                log(`> Readiness found: ${todayReadiness.score}`, 'success');
            } else {
                log(`> Readiness MISSING for ${todayStr}`, 'error');
            }

            // B. YESTERDAY CALCULATION
            const yObj = new Date(todayStr); // Parse "2026-01-05"
            yObj.setDate(yObj.getDate() - 1); // Subtract 1 day
            const prevKey = yObj.toISOString().split('T')[0]; // "2026-01-04"
            
            log(`> Calculated Yesterday: ${prevKey}`, 'debug');

            // C. SLEEP SESSION SEARCH
            let sessions = [];
            if(sData.data) {
                sessions = sData.data.filter(s => s.day === prevKey);
            }
            
            if(sessions.length > 0) {
                log(`> Found ${sessions.length} sessions for ${prevKey} (Yesterday)`, 'success');
                let total = 0;
                sessions.forEach(s => total += s.total_sleep_duration);
                log(`> Total Sleep: ${(total/3600).toFixed(1)} hrs`, 'success');
            } else {
                log(`> NO SESSIONS found for yesterday (${prevKey})`, 'error');
                log(`> Raw Data Dump for ${prevKey}:`, 'debug');
                // Dump nearby dates to see what's available
                sData.data.forEach(s => log(`  - Available: ${s.day} (${s.type})`, 'info'));
            }

            // 3. GEMINI TEST
            log('Testing Gemini API...', 'warn');
            try {
                const aiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const aiRes = await fetch(aiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Ping. Reply with 'Pong'." }] }] })
                });
                
                if(!aiRes.ok) throw new Error(`Gemini status ${aiRes.status}`);
                const aiData = await aiRes.json();
                const reply = aiData.candidates[0].content.parts[0].text;
                log(`> Gemini Reply: ${reply.trim()}`, 'success');
            } catch(gemErr) {
                log(`> Gemini Failed: ${gemErr.message}`, 'error');
            }

            log('DIAGNOSTIC COMPLETE', 'success');

        } catch(e) {
            log(`[CRITICAL ERROR]: ${e.message}`, 'error');
            log(e.stack, 'error');
        }
    }
};

app.init();
</script>
</body>
</html>