<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v17.70 STABLE</title>
<style>
/* CORE */
:root{--bg:#050505;--panel:#121212;--border:#222;--acid:#ccff00;--cyan:#00f0ff;--purple:#bf5af2;--alert:#ff453a;--text:#fff}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);padding-bottom:120px}
/* LAYOUT */
.header{background:rgba(10,10,10,0.98);padding:15px;border-bottom:1px solid #333;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;padding:0 15px;margin-bottom:20px}
/* CONTROLS */
.user-switch{display:flex;background:#1a1a1a;padding:4px;border-radius:24px;border:1px solid #333;margin-bottom:12px}
.user-switch button{flex:1;padding:10px;border:none;background:none;color:#666;border-radius:20px;font-weight:800;font-size:0.7rem;transition:0.2s}
.user-switch button.active{background:var(--acid);color:#000;box-shadow:0 0 15px rgba(204,255,0,0.3)}
.date-nav{display:flex;justify-content:space-between;align-items:center;background:#000;border:1px solid #333;border-radius:10px;padding:8px}
.nav-btn{background:none;border:none;color:var(--cyan);font-size:1.4rem;padding:0 20px;cursor:pointer}
#dateLabel{font-weight:700;font-family:monospace;letter-spacing:1px}
.bio-btn{position:absolute;right:15px;top:15px;background:rgba(255,255,255,0.1);color:var(--acid);border:1px solid var(--acid);padding:6px 12px;border-radius:6px;font-size:0.6rem;font-weight:900}
/* DASHBOARD */
.hero{padding:25px 15px;display:flex;gap:20px;align-items:center;justify-content:center}
.score-box{width:90px;height:90px;border-radius:50%;background:radial-gradient(circle,rgba(204,255,0,0.1) 0%,transparent 70%);border:3px solid var(--acid);display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(204,255,0,0.15)}
.score-val{font-size:2.2rem;font-weight:900;color:#fff;line-height:1}
.score-lbl{font-size:0.5rem;color:var(--acid);margin-top:4px;font-weight:900;letter-spacing:1px}
/* ORBS */
.orb-card{background:#111;border:1px solid #222;border-radius:12px;padding:10px 5px;display:flex;flex-direction:column;align-items:center}
.orb-con{width:50px;height:50px;position:relative;margin-bottom:6px}
.orb-svg{transform:rotate(-90deg);width:100%;height:100%}
.orb-bg{fill:none;stroke:#222;stroke-width:4}
.orb-fg{fill:none;stroke-width:4;stroke-dasharray:126;stroke-dashoffset:126;transition:stroke-dashoffset 1s ease}
.orb-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:monospace;font-size:0.65rem;font-weight:900}
.orb-lbl{font-size:0.45rem;color:#888;font-weight:900}
/* TIMELINE */
.section-header{padding:0 15px;margin:20px 0 10px;font-size:0.7rem;color:var(--cyan);font-weight:900;letter-spacing:1px}
.task{display:flex;gap:12px;margin-bottom:12px;padding:0 15px;align-items:center}
.task-time{width:45px;text-align:right;font-family:monospace;font-size:0.75rem;color:#666;font-weight:700}
.task-card{flex:1;background:linear-gradient(180deg,#141414 0%,#0a0a0a 100%);border:1px solid #333;border-radius:10px;padding:15px;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s}
.task-card:active{transform:scale(0.98);background:#222}
.task-card.checked{border-color:var(--acid);background:rgba(204,255,0,0.08);box-shadow:0 0 15px rgba(204,255,0,0.05)}
.task-card.auto{border-color:var(--cyan);background:rgba(0,240,255,0.05)}
.task-title{font-weight:900;font-size:0.9rem;margin-bottom:3px;color:#fff}
.task-desc{font-size:0.7rem;color:#888;line-height:1.3}
.check-btn{width:28px;height:28px;border:2px solid #444;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:0.2s}
.task-card.checked .check-btn{background:var(--acid);border-color:var(--acid);color:#000;font-weight:900}
.chevron{color:#444;font-size:1.5rem;font-weight:900;margin-left:10px}
.task-card.checked .chevron{color:var(--acid)}
/* MODAL */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:200;display:none;backdrop-filter:blur(5px)}
.modal-overlay.show{display:block}
.modal-content{padding:25px;padding-bottom:100px;overflow-y:auto;height:100vh}
.menu-item{padding:18px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
.menu-name{font-weight:900;font-size:1rem;margin-bottom:5px}
.menu-meta{font-size:0.7rem;color:#888;font-family:monospace}
/* FOOTER */
.footer{position:fixed;bottom:0;left:0;width:100%;background:#050505;border-top:1px solid #333;padding:15px;display:flex;justify-content:space-between;align-items:center;z-index:100}
.sync-stat{font-size:0.6rem;color:#555;font-family:monospace}
.sync-btn{background:var(--acid);color:#000;border:none;padding:10px 20px;border-radius:8px;font-weight:900;font-size:0.7rem}
</style>
</head>
<body>

<div class="header">
    <div class="user-switch">
        <button id="btn-jermaine" class="active" onclick="app.switchUser('jermaine')">JERMAINE</button>
        <button id="btn-sophia" onclick="app.switchUser('sophia')">SOPHIA</button>
    </div>
    <div class="date-nav">
        <button class="nav-btn" onclick="app.changeDate(-1)">â—€</button>
        <span id="dateLabel">LOADING...</span>
        <button class="nav-btn" onclick="app.changeDate(1)">â–¶</button>
    </div>
    <button class="bio-btn" onclick="app.openBio()">BIO</button>
</div>

<div class="hero">
    <div class="score-box">
        <div class="score-val" id="longevityScore">--</div>
        <div class="score-lbl">READY</div>
    </div>
    <div class="grid-2" style="flex:1; margin-left:15px;">
        <div style="background:#111; border:1px solid #333; border-radius:10px; padding:10px; text-align:center;">
            <div style="font-size:0.6rem; color:#888;">SLEEP</div>
            <div style="font-size:1.1rem; font-weight:900; color:#fff;" id="heroSleep">--</div>
        </div>
        <div style="background:#111; border:1px solid #333; border-radius:10px; padding:10px; text-align:center;">
            <div style="font-size:0.6rem; color:#888;">PROTEIN</div>
            <div style="font-size:1.1rem; font-weight:900; color:#fff;" id="heroProtein">0g</div>
        </div>
    </div>
</div>

<div class="section-header">BIO-METRICS (OURA)</div>
<div class="grid-4">
    <div class="orb-card"><div class="orb-con"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="20"></circle><circle class="orb-fg" id="orb-sleep" cx="25" cy="25" r="20" style="stroke:#bf5af2"></circle></svg><div class="orb-txt" id="val-sleep">0</div></div><div class="orb-lbl">SLEEP</div></div>
    <div class="orb-card"><div class="orb-con"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="20"></circle><circle class="orb-fg" id="orb-deep" cx="25" cy="25" r="20" style="stroke:#00f0ff"></circle></svg><div class="orb-txt" id="val-deep">0</div></div><div class="orb-lbl">DEEP</div></div>
    <div class="orb-card"><div class="orb-con"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="20"></circle><circle class="orb-fg" id="orb-rem" cx="25" cy="25" r="20" style="stroke:#00f0ff"></circle></svg><div class="orb-txt" id="val-rem">0</div></div><div class="orb-lbl">REM</div></div>
    <div class="orb-card"><div class="orb-con"><svg class="orb-svg" viewBox="0 0 50 50"><circle class="orb-bg" cx="25" cy="25" r="20"></circle><circle class="orb-fg" id="orb-rhr" cx="25" cy="25" r="20" style="stroke:#ff453a"></circle></svg><div class="orb-txt" id="val-rhr">0</div></div><div class="orb-lbl">RHR</div></div>
</div>

<div class="section-header">CENTURION PROTOCOL</div>
<div id="timeline"></div>

<div class="modal-overlay" id="mainModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 id="modalTitle" style="margin:0; font-weight:900; color:#fff;">DETAILS</h2>
            <button onclick="app.closeModal()" style="background:none; border:none; color:#fff; font-size:1.5rem;">âœ•</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<div class="footer">
    <span class="sync-stat" id="syncStatus">CONNECTED</span>
    <button class="sync-btn" onclick="app.sync()">ðŸ”„ SYNC</button>
</div>

<script>
// --- CONFIGURATION ---
const USERS = {
    jermaine: { name: "Jermaine", token: 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', goals: { protein: 175 } },
    sophia: { name: "Sophia", token: '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4', goals: { protein: 130 } }
};

const DB = {
    breakfast: [
        {title:"Greek Yogurt & Berries", p:20, cal:250, why:"Probiotics"},
        {title:"Smoked Salmon Toast", p:28, cal:450, why:"Omega-3"},
        {title:"Omega Breakfast", p:58, cal:680, why:"High Protein"},
        {title:"Sea Moss Oatmeal", p:48, cal:580, why:"Thyroid"},
        {title:"Protein Pancakes", p:52, cal:620, why:"Anabolic"}
    ],
    lunch: [
        {title:"Salmon & Quinoa Bowl", p:48, cal:780, why:"Fiber + Omega-3"},
        {title:"Bison Burger", p:42, cal:550, why:"Heme Iron"},
        {title:"Turkey Club Wrap", p:38, cal:540, why:"Lean Protein"},
        {title:"Salmon Poke Bowl", p:45, cal:580, why:"Raw Enzymes"},
        {title:"Chipotle Bowl (Bison)", p:58, cal:740, why:"Massive Fiber"}
    ],
    dinner: [
        {title:"Bone Broth Pho", p:40, cal:450, why:"Collagen"},
        {title:"Grass-Fed Steak", p:60, cal:720, why:"Creatine"},
        {title:"Whole Branzino", p:52, cal:580, why:"Glycine"},
        {title:"Turkey Chili", p:35, cal:500, why:"Comfort"},
        {title:"Beef Bolognese", p:40, cal:550, why:"Iron Rich"}
    ],
    snack: [
        {title:"Hard Boiled Eggs", p:12, cal:140, why:"Choline"},
        {title:"Bone Broth Cup", p:10, cal:45, why:"Gut Health"},
        {title:"Beef Jerky", p:12, cal:80, why:"Protein"},
        {title:"Protein Balls", p:12, cal:220, why:"Energy"}
    ]
};

const PROTOCOLS = {
    microcurrent: {title:"âš¡ MICROCURRENT", steps:["1. CLEANSE oil-free","2. GEL thick layer","3. GLIDE jaw to ear","4. LIFT cheek to temple","5. HOLD brows up","6. 3-5 mins per side"]},
    microneedling: {title:"ðŸ“ MICRONEEDLING", steps:["1. SANITIZE device","2. DOUBLE CLEANSE","3. SERUM (HA Only)","4. CROSS HATCH pattern","5. 0.5mm forehead / 1.0mm cheek","6. NO actives 24hrs"]},
    cupping: {title:"ðŸ”µ BACK CUPPING", steps:["1. OIL back","2. PLACE cups on traps","3. SLIDE along spine muscles","4. STATIC on knots (3m max)","5. AVOID spine bone","6. DRINK water"]},
    normatec: {title:"ðŸ¦µ NORMATEC", steps:["1. LEGS attachment","2. LEVEL 7 (Flush) or 5 (Relax)","3. 30-45 Minutes","4. ZONE BOOST quads if sore"]},
    inshape: {title:"ðŸŠ INSHAPE RITUAL", steps:["1. STEAM 15m","2. SAUNA 20m","3. POOL 20m","4. AQUA BED 30m","5. COLD SHOWER"]},
    massage: {title:"ðŸ’† LYMPHATIC", steps:["1. OIL face","2. PUMP collarbone","3. SWEEP neck down","4. GLIDE chin to ear","5. DRAIN down neck"]}
};

class CenturionApp {
    constructor() {
        this.user = localStorage.getItem('c_user') || 'jermaine';
        this.todayKey = new Date().toLocaleDateString('en-CA'); // Fix timezone issue
        
        // Init Storage
        const raw = localStorage.getItem(`c_data_${this.user}`);
        this.data = raw ? JSON.parse(raw) : {};
        if (!this.data[this.todayKey]) this.data[this.todayKey] = { checked: [], meals: {} };
        
        this.render();
        setTimeout(() => this.sync(), 100);
    }

    switchUser(u) {
        document.getElementById(`btn-${this.user}`).classList.remove('active');
        this.user = u;
        localStorage.setItem('c_user', u);
        document.getElementById(`btn-${u}`).classList.add('active');
        
        // Re-load data for new user
        this.todayKey = new Date().toLocaleDateString('en-CA');
        const raw = localStorage.getItem(`c_data_${this.user}`);
        this.data = raw ? JSON.parse(raw) : {};
        if (!this.data[this.todayKey]) this.data[this.todayKey] = { checked: [], meals: {} };
        
        this.render();
        this.sync();
    }

    changeDate(dir) {
        const curr = new Date(this.todayKey);
        curr.setDate(curr.getDate() + dir);
        this.todayKey = curr.toLocaleDateString('en-CA');
        
        if (!this.data[this.todayKey]) this.data[this.todayKey] = { checked: [], meals: {} };
        this.render();
    }

    save() {
        localStorage.setItem(`c_data_${this.user}`, JSON.stringify(this.data));
        this.render();
    }

    toggle(id) {
        const list = this.data[this.todayKey].checked;
        const idx = list.indexOf(id);
        if (idx > -1) list.splice(idx, 1); else list.push(id);
        this.save();
    }

    // --- PROTOCOL LOGIC ---
    getFacial(d) {
        if (this.user === 'jermaine') {
            if (d === 0) return { key: 'microneedling', title: 'Microneedling' }; // Sunday
            if (d === 1 || d === 3 || d === 5) return { key: 'microcurrent', title: 'Microcurrent' };
            return { key: 'massage', title: 'Massage' };
        } else {
            if (d === 2 || d === 4) return { key: 'massage', title: 'Recovery Facial' };
            return { key: 'massage', title: 'Maint. Facial' };
        }
    }

    getRecovery(d) {
        if (d === 0) return { key: 'inshape', title: 'InShape Ritual' };
        if (d === 2 || d === 4) return { key: 'cupping', title: 'Back Cupping' };
        return { key: 'normatec', title: 'Normatec' };
    }

    // --- RENDERING ---
    render() {
        const day = this.data[this.todayKey];
        document.getElementById('dateLabel').innerText = this.todayKey;
        
        // 1. Build Task List
        const dow = new Date(this.todayKey).getDay(); // 0=Sun, 1=Mon...
        const facial = this.getFacial(dow);
        const recovery = this.getRecovery(dow);

        const tasks = [
            { id: 't1', time: '07:30', title: 'Breakfast', slot: 'breakfast' },
            { id: 't2', time: '09:00', title: 'Training', auto: true },
            { id: 't3', time: '13:00', title: 'Lunch', slot: 'lunch' },
            { id: 't4', time: '15:30', title: 'Snack', slot: 'snack' },
            { id: 't5', time: '18:30', title: 'Dinner', slot: 'dinner' },
            { id: 't6', time: '20:00', title: recovery.title, proto: recovery.key, type: 'recovery' },
            { id: 't7', time: '21:15', title: facial.title, proto: facial.key, type: 'facial' }
        ];

        // 2. Generate HTML
        let html = '';
        let totalP = 0;

        tasks.forEach(t => {
            const isChecked = day.checked.includes(t.id);
            let sub = "Tap to set";
            let action = "";
            let css = "";

            // Handle Meals
            if (t.slot) {
                const mealIdx = day.meals[t.slot];
                if (mealIdx !== undefined && MEAL_DATABASE[t.slot][mealIdx]) {
                    const m = MEAL_DATABASE[t.slot][mealIdx];
                    sub = `${m.title} (${m.p}g P)`;
                    totalP += m.p;
                    css = "checked"; // Highlight if meal selected
                }
                action = `onclick="app.openPicker('${t.slot}')"`;
            }

            // Handle Protocols
            if (t.proto) {
                sub = "Tap for protocol";
                action = `onclick="app.openProtocol('${t.proto}')"`;
                if(t.type === 'recovery') css = 'auto';
                if(t.type === 'facial') css = 'auto';
            }
            
            if (t.auto) { sub = "Auto-Detect"; css = "auto"; }
            if (isChecked) css += " checked";

            html += `
            <div class="task">
                <div class="task-time">${t.time}</div>
                <div class="task-card ${css}" ${action}>
                    <div>
                        <div class="task-title">${t.title}</div>
                        <div class="task-desc">${sub}</div>
                    </div>
                    ${!t.auto ? `<div class="check-btn" onclick="event.stopPropagation(); app.toggle('${t.id}')">${isChecked ? 'âœ“' : ''}</div>` : ''}
                </div>
            </div>`;
        });

        document.getElementById('timeline').innerHTML = html;
        
        // Update Hero Metrics
        document.getElementById('heroProtein').innerText = totalP + 'g';
    }

    // --- MODALS ---
    openPicker(slot) {
        const list = MEAL_DATABASE[slot];
        let h = '';
        list.forEach((m, i) => {
            h += `<div class="menu-item" onclick="app.selectMeal('${slot}', ${i})">
                <div>
                    <div class="menu-name">${m.title}</div>
                    <div class="menu-meta">Protein: ${m.p}g â€¢ ${m.why}</div>
                </div>
                <div style="font-size:1.5rem">â€º</div>
            </div>`;
        });
        document.getElementById('modalTitle').innerText = slot.toUpperCase();
        document.getElementById('modalBody').innerHTML = h;
        document.getElementById('mainModal').classList.add('show');
    }

    selectMeal(slot, idx) {
        this.data[this.todayKey].meals[slot] = idx;
        this.save(); // Renders automatically
        this.closeModal();
    }

    openProtocol(key) {
        const p = PROTOCOLS[key];
        document.getElementById('modalTitle').innerText = p.title;
        document.getElementById('modalBody').innerHTML = p.steps.map(s => 
            `<div style="padding:15px; border-bottom:1px solid #333; color:#ccc;">${s}</div>`
        ).join('');
        document.getElementById('mainModal').classList.add('show');
    }

    openBio() {
        // Simple Bio Placeholder
        document.getElementById('modalTitle').innerText = "BIOMETRICS";
        document.getElementById('modalBody').innerHTML = `<div style="text-align:center; padding:20px; color:#888;">Bio-Marker inputs coming in v18</div>`;
        document.getElementById('mainModal').classList.add('show');
    }

    closeModal() { document.getElementById('mainModal').classList.remove('show'); }

    // --- OURA SYNC ---
    async sync() {
        document.getElementById('syncStatus').innerText = 'SYNCING...';
        const token = USERS[this.user].token;
        const start = new Date(); start.setDate(start.getDate() - 7);
        const sStr = start.toISOString().split('T')[0];
        const eStr = new Date().toISOString().split('T')[0];

        try {
            const url = `https://corsproxy.io/?https://api.ouraring.com/v2/usercollection/sleep?start_date=${sStr}&end_date=${eStr}`;
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            
            if (!res.ok) throw new Error('Auth Error');
            
            const json = await res.json();
            if (json.data && json.data.length > 0) {
                const last = json.data[json.data.length - 1];
                this.updateOuraUI(last);
                document.getElementById('syncStatus').innerText = 'UPDATED';
            }
        } catch (e) {
            console.error(e);
            document.getElementById('syncStatus').innerText = 'OFFLINE';
        }
    }

    updateOuraUI(d) {
        // Update Orbs
        const hrs = (d.total_sleep_duration / 3600).toFixed(1);
        const deep = Math.round(d.deep_sleep_duration / 60);
        const rem = Math.round(d.rem_sleep_duration / 60);
        
        document.getElementById('val-sleep').innerText = hrs;
        document.getElementById('orb-sleep').style.strokeDashoffset = 126 - ((d.total_sleep_duration / 28800) * 126);
        
        document.getElementById('val-deep').innerText = deep;
        document.getElementById('orb-deep').style.strokeDashoffset = 126 - ((deep / 90) * 126);
        
        document.getElementById('val-rem').innerText = rem;
        document.getElementById('orb-rem').style.strokeDashoffset = 126 - ((rem / 90) * 126);

        document.getElementById('heroSleep').innerText = hrs + 'h';
        document.getElementById('longevityScore').innerText = d.score;
    }
}

// Global Init
window.app = new CenturionApp();
</script>
</body>
</html>