<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v228.7 Oura Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#050505; --card:#141414; --gold:#D4AF37; --green:#00E676; --blue:#00B0FF; --purple:#D500F9; --text:#fff;
        --g-pro:linear-gradient(90deg,#FF5252,#D50000);
        --g-carb:linear-gradient(90deg,#FFAB40,#FF6D00);
        --g-cal:linear-gradient(90deg,#B388FF,#6200EA);
        --g-fib:linear-gradient(90deg,#00E676,#00C853);}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:15px;font-size:14px}
        .container{max-width:500px;margin:0 auto; padding-bottom: 50px;}
        h1{text-align:center;font-weight:200;letter-spacing:5px;text-transform:uppercase;font-size:1.2rem;margin:10px 0}
        .version-tag { display: block; text-align: center; font-size: 0.5rem; color: #444; margin-top: -8px; margin-bottom: 15px; letter-spacing: 2px; }
        .badge-row{display:flex;justify-content:center;gap:8px;margin-bottom:15px}
        .u-badge{background:#000;padding:8px 16px;border-radius:20px;border:1px solid #333;font-size:0.6rem;font-weight:800;cursor:pointer;color:#666}
        .u-badge.active{border-color:var(--gold);color:var(--gold)}
        .status-bar{text-align:center;color:#888;font-size:0.65rem;font-weight:800;margin-bottom:10px;text-transform:uppercase}
        .controls{display:flex;gap:5px;margin-bottom:15px}
        .nav-btn{background:#111;border:1px solid #222;color:#888;padding:10px;flex:1;border-radius:8px;font-size:0.55rem;font-weight:800;cursor:pointer}
        .card, .macro-dashboard{background:var(--card);border-radius:20px;padding:20px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.03);position:relative}
        .card::before{content:"";position:absolute;left:0;top:20px;bottom:20px;width:3px;background:var(--gold);border-radius:0 4px 4px 0}
        .card.holiday-card::before{background:var(--purple);box-shadow: 0 0 15px rgba(213, 0, 249, 0.4);}
        .label{color:#666;font-size:0.5rem;text-transform:uppercase;font-weight:900;margin-bottom:4px; display: flex; justify-content: space-between;}
        .portion-tag { color: var(--blue); }
        .value{ font-size: 0.95rem; margin-bottom: 12px; font-weight: 500; cursor: pointer; border-bottom: 1px solid #222; padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
        .macro-row{margin-bottom:10px}
        .macro-label{display:flex;justify-content:space-between;font-size:0.55rem;font-weight:800;color:#777;margin-bottom:3px}
        .macro-bg{height:5px;background:#222;border-radius:10px;overflow:hidden}
        .macro-fill{height:100%;border-radius:10px;transition:width 0.8s}
        .tabs{display:flex;gap:4px;margin-bottom:15px}
        .tab{flex:1;padding:10px 0;background:#111;border:1px solid #222;color:#444;border-radius:8px;font-size:0.55rem;font-weight:800;text-align:center;cursor:pointer}
        .tab.active{background:#222;color:#fff;border-color:444}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a0a;z-index:2000;overflow-y:auto;padding:0;}
        .modal-content{background:#0a0a0a;margin:0;padding:25px;border:none;border-radius:0;width:100%;min-height:100%;max-width:none;}
        .close-btn-float { position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(30,30,30,0.8); backdrop-filter: blur(5px); border-radius: 50%; border: 1px solid #333; color: #fff; font-size: 24px; text-align: center; line-height: 38px; cursor: pointer; z-index: 2001; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .chef-steps ol{padding-left:20px; color:#ccc; margin:10px 0; font-size:0.9rem; line-height:1.6;}
        .chef-steps li{margin-bottom:12px;}
        .chef-steps strong{color:var(--gold); display:block; margin-top:20px; font-size:0.8rem; border-top:1px dashed #333; padding-top:15px;}
        .juice-name{font-size:1.1rem;font-weight:900;color:#fff;text-align:center;text-transform:uppercase;cursor:pointer;border:1px dashed #333;padding:10px;border-radius:12px}
        .bio-section{margin-bottom:25px;padding:15px;background:rgba(255,255,255,0.03);border-radius:15px;border:1px solid rgba(255,255,255,0.05)}
        .bio-title{display:flex;justify-content:space-between;font-size:0.75rem;font-weight:800;color:#fff;margin-bottom:12px;text-transform:uppercase}
        .bar-group{display:flex;flex-direction:column;gap:8px}
        .bar-row{display:flex;align-items:center}
        .bar-lbl{width:45px;font-size:0.55rem;color:#666;font-weight:900;text-transform:uppercase}
        .bar-track{flex:1;height:8px;background:#111;border-radius:10px;margin:0 10px;border:1px solid #222;overflow:hidden}
        .bar-fill{height:100%;border-radius:10px;transition:width 1s cubic-bezier(0.4,0,0.2,1)}
        .rec-phase-list { position: relative; padding-left: 25px; margin-top: 20px; }
        .rec-phase-list::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--blue), var(--purple)); }
        .phase-item { position: relative; margin-bottom: 25px; }
        .phase-item::after { content: ''; position: absolute; left: -22px; top: 5px; width: 10px; height: 10px; background: var(--bg); border: 2px solid var(--blue); border-radius: 50%; }
        .phase-time { font-size: 0.6rem; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; }
        .phase-title { display: block; font-size: 0.9rem; font-weight: 700; color: #fff; margin: 2px 0; }
        .phase-detail { font-size: 0.75rem; color: #999; line-height: 1.4; display: block; }
        .macro-pill { background: #1a1a1a; border: 1px solid #333; padding: 3px 8px; border-radius: 12px; font-size: 0.55rem; color: #888; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap; }
        .grocery-cat { font-size: 0.85rem; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-top: 30px; margin-bottom: 15px; font-weight: 900; border-bottom: 1px dashed #333; padding-bottom: 8px; }
        .grocery-item { padding: 12px 0; color: #ccc; font-size: 0.95rem; display:flex; align-items:center; border-bottom:1px solid #1a1a1a; }
        .grocery-item span { margin-left: 12px; }
        .snack-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .snack-slot { flex: 1; border: 1px dashed #333; border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer; position: relative; min-height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.02); }
        .snack-slot.filled { border: 1px solid var(--gold); background: #111; }
        .snack-label { font-size: 0.65rem; color: #fff; font-weight: 700; line-height: 1.2; }
        .snack-macro { font-size: 0.5rem; color: #666; margin-top: 4px; }
        .remove-snack { position: absolute; top: -5px; right: -5px; background: #333; color: #aaa; border: 1px solid #222; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 14px; text-align: center; font-weight: 800; box-shadow: 0 1px 3px rgba(0,0,0,0.5); z-index: 10; transition: all 0.2s ease; }
        .remove-snack:hover { background: #444; color: #fff; border-color:#333; }
        .meal-img { display: block; width: 100%; max-width: 100%; height: auto; min-height: 220px; object-fit: cover; border-radius: 14px; background-color: #111; transition: opacity 0.5s ease, filter 0.5s ease; }
        .img-loader { height: 220px; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; background: rgba(255,255,255,0.02); border-radius: 14px; border: 1px dashed #333; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .hist-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.7rem; color: #ccc; }
        .hist-table th { text-align: left; color: #666; border-bottom: 1px solid #333; padding: 5px; font-weight: 800; }
        .hist-table td { border-bottom: 1px solid #222; padding: 8px 5px; }
        .hist-row:last-child td { border-bottom: none; }
        .holiday-banner { background: linear-gradient(90deg, #D4AF37, #FDD835, #D4AF37); background-size: 200% 200%; animation: shine 3s infinite; color: #000; text-align: center; font-weight: 900; font-size: 0.75rem; padding: 10px; border-radius: 12px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }
        @keyframes shine { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .oura-hist-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 0.7rem; color: #888; }
        .oura-val { font-weight: 800; color: #fff; }
    </style>
</head>
<body>
<div class="container">
    <header><h1>THE CENTURION</h1>
        <span class="version-tag">v228.7 Oura Fix (Active)</span>
        <div class="badge-row">
            <div id="bj" class="u-badge active" onclick="switchU('J')">üßîüèæ‚Äç‚ôÇÔ∏è JERMAINE</div>
            <div id="bs" class="u-badge" onclick="switchU('S')">üë©üèæ‚Äçü¶± SOPHIA</div>
        </div>
    </header>
    <div id="dateDisplay" class="status-bar">...</div>
    <div class="controls">
        <button class="nav-btn" onclick="changeW(-1)">PREV</button>
        <button class="nav-btn" onclick="resetD()">TODAY</button>
        <button class="nav-btn" onclick="changeW(1)">NEXT</button>
        <button class="nav-btn" onclick="openBio()" style="color:var(--green)">MY DATA</button>
    </div>
    <div id="dayTabs" class="tabs"></div>
    <div id="dayContent"></div>
</div>

<div id="masterModal" class="modal">
    <div class="close-btn-float" onclick="closeM()">&times;</div>
    <div class="modal-content">
        <h2 id="mTitle" style="font-size:1.5rem; margin-top:10px;"></h2>
        <div id="mSub" style="color:var(--gold);font-size:0.85rem;margin:10px 0; text-transform:uppercase; letter-spacing:1px; font-weight:700;"></div>
        <div id="mImgContainer"></div>
        <div id="mBody" class="chef-steps" style="counter-reset:step"></div>
        <div id="mTip" class="chef-tip" style="margin-top:30px; padding:15px; border:1px solid #222; background:#111; border-radius:10px; color:#888; font-style:italic;"></div>
        <br><br><br>
    </div>
</div>
<script>
// --- GLOBAL STATE ---
let user = localStorage.getItem('centurion_active_user') || 'J';
let offset = 0;
let snackLog = {}; 
let currentSlot = 0;

// --- DUAL OURA CONFIGURATION ---
const TOKEN_J = "WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y"; // Jermaine's Key
const TOKEN_S = "4QSDWYJJUZFHRWRH727NCK7WH4COQJF4"; // Sophia's Key

function getActiveToken() {
    if (user === 'J') {
        return localStorage.getItem('centurion_oura_token_J') || TOKEN_J;
    } else {
        return TOKEN_S; 
    }
}

// --- UTILITIES ---
function getCaDate() {
    let d = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
    d.setHours(12, 0, 0, 0); 
    return d;
}

function getDateKey(d) {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

let selDate = getCaDate();

// --- DATABASES ---
const jDB = {
    // TODAY'S JUICE PIVOT: Liquid Extraction (Low Fiber, High Absorption)
    "PINEAPPLE GREEN Vitality": ["Digestion + Detox", "2c Spinach, 1c Pineapple, 1/2 Cucumber, Ginger, Lemon", 1, 28, 120, 1],
    "PLASMA FLUSH Juice": ["Recovery", "3c Watermelon, 1 Lime (Peeled), Mint", 1, 32, 140, 1],
    "TITAN RED Juice": ["Endurance", "2 Raw Beets, 2 Carrots, Pomegranate, Ginger", 2, 42, 185, 2],
    "ZENITH GREEN Juice": ["Alkalizer", "4 Kale Leaves, 1 Cucumber, Celery, Lemon", 2, 18, 120, 1],
    "APOLLO GOLD Juice": ["Anti-Inflammatory", "2 Pears, Turmeric Root, Ginger, Lemon", 1, 45, 195, 2]
};

const mDB = {
    b: [
        "Ancestral Beef Sausage ‚ö°|80/20 Beef-Liver Blend,Sage,Thyme|sear|<strong>Prep:</strong> 5m ‚Ä¢ <strong>Cook:</strong> 8m<hr><strong>INGREDIENTS</strong><br>6oz Beef/Liver Blend (80/20) ‚Ä¢ 1 tsp Sage ‚Ä¢ 1/2 tsp Thyme<br><br><strong>1. MIX</strong><br>Mix herbs into the ground blend. Form into small patties or links.<br><br><strong>2. COOK</strong><br>Pan fry until browned and cooked through. Serve with a side of berries.<br><br><strong>Longevity Win:</strong> The 20% liver content is masked by the savory herbs, providing massive Vitamin A.|25|2|280|0",
        "Centurion Avocado Toast|Ezekiel Bread,Avocado,Egg Whites,Hemp Seeds|toast|<strong>Prep:</strong> 8m ‚Ä¢ <strong>Cook:</strong> 5m<hr><strong>INGREDIENTS</strong><br>2 Slices Sprouted Bread ‚Ä¢ 1/2 Avocado ‚Ä¢ 1 Cup Egg Whites ‚Ä¢ 1 tbsp Hemp Seeds<br><br><strong>1. PREP</strong><br>Toast bread. Mash avocado with 1 tsp lemon juice and a pinch of sea salt.<br><br><strong>2. COOK</strong><br>Scramble egg whites separately until fluffy. Serve toast topped with avo mash, and eggs on the side. Sprinkle hemp seeds over everything.|35|30|450|12",
        "Fluffy Protein Pancakes|Oat Flour,Whey Isolate,Blueberries,Almond Milk|griddle|<strong>Prep:</strong> 10m ‚Ä¢ <strong>Cook:</strong> 10m<hr><strong>INGREDIENTS</strong><br>1/2 Cup Oat Flour ‚Ä¢ 1 Scoop Vanilla Protein ‚Ä¢ 1/2 tsp Baking Powder ‚Ä¢ 1/2 Cup Almond Milk ‚Ä¢ 1/4 Cup Blueberries<br><br><strong>1. MIX</strong><br>Whisk flour, protein, and baking powder. Stir in milk until batter forms (don't overmix).<br><br><strong>2. COOK</strong><br>Pour onto hot griddle. Drop fresh blueberries into the wet batter. Flip when bubbles form.|35|25|380|6"
    ],
    l: [
        "Legacy Beef Meatballs ‚ö°|80/20 Beef-Liver Blend,Carrot Sticks,Cucumber|bake|<strong>Prep:</strong> 10m<hr><strong>INGREDIENTS</strong><br>6oz Beef/Liver Blend (80/20) ‚Ä¢ Carrots ‚Ä¢ Cucumbers<br><br><strong>1. PREP</strong><br>Form meatballs from the blend. Bake at 375¬∞F for 15 mins.<br><br><strong>2. ASSEMBLY</strong><br>Pack in a container with veggie sticks on side.<br><br><strong>Longevity Win:</strong> The lightning bolt means this contains liver (Bioavailable Vitamin A), masked by the beef flavor.|25|15|340|6",
        "The 'Super Mince' Bowl|96% Lean Beef,Black Lentils,Broccoli,Cauliflower|sear|<strong>Prep:</strong> 15m ‚Ä¢ <strong>Cook:</strong> 15m<hr><strong>INGREDIENTS</strong><br>8oz Lean Ground Beef ‚Ä¢ 1/2 Cup Black Lentils ‚Ä¢ 1 Cup Broccoli ‚Ä¢ 1 Cup Cauliflower<br><br><strong>1. PREP</strong><br>Pulse broccoli and cauliflower in a processor to make 'rice'. Rinse lentils.<br><br><strong>2. COOK</strong><br>Brown the beef. Add the veggie rice and lentils. Saut√© until veg is soft but not mushy. Season heavily.<br><br><strong>Longevity Win:</strong> The cornerstone meal. Balances high protein with massive fiber volume. Lentils contain spermidine (induces autophagy).|50|25|550|15",
        "Chicken & Artichoke|Chicken Breast,Artichoke Hearts,Arugula,Lemon|sear|<strong>Prep:</strong> 10m ‚Ä¢ <strong>Cook:</strong> 10m<hr><strong>INGREDIENTS</strong><br>6oz Chicken Breast ‚Ä¢ 1 Cup Canned Artichoke Hearts ‚Ä¢ Arugula<br><br><strong>1. PREP</strong><br>Rinse and drain artichokes well. Pat dry. Slice chicken.<br><br><strong>2. COOK</strong><br>Sear chicken. Add artichokes to pan to brown them. Serve warm mixture over a bed of cold arugula.<br><br><strong>Longevity Win:</strong> Artichokes are one of the highest fiber vegetables (9g/cup) and contain Cynarin, which boosts bile production and liver health.|40|15|420|10"
    ],
    d: [
        "Bison & Portobello Stack|Ground Bison,Portobello Caps,Avocado,Lettuce Wrap|sear|<strong>Prep:</strong> 10m ‚Ä¢ <strong>Cook:</strong> 12m<hr><strong>INGREDIENTS</strong><br>6oz Bison ‚Ä¢ 1 Large Portobello Cap ‚Ä¢ 1/2 Avocado ‚Ä¢ Lettuce<br><br><strong>1. PREP</strong><br>Clean mushroom cap (remove gills). Form bison into a patty.<br><br><strong>2. COOK</strong><br>Sear bison patty (4m/side). In same fat, sear mushroom cap until tender. Stack meat on mushroom. Top with avocado.<br><br><strong>Longevity Win:</strong> Portobellos contain Ergothioneine, an antioxidant that protects DNA. Bison is leaner than beef.|45|8|480|5",
        "Balsamic Beef & Mushrooms ‚ö°|80/20 Beef-Liver Blend,Mushrooms,Balsamic|sear|<strong>Prep:</strong> 10m ‚Ä¢ <strong>Cook:</strong> 8m<hr><strong>INGREDIENTS</strong><br>6oz Beef/Liver Blend (80/20) ‚Ä¢ 2 Cups Mushrooms<br><br><strong>1. PREP</strong><br>Slice mushrooms.<br><br><strong>2. COOK</strong><br>Saut√© mushrooms. Add meat blend and balsamic vinegar.<br><br><strong>Longevity Win:</strong> The lightning bolt indicates a nutrient-dense organ blend, masked by the rich balsamic mushrooms.|42|12|430|9",
        "Filet & Lentil Side|Filet Mignon,Black Lentils,Asparagus,Lemon|sear|<strong>Prep:</strong> 5m ‚Ä¢ <strong>Cook:</strong> 15m<hr><strong>INGREDIENTS</strong><br>6oz Filet Mignon ‚Ä¢ 1/2 Cup Lentils ‚Ä¢ Asparagus<br><br><strong>1. PREP</strong><br>Use precooked lentils. Snap asparagus.<br><br><strong>2. COOK</strong><br>Sear steak. Warm lentils with lemon/cumin. Steam asparagus.<br><br><strong>Longevity Win:</strong> Adding lentils to steak triples the fiber content (14g Total) without ruining the 'steak night' vibe.|45|25|520|14"
    ],
    s: [
        "Beef Isolate Shake|Beef Isolate Protein,Water,Ice|shake|<strong>Prep:</strong> 2m<hr><strong>INGREDIENTS</strong><br>1 Scoop Beef Isolate ‚Ä¢ Water<br><br><strong>THE PROTOCOL</strong><br>Mix in shaker bottle.<br><br><strong>Longevity Win:</strong> Provides collagen and amino acids without the dairy inflammatory response of Whey.|25|0|110|0",
        "Sardines (Water)|Sardines,Lemon,Hot Sauce|raw|<strong>Prep:</strong> 1m<hr><strong>INGREDIENTS</strong><br>1 Tin Sardines (Water)<br><br><strong>THE PROTOCOL</strong><br>Drain and eat straight from tin.<br><br><strong>Longevity Win:</strong> The most convenient source of Omega-3s on earth. Low mercury, high benefit.|22|0|190|0",
        "Avocado Cup|1/2 Avocado,Sea Salt|raw|<strong>Prep:</strong> 1m<hr><strong>INGREDIENTS</strong><br>1/2 Avocado<br><br><strong>THE PROTOCOL</strong><br>Sprinkle with salt and eat with spoon.<br><br><strong>Longevity Win:</strong> Monounsaturated fats aid in the absorption of fat-soluble vitamins.|2|8|160|7"
    ]
};

const pDB={"HEAVY LIFT":[{t:"PRE",h:"Theragun",d:"Glutes, Quads, Hams. 30s each."},{t:"GYM",h:"Heavy Lift",d:"Main compound movement."},{t:"POST",h:"Chair+Sauna",d:"20m Zero-Grav + 20m Sauna."}],"BOXING":[{t:"PRE",h:"Mobility",d:"Rotator cuffs & Calves."},{t:"GYM",h:"Boxing",d:"High intensity rounds."},{t:"POST",h:"Normatec",d:"Flush legs. NO SAUNA."}],"REFORM":[{t:"PRE",h:"Sweep",d:"Light full body percussion."},{t:"GYM",h:"Reform",d:"Time under tension."},{t:"POST",h:"Sauna",d:"20m HGH Boost."}],"REFORM/YOGA":[{t:"PRE",h:"Sweep",d:"Light full body percussion."},{t:"GYM",h:"Yoga",d:"Deep fascial release."},{t:"POST",h:"Heat",d:"Sauna or Thera Knee Heat."}],"CS4":[{t:"PRE",h:"Hydrate",d:"Electrolytes."},{t:"GYM",h:"CS4",d:"Cardio Strength 4."},{t:"POST",h:"Contrast",d:"Sauna + Cold or Knee Contrast."}],"RELAX":[{t:"PRE",h:"Walk",d:"Light movement."},{t:"GYM",h:"Relax",d:"Active recovery."},{t:"POST",h:"Massage",d:"Chair or Thera Knee Heat."}]};

const rDB={"Sea Moss":["92 Minerals","2 TBSP Fasted.","Thyroid & Gut support."],"Kombucha":["Probiotic","4 OZ post-Lunch.","Enzyme support."],"Aloe Vera":["Gut Soother", "2oz Pure Aloe Inner Leaf.", "Heals stomach lining."],"Golden Milk":["Anti-Inflammatory", "Coconut Milk, Turmeric, Black Pepper.", "Calms the immune system."],"Hibiscus Tea":["Blood Pressure", "Dried Hibiscus Flowers.", "Rich in antioxidants (Vitamin C)."],"Aqua Chair":["Hydro-Massage","Align body to zero-gravity.","Jets to glutes and lats.","20 Min Duration."],"Sauna":["HSP Induction","185¬∞F Range.","20 Mins total.","Heavy metal detox sweat."],"Theragun":["Percussive","Float over muscles.","2m per limb.","Target Lats/Hips."],"Normatec":["Compression","Level 4 Intensity.","Full leg cycle.","30m Lymphatic flush."],"Pre-Workout":["Nitro-Boost","6g Citrulline Malate.","Take 20m before training."]};

var defaultUH = {
    'J': {
        now: {bf:19.0, m:99.0, w:217.0, vf:10, bmr:2050}, 
        goal: {bf:15.0, m:105.0, w:212.0, vf:7, bmr:2150},
        info: {bf:{d:"Adipose tissue percentage.",f:"Rx: Caloric Deficit."},m:{d:"Skeletal muscle.",f:"Rx: Hypertrophy."},vf:{d:"Visceral Fat.",f:"Rx: No Fructose."},bmr:{d:"Basal Metabolic Rate.",f:"Rx: Build muscle."}},
        labs: {apob:{val:95,goal:60,unit:"mg/dL",name:"ApoB",lowerIsBetter:true,desc:"Plaque particles.",fix:"Rx: Fiber >40g."},hba1c:{val:5.4,goal:5.0,unit:"%",name:"HbA1c",lowerIsBetter:true,desc:"Avg blood sugar.",fix:"Rx: Walk post-meal."}},
        tests: {vo2:{val:45,goal:55,unit:"ml/kg",name:"VO2 Max",desc:"Oxygen efficiency.",fix:"Rx: 4x4 Intervals."},hang:{val:85,goal:120,unit:"s",name:"Dead Hang",desc:"Grip strength.",fix:"Rx: Daily hangs."}}
    },
    'S': {
        now: {bf:36.1, m:49.2, w:141.5, vf:9, bmr:1250},
        goal: {bf:22.0, m:60.0, w:135.0, vf:4, bmr:1450}, 
        info: {bf:{d:"Adipose tissue.",f:"Rx: Deficit."},m:{d:"Muscle.",f:"Rx: Hypertrophy."},vf:{d:"Visceral fat.",f:"Rx: No seed oils."},bmr:{d:"Metabolism.",f:"Rx: Protein."}},
        labs: {ana:{val:320,goal:40,unit:" titer",name:"ANA",lowerIsBetter:true,desc:"Autoimmune marker.",fix:"Rx: Sleep/Stress."},gluc:{val:84,goal:75,unit:"mg/dL",name:"Glucose",lowerIsBetter:true,desc:"Fasting sugar.",fix:"Rx: Post-meal walks."}},
        tests: {vo2:{val:32,goal:50,unit:"ml/kg",name:"VO2 Max",desc:"Cardio health.",fix:"Rx: Zone 2."},hang:{val:40,goal:90,unit:"s",name:"Dead Hang",desc:"Grip.",fix:"Rx: Practice daily."}}
    }
};

var uH = JSON.parse(localStorage.getItem('centurion_bio_v2')) || JSON.parse(JSON.stringify(defaultUH));

function updateStreak(change) {
    if(!uH['S'].streak) uH['S'].streak = 0;
    uH['S'].streak += change;
    if(uH['S'].streak < 0) uH['S'].streak = 0;
    let startCRP = 1.8;
    let newCRP = Math.max(0.5, (startCRP - (uH['S'].streak * 0.1)).toFixed(2));
    uH['S'].labs.crp = {val: newCRP, goal:0.3, unit:"mg/L", name:"hs-CRP", lowerIsBetter:true, desc:"Inflammation.", fix:"Rx: Omega-3."};
    localStorage.setItem('centurion_bio_v2', JSON.stringify(uH));
    renderBioTab('labs'); 
}

function updateBioVal(section, key, name) {
    event.stopPropagation(); 
    var current = uH[user][section][key].val;
    var newVal = prompt("LOG NEW RESULT for " + name + ":", current);
    if(newVal !== null && newVal !== "" && !isNaN(newVal)) {
        uH[user][section][key].val = parseFloat(newVal);
        localStorage.setItem('centurion_bio_v2', JSON.stringify(uH));
        renderBioTab(section); 
    }
}

function resetBioData() {
    if(confirm("Reset all biometric data to defaults? This cannot be undone.")) {
        uH = JSON.parse(JSON.stringify(defaultUH));
        localStorage.setItem('centurion_bio_v2', JSON.stringify(uH));
        renderBioTab('phys');
    }
}

function calculateLifeExpectancy(uID) {
    var u = uH[uID];
    if (!u) return { current: 0, potential: 0 };
    var l = u.labs;
    var t = u.tests;
    var f = u.now;
    var baseAge = 78; 
    if (t.vo2 && t.vo2.val >= 50) baseAge += 8; 
    else if (t.vo2 && t.vo2.val >= 40) baseAge += 4; 
    else if (t.vo2 && t.vo2.val < 30) baseAge -= 5; 
    if (l.apob && l.apob.val <= 60) baseAge += 6; 
    if (l.hba1c && l.hba1c.val <= 5.0) baseAge += 4; 
    if (f.vf <= 6) baseAge += 3; 
    if (baseAge > 100) baseAge = 100;
    return { current: baseAge, potential: 100 };
}

function getHoliday(d) { return null; }

function switchU(uID){ 
    user=uID;
    localStorage.setItem('centurion_active_user', uID);
    document.querySelectorAll('.u-badge').forEach(b=>b.classList.remove('active')); 
    document.getElementById('b'+uID.toLowerCase()).classList.add('active'); 
    document.getElementById('dateDisplay').innerHTML = `<span style="color:#666">üíç LOADING...</span>`;
    render(); 
    setTimeout(fetchOuraData, 500);
}

function syncOffsetToSelection() {
    let today = getCaDate(); today.setHours(0,0,0,0);
    let todayMon = new Date(today);
    todayMon.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
    let selMon = new Date(selDate);
    selMon.setDate(selDate.getDate() - (selDate.getDay() === 0 ? 6 : selDate.getDay() - 1));
    selMon.setHours(0,0,0,0);
    offset = Math.round((selMon - todayMon) / (7 * 864e5));
}

function getMon(o){ 
    let d = getCaDate(); 
    d.setHours(0,0,0,0); 
    let day = d.getDay(); 
    let diff = d.getDate() - day + (day === 0 ? -6 : 1); 
    d.setDate(diff + (o * 7)); 
    return d; 
}

function changeW(direction) {
    let viewMon = getMon(offset); 
    if (direction > 0) selDate = new Date(viewMon.getTime() + (7 * 864e5)); 
    else selDate = new Date(viewMon.getTime() - 864e5);
    selDate.setHours(12, 0, 0, 0); syncOffsetToSelection(); render(); 
}

function resetD(){ offset=0; selDate=getCaDate(); render(); }

function render(){
    const mon=getMon(offset); const days=["MON","TUE","WED","THU","FRI","SAT","SUN"];
    const tabs=document.getElementById('dayTabs'); tabs.innerHTML='';
    const end=new Date(mon); end.setDate(mon.getDate()+6);
    document.getElementById('dateDisplay').innerText=`${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${end.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
    
    for(let i=0; i<7; i++){
        let d=new Date(mon); d.setDate(mon.getDate()+i);
        const isSelected = getDateKey(d) === getDateKey(selDate);
        const b=document.createElement('div'); 
        b.className='tab'+(isSelected?' active':'');
        b.innerHTML=`${days[i]}<br>${d.getDate()}`;
        b.onclick=()=>{ selDate=d; render() }; 
        tabs.appendChild(b);
        if(isSelected) showDay(d, i);
    }
}

function applyAIPLogic(mealString, type) {
    if(user !== 'S') return mealString; 
    if(mealString.includes("Coffee") || mealString.includes("Espresso")) {
        return "Golden Milk|Coconut Milk,Turmeric,Collagen|heat|<strong>Prep:</strong> 5m<hr><strong>INGREDIENTS</strong><br>1 Cup Coconut Milk ‚Ä¢ 1 tsp Turmeric ‚Ä¢ 1 Scoop Collagen<br><br><strong>THE PROTOCOL</strong><br>Heat milk. Whisk in turmeric and ginger. Sip warm.<br><br><strong>Longevity Win:</strong> Curcumin reduces inflammation.|8|5|160|1";
    }
    let parts = mealString.split('|');
    let name = parts[0];
    let ingredients = parts[1];
    let macros = { p: parseInt(parts[4]), c: parseInt(parts[5]), k: parseInt(parts[6]), f: parseInt(parts[7]||0) };
    if(macros.f < 10 && type !== 's') { 
        ingredients += " + 1/2 Avocado";
        macros.f += 7;
        macros.k += 120;
    }
    return `${name}|${ingredients}|${parts[2]}|${parts[3]}|${macros.p}|${macros.c}|${macros.k}|${macros.f}`;
}

function showDay(dObj, idx){
    const id=Math.floor(dObj.getTime()/864e5);
    const dateKey = getDateKey(dObj);
    if(!snackLog[dateKey]) snackLog[dateKey] = [null, null];
    const snacks = snackLog[dateKey];
    
    let rawB = (mDB.b[Math.abs(id) % mDB.b.length] || mDB.b[0]);
    let rawL = (mDB.l[Math.abs(id) % mDB.l.length] || mDB.l[0]);
    let rawD = (mDB.d[Math.abs(id) % mDB.d.length] || mDB.d[0]);

    let b = applyAIPLogic(rawB, 'b').split('|');
    let l = applyAIPLogic(rawL, 'l').split('|');
    let dn = applyAIPLogic(rawD, 'd').split('|');
    
    const sch=["HEAVY LIFT","BOXING","REFORM","BOXING","REFORM/YOGA","CS4","RELAX"];
    const jcs=["PINEAPPLE GREEN Vitality","TITAN RED Juice","ZENITH GREEN Juice","TITAN RED Juice","ZENITH GREEN Juice","TITAN RED Juice","APOLLO GOLD Juice"];
    const j=jDB[jcs[idx]]; 
    
    let wName = sch[idx];
    const isHighOutput = ["HEAVY LIFT", "BOXING", "CS4"].includes(wName);
    
    const g=(user==='J') ? {P:165, C:isHighOutput?160:85, F:40, K:isHighOutput?2200:1800} : {P:105, C:55, F:35, K:1300};
    const sc = (user==='J') ? 1 : 0.6; 

    let sPro=0, sCarb=0, sFib=0, sCal=0;
    snacks.forEach(sIdx => {
        if(sIdx !== null) {
            let sData = mDB.s[sIdx].split('|');
            sPro += parseInt(sData[4]); 
            sCarb += parseInt(sData[5]); 
            sCal += parseInt(sData[6]);
            sFib += parseInt(sData[7] || 0);
        }
    });

    let p = Math.round((parseInt(b[4]) + parseInt(l[4]) + parseInt(dn[4]))*sc) + j[2] + sPro;
    let c = Math.round((parseInt(b[5]) + parseInt(l[5]) + parseInt(dn[5]))*sc) + j[3] + sCarb;
    let k = Math.round((parseInt(b[6]) + parseInt(l[6]) + parseInt(dn[6]))*sc) + j[4] + sCal;
    let f = Math.round((parseInt(b[7]||0) + parseInt(l[7]||0) + parseInt(dn[7]||0))*sc) + (j[5]||0) + sFib;

    let ptn = (user==='J') ? { l: '8oz', d: '8oz' } : { l: '5oz', d: '5oz' };
    ptn.b = (user==='J') ? "Large" : "Small";

    const proto = pDB[wName] || pDB["RELAX"];
    
    let snackHTML = '<div class="snack-grid">';
    for(let i=0; i<2; i++) {
        if(snacks[i] === null) {
            snackHTML += `<div class="snack-slot" onclick="openSnackSelector(${i})"><span style="font-size:1.2rem; color:#333;">Ôºã</span><span class="snack-label" style="color:#666; font-weight:500;">ADD SNACK</span></div>`;
        } else {
            let s = mDB.s[snacks[i]].split('|');
            snackHTML += `<div class="snack-slot filled" onclick="openR('${s[0].replace(/'/g, "\\'")}', '${s[1]}', '${s[2]}', '${s[3].replace(/'/g, "\\'")}')"><div class="remove-snack" onclick="event.stopPropagation(); removeSnack(${i})">‚úï</div><span class="snack-label">${s[0]}</span><span class="snack-macro">${s[4]}P ${s[7]||0}F</span></div>`;
        }
    }
    snackHTML += '</div>';

    // DYNAMIC ESSENTIALS LOGIC
    const ess1 = "Sea Moss";
    const ess2 = (user === 'S') ? "Hibiscus Tea" : "Kombucha";
    const ess2Emoji = (user === 'S') ? "üå∫" : "ü•É";

    document.getElementById('dayContent').innerHTML = `
        <div style="background:#0a0a0a; border:1px solid #222; border-bottom:4px solid var(--blue); padding:15px; border-radius:12px; margin-bottom:25px; cursor:pointer;" onclick="openRecoveryPhase('${wName}')">
            <div style="display:flex; justify-content:space-between; align-items:center; text-align:center;">
                <div style="flex:1"><div style="font-size:0.5rem; color:#666; font-weight:900; letter-spacing:1px">WARM UP</div><div style="font-size:0.7rem; color:#fff; margin-top:4px">${proto[0].h}</div></div>
                <div style="color:var(--blue); font-size:0.8rem; padding:0 8px">‚ûú</div>
                <div style="flex:1.2"><div style="font-size:0.5rem; color:var(--blue); font-weight:900; letter-spacing:1px">WORKOUT</div><div style="font-size:0.85rem; color:#fff; font-weight:900; margin-top:4px">${wName}</div></div>
                <div style="color:var(--blue); font-size:0.8rem; padding:0 8px">‚ûú</div>
                <div style="flex:1"><div style="font-size:0.5rem; color:#666; font-weight:900; letter-spacing:1px">RECOVER</div><div style="font-size:0.7rem; color:#fff; margin-top:4px">${proto[2].h}</div></div>
            </div>
            <div style="text-align:center; font-size:0.55rem; color:#444; margin-top:12px; letter-spacing:1px">TAP CARD FOR FULL GUIDE</div>
        </div>
        
        <div class="label">üß¨ Daily Essentials</div>
        <div style="display:flex; gap:10px; margin-bottom:15px">
            <div onclick="openM('${ess1}')" style="flex:1; background:#111; border:1px solid #333; padding:10px; border-radius:10px; text-align:center; font-size:0.8rem; font-weight:700; cursor:pointer;">${ess1} üåø</div>
            <div onclick="openM('${ess2}')" style="flex:1; background:#111; border:1px solid #333; padding:10px; border-radius:10px; text-align:center; font-size:0.8rem; font-weight:700; cursor:pointer;">${ess2} ${ess2Emoji}</div>
        </div>

        <div class="label">üç≥ Breakfast <span class="portion-tag">‚Ä¢ ${ptn.b}</span></div>
        <div class="value" onclick="openR('${b[0].replace(/'/g, "\\'")}', '${b[1]}', '${b[2]}', '${b[3].replace(/'/g, "\\'")}')">
            <span>${b[0]}</span> <span class="macro-pill">${Math.round(b[4]*sc)}P ${b[7]||0}F</span>
        </div>

        <div class="label">ü•ó Lunch <span class="portion-tag">‚Ä¢ ${ptn.l}</span></div>
        <div class="value" onclick="openR('${l[0].replace(/'/g, "\\'")}', '${l[1]}', '${l[2]}', '${l[3].replace(/'/g, "\\'")}')">
            <span>${l[0]} üíº</span> <span class="macro-pill">${Math.round(l[4]*sc)}P ${l[7]||0}F</span>
        </div>

        <div class="label">üçΩÔ∏è Dinner <span class="portion-tag">‚Ä¢ ${ptn.d}</span></div>
        <div class="value" onclick="openR('${dn[0].replace(/'/g, "\\'")}', '${dn[1]}', '${dn[2]}', '${dn[3].replace(/'/g, "\\'")}')">
            <span>${dn[0]}</span> <span class="macro-pill">${Math.round(dn[4]*sc)}P ${dn[7]||0}F</span>
        </div>

        <div class="label">ü•ú Snack Options</div>
        ${snackHTML}

        <div class="macro-dashboard">
            <div class="macro-row"><div class="macro-label"><span>PROTEIN</span><span>${p}g / ${g.P}g</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((p/g.P)*100,100)}%; background:var(--g-pro)"></div></div></div>
            <div class="macro-row"><div class="macro-label"><span style="color:var(--green)">FIBER</span><span>${f}g / ${g.F}g</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((f/g.F)*100,100)}%; background:var(--g-fib)"></div></div></div>
            <div class="macro-row"><div class="macro-label"><span>CARBS</span><span>${c}g / ${g.C}g</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((c/g.C)*100,100)}%; background:var(--g-carb)"></div></div></div>
            <div class="macro-row"><div class="macro-label"><span>CALORIES</span><span>${k} / ${g.K}</span></div><div class="macro-bg"><div class="macro-fill" style="width:${Math.min((k/g.K)*100,100)}%; background:var(--g-cal)"></div></div></div>
        </div>

        <div class="card" style="text-align:center"><div class="label" style="color:var(--gold)">Functional Juice</div><div class="juice-name" onclick="openJ('${jcs[idx]}')">${jcs[idx]}</div></div>`;
}

function stableSeed(s) {
    let h = 0;
    for(let i = 0; i < s.length; i++) h = Math.imul(31, h) + s.charCodeAt(i) | 0;
    return Math.abs(h);
}

function openR(n, i, a, t) {
    document.getElementById('mTitle').innerText = n;
    document.getElementById('mSub').innerText = "";
    const body = document.getElementById('mBody');
    body.innerHTML = '<div class="img-loader">‚ú® Chef is plating...</div>'; 
    const cleanName = n.replace(/[^a-zA-Z ]/g, "").trim();
    const seed = stableSeed(cleanName); 
    const prompt = encodeURIComponent(`delicious ${cleanName} plated food photo`);
    const imgUrl = `https://image.pollinations.ai/prompt/${prompt}?width=800&height=600&seed=${seed}&nologo=true&model=turbo`; 
    const img = document.createElement("img");
    img.className = "meal-img";
    img.loading = "eager"; 
    img.alt = cleanName;
    img.referrerPolicy = "no-referrer";
    img.style.opacity = "0";
    img.style.filter = "blur(10px)";
    img.style.transition = "opacity 0.4s ease, filter 0.4s ease";
    const safeFallback = "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&q=80";
    const timer = setTimeout(() => {
        if (!img.complete || img.naturalWidth === 0) { 
            img.src = safeFallback; 
        }
    }, 15000); 
    img.onload = () => {
        clearTimeout(timer);
        body.innerHTML = ""; 
        body.appendChild(img);
        setTimeout(() => {
            img.style.opacity = "1";
            img.style.filter = "blur(0)";
        }, 50);
        const txt = document.createElement("div");
        txt.innerHTML = `<br>${t}`;
        body.appendChild(txt);
    };
    img.onerror = () => { 
        clearTimeout(timer); 
        img.src = safeFallback; 
        img.onload = null; 
        img.style.opacity = "1";
        img.style.filter = "blur(0)";
    };
    setTimeout(() => {
        img.src = imgUrl;
    }, 30);
    document.getElementById('mTip').innerText = "";
    document.getElementById('masterModal').style.display = 'block';
}

function openSnackSelector(slotIdx) {
    currentSlot = slotIdx; 
    const modalBody = document.getElementById('mBody');
    document.getElementById('mTitle').innerText = "SELECT SNACK";
    document.getElementById('mSub').innerText = "SLOT " + (slotIdx + 1);
    let html = '';
    mDB.s.forEach((item, index) => {
        let s = item.split('|');
        html += `<div class="value" onclick="applySnack(${index})">
            ${s[0]} 
            <span style="float:right;font-size:0.7rem;color:#666">${s[4]}g Pro | ${s[6]} Cal</span>
        </div>`;
    });
    modalBody.innerHTML = html;
    document.getElementById('mTip').innerText = "PRO TIP: Prioritize high-protein snacks on Heavy Lift days.";
    document.getElementById('masterModal').style.display = 'block';
}

function applySnack(snackIndex) {
    const dateKey = getDateKey(selDate);
    if(!snackLog[dateKey]) snackLog[dateKey] = [null, null];
    snackLog[dateKey][currentSlot] = snackIndex;
    document.getElementById('masterModal').style.display = 'none';
    render(); 
}

function removeSnack(slotIdx) {
    const dateKey = getDateKey(selDate);
    if(snackLog[dateKey]) {
        snackLog[dateKey][slotIdx] = null;
        render(); 
    }
}

function openJ(n){
    const d=jDB[n]; document.getElementById('mTitle').innerText=n; document.getElementById('mSub').innerText=d[0];
    document.getElementById('mBody').innerHTML=`<p><strong>Ingredients:</strong> ${d[1]}</p><p>P: ${d[2]}g | C: ${d[3]}g | Kcal: ${d[4]} | Fiber: ${d[5]}g</p>`;
    document.getElementById('mTip').innerText = "PRO TIP: High-speed blending retains fiber while unlocking nutrients.";
    document.getElementById('masterModal').style.display='block';
}

function openM(n){
    const d=rDB[n]; document.getElementById('mTitle').innerText=n; document.getElementById('mSub').innerText=d[0];
    document.getElementById('mBody').innerHTML=d.slice(1).map(x=>`<p>${x}</p>`).join('');
    document.getElementById('mTip').innerText = "PRO TIP: Consistency beats intensity for recovery protocols.";
    document.getElementById('masterModal').style.display='block';
}

function openRecoveryPhase(workout) {
    const m = document.getElementById('mBody');
    document.getElementById('mTitle').innerText = workout + " PROTOCOL";
    document.getElementById('mSub').innerText = "V222.61 FLOW LOGIC";
    const active = pDB[workout] || pDB["RELAX"];
    let html = '<div class="rec-phase-list">';
    html += `<div class="phase-item"><span class="phase-time">WARM UP</span><span class="phase-title">${active[0].h}</span><span class="phase-detail">${active[0].d}</span></div>`;
    html += `<div class="phase-item"><span class="phase-time" style="color:#fff">TRAINING</span><span class="phase-title">${active[1].h}</span><span class="phase-detail">${active[1].d}</span></div>`;
    html += `<div class="phase-item"><span class="phase-time" style="color:var(--purple)">RECOVERY</span><span class="phase-title">${active[2].h}</span><span class="phase-detail">${active[2].d}</span></div>`;
    html += '</div>';
    m.innerHTML = html;
    document.getElementById('mTip').innerText = "TIP: Hydrate with minerals before Sauna sessions.";
    document.getElementById('masterModal').style.display = 'block';
}

function openBio() {
    var modalBody = document.getElementById('mBody');
    var u = uH[user];
    
    document.getElementById('mTitle').innerHTML = (user === 'J' ? "JERMAINE" : "SOPHIA") + 
        " <span onclick='resetBioData()' style='font-size:0.6rem; color:#444; border:1px solid #333; padding:4px 8px; border-radius:4px; vertical-align:middle; cursor:pointer; float:right;'>RESET DATA</span>";
    
    document.getElementById('mSub').innerText = "Clinical & Functional Metrics";
    document.getElementById('mImgContainer').innerHTML = ''; 

    modalBody.innerHTML = `
        <div class="tabs" style="margin-bottom:20px;">
            <div id="btPhys" class="tab active" onclick="renderBioTab('phys')">BODY</div>
            <div id="btLabs" class="tab" onclick="renderBioTab('labs')">LABS</div>
            <div id="btTests" class="tab" onclick="renderBioTab('tests')">TESTS</div>
            <div id="btOura" class="tab" onclick="renderOuraTab()">OURA</div>
        </div>
        <div id="bioContentArea"></div>
    `;

    document.getElementById('mTip').innerText = "TIP: Green bars indicate you have reached the 'Centurion' standard for longevity.";
    renderBioTab('phys'); 
    document.getElementById('masterModal').style.display = 'block';
}

function renderOuraTab() {
    var target = document.getElementById('bioContentArea');
    document.querySelectorAll('[id^="bt"]').forEach(function(t){ t.classList.remove('active') });
    document.getElementById('btOura').classList.add('active');

    // Retrieve history from storage
    let historyKey = 'centurion_oura_history_' + user;
    let rawHist = localStorage.getItem(historyKey);
    let history = rawHist ? JSON.parse(rawHist) : [];
    
    // Sort history by date descending (newest first)
    history.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if(history.length === 0) {
        target.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">No Oura history found.<br><br>Tap the ring icon on the main screen to sync data.</div>`;
        return;
    }

    let todayData = history[0]; // Most recent
    
    // Goals
    const deepGoal = 90; // 1.5 hours in minutes
    const remGoal = 90;  // 1.5 hours
    const actGoal = (user === 'J') ? 900 : 600; // Calories

    // Helper for bars
    const drawBar = (label, val, goal, unit, lowMsg, highMsg) => {
        let pct = Math.min((val / goal) * 100, 100);
        let color = val >= goal ? 'var(--green)' : '#FF5252';
        let msg = val >= goal ? highMsg : lowMsg;
        return `
        <div class="bio-section" style="margin-bottom:12px; padding:15px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05);">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                <span style="font-size:0.8rem; font-weight:800; color:#fff;">${label}</span>
                <span style="font-size:0.7rem; color:${color}; font-weight:800;">${val} / ${goal} ${unit}</span>
            </div>
            <div style="height:8px; background:#111; border-radius:10px; overflow:hidden; margin-bottom:8px;">
                <div style="width:${pct}%; height:100%; background:${color}; border-radius:10px;"></div>
            </div>
            <div style="font-size:0.65rem; color:#888; font-style:italic;">${msg}</div>
        </div>`;
    };

    let deepMin = Math.round(todayData.deep / 60);
    let remMin = Math.round(todayData.rem / 60);
    
    let html = `<div style="margin-bottom:20px; text-align:center; color:#666; font-size:0.7rem;">LATEST SYNC: ${todayData.date}</div>`;
    
    // 1. Deep Sleep Bar
    html += drawBar("DEEP SLEEP", deepMin, 90, "min", 
        "‚ö†Ô∏è Low: Hormone production compromised. Rx: Cool room to 65¬∞F.", 
        "‚úÖ Optimal: Anabolic hormone production active.");
        
    // 2. REM Sleep Bar
    html += drawBar("REM SLEEP", remMin, 90, "min", 
        "‚ö†Ô∏è Low: Cognitive recovery needed. Rx: No blue light 1h before bed.", 
        "‚úÖ Optimal: Memory consolidation active.");
        
    // 3. Activity Bar
    html += drawBar("ACTIVE BURN", todayData.cal, actGoal, "kcal", 
        "‚ö†Ô∏è Low: Insulin sensitivity risk. Rx: 15m post-meal walk.", 
        "‚úÖ Optimal: Metabolic firing rate high.");

    // 4. History Table
    html += `<div style="margin-top:30px; border-top:1px dashed #333; padding-top:15px;">
        <div style="font-size:0.8rem; color:var(--gold); font-weight:900; margin-bottom:10px; letter-spacing:1px;">7-DAY TRENDS</div>
        <div style="display:flex; justify-content:space-between; color:#666; font-size:0.6rem; font-weight:900; margin-bottom:5px; padding:0 4px;">
            <span style="flex:1">DATE</span>
            <span style="flex:1; text-align:center">SCORE</span>
            <span style="flex:1; text-align:center">DEEP</span>
            <span style="flex:1; text-align:right">BURN</span>
        </div>`;
        
    history.slice(0, 7).forEach(day => {
        let dMin = Math.round(day.deep / 60);
        let dateStr = day.date.slice(5); // Remove year "MM-DD"
        html += `<div class="oura-hist-row">
            <span class="oura-hist-date" style="flex:1">${dateStr}</span>
            <span style="flex:1; text-align:center; color:${day.score >= 85 ? 'var(--green)' : '#aaa'}">${day.score}</span>
            <span style="flex:1; text-align:center">${dMin}m</span>
            <span style="flex:1; text-align:right">${day.cal}</span>
        </div>`;
    });
    
    html += `</div>`;
    target.innerHTML = html;
}

// ... (Rest of existing renderBioTab and toggleBioItem functions remain same)

async function fetchOuraData() {
    let activeToken = getActiveToken();
    
    console.log(`Syncing ${user} with token start: ${activeToken.substring(0, 5)}...`);

    if (!activeToken) {
        document.getElementById('dateDisplay').innerHTML = `<span style="color:var(--blue); font-weight:800; cursor:pointer;" onclick="connectOura()">üíç TAP TO ADD ${user}'s RING</span>`;
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    // CHANGE: Look back 8 days to get full week history
    const lookback = new Date(Date.now() - (86400000 * 8)).toISOString().split('T')[0];
    
    document.getElementById('dateDisplay').innerHTML = `üíç SYNCING...`;

    const PROXY_URL = "https://corsproxy.io/?";
    const headers = { 'Authorization': `Bearer ${activeToken}` };
    const buster = `&cb=${Date.now()}`;

    try {
        // Fetch 3 endpoints
        const readyUrl = `https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${lookback}&end_date=${today}`;
        const sleepUrl = `https://api.ouraring.com/v2/usercollection/daily_sleep?start_date=${lookback}&end_date=${today}`;
        const activityUrl = `https://api.ouraring.com/v2/usercollection/daily_activity?start_date=${lookback}&end_date=${today}`;
        
        const fetchOpts = { headers, cache: "no-store" };

        const [readyRes, sleepRes, activityRes] = await Promise.all([
            fetch(PROXY_URL + encodeURIComponent(readyUrl) + buster, fetchOpts),
            fetch(PROXY_URL + encodeURIComponent(sleepUrl) + buster, fetchOpts),
            fetch(PROXY_URL + encodeURIComponent(activityUrl) + buster, fetchOpts)
        ]);

        const rData = await readyRes.json();
        const sData = await sleepRes.json();
        const aData = await activityRes.json();

        if (rData.data && rData.data.length > 0) {
            // 1. Update Top Banner (Most Recent)
            const latestReady = rData.data[rData.data.length - 1];
            const targetDate = latestReady.day;
            const latestSleep = sData.data.find(item => item.day === targetDate);
            const latestAct = aData.data.find(item => item.day === targetDate);
            
            const score = latestReady.score;
            let status = "OPTIMAL";
            let color = "var(--green)";
            
            if(score < 85) { status = "MAINTENANCE"; color = "var(--gold)"; }
            if(score < 70) { status = "‚ö†Ô∏è RECOVER"; color = "#FF5252"; }
            
            let displayHTML = `<span style="color:${color}; cursor:pointer;" onclick="alert('Viewing: ${user === 'J' ? 'Jermaine' : 'Sophia'}')">üíç ${user === 'J' ? "JERMAINE" : "SOPHIA"}: ${score} (${status})</span>`;
            
            if(user === 'S') displayHTML += ` <span style="font-size:0.55rem; color:#666; margin-left:5px; cursor:pointer; text-decoration:underline;" onclick="connectOura()">‚Üª RESET</span>`;

            // RHR Check for Sophia
            let rhr = (latestSleep && latestSleep.lowest_heart_rate) ? latestSleep.lowest_heart_rate : 0;
            if(user === 'S' && rhr > 60) {
                displayHTML += ` <span style="font-size:0.6rem; color:#FF5252; border:1px solid #FF5252; padding:2px 4px; border-radius:4px;">üî• RHR SPIKE (${rhr})</span>`;
            }
            document.getElementById('dateDisplay').innerHTML = displayHTML;
            
            // 2. Process History for "My Data" Tab
            let history = [];
            // Iterate through readiness data to build daily objects
            rData.data.forEach(dayReady => {
                let d = dayReady.day;
                let daySleep = sData.data.find(i => i.day === d);
                let dayAct = aData.data.find(i => i.day === d);
                
                if (daySleep && dayAct) {
                    history.push({
                        date: d,
                        score: dayReady.score,
                        deep: daySleep.deep_sleep_duration, // Seconds
                        rem: daySleep.rem_sleep_duration,   // Seconds
                        cal: dayAct.active_calories
                    });
                }
            });
            
            // Save to LocalStorage
            localStorage.setItem('centurion_oura_history_' + user, JSON.stringify(history));

        } else {
            document.getElementById('dateDisplay').innerHTML = `<span style="color:orange" onclick="connectOura()">üíç NO DATA (Tap to Fix Token)</span>`;
        }
    } catch (e) {
        console.error(e);
        document.getElementById('dateDisplay').innerHTML = `<span style="color:#FF5252; cursor:pointer;" onclick="connectOura()">üíç WRONG TOKEN (Tap to Fix)</span>`;
    }
}

// ... window.onload remains same ...
</script>
</body>
</html>