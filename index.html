<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v17.26 PERSONALIZED</title>
<style>
/* --- CORE STYLES --- */
:root { --bg:#050505; --panel:#121212; --border:#222; --acid:#ccff00; --cyan:#00f0ff; --alert:#ff453a; --text:#fff; }
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom:120px; -webkit-tap-highlight-color: transparent;}
.header{background:rgba(10,10,10,0.95);padding:15px;border-bottom:1px solid #333;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px);}

/* CONTROLS */
.user-switch{display:flex;gap:8px;background:#1a1a1a;padding:4px;border-radius:24px;margin-bottom:10px; border:1px solid #333;}
.user-switch button{flex:1;padding:10px;border:none;background:transparent;color:#666;border-radius:20px;cursor:pointer;font-weight:800;font-size:0.75rem;transition:all 0.3s; letter-spacing:1px;}
.user-switch button.active{background:var(--acid);color:#000;box-shadow:0 0 15px rgba(204,255,0,0.4); text-shadow:none;}
.date-nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;background:#000;border:1px solid #333;border-radius:10px;padding:6px}
.nav-btn{background:transparent;border:none;color:var(--cyan);padding:5px 20px;font-size:1.2rem;cursor:pointer; text-shadow:0 0 8px rgba(0,240,255,0.6);}
#dateLabel{flex:1;text-align:center;color:#fff;font-weight:700;font-size:0.9rem;font-family:monospace; letter-spacing:1px;}
.bio-btn{position:absolute;right:15px;top:15px;background:rgba(255,255,255,0.05);color:var(--acid);border:1px solid var(--acid);padding:6px 12px;border-radius:6px;font-size:0.6rem;font-weight:900;cursor:pointer; box-shadow:0 0 5px rgba(204,255,0,0.2);}

/* HERO */
.hero{padding:25px 15px;display:flex;gap:15px;align-items:center;}
.dual-score{display:flex;gap:15px;align-items:center}
.score-box{border:2px solid #333;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;background:#000;}
.score-box.small{width:70px;height:70px;}
.score-box.primary{width:90px;height:90px;border-width:3px;background:radial-gradient(circle,rgba(204,255,0,0.08) 0%,transparent 70%); border-color:var(--acid); box-shadow:0 0 25px rgba(204,255,0,0.2);}
.score-val{font-size:1.4rem;font-weight:900;line-height:1; color:#fff;}
.score-val.longevity{font-size:2.2rem;background:linear-gradient(135deg,var(--acid) 0%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent; filter:drop-shadow(0 0 8px rgba(204,255,0,0.6));}
.score-label{font-size:0.45rem;color:#666;text-transform:uppercase;margin-top:4px;font-weight:800;letter-spacing:1px;}

/* ALERTS */
.alert{margin:0 15px 20px;padding:15px;border-radius:10px;text-align:center;font-weight:800;display:none;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px; line-height:1.4;}
.alert.show{display:block;animation:pulse 3s infinite}
.alert-warning{background:rgba(255,214,10,0.15); border:1px solid #FFD60A; color:#FFD60A; box-shadow:0 0 15px rgba(255,214,10,0.1);}
.alert-protein{background:rgba(0,240,255,0.15); border:1px solid var(--cyan); color:var(--cyan); box-shadow:0 0 15px rgba(0,240,255,0.1);}
.alert-love{background:linear-gradient(135deg, #b00b69 0%, #52057b 100%); color:#fff; border:1px solid #ff69b4; text-shadow:0 1px 2px rgba(0,0,0,0.5); box-shadow:0 0 20px rgba(255,105,180,0.3);}
@keyframes pulse{0%{opacity:1}50%{opacity:0.8}100%{opacity:1}}

/* SECTIONS */
.section-header{padding:15px;font-size:0.65rem;font-weight:900;color:#888;letter-spacing:1.5px;text-transform:uppercase;margin-top:10px; display:flex; align-items:center; gap:10px;}
.section-header::after { content:''; height:1px; background:#333; flex:1; }

.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:0 15px;margin-bottom:20px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;padding:0 15px;margin-bottom:20px}

/* ORBS - HIGH CONTRAST NEON */
.orb-card{background:linear-gradient(145deg, #111 0%, #080808 100%); border:1px solid #222; border-radius:14px; padding:15px 5px; display:flex; flex-direction:column; align-items:center; transition:transform 0.1s;}
.orb-card:active{transform:scale(0.96);}
.orb-container{width:55px;height:55px;position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.orb-svg{transform:rotate(-90deg);width:100%;height:100%}
.orb-bg{fill:none;stroke:#1a1a1a;stroke-width:5;}
.orb-fg{fill:none;stroke-width:5;stroke-dasharray:145;stroke-dashoffset:145;transition:stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1); stroke-linecap:round; filter:drop-shadow(0 0 4px currentColor);}

/* LEGIBILITY FIX */
.orb-val-box{position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center;}
.orb-val{font-family:'Courier New', monospace; font-size:0.75rem; font-weight:900; color:#fff; text-shadow:0 0 4px #000, 0 0 4px #000; letter-spacing:-0.5px; z-index:2;}
.orb-label{font-size:0.45rem;font-weight:800;color:#666;text-transform:uppercase;letter-spacing:0.5px}

/* HEARTS */
.heart-svg { width: 100%; height: 100%; overflow: visible; }
.heart-bg { fill: none; stroke: #1a1a1a; stroke-width: 2.5; }
.heart-fg { fill: none; stroke-width: 2.5; stroke-dasharray: 100; stroke-dashoffset: 100; transition: stroke-dashoffset 1s ease; filter:drop-shadow(0 0 3px currentColor); }
.beating { animation: heartbeat 1.5s infinite; transform-origin: center; }
@keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.1); } 30% { transform: scale(1); } 45% { transform: scale(1.1); } 60% { transform: scale(1); } }

/* RAINBOW */
.rainbow-container{padding:0 15px;margin-bottom:20px}
.rainbow-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.rainbow-title{font-size:0.65rem;font-weight:900;color:#ccc;letter-spacing:1px}
.rainbow-score{font-size:0.9rem;font-weight:900;color:var(--acid);font-family:monospace; text-shadow:0 0 10px rgba(204,255,0,0.3);}
.rainbow-track{height:10px;background:#111;border-radius:5px;display:flex;overflow:hidden;border:1px solid #333}
.rainbow-seg{height:100%;width:0%;transition:width 0.5s ease; box-shadow:inset 0 0 5px rgba(0,0,0,0.5);}
.rainbow-suggestion{font-size:0.65rem;color:var(--acid);margin-top:10px;font-weight:700;padding:10px;background:rgba(204,255,0,0.05);border-radius:8px;border:1px solid rgba(204,255,0,0.2); text-align:right;}

/* TIMELINE */
.timeline{padding:0 15px;margin-bottom:40px}
.task{display:flex;gap:12px;margin-bottom:15px;min-height:60px}
.task-time{width:45px;color:#666;font-size:0.7rem;padding-top:15px;text-align:right;font-family:monospace;font-weight:bold}
.task-card{flex:1;background:linear-gradient(180deg, #111 0%, #0d0d0d 100%);border:1px solid #333;border-radius:12px;padding:15px;position:relative;transition:all 0.2s; display:flex; justify-content:space-between; align-items:center;}
.task-card:active{transform:scale(0.98);background:#1a1a1a}
.task-card.checked{border-color:var(--acid);background:rgba(204,255,0,0.03); box-shadow:0 0 15px rgba(204,255,0,0.05);}
.task-card.auto-detected{border-color:var(--cyan);background:rgba(0,240,255,0.03);}
.task-info { flex:1; }
.task-title{font-weight:900;font-size:0.85rem;margin-bottom:5px;color:#fff}
.task-desc{font-size:0.7rem;color:#888;line-height:1.4}
.workout-badge{display:inline-block;background:var(--cyan);color:#000;padding:2px 6px;border-radius:4px;font-size:0.5rem;font-weight:900;margin-left:5px; vertical-align:middle; box-shadow:0 0 5px var(--cyan);}
.chevron { font-size:1.5rem; color:#333; margin-left:15px; font-weight:900; transition:color 0.2s;}
.task-card:active .chevron { color:var(--acid); }
.check-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-left:5px;}
.check-circle{width:26px;height:26px;border:2px solid #555;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1rem;color:transparent;transition:all 0.2s}
.task-card.checked .check-circle{background:var(--acid);border-color:var(--acid);color:#000; box-shadow:0 0 10px var(--acid);}

/* RECIPE DEEP DIVE MODAL */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:500;display:none;overflow-y:auto;backdrop-filter:blur(8px);}
.modal-overlay.show{display:block}
.modal-content{width:100%;min-height:100vh;background:#050505;padding-bottom:120px;}
.modal-header{padding:20px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:rgba(5,5,5,0.95);z-index:10;}
.modal-title{font-size:1rem;font-weight:900;color:var(--acid);text-transform:uppercase;letter-spacing:1px; max-width:85%;}
.modal-close{background:transparent;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1}
.modal-body{padding:20px;}

/* RECIPE STYLES */
.recipe-hero { margin-bottom:25px; }
.recipe-title { font-size:1.6rem; font-weight:900; line-height:1.1; margin-bottom:10px; color:#fff; }
.recipe-stats { display:flex; gap:20px; font-size:0.85rem; color:#888; font-weight:700; font-family:monospace; }

.macro-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:25px; }
.macro-stat { background:#111; border:1px solid #333; padding:12px 5px; border-radius:10px; text-align:center; }
.m-val { font-size:1.1rem; font-weight:900; color:#fff; font-family:monospace; }
.m-lbl { font-size:0.5rem; color:var(--acid); text-transform:uppercase; margin-top:4px; font-weight:900; }

.section-label { font-size:0.75rem; color:var(--cyan); font-weight:900; margin:25px 0 15px; text-transform:uppercase; letter-spacing:1px; border-bottom:2px solid #222; padding-bottom:5px; display:inline-block;}

/* UPDATED LIST STYLES */
.ing-item { color:#ccc; font-size:0.9rem; border-bottom:1px solid #1a1a1a; padding:10px 0; display:flex; align-items:center; }
.ing-item::before { content:'‚Ä¢'; color:var(--acid); font-weight:bold; margin-right:10px; font-size:1.2rem; }

.step-item { display:flex; gap:15px; font-size:0.9rem; color:#ddd; line-height:1.6; margin-bottom:15px; background:#111; padding:15px; border-radius:10px; border:1px solid #222; }
.step-num { color:#000; background:var(--acid); font-weight:900; font-family:monospace; min-width:24px; height:24px; display:flex; align-items:center; justify-content:center; border-radius:50%; font-size:0.8rem; margin-top:2px; }

.synergy-box { background:linear-gradient(135deg, rgba(0,240,255,0.05) 0%, rgba(0,0,0,0) 100%); border:1px solid rgba(0,240,255,0.3); padding:20px; border-radius:12px; margin-bottom:20px; position:relative; overflow:hidden; }
.syn-title { color:var(--cyan); font-weight:900; font-size:0.75rem; text-transform:uppercase; margin-bottom:8px; letter-spacing:1px; }
.syn-text { color:#ccc; font-size:0.9rem; font-style:italic; line-height:1.5; }

.abs-alert{background:rgba(255,69,58,0.1);border:1px solid var(--alert);padding:15px;border-radius:10px;margin-bottom:15px;font-size:0.8rem;color:#fff;line-height:1.4; display:flex; align-items:center; gap:12px;}
.abs-boost{background:rgba(48,209,88,0.15);border:1px solid #30d158;padding:15px;border-radius:10px;margin-bottom:15px;font-size:0.8rem;color:#fff;line-height:1.4; display:flex; align-items:center; gap:12px;}

.select-btn { width:100%; background:var(--acid); color:#000; padding:18px; border:none; border-radius:12px; font-weight:900; font-size:1rem; cursor:pointer; margin-top:10px; text-transform:uppercase; box-shadow:0 0 20px rgba(204,255,0,0.3); transition:transform 0.1s; position:fixed; bottom:20px; left:20px; width:calc(100% - 40px); z-index:20;}
.select-btn:active { transform:scale(0.98); }

/* MENU LIST - REDESIGNED WITH RIGHT ALIGNMENT */
.menu-item { padding:20px; border-bottom:1px solid #222; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s; background:linear-gradient(90deg, #111 0%, #0d0d0d 100%); margin-bottom:1px; }
.menu-item:active { background:#1a1a1a; }
.menu-left { flex:1; }
.menu-right { display:flex; gap:8px; align-items:center; justify-content:flex-end; min-width:80px; }
.menu-name { font-size:1rem; font-weight:800; color:#fff; margin-bottom:6px; letter-spacing:0.5px; }
.menu-meta { font-size:0.7rem; color:#888; font-family:monospace; margin-bottom:0px; display:flex; gap:10px;}
.menu-badges { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
.badge { font-size:0.6rem; padding:4px 8px; border-radius:6px; font-weight:900; text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; }
.badge.boost { background:rgba(48,209,88,0.15); color:#30d158; border:1px solid #30d158; }
.badge.block { background:rgba(255,69,58,0.15); color:#ff453a; border:1px solid #ff453a; }
.badge.omega { background:rgba(0,240,255,0.15); color:var(--cyan); border:1px solid var(--cyan); }
.badge.user { background:rgba(255, 255, 255, 0.15); color:#fff; border:1px solid #fff; }
.menu-arrow { color:#333; font-size:1.5rem; font-weight:900; margin-left:10px;}

/* CUSTOM BUILDER STYLES */
.custom-btn-container { padding:20px; background:#111; border-bottom:1px solid #333; text-align:center; }
.custom-btn { background:transparent; border:2px dashed #444; color:#888; width:100%; padding:15px; border-radius:12px; font-weight:800; text-transform:uppercase; cursor:pointer; }
.custom-btn:hover { border-color:var(--acid); color:var(--acid); }
.builder-form { padding:20px; }
.form-group { margin-bottom:20px; }
.form-label { display:block; color:var(--cyan); font-size:0.7rem; font-weight:900; margin-bottom:8px; text-transform:uppercase; }
.form-input { width:100%; background:#1a1a1a; border:1px solid #333; color:#fff; padding:15px; border-radius:8px; font-size:1rem; font-family:monospace; }
.form-input:focus { border-color:var(--acid); outline:none; }

.footer{position:fixed;bottom:0;left:0;width:100%;background:#000;padding:12px 15px;border-top:1px solid #333;display:flex;justify-content:space-between;align-items:center;z-index:90}
.sync-status{font-size:0.6rem;color:#666;font-family:monospace}
.sync-btn{background:var(--acid);color:#000;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:900;font-size:0.7rem}
</style>
</head>
<body>

<div class="header">
    <div class="user-switch">
        <button id="btn-jermaine" class="active" onclick="if(window.app)app.switchUser('jermaine')">JERMAINE</button>
        <button id="btn-sophia" onclick="if(window.app)app.switchUser('sophia')">SOPHIA</button>
    </div>
    <div class="date-nav">
        <button class="nav-btn" onclick="if(window.app)app.changeDate(-1)">‚óÄ</button>
        <span id="dateLabel">LOADING...</span>
        <button class="nav-btn" onclick="if(window.app)app.changeDate(1)">‚ñ∂</button>
    </div>
    <button class="bio-btn" onclick="if(window.app)app.openBio()">BIO</button>
</div>

<div id="alertBanner" class="alert"></div>

<div class="hero">
    <div class="dual-score">
        <div class="score-box small">
            <div class="score-val" id="dayGrade">--</div>
            <div class="score-label">TODAY</div>
        </div>
        <div class="score-box primary">
            <div class="score-val longevity" id="longevityScore">--</div>
            <div class="score-label">LONGEVITY</div>
            <div class="score-max">/120</div>
        </div>
    </div>
    <div class="status" id="statusMsg">INITIALIZING...</div>
</div>

<div class="section-header">SLEEP ARCHITECTURE</div>
<div class="grid-3">
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="sleepOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="sleepVal">--</div></div></div><div class="orb-label" style="color:#bf5af2">TOTAL</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="deepOrb" cx="25" cy="25" r="21" style="stroke:#007aff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="deepVal">--</div></div></div><div class="orb-label" style="color:#007aff">DEEP</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="remOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="remVal">--</div></div></div><div class="orb-label" style="color:#bf5af2">REM</div></div>
</div>

<div class="section-header">FUEL (NUTRITION)</div>
<div class="grid-4">
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="proteinOrb" cx="25" cy="25" r="21" style="stroke:#fff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="proteinVal">0</div></div></div><div class="orb-label" style="color:#fff">PROTEIN</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="omega3Orb" cx="25" cy="25" r="21" style="stroke:#00d4ff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="omega3Val">0</div></div></div><div class="orb-label" style="color:#00d4ff">OMEGA-3</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="fiberOrb" cx="25" cy="25" r="21" style="stroke:#30d158"></circle></svg><div class="orb-val-box"><div class="orb-val" id="fiberVal">0</div></div></div><div class="orb-label" style="color:#30d158">FIBER</div></div>
    <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="calorieOrb" cx="25" cy="25" r="21" style="stroke:#FFD60A"></circle></svg><div class="orb-val-box"><div class="orb-val" id="calorieVal">0</div></div></div><div class="orb-label" style="color:#FFD60A">CALORIES</div></div>
</div>

<div class="section-header">ENGINE (CARDIO)</div>
<div class="grid-4">
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg beating" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#ff453a; fill:rgba(255,69,58,0.2);"></path></svg><div class="orb-val-box"><div class="orb-val" id="rhrVal">--</div></div></div>
        <div class="orb-label" style="color:#ff453a">RHR</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="z2Heart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#00f0ff"></path></svg><div class="orb-val-box"><div class="orb-val" id="z2Val">0</div></div></div>
        <div class="orb-label" style="color:#00f0ff">ZONE 2</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="z5Heart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#ff453a"></path></svg><div class="orb-val-box"><div class="orb-val" id="z5Val">0</div></div></div>
        <div class="orb-label" style="color:#ff453a">ZONE 5</div>
    </div>
    <div class="orb-card">
        <div class="orb-container"><svg class="heart-svg" viewBox="0 0 24 24"><path class="heart-bg" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path><path class="heart-fg" id="calHeart" pathLength="100" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="stroke:#FFD60A"></path></svg><div class="orb-val-box"><div class="orb-val" id="calVal">0</div></div></div>
        <div class="orb-label" style="color:#FFD60A">BURN</div>
    </div>
</div>

<div class="section-header">PHYTONUTRIENT DIVERSITY üåà</div>
<div class="rainbow-container">
    <div class="rainbow-header"><div class="rainbow-title">RAINBOW SCORE</div><div class="rainbow-score" id="rainbowScore">0%</div></div>
    <div class="rainbow-track" id="rainbowTrack"></div>
    <div id="rainbowSuggestion" class="rainbow-suggestion" style="display:none"></div>
</div>

<div class="section-header">SYNERGY PROTOCOL üîÑ AUTO-DETECT</div>
<div class="timeline" id="timeline"></div>

<div class="modal-overlay" id="mainModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">TITLE</div>
            <button class="modal-close" onclick="app.closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<div class="footer">
    <span class="sync-status" id="syncStatus">INIT</span>
    <button class="sync-btn" onclick="if(window.app)app.sync()">üîÑ SYNC</button>
</div>

<script>
// --- CONFIGURATION ---
const USERS = {
    jermaine: {
        name: "Jermaine",
        dob: "1983-01-13",
        goals: { protein: 172, omega3: 12000, fiber: 50, water: 140, weightTarget: 210, heightInches: 70, z2: 45, z5: 20, calBurn: 500 },
        defaultBios: { bmr: '2057', apob: '114', lpa: '178', weight: '217.1', hscrp: '0.4', hba1c: '5.4' }
    },
    sophia: {
        name: "Sophia",
        dob: "1987-01-25",
        goals: { protein: 130, omega3: 4000, fiber: 35, water: 100, weightTarget: 140, heightInches: 64, z2: 30, z5: 15, calBurn: 350 },
        defaultBios: { bmr: '1450', apob: '70', lpa: '20', weight: '148', hscrp: '0.5', hba1c: '5.2' }
    }
};

// GLOBAL RECIPE DATABASE
const MEAL_DATABASE = {
    breakfast: [
        {title:"Greek Yogurt & Berries",time:"5min",servings:1,macros:{p:20,o:0,f:4,cal:250},ingredients:["1 cup Greek Yogurt","1/2 cup Mixed Berries","1 tbsp Honey","1 tbsp Walnuts"],steps:["Scoop yogurt into bowl","Top with berries and walnuts","Drizzle with honey"],why:"Probiotics + Antioxidants. Quick high protein start.",colors:['white','purple','brown']},
        {title:"Omega Breakfast",time:"15min",servings:1,macros:{p:58,o:3500,f:12,cal:680},ingredients:["8oz Wild Salmon","2 Eggs","2 cups Kale","1 cup Blueberries","1 tsp EVOO"],steps:["Heat EVOO in pan","Season salmon with salt/pepper","Sear salmon 4min per side","Scramble eggs separately","Massage kale for 2min","Plate kale as base","Top with salmon, eggs, and berries"],why:"Salmon + Eggs = Choline/Omega-3 synergy for brain health.",colors:['orange','purple','green']},
        {title:"Sophia's Sea Moss Oatmeal",time:"10min",servings:1,macros:{p:48,o:8200,f:18,cal:580},ingredients:["1 cup Oats","1 tbsp Sea Moss","3 tbsp Flaxseed","Pea Protein","Berries"],steps:["Cook oats in water or oat milk","Stir in Sea Moss gel and protein","Top with ground flax and berries"],why:"Sea Moss minerals support thyroid. Flax lowers Lp(a).",colors:['purple','white']},
        {title:"PB Sea Moss Power Shake",time:"5min",servings:1,macros:{p:54,o:7200,f:16,cal:680},ingredients:["Pea Protein","Sea Moss","Flaxseed","PB","Spinach"],steps:["Blend all ingredients with Oat Milk"],why:"Sea Moss supports mucus membranes. Pea protein = 54g complete.",colors:['green','white']},
        {title:"Smoked Trout Hash",time:"18min",servings:1,macros:{p:54,o:3200,f:16,cal:640},ingredients:["6oz Trout","2 Eggs","1 Sweet Potato","Brussels Sprouts","Garlic"],steps:["Dice sweet potato and saute","Add sprouts and garlic","Crack eggs into wells","Cover until eggs set","Top with flaked trout"],why:"Trout is lower mercury than tuna. Sprouts = Sulforaphane.",colors:['orange','green']},
        {title:"Greek Yogurt Parfait",time:"5min",servings:1,macros:{p:25,o:0,f:2,cal:300},ingredients:["1 cup Greek Yogurt","1/2 cup Blueberries","1 tbsp Honey"],steps:["Scoop yogurt","Top with berries and honey"],why:"Probiotics for gut health.",colors:['white','purple']}
    ],
    lunch: [
        {title:"Ahi Poke Bowl",time:"15min",servings:1,macros:{p:45,o:1200,f:8,cal:520},ingredients:["6oz Ahi Tuna","Brown Rice","Cucumber","Mango","Seaweed","Sesame Oil"],steps:["Cube raw tuna","Toss in sesame oil and soy","Plate over brown rice","Top with sliced veg and mango"],why:"Raw fish preserves delicate Omega-3s. Seaweed = Iodine.",colors:['red','green','yellow']},
        {title:"Turkey Club Wrap",time:"10min",servings:1,macros:{p:38,o:400,f:6,cal:540},ingredients:["1 large tortilla","4oz turkey breast","2 slices turkey bacon","Lettuce","Tomato","Mayo (light)"],steps:["Cook bacon until crisp","Spread mayo on wrap","Layer turkey, bacon, veg","Roll tightly and slice"],why:"High protein lunch standard.",colors:['white','green','red']},
        {title:"Bean & Cheese Burrito",time:"10min",servings:1,macros:{p:22,o:200,f:14,cal:580},ingredients:["1 large whole wheat tortilla","1/2 cup refried beans (vegetarian)","1/4 cup cheddar","Salsa","Spinach","Greek yogurt"],steps:["Spread beans on tortilla","Add cheese and salsa","Add spinach","Roll and heat in pan","Dip in yogurt"],why:"Beans = fiber/protein combo. Whole wheat = sustained energy.",colors:['brown','green','white']}
    ],
    dinner: [
        {title:"Turkey Chili",time:"35min",servings:2,macros:{p:35,o:400,f:15,cal:500},ingredients:["1lb ground turkey","1 can kidney beans","1 can diced tomatoes","1 onion","1 bell pepper","Chili powder","Cumin","Garlic"],steps:["Brown turkey with onion/garlic","Add peppers and spices","Add tomatoes and beans","Simmer 20 mins","Serve warm"],why:"Turkey = lean protein. Beans = fiber. Tomatoes = lycopene.",colors:['brown','red']},
        {title:"Beef Bolognese (Zoodles)",time:"40min",servings:2,macros:{p:35,o:500,f:10,cal:550},ingredients:["1lb ground beef","1 jar marinara (no sugar)","1 onion","2 carrots","Celery","Zucchini noodles"],steps:["Brown beef","Add chopped veg, cook 5 min","Add sauce, simmer 20 min","Serve over raw or lightly saut√©ed zoodles"],why:"Beef = iron. Tomato sauce = lycopene.",colors:['red','green']}
    ],
    juices: [
        {title:"The Red Pipe Clearer",macros:{p:2,o:0,f:1,cal:110},ingredients:["Beets","Carrots","Ginger","Lemon"],steps:["Wash produce","Juice beets first","Drink immediately"],why:"Beets increase Nitric Oxide, dilating blood vessels.",colors:['red','orange']},
        {title:"The ANA Green Soother",macros:{p:2,o:0,f:1,cal:90},ingredients:["Celery","Cucumber","Turmeric","Ginger"],steps:["Juice turmeric/ginger","Follow with watery veg","Add black pepper"],why:"Turmeric/Ginger is the ultimate anti-inflammatory stack.",colors:['green','yellow']}
    ],
    snack: [
        {title:"Beef Jerky (Grass-Fed)",macros:{p:12,o:0,f:0,cal:80},ingredients:["1oz Beef Jerky (Grass-fed)"],steps:["Open and enjoy"],why:"Pure bioavailable protein. Zero prep. convenient.",colors:['brown']},
        {title:"Savory Pulp Crackers",macros:{p:6,o:1200,f:12,cal:140},ingredients:["Veggie Pulp","Flaxseed","Chia Seeds","Water"],steps:["Mix pulp and seeds","Spread thin on sheet","Dehydrate 8hrs"],why:"Zero waste. Massive fiber hit binds to cholesterol.",colors:['brown']}
    ]
};

const BASE_PROTOCOL = [
    { id: 'sunrise', time: '06:00', title: 'Morning Walk', desc: '15min walk + cold shower', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 60 },
    { id: 'breakfast', time: '07:30', title: 'Breakfast', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'breakfast' },
    { id: 'juice', time: '08:30', title: 'Fresh Juice/Elixir', desc: 'Tap to select juice', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'juices' },
    { id: 'train', time: '09:00', title: 'Training', desc: 'Auto-detected from Oura', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: false, autoDetect: true },
    { id: 'lunch', time: '13:00', title: 'Lunch', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'lunch' },
    { id: 'snack', time: '15:30', title: 'Longevity Snack', desc: 'Tap to select snack', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'snack' },
    { id: 'dinner', time: '18:30', title: 'Dinner', desc: 'Tap to select meal', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'dinner' },
    { id: 'evening', time: '21:00', title: 'Wind Down', desc: 'Chamomile tea + stretch', macros: { p: 0, o: 0, f: 0, cal: 0 }, colors: ['purple'], calBurn: 0 }
];

const TOKENS = { jermaine: 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', sophia: '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };

const LONGEVITY_MARKERS = {
    apob: { weight: 15, optimal: 80, threshold: 130, direction: 'lower' },
    lpa: { weight: 15, optimal: 30, threshold: 150, direction: 'lower' },
    rhr: { weight: 10, optimal: 50, threshold: 75, direction: 'lower' },
    sleepScore: { weight: 10, optimal: 85, threshold: 60, direction: 'higher' }
};

const RAINBOW_COLORS = {
    red: { hex: '#ff453a', examples: 'Tomatoes, Beets' },
    orange: { hex: '#ff9f0a', examples: 'Carrots, Salmon' },
    yellow: { hex: '#ffd60a', examples: 'Lemon, Turmeric' },
    green: { hex: '#30d158', examples: 'Kale, Spinach' },
    purple: { hex: '#bf5af2', examples: 'Blueberries' },
    white: { hex: '#fff', examples: 'Garlic, Onion' },
    brown: { hex: '#A0522D', examples: 'Nuts, Seeds' },
    pink: { hex: '#FF69B4', examples: 'Shrimp, Salmon' },
    black: { hex: '#333', examples: 'Olives, Beans' }
};

const ABSORPTION_RULES = {
    blockers: {
        calcium_iron: { warning: "Calcium blocks iron absorption", check: (ing) => (ing.includes('salmon') && ing.includes('yogurt')) },
        phytates: { warning: "Phytates block mineral uptake", check: (ing) => (ing.includes('oats') || ing.includes('beans')) }
    },
    boosters: {
        vitc_iron: { boost: "Vit C boosts Iron 3x", check: (ing) => (ing.includes('spinach') && ing.includes('citrus')) },
        fat_omega: { boost: "Fat helps Omega-3 absorb", check: (ing) => (ing.includes('salmon') && ing.includes('avocado')) }
    }
};

const WORKOUT_TYPES = { strength_training: 'Strength', cycling: 'Cycling', running: 'Running', walking: 'Walking', swimming: 'Swim', other: 'Workout' };

// --- APP CLASS ---
class CenturionApp {
    constructor() {
        console.log('üöÄ Init v17.26 PERSONALIZED');
        // FORCE RESET FOR NEW DB
        const CURRENT_VER = '17.26.0';
        const savedVer = localStorage.getItem('centurion_version');
        if(savedVer !== CURRENT_VER) { localStorage.clear(); localStorage.setItem('centurion_version', CURRENT_VER); }

        this.user = localStorage.getItem('centurion_user') || 'jermaine';
        this.history = [];
        this.currentIndex = 0;
        this.currentDateStr = new Date().toLocaleDateString('en-CA');
        this.checked = {};
        this.meals = {};
        this.bios = {};
        this.customMeals = {};
        this.protocol = [];
        
        this.loadUserData();
        this.setPlaceholderData();
        this.render();
        this.fetchOuraData();
    }

    loadUserData() {
        try {
            const savedChecked = localStorage.getItem(`c_checked_${this.user}`);
            this.checked = savedChecked ? JSON.parse(savedChecked) : {};
            const savedMeals = localStorage.getItem(`c_meals_${this.user}`);
            this.meals = savedMeals ? JSON.parse(savedMeals) : {};
            const savedBios = localStorage.getItem(`c_bios_${this.user}`);
            this.bios = savedBios ? JSON.parse(savedBios) : USERS[this.user].defaultBios;
            
            // LOAD CUSTOM MEALS
            const savedCustom = localStorage.getItem(`c_custom_meals_${this.user}`);
            this.customMeals = savedCustom ? JSON.parse(savedCustom) : {};
        } catch(e) { this.checked = {}; this.meals = {}; }
    }

    saveUserData() {
        localStorage.setItem(`c_checked_${this.user}`, JSON.stringify(this.checked));
        localStorage.setItem(`c_meals_${this.user}`, JSON.stringify(this.meals));
        localStorage.setItem(`c_bios_${this.user}`, JSON.stringify(this.bios));
        localStorage.setItem(`c_custom_meals_${this.user}`, JSON.stringify(this.customMeals));
    }

    setPlaceholderData() {
        this.history = [{ date: this.currentDateStr, score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: [] }];
        this.currentIndex = 0;
    }

    async fetchOuraData() {
        this.setText('syncStatus', 'SYNCING...');
        try {
            const end = new Date(); end.setDate(end.getDate() + 1);
            const start = new Date(); start.setDate(start.getDate() - 10);
            const startStr = start.toISOString().split('T')[0];
            const endStr = end.toISOString().split('T')[0];
            const token = TOKENS[this.user];
            const [s, w, a, r] = await Promise.all([
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/workout?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${startStr}&end_date=${endStr}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            if (!s.ok) throw new Error('API failed');
            const [sD, wD, aD, rD] = await Promise.all([s.json(), w.json(), a.json(), r.json()]);
            this.processData(sD.data || [], wD.data || [], aD.data || [], rD.data || []);
            this.setText('syncStatus', 'SYNCED ‚úì');
            this.render();
        } catch (error) {
            console.error('Sync failed: ' + error);
            this.setText('syncStatus', 'OFFLINE');
            this.render();
        }
    }

    processData(sleepData, workoutData, activityData, readinessData) {
        const dataMap = new Map();
        const getDay = (date) => {
            if(!dataMap.has(date)) { dataMap.set(date, { date: date, score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: [] }); }
            return dataMap.get(date);
        };
        sleepData.forEach(s => {
            const d = getDay(s.day);
            d.totalSec += s.total_sleep_duration || 0;
            d.deepSec += s.deep_sleep_duration || 0;
            d.remSec += s.rem_sleep_duration || 0;
            if (s.score && s.score > d.score) d.score = s.score;
        });
        readinessData.forEach(r => { const d = getDay(r.day); if (r.contributors?.resting_heart_rate) d.rhr = r.contributors.resting_heart_rate; });
        workoutData.forEach(w => {
            const d = getDay(w.day);
            const dateObj = new Date(w.start_datetime);
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: false });
            d.workouts.push({ type: w.activity || 'other', intensity: w.intensity || 'moderate', calories: w.calories || 300, time: timeStr, start: w.start_datetime });
        });
        activityData.forEach(a => { const d = getDay(a.day); d.cal = a.active_calories || 0; d.high = (a.high_activity_time || 0)/60; d.med = (a.medium_activity_time || 0)/60; });
        this.history = Array.from(dataMap.values()).sort((a, b) => b.date.localeCompare(a.date));
        this.currentIndex = this.history.findIndex(h => h.date === this.currentDateStr);
        if (this.currentIndex === -1) { this.history.unshift({ date: this.currentDateStr, score: 0, totalSec: 0, deepSec: 0, remSec: 0, rhr: '-', cal: 0, high: 0, med: 0, workouts: [] }); this.currentIndex = 0; }
    }

    changeDate(direction) {
        const newIndex = this.currentIndex - direction;
        if (newIndex >= 0 && newIndex < this.history.length) { this.currentIndex = newIndex; this.currentDateStr = this.history[newIndex].date; this.render(); }
    }

    switchUser(newUser) {
        if (newUser === this.user) return;
        document.querySelectorAll('.user-switch button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${newUser}`).classList.add('active');
        this.user = newUser; localStorage.setItem('centurion_user', newUser);
        this.history = []; this.loadUserData(); this.setPlaceholderData(); this.render(); this.fetchOuraData();
    }

    toggleTask(taskId) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.checked[dateKey]) this.checked[dateKey] = [];
        const index = this.checked[dateKey].indexOf(taskId);
        if (index === -1) this.checked[dateKey].push(taskId); else this.checked[dateKey].splice(index, 1);
        this.saveUserData();
        this.render();
    }

    // --- MODAL & LOGIC ---
    openBio() {
        const modalBody = document.getElementById('modalBody');
        this.setText('modalTitle', 'BIOMETRICS');
        let html = '';
        ['apob','lpa','ldl','hscrp','glucose','hba1c','weight','bmr'].forEach(f => {
            html += `<div class="bio-row"><div class="bio-group"><label>${f.toUpperCase()}</label><input class="bio-input" id="bio-${f}" type="number" value="${this.bios[f] || ''}"></div></div>`;
        });
        html += `<button class="save-btn" onclick="app.saveBio()">SAVE BIOMETRICS</button>`;
        modalBody.innerHTML = html;
        document.getElementById('mainModal').classList.add('show');
    }

    saveBio() {
        ['apob','lpa','ldl','hscrp','glucose','hba1c','weight','bmr'].forEach(f => { const el = document.getElementById(`bio-${f}`); if(el) this.bios[f] = el.value; });
        this.saveUserData(); this.closeModal(); this.render();
    }

    // --- CUSTOM MEAL BUILDER ---
    openCustomBuilder(mealSlot) {
        const modalBody = document.getElementById('modalBody');
        this.setText('modalTitle', 'ADD CUSTOM MEAL');
        
        let html = `
            <div class="builder-form">
                <div class="form-group"><label class="form-label">Meal Name</label><input id="cust-name" class="form-input" type="text" placeholder="e.g. Volleyball Pancakes"></div>
                <div class="form-group"><label class="form-label">Protein (g)</label><input id="cust-p" class="form-input" type="number" placeholder="0"></div>
                <div class="form-group"><label class="form-label">Calories</label><input id="cust-cal" class="form-input" type="number" placeholder="0"></div>
                <div class="form-group"><label class="form-label">Omega-3 (mg) [Optional]</label><input id="cust-o" class="form-input" type="number" placeholder="0"></div>
                <button class="select-btn" onclick="app.saveCustomMeal('${mealSlot}')">SAVE & SELECT</button>
            </div>
        `;
        modalBody.innerHTML = html;
    }

    saveCustomMeal(mealSlot) {
        const name = document.getElementById('cust-name').value;
        const p = parseInt(document.getElementById('cust-p').value) || 0;
        const cal = parseInt(document.getElementById('cust-cal').value) || 0;
        const o = parseInt(document.getElementById('cust-o').value) || 0;
        
        if(!name) return;

        // Save to Custom DB
        if(!this.customMeals[mealSlot]) this.customMeals[mealSlot] = [];
        this.customMeals[mealSlot].push({
            title: name,
            macros: {p: p, o: o, f: 0, cal: cal},
            ingredients: ["Custom Meal"],
            colors: ['white'],
            isCustom: true
        });
        
        this.saveUserData();
        
        // Select it immediately
        const newIndex = (MEAL_DATABASE[mealSlot] || []).length + this.customMeals[mealSlot].length - 1;
        this.selectMeal(mealSlot, newIndex); // Note: Logic handles offset in render
    }

    openMealPicker(mealSlot) {
        const modalBody = document.getElementById('modalBody');
        const slotName = mealSlot.charAt(0).toUpperCase() + mealSlot.slice(1);
        this.setText('modalTitle', slotName + ' MENU');
        
        const standardMeals = MEAL_DATABASE[mealSlot] || [];
        const userMeals = this.customMeals[mealSlot] || [];
        const allMeals = [...standardMeals, ...userMeals];
        
        let html = `
            <div class="custom-btn-container">
                <button class="custom-btn" onclick="app.openCustomBuilder('${mealSlot}')">Ôºã CREATE CUSTOM MEAL</button>
            </div>
        `;
        
        allMeals.forEach((meal, index) => {
            const title = meal.title || meal.name || "Meal";
            const colorDots = (meal.colors || []).map(c => `<span class="color-dot" style="background:${RAINBOW_COLORS[c] ? RAINBOW_COLORS[c].hex : '#fff'}"></span>`).join('');
            
            let badges = '';
            if(meal.isCustom) badges += `<span class="badge user">USER</span>`;
            
            // MENU BADGES
            const ingString = (meal.ingredients||[]).join(' ').toLowerCase();
            if(ingString.includes('salmon') && (ingString.includes('avocado') || ingString.includes('oil'))) badges += `<span class="badge boost">Œ©-3</span>`;
            if(ingString.includes('bison') && ingString.includes('peppers')) badges += `<span class="badge boost">IRON+</span>`;

            html += `<div class="menu-item" onclick="${meal.isCustom ? `app.selectMeal('${mealSlot}', ${index})` : `app.showRecipe('${mealSlot}', ${index})`}">
                <div class="menu-left">
                    <div class="menu-name">${title}</div>
                    <div class="menu-meta">P:${meal.macros.p}g ‚Ä¢ Œ©3:${meal.macros.o}mg</div>
                    <div class="menu-badges">${colorDots}</div>
                </div>
                <div class="menu-right">
                    ${badges}
                    <div class="menu-arrow">‚Ä∫</div>
                </div>
            </div>`;
        });
        modalBody.innerHTML += html;
        document.getElementById('mainModal').classList.add('show');
    }

    showRecipe(mealSlot, index) {
        const meal = MEAL_DATABASE[mealSlot][index];
        const modalBody = document.getElementById('modalBody');
        
        let ingredientsHTML = '';
        (meal.ingredients||[]).forEach(ing => ingredientsHTML += `<div class="ing-item">${ing}</div>`);
        
        let stepsHTML = '';
        (meal.steps||[]).forEach((step, i) => stepsHTML += `<div class="step-item"><span class="step-num">${i+1}</span> <span class="step-desc">${step}</span></div>`);
        
        let synergyHTML = '';
        const ingString = (meal.ingredients||[]).join(' ').toLowerCase();
        if((ingString.includes('bison') || ingString.includes('steak')) && (ingString.includes('peppers') || ingString.includes('citrus'))) synergyHTML += `<div class="abs-boost">üöÄ <strong>IRON SUPER-CHARGE:</strong> Vitamin C boosts Heme Iron absorption.</div>`;
        if(ingString.includes('salmon') && ingString.includes('yogurt')) synergyHTML += `<div class="abs-alert">‚ö†Ô∏è <strong>BLOCKER ALERT:</strong> Calcium in Yogurt blocks Iron absorption.</div>`;

        let html = `
            <div class="recipe-hero">
                <div class="recipe-title">${meal.title}</div>
                <div class="recipe-stats">
                    <span>‚è±Ô∏è ${meal.time}</span>
                    <span>üçΩÔ∏è ${meal.servings} serving</span>
                </div>
            </div>
            
            <div class="macro-grid">
                <div class="macro-stat"><div class="m-val">${meal.macros.p}</div><div class="m-lbl">PRO</div></div>
                <div class="macro-stat"><div class="m-val">${meal.macros.o}</div><div class="m-lbl">Œ©-3</div></div>
                <div class="macro-stat"><div class="m-val">${meal.macros.f}</div><div class="m-lbl">FIBER</div></div>
                <div class="macro-stat"><div class="m-val">${meal.macros.cal}</div><div class="m-lbl">CAL</div></div>
            </div>

            ${synergyHTML}

            <div class="section-label">INGREDIENTS</div>
            <div class="ing-list">${ingredientsHTML}</div>

            <div class="section-label">PREPARATION</div>
            <div class="step-list">${stepsHTML}</div>

            <button class="select-btn" onclick="app.selectMeal('${mealSlot}', ${index})">LOG THIS MEAL</button>
        `;
        
        this.setText('modalTitle', 'RECIPE DETAILS');
        modalBody.innerHTML = html;
    }

    closeModal() { document.getElementById('mainModal').classList.remove('show'); }

    selectMeal(mealSlot, mealIndex) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.meals[dateKey]) this.meals[dateKey] = {};
        this.meals[dateKey][mealSlot] = mealIndex;
        this.saveUserData();
        this.closeModal();
        this.render();
    }

    // --- CALCULATORS ---
    calculateSleepDebt() {
        const today = new Date().toLocaleDateString('en-CA');
        const last7Days = this.history.filter(day => day.date !== today && day.totalSec > 0).slice(0, 7);
        if (last7Days.length === 0) return 0;
        let totalDebt = 0;
        last7Days.forEach(day => {
            const actual = day.totalSec / 3600;
            const deficit = 8 - actual;
            if (deficit > 0) totalDebt += deficit;
        });
        return totalDebt;
    }

    calculateMacros() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let totals = { protein: 0, omega3: 0, fiber: 0, calories: 0, burn: 0 };
        this.protocol.forEach(task => {
            if (checked.includes(task.id)) {
                totals.protein += task.macros.p || 0;
                totals.omega3 += task.macros.o || 0;
                totals.fiber += task.macros.f || 0;
                totals.calories += task.macros.cal || 0;
                totals.burn += task.calBurn || 0;
            }
        });
        return totals;
    }

    calculateRainbow() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let colors = new Set();
        this.protocol.forEach(task => { if (checked.includes(task.id) && task.colors) task.colors.forEach(c => colors.add(c)); });
        return colors;
    }

    calculateGrade(score) {
        if(score >= 95) return { letter: 'S+', color: '#00ff00' };
        if(score >= 90) return { letter: 'S', color: '#ccff00' };
        if(score >= 85) return { letter: 'A+', color: '#00f0ff' };
        if(score >= 80) return { letter: 'A', color: '#00d4ff' };
        if(score >= 70) return { letter: 'B', color: '#FFD60A' };
        return { letter: 'C', color: '#ff453a' };
    }

    // --- RENDER ---
    renderGrade(score) {
        const grade = this.calculateGrade(score);
        this.setText('dayGrade', grade.letter);
        const el = document.getElementById('dayGrade');
        if(el) el.style.color = grade.color;
    }

    render() {
        try {
            if (!this.history || this.history.length === 0) return;
            this.protocol = JSON.parse(JSON.stringify(BASE_PROTOCOL));
            const dateKey = this.history[this.currentIndex].date;
            const day = this.history[this.currentIndex];
            const goals = USERS[this.user].goals;

            let selectedMeals = this.meals[dateKey] || {};
            this.protocol.forEach(task => {
                if (task.mealSlot && selectedMeals[task.mealSlot] !== undefined) {
                    const standardMeals = MEAL_DATABASE[task.mealSlot] || [];
                    const userMeals = this.customMeals[task.mealSlot] || [];
                    const allMeals = [...standardMeals, ...userMeals];
                    
                    if(allMeals[selectedMeals[task.mealSlot]]) {
                         const meal = allMeals[selectedMeals[task.mealSlot]];
                         task.title = meal.title || meal.name; 
                         task.desc = `P:${meal.macros.p} F:${meal.macros.f||0} Œ©3:${meal.macros.o}`;
                         task.macros = meal.macros;
                         task.colors = meal.colors;
                    } else { task.desc = "Select meal"; }
                }
            });
            
            if (day.workouts && day.workouts.length > 0) {
                this.protocol = this.protocol.filter(t => t.id !== 'train');
                day.workouts.forEach((w, i) => {
                    const dateObj = new Date(w.start);
                    const displayTime = dateObj.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit'});
                    this.protocol.push({
                        id: `workout-${i}`, time: w.time, displayTime: displayTime,
                        title: `${WORKOUT_TYPES[w.type] || 'Workout'} üîÑ`,
                        desc: `${w.calories} cal ‚Ä¢ Auto-detected`, macros: {p:0,o:0,f:0,cal:0}, colors: [], calBurn: w.calories, autoDetected: true
                    });
                    const checked = this.checked[dateKey] || [];
                    if (!checked.includes(`workout-${i}`)) { checked.push(`workout-${i}`); this.checked[dateKey] = checked; }
                });
                this.protocol.sort((a, b) => a.time.localeCompare(b.time));
                this.saveUserData();
            }

            const sleepHours = (day.totalSec || 0) / 3600;
            const dayScore = Math.min(100, Math.round((sleepHours / 8) * 100));
            this.renderGrade(dayScore); 
            this.setText('dateLabel', day.date);
            
            const macros = this.calculateMacros();
            const bmr = parseInt(this.bios.bmr) || 2057;
            const totalBurn = bmr + macros.burn;
            
            const updateOrb = (id, val, goal, activeColor) => {
                const el = document.getElementById(id);
                if(el) {
                   const pct = Math.min(val/goal, 1);
                   el.style.strokeDashoffset = 145 - (pct * 145);
                   el.style.stroke = activeColor;
                }
            };
            const updateHeart = (id, val, goal) => {
                 const el = document.getElementById(id);
                 if(el) el.style.strokeDashoffset = 100 - (Math.min(val/goal, 1) * 100);
            };

            this.setText('sleepVal', `${Math.floor(sleepHours)}h ${Math.round((day.totalSec%3600)/60)}m`);
            this.setText('deepVal', `${Math.round((day.deepSec||0)/60)}m`);
            this.setText('remVal', `${Math.round((day.remSec||0)/60)}m`);
            updateOrb('sleepOrb', sleepHours, 8, '#bf5af2');
            updateOrb('deepOrb', (day.deepSec||0)/60, 90, '#007aff');
            updateOrb('remOrb', (day.remSec||0)/60, 90, '#bf5af2');

            this.setText('proteinVal', macros.protein); updateOrb('proteinOrb', macros.protein, goals.protein, '#fff');
            this.setText('omega3Val', Math.round(macros.omega3/1000)+'g'); updateOrb('omega3Orb', macros.omega3, goals.omega3, '#00d4ff');
            this.setText('fiberVal', macros.fiber); updateOrb('fiberOrb', macros.fiber, goals.fiber, '#30d158');
            this.setText('calorieVal', macros.calories); updateOrb('calorieOrb', macros.calories, 2500, '#FFD60A');

            this.setText('rhrVal', day.rhr); 
            this.setText('z2Val', Math.round(day.med||0)); updateHeart('z2Heart', day.med||0, goals.z2||45);
            this.setText('z5Val', Math.round(day.high||0)); updateHeart('z5Heart', day.high||0, goals.z5||20);
            this.setText('calVal', Math.round(day.cal||0)); updateHeart('calHeart', day.cal||0, goals.calBurn||500);

            const userDob = USERS[this.user].dob;
            if(userDob) {
                const [y, m, d] = userDob.split('-').map(Number);
                const today = new Date();
                if(today.getMonth()+1 === m && today.getDate() === d) {
                     const age = today.getFullYear() - y;
                     const banner = document.getElementById('alertBanner');
                     if (this.user === 'sophia' && m === 1 && d === 25) {
                         banner.className = 'alert alert-love show';
                         banner.innerHTML = `üéÇ <strong>HAPPY BIRTHDAY SOPHIA!</strong> üéâ<br><br>I love you so much. You inspire me every single day.<br>Let's crush 39 together. ‚ù§Ô∏è - Jermaine`;
                     } else {
                         banner.className = 'alert alert-protein show';
                         banner.innerText = `üéÇ HAPPY ${age}TH BIRTHDAY ${USERS[this.user].name.toUpperCase()}! üéâ`;
                     }
                     this.setText('statusMsg', 'CELEBRATION MODE üéÇ');
                } else {
                     this.renderStatus(sleepHours);
                }
            } else {
                 this.renderStatus(sleepHours);
            }
            this.renderRainbow();
            this.renderTimeline(dateKey);
        } catch (e) { console.error('Render Error: ' + e); }
    }

    renderRainbow() {
        const colors = this.calculateRainbow();
        const score = Math.round((colors.size / 6) * 100);
        this.setText('rainbowScore', score + '%');
        let html = '';
        ['red', 'orange', 'yellow', 'green', 'purple', 'white'].forEach(c => {
            const width = colors.has(c) ? 16.66 : 0;
            const hex = RAINBOW_COLORS[c] ? RAINBOW_COLORS[c].hex : '#999';
            html += `<div class="rainbow-seg" style="background:${hex}; width:${width}%"></div>`;
        });
        document.getElementById('rainbowTrack').innerHTML = html;
        const sugg = document.getElementById('rainbowSuggestion');
        if(colors.size < 6 && colors.size > 0) {
            const missing = ['red', 'orange', 'yellow', 'green', 'purple', 'white'].find(c => !colors.has(c));
            sugg.innerText = `Tip: Add ${missing.toUpperCase()} foods!`;
            sugg.style.display = 'block';
        } else { sugg.style.display = 'none'; }
    }

    renderStatus(sleepHours) {
        const debt = this.calculateSleepDebt();
        const banner = document.getElementById('alertBanner');
        let status = '';
        if (debt > 7) {
            status = `‚ö†Ô∏è SLEEP DEBT: ${debt.toFixed(1)}h`;
            banner.className = 'alert alert-warning show';
            banner.innerText = "FORCED RECOVERY: Sleep Debt Critical";
        } else if (sleepHours >= 7) {
            status = "‚úÖ OPTIMAL READY";
            banner.className = 'alert';
        } else {
            status = "‚ö†Ô∏è CAUTION";
            banner.className = 'alert';
        }
        this.setText('statusMsg', status);
    }

    renderTimeline(dateKey) {
        const checked = this.checked[dateKey] || [];
        let html = '';
        this.protocol.forEach(task => {
            const isChecked = checked.includes(task.id);
            const clickAction = task.clickable ? `onclick="app.openMealPicker('${task.mealSlot}')"` : '';
            const cardClass = `task-card ${isChecked ? 'checked' : ''} ${task.clickable ? 'clickable' : ''} ${task.autoDetected ? 'auto-detected' : ''}`;
            const chevron = task.clickable ? `<span class="chevron">‚Ä∫</span>` : '';
            const timeDisplay = task.displayTime || task.time;
            html += `<div class="task">
                <div class="task-time">${timeDisplay}</div>
                <div class="${cardClass}" ${clickAction}>
                    <div class="task-info">
                        <div class="task-title">${task.title} ${task.autoDetected ? '<span class="workout-badge">AUTO</span>' : ''}</div>
                        <div class="task-desc">${task.desc}</div>
                    </div>
                    ${chevron}
                    ${!task.autoDetected ? `<div class="check-btn" onclick="event.stopPropagation(); app.toggleTask('${task.id}')"><div class="check-circle">${isChecked ? '‚úì' : ''}</div></div>` : ''}
                </div>
            </div>`;
        });
        document.getElementById('timeline').innerHTML = html;
    }

    setText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
    sync() { this.fetchOuraData(); }
}

let app;
window.onload = () => { app = new CenturionApp(); window.app = app; };
</script>
</body>
</html>