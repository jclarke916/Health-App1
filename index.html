<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centurion v9600.1 LOGIC PROBE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: 'JetBrains Mono', monospace; padding: 20px; font-size: 11px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .btn { background: #222; border: 1px solid #444; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: bold; }
        .btn.active { background: #00f0ff; color: #000; }
        
        #log-console { 
            background: #0a0a0a; border: 1px solid #333; border-radius: 8px; 
            height: 450px; overflow-y: auto; padding: 10px; margin-bottom: 20px;
            white-space: pre-wrap; word-break: break-all;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-time { color: #555; margin-right: 8px; }
        .log-info { color: #00f0ff; }
        .log-warn { color: #ffd60a; font-weight: bold; }
        .log-error { color: #ff453a; font-weight: bold; background: rgba(255, 69, 58, 0.1); display:inline-block; width:100%; }
        .log-success { color: #30d158; }
        .log-debug { color: #bf5af2; }
    </style>
</head>
<body>

    <div class="header">
        <div>V9600.1 LOGIC PROBE</div>
        <div>
            <button id="btn-J" class="btn active" onclick="app.switchUser('jermaine')">JER</button>
            <button id="btn-S" class="btn" onclick="app.switchUser('sophia')">SOPH</button>
        </div>
    </div>

    <div id="log-console"></div>
    <button class="btn" style="width:100%; padding:15px; background:#222; border-color:#00f0ff; color:#00f0ff;" onclick="app.fetchData()">FORCE SYNC (RUN DIAGNOSTIC)</button>

<script>
// --- CONFIG ---
const TOKENS = { 'jermaine': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 'sophia': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };
function getToday() { let d = new Date(); d.setHours(12,0,0,0); return d.toISOString().split('T')[0]; }

// --- LOGGER ---
function log(msg, type='info') {
    const box = document.getElementById('log-console');
    const time = new Date().toLocaleTimeString().split(' ')[0];
    box.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span></div>`;
    box.scrollTop = box.scrollHeight;
}

// --- APP CORE ---
const app = {
    user: 'jermaine',
    
    init: function() {
        this.switchUser('jermaine');
    },

    switchUser: function(uid) {
        this.user = uid;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById(uid === 'jermaine' ? 'btn-J' : 'btn-S').classList.add('active');
        log(`Switched to user: ${uid.toUpperCase()}`, 'info');
    },

    fetchData: async function() {
        const token = TOKENS[this.user];
        const today = getToday();
        const start = new Date(); start.setDate(start.getDate() - 5); 
        const startStr = start.toISOString().split('T')[0];
        
        log('-----------------------------------');
        log(`DIAGNOSTIC START: ${today}`, 'info');

        try {
            // 1. FETCH
            log(`Fetching data from ${startStr}...`, 'info');
            const cb = `&t=${Date.now()}`;
            
            const [rRes, sRes] = await Promise.all([
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?start_date=${startStr}&end_date=${today}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${today}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            const rData = await rRes.json();
            const sData = await sRes.json();

            log(`Readiness: Found ${rData.data?.length || 0} records`, 'success');
            log(`Sleep Sessions: Found ${sData.data?.length || 0} records`, 'success');

            if(!rData.data || rData.data.length === 0) {
                log('CRITICAL: No Readiness Data found.', 'error');
                return;
            }

            // 2. PROCESS LOOP (The Danger Zone)
            log('Starting Merge Logic...', 'warn');
            
            const hist = rData.data.map(day => {
                try {
                    const todayKey = day.day; // "2026-01-05"
                    log(`Processing Readiness Day: ${todayKey}`, 'info');

                    // --- TIME BRIDGE LOGIC START ---
                    let sessions = [];
                    
                    // Attempt 1: Check Today
                    if(sData.data) {
                        sessions = sData.data.filter(s => s.day === todayKey);
                    }
                    
                    // Attempt 2: Check Yesterday (Safe Date Math)
                    if(sessions.length === 0) {
                        log(`  > No sessions for ${todayKey}. Calculating yesterday...`, 'debug');
                        
                        // SAFE DATE CALCULATION
                        // We parse string manually to avoid timezone shifts
                        const parts = todayKey.split('-');
                        const dObj = new Date(parts[0], parts[1]-1, parts[2]); // Y, M-1, D
                        dObj.setDate(dObj.getDate() - 1);
                        
                        // Pad with leading zeros
                        const yY = dObj.getFullYear();
                        const yM = String(dObj.getMonth() + 1).padStart(2, '0');
                        const yD = String(dObj.getDate()).padStart(2, '0');
                        const prevKey = `${yY}-${yM}-${yD}`;
                        
                        log(`  > Checking Yesterday: ${prevKey}`, 'debug');
                        
                        if(sData.data) {
                            sessions = sData.data.filter(s => s.day === prevKey);
                        }
                    }
                    // --- TIME BRIDGE LOGIC END ---

                    log(`  > Found ${sessions.length} sessions matching.`, sessions.length > 0 ? 'success' : 'error');

                    // Summation
                    let totalSec = 0;
                    sessions.forEach(s => {
                        totalSec += (s.total_sleep_duration || 0);
                    });

                    let sleepStr = totalSec > 0 ? (totalSec / 3600).toFixed(1) : "NaN";
                    log(`  > Final Sleep Hours: ${sleepStr}`, 'info');

                    return { date: day.day, score: day.score, sleep: sleepStr };

                } catch (err) {
                    log(`CRASH inside loop for ${day.day}: ${err.message}`, 'error');
                    console.error(err);
                    return null;
                }
            });

            log('Processing Complete. Check above for "CRASH" errors.', 'success');

        } catch(e) {
            log(`GLOBAL CRASH: ${e.message}`, 'error');
            console.error(e);
        }
    }
};

// Start
app.init();
</script>
</body>
</html>