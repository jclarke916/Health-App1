Claude 2

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v2001.0 Predictive Autopilot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --glass: rgba(30, 30, 32, 0.85);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
            --gold: #FFD60A;
            --green: #30D158;
            --blue: #0A84FF;
            --red: #FF453A;
            --purple: #BF5AF2;
            --orange: #FF9F0A;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px 16px; min-height: 100vh; background-image: radial-gradient(circle at top center, #1a1a1a 0%, #000000 60%); }
        .container { max-width: 480px; margin: 0 auto; padding-bottom: 60px; }
        h1 { text-align: center; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; font-size: 0.8rem; margin: 10px 0 20px 0; color: #666; }

        .badge-row { display: flex; justify-content: center; background: rgba(255, 255, 255, 0.05); padding: 4px; border-radius: 30px; margin: 0 auto 20px auto; width: fit-content; border: 1px solid var(--border); }
        .u-badge { padding: 8px 20px; border-radius: 24px; font-size: 0.7rem; font-weight: 700; cursor: pointer; color: var(--text-sub); transition: all 0.3s ease; }
        .u-badge.active { background: rgba(255, 255, 255, 0.15); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .status-bar { text-align: center; color: var(--text-sub); font-size: 0.65rem; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; }
        .controls { display: flex; gap: 8px; margin-bottom: 20px; }
        .nav-btn { background: var(--glass); border: 1px solid var(--border); color: var(--text-sub); padding: 12px; flex: 1; border-radius: 16px; font-size: 0.6rem; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        .nav-btn:active { transform: scale(0.98); }

        .tabs { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;}
        .tab { flex: 1; min-width: 45px; padding: 12px 0; background: transparent; color: #555; border-radius: 16px; font-size: 0.6rem; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: var(--glass); color: #fff; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        .premium-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .premium-card:active { transform: scale(0.99); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-sub); }
        .card-subtitle { font-size: 0.65rem; color: #555; margin-top: 3px; }
        .card-val-lg { font-size: 1.6rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }

        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.02); }
        .data-label { font-size: 0.65rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .data-val { font-size: 0.8rem; font-weight: 700; color: #fff; }

        .bio-section { margin-bottom: 15px; }
        .bar-label { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; margin-bottom: 8px; display: flex; justify-content: space-between; text-transform: uppercase; }
        .bar-track { height: 8px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 0.8s ease; }
        
        .section-header { margin: 25px 0 10px 0; font-size: 0.6rem; color: #666; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .chevron { font-size: 0.8rem; color: #444; transition: transform 0.3s ease; margin-left: 10px; }
        .premium-card.collapsed .card-body { display: none; }
        .premium-card.collapsed .chevron { transform: rotate(-90deg); }
        
        .science-box { margin-top: 15px; padding: 12px; background: rgba(255, 214, 10, 0.05); border-left: 2px solid var(--gold); border-radius: 4px; }
        .sci-label { font-size: 0.6rem; color: var(--gold); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .sci-text { font-size: 0.75rem; color: #ddd; line-height: 1.4; }
        .sci-reason { color: #888; font-style: italic; margin-top: 4px; font-size: 0.7rem; }

        .action-btn { background: var(--blue); color: #fff; padding: 12px 20px; border-radius: 12px; border: none; font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; transition: all 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        .action-btn.green { background: var(--green); }
        .action-btn.gold { background: var(--gold); color: #000; }
        .action-btn.red { background: var(--red); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; animation: fadeIn 0.2s; }
        .modal.active { display: flex; }
        .modal-header { padding: 20px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 0.8rem; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1.5px; }
        .modal-close { font-size: 1.8rem; cursor: pointer; color: #666; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; }
        .form-input { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-size: 0.9rem; font-weight: 600; }
        .form-input:focus { outline: none; border-color: var(--blue); }

        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 16px; padding: 15px 25px; z-index: 10000; display: none; animation: slideDown 0.3s; max-width: 90%; }
        .notification.active { display: block; }
        .notification.success { border-color: var(--green); }
        .notification.error { border-color: var(--red); }

        .prediction-badge { display: inline-block; padding: 4px 10px; background: rgba(10, 132, 255, 0.15); border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 8px; font-size: 0.55rem; font-weight: 800; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; margin-left: 8px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateX(-50%) translateY(-20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>THE CENTURION PROTOCOL</h1>
        <div class="badge-row">
            <div id="bj" class="u-badge" onclick="switchU('J')">üßîüèæ‚Äç‚ôÇÔ∏è JERMAINE</div>
            <div id="bs" class="u-badge" onclick="switchU('S')">üë©üèæ‚Äçü¶± SOPHIA</div>
        </div>
    </header>
    
    <div id="labReminder" class="status-bar" style="color: var(--orange); cursor: default;"></div>
    <div id="ouraBar" class="status-bar" onclick="fetchOuraData()">üíç HANDSHAKE REQUIRED...</div>
    <div id="dateDisplay" class="status-bar" style="margin-bottom: 20px; opacity: 0.7;">...</div>

    <div class="controls">
        <button class="nav-btn" onclick="changeW(-1)">‚óÄ PREV</button>
        <button class="nav-btn" onclick="resetD()">TODAY</button>
        <button class="nav-btn" onclick="changeW(1)">NEXT ‚ñ∂</button>
    </div>
    
    <div id="dayTabs" class="tabs"></div>
    <div id="dayContent"></div>
    <div style="text-align:center; color:#333; font-size:10px; margin-top:30px; opacity:0.4;">v2001.0 Predictive Autopilot + AI Vision</div>
</div>

<div id="mealModal" class="modal">
    <div class="modal-header">
        <div class="modal-title">üì∏ AI MEAL ANALYZER</div>
        <div class="modal-close" onclick="closeModal('mealModal')">‚úï</div>
    </div>
    <div class="modal-body">
        <input type="file" accept="image/*" capture="environment" id="photoInput" style="display:none" onchange="processPhotoWithAI(event)">
        <label for="photoInput">
            <div style="border: 2px dashed var(--border); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üì∏</div>
                <div style="font-size: 0.8rem; color: var(--text-sub);">TAP TO CAPTURE MEAL</div>
                <div style="font-size: 0.6rem; color: #666; margin-top: 8px;">AI will identify food & estimate macros</div>
            </div>
        </label>
        <div id="photoPreview" style="display:none;"></div>
        <div style="border-top: 1px solid var(--border); padding-top: 20px; margin-top: 20px;">
            <div style="font-size: 0.65rem; color: #666; margin-bottom: 10px; text-transform: uppercase;">OR QUICK LOG</div>
            <div id="quickMealButtons"></div>
        </div>
    </div>
</div>

<div id="labModal" class="modal">
    <div class="modal-header">
        <div class="modal-title">ü©∏ LOG TEST RESULTS</div>
        <div class="modal-close" onclick="closeModal('labModal')">‚úï</div>
    </div>
    <div class="modal-body">
        <div style="background: rgba(10, 132, 255, 0.1); padding: 15px; border-radius: 12px; border-left: 3px solid var(--blue); margin-bottom: 20px;">
            <div style="font-size: 0.65rem; color: var(--blue); font-weight: 800; margin-bottom: 5px;">‚ÑπÔ∏è PREDICTION MODE</div>
            <div style="font-size: 0.75rem; color: #ddd; line-height: 1.4;">
                Between tests, we use AI to predict your daily values. Only log when you get actual test results (every 3 months).
            </div>
        </div>
        <div id="labModalBody"></div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
// ==========================================
// CENTURION v2001.0 - PREDICTIVE AUTOPILOT
// ==========================================

let user = localStorage.getItem('centurion_active_user') || 'J';
let offset = 0;
let selDate = getCaDate(); 

let isPlanCollapsed = false;
let isWorkoutCollapsed = true;
let isNutCollapsed = true;
let isAICollapsed = true;
let isBioCollapsed = true;
let isTrendCollapsed = true;

const TOKENS = { 
    'J': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 
    'S': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' 
};

// ==========================================
// BASELINE DATA (ANCHOR POINTS)
// ==========================================

const baselineData = {
    'J': {
        // Last verified measurements
        lastBodyScan: {
            date: '2024-12-15',
            bf: 19.0,
            muscle: 99.0,
            vf: 10
        },
        lastLabTest: {
            date: '2024-12-15',
            apob: 95,
            hba1c: 5.4,
            testosterone: 650,
            vitaminD: 45
        },
        // Goals
        goals: {
            bf: 15.0,
            muscle: 105.0,
            vf: 7,
            apob: 60,
            hba1c: 5.0,
            testosterone: 600,
            vitaminD: 50,
            vo2: 55
        },
        // Current VO2 (updated from performance tests)
        vo2: 45,
        // Intervention start date
        startDate: '2025-01-01'
    },
    'S': {
        lastBodyScan: {
            date: '2024-12-20',
            bf: 36.1,
            muscle: 49.2,
            vf: 9
        },
        lastLabTest: {
            date: '2024-12-20',
            calcium: 9.0,
            glucose: 84,
            bun: 13,
            creatinine: 0.82,
            egfr: 94,
            ana: 320,
            hba1c: 5.6,
            ferritin: 75,
            tsh: 2.1,
            vitaminD: 38
        },
        goals: {
            bf: 22.0,
            muscle: 60.0,
            vf: 4,
            calcium: 9.5,
            glucose: 85,
            bun: 15,
            creatinine: 0.7,
            egfr: 90,
            ana: 40,
            hba1c: 5.0,
            ferritin: 70,
            tsh: 2.0,
            vitaminD: 50,
            vo2: 45
        },
        vo2: 32,
        startDate: '2025-01-01'
    }
};

const labMetadata = {
    'J': {
        apob: { name: "ApoB", unit: "mg/dL", lowerBetter: true, freq: 90 },
        hba1c: { name: "HbA1c", unit: "%", lowerBetter: true, freq: 90 },
        testosterone: { name: "Testosterone", unit: "ng/dL", lowerBetter: false, freq: 180 },
        vitaminD: { name: "Vitamin D", unit: "ng/mL", lowerBetter: false, freq: 180 }
    },
    'S': {
        calcium: { name: "Calcium", unit: "mg/dL", lowerBetter: false, freq: 90 },
        glucose: { name: "Glucose", unit: "mg/dL", lowerBetter: true, freq: 90 },
        bun: { name: "BUN", unit: "mg/dL", lowerBetter: false, freq: 90 },
        creatinine: { name: "Creatinine", unit: "mg/dL", lowerBetter: true, freq: 90 },
        egfr: { name: "eGFR", unit: "", lowerBetter: false, freq: 90 },
        ana: { name: "ANA Titer", unit: "", lowerBetter: true, freq: 90 },
        hba1c: { name: "HbA1c", unit: "%", lowerBetter: true, freq: 90 },
        ferritin: { name: "Ferritin", unit: "ng/mL", lowerBetter: false, freq: 180 },
        tsh: { name: "TSH", unit: "mIU/L", lowerBetter: true, freq: 180 },
        vitaminD: { name: "Vitamin D", unit: "ng/mL", lowerBetter: false, freq: 180 }
    }
};

const unifiedSchedule = {
    1: { focus: "HEAVY LIFT", tasks: "5x5 Compounds | Squat/Deadlift", zT: {h:15, m:30} },
    2: { focus: "BOXING", tasks: "45m Intervals | Breath Training", zT: {h:30, m:15} },
    3: { focus: "REFORM", tasks: "Pilates | Stability Work", zT: {h:5, m:40} },
    4: { focus: "BOXING", tasks: "Technique & Heavy Bag", zT: {h:25, m:20} },
    5: { focus: "REFORM", tasks: "Core & Recovery Focus", zT: {h:0, m:30} },
    6: { focus: "CS4 / VO2", tasks: "Max Effort Intervals", zT: {h:25, m:20} },
    0: { focus: "REST", tasks: "Active Recovery Walk", zT: {h:0, m:0} }
};

const mealDB = {
    b: [
        { name: "Ancestral Beef Sausage", pro: 25, carb: 5, fat: 18, cal: 280 },
        { name: "Avocado Egg Toast", pro: 20, carb: 35, fat: 12, cal: 340 },
        { name: "Greek Yogurt Bowl", pro: 30, carb: 25, fat: 8, cal: 290 }
    ],
    l: [
        { name: "Super Mince Bowl", pro: 50, carb: 35, fat: 15, cal: 550 },
        { name: "Salmon Power Salad", pro: 40, carb: 20, fat: 25, cal: 480 },
        { name: "Turkey Rice Bowl", pro: 45, carb: 50, fat: 10, cal: 520 }
    ],
    d: [
        { name: "Bison Portobello", pro: 45, carb: 12, fat: 18, cal: 420 },
        { name: "Ribeye & Sweet Potato", pro: 50, carb: 40, fat: 25, cal: 620 },
        { name: "Halibut White Beans", pro: 42, carb: 30, fat: 12, cal: 420 }
    ]
};

// ==========================================
// PREDICTIVE ENGINE - BODY COMPOSITION
// ==========================================

function predictBodyCompositionForDate(userID, targetDate) {
    const baseline = baselineData[userID];
    const lastScan = baseline.lastBodyScan;
    const goals = baseline.goals;
    
    const startDate = new Date(baseline.startDate);
    const scanDate = new Date(lastScan.date);
    const target = new Date(targetDate);
    
    // Days since intervention started
    const daysSinceStart = Math.floor((target - startDate) / 86400000);
    
    // Expected weekly rates (based on optimal protocol compliance)
    const weeklyBFLoss = user === 'J' ? 0.25 : 0.35; // % per week
    const weeklyMuscleGain = user === 'J' ? 0.4 : 0.3; // lbs per week
    const weeklyVFReduction = 0.15; // units per week
    
    const weeksPassed = daysSinceStart / 7;
    
    // Calculate predictions with asymptotic approach to goals
    const predictedBF = Math.max(
        goals.bf,
        lastScan.bf - (weeklyBFLoss * weeksPassed * (1 - weeksPassed/52)) // Slow as you approach goal
    );
    
    const predictedMuscle = Math.min(
        goals.muscle,
        lastScan.muscle + (weeklyMuscleGain * weeksPassed * (1 - weeksPassed/52))
    );
    
    const predictedVF = Math.max(
        goals.vf,
        lastScan.vf - (weeklyVFReduction * weeksPassed)
    );
    
    // Confidence based on days since last actual measurement
    const daysSinceLastScan = Math.floor((target - scanDate) / 86400000);
    let confidence;
    if (daysSinceLastScan <= 7) confidence = "HIGH";
    else if (daysSinceLastScan <= 21) confidence = "MEDIUM";
    else confidence = "LOW";
    
    return {
        bf: parseFloat(predictedBF.toFixed(1)),
        muscle: parseFloat(predictedMuscle.toFixed(1)),
        vf: Math.round(predictedVF),
        confidence,
        daysSinceLastScan,
        isPrediction: daysSinceLastScan > 0
    };
}

// ==========================================
// PREDICTIVE ENGINE - LAB VALUES
// ==========================================

function predictLabValueForDate(userID, labKey, targetDate) {
    const baseline = baselineData[userID];
    const lastTest = baseline.lastLabTest;
    const goals = baseline.goals;
    
    if (!lastTest[labKey]) return null;
    
    const startDate = new Date(baseline.startDate);
    const testDate = new Date(lastTest.date);
    const target = new Date(targetDate);
    
    const daysSinceStart = Math.floor((target - startDate) / 86400000);
    const weeksPassed = daysSinceStart / 7;
    
    // Get lab metadata
    const meta = labMetadata[userID][labKey];
    const currentVal = lastTest[labKey];
    const goalVal = goals[labKey];
    
    // Calculate expected weekly change (assumes optimal intervention compliance)
    let weeklyChange;
    
    if (userID === 'J') {
        if (labKey === 'apob') weeklyChange = -2.5; // mg/dL per week (diet + exercise)
        else if (labKey === 'hba1c') weeklyChange = -0.01; // % per week
        else if (labKey === 'testosterone') weeklyChange = 0; // Stable unless on TRT
        else if (labKey === 'vitaminD') weeklyChange = 0.5; // ng/mL per week with supplementation
    } else {
        if (labKey === 'ana') weeklyChange = -8; // Reduction with anti-inflammatory protocol
        else if (labKey === 'hba1c') weeklyChange = -0.015; // Faster improvement for Sophia
        else if (labKey === 'glucose') weeklyChange = -0.3;
        else if (labKey === 'ferritin') weeklyChange = -0.2;
        else if (labKey === 'tsh') weeklyChange = -0.02;
        else if (labKey === 'vitaminD') weeklyChange = 0.8;
        else weeklyChange = 0; // Stable markers
    }
    
    // Apply asymptotic slowdown as you approach goal
    const progressFactor = 1 - Math.min(weeksPassed / 52, 0.8);
    let predictedVal = currentVal + (weeklyChange * weeksPassed * progressFactor);
    
    // Clamp to goal (don't overshoot)
    if (meta.lowerBetter) {
        predictedVal = Math.max(goalVal, predictedVal);
    } else {
        predictedVal = Math.min(goalVal, predictedVal);
    }
    
    // Confidence
    const daysSinceLastTest = Math.floor((target - testDate) / 86400000);
    let confidence;
    if (daysSinceLastTest <= 30) confidence = "HIGH";
    else if (daysSinceLastTest <= 60) confidence = "MEDIUM";
    else confidence = "LOW";
    
    return {
        value: parseFloat(predictedVal.toFixed(labKey === 'hba1c' || labKey === 'creatinine' || labKey === 'tsh' ? 2 : 1)),
        confidence,
        daysSinceLastTest,
        isPrediction: daysSinceLastTest > 0
    };
}

// ==========================================
// DATA PERSISTENCE
// ==========================================

function saveLabTest(userID, testDate, results) {
    // Update baseline with new test results
    baselineData[userID].lastLabTest = {
        date: testDate,
        ...results
    };
    
    // Save to localStorage
    localStorage.setItem('centurion_baseline', JSON.stringify(baselineData));
    
    showNotification('‚úì Lab results saved - Predictions updated');
}

function loadBaselineData() {
    const saved = localStorage.getItem('centurion_baseline');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(u => {
            if (baselineData[u]) {
                Object.assign(baselineData[u], data[u]);
            }
        });
    }
}

function saveBodyScan(userID, scanDate, results) {
    baselineData[userID].lastBodyScan = {
        date: scanDate,
        ...results
    };
    
    localStorage.setItem('centurion_baseline', JSON.stringify(baselineData));
    showNotification('‚úì Body scan saved - Predictions updated');
}

// ==========================================
// UTILITIES
// ==========================================

function getCaDate() { let d = new Date(); d.setHours(12, 0, 0, 0); return d; }
function getDateKey(d) { return d.toISOString().split('T')[0]; }
function getMon(o) { let d = getCaDate(); d.setHours(0,0,0,0); let day = d.getDay(); let diff = d.getDate() - day + (day === 0 ? -6 : 1); d.setDate(diff + (o * 7)); return d; }

function bioBar(label, val, goal, unit, lowerBetter=false, isPredicted=false) { 
    if(!val || isNaN(val)) return ""; 
    const pct = Math.min(lowerBetter ? (goal/val)*100 : (val/goal)*100, 100); 
    const color = pct >= 100 ? 'var(--green)' : pct >= 70 ? 'var(--gold)' : 'var(--red)'; 
    const predBadge = isPredicted ? '<span class="prediction-badge">AI PRED</span>' : '';
    return `<div class="bio-section"><div class="bar-label"><span>${label} ${predBadge}</span><span>${val}${unit}</span></div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div></div>`; 
}

function showNotification(message, type='success') {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.className = 'notification active ' + type;
    setTimeout(() => notif.className = 'notification', 3000);
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function checkLabReminder(userID) {
    const lastTest = new Date(baselineData[userID].lastLabTest.date);
    const nextDue = new Date(lastTest);
    nextDue.setDate(nextDue.getDate() + 90);
    
    const today = new Date();
    const daysUntil = Math.floor((nextDue - today) / 86400000);
    
    if (daysUntil <= 0) {
        return `ü©∏ LAB WORK OVERDUE - <span style="text-decoration:underline; cursor:pointer;" onclick="openLabLogger()">Order tests now</span>`;
    } else if (daysUntil <= 7) {
        return `ü©∏ LAB WORK DUE IN ${daysUntil} DAYS`;
    } else if (daysUntil <= 14) {
        return `ü©∏ Next labs: ${daysUntil} days`;
    }
    return null;
}
// ==========================================
// AI VISION - FOOD RECOGNITION
// ==========================================

async function processPhotoWithAI(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const imgData = e.target.result;
        const base64Data = imgData.split(',')[1];
        
        document.getElementById('photoPreview').style.display = 'block';
        document.getElementById('photoPreview').innerHTML = `
            <img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;">
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--border);">
                <div style="font-size:0.65rem; color:#888; margin-bottom:10px; text-transform:uppercase;">ü§ñ AI VISION ANALYZING</div>
                <div style="text-align:center; padding:20px; color:#666;">
                    <div style="font-size:1.2rem; margin-bottom:10px; animation: pulse 1.5s infinite;">üîÑ Identifying food...</div>
                    <div style="font-size:0.7rem;">This may take 5-10 seconds</div>
                </div>
            </div>
        `;
        
        try {
            // Call Anthropic API with vision
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1024,
                    messages: [{
                        role: "user",
                        content: [
                            {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: "image/jpeg",
                                    data: base64Data
                                }
                            },
                            {
                                type: "text",
                                text: `Analyze this food image and provide ONLY a JSON response with this exact structure (no markdown, no explanation):
{
  "foods": ["food item 1", "food item 2"],
  "description": "brief description of the meal",
  "protein": estimated_grams,
  "carbs": estimated_grams,
  "fat": estimated_grams,
  "calories": estimated_total,
  "portionSize": "small/medium/large",
  "confidence": "high/medium/low"
}

Be specific about food items (e.g., "grilled chicken breast" not just "chicken"). Estimate macros based on visible portion sizes. If you can't identify clearly, set confidence to "low".`
                            }
                        ]
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error('AI Vision unavailable');
            }
            
            const data = await response.json();
            const aiText = data.content[0].text.trim();
            
            // Parse JSON response
            let foodData;
            try {
                // Remove any markdown code blocks if present
                const cleanJson = aiText.replace(/```json\n?|\n?```/g, '').trim();
                foodData = JSON.parse(cleanJson);
            } catch (e) {
                throw new Error('Could not parse AI response');
            }
            
            const { foods, description, protein, carbs, fat, calories, portionSize, confidence } = foodData;
            
            // Display results
            document.getElementById('photoPreview').innerHTML = `
                <img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;">
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:12px;">
                        <div style="font-size:0.65rem; color:var(--green); text-transform:uppercase; font-weight:800;">‚úì AI IDENTIFIED</div>
                        <div style="font-size:0.6rem; padding:4px 8px; background:rgba(255,255,255,0.1); border-radius:6px; color:#888;">
                            ${confidence.toUpperCase()} CONFIDENCE
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <div style="font-size:0.9rem; font-weight:800; color:#fff; margin-bottom:8px;">
                            ${foods.join(' ‚Ä¢ ')}
                        </div>
                        <div style="font-size:0.7rem; color:#888; line-height:1.4;">
                            ${description} (${portionSize} portion)
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1; text-align:center; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px;">
                            <div style="font-size:1.2rem; font-weight:800; color:var(--red)">${protein}</div>
                            <div style="font-size:0.5rem; color:#666; margin-top:2px;">PROTEIN</div>
                        </div>
                        <div style="flex:1; text-align:center; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px;">
                            <div style="font-size:1.2rem; font-weight:800; color:var(--gold)">${carbs}</div>
                            <div style="font-size:0.5rem; color:#666; margin-top:2px;">CARBS</div>
                        </div>
                        <div style="flex:1; text-align:center; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px;">
                            <div style="font-size:1.2rem; font-weight:800; color:var(--blue)">${fat}</div>
                            <div style="font-size:0.5rem; color:#666; margin-top:2px;">FAT</div>
                        </div>
                        <div style="flex:1; text-align:center; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px;">
                            <div style="font-size:1.2rem; font-weight:800; color:var(--purple)">${calories}</div>
                            <div style="font-size:0.5rem; color:#666; margin-top:2px;">CAL</div>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:8px;">
                        <button class="action-btn green" style="flex:1;" onclick="confirmAIMeal('${foods.join(' + ')}', ${protein}, ${carbs}, ${fat}, ${calories})">‚úì LOG MEAL</button>
                        <button class="action-btn" style="flex:1; background:rgba(255,255,255,0.1);" onclick="document.getElementById('photoInput').value=''; document.getElementById('photoPreview').style.display='none'">üì∏ RETAKE</button>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('AI Vision Error:', error);
            document.getElementById('photoPreview').innerHTML = `
                <img src="${imgData}" style="width:100%; border-radius:12px; margin-bottom:15px;">
                <div style="background:rgba(255,69,58,0.1); padding:15px; border-radius:12px; border:1px solid var(--red);">
                    <div style="font-size:0.65rem; color:var(--red); margin-bottom:5px; text-transform:uppercase;">‚ö†Ô∏è AI VISION ERROR</div>
                    <div style="font-size:0.75rem; color:#ddd; margin-bottom:15px;">
                        Could not analyze image. Please use quick log buttons below or try again.
                    </div>
                    <button class="action-btn" style="background:rgba(255,255,255,0.1);" onclick="document.getElementById('photoInput').value=''; document.getElementById('photoPreview').style.display='none'">CLOSE</button>
                </div>
            `;
        }
    };
    
    reader.readAsDataURL(file);
}

function confirmAIMeal(name, pro, carb, fat, cal) {
    const dk = getDateKey(selDate);
    const meal = { name, pro, carb, fat, cal, aiLogged: true };
    const dayLog = saveFoodLog(dk, meal);
    
    closeModal('mealModal');
    showNotification(`‚úì ${name} logged | Daily: ${dayLog.totalPro}g protein`);
    render();
}

function saveFoodLog(date, meal) {
    const log = JSON.parse(localStorage.getItem(`centurion_food_log_${user}`)) || {};
    if (!log[date]) log[date] = { meals: [], totalPro: 0, totalCarb: 0, totalFat: 0, totalCal: 0 };
    
    log[date].meals.push({ ...meal, time: Date.now() });
    log[date].totalPro += meal.pro;
    log[date].totalCarb += meal.carb;
    log[date].totalFat += meal.fat || 0;
    log[date].totalCal += meal.cal;
    
    localStorage.setItem(`centurion_food_log_${user}`, JSON.stringify(log));
    return log[date];
}

function getFoodLog(date) {
    const log = JSON.parse(localStorage.getItem(`centurion_food_log_${user}`)) || {};
    return log[date] || { meals: [], totalPro: 0, totalCarb: 0, totalFat: 0, totalCal: 0 };
}

// ==========================================
// UI FUNCTIONS
// ==========================================

function openMealLogger(mealType) {
    const macros = { protein: user === 'J' ? 165 : 100, carbs: user === 'J' ? 160 : 80, calories: user === 'J' ? 2200 : 1500 };
    
    let quickButtons = '';
    const mealOptions = mealType === 'breakfast' ? mealDB.b : mealType === 'lunch' ? mealDB.l : mealDB.d;
    
    if (mealOptions) {
        mealOptions.forEach(meal => {
            quickButtons += `
                <button class="action-btn" style="margin-bottom: 8px;" onclick="logQuickMeal('${meal.name}', ${meal.pro}, ${meal.carb}, ${meal.fat}, ${meal.cal})">
                    ${meal.name} <span style="opacity:0.6; font-size:0.65rem;">(${meal.pro}P ${meal.carb}C)</span>
                </button>
            `;
        });
    }
    
    document.getElementById('quickMealButtons').innerHTML = quickButtons;
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('photoInput').value = '';
    openModal('mealModal');
}

function logQuickMeal(name, pro, carb, fat, cal) {
    const dk = getDateKey(selDate);
    const meal = { name, pro, carb, fat, cal };
    const dayLog = saveFoodLog(dk, meal);
    
    closeModal('mealModal');
    showNotification(`‚úì ${name} | Daily: ${dayLog.totalPro}g protein`);
    render();
}

function openLabLogger() {
    const baseline = baselineData[user];
    const lastTest = baseline.lastLabTest;
    
    let html = `
        <div class="form-group">
            <label class="form-label">Test Date</label>
            <input type="date" id="labDateInput" class="form-input" value="${getDateKey(new Date())}">
        </div>
    `;
    
    Object.keys(labMetadata[user]).forEach(key => {
        const meta = labMetadata[user][key];
        const currentVal = lastTest[key] || baseline.goals[key];
        
        html += `
            <div class="form-group">
                <label class="form-label">${meta.name} <span style="opacity:0.6; font-weight:400;">(${meta.unit || 'units'})</span></label>
                <input type="number" step="0.1" id="lab_${key}" class="form-input" value="${currentVal}" placeholder="${baseline.goals[key]}">
            </div>
        `;
    });
    
    html += '<button class="action-btn green" onclick="saveLabsFromForm()">‚úì SAVE TEST RESULTS</button>';
    document.getElementById('labModalBody').innerHTML = html;
    openModal('labModal');
}

function saveLabsFromForm() {
    const date = document.getElementById('labDateInput').value;
    const results = {};
    
    Object.keys(labMetadata[user]).forEach(key => {
        const input = document.getElementById('lab_' + key);
        if (input && input.value) {
            results[key] = parseFloat(input.value);
        }
    });
    
    saveLabTest(user, date, results);
    closeModal('labModal');
    render();
}

// ==========================================
// INTELLIGENCE FUNCTIONS
// ==========================================

function predictBurnout(ouraHistory) {
    if (!ouraHistory || ouraHistory.length < 7) return { risk: "LOW", action: "GATHERING DATA", days: 7, trend: "0", avgScore: "-" };
    const last7 = ouraHistory.slice(0, 7);
    const scores = last7.map(d => parseInt(d.score) || 0);
    const trend = (scores[0] - scores[6]) / 6;
    const currentScore = scores[0];
    const avgScore = scores.reduce((a, b) => a + b, 0) / 7;
    const highIntensityDays = last7.filter(d => d.high > 20).length;
    
    let riskScore = 0;
    if (trend < -2) riskScore += 3;
    if (currentScore < 70) riskScore += 2;
    if (avgScore < 75) riskScore += 1;
    if (highIntensityDays >= 4) riskScore += 2;
    
    let risk, action, daysToRest;
    if (riskScore >= 5) { risk = "CRITICAL"; action = "FORCE REST TODAY"; daysToRest = 0; }
    else if (riskScore >= 3) { risk = "HIGH"; action = "REST WITHIN 48H"; daysToRest = 2; }
    else if (riskScore >= 1) { risk = "MODERATE"; action = "MONITOR CLOSELY"; daysToRest = 4; }
    else { risk = "LOW"; action = "CONTINUE PROTOCOL"; daysToRest = 7; }
    
    return { risk, action, daysToRest, trend: trend.toFixed(1), avgScore: avgScore.toFixed(0) };
}

function adaptSchedule(dayData, burnoutPrediction, currentScore) {
    if (burnoutPrediction.risk === "CRITICAL" || currentScore < 65) {
        return { 
            focus: "MANDATORY REST", 
            tasks: "NO TRAINING. Active recovery walk only. Sleep priority.", 
            zT: { h: 0, m: 0 }, 
            override: true, 
            reason: burnoutPrediction.action
        };
    }
    if (burnoutPrediction.risk === "HIGH" && (dayData.focus.includes("BOXING") || dayData.focus.includes("LIFT"))) {
        return { 
            focus: dayData.focus + " (MODIFIED)", 
            tasks: "Reduce volume 40%. No max efforts. Focus technique.", 
            zT: { h: Math.round(dayData.zT.h * 0.5), m: dayData.zT.m }, 
            override: true, 
            reason: "Recovery prioritized"
        };
    }
    return { ...dayData, override: false };
}

function calculateRecoveryIndex(ouraHistory, currentScore) {
    if (!ouraHistory || ouraHistory.length < 3) return { score: currentScore, trend: "SYNC", advice: "Gathering data...", weekAvg: "-" };
    const last3 = ouraHistory.slice(0, 3);
    const avgScore = last3.reduce((sum, d) => sum + (parseInt(d.score) || 0), 0) / 3;
    const trend = currentScore > avgScore ? "IMPROVING" : currentScore < avgScore - 5 ? "DECLINING" : "STABLE";
    let advice = "";
    if (currentScore >= 85) advice = "Peak performance window. Execute high-intensity protocol.";
    else if (currentScore >= 75) advice = "Ready for planned training intensity.";
    else if (currentScore >= 65) advice = "Reduce volume 20%. Maintain intensity.";
    else advice = "REST PROTOCOL: Active recovery only. Prioritize sleep.";
    return { score: currentScore, trend, advice, weekAvg: avgScore.toFixed(0) };
}

function getZoneCompliance(actual, target) {
    if (!target || target === 0) return { pct: 0, status: "NONE", color: "#666" };
    const pct = Math.round((actual / target) * 100);
    if (pct >= 90) return { pct, status: "PERFECT", color: "var(--green)" };
    if (pct >= 70) return { pct, status: "GOOD", color: "var(--gold)" };
    if (pct >= 50) return { pct, status: "PARTIAL", color: "#FF9800" };
    return { pct, status: "MISSED", color: "var(--red)" };
}

function getWeeklySummary(history) {
    if (!history || history.length < 7) return null;
    const week = history.slice(0, 7);
    const avgReady = Math.round(week.reduce((s, d) => s + (parseInt(d.score) || 0), 0) / 7);
    const totalCal = week.reduce((s, d) => s + (parseInt(d.cal) || 0), 0);
    const totalHigh = week.reduce((s, d) => s + d.high, 0);
    const avgSleep = Math.round(week.reduce((s, d) => s + (d.totalSleep || 0), 0) / 7);
    const perfectDays = week.filter(d => parseInt(d.score) >= 85).length;
    return { avgReady, totalCal, totalHigh, avgSleep, perfectDays, consistency: Math.round((perfectDays / 7) * 100) };
}

// ==========================================
// RENDER ENGINE
// ==========================================

function render() {
    const mon = getMon(offset); 
    const tabs = document.getElementById('dayTabs'); 
    tabs.innerHTML = '';
    
    document.getElementById('dateDisplay').innerText = `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${new Date(mon.getTime() + 864e5*6).toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
    
    const labReminder = checkLabReminder(user);
    if (labReminder) {
        document.getElementById('labReminder').innerHTML = labReminder;
        document.getElementById('labReminder').style.display = 'block';
    } else {
        document.getElementById('labReminder').style.display = 'none';
    }
    
    for(let i=0; i<7; i++){
        let d = new Date(mon); 
        d.setDate(mon.getDate()+i);
        let active = getDateKey(d) === getDateKey(selDate);
        let t = document.createElement('div'); 
        t.className = 'tab' + (active ? ' active' : '');
        t.innerHTML = `${["M","T","W","T","F","S","S"][i]}<br>${d.getDate()}`;
        t.onclick = () => { selDate = d; render(); }; 
        tabs.appendChild(t);
        if(active) showDay(d, i+1 === 7 ? 0 : i+1);
    }
}

function showDay(dObj, idx) {
    const dk = getDateKey(dObj); 
    const basePlan = unifiedSchedule[idx] || unifiedSchedule[1]; 
    const cached = JSON.parse(localStorage.getItem(`centurion_oura_cache_${user}`)) || { history: [] };
    const rawOura = cached.history.find(d => d.date === dk) || { score: "-", cal: "-", high: 0, med: 0, rhr: "-", totalSleep: 0, deepSleep: 0, remSleep: 0 };
    const hasData = rawOura.score !== "-";
    
    const burnout = predictBurnout(cached.history);
    const dayData = adaptSchedule(basePlan, burnout, parseInt(rawOura.score) || 0);
    const recovery = calculateRecoveryIndex(cached.history, parseInt(rawOura.score) || 0);
    
    // GET PREDICTIONS FOR THIS DATE
    const bodyPred = predictBodyCompositionForDate(user, dk);
    const foodLog = getFoodLog(dk);
    
    // BURNOUT ALERT
    const burnoutAlert = burnout.risk !== "LOW" ? `
    <div class="premium-card" style="background:linear-gradient(135deg, rgba(255,69,58,0.2), rgba(191,90,242,0.15)); border:1px solid ${burnout.risk==='CRITICAL'?'var(--red)':'var(--gold)'}; margin-bottom:12px; padding:15px;">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="font-size:2rem;">${burnout.risk === 'CRITICAL' ? 'üö®' : '‚ö†Ô∏è'}</div>
            <div style="flex:1;">
                <div style="font-size:0.7rem; font-weight:800; color:${burnout.risk==='CRITICAL'?'var(--red)':'var(--gold)'}; text-transform:uppercase; letter-spacing:1px; margin-bottom:3px;">${burnout.risk} FATIGUE RISK</div>
                <div style="font-size:0.75rem; color:#fff; line-height:1.4;">${burnout.action} ‚Ä¢ 7-day trend: ${burnout.trend}/day</div>
            </div>
        </div>
        ${dayData.override ? `<div style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px; font-size:0.7rem; color:var(--gold);">üìã AUTO-ADJUSTED: ${dayData.reason}</div>` : ''}
    </div>` : "";
    
    // WEEKLY SUMMARY
    const weekSum = getWeeklySummary(cached.history);
    const summaryHTML = weekSum ? `
    <div class="premium-card" style="background:linear-gradient(135deg, rgba(10,132,255,0.15), rgba(191,90,242,0.1)); border-color:rgba(10,132,255,0.3); margin-bottom:12px;">
        <div style="display:flex; justify-content:space-around; text-align:center;">
            <div><div style="font-size:1.4rem; font-weight:900; color:#fff">${weekSum.avgReady}</div><div style="font-size:0.55rem; color:#888; margin-top:2px;">AVG READY</div></div>
            <div><div style="font-size:1.4rem; font-weight:900; color:var(--green)">${weekSum.perfectDays}/7</div><div style="font-size:0.55rem; color:#888; margin-top:2px;">PERFECT</div></div>
            <div><div style="font-size:1.4rem; font-weight:900; color:var(--red)">${weekSum.totalHigh}m</div><div style="font-size:0.55rem; color:#888; margin-top:2px;">HIGH HR</div></div>
            <div><div style="font-size:1.4rem; font-weight:900; color:var(--blue)">${weekSum.avgSleep}m</div><div style="font-size:0.55rem; color:#888; margin-top:2px;">AVG SLEEP</div></div>
        </div>
    </div>` : "";
    
    // DAILY PREDICTIONS CARD
    const predictionsHTML = `
    <div class="premium-card" style="background:linear-gradient(135deg, rgba(191,90,242,0.15), rgba(10,132,255,0.1)); border-color:rgba(191,90,242,0.3); margin-bottom:12px;">
        <div style="margin-bottom:15px;">
            <div class="card-title" style="color:var(--purple)">üìä TODAY'S PROJECTIONS</div>
            <div class="card-subtitle">AI predictions ‚Ä¢ ${bodyPred.confidence} confidence ‚Ä¢ Last scan ${bodyPred.daysSinceLastScan}d ago</div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; text-align:center;">
                <div style="font-size:1.2rem; font-weight:800; color:#fff">${bodyPred.bf}%</div>
                <div style="font-size:0.5rem; color:#888; margin-top:2px;">BODY FAT</div>
                <div style="font-size:0.55rem; color:var(--purple); margin-top:3px;">‚Üí ${baselineData[user].goals.bf}%</div>
            </div>
            <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; text-align:center;">
                <div style="font-size:1.2rem; font-weight:800; color:#fff">${bodyPred.muscle}lb</div>
                <div style="font-size:0.5rem; color:#888; margin-top:2px;">MUSCLE</div>
                <div style="font-size:0.55rem; color:var(--purple); margin-top:3px;">‚Üí ${baselineData[user].goals.muscle}lb</div>
            </div>
            <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; text-align:center;">
                <div style="font-size:1.2rem; font-weight:800; color:#fff">${bodyPred.vf}</div>
                <div style="font-size:0.5rem; color:#888; margin-top:2px;">VISC FAT</div>
                <div style="font-size:0.55rem; color:var(--purple); margin-top:3px;">‚Üí ${baselineData[user].goals.vf}</div>
            </div>
        </div>
        <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:2px solid var(--purple);">
            <div style="font-size:0.6rem; color:var(--purple); margin-bottom:3px; text-transform:uppercase;">üìà TREND</div>
            <div style="font-size:0.75rem; color:#ddd;">
                ${bodyPred.bf < baselineData[user].lastBodyScan.bf ? `‚Üì ${(baselineData[user].lastBodyScan.bf - bodyPred.bf).toFixed(1)}% body fat lost` : 'Maintaining current composition'}
            </div>
        </div>
    </div>`;
    
    // PROTOCOL CARD
    const protocolHTML = `
    <div class="premium-card ${isPlanCollapsed?'collapsed':''}" onclick="isPlanCollapsed=!isPlanCollapsed;render()">
        <div class="card-header">
            <div>
                <div class="card-title" style="color:${recovery.trend==='IMPROVING'?'var(--green)':recovery.trend==='DECLINING'?'var(--red)':'var(--gold)'}">DAILY PROTOCOL</div>
                <div class="card-subtitle">${dayData.focus} ‚Ä¢ ${recovery.trend}</div>
            </div>
            <div class="card-val-lg">${recovery.score} <span style="font-size:0.7rem; opacity:0.6">/ ${recovery.weekAvg}avg</span> <span class="chevron">‚ñº</span></div>
        </div>
        <div class="card-body">
            <div style="padding:12px; background:rgba(255,255,255,0.04); border-radius:12px; margin-bottom:12px; border-left:3px solid ${recovery.score >= 75 ?'var(--green)':'var(--red)'}">
                <div style="font-size:0.65rem; color:#888; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px;">AI COACH</div>
                <div style="font-size:0.8rem; color:#fff; line-height:1.5;">${recovery.advice}</div>
            </div>
            <div style="font-size:0.8rem; color:#ddd; line-height:1.5; margin-bottom:10px;">${dayData.tasks}</div>
        </div>
    </div>`;
    
    // WORKOUT CARD
    const highComp = getZoneCompliance(rawOura.high, dayData.zT.h);
    const medComp = getZoneCompliance(rawOura.med, dayData.zT.m);
    const totalComp = Math.round((highComp.pct + medComp.pct) / 2);
    
    const workoutHTML = `
    <div class="premium-card ${isWorkoutCollapsed?'collapsed':''}" onclick="isWorkoutCollapsed=!isWorkoutCollapsed;render()">
        <div class="card-header">
            <div>
                <div class="card-title" style="color:var(--red)">TRAINING</div>
                <div class="card-subtitle">COMPLIANCE: ${totalComp}%</div>
            </div>
            <div class="card-val-lg">${rawOura.cal} <span style="font-size:0.9rem; opacity:0.7">CAL</span> <span class="chevron">‚ñº</span></div>
        </div>
        <div class="card-body">
            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <div style="flex:1; padding:10px; background:rgba(255,255,255,0.03); border-radius:12px; text-align:center; border:1px solid ${highComp.color}">
                    <div style="font-size:0.55rem; color:#888; margin-bottom:3px;">HIGH</div>
                    <div style="font-size:1.2rem; font-weight:800; color:${highComp.color}">${highComp.pct}%</div>
                    <div style="font-size:0.5rem; color:#666; margin-top:2px;">${highComp.status}</div>
                </div>
                <div style="flex:1; padding:10px; background:rgba(255,255,255,0.03); border-radius:12px; text-align:center; border:1px solid ${medComp.color}">
                    <div style="font-size:0.55rem; color:#888; margin-bottom:3px;">MED</div>
                    <div style="font-size:1.2rem; font-weight:800; color:${medComp.color}">${medComp.pct}%</div>
                    <div style="font-size:0.5rem; color:#666; margin-top:2px;">${medComp.status}</div>
                </div>
            </div>
            ${bioBar("High Intensity (Z4-Z5)", rawOura.high, dayData.zT.h, "m")}
            ${bioBar("Zone 2 Volume (Z3)", rawOura.med, dayData.zT.m, "m")}
        </div>
    </div>`;
    
    // NUTRITION CARD with meal logging
    const nutHTML = `
    <div class="premium-card ${isNutCollapsed?'collapsed':''}" onclick="event.stopPropagation(); isNutCollapsed=!isNutCollapsed;render()">
        <div class="card-header">
            <div>
                <div class="card-title" style="color:var(--green)">NUTRITION</div>
                <div class="card-subtitle">${foodLog.meals.length} meals logged</div>
            </div>
            <div class="card-val-lg">${foodLog.totalPro || 0}g <span style="font-size:0.9rem; opacity:0.7">PRO</span> <span class="chevron">‚ñº</span></div>
        </div>
        <div class="card-body">
            ${foodLog.meals.length > 0 ? `
                <div style="padding:12px; background:rgba(48,209,88,0.1); border-left:3px solid var(--green); border-radius:8px; margin-bottom:15px;">
                    <div style="font-size:0.65rem; color:var(--green); margin-bottom:8px; text-transform:uppercase; font-weight:800;">‚úì LOGGED TODAY</div>
                    ${foodLog.meals.map(m => `
                        <div style="font-size:0.7rem; color:#ddd; margin-bottom:4px; display:flex; justify-content:space-between;">
                            <span>${m.name}${m.aiLogged ? ' ü§ñ' : ''}</span>
                            <span style="color:#888;">${m.pro}P ${m.carb}C</span>
                        </div>
                    `).join('')}
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1);">
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1; text-align:center;">
                                <div style="font-size:1rem; font-weight:800; color:#fff">${foodLog.totalPro}g</div>
                                <div style="font-size:0.5rem; color:#888; margin-top:2px;">PROTEIN</div>
                            </div>
                            <div style="flex:1; text-align:center;">
                                <div style="font-size:1rem; font-weight:800; color:#fff">${foodLog.totalCarb}g</div>
                                <div style="font-size:0.5rem; color:#888; margin-top:2px;">CARBS</div>
                            </div>
                            <div style="flex:1; text-align:center;">
                                <div style="font-size:1rem; font-weight:800; color:#fff">${foodLog.totalCal}</div>
                                <div style="font-size:0.5rem; color:#888; margin-top:2px;">CALORIES</div>
                            </div>
                        </div>
                    </div>
                </div>
            ` : `
                <div style="padding:20px; text-align:center; background:rgba(255,255,255,0.02); border-radius:12px; margin-bottom:15px;">
                    <div style="font-size:1.5rem; margin-bottom:8px; opacity:0.3;">üçΩÔ∏è</div>
                    <div style="font-size:0.7rem; color:#666;">No meals logged yet</div>
                </div>
            `}
            
            <button class="action-btn green" onclick="event.stopPropagation(); openMealLogger('custom')">üì∏ LOG MEAL WITH AI</button>
        </div>
    </div>`;
    
    // LAB PREDICTIONS CARD
    let labPredHTML = '<div class="section-header">PREDICTED LAB VALUES</div>';
    Object.keys(labMetadata[user]).forEach(key => {
        const pred = predictLabValueForDate(user, key, dk);
        if (pred) {
            const meta = labMetadata[user][key];
            labPredHTML += bioBar(meta.name, pred.value, baselineData[user].goals[key], " " + (meta.unit || ""), meta.lowerBetter, pred.isPrediction);
        }
    });
    
    const bioHTML = `
    <div class="premium-card ${isBioCollapsed?'collapsed':''}" onclick="isBioCollapsed=!isBioCollapsed;render()">
        <div class="card-header">
            <div>
                <div class="card-title" style="color:var(--purple)">BIOMETRICS</div>
                <div class="card-subtitle">AI-Predicted Values</div>
            </div>
            <div class="card-val-lg">${bodyPred.vf} <span style="font-size:0.9rem; opacity:0.7">VF</span> <span class="chevron">‚ñº</span></div>
        </div>
        <div class="card-body">
            ${labPredHTML}
            <button class="action-btn blue" onclick="event.stopPropagation(); openLabLogger()">ü©∏ LOG ACTUAL TEST RESULTS</button>
            <div style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.02); border-radius:8px; font-size:0.65rem; color:#666; text-align:center;">
                These are AI predictions. Log actual test results every 3 months to improve accuracy.
            </div>
        </div>
    </div>`;
    
    document.getElementById('dayContent').innerHTML = 
        burnoutAlert + 
        summaryHTML + 
        predictionsHTML +
        protocolHTML + 
        workoutHTML + 
        nutHTML + 
        bioHTML;
}

// ==========================================
// API INTEGRATION
// ==========================================

function switchU(uID) {
    localStorage.removeItem(`centurion_oura_cache_${uID}`);
    user = uID;
    localStorage.setItem('centurion_active_user', uID);
    document.getElementById('dayContent').innerHTML = `<div style="text-align:center; padding:50px; color:#444; font-size:0.7rem; letter-spacing:2px;">AUTHENTICATING...</div>`;
    document.getElementById('ouraBar').innerHTML = "üíç HANDSHAKE: " + (uID === 'J' ? 'JERMAINE' : 'SOPHIA');
    document.querySelectorAll('.u-badge').forEach(b => b.classList.toggle('active', b.id === 'b' + uID.toLowerCase()));
    
    fetchOuraData();
}

async function fetchOuraData() {
    const fetchID = user; 
    const token = TOKENS[fetchID];
    const range = `start_date=${getDateKey(new Date(Date.now()-864e5*14))}&end_date=${getDateKey(new Date())}`;
    
    document.getElementById('ouraBar').style.animation = 'pulse 1.5s infinite';
    
    try {
        const [rRes, aRes, sRes] = await Promise.all([
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${range}&t=${Date.now()}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?${range}&t=${Date.now()}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_sleep?${range}&t=${Date.now()}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);
        
        const rData = await rRes.json();
        const aData = await aRes.json();
        const sData = await sRes.json();
        
        if(user !== fetchID) return;
        
        if(rData.data) {
            const hist = rData.data.map(day => {
                const act = aData.data ? aData.data.find(ac => ac.day === day.day) : null;
                const sleep = sData.data ? sData.data.find(s => s.day === day.day) : null;
                
                return { 
                    date: day.day, 
                    score: day.score || "-", 
                    cal: act ? act.active_calories : "-", 
                    high: act ? Math.round(act.high_activity_time/60) : 0, 
                    med: act ? Math.round(act.medium_activity_time/60) : 0,
                    rhr: day.contributors?.resting_heart_rate || "-",
                    totalSleep: sleep ? sleep.total_sleep_duration : 0,
                    deepSleep: sleep ? sleep.deep_sleep_duration : 0,
                    remSleep: sleep ? sleep.rem_sleep_duration : 0
                };
            }).reverse();
            
            localStorage.setItem(`centurion_oura_cache_${fetchID}`, JSON.stringify({history: hist, lastFetch: Date.now()}));
            document.getElementById('ouraBar').style.animation = '';
            document.getElementById('ouraBar').innerHTML = `üíç ${fetchID === 'J' ? 'JERMAINE' : 'SOPHIA'} READY: <span style="color:${hist[0]?.score >= 75 ? 'var(--green)' : 'var(--red)'}; font-weight:900">${hist[0]?.score || "-"}</span>`;
            render();
        }
    } catch(e) { 
        document.getElementById('ouraBar').style.animation = '';
        if(user === fetchID) {
            document.getElementById('ouraBar').innerHTML = "üíç SYNC TIMEOUT";
            render();
        }
    }
}

function changeW(d) { offset += d; render(); }
function resetD() { offset = 0; selDate = getCaDate(); render(); }

// ==========================================
// INITIALIZE
// ==========================================

window.onload = () => { 
    loadBaselineData();
    switchU(user); 
};
</script>
</body>
</html>
