<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Centurion | v5.2</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #000000;
            --bg-panel: #0a0a0a;
            --border: #222;
            --acid: #ccff00;
            --cyan: #00f0ff;
            --gold: #FFD60A;
            --alert: #ff453a;
            --purple: #bf5af2;
            --text-main: #ffffff;
            --text-muted: #666;
            --font-ui: 'Inter', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
        }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0 0 100px 0; background: var(--bg-deep); color: var(--text-main); font-family: var(--font-ui); min-height: 100vh; background-image: radial-gradient(circle at top right, #111 0%, #000 70%); }

    .hud-header { padding: 15px 16px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .app-name { font-size: 0.6rem; font-weight: 900; letter-spacing: 2px; color: var(--text-muted); }
    .user-switch { display: flex; gap: 4px; background: #222; padding: 2px; border-radius: 20px; }
    .u-badge { padding: 6px 14px; border-radius: 16px; font-size: 0.6rem; font-weight: 700; color: #666; background: transparent; border: none; cursor: pointer; transition: all 0.2s; }
    .u-badge.active { background: var(--text-main); color: #000; }
    .bio-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: var(--text-muted); padding: 4px 8px; border-radius: 8px; font-size: 0.55rem; font-weight: 700; cursor: pointer; margin-right: 10px; }

    .date-nav { display: flex; justify-content: center; align-items: center; gap: 20px; font-family: var(--font-data); font-size: 0.8rem; font-weight: 700; color: #fff; padding-top: 5px; }
    .nav-btn { background: transparent; border: 1px solid var(--border); color: var(--gold); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.6rem; font-weight: 900; }
    .nav-btn.disabled { opacity: 0.3; cursor: default; }
    .date-display { min-width: 100px; text-align: center; letter-spacing: 1px; }

    .hero-section { padding: 25px 16px 10px; display: flex; align-items: center; justify-content: space-between; }
    .ring-container { width: 110px; height: 110px; position: relative; display: flex; align-items: center; justify-content: center; }
    .ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
    .ring-fg { fill: none; stroke: var(--acid); stroke-width: 6; stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s ease, stroke 0.5s ease; stroke-linecap: round; }
    .ring-data { position: absolute; text-align: center; }
    .ring-val { font-family: var(--font-data); font-size: 1.8rem; font-weight: 700; color: #fff; line-height: 1; }
    .ring-label { font-size: 0.5rem; font-weight: 700; color: var(--text-muted); margin-top: 2px; }

    .tactical-box { flex: 1; margin-left: 20px; background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, transparent 100%); border-left: 3px solid var(--acid); padding: 12px; border-radius: 0 12px 12px 0; border: 1px solid var(--border); border-left-width: 3px; }
    .tac-label { font-size: 0.55rem; color: var(--acid); font-weight: 900; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
    .tac-cmd { font-size: 0.8rem; font-weight: 700; color: #fff; line-height: 1.3; }
    .tac-meta { font-family: var(--font-data); font-size: 0.55rem; color: var(--text-muted); margin-top: 4px; }

    /* AI INSIGHT CARD */
    .ai-insight-card { 
        background: linear-gradient(135deg, rgba(0,240,255,0.08) 0%, rgba(191,90,242,0.08) 100%); 
        border: 1px solid rgba(0,240,255,0.3); 
        border-radius: 12px; 
        padding: 15px; 
        margin: 15px 16px; 
        position: relative;
        box-shadow: 0 0 20px rgba(0,240,255,0.1);
    }
    .ai-header { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        margin-bottom: 10px; 
        font-size: 0.65rem; 
        color: var(--cyan); 
        font-weight: 900; 
        letter-spacing: 1px;
    }
    .ai-content { 
        font-size: 0.75rem; 
        line-height: 1.5; 
        color: #ddd; 
    }
    .ai-content strong { 
        color: var(--acid); 
        font-weight: 900; 
    }
    .ai-refresh { 
        background: rgba(0,240,255,0.1); 
        border: 1px solid var(--cyan); 
        color: var(--cyan); 
        padding: 6px 12px; 
        border-radius: 6px; 
        font-size: 0.6rem; 
        font-weight: 700; 
        cursor: pointer; 
        margin-top: 10px;
        display: inline-block;
    }
    .ai-refresh:hover { 
        background: rgba(0,240,255,0.2); 
    }
    .ai-loading {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(0,240,255,0.3);
        border-top-color: var(--cyan);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .section-label { font-size: 0.7rem; font-weight: 900; color: #999; letter-spacing: 1px; margin: 20px 16px 10px; text-transform: uppercase; }
    .telemetry-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 10px; }
    .sleep-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 20px; }
    .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 0 16px; margin-bottom: 30px; }
    
    .orb-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    .orb-container { width: 60px; height: 60px; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
    .orb-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .orb-bg { fill: none; stroke: #222; stroke-width: 5; }
    .orb-fg { fill: none; stroke: var(--cyan); stroke-width: 5; stroke-dasharray: 158; stroke-dashoffset: 158; transition: stroke-dashoffset 1s ease; stroke-linecap: round; }
    .orb-val-box { position: absolute; text-align: center; }
    .orb-val { font-family: var(--font-data); font-size: 0.75rem; font-weight: 700; color: #fff; line-height: 1; }
    .orb-unit { font-size: 0.4rem; color: var(--text-muted); display: block; margin-top: 2px; }
    .orb-label { font-size: 0.6rem; font-weight: 700; color: #aaa; letter-spacing: 1px; text-transform: uppercase; }
    .live-dot { width: 5px; height: 5px; background: var(--alert); border-radius: 50%; position: absolute; top: 8px; right: 8px; box-shadow: 0 0 5px var(--alert); animation: pulse-fast 1s infinite; display: none; }
    .orb-card.live .live-dot { display: block; }

    .biomarker-panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin: 0 16px 20px; }
    .bio-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .bio-row:last-child { border-bottom: none; }
    .bio-name { font-size: 0.7rem; color: #aaa; }
    .bio-val { font-family: var(--font-data); font-size: 0.75rem; font-weight: 700; color: #fff; }
    .bio-status { font-size: 0.5rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .status-optimal { background: rgba(204,255,0,0.2); color: var(--acid); }
    .status-warning { background: rgba(255,159,10,0.2); color: var(--gold); }
    .status-alert { background: rgba(255,69,58,0.2); color: var(--alert); }

    .timeline-container { padding: 0 16px; }
    .time-slot { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
    .ts-time { width: 50px; font-family: var(--font-data); font-size: 0.75rem; color: var(--text-muted); text-align: right; padding-top: 5px; }
    .ts-card { flex: 1; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; position: relative; }
    .ts-title { font-size: 0.9rem; font-weight: 700; color: #fff; margin-bottom: 6px; }
    .ts-desc { font-size: 0.75rem; color: #aaa; line-height: 1.4; margin-bottom: 8px; }
    .ts-nutrients { font-size: 0.7rem; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; margin-top: 8px; }
    .nutrient-tag { display: inline-block; background: rgba(255,255,255,0.05); padding: 3px 8px; border-radius: 4px; margin: 2px; font-size: 0.65rem; }
    .ts-mech { font-family: var(--font-data); font-size: 0.6rem; color: var(--text-muted); padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 5px; margin-top: 8px; }
    .color-dots { display: flex; gap: 4px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
    .color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); }
    
    .check-btn { position: absolute; top: 15px; right: 15px; width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--border); background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-weight: 800; font-size: 0.7rem; }
    .ts-card.checked .check-btn { background: var(--acid); border-color: var(--acid); color: #000; }
    .ts-card.checked { opacity: 0.5; }

    .summary-card { background: linear-gradient(135deg, rgba(204, 255, 0, 0.05) 0%, rgba(0, 240, 255, 0.03) 100%); border: 2px solid var(--acid); box-shadow: 0 0 20px rgba(204, 255, 0, 0.1); }
    .summary-score { font-family: var(--font-data); font-size: 3rem; font-weight: 900; line-height: 1; margin: 10px 0; background: linear-gradient(135deg, var(--acid) 0%, var(--cyan) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .summary-grade { display: inline-block; padding: 4px 12px; border-radius: 6px; font-weight: 900; font-size: 0.7rem; margin-left: 10px; }
    .grade-s { background: var(--acid); color: #000; } .grade-a { border: 1px solid var(--cyan); color: var(--cyan); } .grade-b { border: 1px solid var(--gold); color: var(--gold); } .grade-c { border: 1px solid var(--alert); color: var(--alert); }

    .bio-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; padding: 20px; overflow-y: auto; }
    .bio-modal.active { display: block; }
    .bio-content { background: var(--bg-panel); border: 1px solid var(--acid); border-radius: 16px; padding: 20px; max-width: 500px; margin: 20px auto; }
    .bio-field { margin-bottom: 15px; }
    .bio-field label { display: block; font-size: 0.7rem; color: #aaa; margin-bottom: 5px; font-weight: 600; }
    .bio-field input { width: 100%; max-width: 100%; background: #111; border: 1px solid var(--border); padding: 12px; color: #fff; font-family: var(--font-data); border-radius: 8px; font-size: 0.9rem; box-sizing: border-box; }
    .bio-save { width: 100%; padding: 15px; background: var(--acid); color: #000; font-weight: 900; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.85rem; }

    .sync-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-family: var(--font-data); font-size: 0.6rem; color: #555; z-index: 200; }
    .pulse { animation: pulse 2s infinite; display: inline-block; width: 6px; height: 6px; background: var(--acid); border-radius: 50%; margin-right: 6px; }
    
    .science-term { position: relative; color: var(--cyan); cursor: help; border-bottom: 1px dotted var(--cyan); }
    .tooltip { display: none; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: #1a1a1a; border: 1px solid var(--cyan); border-radius: 8px; padding: 12px; width: 280px; font-size: 0.7rem; line-height: 1.4; color: #ddd; z-index: 1000; box-shadow: 0 4px 20px rgba(0,240,255,0.3); }
    .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--cyan) transparent transparent transparent; }
    .science-term:hover .tooltip { display: block; }
    .tooltip-title { color: var(--cyan); font-weight: 900; font-size: 0.65rem; margin-bottom: 4px; text-transform: uppercase; }
    .tooltip-benefit { color: var(--acid); font-size: 0.65rem; margin-top: 6px; font-weight: 700; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes pulse-fast { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    @keyframes spin { to { transform: rotate(360deg); } }

    .expand-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 16px; border-radius: 8px; font-size: 0.65rem; font-weight: 700; cursor: pointer; margin: 0 16px 15px; width: calc(100% - 32px); text-align: center; }
    .expandable { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .expandable.open { max-height: 2000px; }
</style>

</head>
<body>

<svg style="width:0; height:0; position:absolute;" aria-hidden="true" focusable="false">
  <defs>
    <linearGradient id="grad-zone2" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#00f0ff;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#0080ff;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-zone5" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ff453a;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ff9f0a;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-purple" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#bf5af2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#9d4edd;stop-opacity:1" />
    </linearGradient>
  </defs>
</svg>

<div class="hud-header">
    <div class="top-bar">
        <div class="app-name">THE CENTURION v5.2</div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="bio-btn" onclick="centurion.openBio()">BIOMARKERS</button>
            <div class="user-switch">
                <button id="btn-J" class="u-badge active" onclick="centurion.switchUser('J')">JER</button>
                <button id="btn-S" class="u-badge" onclick="centurion.switchUser('S')">SOPH</button>
            </div>
        </div>
    </div>
    <div class="date-nav">
        <button id="btn-prev" class="nav-btn" onclick="centurion.changeDate(-1)">‚óÄ</button>
        <span class="date-display" id="dateDisplay">TODAY</span>
        <button id="btn-next" class="nav-btn disabled" onclick="centurion.changeDate(1)">‚ñ∂</button>
    </div>
</div>

<div id="dayContent"></div>

<div class="sync-footer">
    <div><span class="pulse"></span><span id="ouraBar">INIT...</span></div>
    <div onclick="centurion.fetchOuraData()" style="cursor:pointer">FORCE SYNC</div>
</div>

<div id="bioModal" class="bio-modal">
    <div class="bio-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--acid);">
            <span style="color:var(--acid);font-weight:900;font-size:0.9rem;letter-spacing:1px;">BIOMARKER PANEL</span>
            <span onclick="centurion.closeBio()" style="color:#fff;cursor:pointer;font-size:1.5rem;font-weight:300;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border:1px solid #666;border-radius:50%;">‚úï</span>
        </div>

    <div style="font-size:0.75rem;color:var(--acid);margin-bottom:10px;font-weight:900;letter-spacing:1px;">METABOLIC HEALTH</div>
    <div class="bio-field"><label>HbA1c (%)</label><input id="in-hba1c" type="number" step="0.1" placeholder="e.g. 5.2"></div>
    <div class="bio-field"><label>Fasting Glucose (mg/dL)</label><input id="in-glucose" type="number" placeholder="e.g. 85"></div>
    <div class="bio-field"><label>Fasting Insulin (ŒºIU/mL)</label><input id="in-insulin" type="number" step="0.1" placeholder="e.g. 3.5"></div>
    
    <div style="font-size:0.75rem;color:var(--acid);margin:20px 0 10px;font-weight:900;letter-spacing:1px;">CARDIOVASCULAR HEALTH</div>
    <div class="bio-field"><label>ApoB (mg/dL)</label><input id="in-apob" type="number" placeholder="e.g. 60"></div>
    <div class="bio-field"><label>Lp(a) (nmol/L)</label><input id="in-lpa" type="number" placeholder="e.g. 25"></div>
    <div class="bio-field"><label>hsCRP (mg/L)</label><input id="in-hscrp" type="number" step="0.1" placeholder="e.g. 0.5"></div>
    
    <div style="font-size:0.75rem;color:var(--acid);margin:20px 0 10px;font-weight:900;letter-spacing:1px;">LONGEVITY MARKERS</div>
    <div class="bio-field"><label>VO2 Max (mL/kg/min)</label><input id="in-vo2" type="number" placeholder="e.g. 55"></div>
    <div class="bio-field"><label>Testosterone (ng/dL)</label><input id="in-test" type="number" placeholder="e.g. 650"></div>
    <div class="bio-field"><label>IGF-1 (ng/mL)</label><input id="in-igf1" type="number" placeholder="e.g. 180"></div>
    <div class="bio-field"><label>Vitamin D (ng/mL)</label><input id="in-vitd" type="number" placeholder="e.g. 50"></div>
    
    <button class="bio-save" onclick="centurion.saveBio()">SAVE BIOMARKERS</button>
</div>
</div>

<script>
// ‚ö†Ô∏è REPLACE THIS WITH YOUR ACTUAL GOOGLE GEMINI API KEY
const GEMINI_API_KEY = "AIzaSyCHZvxl_YvhDxZQFuZ1RuriCFasaKSDero"; // Replace this with the key starting with AIza...

const TOKENS = { 'J': 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', 'S': '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };

const USERS = {
    'J': { 
        name: "Jermaine", 
        age: 42,
        rhr: 48, 
        goals: { cal: 700, z2: 60, z5: 20, pro: 180, carb: 200, fat: 80, fib: 40, sleep: 8, omega3: 3000, polyphenols: 500 }
    },
    'S': { 
        name: "Sophia", 
        age: 38,
        rhr: 58, 
        goals: { cal: 450, z2: 45, z5: 15, pro: 120, carb: 150, fat: 60, fib: 35, sleep: 8.5, omega3: 2500, polyphenols: 400 }
    }
};

const COLOR_MAP = {
    red: { color: '#ff453a', name: 'Red', compound: 'Lycopene' },
    orange: { color: '#ff9f0a', name: 'Orange', compound: 'Œ≤-Carotene' },
    yellow: { color: '#ffd60a', name: 'Yellow', compound: 'Curcumin' },
    green: { color: '#30d158', name: 'Green', compound: 'Sulforaphane' },
    purple: { color: '#bf5af2', name: 'Purple', compound: 'Anthocyanins' },
    white: { color: '#ffffff', name: 'White', compound: 'Allicin' }
};

const MEAL_DB = {
    'J': {
        breakfast: {
            name: "Centurion Omega Bowl",
            time: "7:30",
            desc: "Wild Alaskan Salmon (6oz), Pasture Eggs (3), Spinach (2c), Blueberries (1c), Walnuts (1oz), EVOO (1tbsp)",
            macros: { p: 60, c: 25, f: 35, fib: 8 },
            compounds: { omega3: 2400, polyphenols: 180, choline: 450, vitK: 500, vitD: 600, magnesium: 120 },
            colors: ['red', 'purple', 'green', 'white'],
            micronutrients: "Vitamin D (600 IU), Magnesium (120mg), Choline (450mg), Vitamin K2"
        },
        juice: {
            name: "Beet Nitric Stack",
            time: "8:00",
            desc: "Beet juice (8oz), Pomegranate (4oz), Ginger root, Lemon, Turmeric + Black Pepper",
            macros: { p: 2, c: 28, f: 0, fib: 2 },
            compounds: { omega3: 0, polyphenols: 200, nitrates: 400, curcumin: 50 },
            colors: ['red', 'purple', 'yellow'],
            micronutrients: "Nitric Oxide (400mg), Curcumin (50mg + piperine)"
        },
        lunch: {
            name: "Sardine Longevity Bowl",
            time: "13:00",
            desc: "Wild Sardines (2 cans), Quinoa (1c), Mixed Greens (3c), Cherry Tomatoes, Red Onion, Turmeric Dressing",
            macros: { p: 45, c: 35, f: 20, fib: 10 },
            compounds: { omega3: 2000, polyphenols: 150, vitD: 800, calcium: 350, selenium: 45 },
            colors: ['green', 'red', 'white', 'yellow'],
            micronutrients: "Vitamin D (800 IU), Selenium (45mcg), Calcium (350mg), B12 (8mcg)"
        },
        snack: {
            name: "Brazil Nut Power Bowl",
            time: "16:00",
            desc: "Greek Yogurt (1c), Mixed Berries (1c), Brazil Nuts (3), Dark Chocolate 85% (1oz), Pumpkin Seeds",
            macros: { p: 20, c: 28, f: 15, fib: 8 },
            compounds: { omega3: 100, polyphenols: 300, probiotics: true, selenium: 200, magnesium: 80, zinc: 5 },
            colors: ['purple', 'red'],
            micronutrients: "Selenium (200mcg - entire daily need!), Probiotics (50B CFU), Zinc (5mg)"
        },
        dinner: {
            name: "Wild Salmon Centurion",
            time: "19:00",
            desc: "Wild Salmon (8oz), Sweet Potato (1 med), Broccoli (2c), Brussels Sprouts (1c), Garlic (3 cloves), EVOO (2tbsp)",
            macros: { p: 55, c: 40, f: 25, fib: 12 },
            compounds: { omega3: 3200, polyphenols: 180, sulforaphane: 50, vitD: 1000, vitK: 200, magnesium: 100 },
            colors: ['red', 'orange', 'green', 'white'],
            micronutrients: "Vitamin D (1000 IU), Sulforaphane (50mg), Vitamin K (200mcg), Magnesium (100mg)"
        }
    },
    'S': {
        breakfast: {
            name: "Omega Vitality Scramble",
            time: "7:30",
            desc: "Pasture Eggs (3), Wild Salmon (4oz), Kale (1c), Avocado (1/2), Berries (1/2c), Chia seeds (1tbsp)",
            macros: { p: 45, c: 18, f: 28, fib: 10 },
            compounds: { omega3: 2200, polyphenols: 120, choline: 400, vitD: 500, vitK: 400, magnesium: 100 },
            colors: ['green', 'purple', 'red'],
            micronutrients: "Omega-3 (2200mg), Vitamin D (500 IU), Choline (400mg), Magnesium (100mg)"
        },
        juice: {
            name: "Orange Immune Elixir",
            time: "8:00",
            desc: "Orange juice (8oz), Carrot (1 large), Turmeric root, Ginger, Black Pepper, Spirulina (1tsp)",
            macros: { p: 3, c: 25, f: 0, fib: 3 },
            compounds: { omega3: 50, polyphenols: 150, vitC: 200, betacarotene: 8000, iron: 4 },
            colors: ['orange', 'yellow', 'green'],
            micronutrients: "Vitamin C (200mg), Beta-Carotene (8000 IU), Spirulina Iron (4mg)"
        },
        lunch: {
            name: "White Fish Ceviche",
            time: "13:00",
            desc: "Wild Cod (6oz), Lime, Cilantro, Red Onion, Tomato, Avocado, Mixed Greens, Pumpkin seeds",
            macros: { p: 38, c: 22, f: 14, fib: 9 },
            compounds: { omega3: 800, polyphenols: 100, vitC: 150, vitE: 5, zinc: 4, magnesium: 70 },
            colors: ['white', 'green', 'red'],
            micronutrients: "Vitamin C (150mg), Zinc (4mg), Magnesium (70mg), Vitamin E (5mg)"
        },
        snack: {
            name: "Kefir Probiotic Bowl",
            time: "16:00",
            desc: "Kefir (1c), Blueberries (1/2c), Walnuts (1/2oz), Chia seeds (1tbsp), Hemp hearts (1tbsp)",
            macros: { p: 18, c: 20, f: 12, fib: 8 },
            compounds: { omega3: 1200, polyphenols: 180, probiotics: true, calcium: 300, magnesium: 90 },
            colors: ['purple', 'white'],
            micronutrients: "Probiotics (100B CFU), Omega-3 (1200mg ALA), Calcium (300mg)"
        },
        dinner: {
            name: "Cod + White Bean Medley",
            time: "19:00",
            desc: "Wild Cod (6oz), White Beans (1c), Spinach (2c), Cherry Tomatoes, Garlic (3 cloves), Lemon, EVOO",
            macros: { p: 42, c: 35, f: 10, fib: 14 },
            compounds: { omega3: 600, polyphenols: 140, fiber: 14, folate: 250, iron: 5, calcium: 150 },
            colors: ['white', 'green', 'red'],
            micronutrients: "Folate (250mcg), Iron (5mg), Calcium (150mg), Fiber (14g)"
        }
    }
};

const WORKOUTS = {
    'anabolic_j': { title: "Heavy Compounds", sub: "Hypertrophy A", mech: "Deadlifts 5x5, mTOR activation", postWorkout: "Creatine 5g + Protein" },
    'repair_j': { title: "Zone 2 Flush", sub: "Active Recovery", mech: "Ruck 45m @ 35lbs, Mitochondrial biogenesis", postWorkout: "Creatine 5g" },
    'anabolic_s': { title: "Glute/Core", sub: "Strength", mech: "Hip Thrusts 4x10, Progressive overload", postWorkout: "Protein" },
    'repair_s': { title: "Yoga Flow", sub: "Parasympathetic", mech: "Vinyasa 45m, HRV optimization", postWorkout: "Hydration" }
};

function getCaDate() { let d = new Date(); d.setHours(12, 0, 0, 0); return d; }
function getDateKey(d) { return d.toISOString().split('T')[0]; }

class CenturionCore {
    constructor() {
        this.user = localStorage.getItem('centurion_active_user') || 'J';
        this.dayOffset = 0;
        this.cache = JSON.parse(localStorage.getItem(`centurion_oura_cache_${this.user}`)) || { history: [] };
        this.checkedItems = JSON.parse(localStorage.getItem(`centurion_checked_${this.user}`)) || {};
        this.bios = JSON.parse(localStorage.getItem(`centurion_bios_${this.user}`)) || {};
        this.aiInsights = JSON.parse(localStorage.getItem(`centurion_ai_insights_${this.user}`)) || {};
        this.init();
    }

    init() {
        this.updateUI(); 
        this.render();   
        this.fetchOuraData(); 
    }

    switchUser(uID) {
        if(this.user === uID) return;
        this.user = uID;
        localStorage.setItem('centurion_active_user', uID);
        
        this.cache = JSON.parse(localStorage.getItem(`centurion_oura_cache_${uID}`)) || { history: [] };
        this.checkedItems = JSON.parse(localStorage.getItem(`centurion_checked_${uID}`)) || {};
        this.bios = JSON.parse(localStorage.getItem(`centurion_bios_${uID}`)) || {};
        this.aiInsights = JSON.parse(localStorage.getItem(`centurion_ai_insights_${uID}`)) || {};
        
        this.dayOffset = 0;
        this.updateUI();
        this.render(); 
        this.fetchOuraData();
    }

    changeDate(d) {
        this.dayOffset += d;
        if(this.dayOffset > 0) this.dayOffset = 0;
        this.render();
    }

    toggleItem(id) {
        const dk = getDateKey(this.getCurrentDate());
        if(!this.checkedItems[dk]) this.checkedItems[dk] = [];
        const idx = this.checkedItems[dk].indexOf(id);
        if(idx > -1) this.checkedItems[dk].splice(idx, 1);
        else this.checkedItems[dk].push(id);
        localStorage.setItem(`centurion_checked_${this.user}`, JSON.stringify(this.checkedItems));
        this.render();
    }

    getCurrentDate() {
        const d = getCaDate();
        d.setDate(d.getDate() + this.dayOffset);
        return d;
    }

    updateUI() {
        document.querySelectorAll('.u-badge').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${this.user}`).classList.add('active');
        document.getElementById('ouraBar').innerHTML = `üíç SWITCHING...`;
    }

    openBio() {
        document.getElementById('bioModal').classList.add('active');
        document.getElementById('in-hba1c').value = this.bios.hba1c || "";
        document.getElementById('in-glucose').value = this.bios.glucose || "";
        document.getElementById('in-insulin').value = this.bios.insulin || "";
        document.getElementById('in-apob').value = this.bios.apob || "";
        document.getElementById('in-lpa').value = this.bios.lpa || "";
        document.getElementById('in-hscrp').value = this.bios.hscrp || "";
        document.getElementById('in-vo2').value = this.bios.vo2 || "";
        document.getElementById('in-test').value = this.bios.test || "";
        document.getElementById('in-igf1').value = this.bios.igf1 || "";
        document.getElementById('in-vitd').value = this.bios.vitd || "";
    }
    
    closeBio() { document.getElementById('bioModal').classList.remove('active'); }
    
    saveBio() {
        this.bios = {
            hba1c: document.getElementById('in-hba1c').value,
            glucose: document.getElementById('in-glucose').value,
            insulin: document.getElementById('in-insulin').value,
            apob: document.getElementById('in-apob').value,
            lpa: document.getElementById('in-lpa').value,
            hscrp: document.getElementById('in-hscrp').value,
            vo2: document.getElementById('in-vo2').value,
            test: document.getElementById('in-test').value,
            igf1: document.getElementById('in-igf1').value,
            vitd: document.getElementById('in-vitd').value
        };
        localStorage.setItem(`centurion_bios_${this.user}`, JSON.stringify(this.bios));
        this.closeBio();
        this.render();
    }

    async fetchOuraData() {
        const fetchID = this.user; 
        const token = TOKENS[fetchID];
        const range = `start_date=${getDateKey(new Date(Date.now()-864e5*14))}&end_date=${getDateKey(new Date())}`;
        const cb = `&t=${Date.now()}`;
        
        document.getElementById('ouraBar').innerHTML = "üíç SYNCING...";
        
        try {
            const [rRes, aRes, sRes] = await Promise.all([
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_readiness?${range}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/daily_activity?${range}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?${range}${cb}`)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            const rData = await rRes.json();
            const aData = await aRes.json();
            const sData = await sRes.json();
            
            if(this.user !== fetchID) return;
            
            if(rData.data) {
                console.log(`üìä Oura sync: ${rData.data.length} days | Readiness + Activity + Sleep`);
                
                const hist = rData.data.map(day => {
                    const act = aData.data ? aData.data.find(ac => ac.day === day.day) : null;
                    
                    const dayBefore = new Date(day.day);
                    dayBefore.setDate(dayBefore.getDate() - 1);
                    const dayBeforeKey = getDateKey(dayBefore);
                    const slp = sData.data ? sData.data.find(sc => sc.day === dayBeforeKey) : null;
                    
                    // More defensive parsing with explicit null checks
                    let sleepHours = "-";
                    let deepMin = "-";
                    let remMin = "-";
                    
                    if(slp) {
                        // CRITICAL: Oura v2 sleep endpoint uses these exact field names
                        // Check if total_sleep_duration exists and is a number
                        if(typeof slp.total_sleep_duration === 'number' && slp.total_sleep_duration > 0) {
                            sleepHours = (slp.total_sleep_duration / 3600).toFixed(1);
                        }
                        
                        // Check deep sleep
                        if(typeof slp.deep_sleep_duration === 'number' && slp.deep_sleep_duration > 0) {
                            deepMin = Math.round(slp.deep_sleep_duration / 60);
                        }
                        
                        // Check REM sleep
                        if(typeof slp.rem_sleep_duration === 'number' && slp.rem_sleep_duration > 0) {
                            remMin = Math.round(slp.rem_sleep_duration / 60);
                        }
                    }
                    
                    return { 
                        date: day.day, 
                        score: day.score || "-", 
                        cal: act ? act.active_calories : "-", 
                        high: act ? Math.round(act.high_activity_time/60) : 0, 
                        med: act ? Math.round(act.medium_activity_time/60) : 0,
                        rhr: USERS[fetchID].rhr,
                        sleep: sleepHours,
                        deep: deepMin,
                        rem: remMin
                    };
                }).reverse();
                
                localStorage.setItem(`centurion_oura_cache_${fetchID}`, JSON.stringify({history: hist, lastFetch: Date.now()}));
                this.cache = { history: hist };
                document.getElementById('ouraBar').innerHTML = `üíç SYNCED`;
                this.render();
            }
        } catch(e) { 
            console.error(e);
            document.getElementById('ouraBar').innerHTML = "üíç SYNC TIMEOUT"; 
        }
    }

    calculateDailyTotals(dk) {
        const checks = this.checkedItems[dk] || [];
        const meals = MEAL_DB[this.user];
        let totals = { p:0, c:0, f:0, fib:0, omega3:0, polyphenols:0 };
        let colorsPicked = new Set();
        
        ['breakfast', 'juice', 'lunch', 'snack', 'dinner'].forEach(mealType => {
            if(checks.includes(mealType)) {
                const meal = meals[mealType];
                totals.p += meal.macros.p;
                totals.c += meal.macros.c;
                totals.f += meal.macros.f;
                totals.fib += meal.macros.fib;
                totals.omega3 += meal.compounds.omega3 || 0;
                totals.polyphenols += meal.compounds.polyphenols || 0;
                if(meal.colors) meal.colors.forEach(c => colorsPicked.add(c));
            }
        });

        const rainbowScore = Math.round((colorsPicked.size / 6) * 100);
        return { totals, rainbowScore };
    }

    async getAIInsight(dk, rawOura, totals, u, rainbowScore) {
        // Check cache first
        if(this.aiInsights[dk]) {
            console.log("‚úÖ Using cached AI insight for", dk);
            return this.aiInsights[dk];
        }

        // Check if API key is set
        if(GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
            console.warn("‚ö†Ô∏è No API key configured - returning demo insight");
            return this.generateDemoInsight(rawOura, totals, u, rainbowScore);
        }

        console.log("ü§ñ Generating new AI insight for", dk);
        const scoreVal = parseInt(rawOura.score) || 0;

        const contextPrompt = `You are an expert longevity coach analyzing daily health data for ${u.name}, age ${u.age}.

TODAY'S DATA (${dk}):
- Readiness Score: ${scoreVal}/100
- Sleep: ${rawOura.sleep} hours (Deep: ${rawOura.deep}m, REM: ${rawOura.rem}m)
- Activity: ${rawOura.cal} active calories, ${rawOura.med}min Zone 2, ${rawOura.high}min Zone 5
- Nutrition: ${totals.p}g protein, ${Math.round(totals.omega3)}mg omega-3, ${totals.polyphenols}mg polyphenols
- Phytonutrient Diversity: ${rainbowScore}% (${Math.round(rainbowScore/100*6)}/6 colors)

BIOMARKERS:
- VO2 Max: ${this.bios.vo2 || 'Not tracked'} mL/kg/min
- HbA1c: ${this.bios.hba1c || 'Not tracked'}%
- ApoB: ${this.bios.apob || 'Not tracked'} mg/dL

GOALS:
- Sleep: ${u.goals.sleep}hrs | Protein: ${u.goals.pro}g | Omega-3: ${u.goals.omega3}mg | Polyphenols: ${u.goals.polyphenols}mg

Provide a brief (2-3 sentences) personalized insight:
1. What's going WELL (be specific with numbers)
2. ONE actionable improvement (not generic advice)
3. WHY this matters for longevity (mechanism, not platitude)

Be direct, data-driven, and motivating. No fluff.`;

        try {
            // Using Google Gemini 1.5 Flash via REST API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: contextPrompt }]
                    }]
                })
            });

            if(!response.ok) {
                const errorText = await response.text();
                console.error("‚ùå API error:", response.status, errorText);
                throw new Error(`API returned ${response.status}`);
            }

            const data = await response.json();
            // Parse Gemini response structure
            const insight = data.candidates[0].content.parts[0].text;
            
            // Cache the insight
            this.aiInsights[dk] = insight;
            localStorage.setItem(`centurion_ai_insights_${this.user}`, JSON.stringify(this.aiInsights));

            console.log("‚úÖ AI insight generated and cached");
            return insight;
        } catch(e) {
            console.error("‚ùå AI insight error:", e);
            return this.generateDemoInsight(rawOura, totals, u, rainbowScore);
        }
    }

    generateDemoInsight(rawOura, totals, u, rainbowScore) {
        const scoreVal = parseInt(rawOura.score) || 0;
        const proteinPct = Math.round(totals.p/u.goals.pro*100);
        const sleepPct = rawOura.sleep !== "-" ? Math.round((rawOura.sleep/u.goals.sleep)*100) : 0;
        
        let insight = `<strong>Demo Mode - Configure API Key</strong><br><br>`;
        
        if(scoreVal >= 85) {
            insight += `Your ${scoreVal} readiness score indicates <strong>peak recovery</strong>. `;
        } else if(scoreVal >= 70) {
            insight += `Your ${scoreVal} readiness suggests <strong>moderate recovery</strong>. `;
        } else if(scoreVal > 0) {
            insight += `Your ${scoreVal} readiness indicates you need more recovery. `;
        } else {
            insight += `Waiting for Oura sync data. `;
        }

        if(proteinPct >= 90) {
            insight += `Excellent protein intake at ${totals.p}g (${proteinPct}% of goal), supporting muscle protein synthesis and mTOR activation. `;
        } else if(proteinPct >= 70) {
            insight += `You're at ${totals.p}g protein (${proteinPct}% of goal). `;
        } else {
            insight += `<strong>Priority: increase protein</strong> to ${u.goals.pro}g for optimal muscle maintenance and longevity signaling. `;
        }

        if(rainbowScore >= 80) {
            insight += `Your ${rainbowScore}% phytonutrient diversity is outstanding! üåà`;
        } else if(rainbowScore >= 50) {
            insight += `Try adding more colorful foods to boost polyphenol intake for enhanced cellular resilience.`;
        } else {
            insight += `Focus on eating across the color spectrum to maximize polyphenol diversity and activate longevity pathways.`;
        }

        insight += `<br><br><em style="color:#666;">Add your Google Gemini API key to GEMINI_API_KEY variable for real AI coaching.</em>`;
        
        return insight;
    }

    async refreshAIInsight() {
        const aiCard = document.querySelector('.ai-insight-card');
        if(aiCard) {
            aiCard.innerHTML = `
                <div class="ai-header">
                    <span class="ai-loading"></span>
                    <span>AI COACH REGENERATING...</span>
                </div>
                <div class="ai-content">Analyzing your latest data...</div>
            `;
        }
        
        const dk = getDateKey(this.getCurrentDate());
        delete this.aiInsights[dk];
        localStorage.setItem(`centurion_ai_insights_${this.user}`, JSON.stringify(this.aiInsights));
        
        setTimeout(async () => {
            const d = this.getCurrentDate();
            const dkNew = getDateKey(d);
            const rawOura = this.cache.history.find(d => d.date === dkNew) || { score: "-", cal: "-", high: 0, med: 0, rhr: "-", sleep: "-", deep: "-", rem: "-" };
            const u = USERS[this.user];
            
            const { totals, rainbowScore } = this.calculateDailyTotals(dkNew);
            
            const insight = await this.getAIInsight(dkNew, rawOura, totals, u, rainbowScore);
            
            if(aiCard) {
                aiCard.innerHTML = `
                    <div class="ai-header">
                        <span>üß† AI LONGEVITY COACH</span>
                    </div>
                    <div class="ai-content">${insight}</div>
                    <button class="ai-refresh" onclick="centurion.refreshAIInsight()">üîÑ REGENERATE INSIGHT</button>
                `;
            }
        }, 500);
    }

    async render() {
        const d = this.getCurrentDate();
        const dk = getDateKey(d);
        const today = getDateKey(getCaDate());
        const displayDate = (dk === today) ? "TODAY" : dk.substring(5);
        
        document.getElementById('dateDisplay').innerText = displayDate;
        document.getElementById('btn-next').classList.toggle('disabled', dk === today);

        const rawOura = this.cache.history.find(d => d.date === dk) || { score: "-", cal: "-", high: 0, med: 0, rhr: "-", sleep: "-", deep: "-", rem: "-" };
        const u = USERS[this.user];
        const scoreVal = parseInt(rawOura.score) || 0;
        const rColor = scoreVal >= 80 ? 'var(--acid)' : scoreVal >= 60 ? 'var(--gold)' : 'var(--alert)';
        const safeNum = (v) => (v === "-" || v === undefined || isNaN(v)) ? 0 : parseFloat(v);

        let statusMsg = "GATHERING DATA...";
        if(scoreVal > 0) {
            if(scoreVal >= 85) statusMsg = "PEAK READINESS. ANABOLIC WINDOW OPEN.";
            else if(scoreVal >= 70) statusMsg = "SYSTEMS NOMINAL. MAINTAIN PROTOCOLS.";
            else statusMsg = "RECOVERY MODE. PRIORITIZE SLEEP/NUTRITION.";
        }

        const meals = MEAL_DB[this.user];
        const mode = scoreVal >= 80 ? "anabolic" : "repair";
        const wKey = `${mode}_${this.user.toLowerCase()}`;
        const workout = WORKOUTS[wKey];

        const checks = this.checkedItems[dk] || [];
        
        const { totals, rainbowScore } = this.calculateDailyTotals(dk);

        const sleepScore = Math.min((safeNum(rawOura.sleep)/u.goals.sleep)*100, 100);
        const trainScore = Math.min((safeNum(rawOura.high)/u.goals.z5)*100, 100);
        const nutritionScore = Math.min(((totals.p/u.goals.pro + totals.omega3/u.goals.omega3 + totals.polyphenols/u.goals.polyphenols)/3)*100, 100);
        const dayGrade = (sleepScore + trainScore + nutritionScore) / 3;
        
        let gradeLetter = 'C', gradeClass = 'grade-c';
        if(dayGrade >= 90) { gradeLetter = 'S'; gradeClass = 'grade-s'; }
        else if(dayGrade >= 80) { gradeLetter = 'A'; gradeClass = 'grade-a'; }
        else if(dayGrade >= 70) { gradeLetter = 'B'; gradeClass = 'grade-b'; }

        const isChecked = (id) => checks.includes(id) ? 'checked' : '';
        const btnTxt = (id) => checks.includes(id) ? '‚úì' : '‚óã';

        const bioStatus = (val, optimal, warning) => {
            if(!val) return '';
            const v = parseFloat(val);
            if(v <= optimal) return '<span class="bio-status status-optimal">OPTIMAL</span>';
            if(v <= warning) return '<span class="bio-status status-warning">MONITOR</span>';
            return '<span class="bio-status status-alert">ALERT</span>';
        };

        const colorDots = (colors) => {
            if(!colors || colors.length === 0) return '';
            return `<div class="color-dots">
                ${colors.map(c => `<div class="color-dot" style="background:${COLOR_MAP[c].color}" title="${COLOR_MAP[c].compound}"></div>`).join('')}
            </div>`;
        };

        // AI INSIGHT - Show loading state initially
        let aiInsightHTML = `<div class="ai-insight-card">
            <div class="ai-header">
                <span class="ai-loading"></span>
                <span>AI LONGEVITY COACH ANALYZING...</span>
            </div>
            <div class="ai-content" id="aiInsightContent">Generating personalized insight...</div>
        </div>`;

        const html = `
        <div class="hero-section">
            <div class="ring-container">
                <svg class="ring-svg"><circle class="ring-bg" cx="55" cy="55" r="45"></circle><circle class="ring-fg" cx="55" cy="55" r="45" style="stroke:${rColor}; stroke-dashoffset:${283 - (Math.min(scoreVal,100)/100)*283}"></circle></svg>
                <div class="ring-data"><div class="ring-val">${rawOura.score}</div><div class="ring-label">READINESS</div></div>
            </div>
            <div class="tactical-box" style="border-left-color:${rColor}">
                <div class="tac-label" style="color:${rColor}">USER: ${u.name.toUpperCase()}</div>
                <div class="tac-cmd">${statusMsg}</div>
                <div class="tac-meta">VO2: ${this.bios.vo2 || '--'} | HbA1c: ${this.bios.hba1c || '--'}% | üåà ${rainbowScore}% Diversity</div>
            </div>
        </div>

        ${aiInsightHTML}

        <div class="section-label">SLEEP ARCHITECTURE</div>
        <div class="sleep-grid">
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:url(#grad-purple); stroke-dashoffset:${158-(Math.min(safeNum(rawOura.sleep),9)/9)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.sleep}</div><span class="orb-unit">HRS</span></div></div><div class="orb-label">TOTAL</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:#007aff; stroke-dashoffset:${158-(Math.min(safeNum(rawOura.deep),120)/120)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.deep}</div><span class="orb-unit">DEEP</span></div></div><div class="orb-label">DEEP</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:var(--purple); stroke-dashoffset:${158-(Math.min(safeNum(rawOura.rem),120)/120)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.rem}</div><span class="orb-unit">REM</span></div></div><div class="orb-label">REM</div></div>
        </div>

        <div class="section-label">CARDIO-METABOLIC STATUS</div>
        <div class="telemetry-grid">
            <div class="orb-card live"><div class="live-dot"></div><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:var(--cyan); stroke-dashoffset:${158-(Math.min(safeNum(rawOura.cal),1000)/1000)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.cal}</div><span class="orb-unit">CAL</span></div></div><div class="orb-label">ACTIVE</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:url(#grad-zone2); stroke-dashoffset:${158-(Math.min(safeNum(rawOura.med),60)/60)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.med}</div><span class="orb-unit">Z2 MIN</span></div></div><div class="orb-label">BASE</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:url(#grad-zone5); stroke-dashoffset:${158-(Math.min(safeNum(rawOura.high),30)/30)*158}"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.high}</div><span class="orb-unit">Z5 MIN</span></div></div><div class="orb-label">PEAK</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:var(--acid)"></circle></svg><div class="orb-val-box"><div class="orb-val">${rawOura.rhr}</div><span class="orb-unit">BPM</span></div></div><div class="orb-label">RHR</div></div>
        </div>

        <div class="section-label">MACRO & LONGEVITY COMPOUNDS</div>
        <div class="macro-grid">
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:#fff; stroke-dashoffset:${158-(Math.min(totals.p/u.goals.pro,1)*158)}"></circle></svg><div class="orb-val-box"><div class="orb-val">${totals.p}</div><span class="orb-unit">PRO</span></div></div><div class="orb-label">PROTEIN</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:#00d4ff; stroke-dashoffset:${158-(Math.min(totals.omega3/u.goals.omega3,1)*158)}"></circle></svg><div class="orb-val-box"><div class="orb-val">${Math.round(totals.omega3/100)/10}</div><span class="orb-unit">Œ©-3g</span></div></div><div class="orb-label">OMEGA-3</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:#bf5af2; stroke-dashoffset:${158-(Math.min(totals.polyphenols/u.goals.polyphenols,1)*158)}"></circle></svg><div class="orb-val-box"><div class="orb-val">${totals.polyphenols}</div><span class="orb-unit">POLY</span></div></div><div class="orb-label">POLYPHENOLS</div></div>
            <div class="orb-card"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="30" cy="30" r="25"></circle><circle class="orb-fg" cx="30" cy="30" r="25" style="stroke:#30d158; stroke-dashoffset:${158-(Math.min(totals.fib/u.goals.fib,1)*158)}"></circle></svg><div class="orb-val-box"><div class="orb-val">${totals.fib}</div><span class="orb-unit">FIB</span></div></div><div class="orb-label">FIBER</div></div>
        </div>

        <button class="expand-btn" onclick="document.getElementById('bioPanel').classList.toggle('open')">‚ñº BIOMARKER PANEL</button>
        <div id="bioPanel" class="expandable">
            <div class="biomarker-panel">
                <div style="font-size:0.6rem;color:var(--acid);margin-bottom:10px;font-weight:700;">METABOLIC</div>
                <div class="bio-row"><span class="bio-name">HbA1c</span><span><span class="bio-val">${this.bios.hba1c || '--'}%</span>${bioStatus(this.bios.hba1c, 5.4, 5.7)}</span></div>
                <div class="bio-row"><span class="bio-name">Fasting Glucose</span><span><span class="bio-val">${this.bios.glucose || '--'} mg/dL</span>${bioStatus(this.bios.glucose, 85, 100)}</span></div>
                <div class="bio-row"><span class="bio-name">Fasting Insulin</span><span><span class="bio-val">${this.bios.insulin || '--'} ŒºIU/mL</span>${bioStatus(this.bios.insulin, 5, 8)}</span></div>
                
                <div style="font-size:0.6rem;color:var(--acid);margin:15px 0 10px;font-weight:700;">CARDIOVASCULAR</div>
                <div class="bio-row"><span class="bio-name">ApoB</span><span><span class="bio-val">${this.bios.apob || '--'} mg/dL</span>${bioStatus(this.bios.apob, 60, 80)}</span></div>
                <div class="bio-row"><span class="bio-name">Lp(a)</span><span><span class="bio-val">${this.bios.lpa || '--'} nmol/L</span>${bioStatus(this.bios.lpa, 30, 75)}</span></div>
                <div class="bio-row"><span class="bio-name">hsCRP</span><span><span class="bio-val">${this.bios.hscrp || '--'} mg/L</span>${bioStatus(this.bios.hscrp, 1, 3)}</span></div>
                
                <div style="font-size:0.6rem;color:var(--acid);margin:15px 0 10px;font-weight:700;">LONGEVITY MARKERS</div>
                <div class="bio-row"><span class="bio-name">VO2 Max</span><span><span class="bio-val">${this.bios.vo2 || '--'} mL/kg/min</span></span></div>
                <div class="bio-row"><span class="bio-name">Testosterone</span><span><span class="bio-val">${this.bios.test || '--'} ng/dL</span></span></div>
                <div class="bio-row"><span class="bio-name">IGF-1</span><span><span class="bio-val">${this.bios.igf1 || '--'} ng/mL</span></span></div>
                <div class="bio-row"><span class="bio-name">Vitamin D</span><span><span class="bio-val">${this.bios.vitd || '--'} ng/mL</span>${bioStatus(this.bios.vitd, 40, 60, true)}</span></div>
            </div>
        </div>

        <div class="timeline-container">
            <div class="section-label" style="margin:0 0 15px;">CHRONO-NUTRITION PROTOCOL</div>
            
            <div class="time-slot">
                <div class="ts-time">6:00</div>
                <div class="ts-card ${isChecked('circadian')}">
                    <div class="ts-title">Circadian Activation</div>
                    <div class="ts-desc">Sunlight exposure (10min) + Cold shower (3min @ 50¬∞F)</div>
                    <div class="ts-mech">üî¨ <span class="science-term">Cortisol awakening response<span class="tooltip"><div class="tooltip-title">Cortisol Awakening Response</div>Natural cortisol spike within 30min of waking, triggered by morning sunlight. Sets circadian rhythm and optimizes energy/focus.<div class="tooltip-benefit">‚Üí Circadian health & alertness</div></span></span> + <span class="science-term">Cold thermogenesis<span class="tooltip"><div class="tooltip-title">Cold Thermogenesis</div>Cold exposure activates brown fat, increases metabolic rate, and triggers resilience pathways like PGC-1Œ± for mitochondrial health.<div class="tooltip-benefit">‚Üí Metabolic boost & resilience</div></span></span></div>
                    <button class="check-btn" onclick="centurion.toggleItem('circadian')">${btnTxt('circadian')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">${meals.breakfast.time}</div>
                <div class="ts-card ${isChecked('breakfast')}">
                    <div class="ts-title">${meals.breakfast.name}</div>
                    <div class="ts-desc">${meals.breakfast.desc}</div>
                    <div class="ts-nutrients">
                        <span class="nutrient-tag science-term">EPA/DHA: ${meals.breakfast.compounds.omega3}mg<span class="tooltip"><div class="tooltip-title">EPA & DHA (Omega-3s)</div>Long-chain fatty acids from fish that reduce inflammation, support brain health, and improve cardiovascular function.<div class="tooltip-benefit">‚Üí Heart, brain & longevity</div></span></span>
                        <span class="nutrient-tag science-term">Polyphenols: ${meals.breakfast.compounds.polyphenols}mg<span class="tooltip"><div class="tooltip-title">Polyphenols</div>Plant compounds that activate longevity pathways (sirtuins), reduce oxidative stress, and support mitochondrial health.<div class="tooltip-benefit">‚Üí Cellular longevity & disease prevention</div></span></span>
                        <span class="nutrient-tag">${meals.breakfast.macros.p}p/${meals.breakfast.macros.c}c/${meals.breakfast.macros.f}f</span>
                    </div>
                    <div style="font-size:0.65rem;color:#666;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
                        üìä ${meals.breakfast.micronutrients}
                    </div>
                    ${colorDots(meals.breakfast.colors)}
                    <button class="check-btn" onclick="centurion.toggleItem('breakfast')">${btnTxt('breakfast')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">${meals.juice.time}</div>
                <div class="ts-card ${isChecked('juice')}">
                    <div class="ts-title">${meals.juice.name}</div>
                    <div class="ts-desc">${meals.juice.desc}</div>
                    <div class="ts-nutrients">
                        <span class="nutrient-tag">Polyphenols: ${meals.juice.compounds.polyphenols}mg</span>
                        ${meals.juice.compounds.nitrates ? `<span class="nutrient-tag science-term">Nitrates: ${meals.juice.compounds.nitrates}mg<span class="tooltip"><div class="tooltip-title">Dietary Nitrates</div>Converted to nitric oxide in the body, improving blood flow, lowering blood pressure, and enhancing exercise performance.<div class="tooltip-benefit">‚Üí Cardiovascular health & performance</div></span></span>` : ''}
                        ${meals.juice.compounds.curcumin ? `<span class="nutrient-tag science-term">Curcumin: ${meals.juice.compounds.curcumin}mg<span class="tooltip"><div class="tooltip-title">Curcumin + Piperine</div>Powerful anti-inflammatory from turmeric. Piperine (black pepper) increases absorption by 2000%.<div class="tooltip-benefit">‚Üí Inflammation reduction</div></span></span>` : ''}
                    </div>
                    <div style="font-size:0.65rem;color:#666;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
                        üìä ${meals.juice.micronutrients}
                    </div>
                    ${colorDots(meals.juice.colors)}
                    <button class="check-btn" onclick="centurion.toggleItem('juice')">${btnTxt('juice')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">9:00</div>
                <div class="ts-card ${isChecked('train')}">
                    <div class="ts-title">Training: ${workout.title}</div>
                    <div class="ts-desc">${workout.sub}</div>
                    <div class="ts-mech">üî¨ ${workout.mech.replace('mTOR', '<span class="science-term">mTOR<span class="tooltip"><div class="tooltip-title">Mechanistic Target of Rapamycin</div>Master growth regulator that triggers muscle protein synthesis when activated by resistance training + protein.<div class="tooltip-benefit">‚Üí Muscle growth & longevity balance</div></span></span>').replace('Mitochondrial biogenesis', '<span class="science-term">Mitochondrial biogenesis<span class="tooltip"><div class="tooltip-title">Mitochondrial Biogenesis</div>Creation of new cellular powerhouses triggered by Zone 2 cardio. More mitochondria = better energy, endurance, and metabolic health.<div class="tooltip-benefit">‚Üí Enhanced longevity & energy</div></span></span>').replace('HRV', '<span class="science-term">HRV<span class="tooltip"><div class="tooltip-title">Heart Rate Variability</div>Beat-to-beat heart rhythm variation. Higher HRV = better autonomic nervous system flexibility and recovery capacity.<div class="tooltip-benefit">‚Üí Stress resilience & recovery</div></span></span>')}</div>
                    <button class="check-btn" onclick="centurion.toggleItem('train')">${btnTxt('train')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">10:00</div>
                <div class="ts-card ${isChecked('post_workout')}">
                    <div class="ts-title">Post-Workout Nutrition</div>
                    <div class="ts-desc">${workout.postWorkout}</div>
                    ${this.user === 'J' ? `<div class="ts-mech">üß¨ <span class="science-term">Creatine<span class="tooltip"><div class="tooltip-title">Creatine Monohydrate</div>Cannot get 5g from food (would need 2+ lbs of meat). Enhances ATP production for strength, power, and muscle growth. Also supports brain function.<div class="tooltip-benefit">‚Üí Performance & cognitive health</div></span></span> - 5g daily (not obtainable from food)</div>` : ''}
                    <button class="check-btn" onclick="centurion.toggleItem('post_workout')">${btnTxt('post_workout')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">${meals.lunch.time}</div>
                <div class="ts-card ${isChecked('lunch')}">
                    <div class="ts-title">${meals.lunch.name}</div>
                    <div class="ts-desc">${meals.lunch.desc}</div>
                    <div class="ts-nutrients">
                        <span class="nutrient-tag">Omega-3: ${meals.lunch.compounds.omega3}mg</span>
                        <span class="nutrient-tag">Polyphenols: ${meals.lunch.compounds.polyphenols}mg</span>
                        <span class="nutrient-tag">${meals.lunch.macros.p}p/${meals.lunch.macros.c}c/${meals.lunch.macros.f}f</span>
                    </div>
                    <div style="font-size:0.65rem;color:#666;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
                        üìä ${meals.lunch.micronutrients}
                    </div>
                    ${colorDots(meals.lunch.colors)}
                    <button class="check-btn" onclick="centurion.toggleItem('lunch')">${btnTxt('lunch')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">${meals.snack.time}</div>
                <div class="ts-card ${isChecked('snack')}">
                    <div class="ts-title">${meals.snack.name}</div>
                    <div class="ts-desc">${meals.snack.desc}</div>
                    <div class="ts-nutrients">
                        <span class="nutrient-tag">Polyphenols: ${meals.snack.compounds.polyphenols}mg</span>
                        ${meals.snack.compounds.probiotics ? '<span class="nutrient-tag">Probiotics: 50B CFU</span>' : ''}
                        <span class="nutrient-tag">${meals.snack.macros.p}p/${meals.snack.macros.c}c/${meals.snack.macros.f}f</span>
                    </div>
                    <div style="font-size:0.65rem;color:#666;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
                        üìä ${meals.snack.micronutrients}
                    </div>
                    ${colorDots(meals.snack.colors)}
                    <button class="check-btn" onclick="centurion.toggleItem('snack')">${btnTxt('snack')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">${meals.dinner.time}</div>
                <div class="ts-card ${isChecked('dinner')}">
                    <div class="ts-title">${meals.dinner.name}</div>
                    <div class="ts-desc">${meals.dinner.desc}</div>
                    <div class="ts-nutrients">
                        <span class="nutrient-tag">EPA/DHA: ${meals.dinner.compounds.omega3}mg</span>
                        <span class="nutrient-tag">Polyphenols: ${meals.dinner.compounds.polyphenols}mg</span>
                        ${meals.dinner.compounds.sulforaphane ? `<span class="nutrient-tag science-term">Sulforaphane: ${meals.dinner.compounds.sulforaphane}mg<span class="tooltip"><div class="tooltip-title">Sulforaphane</div>Potent compound from cruciferous vegetables that activates Nrf2 pathway, boosting antioxidant production and detoxification.<div class="tooltip-benefit">‚Üí Cancer prevention & detox</div></span></span>` : ''}
                        <span class="nutrient-tag">${meals.dinner.macros.p}p/${meals.dinner.macros.c}c/${meals.dinner.macros.f}f</span>
                    </div>
                    <div style="font-size:0.65rem;color:#666;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
                        üìä ${meals.dinner.micronutrients}
                    </div>
                    ${colorDots(meals.dinner.colors)}
                    <button class="check-btn" onclick="centurion.toggleItem('dinner')">${btnTxt('dinner')}</button>
                </div>
            </div>

            <div class="time-slot">
                <div class="ts-time">21:00</div>
                <div class="ts-card ${isChecked('evening')}">
                    <div class="ts-title">Evening Protocol</div>
                    <div class="ts-desc">Blue light blocking + Magnesium-rich foods complete (${meals.breakfast.compounds.magnesium + meals.snack.compounds.magnesium + meals.dinner.compounds.magnesium}mg today)</div>
                    <div class="ts-mech">üî¨ Melatonin optimization + <span class="science-term">Sleep pressure<span class="tooltip"><div class="tooltip-title">Sleep Pressure (Adenosine)</div>Adenosine builds throughout the day creating "sleep pressure." Magnesium from food aids natural sleep without supplements.<div class="tooltip-benefit">‚Üí Natural deep sleep</div></span></span></div>
                    <button class="check-btn" onclick="centurion.toggleItem('evening')">${btnTxt('evening')}</button>
                </div>
            </div>

            <div class="time-slot summary-card">
                <div style="text-align:center;padding:10px 0;">
                    <div style="font-size:0.6rem;color:var(--text-muted);font-weight:900;letter-spacing:1px;margin-bottom:10px;">LONGEVITY PERFORMANCE SCORE</div>
                    <div class="summary-score">${dayGrade.toFixed(0)}<span style="font-size:1.5rem">/100</span></div>
                    <span class="summary-grade ${gradeClass}">${gradeLetter} GRADE</span>
                    <div style="font-family:var(--font-data);font-size:0.55rem;color:var(--text-muted);margin-top:10px;">
                        Sleep: ${sleepScore.toFixed(0)}% | Training: ${trainScore.toFixed(0)}% | Nutrition: ${nutritionScore.toFixed(0)}%
                    </div>
                </div>
            </div>
        </div>
        `;

        document.getElementById('dayContent').innerHTML = html;

        // NOW generate AI insight AFTER render (async)
        setTimeout(async () => {
            const insight = await this.getAIInsight(dk, rawOura, totals, u, rainbowScore);
            const aiCard = document.querySelector('.ai-insight-card');
            if(aiCard) {
                aiCard.innerHTML = `
                    <div class="ai-header">
                        <span>üß† AI LONGEVITY COACH</span>
                    </div>
                    <div class="ai-content">${insight}</div>
                    <button class="ai-refresh" onclick="centurion.refreshAIInsight()">üîÑ REGENERATE INSIGHT</button>
                `;
            }
        }, 100);
    }
}

const centurion = new CenturionCore();
</script>

</body>
</html>