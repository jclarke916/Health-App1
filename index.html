<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Centurion v17.7 STABILITY</title>
<style>
/* --- CORE STYLES --- */
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:sans-serif;padding-bottom:80px; -webkit-tap-highlight-color: transparent;}
.header{background:#111;padding:15px;border-bottom:1px solid #333;position:sticky;top:0;z-index:100}

/* USER SWITCH */
.user-switch{display:flex;gap:5px;background:#222;padding:3px;border-radius:20px;margin-bottom:10px}
.user-switch button{flex:1;padding:8px 12px;border:none;background:transparent;color:#666;border-radius:16px;cursor:pointer;font-weight:900;font-size:0.7rem;transition:all 0.2s}
.user-switch button.active{background:#ccff00;color:#000;box-shadow:0 2px 10px rgba(204,255,0,0.2)}

/* DATE NAV */
.date-nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;background:#000;border:1px solid #333;border-radius:8px;padding:4px}
.nav-btn{background:transparent;border:none;color:#ccff00;padding:8px 20px;font-size:1.2rem;cursor:pointer}
#dateLabel{flex:1;text-align:center;color:#fff;font-weight:900;font-size:0.9rem;font-family:monospace}

/* HERO SCOREBOARD */
.hero{padding:20px 15px;display:flex;gap:15px;align-items:center}
.dual-score{display:flex;gap:12px;align-items:center}
.score-box{border:3px solid #333;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
.score-box.small{width:70px;height:70px;border-width:2px}
.score-box.primary{width:90px;height:90px;border-width:3px;background:radial-gradient(circle,rgba(204,255,0,0.05) 0%,transparent 70%);box-shadow:0 0 15px rgba(204,255,0,0.1)}
.score-val{font-size:1.4rem;font-weight:900;line-height:1}
.score-val.longevity{font-size:2rem;background:linear-gradient(135deg,#ccff00 0%,#00f0ff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.score-label{font-size:0.45rem;color:#666;text-transform:uppercase;margin-top:2px;font-weight:700}
.score-max{font-size:0.5rem;color:#444;font-weight:700;position:absolute;bottom:6px}

/* STATUS & ALERTS */
.status{flex:1;border-left:3px solid #ccff00;padding-left:15px;font-size:0.7rem;font-weight:bold;line-height:1.3;color:#ccc}
.alert{margin:0 15px 20px;padding:12px;border-radius:8px;text-align:center;font-weight:bold;display:none;font-size:0.7rem;text-transform:uppercase;letter-spacing:1px}
.alert.show{display:block;animation:pulse 2s infinite}
.alert-warning{background:#FFD60A;color:#000}
.alert-protein{background:#00f0ff;color:#000}
@keyframes pulse{0%{opacity:1}50%{opacity:0.8}100%{opacity:1}}

/* GRIDS */
.section-header{padding:10px 15px;font-size:0.55rem;font-weight:900;color:#666;letter-spacing:1px;text-transform:uppercase;margin-top:10px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:0 15px;margin-bottom:20px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;padding:0 15px;margin-bottom:20px}

/* ORBS */
.macro-orb{background:#0a0a0a;border:1px solid #222;border-radius:12px;padding:12px 5px;display:flex;flex-direction:column;align-items:center}
.orb-container{width:50px;height:50px;position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.orb-svg{transform:rotate(-90deg);width:100%;height:100%}
.orb-bg{fill:none;stroke:#222;stroke-width:4}
.orb-fg{fill:none;stroke-width:4;stroke-dasharray:145;stroke-dashoffset:145;transition:stroke-dashoffset 1s ease;stroke-linecap:round}
.orb-val-box{position:absolute;text-align:center}
.orb-val{font-family:monospace;font-size:0.7rem;font-weight:900;color:#fff}
.orb-label{font-size:0.45rem;font-weight:700;color:#666;text-transform:uppercase;letter-spacing:1px}
.macro-goal{font-size:0.5rem;color:#444;margin-top:2px;font-family:monospace}

/* RAINBOW */
.rainbow-container{padding:0 15px;margin-bottom:20px}
.rainbow-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.rainbow-title{font-size:0.6rem;font-weight:900;color:#fff;letter-spacing:1px}
.rainbow-score{font-size:0.75rem;font-weight:900;color:#ccff00;font-family:monospace}
.rainbow-track{height:8px;background:#111;border-radius:4px;display:flex;overflow:hidden;border:1px solid #222}
.rainbow-seg{height:100%;width:0%;transition:width 0.5s ease}
.rainbow-meta{font-size:0.55rem;color:#666;margin-top:6px;line-height:1.3}
.rainbow-suggestion{font-size:0.6rem;color:#ccff00;margin-top:8px;font-weight:700;padding:8px;background:rgba(204,255,0,0.05);border-radius:6px;border:1px solid rgba(204,255,0,0.2)}

/* TIMELINE */
.timeline{padding:0 15px;margin-bottom:40px}
.task{display:flex;gap:10px;margin-bottom:15px;min-height:60px}
.task-time{width:45px;color:#666;font-size:0.7rem;padding-top:12px;text-align:right;font-family:monospace;font-weight:bold}
.task-card{flex:1;background:#0a0a0a;border:1px solid #333;border-radius:12px;padding:12px 60px 12px 12px;position:relative;transition:all 0.2s}
.task-card.checked{border-color:#ccff00;background:rgba(204,255,0,0.05)}
.task-card.clickable:active{transform:scale(0.98);background:#222}
.task-card.auto-detected{border-color:#00f0ff;background:rgba(0,240,255,0.05)}
.task-title{font-weight:900;font-size:0.8rem;margin-bottom:4px;color:#fff}
.task-desc{font-size:0.65rem;color:#888;line-height:1.4}
.workout-badge{display:inline-block;background:#00f0ff;color:#000;padding:2px 6px;border-radius:4px;font-size:0.5rem;font-weight:900;margin-left:4px;vertical-align:text-bottom}
.check-btn{position:absolute;top:0;right:0;width:60px;height:100%;display:flex;align-items:center;justify-content:center;cursor:pointer;border-left:1px solid #222}
.check-circle{width:24px;height:24px;border:2px solid #666;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:0.9rem;transition:all 0.2s}
.task-card.checked .check-circle{background:#ccff00;border-color:#ccff00;color:#000}
.task-card.auto-detected .check-circle{background:#00f0ff;border-color:#00f0ff;color:#000}

/* MODALS */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:500;display:none;overflow-y:auto}
.modal-overlay.show{display:block}
.modal-content{width:90%;max-width:500px;margin:80px auto 40px;background:#111;border-radius:16px;border:2px solid #ccff00}
.modal-header{padding:20px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;background:#000;border-radius:14px 14px 0 0}
.modal-title{font-size:0.9rem;font-weight:900;color:#ccff00;text-transform:uppercase;letter-spacing:1px}
.modal-close{background:transparent;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1}
.modal-body{padding:15px;max-height:60vh;overflow-y:auto}
.meal-option{background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:15px;margin-bottom:12px;cursor:pointer}
.meal-option:active{transform:scale(0.98);background:#222;border-color:#ccff00}
.meal-name{font-size:0.8rem;font-weight:900;color:#fff;margin-bottom:6px}
.meal-macros{font-size:0.6rem;color:#ccc;margin-bottom:6px;font-family:monospace}
.meal-colors{font-size:0.55rem;color:#888}
.color-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}

/* FOOTER & DEBUG */
.footer{position:fixed;bottom:0;left:0;width:100%;background:#000;padding:12px 15px;border-top:1px solid #333;display:flex;justify-content:space-between;align-items:center;z-index:100}
.sync-status{font-size:0.6rem;color:#666;font-family:monospace}
.sync-btn{background:#ccff00;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:900;font-size:0.75rem}
.debug-btn{position:fixed;bottom:80px;right:10px;z-index:200;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #333;padding:5px 10px;border-radius:6px;font-size:0.6rem}
.debug-console{position:fixed;bottom:60px;left:0;right:0;height:200px;background:rgba(0,0,0,0.95);border-top:2px solid #ccff00;z-index:199;display:none;overflow-y:auto;padding:10px;font-size:0.65rem;color:#0f0;font-family:monospace}
</style>
</head>
<body>

<div class="header">
    <div class="user-switch">
        <button id="btn-jermaine" class="active" onclick="if(window.app)app.switchUser('jermaine')">JERMAINE</button>
        <button id="btn-sophia" onclick="if(window.app)app.switchUser('sophia')">SOPHIA</button>
    </div>
    <div class="date-nav">
        <button class="nav-btn" onclick="if(window.app)app.changeDate(-1)">â—€</button>
        <span id="dateLabel">LOADING...</span>
        <button class="nav-btn" onclick="if(window.app)app.changeDate(1)">â–¶</button>
    </div>
</div>

<div id="alertBanner" class="alert"></div>

<div class="hero">
    <div class="dual-score">
        <div class="score-box small">
            <div class="score-val" id="dayScore">--</div>
            <div class="score-label">TODAY</div>
        </div>
        <div class="score-box primary">
            <div class="score-val longevity" id="longevityScore">--</div>
            <div class="score-label">LONGEVITY</div>
            <div class="score-max">/120</div>
        </div>
    </div>
    <div class="status" id="statusMsg">INITIALIZING...</div>
</div>

<div class="section-header">SLEEP ARCHITECTURE</div>
<div class="grid-3">
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="sleepOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="sleepVal">--</div></div></div><div class="orb-label">TOTAL</div></div>
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="deepOrb" cx="25" cy="25" r="21" style="stroke:#007aff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="deepVal">--</div></div></div><div class="orb-label">DEEP</div></div>
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="remOrb" cx="25" cy="25" r="21" style="stroke:#bf5af2"></circle></svg><div class="orb-val-box"><div class="orb-val" id="remVal">--</div></div></div><div class="orb-label">REM</div></div>
</div>

<div class="section-header">FUEL COMPOSITION ðŸ”„ DYNAMIC</div>
<div class="grid-4">
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="proteinOrb" cx="25" cy="25" r="21" style="stroke:#fff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="proteinVal">0</div></div></div><div class="orb-label">PROTEIN</div><div class="macro-goal" id="proteinGoal">--</div></div>
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="omega3Orb" cx="25" cy="25" r="21" style="stroke:#00d4ff"></circle></svg><div class="orb-val-box"><div class="orb-val" id="omega3Val">0</div></div></div><div class="orb-label">OMEGA-3</div><div class="macro-goal" id="omega3Goal">--</div></div>
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="calorieOrb" cx="25" cy="25" r="21" style="stroke:#FFD60A"></circle></svg><div class="orb-val-box"><div class="orb-val" id="calorieVal">0</div></div></div><div class="orb-label">CALORIES</div><div class="macro-goal" id="calorieGoal">--</div></div>
    <div class="macro-orb"><div class="orb-container"><svg class="orb-svg"><circle class="orb-bg" cx="25" cy="25" r="21"></circle><circle class="orb-fg" id="burnOrb" cx="25" cy="25" r="21" style="stroke:#ff453a"></circle></svg><div class="orb-val-box"><div class="orb-val" id="burnVal">0</div></div></div><div class="orb-label">BURN</div><div class="macro-goal" id="burnGoal">--</div></div>
</div>

<div class="section-header">PHYTONUTRIENT DIVERSITY ðŸŒˆ</div>
<div class="rainbow-container">
    <div class="rainbow-header"><div class="rainbow-title">RAINBOW SCORE</div><div class="rainbow-score" id="rainbowScore">0%</div></div>
    <div class="rainbow-track" id="rainbowTrack"></div>
    <div id="rainbowSuggestion" class="rainbow-suggestion" style="display:none"></div>
</div>

<div class="section-header">SYNERGY PROTOCOL ðŸ”„ AUTO-DETECT</div>
<div class="timeline" id="timeline"></div>

<div class="modal-overlay" id="mealModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">SELECT MEAL</div>
            <button class="modal-close" onclick="app.closeMealPicker()">Ã—</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<div class="footer">
    <span class="sync-status" id="syncStatus">INIT</span>
    <button class="sync-btn" onclick="if(window.app)app.sync()">ðŸ”„ SYNC</button>
</div>

<button class="debug-btn" onclick="toggleDebug()">BUG</button>
<div class="debug-console" id="debugConsole"></div>

<script>
// --- CONFIGURATION ---
const USERS = {
    jermaine: {
        name: "Jermaine",
        goals: { protein: 172, omega3: 12000, water: 140, weightTarget: 210, heightInches: 70 },
        defaultBios: { bmr: '2057', apob: '114', lpa: '178', weight: '217.1', hscrp: '0.4', hba1c: '5.4' }
    },
    sophia: {
        name: "Sophia",
        goals: { protein: 130, omega3: 4000, water: 100, weightTarget: 140, heightInches: 64 },
        defaultBios: { bmr: '1450', apob: '70', lpa: '20', weight: '148', hscrp: '0.5', hba1c: '5.2' }
    }
};

const MEAL_DATABASE = {
    breakfast: [
        { name: 'Salmon + Berries + Kale', macros: { p: 54, o: 4000, cal: 640 }, colors: ['orange', 'purple', 'green'] },
        { name: 'Eggs + Avocado + Tomato', macros: { p: 42, o: 1200, cal: 520 }, colors: ['yellow', 'green', 'red'] },
        { name: 'Greek Yogurt + Walnuts', macros: { p: 35, o: 2500, cal: 450 }, colors: ['white', 'purple'] }
    ],
    lunch: [
        { name: 'Chicken + Quinoa Bowl', macros: { p: 52, o: 3800, cal: 680 }, colors: ['red', 'green', 'white', 'yellow'] },
        { name: 'Tuna Salad + Greens', macros: { p: 45, o: 4200, cal: 520 }, colors: ['green', 'red', 'white'] },
        { name: 'Grilled Salmon + Yam', macros: { p: 48, o: 5000, cal: 720 }, colors: ['orange', 'green', 'purple'] }
    ],
    dinner: [
        { name: 'Steak + Broccoli', macros: { p: 56, o: 3600, cal: 720 }, colors: ['orange', 'green', 'white'] },
        { name: 'Baked Cod + Asparagus', macros: { p: 50, o: 4500, cal: 580 }, colors: ['white', 'green', 'yellow'] },
        { name: 'Shrimp Stir-fry', macros: { p: 46, o: 3200, cal: 560 }, colors: ['orange', 'green', 'red'] }
    ]
};

const BASE_PROTOCOL = [
    { id: 'sunrise', time: '06:00', title: 'Morning Walk', desc: '15min walk + cold shower', macros: { p: 0, o: 0, cal: 0 }, colors: [], calBurn: 60 },
    { id: 'breakfast', time: '07:30', title: 'Breakfast ðŸ‘†', desc: 'Tap to select meal', macros: { p: 0, o: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'breakfast' },
    { id: 'train', time: '09:00', title: 'Training ðŸ‘†', desc: 'Auto-detected from Oura', macros: { p: 0, o: 0, cal: 0 }, colors: [], calBurn: 0, clickable: false, autoDetect: true },
    { id: 'lunch', time: '13:00', title: 'Lunch ðŸ‘†', desc: 'Tap to select meal', macros: { p: 0, o: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'lunch' },
    { id: 'dinner', time: '18:30', title: 'Dinner ðŸ‘†', desc: 'Tap to select meal', macros: { p: 0, o: 0, cal: 0 }, colors: [], calBurn: 0, clickable: true, mealSlot: 'dinner' },
    { id: 'evening', time: '21:00', title: 'Wind Down', desc: 'Chamomile tea + stretch', macros: { p: 0, o: 0, cal: 0 }, colors: ['purple'], calBurn: 0 }
];

const TOKENS = { jermaine: 'WLIGFPFJQY73G43BY7CK7H6UJXPQ7N5Y', sophia: '4QSDWYJJUZFHRWRH727NCK7WH4COQJF4' };

const LONGEVITY_MARKERS = {
    apob: { weight: 15, optimal: 80, threshold: 130, direction: 'lower' },
    lpa: { weight: 15, optimal: 30, threshold: 150, direction: 'lower' },
    rhr: { weight: 10, optimal: 50, threshold: 75, direction: 'lower' },
    sleepScore: { weight: 10, optimal: 85, threshold: 60, direction: 'higher' }
};

const RAINBOW_COLORS = {
    red: { hex: '#ff453a', examples: 'Tomatoes, Beets' },
    orange: { hex: '#ff9f0a', examples: 'Carrots, Salmon' },
    yellow: { hex: '#ffd60a', examples: 'Lemon, Turmeric' },
    green: { hex: '#30d158', examples: 'Kale, Spinach' },
    purple: { hex: '#bf5af2', examples: 'Blueberries' },
    white: { hex: '#fff', examples: 'Garlic, Onion' }
};

const WORKOUT_TYPES = { strength_training: 'Strength', cycling: 'Cycling', running: 'Running', walking: 'Walking', swimming: 'Swim', other: 'Workout' };

// --- APP CLASS ---
class CenturionApp {
    constructor() {
        log('ðŸš€ Init v17.7');
        
        // SELF-HEALING: Check version to force clear broken data from previous attempts
        const CURRENT_VER = '17.7';
        const savedVer = localStorage.getItem('centurion_version');
        if(savedVer !== CURRENT_VER) {
             console.warn('Version mismatch. Wiping clean.');
             localStorage.clear();
             localStorage.setItem('centurion_version', CURRENT_VER);
        }

        this.user = localStorage.getItem('centurion_user') || 'jermaine';
        this.history = [];
        this.currentIndex = 0;
        this.currentDateStr = new Date().toLocaleDateString('en-CA');
        this.checked = {};
        this.meals = {};
        this.bios = {};
        this.protocol = [];
        
        this.loadUserData();
        this.setPlaceholderData();
        this.render();
        this.fetchOuraData();
    }

    loadUserData() {
        try {
            const savedChecked = localStorage.getItem(`c_checked_${this.user}`);
            this.checked = savedChecked ? JSON.parse(savedChecked) : {};
            
            const savedMeals = localStorage.getItem(`c_meals_${this.user}`);
            this.meals = savedMeals ? JSON.parse(savedMeals) : {};
            
            const savedBios = localStorage.getItem(`c_bios_${this.user}`);
            this.bios = savedBios ? JSON.parse(savedBios) : USERS[this.user].defaultBios;
        } catch(e) {
            logerr('Data corrupt, resetting user data');
            this.checked = {};
            this.meals = {};
        }
    }

    saveUserData() {
        localStorage.setItem(`c_checked_${this.user}`, JSON.stringify(this.checked));
        localStorage.setItem(`c_meals_${this.user}`, JSON.stringify(this.meals));
    }

    setPlaceholderData() {
        this.history = [{
            date: this.currentDateStr,
            score: 0,
            totalSec: 0,
            deepSec: 0,
            remSec: 0,
            rhr: '-',
            cal: 0,
            workouts: []
        }];
        this.currentIndex = 0;
    }

    async fetchOuraData() {
        log('ðŸ”„ Fetching Oura...');
        this.setText('syncStatus', 'SYNCING...');
        
        try {
            const end = new Date();
            end.setDate(end.getDate() + 1);
            const start = new Date();
            start.setDate(start.getDate() - 10);
            
            const startStr = start.toISOString().split('T')[0];
            const endStr = end.toISOString().split('T')[0];
            const token = TOKENS[this.user];

            const sleepUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/sleep?start_date=${startStr}&end_date=${endStr}`)}`;
            const workoutUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.ouraring.com/v2/usercollection/workout?start_date=${startStr}&end_date=${endStr}`)}`;

            const [sleepRes, workoutRes] = await Promise.all([
                fetch(sleepUrl, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(workoutUrl, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            if (!sleepRes.ok || !workoutRes.ok) throw new Error('API failed');

            const sleepData = await sleepRes.json();
            const workoutData = await workoutRes.json();

            // Safety check for data arrays
            this.processSleepData(Array.isArray(sleepData.data) ? sleepData.data : []);
            this.processWorkoutData(Array.isArray(workoutData.data) ? workoutData.data : []);
            
            this.setText('syncStatus', 'SYNCED âœ“');
            this.render();
            
        } catch (error) {
            logerr('âŒ Sync failed: ' + error);
            this.setText('syncStatus', 'OFFLINE');
            this.render();
        }
    }

    processSleepData(sleepData) {
        const sleepMap = new Map();
        sleepData.forEach(session => {
            if (!sleepMap.has(session.day)) {
                sleepMap.set(session.day, {
                    date: session.day,
                    score: session.score || 0,
                    totalSec: 0,
                    deepSec: 0,
                    remSec: 0,
                    rhr: session.contributors?.resting_heart_rate || '-',
                    cal: 0,
                    workouts: []
                });
            }
            const day = sleepMap.get(session.day);
            day.totalSec += session.total_sleep_duration || 0;
            day.deepSec += session.deep_sleep_duration || 0;
            day.remSec += session.rem_sleep_duration || 0;
            // Oura sometimes sends multiple sleep segments, take max score
            if (session.score && session.score > day.score) day.score = session.score;
        });
        
        this.history = Array.from(sleepMap.values()).sort((a, b) => b.date.localeCompare(a.date));
        
        // Ensure today exists
        this.currentIndex = this.history.findIndex(h => h.date === this.currentDateStr);
        if (this.currentIndex === -1) {
            this.history.unshift({
                date: this.currentDateStr,
                score: 0,
                totalSec: 0,
                deepSec: 0,
                remSec: 0,
                rhr: '-',
                cal: 0,
                workouts: []
            });
            this.currentIndex = 0;
        }
    }

    processWorkoutData(workoutData) {
        workoutData.forEach(workout => {
            const day = this.history.find(h => h.date === workout.day);
            if (day) {
                const startTime = new Date(workout.start_datetime);
                const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                day.workouts.push({
                    type: workout.activity || 'other',
                    intensity: workout.intensity || 'moderate',
                    calories: workout.calories || 300,
                    time: timeStr,
                    start: workout.start_datetime
                });
            }
        });
    }

    changeDate(direction) {
        const newIndex = this.currentIndex - direction;
        if (newIndex >= 0 && newIndex < this.history.length) {
            this.currentIndex = newIndex;
            this.currentDateStr = this.history[newIndex].date;
            this.render();
        }
    }

    switchUser(newUser) {
        if (newUser === this.user) return;
        
        // Update UI Tabs
        document.querySelectorAll('.user-switch button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${newUser}`).classList.add('active');
        
        // Reset state
        this.user = newUser;
        localStorage.setItem('centurion_user', newUser);
        this.history = []; // Clear old user history
        this.loadUserData(); // Load new user settings
        this.setPlaceholderData(); // Set dummy data to prevent crash
        
        this.render(); // Render empty state
        this.fetchOuraData(); // Fetch real data
    }

    toggleTask(taskId) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.checked[dateKey]) this.checked[dateKey] = [];
        
        const index = this.checked[dateKey].indexOf(taskId);
        if (index === -1) {
            this.checked[dateKey].push(taskId);
        } else {
            this.checked[dateKey].splice(index, 1);
        }
        
        this.saveUserData();
        this.render();
    }

    openMealPicker(mealSlot) {
        this.currentMealSlot = mealSlot;
        const slotName = mealSlot.charAt(0).toUpperCase() + mealSlot.slice(1);
        this.setText('modalTitle', 'SELECT ' + slotName.toUpperCase());
        
        const meals = MEAL_DATABASE[mealSlot] || [];
        let html = '';
        meals.forEach((meal, index) => {
            const colorDots = meal.colors.map(c => `<span class="color-dot" style="background:${RAINBOW_COLORS[c].hex}"></span>`).join('');
            html += `<div class="meal-option" onclick="app.selectMeal('${mealSlot}', ${index})">
                <div class="meal-name">${meal.name}</div>
                <div class="meal-macros">P: ${meal.macros.p}g | Î©3: ${meal.macros.o}mg | Cal: ${meal.macros.cal}</div>
                <div class="meal-colors">${colorDots} ${meal.colors.join(', ')}</div>
            </div>`;
        });
        
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('mealModal').classList.add('show');
    }

    closeMealPicker() {
        document.getElementById('mealModal').classList.remove('show');
        this.currentMealSlot = null;
    }

    selectMeal(mealSlot, mealIndex) {
        const dateKey = this.history[this.currentIndex].date;
        if (!this.meals[dateKey]) this.meals[dateKey] = {};
        
        this.meals[dateKey][mealSlot] = mealIndex;
        this.saveUserData();
        this.closeMealPicker();
        this.render();
    }

    // --- LOGIC ENGINES ---

    calculateDynamicCalories() {
        const bmr = parseInt(this.bios.bmr) || 2057;
        const day = this.history[this.currentIndex];
        let workoutBurn = 0;
        
        if (day.workouts && day.workouts.length > 0) {
            day.workouts.forEach(w => workoutBurn += w.calories || 0);
        }
        
        return { bmr: bmr, workoutBurn: workoutBurn, total: bmr + workoutBurn };
    }

    calculateMacros() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let totals = { protein: 0, omega3: 0, calories: 0, burn: 0 };
        
        this.protocol.forEach(task => {
            if (checked.includes(task.id)) {
                totals.protein += task.macros.p || 0;
                totals.omega3 += task.macros.o || 0;
                totals.calories += task.macros.cal || 0;
                totals.burn += task.calBurn || 0;
            }
        });
        return totals;
    }

    calculateRainbow() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let colors = new Set();
        
        this.protocol.forEach(task => {
            if (checked.includes(task.id) && task.colors) {
                task.colors.forEach(c => colors.add(c));
            }
        });
        return colors;
    }

    // FIX: Sleep debt explicitly excludes 'today' (which is always incomplete)
    calculateSleepDebt() {
        const today = new Date().toLocaleDateString('en-CA');
        const last7Days = this.history.filter(day => {
            if (day.date === today) return false;
            if (day.totalSec === 0) return false; // Ignore missing data days
            return true;
        }).slice(0, 7);
        
        if (last7Days.length === 0) return 0;
        
        let totalDebt = 0;
        last7Days.forEach(day => {
            const actual = day.totalSec / 3600;
            const deficit = 8 - actual;
            if (deficit > 0) totalDebt += deficit;
        });
        
        return totalDebt;
    }

    checkProteinWindow() {
        // Only run for today's live data
        const dateKey = this.history[this.currentIndex].date;
        if (dateKey !== new Date().toLocaleDateString('en-CA')) return;
        
        const day = this.history[this.currentIndex];
        const hasWorkout = day.workouts && day.workouts.length > 0;
        
        if (!hasWorkout) return;
        
        const checked = this.checked[dateKey] || [];
        const ateProtein = checked.includes('breakfast') || 
                           checked.includes('lunch') || 
                           checked.includes('dinner');
        
        if (ateProtein) return;
        
        // If workout exists and no protein logged -> Active Window
        this.proteinWindowActive = true;
    }

    calculateLongevityScore() {
        // Simplified marker check for demo
        const day = this.history[this.currentIndex];
        let totalScore = 0;
        // Mock calculation based on bios presence
        if (this.bios.apob && parseInt(this.bios.apob) < 100) totalScore += 30;
        if (day.score > 80) totalScore += 20;
        return totalScore + 50; // Base baseline
    }

    // --- RENDER ---
    render() {
        try {
            if (!this.history || this.history.length === 0) return;

            this.protocol = JSON.parse(JSON.stringify(BASE_PROTOCOL));
            this.proteinWindowActive = false;
            
            const dateKey = this.history[this.currentIndex].date;
            const day = this.history[this.currentIndex];
            
            // 1. Hydrate Meal Slots
            let selectedMeals = this.meals[dateKey];
            if (!selectedMeals) {
                // Default meals if none selected
                selectedMeals = { breakfast: 0, lunch: 0, dinner: 0 };
                this.meals[dateKey] = selectedMeals;
            }
            
            this.protocol.forEach(task => {
                if (task.mealSlot && selectedMeals[task.mealSlot] !== undefined) {
                    const meal = MEAL_DATABASE[task.mealSlot][selectedMeals[task.mealSlot]];
                    task.title = meal.name + ' ðŸ‘†';
                    task.desc = `P: ${meal.macros.p}g Î©3: ${meal.macros.o}mg Cal: ${meal.macros.cal}`;
                    task.macros = meal.macros;
                    task.colors = meal.colors;
                }
                
                // Auto Detect Workout in Protocol
                if (task.autoDetect && day.workouts && day.workouts.length > 0) {
                    const workout = day.workouts[0]; // Take first workout
                    const workoutName = WORKOUT_TYPES[workout.type] || 'Workout';
                    task.title = `${workoutName} ðŸ”„`;
                    task.desc = `${workout.time} â€¢ ${workout.calories} cal burned`;
                    task.calBurn = workout.calories;
                    task.autoDetected = true;
                    
                    // Auto-check the box
                    const checked = this.checked[dateKey] || [];
                    if (!checked.includes('train')) {
                        checked.push('train');
                        this.checked[dateKey] = checked;
                        this.saveUserData();
                    }
                }
            });

            // 2. Logic Engines
            const sleepDebt = this.calculateSleepDebt();
            if (sleepDebt > 7) {
                this.sleepDebtCritical = true;
                const trainTask = this.protocol.find(t => t.id === 'train');
                if (trainTask) {
                    trainTask.title = 'ðŸ›ï¸ FORCED REST';
                    trainTask.desc = `Sleep debt: ${sleepDebt.toFixed(1)}h - Training Disabled`;
                    trainTask.calBurn = 0;
                    trainTask.autoDetected = false;
                }
            } else {
                this.sleepDebtCritical = false;
            }
            
            // 3. Inject Supplements
            const supplements = [
                { id: 'fish-oil', time: '07:30', title: 'Fish Oil 2g', desc: 'Omega-3', macros: {p:0,o:2000,cal:20}, colors: [], calBurn: 0 },
                { id: 'vitamin-d', time: '07:30', title: 'Vitamin D3', desc: '5000 IU', macros: {p:0,o:0,cal:0}, colors: [], calBurn: 0 },
                { id: 'magnesium', time: '21:00', title: 'Magnesium', desc: '400mg', macros: {p:0,o:0,cal:0}, colors: [], calBurn: 0 }
            ];
            
            supplements.forEach(supp => {
                if (!this.protocol.find(t => t.id === supp.id)) {
                    this.protocol.push(supp);
                }
            });
            this.protocol.sort((a, b) => a.time.localeCompare(b.time));
            
            // 4. Check Alerts
            this.checkProteinWindow();

            // 5. Render Components
            this.renderScores();
            this.renderSleepMetrics();
            this.renderMacros();
            this.renderRainbow();
            this.renderStatus();
            this.renderTimeline();
            
            log('âœ… Render complete');
        } catch (e) {
            logerr('âš ï¸ Render Error: ' + e);
        }
    }

    renderScores() {
        const day = this.history[this.currentIndex];
        const sleepHours = (day.totalSec || 0) / 3600;
        const dayScore = Math.min(100, Math.round((sleepHours / 8) * 100)); // Simple calculation based on sleep for now
        
        this.setText('dayScore', dayScore);
        this.setText('dateLabel', day.date);
        
        const scoreEl = document.getElementById('dayScore');
        if(scoreEl) scoreEl.style.color = dayScore >= 80 ? '#ccff00' : dayScore >= 60 ? '#FFD60A' : '#ff453a';
        
        const longevityScore = this.calculateLongevityScore();
        this.setText('longevityScore', longevityScore);
        
        const primaryBox = document.querySelector('.score-box.primary');
        if(primaryBox) {
            const color = longevityScore >= 100 ? '#00ff00' : longevityScore >= 80 ? '#ccff00' : longevityScore >= 60 ? '#00f0ff' : '#ff453a';
            primaryBox.style.borderColor = color;
        }
    }

    renderSleepMetrics() {
        const day = this.history[this.currentIndex];
        const totalHours = Math.floor(day.totalSec / 3600);
        const totalMins = Math.round((day.totalSec % 3600) / 60);
        const deepMins = Math.round((day.deepSec || 0) / 60);
        const remMins = Math.round((day.remSec || 0) / 60);
        
        this.setText('sleepVal', `${totalHours}h ${totalMins}m`);
        this.setText('deepVal', `${deepMins}m`);
        this.setText('remVal', `${remMins}m`);
        
        const updateOrb = (id, val, goal) => {
            const el = document.getElementById(id);
            if (el) {
                const offset = 145 - (Math.min(val / goal, 1) * 145);
                el.style.strokeDashoffset = offset;
            }
        };
        
        updateOrb('sleepOrb', day.totalSec / 3600, 9);
        updateOrb('deepOrb', (day.deepSec || 0) / 3600, 2);
        updateOrb('remOrb', (day.remSec || 0) / 3600, 2);
    }

    renderMacros() {
        const goals = USERS[this.user].goals;
        const cals = this.calculateDynamicCalories();
        const macros = this.calculateMacros();
        
        this.setText('proteinVal', macros.protein);
        this.setText('proteinGoal', `/${goals.protein}g`);
        
        this.setText('omega3Val', Math.round(macros.omega3 / 1000) + 'k');
        this.setText('omega3Goal', `/${Math.round(goals.omega3 / 1000)}k`);
        
        this.setText('calorieVal', macros.calories);
        this.setText('calorieGoal', `/${cals.total}`);
        
        this.setText('burnVal', macros.burn);
        this.setText('burnGoal', `/${cals.workoutBurn}`);
        
        const updateOrb = (id, val, goal) => {
            const el = document.getElementById(id);
            if (el) {
                const pct = Math.min(val / goal, 1);
                const offset = 145 - (pct * 145);
                el.style.strokeDashoffset = offset;
                // Color change based on completion
                const orbColor = pct >= 0.9 ? '#30d158' : pct >= 0.7 ? '#FFD60A' : '#ff453a';
                el.style.stroke = orbColor;
            }
        };
        
        updateOrb('proteinOrb', macros.protein, goals.protein);
        updateOrb('omega3Orb', macros.omega3, goals.omega3);
        updateOrb('calorieOrb', macros.calories, cals.total);
        updateOrb('burnOrb', macros.burn, cals.workoutBurn);
    }

    renderRainbow() {
        const colors = this.calculateRainbow();
        const score = Math.round((colors.size / 6) * 100);
        this.setText('rainbowScore', score + '%');
        
        let html = '';
        const colorOrder = ['red', 'orange', 'yellow', 'green', 'purple', 'white'];
        
        colorOrder.forEach(colorName => {
            const has = colors.has(colorName);
            const width = has ? 16.66 : 0;
            const color = RAINBOW_COLORS[colorName].hex;
            html += `<div class="rainbow-seg" style="background:${color}; width:${width}%"></div>`;
        });
        
        document.getElementById('rainbowTrack').innerHTML = html;
        
        const suggestionEl = document.getElementById('rainbowSuggestion');
        if (colors.size === 6) {
            suggestionEl.innerText = "ðŸŒˆ FULL SPECTRUM ACHIEVED! Maximum anti-inflammatory power!";
            suggestionEl.style.display = 'block';
        } else if (colors.size > 0) {
            const missing = colorOrder.filter(c => !colors.has(c));
            const nextColor = missing[0];
            const examples = RAINBOW_COLORS[nextColor].examples;
            suggestionEl.innerText = `ðŸ’¡ Add ${nextColor.toUpperCase()} to complete rainbow: ${examples}`;
            suggestionEl.style.display = 'block';
        } else {
            suggestionEl.style.display = 'none';
        }
    }

    renderStatus() {
        const day = this.history[this.currentIndex];
        const sleepHours = (day.totalSec || 0) / 3600;
        let status = '';
        
        if (this.sleepDebtCritical) {
            status = 'âš ï¸ SLEEP DEBT CRITICAL - Recovery Mode';
        } else if (sleepHours >= 7.5) {
            status = 'âœ… OPTIMAL - Ready for training';
        } else if (sleepHours >= 6) {
            status = 'âš ï¸ MODERATE - Light training only';
        } else if (sleepHours > 0) {
            status = 'ðŸ›ï¸ POOR SLEEP - Rest day';
        } else {
            status = 'ðŸ“Š Waiting for data...';
        }
        
        this.setText('statusMsg', status);
        
        // Alert Banner logic
        const banner = document.getElementById('alertBanner');
        if (this.proteinWindowActive) {
            banner.className = 'alert alert-protein show';
            banner.innerText = "âš¡ PROTEIN WINDOW ACTIVE - Eat protein now!";
        } else if (this.sleepDebtCritical) {
            banner.className = 'alert alert-warning show';
            banner.innerText = "âš ï¸ SLEEP DEBT OVER 7 HOURS - FORCED RECOVERY";
        } else {
            banner.className = 'alert'; // Hide
        }
    }

    renderTimeline() {
        const dateKey = this.history[this.currentIndex].date;
        const checked = this.checked[dateKey] || [];
        let html = '';
        
        this.protocol.forEach(task => {
            const isChecked = checked.includes(task.id);
            const isAutoDetected = task.autoDetected || false;
            
            // Fix onclick binding - using global 'app' variable
            const clickHandler = task.clickable && task.mealSlot 
                ? `onclick="app.openMealPicker('${task.mealSlot}')"` 
                : '';
                
            const clickClass = task.clickable && task.mealSlot ? 'clickable' : '';
            const autoClass = isAutoDetected ? 'auto-detected' : '';
            
            html += `<div class="task">
                <div class="task-time">${task.time}</div>
                <div class="task-card ${isChecked ? 'checked' : ''} ${clickClass} ${autoClass}" ${clickHandler}>
                    <div class="task-title">${task.title} 
                        ${isAutoDetected ? '<span class="workout-badge">AUTO</span>' : ''}
                    </div>
                    <div class="task-desc">${task.desc}</div>
                    <div class="check-btn" onclick="event.stopPropagation(); app.toggleTask('${task.id}')">
                        <div class="check-circle">${isChecked ? 'âœ“' : ''}</div>
                    </div>
                </div>
            </div>`;
        });
        
        document.getElementById('timeline').innerHTML = html;
    }

    setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    }

    sync() {
        this.fetchOuraData();
    }
}

// --- DEBUG & INIT ---
const debugLogs = [];
function log(msg) {
    console.log(msg);
    debugLogs.push({t: new Date().toLocaleTimeString(), type: 'LOG', msg: msg, color: '#0f0'});
    if(debugLogs.length > 50) debugLogs.shift();
    renderDebug();
}
function logerr(msg) {
    console.error(msg);
    debugLogs.push({t: new Date().toLocaleTimeString(), type: 'ERROR', msg: msg, color: '#ff453a'});
    if(debugLogs.length > 50) debugLogs.shift();
    renderDebug();
}
function renderDebug() {
    const el = document.getElementById('debugConsole');
    if(!el) return;
    el.innerHTML = debugLogs.map(l => `<div style="color:${l.color};margin-bottom:4px"><span style="color:#666">[${l.t}]</span> <span style="color:#00f0ff">${l.type}</span>: ${l.msg}</div>`).join('');
    el.scrollTop = el.scrollHeight;
}
function toggleDebug() {
    const el = document.getElementById('debugConsole');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// Initialize App
let app;
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}

function initApp() {
    log('âš¡ DOM Ready');
    try {
        app = new CenturionApp();
        window.app = app; // Expose to window for onclicks
        log('ðŸŽ‰ App initialized');
    } catch (error) {
        logerr('ðŸ’¥ INIT ERROR: ' + error);
    }
}

// Error trap
window.addEventListener('error', e => logerr('ðŸ’¥ ERROR: ' + e.error?.message));

log('âœ… Script loaded');
</script>
</body>
</html>